<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Create Work Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Put your anon key here (same pattern as your settings page) -->
  <meta name="supabase-anon-key" content="PASTE_ANON_KEY_HERE" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:34px; }
    .muted { font-size:12px; color:#9fb0c3; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:20px; margin-bottom:16px; }
    label { display:block; font-size:12px; color:#9fb0c3; margin-bottom:6px; }
    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #223044;
      background:#0b0f14;
      color:#e8eef6;
      font-size:14px;
      outline:none;
    }
    textarea { min-height:90px; resize:vertical; }
    input:focus, select:focus, textarea:focus { border-color:#3b82f6; }
    .col { flex:1; min-width:240px; }
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:#243648; }
    .primary { background:#3b82f6; border-color:#3b82f6; }
    .primary:hover { background:#2563eb; }
    .danger { background:#ef4444; border-color:#ef4444; }
    .danger:hover { background:#dc2626; }
    .success { color:#4ade80; font-size:12px; margin-top:10px; }
    .error { color:#ef4444; font-size:12px; margin-top:10px; }

    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #223044; padding:10px 8px; vertical-align:top; }
    th { text-align:left; font-size:12px; color:#9fb0c3; font-weight:600; }
    .pill { display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #223044; color:#9fb0c3; }
    .small { font-size:12px; color:#9fb0c3; }
    .right { text-align:right; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <div>
      <h1>Create Work Order</h1>
      <div class="muted" id="tenantHint">Loading tenant…</div>
    </div>
    <div class="row">
      <button onclick="location.href='dashboard-business.html'">Dashboard</button>
      <button onclick="location.href='work-orders.html'">Work Orders List</button>
      <button class="danger" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Customer</label>
        <select id="customer_id"></select>
        <div class="small">Pick the customer first (filters vehicles list if you want).</div>
      </div>
      <div class="col">
        <label>Vehicle</label>
        <select id="vehicle_id"></select>
      </div>
      <div class="col">
        <label>Status</label>
        <select id="status">
          <option value="draft">Draft</option>
          <option value="scheduled">Scheduled</option>
          <option value="diagnosis_required">Diagnosis Required</option>
          <option value="awaiting_parts">Awaiting Parts</option>
          <option value="customer_approval">Customer Approval</option>
          <option value="in_progress">In Progress</option>
          <option value="repairing">Repairing</option>
          <option value="testing">Testing</option>
          <option value="ready_for_pickup">Ready for Pickup</option>
          <option value="completed">Completed</option>
          <option value="closed">Closed</option>
        </select>
      </div>
      <div class="col">
        <label>Priority</label>
        <select id="priority">
          <option value="low">Low</option>
          <option value="normal" selected>Normal</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="col">
        <label>Scheduled Start</label>
        <input id="scheduled_start" type="datetime-local" />
      </div>
      <div class="col">
        <label>Scheduled End</label>
        <input id="scheduled_end" type="datetime-local" />
      </div>
      <div class="col">
        <label>Odometer / Hours</label>
        <input id="odometer" type="number" min="0" step="1" placeholder="1234" />
      </div>
      <div class="col">
        <label>Shop Tag / Reference</label>
        <input id="reference" type="text" placeholder="WO-Note / Tag" />
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="col">
        <label>Customer Concern / Notes</label>
        <textarea id="customer_notes" placeholder="Customer states…"></textarea>
      </div>
      <div class="col">
        <label>Internal Notes</label>
        <textarea id="internal_notes" placeholder="Tech / advisor notes…"></textarea>
      </div>
    </div>

    <div class="row" style="margin-top:12px; justify-content:flex-end;">
      <button class="primary" onclick="createWorkOrder()">Create Work Order</button>
    </div>

    <div id="msg"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div>
        <h2 style="margin:0; font-size:16px;">Labor Lines (after you create the WO)</h2>
        <div class="muted">You’ll add lines & clock time on the Edit page.</div>
      </div>
      <span class="pill">Tip: one tech per labor line</span>
    </div>
  </div>

<script>
/** ========= CONFIG ========= **/
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

/** ========= AUTH ========= **/
function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;

  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey: ANON_KEY, Authorization: `Bearer ${token}` }
  });
  if(!r.ok) return null;
  const user = await r.json();
  return { token, user };
}

async function getTenantId(token){
  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey: ANON_KEY, Authorization: `Bearer ${token}` }
  });
  if(!r.ok) throw new Error("Failed to load user");
  const u = await r.json();
  return u.user_metadata?.tenant_id || u.id;
}

async function sbFetch(path, { token, method="GET", body=null, prefer=null }){
  const headers = {
    apikey: ANON_KEY,
    Authorization: `Bearer ${token}`
  };
  if(body !== null) headers["Content-Type"] = "application/json";
  if(prefer) headers["Prefer"] = prefer;

  const r = await fetch(path, {
    method,
    headers,
    body: body !== null ? JSON.stringify(body) : null
  });
  return r;
}

function setMsg(text, type="success"){
  const el = document.getElementById("msg");
  el.className = type;
  el.textContent = text;
  setTimeout(()=>{ el.textContent=""; }, 4500);
}

/** ========= LOAD DROPDOWNS ========= **/
let AUTH = null;
let TENANT_ID = null;

async function loadCustomers(){
  const sel = document.getElementById("customer_id");
  sel.innerHTML = `<option value="">Loading…</option>`;

  const r = await sbFetch(
    `${REST_BASE}/customers?select=customer_id,first_name,last_name,business_name&tenant_id=eq.${TENANT_ID}&order=created_at.desc`,
    { token: AUTH.token }
  );
  if(!r.ok){
    sel.innerHTML = `<option value="">(failed to load)</option>`;
    return;
  }
  const rows = await r.json();
  sel.innerHTML = `<option value="">Select customer…</option>` + rows.map(c=>{
    const name = (c.business_name || `${c.first_name||""} ${c.last_name||""}`.trim() || "Customer");
    return `<option value="${c.customer_id}">${name}</option>`;
  }).join("");
}

async function loadVehicles(){
  const sel = document.getElementById("vehicle_id");
  sel.innerHTML = `<option value="">Loading…</option>`;

  // Optional: filter by selected customer
  const custId = document.getElementById("customer_id").value;
  const filter = custId ? `&customer_id=eq.${custId}` : "";

  const r = await sbFetch(
    `${REST_BASE}/vehicles?select=vehicle_id,make,model,year,vin_hin,license_plate&tenant_id=eq.${TENANT_ID}${filter}&order=created_at.desc`,
    { token: AUTH.token }
  );
  if(!r.ok){
    sel.innerHTML = `<option value="">(failed to load)</option>`;
    return;
  }
  const rows = await r.json();
  sel.innerHTML = `<option value="">Select vehicle…</option>` + rows.map(v=>{
    const label = `${v.year||""} ${v.make||""} ${v.model||""}`.trim();
    const extra = [v.vin_hin ? `VIN/HIN: ${v.vin_hin}` : null, v.license_plate ? `Plate: ${v.license_plate}` : null].filter(Boolean).join(" • ");
    return `<option value="${v.vehicle_id}">${label}${extra ? " — " + extra : ""}</option>`;
  }).join("");
}

document.getElementById("customer_id").addEventListener("change", loadVehicles);

/** ========= CREATE WORK ORDER ========= **/
function getWOForm(){
  return {
    tenant_id: TENANT_ID,
    customer_id: document.getElementById("customer_id").value || null,
    vehicle_id: document.getElementById("vehicle_id").value || null,
    status: document.getElementById("status").value,
    priority: document.getElementById("priority").value,
    scheduled_start: document.getElementById("scheduled_start").value ? new Date(document.getElementById("scheduled_start").value).toISOString() : null,
    scheduled_end: document.getElementById("scheduled_end").value ? new Date(document.getElementById("scheduled_end").value).toISOString() : null,
    odometer: document.getElementById("odometer").value ? Number(document.getElementById("odometer").value) : null,
    reference: document.getElementById("reference").value.trim() || null,
    customer_notes: document.getElementById("customer_notes").value.trim() || null,
    internal_notes: document.getElementById("internal_notes").value.trim() || null
  };
}

async function createWorkOrder(){
  try{
    const payload = getWOForm();
    if(!payload.customer_id) return setMsg("Pick a customer first.", "error");
    if(!payload.vehicle_id) return setMsg("Pick a vehicle.", "error");

    const r = await sbFetch(`${REST_BASE}/work_orders`, {
      token: AUTH.token,
      method: "POST",
      prefer: "return=representation",
      body: payload
    });

    if(!r.ok){
      const t = await r.text();
      console.error(t);
      return setMsg("Create failed: " + t, "error");
    }

    const rows = await r.json();
    const wo = rows[0];
    setMsg("✅ Work order created. Opening edit…", "success");

    // redirect to edit page
    setTimeout(()=>{
      location.href = `work-order-edit.html?id=${encodeURIComponent(wo.work_order_id || wo.id)}`;
    }, 700);

  }catch(err){
    console.error(err);
    setMsg("Error: " + err.message, "error");
  }
}

/** ========= INIT ========= **/
async function load(){
  AUTH = await validateAuth();
  if(!AUTH) return location.replace("login.html");

  TENANT_ID = await getTenantId(AUTH.token);
  document.getElementById("tenantHint").textContent = `Tenant: ${TENANT_ID}`;

  await loadCustomers();
  await loadVehicles();
}

load();
</script>
</body>
</html>
