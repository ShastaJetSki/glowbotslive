<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shark Law ‚Äì Sign In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:#0a0a12;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#e8e0f6;
      background-image:radial-gradient(ellipse at 50% 0%,rgba(139,92,246,.12) 0%,transparent 60%);
    }
    .login-wrap{width:100%;max-width:440px;padding:20px;}

    /* Logo area */
    .brand{text-align:center;margin-bottom:32px;}
    .brand-icon{font-size:52px;margin-bottom:8px;}
    .brand-name{font-size:32px;font-weight:800;color:#a78bfa;letter-spacing:-0.5px;}
    .brand-tagline{font-size:13px;color:#7c6ba0;margin-top:4px;letter-spacing:0.5px;}

    /* Card */
    .card{
      padding:32px;border-radius:18px;
      background:linear-gradient(145deg,#13111f,#161226);
      border:1px solid #2d2250;
      box-shadow:0 8px 40px rgba(139,92,246,.08);
    }
    .card-title{font-size:20px;font-weight:700;margin-bottom:4px;}
    .card-sub{font-size:13px;color:#8b7faa;margin-bottom:24px;}

    /* Form */
    .form-group{margin-bottom:16px;}
    .form-label{display:block;margin-bottom:6px;font-size:12px;font-weight:600;color:#8b7faa;text-transform:uppercase;letter-spacing:0.5px;}
    .form-input{
      width:100%;padding:13px 14px;font-size:15px;border-radius:10px;
      border:1px solid #2d2250;background:#0d0b18;color:#e8e0f6;
      transition:border-color .2s;
    }
    .form-input:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.15);}
    .form-input::placeholder{color:#4a3f6b;}

    /* Password wrapper */
    .pw-wrap{position:relative;}
    .pw-toggle{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);
      background:none;border:none;color:#6b5b95;cursor:pointer;font-size:18px;padding:4px;
    }
    .pw-toggle:hover{color:#a78bfa;}

    /* Button */
    .btn-login{
      width:100%;padding:14px;border:none;border-radius:10px;
      background:linear-gradient(135deg,#7c3aed,#8b5cf6);
      color:#fff;font-size:15px;font-weight:700;cursor:pointer;
      transition:all .2s;margin-top:8px;
    }
    .btn-login:hover{background:linear-gradient(135deg,#6d28d9,#7c3aed);transform:translateY(-1px);box-shadow:0 4px 20px rgba(139,92,246,.3);}
    .btn-login:active{transform:translateY(0);}
    .btn-login:disabled{opacity:.5;cursor:not-allowed;transform:none;}

    /* Error/Success */
    .msg{padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none;}
    .msg-error{background:rgba(239,68,68,.12);border:1px solid #ef4444;color:#f87171;}
    .msg-success{background:rgba(16,185,129,.12);border:1px solid #10b981;color:#34d399;}
    .msg.show{display:block;}

    /* Footer */
    .footer{text-align:center;margin-top:24px;}
    .footer-powered{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;}
    .footer-powered span{color:#4a3f6b;font-size:11px;}
    .footer-powered img{height:32px;}
    .footer-powered a{color:#7c3aed;text-decoration:none;font-weight:600;font-size:11px;}
    .footer-powered a:hover{color:#a78bfa;}
    .footer-links{display:flex;justify-content:center;gap:16px;flex-wrap:wrap;}
    .footer-links a{color:#4a3f6b;font-size:11px;text-decoration:none;}
    .footer-links a:hover{color:#a78bfa;}
    .footer-copy{color:#2d2250;font-size:10px;margin-top:10px;}

    /* Forgot password */
    .forgot{text-align:right;margin-top:6px;}
    .forgot a{color:#7c6ba0;font-size:12px;text-decoration:none;}
    .forgot a:hover{color:#a78bfa;}

    @media(max-width:480px){
      .brand-name{font-size:26px;}
      .card{padding:24px 20px;}
    }
  </style>
</head>
<body>

<div class="login-wrap">
  <div class="brand">
    <img src="sharklawlogo.png" alt="Shark Law" style="max-width:260px;height:auto;margin-bottom:8px;">
    <div class="brand-tagline">Motorcycle Law CRM</div>
  </div>

  <div class="card">
    <div class="card-title">Welcome back</div>
    <div class="card-sub">Sign in to your account</div>

    <div class="msg msg-error" id="errorMsg"></div>
    <div class="msg msg-success" id="successMsg"></div>

    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" class="form-input" id="email" placeholder="you@sharklaw.com" autocomplete="email">
    </div>

    <div class="form-group">
      <label class="form-label">Password</label>
      <div class="pw-wrap">
        <input type="password" class="form-input" id="password" placeholder="Enter your password" autocomplete="current-password">
        <button type="button" class="pw-toggle" id="pwToggle" tabindex="-1">üëÅ</button>
      </div>
      <div class="forgot"><a href="#">Forgot password?</a></div>
    </div>

    <button class="btn-login" id="loginBtn">Sign In</button>
  </div>

  <div class="footer">
    <div class="footer-powered">
      <span>Powered by</span>
      <img src="glowbot.png" alt="GlowBot">
      <a href="https://glowbotslive.com" target="_blank">GlowBotsLive.com</a>
    </div>
    <div class="footer-links">
      <a href="#">Privacy</a>
      <a href="#">Terms</a>
      <a href="mailto:support@sharklawrules.com">Support</a>
    </div>
    <div class="footer-copy">&copy; 2026 Shark Law. All rights reserved.</div>
  </div>
</div>

<script>
(function(){
  const SB_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const emailInput    = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const loginBtn      = document.getElementById('loginBtn');
  const pwToggle      = document.getElementById('pwToggle');
  const errorMsg      = document.getElementById('errorMsg');
  const successMsg    = document.getElementById('successMsg');

  // Password visibility toggle
  pwToggle.addEventListener('click', () => {
    const isPassword = passwordInput.type === 'password';
    passwordInput.type = isPassword ? 'text' : 'password';
    pwToggle.textContent = isPassword ? 'üôà' : 'üëÅ';
  });

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add('show');
    successMsg.classList.remove('show');
  }
  function showSuccess(msg) {
    successMsg.textContent = msg;
    successMsg.classList.add('show');
    errorMsg.classList.remove('show');
  }
  function clearMessages() {
    errorMsg.classList.remove('show');
    successMsg.classList.remove('show');
  }

  // Check if already logged in
  async function checkExistingSession() {
    const token = localStorage.getItem('sb_access_token');
    const refresh = localStorage.getItem('sb_refresh_token');
    if (!token || !refresh) return;
    try {
      const { data } = await sb.auth.setSession({ access_token: token, refresh_token: refresh });
      if (data?.session) {
        const tenantId = await getUserTenantId(data.session.user.id, data.session.user.email);
        const dashUrl = await getTenantDashboard(tenantId);
        location.replace(dashUrl);
      }
    } catch (e) {
      localStorage.removeItem('sb_access_token');
      localStorage.removeItem('sb_refresh_token');
    }
  }
  checkExistingSession();

  // Resolve tenant
  async function getUserTenantId(authId, email) {
    // Try by auth_user_id first
    let { data } = await sb.from('users').select('tenant_id').eq('auth_user_id', authId).single();
    if (data?.tenant_id) return data.tenant_id;
    // Fallback: by email
    ({ data } = await sb.from('users').select('tenant_id').eq('email', email).single());
    return data?.tenant_id || null;
  }

  // Get dashboard URL from tenant record
  async function getTenantDashboard(tenantId) {
    const defaultDash = 'dashboard-sharklaw.html';
    if (!tenantId) return defaultDash;
    const { data } = await sb.from('tenants').select('dashboard_url').eq('tenant_id', tenantId).single();
    return data?.dashboard_url || defaultDash;
  }

  // Login
  async function login() {
    clearMessages();
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) { showError('Please enter email and password'); return; }

    loginBtn.disabled = true;
    loginBtn.textContent = 'Signing in...';

    try {
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;

      // Store tokens
      localStorage.setItem('sb_access_token', data.session.access_token);
      localStorage.setItem('sb_refresh_token', data.session.refresh_token);

      showSuccess('Welcome back! Redirecting...');
      loginBtn.textContent = 'Loading dashboard...';

      const tenantId = await getUserTenantId(data.session.user.id, data.session.user.email);
      const dashUrl = await getTenantDashboard(tenantId);

      location.replace(dashUrl);

    } catch (err) {
      console.error('Login error:', err);
      showError(err.message || 'Login failed');
      loginBtn.textContent = 'Sign In';
    } finally {
      loginBtn.disabled = false;
    }
  }

  loginBtn.addEventListener('click', login);
  passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') login(); });
  emailInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') passwordInput.focus(); });
})();
</script>
</body>
</html>
