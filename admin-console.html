<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Platform Command Center</title>
  <style>
    :root{--bg:#050810;--bg2:#0a1018;--bg3:#0f1520;--bg4:#1a2535;--border:#1e3048;--border2:#2a4060;--text:#e8f0ff;--text2:#8aa0c0;--muted:#4a6080;--cyan:#00e5ff;--green:#00ff9d;--orange:#ff9500;--purple:#bf5fff;--red:#ff3d5a;--blue:#3d8bff;--yellow:#ffe03d;--pink:#ff5f9f;--gold:#ffd700}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',-apple-system,sans-serif;background:var(--bg);min-height:100vh;color:var(--text);padding:16px}
    .container{max-width:1850px;margin:0 auto}

    /* Header */
    .header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border);border-radius:12px;margin-bottom:12px;position:relative}
    .header::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),var(--purple),transparent)}
    .header-left{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;background:linear-gradient(135deg,var(--cyan),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 0 20px rgba(0,229,255,.4)}
    .header-title{font-size:22px;font-weight:700}
    .header-sub{font-size:9px;color:var(--cyan);text-transform:uppercase;letter-spacing:2px}
    .status-panel{display:flex;align-items:center;gap:14px;padding:8px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px}
    .status-item{display:flex;align-items:center;gap:5px;font-size:9px;text-transform:uppercase}
    .light{width:8px;height:8px;border-radius:50%}
    .light.on{background:var(--green);box-shadow:0 0 8px var(--green)}
    .light.warn{background:var(--orange);box-shadow:0 0 8px var(--orange);animation:blink 2s infinite}
    .light.alert{background:var(--red);box-shadow:0 0 8px var(--red);animation:blink 1s infinite}
    .light.info{background:var(--cyan);box-shadow:0 0 8px var(--cyan)}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
    .live{display:flex;align-items:center;gap:4px;font-size:8px;color:var(--green);font-weight:600}
    .live-dot{width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,255,157,.7)}50%{box-shadow:0 0 0 6px transparent}}

    /* Impersonation Banner */
    .impersonate-banner{display:none;background:linear-gradient(90deg,var(--orange),var(--red));padding:10px 20px;border-radius:8px;margin-bottom:12px;align-items:center;justify-content:space-between}
    .impersonate-banner.active{display:flex}
    .impersonate-info{display:flex;align-items:center;gap:12px;font-size:12px;font-weight:600}
    .impersonate-info span{background:rgba(0,0,0,.3);padding:4px 10px;border-radius:4px}

    /* Navigation */
    .nav{display:flex;justify-content:space-between;align-items:center;padding:8px 0;margin-bottom:12px;flex-wrap:wrap;gap:8px}
    .tabs{display:flex;gap:4px;flex-wrap:wrap}
    .tab{font-size:10px;font-weight:600;color:var(--text2);background:var(--bg2);border:1px solid var(--border);padding:8px 14px;border-radius:6px;cursor:pointer;transition:.2s;text-transform:uppercase}
    .tab:hover{color:var(--text);background:var(--bg4)}
    .tab.active{color:var(--cyan);border-color:var(--cyan);background:rgba(0,229,255,.08)}
    .tab .badge{background:var(--red);color:#fff;font-size:8px;padding:2px 5px;border-radius:6px;margin-left:4px}
    .btn{font-size:9px;font-weight:600;padding:8px 12px;border:1px solid var(--border2);border-radius:6px;cursor:pointer;transition:.2s;background:var(--bg2);color:var(--text);text-transform:uppercase}
    .btn:hover{background:var(--bg4)}
    .btn-primary{border-color:var(--cyan);color:var(--cyan)}
    .btn-primary:hover{background:rgba(0,229,255,.1)}
    .btn-success{border-color:var(--green);color:var(--green)}
    .btn-danger{border-color:var(--red);color:var(--red)}
    .btn-warning{border-color:var(--orange);color:var(--orange)}
    .btn-sm{padding:5px 8px;font-size:8px}

    /* Collapsible KPI Group */
    .kpi-group{background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden}
    .kpi-group-header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;cursor:pointer;transition:.2s;user-select:none}
    .kpi-group-header:hover{background:var(--bg4)}
    .kpi-group-title{font-size:11px;font-weight:600;display:flex;align-items:center;gap:8px}
    .kpi-group-summary{font-size:10px;color:var(--text2);margin-left:auto;margin-right:12px}
    .kpi-group-toggle{font-size:10px;color:var(--cyan);transition:.3s;width:20px;height:20px;display:flex;align-items:center;justify-content:center;background:var(--bg);border-radius:4px}
    .kpi-group.collapsed .kpi-group-toggle{transform:rotate(-90deg)}
    .kpi-group-content{padding:0 14px 14px;max-height:800px;overflow:hidden;transition:.3s}
    .kpi-group.collapsed .kpi-group-content{max-height:0;padding:0 14px}

    /* ========== DISPLAY TYPE 1: SPEEDOMETER ========== */
    .speedo-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media(max-width:1400px){.speedo-grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:1000px){.speedo-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:700px){.speedo-grid{grid-template-columns:repeat(2,1fr)}}
    .speedo{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;transition:.2s}
    .speedo:hover{border-color:var(--border2);transform:translateY(-1px)}
    .speedo-head{display:flex;justify-content:space-between;margin-bottom:4px}
    .speedo-label{font-size:8px;font-weight:600;color:var(--text2);text-transform:uppercase}
    .speedo-trend{font-size:8px;font-weight:700}
    .speedo-trend.up{color:var(--green)}.speedo-trend.down{color:var(--red)}.speedo-trend.flat{color:var(--orange)}
    .speedo-gauge{width:70px;height:38px;margin:0 auto 4px}
    .speedo-gauge svg{width:100%;height:100%;overflow:visible}
    .gauge-bg{fill:none;stroke:var(--bg3);stroke-width:4;stroke-linecap:round}
    .gauge-fill{fill:none;stroke-width:4;stroke-linecap:round;transition:.8s;filter:drop-shadow(0 0 3px currentColor)}
    .speedo-val{font-size:16px;font-weight:700;text-align:center}
    .speedo-unit{font-size:7px;color:var(--muted);text-align:center}
    .speedo-foot{display:flex;justify-content:space-between;margin-top:4px;padding-top:4px;border-top:1px solid var(--border);font-size:7px;color:var(--muted)}

    /* ========== DISPLAY TYPE 2: LED DIGITAL READOUT ========== */
    .led-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:1200px){.led-grid{grid-template-columns:repeat(2,1fr)}}
    .led-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden}
    .led-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--led-color,var(--cyan))}
    .led-card.green{--led-color:var(--green)}.led-card.cyan{--led-color:var(--cyan)}.led-card.red{--led-color:var(--red)}.led-card.gold{--led-color:var(--gold)}.led-card.purple{--led-color:var(--purple)}
    .led-label{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
    .led-display{font-family:'Courier New',monospace;font-size:32px;font-weight:700;color:var(--led-color);text-shadow:0 0 20px var(--led-color),0 0 40px var(--led-color);letter-spacing:2px}
    .led-sub{display:flex;justify-content:space-between;margin-top:8px;font-size:9px;color:var(--text2)}
    .led-trend{font-weight:600}
    .led-trend.up{color:var(--green)}.led-trend.down{color:var(--red)}

    /* ========== DISPLAY TYPE 3: VERTICAL BAR EQUALIZER ========== */
    .equalizer-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:1000px){.equalizer-grid{grid-template-columns:repeat(2,1fr)}}
    .eq-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px}
    .eq-label{font-size:8px;color:var(--text2);text-transform:uppercase;margin-bottom:8px}
    .eq-display{display:flex;align-items:flex-end;justify-content:center;gap:3px;height:50px;margin-bottom:6px}
    .eq-bar{width:8px;background:var(--bg3);border-radius:2px;position:relative;overflow:hidden}
    .eq-bar-fill{position:absolute;bottom:0;left:0;right:0;border-radius:2px;transition:.6s}
    .eq-bar-fill.cyan{background:linear-gradient(to top,var(--cyan),rgba(0,229,255,.3))}.eq-bar-fill.green{background:linear-gradient(to top,var(--green),rgba(0,255,157,.3))}.eq-bar-fill.orange{background:linear-gradient(to top,var(--orange),rgba(255,149,0,.3))}.eq-bar-fill.red{background:linear-gradient(to top,var(--red),rgba(255,61,90,.3))}.eq-bar-fill.yellow{background:linear-gradient(to top,var(--yellow),rgba(255,224,61,.3))}.eq-bar-fill.blue{background:linear-gradient(to top,var(--blue),rgba(61,139,255,.3))}
    .eq-value{font-size:14px;font-weight:700;text-align:center}
    .eq-footer{display:flex;justify-content:space-between;font-size:7px;color:var(--muted);margin-top:4px}

    /* ========== DISPLAY TYPE 4: CIRCULAR RING GAUGE ========== */
    .ring-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media(max-width:1200px){.ring-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:700px){.ring-grid{grid-template-columns:repeat(2,1fr)}}
    .ring-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center}
    .ring-card:hover{border-color:var(--border2)}
    .ring-gauge{width:60px;height:60px;margin:0 auto 8px;position:relative}
    .ring-gauge svg{width:100%;height:100%;transform:rotate(-90deg)}
    .ring-bg{fill:none;stroke:var(--bg3);stroke-width:5}
    .ring-fill{fill:none;stroke-width:5;stroke-linecap:round;transition:.8s;filter:drop-shadow(0 0 4px currentColor)}
    .ring-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:12px;font-weight:700}
    .ring-label{font-size:8px;color:var(--text2);text-transform:uppercase}
    .ring-value{font-size:11px;font-weight:600;margin-top:2px}
    .ring-trend{font-size:8px;margin-top:2px}
    .ring-trend.up{color:var(--green)}.ring-trend.down{color:var(--red)}

    /* ========== DISPLAY TYPE 5: HORIZONTAL THERMAL BAR ========== */
    .thermal-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(max-width:800px){.thermal-grid{grid-template-columns:1fr}}
    .thermal-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px}
    .thermal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .thermal-label{font-size:9px;color:var(--text2);text-transform:uppercase}
    .thermal-value{font-size:14px;font-weight:700}
    .thermal-bar{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;position:relative}
    .thermal-fill{height:100%;border-radius:4px;transition:.6s;position:relative}
    .thermal-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:4px;background:white;opacity:.6;border-radius:0 4px 4px 0}
    .thermal-fill.gradient-green{background:linear-gradient(90deg,#065f46,var(--green))}
    .thermal-fill.gradient-blue{background:linear-gradient(90deg,#1e3a8a,var(--blue))}
    .thermal-fill.gradient-purple{background:linear-gradient(90deg,#4c1d95,var(--purple))}
    .thermal-fill.gradient-gold{background:linear-gradient(90deg,#78350f,var(--gold))}
    .thermal-fill.gradient-red{background:linear-gradient(90deg,#7f1d1d,var(--red))}
    .thermal-segments{display:flex;justify-content:space-between;margin-top:4px;font-size:7px;color:var(--muted)}

    /* ========== DISPLAY TYPE 6: SPARKLINE ========== */
    .spark-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media(max-width:1200px){.spark-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:700px){.spark-grid{grid-template-columns:repeat(2,1fr)}}
    .spark-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px}
    .spark-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
    .spark-label{font-size:8px;color:var(--text2);text-transform:uppercase}
    .spark-value{font-size:16px;font-weight:700}
    .spark-line{height:30px;position:relative}
    .spark-line svg{width:100%;height:100%}
    .spark-path{fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
    .spark-area{opacity:.2}
    .spark-footer{display:flex;justify-content:space-between;font-size:7px;color:var(--muted);margin-top:4px}

    /* ========== DISPLAY TYPE 7: STATUS LIGHT BANK ========== */
    .lightbank{display:flex;gap:6px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;flex-wrap:wrap}
    .lightbank-item{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:60px}
    .lightbank-light{width:12px;height:12px;border-radius:50%;position:relative}
    .lightbank-light::before{content:'';position:absolute;inset:-3px;border-radius:50%;border:1px solid currentColor;opacity:.3}
    .lightbank-light.on{background:var(--green);color:var(--green);box-shadow:0 0 10px var(--green)}
    .lightbank-light.off{background:var(--muted);color:var(--muted)}
    .lightbank-light.warn{background:var(--orange);color:var(--orange);box-shadow:0 0 10px var(--orange);animation:blink 2s infinite}
    .lightbank-light.alert{background:var(--red);color:var(--red);box-shadow:0 0 10px var(--red);animation:blink 1s infinite}
    .lightbank-label{font-size:7px;color:var(--text2);text-transform:uppercase;text-align:center}

    /* ========== DISPLAY TYPE 8: HEXAGONAL CELLS ========== */
    .hex-grid{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-start}
    .hex-cell{width:100px;height:90px;position:relative;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);background:var(--bg3);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:.2s;cursor:pointer}
    .hex-cell:hover{transform:scale(1.05)}
    .hex-cell.active{background:var(--bg4)}
    .hex-cell.enabled{background:linear-gradient(135deg,rgba(0,255,157,.2),rgba(0,229,255,.1))}
    .hex-cell.disabled{background:linear-gradient(135deg,rgba(255,61,90,.1),rgba(255,149,0,.05))}
    .hex-icon{font-size:20px;margin-bottom:4px}
    .hex-label{font-size:7px;color:var(--text2);text-transform:uppercase;text-align:center;padding:0 8px}
    .hex-status{font-size:8px;font-weight:600;margin-top:2px}
    .hex-status.on{color:var(--green)}.hex-status.off{color:var(--red)}

    /* ========== DISPLAY TYPE 9: COST BREAKDOWN ========== */
    .cost-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .cost-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px}
    .cost-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .cost-dot.good{background:var(--green);box-shadow:0 0 6px var(--green)}
    .cost-dot.mid{background:var(--orange);box-shadow:0 0 6px var(--orange)}
    .cost-dot.high{background:var(--red);box-shadow:0 0 6px var(--red)}
    .cost-info{flex:1}
    .cost-name{font-size:8px;color:var(--muted);text-transform:uppercase}
    .cost-amount{font-size:11px;font-weight:600}
    .cost-pct{font-size:9px;color:var(--text2)}

    /* Tab Content */
    .tab-content{display:none}.tab-content.active{display:block}
    .panel{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px}
    .panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
    .panel-title{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px}

    /* Tables */
    .table{width:100%;border-collapse:collapse}
    .table th{font-size:8px;font-weight:600;text-align:left;padding:8px;background:var(--bg);color:var(--text2);border-bottom:1px solid var(--border);text-transform:uppercase}
    .table td{padding:8px;border-bottom:1px solid var(--border);font-size:10px}
    .table tr:hover{background:var(--bg4)}
    .badge{display:inline-block;font-size:8px;font-weight:600;padding:3px 8px;border-radius:4px;text-transform:uppercase}
    .badge-cyan{background:rgba(0,229,255,.15);color:var(--cyan)}.badge-green{background:rgba(0,255,157,.15);color:var(--green)}.badge-orange{background:rgba(255,149,0,.15);color:var(--orange)}.badge-purple{background:rgba(191,95,255,.15);color:var(--purple)}.badge-red{background:rgba(255,61,90,.15);color:var(--red)}.badge-blue{background:rgba(61,139,255,.15);color:var(--blue)}.badge-gold{background:rgba(255,215,0,.15);color:var(--gold)}

    /* Support */
    .support-stats{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:12px}
    @media(max-width:900px){.support-stats{grid-template-columns:repeat(3,1fr)}}
    .stat-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;cursor:pointer;transition:.2s}
    .stat-card:hover{transform:translateY(-1px)}
    .stat-card .val{font-size:22px;font-weight:700;color:var(--stat)}
    .stat-card .lbl{font-size:8px;color:var(--text2);text-transform:uppercase}
    .stat-card.open{--stat:var(--blue)}.stat-card.progress{--stat:var(--yellow)}.stat-card.waiting{--stat:var(--purple)}.stat-card.resolved{--stat:var(--green)}.stat-card.closed{--stat:var(--muted)}.stat-card.urgent{--stat:var(--red)}

    .filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .filters input,.filters select{font-size:10px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);min-width:110px}
    .priority-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:4px}
    .priority-dot.low{background:var(--muted)}.priority-dot.normal{background:var(--blue)}.priority-dot.high{background:var(--orange);box-shadow:0 0 4px var(--orange)}.priority-dot.urgent{background:var(--red);box-shadow:0 0 4px var(--red);animation:blink 1s infinite}
    .status-badge{padding:3px 8px;border-radius:4px;font-size:8px;font-weight:600;text-transform:uppercase}
    .status-open{background:rgba(61,139,255,.2);color:var(--blue)}.status-in_progress{background:rgba(255,224,61,.2);color:var(--yellow)}.status-waiting_on_customer{background:rgba(191,95,255,.2);color:var(--purple)}.status-resolved{background:rgba(0,255,157,.2);color:var(--green)}.status-closed{background:rgba(74,106,138,.2);color:var(--muted)}

    /* Settings */
    .settings-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media(max-width:1000px){.settings-grid{grid-template-columns:1fr}}
    .settings-section{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:14px}
    .settings-section-title{font-size:11px;font-weight:600;color:var(--cyan);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px dashed var(--border)}
    .form-row{display:flex;gap:10px;margin-bottom:10px}
    .form-group{flex:1}
    .form-label{font-size:9px;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:4px}
    .form-input,.form-select{width:100%;font-size:11px;padding:8px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text)}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--cyan)}

    /* Tier Cards */
    .tier-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:1100px){.tier-grid{grid-template-columns:repeat(2,1fr)}}
    .tier-card{background:var(--bg);border:2px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden}
    .tier-card.featured{border-color:var(--cyan)}
    .tier-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--tier-color,var(--muted))}
    .tier-card.free{--tier-color:var(--muted)}.tier-card.basic{--tier-color:var(--blue)}.tier-card.pro{--tier-color:var(--purple)}.tier-card.enterprise{--tier-color:var(--gold)}
    .tier-name{font-size:14px;font-weight:700;margin-bottom:4px}
    .tier-price{font-size:28px;font-weight:700;color:var(--tier-color)}
    .tier-price span{font-size:12px;color:var(--text2);font-weight:400}
    .tier-desc{font-size:10px;color:var(--text2);margin:8px 0 12px}
    .tier-features{list-style:none;font-size:10px}
    .tier-features li{padding:4px 0;display:flex;align-items:center;gap:6px}
    .tier-features li::before{content:'';display:inline-block;width:6px;height:6px;background:var(--green);border-radius:50%}
    .tier-stats{margin-top:12px;padding-top:12px;border-top:1px dashed var(--border);display:flex;justify-content:space-between;font-size:9px}
    .tier-stat-value{font-weight:700;color:var(--tier-color)}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(5,8,16,.92);backdrop-filter:blur(8px);z-index:1000;align-items:center;justify-content:center;padding:16px}
    .modal.active{display:flex}
    .modal-box{background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;position:relative}
    .modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--cyan),var(--purple))}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg2);z-index:10}
    .modal-title{font-size:14px;font-weight:600}
    .modal-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
    .modal-close:hover{color:var(--red)}
    .modal-body{padding:18px}
    .detail-grid{display:grid;grid-template-columns:1.7fr 1fr;gap:16px}
    @media(max-width:800px){.detail-grid{grid-template-columns:1fr}}
    .meta-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
    .meta-card h4{font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px dashed var(--border)}
    .meta-row{display:flex;justify-content:space-between;padding:5px 0;font-size:10px}
    .meta-row .lbl{color:var(--text2)}.meta-row .val{font-weight:500}
    .desc-box{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px;line-height:1.5;white-space:pre-wrap;font-size:11px}
    .comment{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;border-left:3px solid var(--border)}
    .comment.agent{border-left-color:var(--cyan)}.comment.customer{border-left-color:var(--purple)}.comment.internal{border-left-color:var(--orange);background:rgba(255,149,0,.03)}
    .comment-head{display:flex;justify-content:space-between;margin-bottom:6px;font-size:9px}
    .comment-author{font-weight:600}.comment-author.agent{color:var(--cyan)}.comment-author.internal{color:var(--orange)}
    .comment-time{color:var(--muted)}
    .comment-msg{line-height:1.5;font-size:11px}
    .reply-tabs{display:flex;gap:5px;margin-bottom:8px}
    .reply-tab{padding:6px 12px;border-radius:5px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:10px;font-weight:600;cursor:pointer}
    .reply-tab.active{background:var(--cyan);border-color:var(--cyan);color:var(--bg)}
    .reply-tab.internal.active{background:var(--orange);border-color:var(--orange)}
    textarea{font-family:inherit;font-size:11px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);width:100%;min-height:60px;resize:vertical}
    textarea:focus{outline:none;border-color:var(--cyan)}
    .quick-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}

    /* Toggle Switch */
    .toggle{position:relative;width:36px;height:20px;cursor:pointer}
    .toggle input{display:none}
    .toggle-slider{position:absolute;inset:0;background:var(--bg3);border-radius:20px;transition:.3s}
    .toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:2px;top:2px;background:var(--muted);border-radius:50%;transition:.3s}
    .toggle input:checked+.toggle-slider{background:var(--cyan)}
    .toggle input:checked+.toggle-slider::before{transform:translateX(16px);background:white}

    .loading{text-align:center;padding:24px;color:var(--muted);font-size:11px}
    ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  </style>
</head>
<body>
<div class="container">
  <!-- Impersonation Banner -->
  <div class="impersonate-banner" id="impersonateBanner">
    <div class="impersonate-info">
      VIEWING AS TENANT: <span id="impersonateName">--</span>
      <span id="impersonateEmail">--</span>
    </div>
    <button class="btn btn-danger btn-sm" onclick="exitImpersonation()">Exit View</button>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">PC</div>
      <div><div class="header-title">Platform Command</div><div class="header-sub">Super Admin Console</div></div>
    </div>
    <div class="status-panel">
      <div class="status-item"><div class="light on" id="dbLight"></div><span>DB</span></div>
      <div class="status-item"><div class="light info"></div><span>API</span></div>
      <div class="status-item"><div class="light on"></div><span>Cache</span></div>
      <div class="status-item"><div class="light" id="alertLight"></div><span id="alertText">OK</span></div>
      <div class="status-item"><div class="light" id="profitLight"></div><span id="profitText">Profit</span></div>
      <div class="live"><div class="live-dot"></div>LIVE</div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="nav">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab" onclick="switchTab('tenants')">Tenants</button>
      <button class="tab" onclick="switchTab('support')">Support<span class="badge" id="ticketBadge" style="display:none">0</span></button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>
    <div style="display:flex;gap:6px">
      <button class="btn" onclick="refreshAll()">Refresh</button>
      <button class="btn btn-primary" onclick="exportReport()">Export</button>
    </div>
  </div>

  <!-- KPI GROUPS - Dashboard Only -->
  <div id="kpiGroups">
    <!-- SYSTEM HEALTH - Light Bank (MOVED TO TOP) -->
    <div class="kpi-group" id="kpiSystem">
      <div class="kpi-group-header" onclick="toggleGroup('kpiSystem')">
        <div class="kpi-group-title">System Health</div>
        <div class="kpi-group-summary">All systems operational - 99.99% uptime</div>
        <div class="kpi-group-toggle">▼</div>
      </div>
      <div class="kpi-group-content">
        <div class="lightbank">
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Database</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">API</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Auth</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Storage</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">CDN</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Email</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Payments</div></div>
          <div class="lightbank-item"><div class="lightbank-light warn"></div><div class="lightbank-label">Analytics</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Search</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Queue</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Cache</div></div>
          <div class="lightbank-item"><div class="lightbank-light on"></div><div class="lightbank-label">Backup</div></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px">
          <div class="meta-card" style="margin:0"><h4>Uptime</h4><div style="font-size:20px;font-weight:700;color:var(--green)">99.99%</div><div style="font-size:9px;color:var(--text2)">Last 30 days</div></div>
          <div class="meta-card" style="margin:0"><h4>API Latency</h4><div style="font-size:20px;font-weight:700;color:var(--green)">42ms</div><div style="font-size:9px;color:var(--text2)">p95 response</div></div>
          <div class="meta-card" style="margin:0"><h4>Error Rate</h4><div style="font-size:20px;font-weight:700;color:var(--green)">0.01%</div><div style="font-size:9px;color:var(--text2)">Last 24h</div></div>
          <div class="meta-card" style="margin:0"><h4>Active Sessions</h4><div style="font-size:20px;font-weight:700;color:var(--cyan)">847</div><div style="font-size:9px;color:var(--text2)">Right now</div></div>
        </div>
      </div>
    </div>

    <!-- PROFITABILITY - LED Display -->
    <div class="kpi-group" id="kpiProfit">
      <div class="kpi-group-header" onclick="toggleGroup('kpiProfit')">
        <div class="kpi-group-title">Profitability</div>
        <div class="kpi-group-summary" id="profitSummary">$32,830 profit - 72.5% margin</div>
        <div class="kpi-group-toggle">▼</div>
      </div>
      <div class="kpi-group-content">
        <div class="led-grid">
          <div class="led-card green">
            <div class="led-label">Net Profit</div>
            <div class="led-display" id="ledProfit">$32,830</div>
            <div class="led-sub"><span>Revenue - Costs</span><span class="led-trend up">+24.1%</span></div>
          </div>
          <div class="led-card cyan">
            <div class="led-label">Profit Margin</div>
            <div class="led-display" id="ledMargin">72.5%</div>
            <div class="led-sub"><span>Target: >60%</span><span class="led-trend up">+4.2%</span></div>
          </div>
          <div class="led-card red">
            <div class="led-label">Total Costs</div>
            <div class="led-display" id="ledCosts">$12,450</div>
            <div class="led-sub"><span>Budget: $15K</span><span class="led-trend down">-3.5%</span></div>
          </div>
          <div class="led-card gold">
            <div class="led-label">Gross Margin</div>
            <div class="led-display">78.0%</div>
            <div class="led-sub"><span>Target: >70%</span><span class="led-trend up">+1.5%</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- REVENUE - Speedometers + Thermal Bars -->
    <div class="kpi-group" id="kpiRevenue">
      <div class="kpi-group-header" onclick="toggleGroup('kpiRevenue')">
        <div class="kpi-group-title">Revenue</div>
        <div class="kpi-group-summary" id="revenueSummary">$45,280 MRR - $543K ARR</div>
        <div class="kpi-group-toggle">▼</div>
      </div>
      <div class="kpi-group-content">
        <div class="speedo-grid">
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">Monthly Recurring</span><span class="speedo-trend up">+18%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--cyan)" id="mrrGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val" style="color:var(--cyan)" id="mrrVal">$45,280</div><div class="speedo-unit">MRR</div><div class="speedo-foot"><span>Target: $50K</span><span>90%</span></div></div>
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">Annual Run Rate</span><span class="speedo-trend up">+15%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--green)" id="arrGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val" style="color:var(--green)" id="arrVal">$543K</div><div class="speedo-unit">ARR</div><div class="speedo-foot"><span>Target: $600K</span><span>91%</span></div></div>
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">Avg Rev Per User</span><span class="speedo-trend up">+$3.50</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--blue)" id="arpuGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val" style="color:var(--blue)" id="arpuVal">$33.75</div><div class="speedo-unit">ARPU</div><div class="speedo-foot"><span>Target: $40</span><span>84%</span></div></div>
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">Lifetime Value</span><span class="speedo-trend up">+$120</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--purple)" id="ltvGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val" style="color:var(--purple)" id="ltvVal">$1,245</div><div class="speedo-unit">LTV</div><div class="speedo-foot"><span>Target: $1.5K</span><span>83%</span></div></div>
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">Net Rev Retention</span><span class="speedo-trend up">+2%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--yellow)" id="nrrGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val" style="color:var(--yellow)">108%</div><div class="speedo-unit">NRR</div><div class="speedo-foot"><span>Target: >100%</span><span>Great</span></div></div>
        </div>
        <!-- Revenue by Tier - Thermal Bars -->
        <div style="margin-top:12px"><div style="font-size:9px;color:var(--muted);text-transform:uppercase;margin-bottom:8px">Revenue by Subscription Tier</div>
        <div class="thermal-grid">
          <div class="thermal-card"><div class="thermal-header"><span class="thermal-label">Enterprise ($299/mo)</span><span class="thermal-value" style="color:var(--gold)">$20,930</span></div><div class="thermal-bar"><div class="thermal-fill gradient-gold" style="width:46%"></div></div><div class="thermal-segments"><span>70 subscribers</span><span>46% of MRR</span></div></div>
          <div class="thermal-card"><div class="thermal-header"><span class="thermal-label">Pro ($49/mo)</span><span class="thermal-value" style="color:var(--purple)">$18,130</span></div><div class="thermal-bar"><div class="thermal-fill gradient-purple" style="width:40%"></div></div><div class="thermal-segments"><span>370 subscribers</span><span>40% of MRR</span></div></div>
          <div class="thermal-card"><div class="thermal-header"><span class="thermal-label">Basic ($19/mo)</span><span class="thermal-value" style="color:var(--blue)">$6,230</span></div><div class="thermal-bar"><div class="thermal-fill gradient-blue" style="width:14%"></div></div><div class="thermal-segments"><span>328 subscribers</span><span>14% of MRR</span></div></div>
          <div class="thermal-card"><div class="thermal-header"><span class="thermal-label">Free Users</span><span class="thermal-value" style="color:var(--green)">1,505</span></div><div class="thermal-bar"><div class="thermal-fill gradient-green" style="width:53%"></div></div><div class="thermal-segments"><span>Conversion target: 15%</span><span>53% of users</span></div></div>
        </div>
        </div>
      </div>
    </div>

    <!-- CUSTOMERS - Ring Gauges -->
    <div class="kpi-group" id="kpiCustomers">
      <div class="kpi-group-header" onclick="toggleGroup('kpiCustomers')">
        <div class="kpi-group-title">Customers & Growth</div>
        <div class="kpi-group-summary">2,847 users - 1,342 subscribers - 3.2% churn</div>
        <div class="kpi-group-toggle">▼</div>
      </div>
      <div class="kpi-group-content">
        <div class="ring-grid">
          <div class="ring-card"><div class="ring-gauge"><svg viewBox="0 0 36 36"><circle class="ring-bg" cx="18" cy="18" r="15.9"/><circle class="ring-fill" style="stroke:var(--green)" cx="18" cy="18" r="15.9" stroke-dasharray="57 100"/></svg><div class="ring-center" style="color:var(--green)">57%</div></div><div class="ring-label">Total Users</div><div class="ring-value">2,847</div><div class="ring-trend up">+12.5%</div></div>
          <div class="ring-card"><div class="ring-gauge"><svg viewBox="0 0 36 36"><circle class="ring-bg" cx="18" cy="18" r="15.9"/><circle class="ring-fill" style="stroke:var(--cyan)" cx="18" cy="18" r="15.9" stroke-dasharray="67 100"/></svg><div class="ring-center" style="color:var(--cyan)">67%</div></div><div class="ring-label">Subscribers</div><div class="ring-value">1,342</div><div class="ring-trend up">+8.7%</div></div>
          <div class="ring-card"><div class="ring-gauge"><svg viewBox="0 0 36 36"><circle class="ring-bg" cx="18" cy="18" r="15.9"/><circle class="ring-fill" style="stroke:var(--purple)" cx="18" cy="18" r="15.9" stroke-dasharray="89 100"/></svg><div class="ring-center" style="color:var(--purple)">89</div></div><div class="ring-label">Active Trials</div><div class="ring-value">89</div><div class="ring-trend up">+15</div></div>
          <div class="ring-card"><div class="ring-gauge"><svg viewBox="0 0 36 36"><circle class="ring-bg" cx="18" cy="18" r="15.9"/><circle class="ring-fill" style="stroke:var(--blue)" cx="18" cy="18" r="15.9" stroke-dasharray="22.5 100"/></svg><div class="ring-center" style="color:var(--blue)">22%</div></div><div class="ring-label">Conversion</div><div class="ring-value">22.5%</div><div class="ring-trend up">+2.1%</div></div>
          <div class="ring-card"><div class="ring-gauge"><svg viewBox="0 0 36 36"><circle class="ring-bg" cx="18" cy="18" r="15.9"/><circle class="ring-fill" style="stroke:var(--orange)" cx="18" cy="18" r="15.9" stroke-dasharray="3.2 100"/></svg><div class="ring-center" style="color:var(--orange)">3.2</div></div><div class="ring-label">Churn Rate</div><div class="ring-value">3.2%</div><div class="ring-trend down">-0.8%</div></div>
        </div>
      </div>
    </div>

    <!-- COSTS - Equalizer Bars -->
    <div class="kpi-group" id="kpiCosts">
      <div class="kpi-group-header" onclick="toggleGroup('kpiCosts')">
        <div class="kpi-group-title">Cost Breakdown</div>
        <div class="kpi-group-summary">$12,450/mo total - 27.5% of revenue</div>
        <div class="kpi-group-toggle">▼</div>
      </div>
      <div class="kpi-group-content">
        <div class="equalizer-grid">
          <div class="eq-card"><div class="eq-label">Infrastructure</div><div class="eq-display"><div class="eq-bar" style="height:50px"><div class="eq-bar-fill red" style="height:64%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill red" style="height:45%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill red" style="height:78%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill red" style="height:52%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill red" style="height:60%"></div></div></div><div class="eq-value" style="color:var(--red)">$4,850</div><div class="eq-footer"><span>39% of costs</span><span>-2%</span></div></div>
          <div class="eq-card"><div class="eq-label">3rd Party Services</div><div class="eq-display"><div class="eq-bar" style="height:50px"><div class="eq-bar-fill orange" style="height:42%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill orange" style="height:55%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill orange" style="height:38%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill orange" style="height:48%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill orange" style="height:44%"></div></div></div><div class="eq-value" style="color:var(--orange)">$2,540</div><div class="eq-footer"><span>20% of costs</span><span>0%</span></div></div>
          <div class="eq-card"><div class="eq-label">Payment Processing</div><div class="eq-display"><div class="eq-bar" style="height:50px"><div class="eq-bar-fill yellow" style="height:35%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill yellow" style="height:42%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill yellow" style="height:38%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill yellow" style="height:45%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill yellow" style="height:40%"></div></div></div><div class="eq-value" style="color:var(--yellow)">$1,810</div><div class="eq-footer"><span>15% of costs</span><span>+4%</span></div></div>
          <div class="eq-card"><div class="eq-label">Support & Ops</div><div class="eq-display"><div class="eq-bar" style="height:50px"><div class="eq-bar-fill blue" style="height:52%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill blue" style="height:48%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill blue" style="height:55%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill blue" style="height:45%"></div></div><div class="eq-bar" style="height:50px"><div class="eq-bar-fill blue" style="height:50%"></div></div></div><div class="eq-value" style="color:var(--blue)">$3,250</div><div class="eq-footer"><span>26% of costs</span><span>-5%</span></div></div>
        </div>
        <!-- Individual Costs -->
        <div class="cost-breakdown" style="margin-top:12px">
          <div class="cost-item"><div class="cost-dot good"></div><div class="cost-info"><div class="cost-name">AWS Hosting</div><div class="cost-amount">$3,200/mo</div></div><div class="cost-pct">25.7%</div></div>
          <div class="cost-item"><div class="cost-dot good"></div><div class="cost-info"><div class="cost-name">Cloudflare CDN</div><div class="cost-amount">$850/mo</div></div><div class="cost-pct">6.8%</div></div>
          <div class="cost-item"><div class="cost-dot good"></div><div class="cost-info"><div class="cost-name">Supabase Pro</div><div class="cost-amount">$800/mo</div></div><div class="cost-pct">6.4%</div></div>
          <div class="cost-item"><div class="cost-dot good"></div><div class="cost-info"><div class="cost-name">SendGrid</div><div class="cost-amount">$450/mo</div></div><div class="cost-pct">3.6%</div></div>
          <div class="cost-item"><div class="cost-dot mid"></div><div class="cost-info"><div class="cost-name">Auth0</div><div class="cost-amount">$680/mo</div></div><div class="cost-pct">5.5%</div></div>
          <div class="cost-item"><div class="cost-dot good"></div><div class="cost-info"><div class="cost-name">DataDog</div><div class="cost-amount">$520/mo</div></div><div class="cost-pct">4.2%</div></div>
          <div class="cost-item"><div class="cost-dot mid"></div><div class="cost-info"><div class="cost-name">Intercom</div><div class="cost-amount">$890/mo</div></div><div class="cost-pct">7.1%</div></div>
          <div class="cost-item"><div class="cost-dot mid"></div><div class="cost-info"><div class="cost-name">Stripe Fees</div><div class="cost-amount">$1,810/mo</div></div><div class="cost-pct">14.5%</div></div>
          <div class="cost-item"><div class="cost-dot mid"></div><div class="cost-info"><div class="cost-name">Support Staff</div><div class="cost-amount">$1,800/mo</div></div><div class="cost-pct">14.5%</div></div>
        </div>
      </div>
    </div>

    <!-- ACQUISITION - Speedos -->
    <div class="kpi-group" id="kpiAcquisition">
      <div class="kpi-group-header" onclick="toggleGroup('kpiAcquisition')">
        <div class="kpi-group-title">Acquisition</div>
        <div class="kpi-group-summary">$125 CAC - 9.9:1 LTV:CAC - 3.7mo payback</div>
        <div class="kpi-group-toggle">▼</div>
      </div>
      <div class="kpi-group-content">
        <div class="speedo-grid" style="grid-template-columns:repeat(3,1fr)">
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">Customer Acq Cost</span><span class="speedo-trend down">-$8</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--red)" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="78 126"/></svg></div><div class="speedo-val" style="color:var(--red)">$125</div><div class="speedo-unit">CAC</div><div class="speedo-foot"><span>Target: <$150</span><span>Good</span></div></div>
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">LTV:CAC Ratio</span><span class="speedo-trend up">+0.8</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--pink)" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="99 126"/></svg></div><div class="speedo-val" style="color:var(--pink)">9.9:1</div><div class="speedo-unit">LTV / CAC</div><div class="speedo-foot"><span>Target: >3:1</span><span>Excellent</span></div></div>
          <div class="speedo"><div class="speedo-head"><span class="speedo-label">Payback Period</span><span class="speedo-trend down">-0.3mo</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill" style="stroke:var(--green)" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="39 126"/></svg></div><div class="speedo-val" style="color:var(--green)">3.7</div><div class="speedo-unit">Months</div><div class="speedo-foot"><span>Target: <12</span><span>Fast</span></div></div>
        </div>
      </div>
    </div>

    <!-- SUPPORT - Sparklines -->
    <div class="kpi-group" id="kpiSupport">
      <div class="kpi-group-header" onclick="toggleGroup('kpiSupport')">
        <div class="kpi-group-title">Support & Engagement</div>
        <div class="kpi-group-summary" id="supportSummary">2 open - 2.1h response - 4.8 CSAT</div>
        <div class="kpi-group-toggle">▼</div>
      </div>
      <div class="kpi-group-content">
        <div class="spark-grid">
          <div class="spark-card"><div class="spark-header"><span class="spark-label">Open Tickets</span></div><div class="spark-value" style="color:var(--blue)" id="sparkOpen">2</div><div class="spark-line"><svg viewBox="0 0 100 30"><path class="spark-path" style="stroke:var(--blue)" d="M0,25 L20,20 L40,22 L60,15 L80,18 L100,10"/><path class="spark-area" style="fill:var(--blue)" d="M0,25 L20,20 L40,22 L60,15 L80,18 L100,10 L100,30 L0,30 Z"/></svg></div><div class="spark-footer"><span>Target: <10</span><span style="color:var(--green)">Good</span></div></div>
          <div class="spark-card"><div class="spark-header"><span class="spark-label">Avg Response</span></div><div class="spark-value" style="color:var(--purple)">2.1h</div><div class="spark-line"><svg viewBox="0 0 100 30"><path class="spark-path" style="stroke:var(--purple)" d="M0,20 L20,22 L40,18 L60,15 L80,12 L100,8"/><path class="spark-area" style="fill:var(--purple)" d="M0,20 L20,22 L40,18 L60,15 L80,12 L100,8 L100,30 L0,30 Z"/></svg></div><div class="spark-footer"><span>Target: <4h</span><span style="color:var(--green)">Fast</span></div></div>
          <div class="spark-card"><div class="spark-header"><span class="spark-label">Resolution Rate</span></div><div class="spark-value" style="color:var(--green)">88%</div><div class="spark-line"><svg viewBox="0 0 100 30"><path class="spark-path" style="stroke:var(--green)" d="M0,20 L20,18 L40,15 L60,12 L80,10 L100,5"/><path class="spark-area" style="fill:var(--green)" d="M0,20 L20,18 L40,15 L60,12 L80,10 L100,5 L100,30 L0,30 Z"/></svg></div><div class="spark-footer"><span>Target: >80%</span><span style="color:var(--green)">Excellent</span></div></div>
          <div class="spark-card"><div class="spark-header"><span class="spark-label">CSAT Score</span></div><div class="spark-value" style="color:var(--cyan)">4.8</div><div class="spark-line"><svg viewBox="0 0 100 30"><path class="spark-path" style="stroke:var(--cyan)" d="M0,18 L20,15 L40,12 L60,10 L80,8 L100,5"/><path class="spark-area" style="fill:var(--cyan)" d="M0,18 L20,15 L40,12 L60,10 L80,8 L100,5 L100,30 L0,30 Z"/></svg></div><div class="spark-footer"><span>Out of 5.0</span><span style="color:var(--green)">Great</span></div></div>
          <div class="spark-card"><div class="spark-header"><span class="spark-label">NPS Score</span></div><div class="spark-value" style="color:var(--yellow)">68</div><div class="spark-line"><svg viewBox="0 0 100 30"><path class="spark-path" style="stroke:var(--yellow)" d="M0,22 L20,18 L40,15 L60,12 L80,10 L100,8"/><path class="spark-area" style="fill:var(--yellow)" d="M0,22 L20,18 L40,15 L60,12 L80,10 L100,8 L100,30 L0,30 Z"/></svg></div><div class="spark-footer"><span>Target: >50</span><span style="color:var(--green)">Excellent</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD TAB -->
  <div class="tab-content active" id="dashboard"></div>

  <!-- TENANTS TAB -->
  <div class="tab-content" id="tenants">
    <div class="panel">
      <div class="panel-head">
        <span class="panel-title">Tenant Management</span>
        <div style="display:flex;gap:6px">
          <input type="text" id="tenantSearch" placeholder="Search..." style="font-size:10px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);width:150px" oninput="filterTenants()">
          <button class="btn" onclick="loadTenants()">Refresh</button>
          <button class="btn btn-success">+ Add Tenant</button>
        </div>
      </div>
      <div id="tenantsLoading" class="loading">Loading...</div>
      <div style="overflow-x:auto"><table class="table" id="tenantsTable" style="display:none"><thead><tr><th>Company</th><th>Owner</th><th>Tier</th><th>MRR</th><th>Users</th><th>Status</th><th>Actions</th></tr></thead><tbody id="tenantsBody"></tbody></table></div>
    </div>
  </div>

  <!-- SUPPORT TAB -->
  <div class="tab-content" id="support">
    <div class="support-stats">
      <div class="stat-card open" onclick="filterByStatus('open')"><div class="val" id="statOpen">0</div><div class="lbl">Open</div></div>
      <div class="stat-card progress" onclick="filterByStatus('in_progress')"><div class="val" id="statProgress">0</div><div class="lbl">In Progress</div></div>
      <div class="stat-card waiting" onclick="filterByStatus('waiting_on_customer')"><div class="val" id="statWaiting">0</div><div class="lbl">Waiting</div></div>
      <div class="stat-card resolved" onclick="filterByStatus('resolved')"><div class="val" id="statResolved">0</div><div class="lbl">Resolved</div></div>
      <div class="stat-card closed" onclick="filterByStatus('closed')"><div class="val" id="statClosed">0</div><div class="lbl">Closed</div></div>
      <div class="stat-card urgent" onclick="filterByStatus('urgent')"><div class="val" id="statUrgent">0</div><div class="lbl">Urgent</div></div>
    </div>
    <div class="panel">
      <div class="panel-head"><span class="panel-title">Support Tickets</span><div style="display:flex;gap:6px"><button class="btn" onclick="loadTickets()">Refresh</button><button class="btn btn-primary">Export</button></div></div>
      <div class="filters">
        <input type="text" id="ticketSearch" placeholder="Search..." oninput="filterTickets()">
        <select id="statusFilter" onchange="filterTickets()"><option value="">All Status</option><option value="open">Open</option><option value="in_progress">In Progress</option><option value="waiting_on_customer">Waiting</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select>
        <select id="priorityFilter" onchange="filterTickets()"><option value="">All Priority</option><option value="urgent">Urgent</option><option value="high">High</option><option value="normal">Normal</option><option value="low">Low</option></select>
      </div>
      <div id="ticketsLoading" class="loading">Loading...</div>
      <div style="overflow-x:auto"><table class="table" id="ticketsTable" style="display:none"><thead><tr><th>ID</th><th>Subject</th><th>Submitter</th><th>Tenant</th><th>Priority</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody id="ticketsBody"></tbody></table></div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab-content" id="settings">
    <!-- Subscription Tiers -->
    <div class="panel">
      <div class="panel-head"><span class="panel-title">Subscription Tiers</span><button class="btn btn-primary btn-sm">+ Add Tier</button></div>
      <div class="tier-grid">
        <div class="tier-card free"><div class="tier-name">Free</div><div class="tier-price">$0<span>/mo</span></div><div class="tier-desc">For individuals getting started</div><ul class="tier-features"><li>1 user</li><li>100 records</li><li>Basic support</li><li>Community access</li></ul><div class="tier-stats"><div><span>Users: </span><span class="tier-stat-value">1,505</span></div><div><span>Conv: </span><span class="tier-stat-value">12%</span></div></div></div>
        <div class="tier-card basic"><div class="tier-name">Basic</div><div class="tier-price">$19<span>/mo</span></div><div class="tier-desc">For small teams</div><ul class="tier-features"><li>5 users</li><li>1,000 records</li><li>Email support</li><li>API access</li><li>Integrations</li></ul><div class="tier-stats"><div><span>Subs: </span><span class="tier-stat-value">328</span></div><div><span>MRR: </span><span class="tier-stat-value">$6,232</span></div></div></div>
        <div class="tier-card pro featured"><div class="tier-name">Pro</div><div class="tier-price">$49<span>/mo</span></div><div class="tier-desc">For growing businesses</div><ul class="tier-features"><li>25 users</li><li>10,000 records</li><li>Priority support</li><li>Advanced analytics</li><li>Custom branding</li><li>Webhooks</li></ul><div class="tier-stats"><div><span>Subs: </span><span class="tier-stat-value">370</span></div><div><span>MRR: </span><span class="tier-stat-value">$18,130</span></div></div></div>
        <div class="tier-card enterprise"><div class="tier-name">Enterprise</div><div class="tier-price">$299<span>/mo</span></div><div class="tier-desc">For large organizations</div><ul class="tier-features"><li>Unlimited users</li><li>Unlimited records</li><li>24/7 phone support</li><li>Dedicated account mgr</li><li>SLA guarantee</li><li>Custom integrations</li><li>On-premise option</li></ul><div class="tier-stats"><div><span>Subs: </span><span class="tier-stat-value">70</span></div><div><span>MRR: </span><span class="tier-stat-value">$20,930</span></div></div></div>
      </div>
    </div>

    <!-- Feature Flags - Hexagonal -->
    <div class="panel">
      <div class="panel-head"><span class="panel-title">Feature Flags</span><button class="btn btn-primary btn-sm">+ Add Flag</button></div>
      <div class="hex-grid">
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">Dark Mode</div><div class="hex-status on">ON</div></div>
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">Analytics V2</div><div class="hex-status on">ON</div></div>
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">Push Notifs</div><div class="hex-status on">ON</div></div>
        <div class="hex-cell disabled" onclick="toggleFeature(this)"><div class="hex-label">AI Assistant</div><div class="hex-status off">OFF</div></div>
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">File Upload</div><div class="hex-status on">ON</div></div>
        <div class="hex-cell disabled" onclick="toggleFeature(this)"><div class="hex-label">SSO</div><div class="hex-status off">OFF</div></div>
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">Email Digest</div><div class="hex-status on">ON</div></div>
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">2FA</div><div class="hex-status on">ON</div></div>
        <div class="hex-cell disabled" onclick="toggleFeature(this)"><div class="hex-label">Beta Features</div><div class="hex-status off">OFF</div></div>
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">Mobile App</div><div class="hex-status on">ON</div></div>
        <div class="hex-cell disabled" onclick="toggleFeature(this)"><div class="hex-label">Multi-lang</div><div class="hex-status off">OFF</div></div>
        <div class="hex-cell enabled" onclick="toggleFeature(this)"><div class="hex-label">Webhooks</div><div class="hex-status on">ON</div></div>
      </div>
    </div>

    <!-- Platform Settings -->
    <div class="settings-grid">
      <div class="settings-section">
        <div class="settings-section-title">Platform Configuration</div>
        <div class="form-row"><div class="form-group"><label class="form-label">Platform Name</label><input type="text" class="form-input" value="My SaaS Platform"></div><div class="form-group"><label class="form-label">Domain</label><input type="text" class="form-input" value="app.mysaas.com"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Support Email</label><input type="email" class="form-input" value="support@mysaas.com"></div><div class="form-group"><label class="form-label">Billing Email</label><input type="email" class="form-input" value="billing@mysaas.com"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Default Trial Days</label><input type="number" class="form-input" value="14"></div><div class="form-group"><label class="form-label">Max Users (Free)</label><input type="number" class="form-input" value="1"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Security Settings</div>
        <div class="form-row"><div class="form-group"><label class="form-label">Session Timeout (min)</label><input type="number" class="form-input" value="60"></div><div class="form-group"><label class="form-label">Max Login Attempts</label><input type="number" class="form-input" value="5"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Password Min Length</label><input type="number" class="form-input" value="8"></div><div class="form-group"><label class="form-label">Require 2FA (Pro+)</label><select class="form-select"><option>Optional</option><option>Required</option></select></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">IP Whitelist</label><input type="text" class="form-input" placeholder="Comma separated IPs"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Billing Settings</div>
        <div class="form-row"><div class="form-group"><label class="form-label">Stripe Mode</label><select class="form-select"><option>Live</option><option>Test</option></select></div><div class="form-group"><label class="form-label">Currency</label><select class="form-select"><option>USD</option><option>EUR</option><option>GBP</option></select></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Tax Rate (%)</label><input type="number" class="form-input" value="0"></div><div class="form-group"><label class="form-label">Grace Period (days)</label><input type="number" class="form-input" value="3"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Email Settings</div>
        <div class="form-row"><div class="form-group"><label class="form-label">From Name</label><input type="text" class="form-input" value="My SaaS"></div><div class="form-group"><label class="form-label">From Email</label><input type="email" class="form-input" value="noreply@mysaas.com"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Welcome Email</label><select class="form-select"><option>Enabled</option><option>Disabled</option></select></div><div class="form-group"><label class="form-label">Weekly Digest</label><select class="form-select"><option>Enabled</option><option>Disabled</option></select></div></div>
      </div>
    </div>
    <div style="text-align:right;margin-top:12px"><button class="btn btn-success">Save All Settings</button></div>
  </div>
</div>

<!-- TICKET MODAL -->
<div class="modal" id="ticketModal">
  <div class="modal-box">
    <div class="modal-head"><span class="modal-title"><span id="modalTitle">Ticket</span> <span class="status-badge status-open" id="modalStatus" style="margin-left:8px">Open</span></span><button class="modal-close" onclick="closeModal()">&times;</button></div>
    <div class="modal-body">
      <div class="detail-grid">
        <div>
          <h3 id="modalSubject" style="font-size:14px;margin-bottom:12px"></h3>
          <div class="desc-box" id="modalDesc"></div>
          <div style="font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:10px;color:var(--text2)">Conversation</div>
          <div id="commentsList"></div>
          <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
            <div class="reply-tabs"><button class="reply-tab active" onclick="setReplyType('public',this)">Reply</button><button class="reply-tab internal" onclick="setReplyType('internal',this)">Internal</button></div>
            <textarea id="replyText" placeholder="Type response..."></textarea>
            <div class="quick-actions"><button class="btn btn-sm btn-success" onclick="submitReply()">Send</button><select id="quickStatus" onchange="quickChangeStatus()" style="font-size:9px;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text)"><option value="">Status...</option><option value="in_progress">In Progress</option><option value="waiting_on_customer">Waiting</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select></div>
          </div>
        </div>
        <div>
          <div class="meta-card"><h4>Ticket Info</h4><div class="meta-row"><span class="lbl">Number</span><span class="val" id="metaNumber">--</span></div><div class="meta-row"><span class="lbl">Created</span><span class="val" id="metaCreated">--</span></div><div class="meta-row"><span class="lbl">Category</span><span class="val" id="metaCategory">--</span></div></div>
          <div class="meta-card"><h4>Submitter</h4><div class="meta-row"><span class="lbl">Name</span><span class="val" id="metaName">--</span></div><div class="meta-row"><span class="lbl">Email</span><span class="val" id="metaEmail">--</span></div><div class="meta-row"><span class="lbl">Tenant</span><span class="val" id="metaTenant">--</span></div></div>
          <div class="meta-card"><h4>Actions</h4>
            <button class="btn btn-warning btn-sm" style="width:100%;margin-bottom:6px" onclick="viewAsTenant()">View as Tenant</button>
            <button class="btn btn-danger btn-sm" style="width:100%" onclick="loginAsTenant()">Login as Tenant</button>
          </div>
          <div class="meta-card"><h4>Manage</h4><div style="margin-bottom:8px"><label class="form-label">Status</label><select class="form-select" id="statusSelect" onchange="updateStatus()"><option value="open">Open</option><option value="in_progress">In Progress</option><option value="waiting_on_customer">Waiting</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select></div><div><label class="form-label">Priority</label><select class="form-select" id="prioritySelect" onchange="updatePriority()"><option value="low">Low</option><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const SB='https://kxqkwpkmtgvmthpafoqx.supabase.co',SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
let conn=false,tenants=[],tickets=[],curId=null,rType='public',impersonating=null;

async function init(){await checkConn();await Promise.all([loadTenants(),loadTickets()]);updateIndicators();gauge('mrrGauge',90);gauge('arrGauge',91);gauge('arpuGauge',84);gauge('ltvGauge',83);gauge('nrrGauge',80)}
async function checkConn(){try{const r=await fetch(SB+'/rest/v1/tenants?select=tenant_id&limit=1',{headers:{apikey:SK,Authorization:'Bearer '+SK}});if(r.ok)conn=true;document.getElementById('dbLight').className='light on'}catch{conn=false;document.getElementById('dbLight').className='light alert'}}
function gauge(id,pct){const e=document.getElementById(id);if(e)e.setAttribute('stroke-dasharray',(pct/100*126)+' 126')}
function toggleGroup(id){document.getElementById(id).classList.toggle('collapsed')}
function collapseAllKPIs(){document.querySelectorAll('.kpi-group').forEach(g=>g.classList.add('collapsed'))}
function expandAllKPIs(){document.querySelectorAll('.kpi-group').forEach(g=>g.classList.remove('collapsed'))}

function switchTab(t){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(t).classList.add('active');
  if(t==='dashboard'){document.getElementById('kpiGroups').style.display='block';expandAllKPIs()}
  else{document.getElementById('kpiGroups').style.display='none'}
  if(t==='support')loadTickets()
}

function updateIndicators(){
  const open=tickets.filter(t=>t.status==='open').length,urgent=tickets.filter(t=>t.priority==='urgent'&&t.status!=='closed').length;
  const al=document.getElementById('alertLight'),at=document.getElementById('alertText');
  if(urgent>0){al.className='light alert';at.textContent=urgent+' Urg'}
  else if(open>5){al.className='light warn';at.textContent=open+' Open'}
  else{al.className='light on';at.textContent='OK'}
  document.getElementById('profitLight').className='light on';
  document.getElementById('profitText').textContent='Profit';
  document.getElementById('sparkOpen').textContent=open;
  document.getElementById('supportSummary').textContent=open+' open - 2.1h response - 4.8 CSAT';
}

// TENANTS
async function loadTenants(){document.getElementById('tenantsLoading').style.display='block';document.getElementById('tenantsTable').style.display='none';if(conn){try{const r=await fetch(SB+'/rest/v1/tenants?select=*&order=created_at.desc',{headers:{apikey:SK,Authorization:'Bearer '+SK}});if(r.ok)tenants=await r.json()}catch(e){}}if(!tenants.length)tenants=[{tenant_id:'1',company_name:'Acme Corp',billing_email:'admin@acme.com',status:'active',monthly_recurring_revenue:299,user_count:12,tier_id:'enterprise'},{tenant_id:'2',company_name:'TechStart Inc',billing_email:'hello@techstart.io',status:'active',monthly_recurring_revenue:49,user_count:5,tier_id:'pro'},{tenant_id:'3',company_name:'Demo Co',billing_email:'demo@example.com',status:'trial',monthly_recurring_revenue:0,user_count:2,tier_id:'basic'},{tenant_id:'4',company_name:'BigCorp Ltd',billing_email:'it@bigcorp.com',status:'active',monthly_recurring_revenue:299,user_count:45,tier_id:'enterprise'},{tenant_id:'5',company_name:'Starter LLC',billing_email:'info@starter.io',status:'active',monthly_recurring_revenue:19,user_count:3,tier_id:'basic'}];renderTenants()}
function renderTenants(){document.getElementById('tenantsLoading').style.display='none';document.getElementById('tenantsTable').style.display='table';document.getElementById('tenantsBody').innerHTML=tenants.map(t=>'<tr><td><strong>'+(t.company_name||'Unknown')+'</strong></td><td>'+(t.billing_email||'-')+'</td><td><span class="badge badge-'+(t.tier_id==='enterprise'?'gold':t.tier_id==='pro'?'purple':'blue')+'">'+(t.tier_id||'basic')+'</span></td><td style="color:var(--green)">$'+(t.monthly_recurring_revenue||0)+'</td><td>'+(t.user_count||1)+'</td><td><span class="badge badge-'+(t.status==='active'?'green':'orange')+'">'+(t.status||'unknown')+'</span></td><td><button class="btn btn-sm" onclick="viewAsTenantById(\''+t.tenant_id+'\')">View</button> <button class="btn btn-sm btn-warning" onclick="loginAsTenantById(\''+t.tenant_id+'\')">Login</button> <button class="btn btn-sm">Edit</button></td></tr>').join('')}
function filterTenants(){const s=document.getElementById('tenantSearch').value.toLowerCase();document.querySelectorAll('#tenantsBody tr').forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(s)?'':'none'})}

// IMPERSONATION
function viewAsTenantById(id){const t=tenants.find(x=>x.tenant_id===id);if(!t)return;impersonating=t;document.getElementById('impersonateBanner').classList.add('active');document.getElementById('impersonateName').textContent=t.company_name;document.getElementById('impersonateEmail').textContent=t.billing_email;alert('Now viewing as: '+t.company_name+'\n\nIn a real implementation, this would load the tenant\'s dashboard view without logging them in.')}
function loginAsTenantById(id){const t=tenants.find(x=>x.tenant_id===id);if(!t)return;if(!confirm('LOGIN AS TENANT\n\nThis will create a session as:\n'+t.company_name+' ('+t.billing_email+')\n\nThis action is logged for security.\n\nContinue?'))return;impersonating=t;document.getElementById('impersonateBanner').classList.add('active');document.getElementById('impersonateName').textContent=t.company_name;document.getElementById('impersonateEmail').textContent=t.billing_email;alert('Logged in as: '+t.company_name+'\n\nIn a real implementation, this would create an authenticated session as this tenant for debugging.')}
function viewAsTenant(){const t=tenants.find(x=>x.company_name===document.getElementById('metaTenant').textContent);if(t)viewAsTenantById(t.tenant_id);else alert('Tenant not found')}
function loginAsTenant(){const t=tenants.find(x=>x.company_name===document.getElementById('metaTenant').textContent);if(t)loginAsTenantById(t.tenant_id);else alert('Tenant not found')}
function exitImpersonation(){impersonating=null;document.getElementById('impersonateBanner').classList.remove('active');alert('Exited tenant view. Back to super admin mode.')}

// TICKETS
async function loadTickets(){document.getElementById('ticketsLoading').style.display='block';document.getElementById('ticketsTable').style.display='none';if(conn){try{const r=await fetch(SB+'/rest/v1/support_tickets?select=*&order=created_at.desc',{headers:{apikey:SK,Authorization:'Bearer '+SK}});if(r.ok)tickets=await r.json()}catch(e){}}if(!tickets.length)tickets=[{ticket_id:'1',ticket_number:'1001',subject:'Cannot login',submitter_email:'user@acme.com',submitter_name:'John Doe',tenant_name:'Acme Corp',category:'account',priority:'high',status:'open',created_at:new Date().toISOString(),description:'Unable to login since yesterday.'},{ticket_id:'2',ticket_number:'1002',subject:'Feature request: Dark mode',submitter_email:'jane@techstart.io',submitter_name:'Jane Smith',tenant_name:'TechStart Inc',category:'feature',priority:'normal',status:'in_progress',created_at:new Date(Date.now()-86400000).toISOString(),description:'Would love dark mode.'},{ticket_id:'3',ticket_number:'1003',subject:'URGENT: Billing issue',submitter_email:'billing@bigcorp.com',submitter_name:'Mike Johnson',tenant_name:'BigCorp Ltd',category:'billing',priority:'urgent',status:'open',created_at:new Date(Date.now()-172800000).toISOString(),description:'Charged twice. Refund needed.'},{ticket_id:'4',ticket_number:'1004',subject:'Export not working',submitter_email:'sarah@demo.com',submitter_name:'Sarah Chen',tenant_name:'Demo Co',category:'bug',priority:'high',status:'waiting_on_customer',created_at:new Date(Date.now()-259200000).toISOString(),description:'CSV export empty.'},{ticket_id:'5',ticket_number:'1005',subject:'API question',submitter_email:'dev@starter.io',submitter_name:'Alex Dev',tenant_name:'Starter LLC',category:'general',priority:'low',status:'resolved',created_at:new Date(Date.now()-345600000).toISOString(),description:'Rate limits?'}];updateTicketStats();renderTickets();updateIndicators()}
function updateTicketStats(){const c={open:tickets.filter(t=>t.status==='open').length,progress:tickets.filter(t=>t.status==='in_progress').length,waiting:tickets.filter(t=>t.status==='waiting_on_customer').length,resolved:tickets.filter(t=>t.status==='resolved').length,closed:tickets.filter(t=>t.status==='closed').length,urgent:tickets.filter(t=>t.priority==='urgent'&&t.status!=='closed'&&t.status!=='resolved').length};document.getElementById('statOpen').textContent=c.open;document.getElementById('statProgress').textContent=c.progress;document.getElementById('statWaiting').textContent=c.waiting;document.getElementById('statResolved').textContent=c.resolved;document.getElementById('statClosed').textContent=c.closed;document.getElementById('statUrgent').textContent=c.urgent;const b=document.getElementById('ticketBadge');if(c.open>0){b.textContent=c.open;b.style.display='inline'}else b.style.display='none'}
function renderTickets(){document.getElementById('ticketsLoading').style.display='none';document.getElementById('ticketsTable').style.display='table';let f=[...tickets];const s=document.getElementById('ticketSearch').value.toLowerCase(),st=document.getElementById('statusFilter').value,pr=document.getElementById('priorityFilter').value;if(s)f=f.filter(t=>(t.subject+' '+t.submitter_email).toLowerCase().includes(s));if(st)f=f.filter(t=>t.status===st);if(pr)f=f.filter(t=>t.priority===pr);document.getElementById('ticketsBody').innerHTML=f.map(t=>'<tr style="cursor:pointer" onclick="openTicket(\''+t.ticket_id+'\')"><td><strong>#'+(t.ticket_number||t.ticket_id.slice(0,6))+'</strong></td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t.subject)+'</td><td><div style="font-size:10px">'+esc(t.submitter_name||'Unknown')+'</div><div style="font-size:8px;color:var(--muted)">'+esc(t.submitter_email||'')+'</div></td><td><span class="badge badge-cyan">'+(t.tenant_name||'-')+'</span></td><td><span class="priority-dot '+t.priority+'"></span>'+t.priority+'</td><td><span class="status-badge status-'+t.status+'">'+fmtStatus(t.status)+'</span></td><td style="font-size:9px;color:var(--muted)">'+fmtDate(t.created_at)+'</td><td><button class="btn btn-sm">View</button></td></tr>').join('')}
function filterTickets(){renderTickets()}
function filterByStatus(s){document.getElementById('ticketSearch').value='';document.getElementById('priorityFilter').value='';if(s==='urgent'){document.getElementById('statusFilter').value='';document.getElementById('priorityFilter').value='urgent'}else document.getElementById('statusFilter').value=s;renderTickets()}
function openTicket(id){curId=id;const t=tickets.find(x=>x.ticket_id===id);if(!t)return;document.getElementById('modalTitle').textContent='Ticket #'+(t.ticket_number||id.slice(0,6));document.getElementById('modalStatus').textContent=fmtStatus(t.status);document.getElementById('modalStatus').className='status-badge status-'+t.status;document.getElementById('modalSubject').textContent=t.subject;document.getElementById('modalDesc').textContent=t.description||'No description.';document.getElementById('metaNumber').textContent='#'+(t.ticket_number||id.slice(0,6));document.getElementById('metaCreated').textContent=fmtDateTime(t.created_at);document.getElementById('metaCategory').textContent=t.category||'-';document.getElementById('metaName').textContent=t.submitter_name||'Unknown';document.getElementById('metaEmail').textContent=t.submitter_email||'-';document.getElementById('metaTenant').textContent=t.tenant_name||'-';document.getElementById('statusSelect').value=t.status;document.getElementById('prioritySelect').value=t.priority;loadComments(id);document.getElementById('ticketModal').classList.add('active')}
async function loadComments(id){const c=document.getElementById('commentsList');c.innerHTML='<div class="loading">Loading...</div>';let comments=[];if(conn){try{const r=await fetch(SB+'/rest/v1/ticket_comments?ticket_id=eq.'+id+'&order=created_at.asc',{headers:{apikey:SK,Authorization:'Bearer '+SK}});if(r.ok)comments=await r.json()}catch(e){}}if(!comments.length)comments=[{comment_type:'customer',commenter_name:'Customer',content:'Initial submission',created_at:new Date(Date.now()-3600000).toISOString()},{comment_type:'agent',commenter_name:'Support',content:'Looking into this.',created_at:new Date(Date.now()-1800000).toISOString()}];c.innerHTML=comments.map(x=>'<div class="comment '+(x.comment_type==='agent'?'agent':'customer')+(x.is_internal?' internal':'')+'"><div class="comment-head"><span class="comment-author '+(x.comment_type==='agent'?'agent':'')+(x.is_internal?' internal':'')+'">'+esc(x.commenter_name||(x.comment_type==='agent'?'Support':'Customer'))+(x.is_internal?' <span style="font-size:7px;padding:2px 4px;border-radius:3px;background:rgba(255,149,0,.2);color:var(--orange)">Internal</span>':'')+'</span><span class="comment-time">'+fmtDateTime(x.created_at)+'</span></div><div class="comment-msg">'+esc(x.content)+'</div></div>').join('')}
function setReplyType(t,btn){rType=t;document.querySelectorAll('.reply-tab').forEach(x=>x.classList.remove('active'));btn.classList.add('active')}
async function submitReply(){const msg=document.getElementById('replyText').value.trim();if(!msg)return;if(conn){try{await fetch(SB+'/rest/v1/ticket_comments',{method:'POST',headers:{apikey:SK,Authorization:'Bearer '+SK,'Content-Type':'application/json',Prefer:'return=minimal'},body:JSON.stringify({ticket_id:curId,content:msg,comment_type:'agent',commenter_name:'Admin',is_internal:rType==='internal',created_at:new Date().toISOString()})})}catch(e){}}document.getElementById('replyText').value='';loadComments(curId)}
async function updateStatus(){const s=document.getElementById('statusSelect').value;if(conn){try{await fetch(SB+'/rest/v1/support_tickets?ticket_id=eq.'+curId,{method:'PATCH',headers:{apikey:SK,Authorization:'Bearer '+SK,'Content-Type':'application/json'},body:JSON.stringify({status:s})})}catch(e){}}document.getElementById('modalStatus').textContent=fmtStatus(s);document.getElementById('modalStatus').className='status-badge status-'+s;const t=tickets.find(x=>x.ticket_id===curId);if(t)t.status=s;updateTicketStats();renderTickets();updateIndicators()}
async function updatePriority(){const p=document.getElementById('prioritySelect').value;if(conn){try{await fetch(SB+'/rest/v1/support_tickets?ticket_id=eq.'+curId,{method:'PATCH',headers:{apikey:SK,Authorization:'Bearer '+SK,'Content-Type':'application/json'},body:JSON.stringify({priority:p})})}catch(e){}}const t=tickets.find(x=>x.ticket_id===curId);if(t)t.priority=p;updateTicketStats();renderTickets();updateIndicators()}
function quickChangeStatus(){const s=document.getElementById('quickStatus');if(!s.value)return;document.getElementById('statusSelect').value=s.value;updateStatus();s.value=''}
function closeModal(){document.getElementById('ticketModal').classList.remove('active');curId=null}

function toggleFeature(el){el.classList.toggle('enabled');el.classList.toggle('disabled');const st=el.querySelector('.hex-status');if(el.classList.contains('enabled')){st.textContent='ON';st.className='hex-status on'}else{st.textContent='OFF';st.className='hex-status off'}}
function fmtStatus(s){return{open:'Open',in_progress:'In Progress',waiting_on_customer:'Waiting',resolved:'Resolved',closed:'Closed'}[s]||s}
function fmtDate(d){return d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'--'}
function fmtDateTime(d){return d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'--'}
function esc(t){return t?t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):''}
function refreshAll(){loadTenants();loadTickets()}
function exportReport(){alert('Exporting report...')}
init();
</script>
</body>
</html>
