<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Scheduler</title>
  <style>
    /* ===== THEME SYSTEM ===== */
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
      --month-alt-bg: #0d1218;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
      --month-alt-bg: #0d1218;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373;
      --month-alt-bg: #161616;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8;
      --month-alt-bg: #141c2e;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa;
      --month-alt-bg: #0c0c0f;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0;
      --month-alt-bg: #0c111e;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff;
      --month-alt-bg: #101010;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf;
      --month-alt-bg: #0c1517;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80;
      --month-alt-bg: #0c130e;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
      touch-action: manipulation;
    }

    body { padding-bottom: 165px; }

    /* ===== HEADER ===== */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-btn, .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-appearance: none;
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    /* View Style Toggle */
    .view-style-toggle {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 10px;
      border: 1px solid var(--border-default);
    }

    .view-style-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .view-style-btn.active {
      background: var(--accent-primary);
      color: white;
    }

    /* ===== MAIN TABS ===== */
    .main-tabs {
      display: flex;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-default);
    }

    .main-tab {
      flex: 1;
      padding: 14px 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .main-tab.active {
      color: var(--accent-light);
      border-bottom-color: var(--accent-primary);
    }

    /* ===== DATE NAV CONTAINERS ===== */
    .date-nav-container {
      display: none;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }
    .date-nav-container.active { display: block; }

    /* ===== LANES DATE NAV ===== */
    .lanes-date-nav {
      padding: 12px 0;
    }

    /* Controls row - Today + Filters inline */
    .lanes-controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .lanes-controls-row::-webkit-scrollbar { display: none; }

    .lanes-today-btn {
      flex-shrink: 0;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--accent-primary);
      background: var(--accent-primary);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .lanes-filter-btn {
      flex-shrink: 0;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      -webkit-appearance: none;
    }

    .lanes-filter-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 20%, transparent);
      border-color: var(--accent-primary);
      color: var(--accent-light);
    }

    .lanes-filter-btn .count {
      background: var(--bg-hover);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    /* Date chips container */
    .lanes-date-chips-wrapper {
      position: relative;
    }

    .lanes-date-chips {
      display: flex;
      gap: 6px;
      padding: 0 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    .lanes-date-chips::-webkit-scrollbar { display: none; }

    /* Month section */
    .month-section {
      display: flex;
      gap: 6px;
      padding: 8px;
      border-radius: 12px;
      margin-right: 4px;
      flex-shrink: 0;
    }

    .month-section.even {
      background: var(--bg-secondary);
    }

    .month-section.odd {
      background: var(--month-alt-bg);
    }

    .month-label {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      transform: rotate(180deg);
      font-size: 9px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 4px 2px;
      opacity: 0.7;
    }

    .month-days {
      display: flex;
      gap: 6px;
    }

    .lanes-date-chip {
      flex-shrink: 0;
      padding: 8px 10px;
      border-radius: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 48px;
      -webkit-appearance: none;
    }

    .lanes-date-chip.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .lanes-date-chip.today {
      border-color: var(--accent-light);
    }

    .lanes-date-chip .day-name {
      font-size: 9px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .lanes-date-chip .day-num {
      font-size: 16px;
      font-weight: 700;
      margin-top: 2px;
    }

    .lanes-date-chip .job-count {
      font-size: 8px;
      margin-top: 2px;
      opacity: 0.8;
    }

    /* ===== STACK DATE NAV ===== */
    .stack-date-nav {
      padding: 12px 16px;
    }

    .stack-date-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .stack-arrow-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .stack-date-display {
      text-align: center;
      min-width: 140px;
    }

    .stack-date-label {
      font-size: 18px;
      font-weight: 700;
    }

    .stack-date-full {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .stack-period-tabs {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-bottom: 12px;
    }

    .stack-period-tab {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .stack-period-tab.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .stack-filters {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    /* ===== GRID DATE NAV ===== */
    .grid-date-nav {
      padding: 12px 16px;
    }

    .grid-period-toggle {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      justify-content: center;
    }

    .grid-period-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .grid-period-btn.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .grid-week-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .grid-week-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .grid-nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      -webkit-appearance: none;
    }

    .grid-week-label {
      font-size: 14px;
      font-weight: 600;
    }

    .grid-calendar-mini {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .grid-cal-day-header {
      text-align: center;
      font-size: 10px;
      color: var(--text-secondary);
      padding: 4px;
      font-weight: 600;
    }

    .grid-cal-day {
      aspect-ratio: 1;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      -webkit-appearance: none;
    }

    .grid-cal-day.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .grid-cal-day.has-jobs::after {
      content: '';
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--accent-light);
      margin-top: 2px;
    }

    .grid-cal-day.active.has-jobs::after {
      background: white;
    }

    .grid-filters {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      justify-content: center;
    }

    .filter-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      -webkit-appearance: none;
    }

    .filter-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 20%, transparent);
      border-color: var(--accent-primary);
      color: var(--accent-light);
    }

    .filter-btn .count {
      background: var(--bg-hover);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    /* ===== CONTENT ===== */
    .content-area { min-height: calc(100vh - 400px); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ===== LANES VIEW ===== */
    .lanes-container { padding: 16px 0; }
    .tech-lane { margin-bottom: 20px; }

    .lane-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      margin-bottom: 12px;
    }

    .lane-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tech-avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
      color: white;
    }
    .tech-avatar.green { background: #22c55e; }
    .tech-avatar.orange { background: #f97316; }
    .tech-avatar.purple { background: #8b5cf6; }

    .tech-details h3 { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
    .tech-details span { font-size: 13px; color: var(--text-secondary); }

    .lane-stats { display: flex; gap: 16px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 18px; font-weight: 700; }
    .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }

    .lane-cards {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 0 16px 8px;
      -webkit-overflow-scrolling: touch;
    }
    .lane-cards::-webkit-scrollbar { display: none; }

    /* ===== WORK ORDER CARD ===== */
    .wo-card {
      flex-shrink: 0;
      width: 220px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-default);
      padding: 12px 14px;
      cursor: pointer;
      position: relative;
      border-left: 4px solid var(--accent-primary);
    }

    .wo-card.status-in_progress { border-left-color: var(--accent-primary); }
    .wo-card.status-waiting { border-left-color: #eab308; }
    .wo-card.status-completed { border-left-color: #22c55e; }
    .wo-card.status-urgent { border-left-color: #ef4444; }

    .wo-card.fleet::after {
      content: 'FLEET';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 8px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      background: #14b8a6;
      color: white;
    }

    .card-time { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .card-customer {
      font-size: 15px; font-weight: 600; margin-bottom: 6px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      padding-right: 40px;
    }

    .card-info-row { display: flex; align-items: center; gap: 6px; }
    .card-vehicle {
      font-size: 12px; color: var(--text-secondary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px;
    }
    .card-dot { width: 3px; height: 3px; border-radius: 50%; background: var(--text-secondary); }

    .card-status {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      padding: 2px 6px; border-radius: 4px;
    }
    .card-status.in_progress { background: rgba(59,130,246,0.2); color: var(--accent-light); }
    .card-status.waiting { background: rgba(234,179,8,0.15); color: #eab308; }
    .card-status.completed { background: rgba(34,197,94,0.15); color: #22c55e; }
    .card-status.urgent { background: rgba(239,68,68,0.15); color: #ef4444; }
    .card-status.scheduled { background: var(--bg-hover); color: var(--text-secondary); }

    .card-amount { font-size: 13px; font-weight: 700; margin-left: auto; }

    .add-card {
      flex-shrink: 0;
      width: 80px;
      min-height: 70px;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 2px dashed var(--border-default);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
    }
    .add-card-icon {
      width: 24px; height: 24px; border-radius: 6px;
      background: var(--bg-hover);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: var(--text-secondary);
    }
    .add-card span { font-size: 10px; color: var(--text-secondary); }

    /* ===== STACK VIEW ===== */
    .stack-container { padding: 16px; }

    .stack-time-block { margin-bottom: 16px; }

    .stack-time-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-card);
      border-radius: 12px 12px 0 0;
      border: 1px solid var(--border-default);
      border-bottom: none;
    }

    .stack-time-label { font-size: 14px; font-weight: 700; color: var(--accent-light); }
    .stack-time-range { font-size: 12px; color: var(--text-secondary); }
    .stack-time-count {
      margin-left: auto;
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--bg-hover);
      padding: 4px 8px;
      border-radius: 6px;
    }

    .stack-tech-section {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-top: none;
    }

    .stack-tech-section:last-child { border-radius: 0 0 12px 12px; }

    .stack-tech-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      border-top: 1px solid var(--border-default);
    }

    .stack-tech-avatar {
      width: 32px; height: 32px; border-radius: 8px;
      background: var(--accent-primary);
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700; color: white;
    }
    .stack-tech-avatar.green { background: #22c55e; }
    .stack-tech-avatar.orange { background: #f97316; }
    .stack-tech-avatar.purple { background: #8b5cf6; }

    .stack-tech-name { font-size: 14px; font-weight: 600; flex: 1; }
    .stack-tech-summary { font-size: 12px; color: var(--text-secondary); }
    .stack-expand-icon { font-size: 12px; color: var(--text-secondary); transition: transform 0.2s; }
    .stack-tech-section.expanded .stack-expand-icon { transform: rotate(180deg); }

    .stack-jobs { display: none; padding: 0 16px 12px; }
    .stack-tech-section.expanded .stack-jobs { display: block; }

    .stack-job-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 8px;
      border-left: 3px solid var(--accent-primary);
      cursor: pointer;
    }
    .stack-job-card.status-waiting { border-left-color: #eab308; }
    .stack-job-card.status-completed { border-left-color: #22c55e; }
    .stack-job-card.status-urgent { border-left-color: #ef4444; }

    .stack-job-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .stack-job-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .stack-job-amount { font-size: 13px; font-weight: 700; }
    .stack-job-customer { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .stack-job-vehicle { font-size: 12px; color: var(--text-secondary); }

    /* ===== GRID VIEW ===== */
    .grid-container { padding: 16px; }

    .grid-day-view {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .grid-column {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-default);
      overflow: hidden;
      min-height: 200px;
    }

    .grid-column-header {
      padding: 10px 8px;
      text-align: center;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }

    .grid-column-title { font-size: 12px; font-weight: 700; color: var(--accent-light); }
    .grid-column-time { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
    .grid-column-body { padding: 8px; }

    .grid-job-card {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 6px;
      border-left: 3px solid var(--accent-primary);
      cursor: pointer;
    }
    .grid-job-card.status-waiting { border-left-color: #eab308; }
    .grid-job-card.status-completed { border-left-color: #22c55e; }
    .grid-job-card.status-urgent { border-left-color: #ef4444; }

    .grid-job-time { font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 2px; }
    .grid-job-customer { font-size: 12px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .grid-job-vehicle { font-size: 10px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ===== SALES LIST ===== */
    .sales-list { padding: 16px; }

    .sales-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      border-left: 4px solid #8b5cf6;
      cursor: pointer;
    }
    .sales-time { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .sales-customer { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .sales-info { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); flex-wrap: wrap; }
    .sales-type {
      padding: 2px 6px; border-radius: 4px;
      background: rgba(139,92,246,0.15); color: #a78bfa;
      font-size: 10px; font-weight: 600;
    }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-text { font-size: 16px; }

    /* ===== MOBILE ACTION BUTTONS ===== */
    .mobile-action-buttons {
      position: fixed;
      bottom: 102px;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-default);
      padding: 8px 8px 0 8px;
      z-index: 101;
    }

    .mobile-action-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .mobile-action-btn {
      padding: 10px 8px;
      border-radius: 8px;
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--accent-light);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-appearance: none;
    }
    .mobile-action-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    /* ===== MOBILE BOTTOM NAV ===== */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-default);
      padding: 8px;
      z-index: 100;
    }

    .mobile-nav-top {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .mobile-nav-secondary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .mobile-nav-btn {
      padding: 10px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }

    .mobile-nav-btn.related {
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--text-primary);
    }

    @supports not (background: color-mix(in srgb, red 50%, blue)) {
      .mobile-nav-btn.related, .mobile-action-btn { background: var(--bg-hover); }
      .lanes-filter-btn.active, .filter-btn.active { background: var(--bg-hover); }
    }

    .toast {
      position: fixed;
      bottom: 200px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--accent-primary);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      display: none;
    }
    .toast.show { display: block; animation: toastIn 0.3s ease; }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-top">
    <div class="header-left">
      <button class="menu-btn" onclick="location.href='dashboard-service.html'">‚Üê</button>
      <h1 class="header-title">Scheduler</h1>
    </div>
    <div class="header-actions">
      <div class="view-style-toggle">
        <button class="view-style-btn active" id="styleLanes" onclick="setViewStyle('lanes')">Lanes</button>
        <button class="view-style-btn" id="styleStack" onclick="setViewStyle('stack')">Stack</button>
        <button class="view-style-btn" id="styleGrid" onclick="setViewStyle('grid')">Grid</button>
      </div>
      <button class="icon-btn" onclick="cycleTheme()">üé®</button>
    </div>
  </div>
</header>

<!-- Main Tabs -->
<div class="main-tabs">
  <button class="main-tab active" id="tabService" onclick="switchTab('service')">Service</button>
  <button class="main-tab" id="tabSales" onclick="switchTab('sales')">Sales</button>
  <button class="main-tab" id="tabFleet" onclick="switchTab('fleet')">Fleet</button>
</div>

<!-- LANES Date Nav -->
<div class="date-nav-container active" id="lanesDateNav">
  <div class="lanes-date-nav">
    <div class="lanes-controls-row" id="lanesControlsRow"></div>
    <div class="lanes-date-chips-wrapper">
      <div class="lanes-date-chips" id="lanesDateChips"></div>
    </div>
  </div>
</div>

<!-- STACK Date Nav -->
<div class="date-nav-container" id="stackDateNav">
  <div class="stack-date-nav">
    <div class="stack-date-selector">
      <button class="stack-arrow-btn" onclick="stackNavPrev()">‚Üê</button>
      <div class="stack-date-display">
        <div class="stack-date-label" id="stackDateLabel">Today</div>
        <div class="stack-date-full" id="stackDateFull">January 10, 2026</div>
      </div>
      <button class="stack-arrow-btn" onclick="stackNavNext()">‚Üí</button>
    </div>
    <div class="stack-period-tabs">
      <button class="stack-period-tab active" onclick="setStackPeriod('today')">Today</button>
      <button class="stack-period-tab" onclick="setStackPeriod('7day')">7 Days</button>
      <button class="stack-period-tab" onclick="setStackPeriod('30day')">30 Days</button>
    </div>
    <div class="stack-filters" id="stackFilters"></div>
  </div>
</div>

<!-- GRID Date Nav -->
<div class="date-nav-container" id="gridDateNav">
  <div class="grid-date-nav">
    <div class="grid-period-toggle">
      <button class="grid-period-btn active" onclick="setGridPeriod('today')">Day</button>
      <button class="grid-period-btn" onclick="setGridPeriod('7day')">Week</button>
      <button class="grid-period-btn" onclick="setGridPeriod('30day')">Month</button>
    </div>
    <div class="grid-week-header" id="gridWeekHeader">
      <div class="grid-week-nav">
        <button class="grid-nav-btn" onclick="gridNavPrev()">‚Üê</button>
        <span class="grid-week-label" id="gridWeekLabel">This Week</span>
        <button class="grid-nav-btn" onclick="gridNavNext()">‚Üí</button>
      </div>
    </div>
    <div id="gridCalendarMini"></div>
    <div class="grid-filters" id="gridFilters"></div>
  </div>
</div>

<!-- Content -->
<div class="content-area">
  <div class="tab-content active" id="content-service">
    <div id="serviceViewContainer"></div>
  </div>
  <div class="tab-content" id="content-sales">
    <div class="sales-list" id="salesList"></div>
  </div>
  <div class="tab-content" id="content-fleet">
    <div id="fleetViewContainer"></div>
  </div>
</div>

<!-- Mobile Action Buttons -->
<div class="mobile-action-buttons">
  <div class="mobile-action-grid">
    <button class="mobile-action-btn" onclick="location.href='work-order-new.html'">+ Work Order</button>
    <button class="mobile-action-btn active">Scheduler</button>
    <button class="mobile-action-btn" onclick="location.href='appointment-new.html'">+ Appointment</button>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<nav class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <button class="mobile-nav-btn related" onclick="location.href='dashboard-business.html'">Business</button>
    <button class="mobile-nav-btn" onclick="location.href='dashboard-search.html'">Search</button>
  </div>
  <div class="mobile-nav-secondary">
    <button class="mobile-nav-btn related" onclick="location.href='dashboard-service.html'">Service</button>
    <button class="mobile-nav-btn related" onclick="location.href='dashboard-parts.html'">Parts</button>
    <button class="mobile-nav-btn related" onclick="location.href='dashboard-sales.html'">Sales</button>
  </div>
</nav>

<div class="toast" id="toast"></div>

<script>
// ===== DATA =====
var technicians = [
  { id: 'mike', name: 'Mike Rodriguez', role: 'Master Tech', bay: 'Bay 1', initials: 'MR', color: '' },
  { id: 'tom', name: 'Tom Jackson', role: 'Senior Tech', bay: 'Bay 2', initials: 'TJ', color: 'green' },
  { id: 'alex', name: 'Alex Lee', role: 'Technician', bay: 'Bay 3', initials: 'AL', color: 'orange' },
  { id: 'unassigned', name: 'Unassigned', role: 'Drag to assign', bay: '', initials: '?', color: 'purple' }
];

var serviceJobs = [
  { id: 'WO-2847', customer: 'James Wilson', vehicle: 'Ford F-150', time: '8:00 AM', status: 'in_progress', tech: 'mike', amount: '$485', date: 0, fleet: false },
  { id: 'WO-2851', customer: 'Sarah Chen', vehicle: 'Tesla Model Y', time: '10:30 AM', status: 'waiting', tech: 'mike', amount: '$890', date: 0, fleet: false },
  { id: 'WO-2856', customer: 'Robert Martinez', vehicle: 'Chevy Silverado', time: '1:00 PM', status: 'scheduled', tech: 'mike', amount: '$245', date: 0, fleet: false },
  { id: 'WO-2860', customer: 'Emily Thompson', vehicle: 'Honda CR-V', time: '3:30 PM', status: 'scheduled', tech: 'mike', amount: '$320', date: 0, fleet: false },
  { id: 'WO-2845', customer: 'David Kim', vehicle: 'BMW X5', time: '8:00 AM', status: 'completed', tech: 'tom', amount: '$125', date: 0, fleet: false },
  { id: 'WO-2849', customer: 'Maria Garcia', vehicle: 'Toyota Camry', time: '9:30 AM', status: 'in_progress', tech: 'tom', amount: '$1,250', date: 0, fleet: false },
  { id: 'WO-2862', customer: "Kevin O'Brien", vehicle: 'Jeep Wrangler', time: '2:00 PM', status: 'urgent', tech: 'tom', amount: 'TBD', date: 0, fleet: false },
  { id: 'WO-2844', customer: 'Lisa Brown', vehicle: 'Mazda CX-5', time: '8:30 AM', status: 'completed', tech: 'alex', amount: '$185', date: 0, fleet: false },
  { id: 'WO-2853', customer: 'Chris Taylor', vehicle: 'Audi Q7', time: '11:00 AM', status: 'in_progress', tech: 'alex', amount: '$395', date: 0, fleet: false },
  { id: 'WO-2858', customer: 'Amanda White', vehicle: 'Hyundai Tucson', time: '2:30 PM', status: 'scheduled', tech: 'alex', amount: '$0', date: 0, fleet: false },
  { id: 'WO-2864', customer: 'Michael Chang', vehicle: 'Kia Telluride', time: 'TBD', status: 'scheduled', tech: 'unassigned', amount: '$220', date: 0, fleet: false },
  { id: 'WO-2865', customer: 'Jennifer Lopez', vehicle: 'Lexus RX', time: 'TBD', status: 'waiting', tech: 'unassigned', amount: '$400', date: 0, fleet: false },
  { id: 'WO-2870', customer: 'Tom Hanks', vehicle: 'Mercedes GLE', time: '9:00 AM', status: 'scheduled', tech: 'mike', amount: '$550', date: 1, fleet: false },
  { id: 'WO-2871', customer: 'Jane Doe', vehicle: 'Volvo XC90', time: '10:00 AM', status: 'scheduled', tech: 'tom', amount: '$320', date: 1, fleet: false },
  { id: 'WO-2875', customer: 'Bob Smith', vehicle: 'Porsche Cayenne', time: '8:00 AM', status: 'scheduled', tech: 'alex', amount: '$780', date: 2, fleet: false },
  { id: 'WO-2880', customer: 'Alice Wonder', vehicle: 'Subaru Outback', time: '9:00 AM', status: 'scheduled', tech: 'mike', amount: '$290', date: 3, fleet: false },
  { id: 'WO-2881', customer: 'John Wick', vehicle: 'Ford Mustang', time: '11:00 AM', status: 'scheduled', tech: 'tom', amount: '$650', date: 5, fleet: false },
  { id: 'WO-2885', customer: 'Bruce Banner', vehicle: 'Toyota Tundra', time: '10:00 AM', status: 'scheduled', tech: 'mike', amount: '$420', date: 15, fleet: false },
  { id: 'WO-2890', customer: 'Tony Stark', vehicle: 'Audi R8', time: '2:00 PM', status: 'scheduled', tech: 'tom', amount: '$2,500', date: 30, fleet: false }
];

var fleetJobs = [
  { id: 'FL-1001', customer: 'ABC Trucking', vehicle: 'Freightliner #101', time: '7:00 AM', status: 'in_progress', tech: 'mike', amount: '$1,200', date: 0, fleet: true },
  { id: 'FL-1002', customer: 'ABC Trucking', vehicle: 'Freightliner #102', time: '8:00 AM', status: 'scheduled', tech: 'tom', amount: '$850', date: 0, fleet: true },
  { id: 'FL-1003', customer: 'City Transit', vehicle: 'Bus #45', time: '9:00 AM', status: 'waiting', tech: 'alex', amount: '$2,100', date: 0, fleet: true },
  { id: 'FL-1004', customer: 'ABC Trucking', vehicle: 'Freightliner #103', time: '1:00 PM', status: 'scheduled', tech: 'unassigned', amount: '$950', date: 0, fleet: true },
  { id: 'FL-1010', customer: 'City Transit', vehicle: 'Bus #46', time: '8:00 AM', status: 'scheduled', tech: 'mike', amount: '$1,800', date: 1, fleet: true },
  { id: 'FL-1011', customer: 'XYZ Logistics', vehicle: 'Van #22', time: '10:00 AM', status: 'scheduled', tech: 'tom', amount: '$450', date: 1, fleet: true }
];

var salesAppointments = [
  { id: 'SA-501', customer: 'Mark Johnson', time: '9:00 AM', type: 'Test Drive', vehicle: '2024 Honda Accord', salesperson: 'John Smith', status: 'confirmed', date: 0 },
  { id: 'SA-502', customer: 'Linda Williams', time: '10:30 AM', type: 'New Purchase', vehicle: '2024 Toyota RAV4', salesperson: 'Sarah Davis', status: 'confirmed', date: 0 },
  { id: 'SA-503', customer: 'Steve Rogers', time: '1:00 PM', type: 'Trade-In', vehicle: '2024 Ford Bronco', salesperson: 'John Smith', status: 'scheduled', date: 0 },
  { id: 'SA-504', customer: 'Nancy Drew', time: '3:00 PM', type: 'Financing', vehicle: '2024 Chevy Equinox', salesperson: 'Sarah Davis', status: 'scheduled', date: 0 },
  { id: 'SA-510', customer: 'Peter Parker', time: '11:00 AM', type: 'Test Drive', vehicle: '2024 Tesla Model 3', salesperson: 'John Smith', status: 'confirmed', date: 1 },
  { id: 'SA-511', customer: 'Mary Jane', time: '2:00 PM', type: 'New Purchase', vehicle: '2024 BMW X3', salesperson: 'Sarah Davis', status: 'scheduled', date: 1 }
];

// ===== STATE =====
var currentTab = 'service';
var currentViewStyle = 'lanes';
var selectedDate = 0;
var currentFilter = 'all';
var stackPeriod = 'today';
var gridPeriod = 'today';
var weekOffset = 0;
var lanesScrollOffset = 0; // For infinite scroll

// ===== THEME =====
var themes = ['dark-blue','grey','slate','midnight','navy','graphite','ocean','forest'];
var themeIndex = 0;

function loadTheme() {
  var t = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', t);
  themeIndex = themes.indexOf(t);
  if (themeIndex < 0) themeIndex = 0;
}

function cycleTheme() {
  themeIndex = (themeIndex + 1) % themes.length;
  document.documentElement.setAttribute('data-theme', themes[themeIndex]);
  localStorage.setItem('app-theme', themes[themeIndex]);
  showToast('Theme: ' + themes[themeIndex]);
}

loadTheme();

// ===== VIEW STYLE =====
function setViewStyle(style) {
  currentViewStyle = style;
  
  document.getElementById('styleLanes').classList.remove('active');
  document.getElementById('styleStack').classList.remove('active');
  document.getElementById('styleGrid').classList.remove('active');
  document.getElementById('style' + style.charAt(0).toUpperCase() + style.slice(1)).classList.add('active');
  
  document.getElementById('lanesDateNav').classList.remove('active');
  document.getElementById('stackDateNav').classList.remove('active');
  document.getElementById('gridDateNav').classList.remove('active');
  document.getElementById(style + 'DateNav').classList.add('active');
  
  localStorage.setItem('scheduler-view-style', style);
  
  renderDateNav();
  renderCurrentView();
  showToast(style.charAt(0).toUpperCase() + style.slice(1) + ' view');
}

var savedStyle = localStorage.getItem('scheduler-view-style');
if (savedStyle && ['lanes', 'stack', 'grid'].indexOf(savedStyle) !== -1) {
  currentViewStyle = savedStyle;
}

// ===== TABS =====
function switchTab(tab) {
  currentTab = tab;
  
  document.getElementById('tabService').classList.remove('active');
  document.getElementById('tabSales').classList.remove('active');
  document.getElementById('tabFleet').classList.remove('active');
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  
  document.getElementById('content-service').classList.remove('active');
  document.getElementById('content-sales').classList.remove('active');
  document.getElementById('content-fleet').classList.remove('active');
  document.getElementById('content-' + tab).classList.add('active');
  
  currentFilter = 'all';
  renderDateNav();
  renderCurrentView();
}

// ===== LANES DATE NAV =====
function renderLanesControls() {
  var jobs = getJobsForDateOffset(selectedDate);
  var all = jobs.length;
  var active = jobs.filter(function(j) { return j.status === 'in_progress'; }).length;
  var waiting = jobs.filter(function(j) { return j.status === 'waiting'; }).length;
  var done = jobs.filter(function(j) { return j.status === 'completed'; }).length;
  
  var html = '<button class="lanes-today-btn" onclick="goToToday()">Today</button>';
  html += '<button class="lanes-filter-btn ' + (currentFilter === 'all' ? 'active' : '') + '" onclick="setFilter(\'all\')">All <span class="count">' + all + '</span></button>';
  html += '<button class="lanes-filter-btn ' + (currentFilter === 'in_progress' ? 'active' : '') + '" onclick="setFilter(\'in_progress\')">Active <span class="count">' + active + '</span></button>';
  html += '<button class="lanes-filter-btn ' + (currentFilter === 'waiting' ? 'active' : '') + '" onclick="setFilter(\'waiting\')">Waiting <span class="count">' + waiting + '</span></button>';
  html += '<button class="lanes-filter-btn ' + (currentFilter === 'completed' ? 'active' : '') + '" onclick="setFilter(\'completed\')">Done <span class="count">' + done + '</span></button>';
  
  document.getElementById('lanesControlsRow').innerHTML = html;
}

function goToToday() {
  selectedDate = 0;
  lanesScrollOffset = 0;
  renderLanesDateChips();
  renderLanesControls();
  renderCurrentView();
  
  // Scroll to today
  var container = document.getElementById('lanesDateChips');
  var todayChip = container.querySelector('.lanes-date-chip.today');
  if (todayChip) {
    todayChip.scrollIntoView({ behavior: 'smooth', inline: 'center' });
  }
  showToast('Today');
}

function renderLanesDateChips() {
  var container = document.getElementById('lanesDateChips');
  var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var today = new Date();
  
  // Generate dates from -30 to +90 days (infinite feel)
  var startOffset = -30 + lanesScrollOffset;
  var endOffset = 90 + lanesScrollOffset;
  
  // Group by month
  var monthGroups = {};
  
  for (var i = startOffset; i < endOffset; i++) {
    var d = new Date(today);
    d.setDate(d.getDate() + i);
    var monthKey = d.getFullYear() + '-' + d.getMonth();
    
    if (!monthGroups[monthKey]) {
      monthGroups[monthKey] = {
        month: d.getMonth(),
        year: d.getFullYear(),
        label: months[d.getMonth()],
        days: []
      };
    }
    
    monthGroups[monthKey].days.push({
      offset: i,
      date: d,
      dayName: days[d.getDay()],
      dayNum: d.getDate(),
      isToday: i === 0
    });
  }
  
  var html = '';
  var monthIndex = 0;
  
  for (var key in monthGroups) {
    var group = monthGroups[key];
    var evenOdd = monthIndex % 2 === 0 ? 'even' : 'odd';
    
    html += '<div class="month-section ' + evenOdd + '">';
    html += '<div class="month-label">' + group.label + '</div>';
    html += '<div class="month-days">';
    
    for (var j = 0; j < group.days.length; j++) {
      var day = group.days[j];
      var jobCount = getJobsForDateOffset(day.offset).length;
      var isActive = day.offset === selectedDate;
      var classes = 'lanes-date-chip';
      if (isActive) classes += ' active';
      if (day.isToday) classes += ' today';
      
      html += '<button class="' + classes + '" onclick="selectLanesDate(' + day.offset + ')">';
      html += '<span class="day-name">' + day.dayName + '</span>';
      html += '<span class="day-num">' + day.dayNum + '</span>';
      if (jobCount > 0) html += '<span class="job-count">' + jobCount + '</span>';
      html += '</button>';
    }
    
    html += '</div></div>';
    monthIndex++;
  }
  
  container.innerHTML = html;
  
  // Setup infinite scroll detection
  container.onscroll = function() {
    if (container.scrollLeft < 100) {
      lanesScrollOffset -= 30;
      var scrollPos = container.scrollLeft;
      renderLanesDateChips();
      container.scrollLeft = scrollPos + 500;
    }
    if (container.scrollLeft > container.scrollWidth - container.clientWidth - 100) {
      lanesScrollOffset += 30;
      renderLanesDateChips();
    }
  };
}

function selectLanesDate(offset) {
  selectedDate = offset;
  renderLanesDateChips();
  renderLanesControls();
  renderCurrentView();
  showToast(getDateLabel(offset));
}

// ===== STACK DATE NAV =====
function setStackPeriod(period) {
  stackPeriod = period;
  document.querySelectorAll('.stack-period-tab').forEach(function(b) { b.classList.remove('active'); });
  event.target.classList.add('active');
  updateStackDateDisplay();
  renderCurrentView();
}

function stackNavPrev() {
  selectedDate--;
  updateStackDateDisplay();
  renderStackFilters();
  renderCurrentView();
}

function stackNavNext() {
  selectedDate++;
  updateStackDateDisplay();
  renderStackFilters();
  renderCurrentView();
}

function updateStackDateDisplay() {
  document.getElementById('stackDateLabel').textContent = getDateLabel(selectedDate);
  var today = new Date();
  var d = new Date(today);
  d.setDate(d.getDate() + selectedDate);
  document.getElementById('stackDateFull').textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}

function renderStackFilters() {
  var jobs = getJobsForDateOffset(selectedDate);
  var all = jobs.length;
  var active = jobs.filter(function(j) { return j.status === 'in_progress'; }).length;
  var waiting = jobs.filter(function(j) { return j.status === 'waiting'; }).length;
  var done = jobs.filter(function(j) { return j.status === 'completed'; }).length;
  
  var html = '<button class="filter-btn ' + (currentFilter === 'all' ? 'active' : '') + '" onclick="setFilter(\'all\')">All <span class="count">' + all + '</span></button>';
  html += '<button class="filter-btn ' + (currentFilter === 'in_progress' ? 'active' : '') + '" onclick="setFilter(\'in_progress\')">Active <span class="count">' + active + '</span></button>';
  html += '<button class="filter-btn ' + (currentFilter === 'waiting' ? 'active' : '') + '" onclick="setFilter(\'waiting\')">Waiting <span class="count">' + waiting + '</span></button>';
  html += '<button class="filter-btn ' + (currentFilter === 'completed' ? 'active' : '') + '" onclick="setFilter(\'completed\')">Done <span class="count">' + done + '</span></button>';
  
  document.getElementById('stackFilters').innerHTML = html;
}

// ===== GRID DATE NAV =====
function setGridPeriod(period) {
  gridPeriod = period;
  document.querySelectorAll('.grid-period-btn').forEach(function(b) { b.classList.remove('active'); });
  event.target.classList.add('active');
  renderGridCalendar();
  renderCurrentView();
}

function gridNavPrev() {
  weekOffset--;
  renderGridCalendar();
  renderCurrentView();
}

function gridNavNext() {
  weekOffset++;
  renderGridCalendar();
  renderCurrentView();
}

function renderGridCalendar() {
  var container = document.getElementById('gridCalendarMini');
  var header = document.getElementById('gridWeekHeader');
  var days = ['S','M','T','W','T','F','S'];
  var today = new Date();
  
  if (gridPeriod === 'today') {
    header.style.display = 'none';
    container.innerHTML = '';
    renderGridFilters();
    return;
  }
  
  header.style.display = 'flex';
  
  if (gridPeriod === '7day') {
    var startOfWeek = new Date(today);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + (weekOffset * 7));
    
    var endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(endOfWeek.getDate() + 6);
    
    document.getElementById('gridWeekLabel').textContent = startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    
    var html = '<div class="grid-calendar-mini">';
    for (var i = 0; i < 7; i++) {
      html += '<div class="grid-cal-day-header">' + days[i] + '</div>';
    }
    for (var i = 0; i < 7; i++) {
      var d = new Date(startOfWeek);
      d.setDate(d.getDate() + i);
      var offset = Math.round((d - today) / (1000 * 60 * 60 * 24));
      var jobCount = getJobsForDateOffset(offset).length;
      html += '<button class="grid-cal-day ' + (offset === selectedDate ? 'active' : '') + (jobCount > 0 ? ' has-jobs' : '') + '" onclick="selectGridDate(' + offset + ')">' + d.getDate() + '</button>';
    }
    html += '</div>';
    container.innerHTML = html;
  } else {
    document.getElementById('gridWeekLabel').textContent = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    var firstDay = new Date(today.getFullYear(), today.getMonth() + weekOffset, 1);
    var lastDay = new Date(today.getFullYear(), today.getMonth() + weekOffset + 1, 0);
    var startPad = firstDay.getDay();
    
    var html = '<div class="grid-calendar-mini">';
    for (var i = 0; i < 7; i++) {
      html += '<div class="grid-cal-day-header">' + days[i] + '</div>';
    }
    for (var i = 0; i < startPad; i++) {
      html += '<div class="grid-cal-day" style="opacity:0.3"></div>';
    }
    for (var i = 1; i <= lastDay.getDate(); i++) {
      var d = new Date(firstDay);
      d.setDate(i);
      var offset = Math.round((d - today) / (1000 * 60 * 60 * 24));
      var jobCount = getJobsForDateOffset(offset).length;
      html += '<button class="grid-cal-day ' + (offset === selectedDate ? 'active' : '') + (jobCount > 0 ? ' has-jobs' : '') + '" onclick="selectGridDate(' + offset + ')">' + i + '</button>';
    }
    html += '</div>';
    container.innerHTML = html;
  }
  
  renderGridFilters();
}

function selectGridDate(offset) {
  selectedDate = offset;
  renderGridCalendar();
  renderCurrentView();
  showToast(getDateLabel(offset));
}

function renderGridFilters() {
  var jobs = getJobsForDateOffset(selectedDate);
  var all = jobs.length;
  var active = jobs.filter(function(j) { return j.status === 'in_progress'; }).length;
  var waiting = jobs.filter(function(j) { return j.status === 'waiting'; }).length;
  var done = jobs.filter(function(j) { return j.status === 'completed'; }).length;
  
  var html = '<button class="filter-btn ' + (currentFilter === 'all' ? 'active' : '') + '" onclick="setFilter(\'all\')">All <span class="count">' + all + '</span></button>';
  html += '<button class="filter-btn ' + (currentFilter === 'in_progress' ? 'active' : '') + '" onclick="setFilter(\'in_progress\')">Active <span class="count">' + active + '</span></button>';
  html += '<button class="filter-btn ' + (currentFilter === 'waiting' ? 'active' : '') + '" onclick="setFilter(\'waiting\')">Waiting <span class="count">' + waiting + '</span></button>';
  html += '<button class="filter-btn ' + (currentFilter === 'completed' ? 'active' : '') + '" onclick="setFilter(\'completed\')">Done <span class="count">' + done + '</span></button>';
  
  document.getElementById('gridFilters').innerHTML = html;
}

// ===== DATE NAV RENDER =====
function renderDateNav() {
  if (currentViewStyle === 'lanes') {
    renderLanesControls();
    renderLanesDateChips();
  } else if (currentViewStyle === 'stack') {
    updateStackDateDisplay();
    renderStackFilters();
  } else {
    renderGridCalendar();
  }
}

// ===== FILTER =====
function setFilter(f) {
  currentFilter = f;
  renderDateNav();
  renderCurrentView();
}

// ===== HELPERS =====
function getDateLabel(offset) {
  if (offset === 0) return 'Today';
  if (offset === 1) return 'Tomorrow';
  if (offset === -1) return 'Yesterday';
  var today = new Date();
  var d = new Date(today);
  d.setDate(d.getDate() + offset);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function getJobsForDateOffset(offset) {
  var jobs = [];
  if (currentTab === 'service') {
    jobs = serviceJobs.filter(function(j) { return j.date === offset; });
  } else if (currentTab === 'fleet') {
    jobs = fleetJobs.filter(function(j) { return j.date === offset; });
  } else {
    jobs = salesAppointments.filter(function(a) { return a.date === offset; });
  }
  return jobs;
}

function getTechById(id) {
  for (var i = 0; i < technicians.length; i++) {
    if (technicians[i].id === id) return technicians[i];
  }
  return { id: id, name: id, initials: '?', color: 'purple' };
}

function getTimeSlot(timeStr) {
  if (!timeStr || timeStr === 'TBD') return 'morning';
  var hour = parseInt(timeStr.split(':')[0]);
  if (timeStr.indexOf('PM') !== -1 && hour !== 12) hour += 12;
  if (hour < 12) return 'morning';
  if (hour < 15) return 'midday';
  return 'afternoon';
}

var statusLabels = { 'in_progress': 'Active', 'waiting': 'Parts', 'completed': 'Done', 'urgent': 'Urgent', 'scheduled': 'Scheduled', 'confirmed': 'Confirmed' };

// ===== RENDER =====
function renderCurrentView() {
  if (currentTab === 'sales') {
    renderSalesList();
    return;
  }
  
  var container = currentTab === 'service' ? document.getElementById('serviceViewContainer') : document.getElementById('fleetViewContainer');
  var jobs = getJobsForDateOffset(selectedDate);
  if (currentFilter !== 'all') {
    jobs = jobs.filter(function(j) { return j.status === currentFilter; });
  }
  
  if (currentViewStyle === 'lanes') {
    container.innerHTML = renderLanesView(jobs);
  } else if (currentViewStyle === 'stack') {
    container.innerHTML = renderStackView(jobs);
  } else {
    container.innerHTML = renderGridView(jobs);
  }
}

function renderLanesView(jobs) {
  if (jobs.length === 0) return '<div class="empty-state"><div class="empty-state-icon">üîß</div><div class="empty-state-text">No jobs for this date</div></div>';
  
  var html = '<div class="lanes-container">';
  technicians.forEach(function(tech) {
    var techJobs = jobs.filter(function(j) { return j.tech === tech.id; });
    var hours = (techJobs.length * 1.5).toFixed(1);
    
    html += '<div class="tech-lane"><div class="lane-header"><div class="lane-info">';
    html += '<div class="tech-avatar ' + tech.color + '">' + tech.initials + '</div>';
    html += '<div class="tech-details"><h3>' + tech.name + '</h3><span>' + tech.role + (tech.bay ? ' ‚Ä¢ ' + tech.bay : '') + '</span></div></div>';
    html += '<div class="lane-stats"><div class="stat-item"><div class="stat-value">' + techJobs.length + '</div><div class="stat-label">Jobs</div></div>';
    html += '<div class="stat-item"><div class="stat-value">' + hours + 'h</div><div class="stat-label">Booked</div></div></div></div>';
    html += '<div class="lane-cards">';
    techJobs.forEach(function(j) {
      html += '<div class="wo-card status-' + j.status + (j.fleet ? ' fleet' : '') + '" onclick="location.href=\'work-order-edit.html?id=' + j.id + '\'">';
      html += '<div class="card-time">' + j.time + '</div><div class="card-customer">' + j.customer + '</div>';
      html += '<div class="card-info-row"><span class="card-vehicle">' + j.vehicle + '</span><span class="card-dot"></span>';
      html += '<span class="card-status ' + j.status + '">' + (statusLabels[j.status] || j.status) + '</span>';
      html += '<span class="card-amount">' + j.amount + '</span></div></div>';
    });
    html += '<div class="add-card" onclick="location.href=\'work-order-new.html\'"><div class="add-card-icon">+</div><span>Add</span></div></div></div>';
  });
  html += '</div>';
  return html;
}

function renderStackView(jobs) {
  if (jobs.length === 0) return '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No jobs for this date</div></div>';
  
  var timeBlocks = [
    { id: 'morning', label: 'Morning', range: '8am - 12pm' },
    { id: 'midday', label: 'Midday', range: '12pm - 3pm' },
    { id: 'afternoon', label: 'Afternoon', range: '3pm - 6pm' }
  ];
  
  var html = '<div class="stack-container">';
  timeBlocks.forEach(function(block) {
    var blockJobs = jobs.filter(function(j) { return getTimeSlot(j.time) === block.id; });
    
    html += '<div class="stack-time-block"><div class="stack-time-header">';
    html += '<span class="stack-time-label">' + block.label + '</span>';
    html += '<span class="stack-time-range">' + block.range + '</span>';
    html += '<span class="stack-time-count">' + blockJobs.length + ' jobs</span></div>';
    
    var techGroups = {};
    blockJobs.forEach(function(j) {
      if (!techGroups[j.tech]) techGroups[j.tech] = [];
      techGroups[j.tech].push(j);
    });
    
    for (var techId in techGroups) {
      var tech = getTechById(techId);
      var techJobs = techGroups[techId];
      
      html += '<div class="stack-tech-section" id="stack-' + block.id + '-' + techId + '">';
      html += '<div class="stack-tech-header" onclick="toggleStackSection(\'' + block.id + '-' + techId + '\')">';
      html += '<div class="stack-tech-avatar ' + tech.color + '">' + tech.initials + '</div>';
      html += '<span class="stack-tech-name">' + tech.name + '</span>';
      html += '<span class="stack-tech-summary">' + techJobs.length + ' job' + (techJobs.length !== 1 ? 's' : '') + '</span>';
      html += '<span class="stack-expand-icon">‚ñº</span></div><div class="stack-jobs">';
      
      techJobs.forEach(function(j) {
        html += '<div class="stack-job-card status-' + j.status + '" onclick="location.href=\'work-order-edit.html?id=' + j.id + '\'">';
        html += '<div class="stack-job-top"><span class="stack-job-time">' + j.time + '</span><span class="stack-job-amount">' + j.amount + '</span></div>';
        html += '<div class="stack-job-customer">' + j.customer + '</div><div class="stack-job-vehicle">' + j.vehicle + '</div></div>';
      });
      
      html += '</div></div>';
    }
    html += '</div>';
  });
  html += '</div>';
  return html;
}

function toggleStackSection(id) {
  var section = document.getElementById('stack-' + id);
  if (section) section.classList.toggle('expanded');
}

function renderGridView(jobs) {
  if (jobs.length === 0) return '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><div class="empty-state-text">No jobs for this date</div></div>';
  
  var columns = [
    { id: 'morning', title: 'Morning', time: '8am - 12pm' },
    { id: 'midday', title: 'Midday', time: '12pm - 3pm' },
    { id: 'afternoon', title: 'Afternoon', time: '3pm - 6pm' }
  ];
  
  var html = '<div class="grid-container"><div class="grid-day-view">';
  columns.forEach(function(col) {
    var colJobs = jobs.filter(function(j) { return getTimeSlot(j.time) === col.id; });
    
    html += '<div class="grid-column"><div class="grid-column-header">';
    html += '<div class="grid-column-title">' + col.title + '</div>';
    html += '<div class="grid-column-time">' + col.time + '</div></div><div class="grid-column-body">';
    
    colJobs.forEach(function(j) {
      html += '<div class="grid-job-card status-' + j.status + '" onclick="location.href=\'work-order-edit.html?id=' + j.id + '\'">';
      html += '<div class="grid-job-time">' + j.time + '</div>';
      html += '<div class="grid-job-customer">' + j.customer + '</div>';
      html += '<div class="grid-job-vehicle">' + j.vehicle + '</div></div>';
    });
    
    if (colJobs.length === 0) html += '<div style="text-align:center;padding:20px;color:var(--text-secondary);font-size:11px;">No jobs</div>';
    html += '</div></div>';
  });
  html += '</div></div>';
  return html;
}

function renderSalesList() {
  var container = document.getElementById('salesList');
  var appts = salesAppointments.filter(function(a) { return a.date === selectedDate; });
  if (currentFilter !== 'all') appts = appts.filter(function(a) { return a.status === currentFilter; });
  
  if (appts.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><div class="empty-state-text">No appointments</div></div>';
    return;
  }
  
  var html = '';
  appts.forEach(function(a) {
    html += '<div class="sales-card" onclick="location.href=\'appointment-edit.html?id=' + a.id + '\'">';
    html += '<div class="sales-time">' + a.time + '</div><div class="sales-customer">' + a.customer + '</div>';
    html += '<div class="sales-info"><span class="sales-type">' + a.type + '</span><span>' + a.vehicle + '</span><span>‚Ä¢</span><span>' + a.salesperson + '</span></div></div>';
  });
  container.innerHTML = html;
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

// ===== INIT =====
function init() {
  document.getElementById('styleLanes').classList.remove('active');
  document.getElementById('styleStack').classList.remove('active');
  document.getElementById('styleGrid').classList.remove('active');
  document.getElementById('style' + currentViewStyle.charAt(0).toUpperCase() + currentViewStyle.slice(1)).classList.add('active');
  
  document.getElementById('lanesDateNav').classList.remove('active');
  document.getElementById('stackDateNav').classList.remove('active');
  document.getElementById('gridDateNav').classList.remove('active');
  document.getElementById(currentViewStyle + 'DateNav').classList.add('active');
  
  renderDateNav();
  renderCurrentView();
  
  // Scroll to today on load for lanes
  setTimeout(function() {
    if (currentViewStyle === 'lanes') {
      var container = document.getElementById('lanesDateChips');
      var todayChip = container.querySelector('.lanes-date-chip.today');
      if (todayChip) {
        todayChip.scrollIntoView({ behavior: 'auto', inline: 'center' });
      }
    }
  }, 100);
}

init();
</script>
</body>
</html>
