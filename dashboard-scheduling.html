<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scheduling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
    
    /* pin app name top-right */
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; display:flex; align-items:center; gap:10px; }

    /* Updated sub-nav under title */
    .sub-nav {
      display:flex;
      gap:16px;
      margin: 8px 0 0;
      padding-bottom:10px;
      border-bottom:1px solid #1f2937;
      flex-wrap:wrap;
    }
    .sub-nav-link {
      font-size:14px;
      color:#9ca3af;
      text-decoration:none;
      padding:4px 2px;
      position:relative;
    }
    .sub-nav-link:hover { color:#e5e7eb; }
    .sub-nav-link.active { color:#38bdf8; font-weight:500; }
    .sub-nav-link.active::after {
      content:"";
      position:absolute;
      left:0;
      bottom:-11px;
      width:100%;
      height:2px;
      background:#38bdf8;
      border-radius:2px;
    }

    /* Button group for Settings and Logout */
    .header-buttons {
      display:flex;
      gap:8px;
      align-items:center;
    }

    button {
      padding:8px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:#243648; }

    .controls {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      gap:12px;
      flex-wrap:wrap;
    }

    .view-toggle {
      display:flex;
      gap:8px;
    }

    .pill {
      padding:6px 12px;
      border-radius:10px;
      border:1px solid #223044;
      background:#0f1621;
      color:#e8eef6;
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .pill.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

    .calendar {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:14px;
      padding:16px;
      margin-bottom:16px;
    }

    .calendar-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .calendar-title {
      font-size:18px;
      font-weight:600;
    }

    .calendar-nav {
      display:flex;
      gap:8px;
    }

    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:8px;
    }

    .day-header {
      text-align:center;
      font-size:12px;
      color:#9fb0c3;
      padding:8px;
      font-weight:600;
    }

    .day-cell {
      background:#0b0f14;
      border:1px solid #223044;
      border-radius:8px;
      padding:8px;
      min-height:80px;
      cursor:pointer;
      position:relative;
    }

    .day-cell:hover {
      border-color:#38bdf8;
    }

    .day-cell.other-month {
      opacity:0.4;
    }

    .day-cell.today {
      border-color:#3b82f6;
      box-shadow:0 0 0 1px rgba(59,130,246,.35) inset;
    }

    .day-number {
      font-size:14px;
      font-weight:600;
      margin-bottom:4px;
    }

    .day-events {
      font-size:11px;
      color:#9fb0c3;
    }

    .event-dot {
      width:6px;
      height:6px;
      border-radius:50%;
      display:inline-block;
      margin-right:4px;
    }

    .event-dot.scheduled { background:#60a5fa; }
    .event-dot.waiting { background:#f59e0b; }
    .event-dot.complications { background:#ef4444; }

    .schedule-list {
      display:grid;
      gap:12px;
    }

    .card {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:14px;
      padding:14px 16px;
      cursor:pointer;
    }
    .card:hover { border-color:#38bdf8; }

    .muted { font-size:12px; color:#9fb0c3; margin-top:4px; }
    .error { color:#ffb3b3; white-space:pre-wrap; }

    /* Mobile responsive */
    @media (max-width: 640px) {
      header { padding-bottom: 8px; }
      h1 { font-size: 32px; }
      .header-buttons { width: 100%; justify-content: flex-end; }
      .day-cell { min-height:60px; padding:4px; }
      .day-number { font-size:12px; }
    }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <div>
      <h1 id="tenantTitle">Scheduling</h1>

      <div class="sub-nav">
        <a href="dashboard-business.html" class="sub-nav-link">Dashboard</a>
        <a href="dashboard-customer-search.html" class="sub-nav-link">Customers</a>
        <a href="dashboard-vehicle-search.html" class="sub-nav-link">Vehicles</a>
        <a href="dashboard-scheduling.html" class="sub-nav-link active">Scheduling</a>
      </div>
    </div>

    <div class="header-buttons">
      <button onclick="goToSettings()">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="controls">
    <div class="view-toggle">
      <div class="pill active" id="btnCalendar" onclick="setView('calendar')">Calendar</div>
      <div class="pill" id="btnList" onclick="setView('list')">List</div>
    </div>
    <button onclick="createWorkOrder()">+ New Work Order</button>
  </div>

  <!-- Calendar View -->
  <div id="calendarView" class="calendar">
    <div class="calendar-header">
      <div class="calendar-title" id="calendarTitle">December 2024</div>
      <div class="calendar-nav">
        <button onclick="previousMonth()">←</button>
        <button onclick="today()">Today</button>
        <button onclick="nextMonth()">→</button>
      </div>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- Days of week headers -->
      <div class="day-header">Sun</div>
      <div class="day-header">Mon</div>
      <div class="day-header">Tue</div>
      <div class="day-header">Wed</div>
      <div class="day-header">Thu</div>
      <div class="day-header">Fri</div>
      <div class="day-header">Sat</div>
      <!-- Calendar days will be inserted here -->
    </div>
  </div>

  <!-- List View -->
  <div id="listView" class="schedule-list" style="display:none;">
    <!-- Work orders will be listed here -->
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let currentDate = new Date();
let workOrders = [];
let employees = [];
let currentView = 'calendar';

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function goToSettings(){
  location.href = "dashboard-settings.html";
}

function createWorkOrder(){
  location.href = "work-order-new.html";
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;

  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
  });
  return r.ok ? token : null;
}

async function fetchJson(url, token){
  const r = await fetch(url, {
    headers:{ Authorization:`Bearer ${token}`, apikey:ANON_KEY }
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function setView(view){
  currentView = view;
  
  document.getElementById('btnCalendar').classList.toggle('active', view === 'calendar');
  document.getElementById('btnList').classList.toggle('active', view === 'list');
  
  document.getElementById('calendarView').style.display = view === 'calendar' ? 'block' : 'none';
  document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
  
  if(view === 'list'){
    renderList();
  }
}

function previousMonth(){
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
}

function nextMonth(){
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
}

function today(){
  currentDate = new Date();
  renderCalendar();
}

function getWorkOrdersForDate(date){
  const dateStr = date.toISOString().split('T')[0];
  return workOrders.filter(wo => {
    if(!wo.scheduled_start) return false;
    const woDate = new Date(wo.scheduled_start).toISOString().split('T')[0];
    return woDate === dateStr;
  });
}

function renderCalendar(){
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // Update title
  const monthNames = ['January','February','March','April','May','June',
    'July','August','September','October','November','December'];
  document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();
  
  const grid = document.getElementById('calendarGrid');
  
  // Clear existing day cells (keep headers)
  while(grid.children.length > 7){
    grid.removeChild(grid.lastChild);
  }
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // Add previous month's trailing days
  const prevMonthDays = new Date(year, month, 0).getDate();
  for(let i = startingDayOfWeek - 1; i >= 0; i--){
    const day = prevMonthDays - i;
    const date = new Date(year, month - 1, day);
    const cell = createDayCell(day, date, true);
    grid.appendChild(cell);
  }
  
  // Add current month days
  for(let day = 1; day <= daysInMonth; day++){
    const date = new Date(year, month, day);
    const dateStr = date.toISOString().split('T')[0];
    const isToday = dateStr === todayStr;
    const cell = createDayCell(day, date, false, isToday);
    grid.appendChild(cell);
  }
  
  // Add next month's leading days
  const totalCells = grid.children.length - 7; // subtract headers
  const remainingCells = 42 - totalCells; // 6 weeks * 7 days
  for(let day = 1; day <= remainingCells; day++){
    const date = new Date(year, month + 1, day);
    const cell = createDayCell(day, date, true);
    grid.appendChild(cell);
  }
}

function createDayCell(day, date, otherMonth = false, isToday = false){
  const cell = document.createElement('div');
  cell.className = 'day-cell';
  if(otherMonth) cell.classList.add('other-month');
  if(isToday) cell.classList.add('today');
  
  const dayNum = document.createElement('div');
  dayNum.className = 'day-number';
  dayNum.textContent = day;
  cell.appendChild(dayNum);
  
  // Get work orders for this date
  const orders = getWorkOrdersForDate(date);
  if(orders.length > 0){
    const events = document.createElement('div');
    events.className = 'day-events';
    
    const scheduled = orders.filter(wo => ['scheduled','in_progress','repairing'].includes(wo.status)).length;
    const waiting = orders.filter(wo => ['awaiting_parts','parts_on_order'].includes(wo.status)).length;
    const complications = orders.filter(wo => ['diagnosis_required','customer_approval'].includes(wo.status)).length;
    
    if(scheduled > 0){
      events.innerHTML += `<span class="event-dot scheduled"></span>${scheduled} `;
    }
    if(waiting > 0){
      events.innerHTML += `<span class="event-dot waiting"></span>${waiting} `;
    }
    if(complications > 0){
      events.innerHTML += `<span class="event-dot complications"></span>${complications} `;
    }
    
    cell.appendChild(events);
  }
  
  cell.onclick = () => showDayDetails(date);
  
  return cell;
}

function showDayDetails(date){
  const dateStr = date.toLocaleDateString();
  const orders = getWorkOrdersForDate(date);
  
  if(orders.length === 0){
    alert(`No work orders scheduled for ${dateStr}`);
    return;
  }
  
  // For now just alert, could open a modal
  const details = orders.map(wo => 
    `${wo.customer_name || 'Unknown'} - ${wo.summary || 'No description'} (${wo.status})`
  ).join('\n');
  
  alert(`Work Orders for ${dateStr}:\n\n${details}`);
}

function renderList(){
  const list = document.getElementById('listView');
  
  // Sort work orders by date
  const sorted = [...workOrders].sort((a,b) => {
    const dateA = a.scheduled_start ? new Date(a.scheduled_start) : new Date(0);
    const dateB = b.scheduled_start ? new Date(b.scheduled_start) : new Date(0);
    return dateA - dateB;
  });
  
  if(sorted.length === 0){
    list.innerHTML = '<div class="muted">No scheduled work orders.</div>';
    return;
  }
  
  list.innerHTML = sorted.map(wo => {
    const date = wo.scheduled_start ? new Date(wo.scheduled_start).toLocaleDateString() : 'No date';
    const time = wo.scheduled_start ? new Date(wo.scheduled_start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
    
    return `
      <div class="card">
        <strong>${wo.customer_name || 'Unknown Customer'}</strong>
        <div class="muted">${wo.summary || 'No description'}</div>
        <div class="muted">${date} ${time}</div>
        <div class="muted">Status: ${wo.status}</div>
      </div>
    `;
  }).join('');
}

async function load(){
  const token = await validateAuth();
  if(!token) return location.replace("login.html");
  
  try {
    // Load work orders
    workOrders = await fetchJson(`${FUNCTIONS_BASE}/work_orders`, token);
    
    // Load employees
    employees = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);
    
    // Set tenant title if available
    if(workOrders.length > 0 && workOrders[0].tenant_name){
      document.getElementById('tenantTitle').textContent = workOrders[0].tenant_name;
      document.title = workOrders[0].tenant_name + ' - Scheduling';
    }
    
    renderCalendar();
    
  } catch(err){
    console.error('Load error:', err);
    alert('Error loading scheduling data: ' + err.message);
  }
}

load();
</script>
</body>
</html>
