<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scheduling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1megyoB4I_LprziRaybKsGHhrX4" />

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: system-ui;
      background: #0b0f14;
      color: #e8eef6;
    }
    
    button {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #223044;
      background: #0f1621;
      color: #e8eef6;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    button:hover {
      background: #1a2535;
      border-color: #2f4461;
    }
    
    button.primary {
      background: #3b82f6;
      border-color: #3b82f6;
      color: #fff;
    }
    
    button.primary:hover {
      background: #2563eb;
      border-color: #2563eb;
    }
    
    /* Desktop styles remain unchanged */
    .main-content {
      padding: 24px;
      max-width: 1800px;
      width: 100%;
      margin: 0 auto;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .view-tabs {
      display: flex;
      gap: 8px;
      background: #0f1621;
      padding: 4px;
      border-radius: 10px;
      border: 1px solid #223044;
    }
    
    .view-tab {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      color: #9fb0c3;
      transition: all 0.2s;
      user-select: none;
    }
    
    .view-tab:hover {
      color: #e8eef6;
      background: rgba(59,130,246,0.1);
    }
    
    .view-tab.active {
      background: #3b82f6;
      color: #fff;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .calendar-title {
      font-size: 18px;
      font-weight: 600;
      min-width: 200px;
      text-align: center;
    }
    
    .calendar-container {
      background: #0f1621;
      border: 1px solid #223044;
      border-radius: 14px;
      padding: 20px;
    }
    
    /* Desktop views - keeping minimal styles */
    .today-grid, .week-grid, .month-grid {
      display: grid;
      gap: 1px;
      background: #223044;
      border: 1px solid #223044;
      border-radius: 8px;
    }
    
    /* Work Order Strip - Desktop */
    .wo-strip {
      background: #1a2535;
      border: 1px solid #3b82f6;
      border-left: 3px solid #3b82f6;
      border-radius: 6px;
      padding: 8px 10px;
      cursor: move;
      font-size: 12px;
      transition: all 0.2s;
      user-select: none;
      position: relative;
    }
    
    .wo-strip.scheduled { border-left-color: #3b82f6; border-color: #3b82f6; }
    .wo-strip.in_progress { border-left-color: #3b82f6; border-color: #3b82f6; }
    .wo-strip.awaiting_parts { border-left-color: #f59e0b; border-color: #f59e0b; }
    .wo-strip.ready_for_pickup { border-left-color: #10b981; border-color: #10b981; }
    .wo-strip.completed { border-left-color: #3b82f6; border-color: #3b82f6; }
    .wo-strip.past-due { border-left-color: #ef4444; border-color: #ef4444; }
    
    .wo-customer {
      font-weight: 600;
      color: #e8eef6;
      margin-bottom: 3px;
      font-size: 13px;
    }
    
    .wo-vehicle {
      color: #9fb0c3;
      font-size: 11px;
      margin-bottom: 3px;
    }
    
    .wo-status-display {
      color: #60a5fa;
      font-size: 10px;
      font-weight: 600;
      margin-top: 3px;
      text-transform: uppercase;
    }
    
    .wo-tech {
      color: #9fb0c3;
      font-size: 10px;
      margin-top: 3px;
    }
    
    /* Hide mobile view on desktop */
    .mobile-app-container {
      display: none;
    }
    
    /* ============================================
       MOBILE APP LAYOUT
       ============================================ */
    @media (max-width: 768px) {
      /* Hide desktop */
      .desktop-header,
      .main-content,
      .controls {
        display: none !important;
      }
      
      /* Show mobile app */
      .mobile-app-container {
        display: flex !important;
        flex-direction: column;
        height: 100vh;
        height: 100dvh; /* Dynamic viewport height for mobile browsers */
      }
      
      /* FIXED HEADER */
      .mobile-header {
        flex-shrink: 0;
        background: #0f1621;
        border-bottom: 1px solid #223044;
      }
      
      .mobile-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        min-height: 48px;
      }
      
      .mobile-header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .mobile-menu-toggle {
        background: transparent;
        border: none;
        color: #e8eef6;
        font-size: 22px;
        padding: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      
      .mobile-header-title {
        font-size: 16px;
        font-weight: 600;
      }
      
      .mobile-header-date {
        font-size: 14px;
        color: #9fb0c3;
        font-weight: 500;
      }
      
      .mobile-header-new {
        background: #3b82f6;
        border: none;
        color: #fff;
        font-size: 20px;
        padding: 4px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        cursor: pointer;
      }
      
      .mobile-header-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      
      .mobile-header-content.expanded {
        max-height: 300px;
      }
      
      .mobile-header-nav {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        overflow-x: auto;
        background: #0b0f14;
        border-top: 1px solid #223044;
      }
      
      .mobile-header-nav a {
        padding: 6px 10px;
        color: #9fb0c3;
        text-decoration: none;
        font-size: 12px;
        white-space: nowrap;
        border-radius: 4px;
        background: transparent;
      }
      
      .mobile-header-nav a.active {
        background: #3b82f6;
        color: #fff;
      }
      
      .mobile-header-actions {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        background: #0b0f14;
        border-top: 1px solid #223044;
      }
      
      .mobile-header-actions button {
        flex: 1;
        padding: 6px;
        font-size: 11px;
      }
      
      /* SCROLLABLE CONTENT AREA */
      .mobile-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        background: #0b0f14;
      }
      
      .mobile-day-view {
        min-height: 100%;
        padding: 8px;
      }
      
      /* WORK ORDER CARDS */
      .mobile-wo-card {
        background: #1a2535;
        border: 1px solid #3b82f6;
        border-left: 3px solid #3b82f6;
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 8px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        touch-action: pan-y;
        position: relative;
      }
      
      .mobile-wo-card.scheduled { border-left-color: #3b82f6; border-color: #3b82f6; }
      .mobile-wo-card.in_progress { border-left-color: #3b82f6; border-color: #3b82f6; }
      .mobile-wo-card.awaiting_parts { border-left-color: #f59e0b; border-color: #f59e0b; }
      .mobile-wo-card.ready_for_pickup { border-left-color: #10b981; border-color: #10b981; }
      .mobile-wo-card.completed { border-left-color: #3b82f6; border-color: #3b82f6; }
      .mobile-wo-card.past-due { border-left-color: #ef4444; border-color: #ef4444; }
      
      .mobile-wo-card.dragging {
        opacity: 0.95;
        box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        z-index: 1000;
        position: fixed;
        left: 8px;
        right: 8px;
        width: calc(100% - 16px);
      }
      
      .mobile-wo-drag-handle {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9fb0c3;
        font-size: 16px;
        cursor: grab;
      }
      
      .mobile-wo-content {
        flex: 1;
        min-width: 0;
      }
      
      .mobile-wo-customer {
        font-weight: 600;
        color: #e8eef6;
        font-size: 14px;
        margin-bottom: 2px;
      }
      
      .mobile-wo-vehicle {
        color: #9fb0c3;
        font-size: 12px;
        margin-bottom: 2px;
      }
      
      .mobile-wo-status {
        color: #60a5fa;
        font-size: 10px;
        font-weight: 600;
        margin-top: 3px;
        text-transform: uppercase;
      }
      
      .mobile-wo-tech {
        color: #9fb0c3;
        font-size: 10px;
        margin-top: 2px;
      }
      
      .mobile-wo-actions {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      
      .mobile-wo-action-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(59,130,246,0.1);
        border: 1px solid #3b82f6;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .mobile-wo-action-btn:active {
        background: rgba(59,130,246,0.2);
        transform: scale(0.95);
      }
      
      .mobile-wo-action-btn.date svg {
        width: 14px;
        height: 14px;
        color: #3b82f6;
      }
      
      .mobile-wo-action-btn.pickup {
        background: rgba(16,185,129,0.1);
        border-color: #10b981;
        font-size: 18px;
        font-weight: bold;
        color: #10b981;
      }
      
      .mobile-wo-action-btn.pickup:active {
        background: rgba(16,185,129,0.2);
      }
      
      /* Empty state */
      .mobile-empty {
        text-align: center;
        padding: 60px 20px;
        color: #9fb0c3;
        font-size: 13px;
      }
      
      /* FIXED BOTTOM NAVIGATION */
      .mobile-bottom-nav {
        flex-shrink: 0;
        background: #0f1621;
        border-top: 1px solid #223044;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      
      .mobile-nav-btn {
        flex: 0 0 auto;
        width: 48px;
        height: 48px;
        background: #1a2535;
        border: 1px solid #223044;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #e8eef6;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
      }
      
      .mobile-nav-btn:active {
        background: #243648;
        transform: scale(0.95);
      }
      
      .mobile-pickup-btn {
        flex: 1;
        height: 48px;
        background: #10b981;
        border: 1px solid #10b981;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .mobile-pickup-btn:active {
        background: #059669;
        transform: scale(0.98);
      }
      
      .mobile-pickup-btn .count {
        background: rgba(255,255,255,0.2);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 700;
      }
      
      /* Date Picker Modal */
      .date-picker-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.85);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      
      .date-picker-content {
        background: #1a2535;
        border: 1px solid #223044;
        border-radius: 12px;
        padding: 20px;
        max-width: 400px;
        width: 100%;
      }
      
      .date-picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      
      .date-picker-title {
        font-size: 16px;
        font-weight: 600;
        color: #e8eef6;
      }
      
      .date-picker-close {
        background: transparent;
        border: none;
        color: #9fb0c3;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .date-picker-input {
        width: 100%;
        padding: 12px;
        background: #0f1621;
        border: 1px solid #223044;
        border-radius: 8px;
        color: #e8eef6;
        font-size: 14px;
        margin-bottom: 16px;
      }
      
      .date-picker-actions {
        display: flex;
        gap: 12px;
      }
      
      .date-picker-actions button {
        flex: 1;
      }
      
      /* Pickup view */
      .mobile-pickup-view {
        display: none;
        flex-direction: column;
        height: 100%;
      }
      
      .mobile-pickup-view.active {
        display: flex;
      }
      
      .mobile-pickup-header {
        flex-shrink: 0;
        padding: 16px 12px;
        background: #1a3528;
        border-bottom: 1px solid #10b981;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .mobile-pickup-title {
        font-size: 16px;
        font-weight: 600;
        color: #4ade80;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .mobile-pickup-close {
        background: transparent;
        border: none;
        color: #4ade80;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <!-- DESKTOP HEADER -->
  <div class="desktop-header" style="position:sticky; top:0; z-index:100; background:#0b0f14; border-bottom:1px solid #223044;">
    <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
      <h1 style="margin:0; font-size:32px; font-weight:600;" id="tenantTitle">Scheduling</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div style="padding:0 24px 12px;">
      <nav style="display:flex; gap:24px; overflow-x:auto;">
        <a href="dashboard-business.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Dashboard</a>
        <a href="dashboard-customer-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
        <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
        <a href="dashboard-scheduling.html" style="padding:12px 0; color:#3b82f6; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid #3b82f6;">Scheduling</a>
      </nav>
    </div>
    
    <div style="padding:0 24px 12px; border-top:1px solid #223044; padding-top:12px;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- DESKTOP CONTENT -->
  <div class="main-content">
    <div class="controls">
      <div class="view-tabs">
        <div class="view-tab active" id="tabToday" onclick="setView('today')">Today</div>
        <div class="view-tab" id="tabWeek" onclick="setView('week')">Week</div>
        <div class="view-tab" id="tabMonth" onclick="setView('month')">30 Days</div>
      </div>
      
      <div class="calendar-nav">
        <button onclick="previousPeriod()">←</button>
        <div class="calendar-title" id="calendarTitle">Today</div>
        <button onclick="todayView()">Today</button>
        <button onclick="nextPeriod()">→</button>
      </div>
      
      <button class="primary" onclick="createWorkOrder()">+ New Work Order</button>
    </div>

    <div class="calendar-container">
      <div id="todayView" class="today-grid"></div>
      <div id="weekView" class="week-grid" style="display:none;"></div>
      <div id="monthView" class="month-grid" style="display:none;"></div>
    </div>
  </div>

  <!-- MOBILE APP CONTAINER -->
  <div class="mobile-app-container">
    <!-- Fixed Header -->
    <div class="mobile-header">
      <div class="mobile-header-bar">
        <div class="mobile-header-left">
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
          <div>
            <div class="mobile-header-title" id="mobileTenantTitle">Scheduling</div>
            <div class="mobile-header-date" id="mobileHeaderDate">Today</div>
          </div>
        </div>
        <button class="mobile-header-new" onclick="createWorkOrder()">+</button>
      </div>
      
      <div class="mobile-header-content" id="mobileHeaderContent">
        <div class="mobile-header-nav">
          <a href="dashboard-business.html">Dashboard</a>
          <a href="dashboard-customer-search.html">Customers</a>
          <a href="dashboard-vehicle-search.html">Vehicles</a>
          <a href="dashboard-scheduling.html" class="active">Scheduling</a>
        </div>
        <div class="mobile-header-actions">
          <button onclick="goToSettings()">Settings</button>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
    </div>

    <!-- Scrollable Content -->
    <div class="mobile-content" id="mobileContent">
      <div class="mobile-day-view" id="mobileDayView"></div>
    </div>
    
    <!-- Pickup View (Hidden by default) -->
    <div class="mobile-pickup-view" id="mobilePickupView">
      <div class="mobile-pickup-header">
        <div class="mobile-pickup-title">Ready for Pickup</div>
        <button class="mobile-pickup-close" onclick="closePickupView()">×</button>
      </div>
      <div class="mobile-content">
        <div class="mobile-day-view" id="mobilePickupList"></div>
      </div>
    </div>

    <!-- Fixed Bottom Nav -->
    <div class="mobile-bottom-nav">
      <div class="mobile-nav-btn" onclick="previousDay()">←</div>
      <div class="mobile-pickup-btn" onclick="showPickupView()">
        <span>Pickup</span>
        <span class="count" id="pickupCount">0</span>
      </div>
      <div class="mobile-nav-btn" onclick="nextDay()">→</div>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let currentDate = new Date();
let workOrders = [];
let customers = [];
let vehicles = [];
let employees = [];
let currentView = 'today';
let isMobile = window.innerWidth <= 768;

// Mobile drag state
let draggedElement = null;
let draggedWO = null;
let dragStartY = 0;
let dragOffsetY = 0;
let scrollInterval = null;

window.addEventListener('resize', () => {
  const wasMobile = isMobile;
  isMobile = window.innerWidth <= 768;
  if(wasMobile !== isMobile) {
    renderView();
  }
});

function toggleMobileMenu() {
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
}

function logout(){
  // Clear all possible token locations
  localStorage.removeItem("sb_access_token");
  localStorage.removeItem("sb-access-token");
  sessionStorage.removeItem("sb_access_token");
  sessionStorage.removeItem("sb-access-token");
  console.log('Logged out, redirecting to login');
  location.replace("login.html");
}

function goToSettings(){
  location.href = "dashboard-settings.html";
}

function createWorkOrder(){
  location.href = "work-order-new.html";
}

// Mobile day navigation
function previousDay() {
  currentDate.setDate(currentDate.getDate() - 1);
  renderMobileDay();
}

function nextDay() {
  currentDate.setDate(currentDate.getDate() + 1);
  renderMobileDay();
}

function showPickupView() {
  document.getElementById('mobilePickupView').classList.add('active');
  renderPickupList();
}

function closePickupView() {
  document.getElementById('mobilePickupView').classList.remove('active');
}

async function validateAuth(){
  // Try both common token storage keys
  let token = localStorage.getItem("sb_access_token") || localStorage.getItem("sb-access-token");
  
  if(!token) {
    console.log('No token found in localStorage');
    // Check if there's a token in sessionStorage as fallback
    token = sessionStorage.getItem("sb_access_token") || sessionStorage.getItem("sb-access-token");
  }
  
  if(!token) {
    console.log('No authentication token found');
    return null;
  }
  
  try {
    const r = await fetch(`${API_BASE}/auth/v1/user`, {
      headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
    });
    
    if(r.ok) {
      console.log('Auth valid');
      return token;
    } else {
      console.log('Auth failed:', r.status);
      return null;
    }
  } catch(err) {
    console.error('Auth error:', err);
    // Don't fail on network errors, allow offline work
    return token;
  }
}

async function fetchTable(table, token){
  try {
    const r = await fetch(`${REST_BASE}/${table}?select=*`, {
      headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
    });
    if(!r.ok) {
      console.error(`Failed to fetch ${table}:`, r.status);
      throw new Error(`Failed to fetch ${table}: ${r.status}`);
    }
    return r.json();
  } catch(err) {
    console.error(`Error fetching ${table}:`, err);
    throw err;
  }
}

function setView(view){
  currentView = view;
  document.getElementById('tabToday').classList.toggle('active', view === 'today');
  document.getElementById('tabWeek').classList.toggle('active', view === 'week');
  document.getElementById('tabMonth').classList.toggle('active', view === 'month');
  renderView();
}

function previousPeriod(){
  if(currentView === 'today'){
    currentDate.setDate(currentDate.getDate() - 1);
  } else if(currentView === 'week'){
    currentDate.setDate(currentDate.getDate() - 7);
  } else {
    currentDate.setMonth(currentDate.getMonth() - 1);
  }
  renderView();
}

function nextPeriod(){
  if(currentView === 'today'){
    currentDate.setDate(currentDate.getDate() + 1);
  } else if(currentView === 'week'){
    currentDate.setDate(currentDate.getDate() + 7);
  } else {
    currentDate.setMonth(currentDate.getMonth() + 1);
  }
  renderView();
}

function todayView(){
  currentDate = new Date();
  renderView();
}

function getWorkOrdersForDate(date){
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const dateStr = `${year}-${month}-${day}`;
  
  return workOrders.filter(wo => {
    if(wo.status === 'ready_for_pickup' || wo.status === 'completed' || wo.status === 'closed') {
      return false;
    }
    
    if(wo.scheduled_start) {
      const woDate = new Date(wo.scheduled_start);
      const woYear = woDate.getFullYear();
      const woMonth = String(woDate.getMonth() + 1).padStart(2, '0');
      const woDay = String(woDate.getDate()).padStart(2, '0');
      const woDateStr = `${woYear}-${woMonth}-${woDay}`;
      return woDateStr === dateStr;
    }
    return false;
  });
}

function renderView(){
  if(isMobile) {
    renderMobileDay();
  } else {
    // Desktop rendering (simplified)
    document.getElementById('todayView').innerHTML = '<div style="padding:40px;text-align:center;color:#9fb0c3;">Desktop view</div>';
  }
}

// MOBILE DAY VIEW
function renderMobileDay() {
  const view = document.getElementById('mobileDayView');
  view.innerHTML = '';
  
  // Update header date
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const currentDay = new Date(currentDate);
  currentDay.setHours(0, 0, 0, 0);
  const isToday = currentDay.getTime() === today.getTime();
  
  const dateText = isToday ? 'Today' : currentDate.toLocaleDateString('en-US', { 
    weekday: 'long', 
    month: 'short', 
    day: 'numeric' 
  });
  document.getElementById('mobileHeaderDate').textContent = dateText;
  
  // Get work orders for this day
  const orders = getWorkOrdersForDate(currentDate);
  
  if(orders.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'mobile-empty';
    empty.textContent = 'No work orders scheduled';
    view.appendChild(empty);
  } else {
    orders.forEach(wo => {
      view.appendChild(createMobileCard(wo));
    });
  }
  
  // Update pickup count
  const pickupOrders = workOrders.filter(wo => wo.status === 'ready_for_pickup');
  document.getElementById('pickupCount').textContent = pickupOrders.length;
  
  // Hide pickup button if no orders
  const pickupBtn = document.querySelector('.mobile-pickup-btn');
  if(pickupOrders.length === 0) {
    pickupBtn.style.display = 'none';
  } else {
    pickupBtn.style.display = 'flex';
  }
}

function renderPickupList() {
  const view = document.getElementById('mobilePickupList');
  view.innerHTML = '';
  
  const pickupOrders = workOrders.filter(wo => wo.status === 'ready_for_pickup');
  
  if(pickupOrders.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'mobile-empty';
    empty.textContent = 'No orders ready for pickup';
    view.appendChild(empty);
  } else {
    pickupOrders.forEach(wo => {
      const card = createMobileCard(wo, true);
      view.appendChild(card);
    });
  }
}

function createMobileCard(wo, isPickupView = false) {
  const customer = customers.find(c => c.customer_id === wo.customer_id);
  const vehicle = vehicles.find(v => v.vehicle_id === wo.vehicle_id);
  const employee = employees.find(e => e.employee_id === wo.assigned_employee_id);
  
  const customerName = customer ? `${customer.first_name} ${customer.last_name}` : 'Unknown';
  const vehicleInfo = vehicle ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : '';
  const techName = employee ? `${employee.first_name} ${employee.last_name}` : 'Unassigned';
  const statusDisplay = wo.status ? wo.status.replace(/_/g, ' ').toUpperCase() : 'DRAFT';
  
  const now = new Date();
  const isPastDue = wo.scheduled_end && new Date(wo.scheduled_end) < now && 
                    wo.status !== 'completed' && wo.status !== 'closed';
  
  const isCompleted = wo.status === 'completed' || wo.status === 'closed';
  const isPickup = wo.status === 'ready_for_pickup';
  
  const card = document.createElement('div');
  card.className = `mobile-wo-card ${isPastDue ? 'past-due' : (wo.status || 'scheduled')}`;
  card.dataset.woId = wo.work_order_id;
  
  card.innerHTML = `
    <div class="mobile-wo-drag-handle">⠿</div>
    <div class="mobile-wo-content">
      <div class="mobile-wo-customer">${customerName}</div>
      ${vehicleInfo ? `<div class="mobile-wo-vehicle">${vehicleInfo}</div>` : ''}
      <div class="mobile-wo-status">${isPastDue ? 'PAST DUE' : statusDisplay}</div>
      <div class="mobile-wo-tech">Tech: ${techName}</div>
    </div>
    <div class="mobile-wo-actions">
      <div class="mobile-wo-action-btn date" data-action="date" data-wo-id="${wo.work_order_id}">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </div>
      ${!isPickup && !isCompleted && !isPickupView ? `
        <div class="mobile-wo-action-btn pickup" data-action="pickup" data-wo-id="${wo.work_order_id}">↓</div>
      ` : ''}
    </div>
  `;
  
  // Touch drag events
  const handle = card.querySelector('.mobile-wo-drag-handle');
  handle.addEventListener('touchstart', handleTouchStart, { passive: false });
  handle.addEventListener('touchmove', handleTouchMove, { passive: false });
  handle.addEventListener('touchend', handleTouchEnd, { passive: false });
  
  // Action buttons
  const dateBtn = card.querySelector('[data-action="date"]');
  dateBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    showDatePicker(wo.work_order_id);
  });
  
  const pickupBtn = card.querySelector('[data-action="pickup"]');
  if(pickupBtn) {
    pickupBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      markAsReadyForPickup(wo.work_order_id);
    });
  }
  
  // Click to open
  card.addEventListener('click', () => openWorkOrder(wo.work_order_id));
  
  return card;
}

// TOUCH DRAG & DROP
function handleTouchStart(e) {
  e.preventDefault();
  e.stopPropagation();
  
  const card = e.target.closest('.mobile-wo-card');
  draggedElement = card;
  draggedWO = card.dataset.woId;
  
  const rect = card.getBoundingClientRect();
  dragStartY = e.touches[0].clientY;
  dragOffsetY = dragStartY - rect.top;
  
  // Make card fixed position
  card.style.position = 'fixed';
  card.style.left = '8px';
  card.style.right = '8px';
  card.style.width = 'calc(100% - 16px)';
  card.style.top = (dragStartY - dragOffsetY) + 'px';
  card.style.zIndex = '1000';
  card.classList.add('dragging');
}

function handleTouchMove(e) {
  if(!draggedElement) return;
  e.preventDefault();
  e.stopPropagation();
  
  const touchY = e.touches[0].clientY;
  
  // Move card
  draggedElement.style.top = (touchY - dragOffsetY) + 'px';
  
  // Auto-scroll
  const scrollThreshold = 100;
  const scrollSpeed = 5;
  const viewportHeight = window.innerHeight;
  const contentArea = document.getElementById('mobileContent');
  
  if(scrollInterval) {
    clearInterval(scrollInterval);
    scrollInterval = null;
  }
  
  if(touchY < scrollThreshold) {
    scrollInterval = setInterval(() => {
      contentArea.scrollTop -= scrollSpeed;
      if(draggedElement) {
        const currentTop = parseFloat(draggedElement.style.top);
        draggedElement.style.top = (currentTop - scrollSpeed) + 'px';
      }
    }, 30);
  } else if(touchY > viewportHeight - scrollThreshold - 80) { // 80px for bottom nav
    scrollInterval = setInterval(() => {
      contentArea.scrollTop += scrollSpeed;
      if(draggedElement) {
        const currentTop = parseFloat(draggedElement.style.top);
        draggedElement.style.top = (currentTop + scrollSpeed) + 'px';
      }
    }, 30);
  }
}

function handleTouchEnd(e) {
  if(!draggedElement) return;
  
  e.preventDefault();
  e.stopPropagation();
  
  if(scrollInterval) {
    clearInterval(scrollInterval);
    scrollInterval = null;
  }
  
  // Reset styling
  draggedElement.style.position = '';
  draggedElement.style.left = '';
  draggedElement.style.right = '';
  draggedElement.style.width = '';
  draggedElement.style.top = '';
  draggedElement.style.zIndex = '';
  draggedElement.classList.remove('dragging');
  
  // Since we're in single-day view, dragging doesn't move between dates
  // Just provide visual feedback that drag ended
  
  draggedElement = null;
  draggedWO = null;
}

// DATE PICKER
function showDatePicker(woId) {
  const wo = workOrders.find(w => w.work_order_id === woId);
  if(!wo) return;
  
  const modal = document.createElement('div');
  modal.className = 'date-picker-modal';
  
  const currentDate = wo.scheduled_start ? new Date(wo.scheduled_start).toISOString().split('T')[0] : '';
  
  modal.innerHTML = `
    <div class="date-picker-content">
      <div class="date-picker-header">
        <div class="date-picker-title">Change Date</div>
        <button class="date-picker-close" onclick="this.closest('.date-picker-modal').remove()">×</button>
      </div>
      <input type="date" class="date-picker-input" value="${currentDate}" />
      <div class="date-picker-actions">
        <button onclick="this.closest('.date-picker-modal').remove()">Cancel</button>
        <button class="primary" onclick="saveDatePicker('${woId}', this.closest('.date-picker-modal'))">Save</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  setTimeout(() => {
    modal.querySelector('.date-picker-input').focus();
  }, 100);
}

async function saveDatePicker(woId, modal) {
  const input = modal.querySelector('.date-picker-input');
  const dateStr = input.value;
  
  if(!dateStr) {
    alert('Please select a date');
    return;
  }
  
  await moveWorkOrderToDate(woId, dateStr);
  modal.remove();
}

async function moveWorkOrderToDate(woId, dateStr) {
  const token = localStorage.getItem("sb_access_token");
  if(!token) return;
  
  try {
    const wo = workOrders.find(w => w.work_order_id === woId);
    if(!wo) return;
    
    const [year, month, day] = dateStr.split('-').map(Number);
    
    let hour = 9, minute = 0;
    if(wo.scheduled_start) {
      const currentTime = new Date(wo.scheduled_start);
      hour = currentTime.getHours();
      minute = currentTime.getMinutes();
    }
    
    const newDateTime = new Date(year, month - 1, day, hour, minute, 0, 0);
    const durationHours = 2.0;
    const newEndTime = new Date(newDateTime);
    newEndTime.setHours(newEndTime.getHours() + durationHours);
    
    await fetch(`${REST_BASE}/work_orders?work_order_id=eq.${woId}`, {
      method: 'PATCH',
      headers: {
        'apikey': ANON_KEY,
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        scheduled_start: newDateTime.toISOString(),
        scheduled_end: newEndTime.toISOString()
      })
    });
    
    await loadWorkOrders(token);
    renderView();
    
  } catch(err) {
    console.error('Move error:', err);
    alert('Error moving work order');
  }
}

async function markAsReadyForPickup(woId) {
  const token = localStorage.getItem("sb_access_token");
  if(!token) return;
  
  try {
    await fetch(`${REST_BASE}/work_orders?work_order_id=eq.${woId}`, {
      method: 'PATCH',
      headers: {
        'apikey': ANON_KEY,
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: 'ready_for_pickup' })
    });
    
    await loadWorkOrders(token);
    renderView();
  } catch(err) {
    console.error('Pickup error:', err);
    alert('Error marking as ready for pickup');
  }
}

function openWorkOrder(woId){
  location.href = `work-order-edit.html?id=${woId}`;
}

async function loadWorkOrders(token){
  workOrders = await fetchTable("work_orders", token);
}

async function load(){
  console.log('Starting load...');
  
  const token = await validateAuth();
  if(!token) {
    console.log('No valid token, redirecting to login');
    alert('Session expired. Please log in again.');
    return location.replace("login.html");
  }
  
  try {
    console.log('Loading data...');
    await loadWorkOrders(token);
    customers = await fetchTable("customers", token);
    vehicles = await fetchTable("vehicles", token);
    employees = await fetchTable("employees", token);
    
    console.log(`Loaded ${workOrders.length} work orders, ${customers.length} customers`);
    
    if(workOrders.length > 0 && workOrders[0].tenant_name){
      document.getElementById('tenantTitle').textContent = workOrders[0].tenant_name;
      document.getElementById('mobileTenantTitle').textContent = workOrders[0].tenant_name;
      document.title = workOrders[0].tenant_name + ' - Scheduling';
    }
    
    renderView();
    console.log('Load complete');
    
  } catch(err){
    console.error('Load error:', err);
    alert('Error loading scheduling data: ' + err.message);
    // Don't redirect to login on data load errors
  }
}

load();
</script>
</body>
</html>
