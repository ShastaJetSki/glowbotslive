<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scheduling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { 
      font-family:system-ui,-apple-system,sans-serif;
      background:#0b0f14;
      color:#e8eef6;
      min-height:100vh;
    }

    /* Scrollbar styles */
    * {
      scrollbar-width: thin;
      scrollbar-color: #223044 #0f1621;
    }

    *::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    *::-webkit-scrollbar-track {
      background: #0f1621;
    }

    *::-webkit-scrollbar-thumb {
      background: #223044;
      border-radius: 5px;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: #2d3f56;
    }

    /* Mobile Header */
    .mobile-header {
      display:none;
      background:#0f1621;
      border-bottom:1px solid #223044;
      position:sticky;
      top:0;
      z-index:100;
    }

    .mobile-header-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
    }

    .mobile-menu-toggle {
      background:transparent;
      border:1px solid transparent;
      border-radius:6px;
      color:#6b7280;
      font-size:20px;
      padding:0;
      width:36px;
      height:36px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }

    .mobile-menu-toggle:hover {
      background:rgba(59,130,246,0.1);
      border-color:#3b82f6;
      color:#3b82f6;
    }

    .mobile-header-center {
      flex:1;
      margin-left:12px;
    }

    .mobile-header-title {
      font-size:18px;
      font-weight:600;
    }

    .mobile-header-subtitle {
      font-size:12px;
      color:#9fb0c3;
      margin-top:2px;
    }

    .mobile-header-pickup {
      background:rgba(52, 211, 153, 0.15);
      border:1px solid rgba(52, 211, 153, 0.3);
      color:#34d399;
      font-size:13px;
      padding:8px 12px;
      height:36px;
      border-radius:6px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:all 0.2s;
      font-weight:600;
    }

    .mobile-header-pickup:active {
      transform:scale(0.95);
      background:rgba(52, 211, 153, 0.25);
    }

    .mobile-pickup-badge {
      background:rgba(52, 211, 153, 0.3);
      padding:2px 8px;
      border-radius:12px;
      font-size:11px;
      color:#34d399;
      font-weight:700;
    }

    .mobile-header-content {
      max-height:0;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }

    .mobile-header-content.expanded {
      max-height:400px;
    }

    .mobile-header-nav {
      display:flex;
      gap:8px;
      padding:8px 12px;
      overflow-x:auto;
      background:#0b0f14;
      border-top:1px solid #223044;
    }

    .mobile-header-nav a {
      padding:8px 12px;
      color:#9fb0c3;
      text-decoration:none;
      font-size:13px;
      white-space:nowrap;
      border-radius:6px;
    }

    .mobile-header-nav a.active {
      background:#3b82f6;
      color:#fff;
    }

    .mobile-header-actions {
      display:flex;
      gap:8px;
      padding:8px 12px;
      background:#0b0f14;
      border-top:1px solid #223044;
    }

    .mobile-header-actions button {
      flex:1;
      padding:10px;
      font-size:13px;
      background:#1a2535;
      border:1px solid #3b82f6;
      border-left:3px solid #3b82f6;
      transition:all 0.2s;
    }

    /* Mobile Action Buttons (NEW - Row above bottom nav) */
    .mobile-action-buttons {
      display:none;
      position:fixed;
      bottom:110px;
      left:0;
      right:0;
      background:#0f1621;
      border-top:1px solid #223044;
      padding:8px 8px 0 8px;
      padding-bottom:calc(0px + env(safe-area-inset-bottom));
      z-index:101;
    }

    .mobile-action-grid {
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:6px;
    }

    .mobile-action-btn {
      padding:10px 8px;
      border-radius:8px;
      border:1px solid rgba(96, 165, 250, 0.3);
      background:rgba(96, 165, 250, 0.1);
      color:#60a5fa;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:44px;
    }

    .mobile-action-btn.active {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }

    .mobile-action-btn:active {
      transform:scale(0.95);
    }

    /* Mobile Bottom Nav (UPDATED - 2 rows) */
    .mobile-bottom-nav {
      display:none;
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#0f1621;
      border-top:1px solid #223044;
      padding:8px;
      padding-bottom:calc(8px + env(safe-area-inset-bottom));
      z-index:100;
      flex-direction:column;
      gap:6px;
    }

    .mobile-nav-grid {
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:6px;
      margin-bottom:6px;
    }

    .mobile-nav-secondary {
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:6px;
    }

    .mobile-nav-btn {
      padding:10px 8px;
      border-radius:8px;
      border:1px solid #223044;
      background:#1a2535;
      color:#9fb0c3;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      min-height:44px;
    }

    .mobile-nav-btn.active, 
    .mobile-nav-btn:hover {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }

    .mobile-nav-btn:active {
      transform:scale(0.95);
    }

    /* Date Picker Modal */
    .date-picker-modal {
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.7);
      z-index:2000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .date-picker-modal.active {
      display:flex;
    }

    .date-picker-content {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:12px;
      padding:24px;
      max-width:320px;
      width:100%;
    }

    .date-picker-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .date-picker-title {
      font-size:16px;
      font-weight:600;
      color:#e8eef6;
    }

    .date-picker-close {
      background:transparent;
      border:none;
      color:#9fb0c3;
      font-size:24px;
      cursor:pointer;
      padding:0;
      width:32px;
      height:32px;
    }

    .date-picker-content input[type="date"] {
      width:100%;
      padding:12px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      color:#e8eef6;
      font-size:16px;
      margin-bottom:16px;
      color-scheme: dark;
    }

    .date-picker-content input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    .date-picker-actions {
      display:flex;
      gap:12px;
    }

    .date-picker-actions button {
      flex:1;
      padding:12px;
      font-size:14px;
    }

    /* Pickup Overlay Modal */
    .pickup-overlay {
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.8);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .pickup-overlay.active {
      display:flex;
    }

    .pickup-overlay-content {
      background:#0f1621;
      border:1px solid #3b82f6;
      border-left:3px solid #3b82f6;
      border-radius:12px;
      padding:24px;
      max-width:900px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
      position:relative;
    }

    .pickup-overlay-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:1px solid #223044;
    }

    .pickup-overlay-title {
      font-size:20px;
      font-weight:700;
      color:#e8eef6;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .pickup-overlay-count {
      background:rgba(52,211,153,0.2);
      padding:4px 12px;
      border-radius:12px;
      font-size:14px;
      color:#34d399;
      font-weight:700;
      margin-left:12px;
    }

    .pickup-overlay-close {
      background:transparent;
      border:1px solid #223044;
      color:#9fb0c3;
      font-size:28px;
      cursor:pointer;
      padding:0;
      width:40px;
      height:40px;
      border-radius:8px;
      transition:all 0.2s;
    }

    .pickup-overlay-close:hover {
      background:#1a2535;
      border-color:#3b82f6;
      color:#3b82f6;
    }

    .pickup-overlay-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:12px;
    }

    /* Desktop Header */
    .desktop-header {
      position:sticky;
      top:0;
      z-index:100;
      background:#0b0f14;
      border-bottom:1px solid #223044;
    }

    .header-top {
      padding:16px 24px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    h1 { font-size:32px; font-weight:600; }

    .header-nav {
      padding:0 24px 12px;
      display:flex;
      gap:24px;
      overflow-x:auto;
    }

    .header-nav a {
      padding:12px 0;
      color:#9fb0c3;
      text-decoration:none;
      font-size:14px;
      white-space:nowrap;
      border-bottom:2px solid transparent;
      transition:all 0.2s;
    }

    .header-nav a.active {
      color:#3b82f6;
      border-bottom-color:#3b82f6;
    }

    .header-actions {
      padding:0 24px 12px;
      border-top:1px solid #223044;
      padding-top:12px;
      display:flex;
      gap:16px;
      justify-content:space-between;
      align-items:center;
    }
    
    .view-tabs-header {
      display:flex;
      gap:4px;
      background:#0f1621;
      border-radius:8px;
      padding:4px;
    }
    
    .view-tabs-header .view-tab {
      padding:6px 16px;
      background:transparent;
      border:1px solid transparent;
      border-radius:6px;
      color:#9fb0c3;
      cursor:pointer;
      font-size:13px;
      transition:all 0.2s;
      white-space:nowrap;
    }
    
    .view-tabs-header .view-tab:hover {
      background:#1a2535;
      color:#e8eef6;
    }
    
    .view-tabs-header .view-tab.active {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }
    
    .calendar-nav-header {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
    }
    
    .calendar-nav-header .nav-arrow {
      padding:6px 12px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#e8eef6;
      font-size:16px;
      cursor:pointer;
      transition:all 0.2s;
      min-width:40px;
    }
    
    .calendar-nav-header .nav-arrow:hover {
      background:#243648;
      border-color:#3b82f6;
    }
    
    .calendar-title-header {
      padding:6px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#e8eef6;
      font-size:13px;
      font-weight:600;
      min-width:150px;
      text-align:center;
      cursor:pointer;
    }
    
    .calendar-title-header:hover {
      background:#243648;
      border-color:#3b82f6;
    }

    button {
      padding:8px 16px;
      border-radius:8px;
      border:1px solid #223044;
      background:#1a2535;
      color:#e8eef6;
      cursor:pointer;
      font-size:13px;
      transition:all 0.2s;
      white-space:nowrap;
    }

    button:hover {
      background:#243648;
      border-color:#2f4461;
    }

    button.primary {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }

    button.primary:hover {
      background:#2563eb;
    }

    /* Main Container */
    .main-container {
      display:flex;
      max-width:1800px;
      margin:0 auto;
      gap:16px;
      padding:24px;
      height:calc(100vh - 200px);
    }

    .schedule-panel {
      flex:1;
      overflow-y:auto;
      background:#0f1621;
      border:1px solid #223044;
      border-radius:12px;
      padding:20px;
    }

    .side-panel {
      width:300px;
      flex-shrink:0;
      display:flex;
      flex-direction:column;
    }

    .side-panel.hidden {
      display:none;
    }

    .side-column {
      background:#0f1621;
      border:1px solid #3b82f6;
      border-left:3px solid #3b82f6;
      border-radius:12px;
      padding:16px;
      overflow-y:auto;
      flex:1;
    }

    .side-column-header {
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#e8eef6;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .pickup-stats {
      display:flex;
      align-items:center;
      gap:16px;
    }

    .pickup-count {
      font-size:14px;
      font-weight:700;
      color:#e8eef6;
    }

    .pickup-total {
      font-size:14px;
      font-weight:600;
      color:#34d399;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .desktop-header { display:none !important; }
      .mobile-header { display:block !important; }
      .mobile-action-buttons { display:block !important; }
      .mobile-bottom-nav { display:flex !important; }
      .side-panel { display:none !important; }
      
      .main-container {
        flex-direction:column;
        padding:12px;
        padding-bottom:185px;
        height:auto;
      }
      
      .schedule-panel {
        order:1;
        width:100%;
        min-height:calc(100vh - 300px);
      }
    }
  </style>
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Scheduling</div>
        <div class="mobile-header-subtitle" id="mobileSubtitle"></div>
      </div>
      <button class="mobile-header-pickup" onclick="scrollToPickup()">
        <span>Pickup</span>
        <span class="mobile-pickup-badge" id="mobilePickupCount">0</span>
      </button>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html" class="active">Scheduling</a>
      </div>
      <div class="mobile-header-actions">
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Mobile Action Buttons (NEW - Row 1) -->
  <div class="mobile-action-buttons">
    <div class="mobile-action-grid">
      <button class="mobile-action-btn active" id="mobileTodayBtn" onclick="goToToday()">Today</button>
      <button class="mobile-action-btn" id="mobileListBtn" onclick="setView('list')">List</button>
      <button class="mobile-action-btn" id="mobile30DayBtn" onclick="setView('30day')">30 Day</button>
      <button class="mobile-action-btn" onclick="createWorkOrder()">+ New</button>
    </div>
  </div>

  <!-- Mobile Bottom Nav (UPDATED - 2 rows) -->
  <div class="mobile-bottom-nav">
    <!-- Row 1: Main Navigation -->
    <div class="mobile-nav-grid">
      <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
      <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
      <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
      <button class="mobile-nav-btn" onclick="goToSettings()">Settings</button>
    </div>
    
    <!-- Row 2: Dashboard Navigation -->
    <div class="mobile-nav-secondary">
      <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
      <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
      <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
    </div>
  </div>

  <!-- Date Picker Modal -->
  <div class="date-picker-modal" id="datePickerModal">
    <div class="date-picker-content">
      <div class="date-picker-header">
        <div class="date-picker-title">Reschedule Work Order</div>
        <button class="date-picker-close" onclick="closeDatePicker()">×</button>
      </div>
      <input type="date" id="newDateInput">
      <div class="date-picker-actions">
        <button onclick="closeDatePicker()">Cancel</button>
        <button class="primary" onclick="saveReschedule()">Save</button>
      </div>
    </div>
  </div>

  <!-- Pickup Overlay Modal -->
  <div class="pickup-overlay" id="pickupOverlay">
    <div class="pickup-overlay-content">
      <div class="pickup-overlay-header">
        <div>
          <span class="pickup-overlay-title">Ready for Pickup</span>
          <span class="pickup-overlay-count" id="pickupOverlayCount">0</span>
        </div>
        <button class="pickup-overlay-close" onclick="closePickupOverlay()">×</button>
      </div>
      <div class="pickup-overlay-grid" id="pickupOverlayGrid"></div>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="desktop-header">
    <div class="header-top">
      <h1 id="pageTitle">Scheduling</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div class="header-nav">
      <a href="dashboard-business.html">Dashboard</a>
      <a href="dashboard-customer-search.html">Customers</a>
      <a href="dashboard-vehicle-search.html">Vehicles</a>
      <a href="dashboard-scheduling.html" class="active">Scheduling</a>
    </div>
    
    <div class="header-actions">
      <div class="view-tabs-header">
        <div class="view-tab active" id="tabToday" onclick="goToToday()">Today</div>
        <div class="view-tab" id="tab7Day" onclick="setView('list')">List</div>
        <div class="view-tab" id="tab30Day" onclick="setView('30day')">30 Days</div>
      </div>
      
      <div class="calendar-nav-header">
        <button class="nav-arrow" onclick="previousPeriod()">←</button>
        <div class="calendar-title-header" id="calendarTitleHeader" onclick="goToToday()"></div>
        <button class="nav-arrow" onclick="nextPeriod()">→</button>
      </div>
      
      <button onclick="goToSettings()">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <div class="schedule-panel">
      <div id="scheduleView">
        <p style="text-align:center; padding:40px; color:#9fb0c3;">Loading scheduling data...</p>
      </div>
    </div>

    <div class="side-panel">
      <div class="side-column">
        <div class="side-column-header">
          <span>Ready for Pickup</span>
          <div class="pickup-stats">
            <span class="pickup-count" id="pickupCount">0</span>
            <span class="pickup-total" id="pickupTotal">$0.00</span>
          </div>
        </div>
        <div id="pickupColumn"></div>
      </div>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let currentDate = new Date();
currentDate.setHours(0, 0, 0, 0);
let workOrders = [];
let customers = [];
let vehicles = [];
let employees = [];
let currentView = 'today';
let isMobile = window.innerWidth <= 768;

window.addEventListener('resize', () => {
  isMobile = window.innerWidth <= 768;
});

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function goToSettings(){
  location.href = "dashboard-settings.html";
}

function createWorkOrder(){
  location.href = "work-order-new.html";
}

function toggleMobileMenu(){
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;
  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
  });
  return r.ok ? token : null;
}

async function fetchTable(table, token){
  const r = await fetch(`${REST_BASE}/${table}?select=*`, {
    headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function setView(view){
  currentView = view;
  
  // Desktop tabs
  document.getElementById('tabToday').classList.toggle('active', view === 'today');
  document.getElementById('tab7Day').classList.toggle('active', view === 'list');
  document.getElementById('tab30Day').classList.toggle('active', view === '30day');
  
  // Mobile action buttons
  const mobileTodayBtn = document.getElementById('mobileTodayBtn');
  const mobileListBtn = document.getElementById('mobileListBtn');
  const mobile30DayBtn = document.getElementById('mobile30DayBtn');
  
  if(mobileTodayBtn) mobileTodayBtn.classList.toggle('active', view === 'today');
  if(mobileListBtn) mobileListBtn.classList.toggle('active', view === 'list');
  if(mobile30DayBtn) mobile30DayBtn.classList.toggle('active', view === '30day');
  
  updateTitle();
  renderSchedule();
}

function updateTitle(){
  const titleHeader = document.getElementById('calendarTitleHeader');
  const mobileSubtitle = document.getElementById('mobileSubtitle');
  
  let titleText = '';
  
  if(currentView === 'today'){
    const today = new Date();
    const current = new Date(currentDate);
    current.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);
    
    if(current.getTime() === today.getTime()) {
      titleText = 'Today';
    } else {
      titleText = currentDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric' 
      });
    }
  } else if(currentView === 'list'){
    titleText = 'Scheduled Work Orders';
  } else {
    titleText = currentDate.toLocaleDateString('en-US', { 
      month: 'long', 
      year: 'numeric' 
    });
  }
  
  if (titleHeader) titleHeader.textContent = titleText;
  if (mobileSubtitle) mobileSubtitle.textContent = titleText;
}

function goToToday(){
  currentDate = new Date();
  currentDate.setHours(0, 0, 0, 0);
  setView('today');
}

function previousPeriod(){
  if(currentView === 'today'){
    const newDate = new Date(currentDate);
    newDate.setDate(newDate.getDate() - 1);
    currentDate = newDate;
  } else {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() - 1);
    currentDate = newDate;
  }
  updateTitle();
  renderSchedule();
}

function nextPeriod(){
  if(currentView === 'today'){
    const newDate = new Date(currentDate);
    newDate.setDate(newDate.getDate() + 1);
    currentDate = newDate;
  } else {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() + 1);
    currentDate = newDate;
  }
  updateTitle();
  renderSchedule();
}

function renderSchedule(){
  const view = document.getElementById('scheduleView');
  view.innerHTML = '<p style="text-align:center; padding:40px; color:#9fb0c3;">No work orders scheduled</p>';
  
  updatePickupColumn();
  
  // Setup swipe gestures for 30-day view on mobile
  if(isMobile && currentView === '30day') {
    setTimeout(setup30DaySwipe, 200);
  }
}

let touchStartX = 0;
let touchEndX = 0;
let touchStartY = 0;
let touchEndY = 0;

function setup30DaySwipe() {
  const scheduleView = document.getElementById('scheduleView');
  if(!scheduleView || currentView !== '30day') return;
  
  scheduleView.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].clientX;
    touchStartY = e.changedTouches[0].clientY;
  }, { passive: true });
  
  scheduleView.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].clientX;
    touchEndY = e.changedTouches[0].clientY;
    handleCalendarSwipe();
  }, { passive: true });
}

function handleCalendarSwipe() {
  const swipeThreshold = 50;
  const deltaX = touchEndX - touchStartX;
  const deltaY = touchEndY - touchStartY;
  
  // Must be horizontal swipe
  if(Math.abs(deltaX) <= Math.abs(deltaY)) return;
  if(Math.abs(deltaX) < swipeThreshold) return;
  
  // Swipe left = next month
  if(deltaX < 0) {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() + 1);
    currentDate = newDate;
    updateTitle();
    renderSchedule();
  }
  // Swipe right = previous month
  else {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() - 1);
    currentDate = newDate;
    updateTitle();
    renderSchedule();
  }
}

function updatePickupColumn(){
  const pickupColumn = document.getElementById('pickupColumn');
  const mobilePickupCount = document.getElementById('mobilePickupCount');
  const pickupCount = document.getElementById('pickupCount');
  const pickupTotal = document.getElementById('pickupTotal');
  
  const pickupOrders = workOrders.filter(wo => wo.status === 'ready_for_pickup');
  
  if(mobilePickupCount) mobilePickupCount.textContent = pickupOrders.length;
  if(pickupCount) pickupCount.textContent = pickupOrders.length;
  if(pickupTotal) pickupTotal.textContent = '$0.00';
  
  if(pickupColumn) {
    pickupColumn.innerHTML = pickupOrders.length === 0 
      ? '<p style="text-align:center; padding:20px; color:#9fb0c3;">No orders ready</p>'
      : '<p style="text-align:center; padding:20px; color:#9fb0c3;">Pickup orders would appear here</p>';
  }
}

function scrollToPickup(){
  if(isMobile) {
    showPickupOverlay();
  } else {
    const pickupColumn = document.getElementById('pickupColumn');
    if(pickupColumn) {
      pickupColumn.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
}

function showPickupOverlay(){
  const overlay = document.getElementById('pickupOverlay');
  const grid = document.getElementById('pickupOverlayGrid');
  const countBadge = document.getElementById('pickupOverlayCount');
  
  const pickupOrders = workOrders.filter(wo => wo.status === 'ready_for_pickup');
  
  countBadge.textContent = pickupOrders.length;
  grid.innerHTML = pickupOrders.length === 0 
    ? '<div style="text-align:center; padding:40px; color:#9fb0c3;">No orders ready for pickup</div>'
    : '<div style="text-align:center; padding:40px; color:#9fb0c3;">Pickup orders would appear here</div>';
  
  overlay.classList.add('active');
  
  setTimeout(() => {
    overlay.addEventListener('click', function closeOnOutside(e) {
      if(e.target === overlay) {
        closePickupOverlay();
        overlay.removeEventListener('click', closeOnOutside);
      }
    });
  }, 100);
}

function closePickupOverlay(){
  document.getElementById('pickupOverlay').classList.remove('active');
}

function closeDatePicker(){
  document.getElementById('datePickerModal').classList.remove('active');
}

async function load(){
  const token = await validateAuth();
  if(!token) return location.replace("login.html");
  
  try {
    workOrders = await fetchTable("work_orders", token);
    customers = await fetchTable("customers", token);
    vehicles = await fetchTable("vehicles", token);
    employees = await fetchTable("employees", token);
    
    updateTitle();
    renderSchedule();
  } catch(err){
    console.error('Load error:', err);
    alert('Error loading scheduling data');
  }
}

load();
</script>
</body>
</html>
