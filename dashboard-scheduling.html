<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scheduling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { 
      font-family:system-ui,-apple-system,sans-serif;
      background:#0b0f14;
      color:#e8eef6;
      min-height:100vh;
    }

    *::-webkit-scrollbar { width:8px; height:8px; }
    *::-webkit-scrollbar-track { background:#0f1621; }
    *::-webkit-scrollbar-thumb { background:#223044; border-radius:4px; }

    .mobile-header {
      display:none;
      background:#0f1621;
      border-bottom:1px solid #223044;
      position:sticky;
      top:0;
      z-index:100;
    }

    .mobile-header-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
    }

    .mobile-menu-toggle {
      background:transparent;
      border:none;
      color:#6b7280;
      font-size:20px;
      width:36px;
      height:36px;
      cursor:pointer;
    }

    .mobile-header-center { flex:1; margin-left:12px; }
    .mobile-header-title { font-size:18px; font-weight:600; }
    .mobile-header-subtitle { font-size:12px; color:#60a5fa; }

    .mobile-header-pickup {
      background:rgba(52, 211, 153, 0.15);
      border:1px solid rgba(52, 211, 153, 0.3);
      color:#34d399;
      font-size:13px;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .mobile-pickup-badge {
      background:rgba(52, 211, 153, 0.3);
      padding:2px 8px;
      border-radius:12px;
      font-size:11px;
      font-weight:700;
    }

    .mobile-header-content {
      max-height:0;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }
    .mobile-header-content.expanded { max-height:200px; }

    .mobile-header-nav {
      display:flex;
      gap:8px;
      padding:8px 12px;
      overflow-x:auto;
      background:#0b0f14;
      border-top:1px solid #223044;
    }

    .mobile-header-nav a {
      padding:8px 12px;
      color:#9fb0c3;
      text-decoration:none;
      font-size:13px;
      white-space:nowrap;
      border-radius:6px;
    }
    .mobile-header-nav a.active { background:#3b82f6; color:#fff; }

    .mobile-bottom-nav {
      display:none;
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#0f1621;
      padding:8px;
      z-index:100;
      border-top:1px solid #223044;
    }

    .mobile-nav-grid {
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:6px;
      margin-bottom:6px;
    }

    .mobile-nav-secondary {
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:6px;
    }

    .mobile-nav-btn {
      padding:10px 8px;
      border-radius:8px;
      border:1px solid #223044;
      background:#1a2535;
      color:#9fb0c3;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
      text-align:center;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .mobile-nav-btn.active { background:#3b82f6; border-color:#3b82f6; color:#fff; }

    .desktop-header {
      position:sticky;
      top:0;
      z-index:100;
      background:#0b0f14;
      border-bottom:1px solid #223044;
    }

    .header-top {
      padding:16px 24px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    h1 { font-size:32px; font-weight:600; }
    .business-name { font-size:14px; color:#60a5fa; }

    .header-nav {
      padding:0 24px 12px;
      display:flex;
      gap:24px;
    }

    .header-nav a {
      padding:12px 0;
      color:#9fb0c3;
      text-decoration:none;
      font-size:14px;
      border-bottom:2px solid transparent;
    }
    .header-nav a.active { color:#3b82f6; border-bottom-color:#3b82f6; }

    .header-actions {
      padding:0 24px 12px;
      border-top:1px solid #223044;
      padding-top:12px;
      display:flex;
      gap:16px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }

    .view-tabs {
      display:flex;
      gap:4px;
      background:#0f1621;
      border-radius:8px;
      padding:4px;
    }

    .view-tab {
      padding:8px 16px;
      background:transparent;
      border:none;
      border-radius:6px;
      color:#9fb0c3;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
    }
    .view-tab:hover { background:#1a2535; }
    .view-tab.active { background:#3b82f6; color:#fff; }

    .calendar-nav {
      display:flex;
      gap:8px;
      align-items:center;
    }

    .nav-arrow {
      padding:8px 12px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#e8eef6;
      cursor:pointer;
    }
    .nav-arrow:hover { background:#243648; border-color:#3b82f6; }

    .calendar-title {
      padding:8px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#e8eef6;
      font-size:14px;
      font-weight:600;
      min-width:180px;
      text-align:center;
    }

    button {
      padding:8px 16px;
      border-radius:8px;
      border:1px solid #223044;
      background:#1a2535;
      color:#e8eef6;
      cursor:pointer;
      font-size:13px;
    }
    button:hover { background:#243648; }

    .main-container {
      display:flex;
      max-width:1800px;
      margin:0 auto;
      gap:16px;
      padding:24px;
      min-height:calc(100vh - 200px);
    }

    .schedule-panel {
      flex:1;
      background:#0f1621;
      border:1px solid #223044;
      border-radius:12px;
      padding:20px;
      overflow-y:auto;
      max-height:calc(100vh - 240px);
    }

    .side-panel {
      width:320px;
      flex-shrink:0;
    }

    .side-column {
      background:#0f1621;
      border:1px solid #34d399;
      border-left:3px solid #34d399;
      border-radius:12px;
      padding:16px;
      max-height:calc(100vh - 240px);
      overflow-y:auto;
    }

    .side-column-header {
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      color:#34d399;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .pickup-stats { display:flex; gap:12px; }
    .pickup-count { font-weight:700; color:#e8eef6; }
    .pickup-total { font-weight:600; color:#34d399; }

    .wo-card {
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      padding:12px;
      margin-bottom:10px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .wo-card:hover { border-color:#3b82f6; transform:translateY(-1px); }

    .wo-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:8px;
    }

    .wo-number { font-weight:700; color:#3b82f6; font-size:14px; }

    .wo-status {
      font-size:10px;
      padding:3px 8px;
      border-radius:4px;
      font-weight:600;
      text-transform:uppercase;
    }
    .wo-status.scheduled { background:#8b5cf6; color:#fff; }
    .wo-status.in_progress { background:#3b82f6; color:#fff; }
    .wo-status.completed { background:#10b981; color:#fff; }
    .wo-status.ready_for_pickup { background:#34d399; color:#000; }

    .wo-customer { font-size:14px; font-weight:600; color:#e8eef6; margin-bottom:4px; }
    .wo-vehicle { font-size:12px; color:#9fb0c3; margin-bottom:4px; }
    .wo-amount { font-size:14px; font-weight:700; color:#10b981; }
    .wo-date { font-size:11px; color:#9fb0c3; }

    .day-section { margin-bottom:24px; }

    .day-header {
      font-size:14px;
      font-weight:700;
      color:#60a5fa;
      padding:8px 0;
      border-bottom:1px solid #223044;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .day-count {
      font-size:12px;
      background:#3b82f6;
      color:#fff;
      padding:2px 8px;
      border-radius:10px;
    }

    .empty-state {
      text-align:center;
      padding:40px;
      color:#9fb0c3;
    }

    .pickup-overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .pickup-overlay.active { display:flex; }

    .pickup-overlay-content {
      background:#0f1621;
      border:1px solid #34d399;
      border-radius:12px;
      padding:24px;
      max-width:600px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
    }

    .pickup-overlay-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid #223044;
    }

    .pickup-overlay-title { font-size:18px; font-weight:700; color:#34d399; }
    .pickup-overlay-close {
      background:transparent;
      border:none;
      color:#9fb0c3;
      font-size:24px;
      cursor:pointer;
    }

    @media (max-width: 768px) {
      .desktop-header { display:none !important; }
      .mobile-header { display:block !important; }
      .mobile-bottom-nav { display:block !important; }
      .side-panel { display:none !important; }
      body { padding-bottom:120px; }
      .main-container { padding:12px; }
      .schedule-panel { max-height:none; }
    }

    @media (min-width: 769px) {
      .mobile-header { display:none !important; }
      .mobile-bottom-nav { display:none !important; }
    }
  </style>
</head>

<body>
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Scheduling</div>
        <div class="mobile-header-subtitle" id="mobileSubtitle">Loading...</div>
      </div>
      <button class="mobile-header-pickup" onclick="showPickupOverlay()">
        <span>Pickup</span>
        <span class="mobile-pickup-badge" id="mobilePickupCount">0</span>
      </button>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html" class="active">Scheduling</a>
      </div>
    </div>
  </div>

  <div class="mobile-bottom-nav">
    <div class="mobile-nav-grid">
      <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
      <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
      <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
      <a href="dashboard-settings.html" class="mobile-nav-btn">Settings</a>
    </div>
    <div class="mobile-nav-secondary">
      <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
      <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
      <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
    </div>
  </div>

  <div class="pickup-overlay" id="pickupOverlay" onclick="if(event.target===this) closePickupOverlay()">
    <div class="pickup-overlay-content">
      <div class="pickup-overlay-header">
        <span class="pickup-overlay-title">Ready for Pickup</span>
        <button class="pickup-overlay-close" onclick="closePickupOverlay()">√ó</button>
      </div>
      <div id="pickupOverlayGrid"></div>
    </div>
  </div>

  <div class="desktop-header">
    <div class="header-top">
      <div>
        <h1>Scheduling</h1>
        <div class="business-name" id="businessName">Loading...</div>
      </div>
      <a onclick="logout()" style="color:#9fb0c3; cursor:pointer; font-size:14px;">Logout</a>
    </div>
    
    <div class="header-nav">
      <a href="dashboard-business.html">Business</a>
      <a href="dashboard-customer-search.html">Customers</a>
      <a href="dashboard-vehicle-search.html">Vehicles</a>
      <a href="dashboard-scheduling.html" class="active">Scheduling</a>
      <a href="dashboard-settings.html">Settings</a>
    </div>
    
    <div class="header-actions">
      <div class="view-tabs">
        <button class="view-tab active" id="tabAll" onclick="setView('all')">All</button>
        <button class="view-tab" id="tabScheduled" onclick="setView('scheduled')">Scheduled</button>
        <button class="view-tab" id="tabInProgress" onclick="setView('in_progress')">In Progress</button>
        <button class="view-tab" id="tabCompleted" onclick="setView('completed')">Completed</button>
      </div>
      
      <div class="calendar-nav">
        <button class="nav-arrow" onclick="previousWeek()">‚Üê</button>
        <div class="calendar-title" id="calendarTitle">All Work Orders</div>
        <button class="nav-arrow" onclick="nextWeek()">‚Üí</button>
      </div>
      
      <div style="display:flex; gap:12px;">
        <button onclick="location.href='dashboard-service.html'">Service</button>
        <button onclick="location.href='dashboard-parts.html'">Parts</button>
        <button onclick="location.href='dashboard-sales.html'">Sales</button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="schedule-panel">
      <div id="scheduleView">
        <div class="empty-state">Loading work orders...</div>
      </div>
    </div>

    <div class="side-panel">
      <div class="side-column">
        <div class="side-column-header">
          <span>Ready for Pickup</span>
          <div class="pickup-stats">
            <span class="pickup-count" id="pickupCount">0</span>
            <span class="pickup-total" id="pickupTotal">$0</span>
          </div>
        </div>
        <div id="pickupColumn"></div>
      </div>
    </div>
  </div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let workOrders = [];
let customers = [];
let vehicles = [];
let currentView = 'all';

async function checkAuth() {
  let { data: { session } } = await sb.auth.getSession();
  
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refreshToken = localStorage.getItem('sb_refresh_token');
    
    if (token && refreshToken) {
      const { data, error } = await sb.auth.setSession({
        access_token: token,
        refresh_token: refreshToken
      });
      if (error || !data.session) {
        window.location.href = 'login-worklogic.html';
        return null;
      }
      return data.session;
    }
    window.location.href = 'login-worklogic.html';
    return null;
  }
  return session;
}

async function logout() {
  await sb.auth.signOut();
  localStorage.removeItem('sb_access_token');
  localStorage.removeItem('sb_refresh_token');
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('sb-')) localStorage.removeItem(key);
  });
  window.location.href = 'login-worklogic.html?logout=1';
}

function toggleMobileMenu() {
  document.getElementById('mobileHeaderContent').classList.toggle('expanded');
}

function setView(view) {
  currentView = view;
  document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
  const tabMap = { all: 'tabAll', scheduled: 'tabScheduled', in_progress: 'tabInProgress', completed: 'tabCompleted' };
  const tab = document.getElementById(tabMap[view]);
  if (tab) tab.classList.add('active');
  updateTitle();
  renderSchedule();
}

function updateTitle() {
  const title = document.getElementById('calendarTitle');
  const mobileSubtitle = document.getElementById('mobileSubtitle');
  const filtered = getFilteredOrders();
  
  let text = '';
  if (currentView === 'all') text = 'All Work Orders';
  else if (currentView === 'scheduled') text = 'Scheduled';
  else if (currentView === 'in_progress') text = 'In Progress';
  else if (currentView === 'completed') text = 'Completed';
  
  text += ` (${filtered.length})`;
  
  if (title) title.textContent = text;
  if (mobileSubtitle) mobileSubtitle.textContent = text;
}

function previousWeek() { renderSchedule(); }
function nextWeek() { renderSchedule(); }

function getCustomerName(customerId) {
  const c = customers.find(x => x.customer_id === customerId);
  if (!c) return 'Unknown Customer';
  return `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.full_name || 'Unknown';
}

function getVehicleInfo(vehicleId) {
  const v = vehicles.find(x => x.vehicle_id === vehicleId);
  if (!v) return '';
  return `${v.year || ''} ${v.make || ''} ${v.model || ''}`.trim();
}

function formatDate(dateStr) {
  if (!dateStr) return '‚Äî';
  return new Date(dateStr).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function getFilteredOrders() {
  if (currentView === 'scheduled') return workOrders.filter(wo => wo.status === 'scheduled');
  if (currentView === 'in_progress') return workOrders.filter(wo => wo.status === 'in_progress');
  if (currentView === 'completed') return workOrders.filter(wo => wo.status === 'completed' || wo.status === 'closed');
  return [...workOrders];
}

function renderWorkOrderCard(wo) {
  const customerName = getCustomerName(wo.customer_id);
  const vehicleInfo = getVehicleInfo(wo.vehicle_id);
  const amount = wo.total_amount ? `$${parseFloat(wo.total_amount).toFixed(2)}` : '$0.00';
  const woNum = wo.wo_number || wo.work_order_number || (wo.work_order_id ? wo.work_order_id.substring(0, 8) : '‚Äî');
  const status = wo.status || 'draft';
  const schedDate = wo.scheduled_start ? formatDate(wo.scheduled_start) : formatDate(wo.created_at);
  
  return `
    <div class="wo-card" onclick="openWorkOrder('${wo.work_order_id}')">
      <div class="wo-header">
        <div class="wo-number">WO-${woNum}</div>
        <div class="wo-status ${status}">${status.replace('_', ' ')}</div>
      </div>
      <div class="wo-customer">${customerName}</div>
      ${vehicleInfo ? `<div class="wo-vehicle">${vehicleInfo}</div>` : ''}
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
        <div class="wo-date">${schedDate}</div>
        <div class="wo-amount">${amount}</div>
      </div>
    </div>
  `;
}

function renderSchedule() {
  const view = document.getElementById('scheduleView');
  const filtered = getFilteredOrders();
  updateTitle();
  
  if (filtered.length === 0) {
    view.innerHTML = '<div class="empty-state">No work orders found</div>';
    updatePickupColumn();
    return;
  }
  
  filtered.sort((a, b) => {
    const dateA = new Date(a.scheduled_start || a.created_at);
    const dateB = new Date(b.scheduled_start || b.created_at);
    return currentView === 'completed' ? dateB - dateA : dateA - dateB;
  });
  
  const grouped = {};
  filtered.forEach(wo => {
    const dateKey = wo.scheduled_start 
      ? new Date(wo.scheduled_start).toDateString() 
      : new Date(wo.created_at).toDateString();
    if (!grouped[dateKey]) grouped[dateKey] = [];
    grouped[dateKey].push(wo);
  });
  
  let html = '';
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  Object.keys(grouped).forEach(dateKey => {
    const date = new Date(dateKey);
    let label = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    
    if (date.toDateString() === today.toDateString()) label = 'üìÖ Today - ' + label;
    else if (date < today) label = '‚è™ ' + label;
    else label = 'üìÜ ' + label;
    
    html += `
      <div class="day-section">
        <div class="day-header">
          <span>${label}</span>
          <span class="day-count">${grouped[dateKey].length}</span>
        </div>
        ${grouped[dateKey].map(renderWorkOrderCard).join('')}
      </div>
    `;
  });
  
  view.innerHTML = html;
  updatePickupColumn();
}

function updatePickupColumn() {
  const pickupOrders = workOrders.filter(wo => wo.status === 'ready_for_pickup');
  const pickupTotal = pickupOrders.reduce((sum, wo) => sum + (parseFloat(wo.total_amount) || 0), 0);
  
  document.getElementById('pickupCount').textContent = pickupOrders.length;
  document.getElementById('pickupTotal').textContent = '$' + Math.round(pickupTotal).toLocaleString();
  document.getElementById('mobilePickupCount').textContent = pickupOrders.length;
  
  const column = document.getElementById('pickupColumn');
  column.innerHTML = pickupOrders.length === 0 
    ? '<div class="empty-state" style="padding:20px; font-size:13px;">No orders ready for pickup</div>'
    : pickupOrders.map(renderWorkOrderCard).join('');
}

function openWorkOrder(woId) {
  window.location.href = `work-order-edit.html?id=${woId}`;
}

function showPickupOverlay() {
  const pickupOrders = workOrders.filter(wo => wo.status === 'ready_for_pickup');
  const grid = document.getElementById('pickupOverlayGrid');
  grid.innerHTML = pickupOrders.length === 0 
    ? '<div class="empty-state">No orders ready for pickup</div>'
    : pickupOrders.map(renderWorkOrderCard).join('');
  document.getElementById('pickupOverlay').classList.add('active');
}

function closePickupOverlay() {
  document.getElementById('pickupOverlay').classList.remove('active');
}

async function loadBusinessSettings() {
  const { data } = await sb.from('business_settings').select('*').single();
  if (data) {
    document.getElementById('businessName').textContent = data.business_name || data.company_name || '';
  }
}

async function load() {
  const session = await checkAuth();
  if (!session) return;
  
  console.log('Logged in as:', session.user.email);
  await loadBusinessSettings();
  
  const { data: woData, error: woErr } = await sb.from('work_orders').select('*');
  if (woErr) console.error('Work orders error:', woErr.message);
  workOrders = woData || [];
  console.log('Loaded work orders:', workOrders.length);
  
  const { data: custData } = await sb.from('customers').select('*');
  customers = custData || [];
  console.log('Loaded customers:', customers.length);
  
  const { data: vehData } = await sb.from('vehicles').select('*');
  vehicles = vehData || [];
  console.log('Loaded vehicles:', vehicles.length);
  
  renderSchedule();
}

load();
</script>

</body>
</html>
