<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Scheduler</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
      --month-alt-bg: #0d1218;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa; --month-alt-bg: #0d1218;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373; --month-alt-bg: #161616;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8; --month-alt-bg: #141c2e;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa; --month-alt-bg: #0c0c0f;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0; --month-alt-bg: #0c111e;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff; --month-alt-bg: #101010;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf; --month-alt-bg: #0c1517;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80; --month-alt-bg: #0c130e;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary); color: var(--text-primary);
      overflow-x: hidden; user-select: none; -webkit-user-select: none;
    }
    body { padding-bottom: 165px; }
    .mobile-top-header { display: block; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; }
    .mobile-menu-toggle { background: transparent; border: 1px solid transparent; border-radius: 6px; color: var(--text-secondary); font-size: 20px; padding: 0; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; -webkit-appearance: none; }
    .mobile-header-center { flex: 1; margin-left: 12px; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-primary); }
    .view-style-toggle { display: flex; gap: 4px; background: var(--bg-card); padding: 4px; border-radius: 10px; border: 1px solid var(--border-default); }
    .view-style-btn { padding: 6px 10px; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; -webkit-appearance: none; }
    .view-style-btn.active { background: var(--accent-primary); color: white; }
    .accordion-icon-header { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s ease; }
    .mobile-menu-toggle.active .accordion-icon-header { transform: rotate(180deg); }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: var(--bg-card); border: 1px solid var(--accent-primary); color: var(--text-primary); border-radius: 8px; cursor: pointer; -webkit-appearance: none; }
    .main-tabs { display: flex; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .main-tab { flex: 1; padding: 14px 12px; text-align: center; font-size: 14px; font-weight: 600; color: var(--text-secondary); background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; -webkit-appearance: none; }
    .main-tab.active { color: var(--accent-light); border-bottom-color: var(--accent-primary); }
    .date-nav-container { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .lanes-date-nav { padding: 12px 0; }
    .lanes-controls-row { display: flex; align-items: center; gap: 8px; padding: 0 16px 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .lanes-controls-row::-webkit-scrollbar { display: none; }
    .lanes-today-btn { flex-shrink: 0; padding: 8px 16px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--accent-primary); color: white; font-size: 13px; font-weight: 600; cursor: pointer; -webkit-appearance: none; }
    .lanes-filter-btn { flex-shrink: 0; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; -webkit-appearance: none; }
    .lanes-filter-btn.active { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: var(--accent-primary); color: var(--accent-light); }
    .lanes-filter-btn .count { background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    .expand-toggle-btn { flex-shrink: 0; width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: auto; -webkit-appearance: none; }
    .expand-toggle-btn.expanded { background: color-mix(in srgb, var(--accent-primary) 30%, transparent); border-color: var(--accent-primary); color: var(--accent-light); }
    .lanes-date-chips { display: flex; gap: 6px; padding: 0 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; overscroll-behavior-x: contain; }
    .lanes-date-chips::-webkit-scrollbar { display: none; }
    .month-section { display: flex; gap: 6px; padding: 8px; border-radius: 12px; margin-right: 4px; flex-shrink: 0; }
    .month-section.even { background: var(--bg-secondary); }
    .month-section.odd { background: var(--month-alt-bg); }
    .month-label { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; padding: 4px 2px; opacity: 0.7; }
    .month-days { display: flex; gap: 6px; }
    .lanes-date-chip { flex-shrink: 0; padding: 8px 10px; border-radius: 10px; background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-width: 48px; -webkit-appearance: none; scroll-snap-align: center; }
    .lanes-date-chip.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
    .lanes-date-chip.today:not(.active) { border-color: var(--accent-light); border-width: 2px; }
    .lanes-date-chip .day-name { font-size: 9px; text-transform: uppercase; opacity: 0.8; }
    .lanes-date-chip .day-num { font-size: 16px; font-weight: 700; margin-top: 2px; }
    .lanes-date-chip .job-count { font-size: 8px; margin-top: 2px; opacity: 0.8; }
    .content-area { position: relative; overflow-x: hidden; overflow-y: auto; min-height: calc(100vh - 350px); -webkit-overflow-scrolling: touch; }
    .swipe-page { position: absolute; top: 0; left: 0; width: 100%; min-height: 100%; will-change: transform, opacity; }
    .swipe-page.current { position: relative; transform: translateX(0); opacity: 1; z-index: 2; }
    .swipe-page.prev { transform: translateX(-100%); opacity: 0; z-index: 1; }
    .swipe-page.next { transform: translateX(100%); opacity: 0; z-index: 1; }
    .swipe-page.animating { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    .edge-indicator { position: fixed; top: 50%; transform: translateY(-50%); width: 70px; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; font-size: 24px; color: white; background: linear-gradient(90deg, rgba(59,130,246,0.9), transparent); opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 500; border-radius: 0 16px 16px 0; }
    .edge-indicator.left { left: 0; }
    .edge-indicator.right { right: 0; background: linear-gradient(-90deg, rgba(59,130,246,0.9), transparent); border-radius: 16px 0 0 16px; }
    .edge-indicator.active { opacity: 1; animation: edgePulse 0.6s ease-in-out infinite; }
    .edge-indicator .date-preview { font-size: 12px; font-weight: 700; text-align: center; line-height: 1.3; padding: 0 8px; }
    .edge-indicator .edge-arrow { font-size: 28px; }
    @keyframes edgePulse { 0%, 100% { opacity: 0.85; } 50% { opacity: 1; } }
    .lanes-container { padding: 12px 0; }
    .tech-lane { margin-bottom: 8px; background: var(--bg-card); margin: 0 12px 8px; border-radius: 12px; border: 1px solid var(--border-default); overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s; }
    .tech-lane.drop-target { border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-primary); }
    .lane-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; }
    .lane-header:active { background: var(--bg-hover); }
    .lane-info { display: flex; align-items: center; gap: 12px; }
    .tech-avatar { width: 40px; height: 40px; border-radius: 10px; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: white; }
    .tech-avatar.green { background: #22c55e; }
    .tech-avatar.orange { background: #f97316; }
    .tech-avatar.purple { background: #8b5cf6; }
    .tech-details h3 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .tech-details span { font-size: 12px; color: var(--text-secondary); }
    .lane-header-right { display: flex; align-items: center; gap: 16px; }
    .lane-stats { display: flex; gap: 16px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 16px; font-weight: 700; }
    .stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
    .lane-expand-icon { font-size: 14px; color: var(--text-secondary); transition: transform 0.2s; }
    .tech-lane.expanded .lane-expand-icon { transform: rotate(180deg); }
    .lane-cards-wrapper { max-height: 0; overflow: clip; transition: max-height 0.3s ease; }
    .tech-lane.expanded .lane-cards-wrapper { max-height: 500px; overflow: visible; }
    .lane-cards { display: flex; gap: 10px; overflow-x: scroll; overflow-y: hidden; padding: 0 16px 12px; -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; touch-action: pan-x; }
    .lane-cards::-webkit-scrollbar { display: none; }
    .wo-card { flex-shrink: 0; width: 200px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-default); padding: 10px 12px 32px 12px; cursor: grab; position: relative; border-left: 4px solid var(--accent-primary); touch-action: pan-x pan-y; }
    .wo-card:active { cursor: grabbing; }
    .wo-card.status-in_progress { border-left-color: var(--accent-primary); }
    .wo-card.status-waiting { border-left-color: #eab308; }
    .wo-card.status-completed { border-left-color: #22c55e; }
    .wo-card.status-urgent { border-left-color: #ef4444; }
    .wo-card.fleet::after { content: 'FLEET'; position: absolute; top: 6px; right: 6px; font-size: 7px; font-weight: 700; padding: 2px 4px; border-radius: 3px; background: #14b8a6; color: white; }
    .wo-card.dragging { opacity: 0.5; transform: scale(0.95); touch-action: none; }
    .card-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .card-customer { font-size: 14px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 35px; }
    .card-info-row { display: flex; align-items: center; gap: 6px; }
    .card-vehicle { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; }
    .card-dot { width: 3px; height: 3px; border-radius: 50%; background: var(--text-secondary); }
    .card-status { font-size: 9px; font-weight: 600; text-transform: uppercase; padding: 2px 5px; border-radius: 4px; }
    .card-status.in_progress { background: rgba(59,130,246,0.2); color: var(--accent-light); }
    .card-status.waiting { background: rgba(234,179,8,0.15); color: #eab308; }
    .card-status.completed { background: rgba(34,197,94,0.15); color: #22c55e; }
    .card-status.urgent { background: rgba(239,68,68,0.15); color: #ef4444; }
    .card-status.scheduled { background: var(--bg-hover); color: var(--text-secondary); }
    .card-amount { font-size: 12px; font-weight: 700; margin-left: auto; }
    .add-card { flex-shrink: 0; width: 70px; min-height: 60px; background: var(--bg-primary); border-radius: 10px; border: 2px dashed var(--border-default); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; }
    .add-card-icon { width: 22px; height: 22px; border-radius: 6px; background: var(--bg-hover); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text-secondary); }
    .add-card span { font-size: 9px; color: var(--text-secondary); }
    .card-details-btn { position: absolute; bottom: 8px; right: 8px; padding: 4px 8px; font-size: 10px; font-weight: 600; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
    .wo-card:hover .card-details-btn { opacity: 1; }
    .stack-container { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .stack-card { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border-default); border-left: 4px solid var(--accent-primary); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .stack-card.status-in_progress { border-left-color: var(--accent-primary); }
    .stack-card.status-waiting { border-left-color: #eab308; }
    .stack-card.status-completed { border-left-color: #22c55e; }
    .stack-card.status-urgent { border-left-color: #ef4444; }
    .stack-card-left { flex: 1; }
    .stack-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .stack-customer { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .stack-vehicle { font-size: 12px; color: var(--text-secondary); }
    .stack-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; padding-right: 60px; }
    .stack-assignee { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
    .stack-card:hover .card-details-btn { opacity: 1; }
    .grid-container { padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    .grid-card { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border-default); border-left: 4px solid var(--accent-primary); padding: 12px 16px 40px 16px; position: relative; }
    .grid-card.status-in_progress { border-left-color: var(--accent-primary); }
    .grid-card.status-waiting { border-left-color: #eab308; }
    .grid-card.status-completed { border-left-color: #22c55e; }
    .grid-card.status-urgent { border-left-color: #ef4444; }
    .grid-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .grid-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .grid-customer { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .grid-vehicle { font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; }
    .grid-card-footer { display: flex; justify-content: space-between; align-items: center; }
    .grid-assignee { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
    .grid-amount { font-size: 14px; font-weight: 700; }
    .grid-card:hover .card-details-btn { opacity: 1; }
    .tech-avatar.small { width: 24px; height: 24px; font-size: 10px; border-radius: 6px; }
    .drag-ghost { position: fixed; z-index: 1001; pointer-events: none; opacity: 0.9; transform: scale(1.05) rotate(2deg); box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state-text { font-size: 16px; }
    .mobile-action-buttons { position: fixed; bottom: 102px; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border-default); padding: 8px 8px 0 8px; z-index: 101; }
    .mobile-action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px; }
    .mobile-action-btn { padding: 10px 8px; border-radius: 8px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); font-size: 12px; font-weight: 600; cursor: pointer; min-height: 44px; display: flex; align-items: center; justify-content: center; -webkit-appearance: none; }
    .mobile-action-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border-default); padding: 8px; z-index: 100; }
    .mobile-nav-top { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 6px; }
    .mobile-nav-secondary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; min-height: 44px; }
    .mobile-nav-btn.related { background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--text-primary); }
    .toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--accent-primary); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 1000; display: none; }
    .toast.show { display: block; animation: toastIn 0.3s ease; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 2000; align-items: flex-end; justify-content: center; padding: 0; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 0; line-height: 1; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
    .modal-close:active { background: var(--bg-hover); }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-label .required { color: #ef4444; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 16px; -webkit-appearance: none; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .search-container { position: relative; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 10px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
    .search-results.show { display: block; }
    .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-default); }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:active { background: var(--bg-hover); }
    .search-result-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .search-result-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .search-result-new { display: flex; align-items: center; gap: 8px; color: var(--accent-light); }
    .search-result-new .plus-icon { width: 20px; height: 20px; border-radius: 50%; background: var(--accent-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
    .selected-chip { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--accent-primary); border-radius: 10px; }
    .selected-chip-info { flex: 1; }
    .selected-chip-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .selected-chip-sub { font-size: 12px; color: var(--text-secondary); }
    .selected-chip-remove { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 4px; }
    .modal-footer { padding: 16px 20px 24px; border-top: 1px solid var(--border-default); }
    .modal-footer-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btn-primary { padding: 14px 12px; border-radius: 12px; border: none; background: var(--accent-primary); color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary:active { opacity: 0.9; transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-secondary:active { background: var(--bg-hover); }
    .btn-outline { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--accent-primary); background: transparent; color: var(--accent-light); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-outline:active { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); }
    .new-fields { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-top: 12px; border: 1px solid var(--border-default); }
    .new-fields .form-group { margin-bottom: 16px; }
    .new-fields .form-group:last-child { margin-bottom: 0; }
    .btn-loading { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @supports not (background: color-mix(in srgb, red 50%, blue)) {
      .mobile-nav-btn.related, .mobile-action-btn { background: var(--bg-hover); }
      .lanes-filter-btn.active { background: var(--bg-hover); }
      .expand-toggle-btn.expanded { background: var(--accent-primary); }
    }
  </style>
</head>
<body>
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span class="accordion-icon-header">☰</span></button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Scheduler</div>
      <div class="business-name" id="businessName">Scheduler</div>
    </div>
    <div class="view-style-toggle">
      <button class="view-style-btn active" id="styleLanes" onclick="setViewStyle('lanes')">Lanes</button>
      <button class="view-style-btn" id="styleStack" onclick="setViewStyle('stack')">Stack</button>
      <button class="view-style-btn" id="styleGrid" onclick="setViewStyle('grid')">Grid</button>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='dashboard-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
    </div>
  </div>
</div>
<div class="main-tabs">
  <button class="main-tab active" id="tabService" onclick="switchTab('service')">Service</button>
  <button class="main-tab" id="tabSales" onclick="switchTab('sales')">Sales</button>
  <button class="main-tab" id="tabFleet" onclick="switchTab('fleet')">Fleet</button>
</div>
<div class="date-nav-container" id="lanesDateNav">
  <div class="lanes-date-nav">
    <div class="lanes-controls-row" id="lanesControlsRow"></div>
    <div class="lanes-date-chips" id="lanesDateChips"></div>
  </div>
</div>
<div class="edge-indicator left" id="edgeLeft"><span class="edge-arrow">◀</span><div class="date-preview" id="edgeLeftPreview"></div></div>
<div class="edge-indicator right" id="edgeRight"><span class="edge-arrow">▶</span><div class="date-preview" id="edgeRightPreview"></div></div>
<div class="content-area" id="contentArea">
  <div class="swipe-page current" id="currentPage"></div>
  <div class="swipe-page prev" id="prevPage"></div>
  <div class="swipe-page next" id="nextPage"></div>
</div>

<!-- Quick Work Order Modal -->
<div class="modal-overlay" id="quickWOModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Quick Work Order</div>
      <button class="modal-close" onclick="closeQuickWOModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Customer <span class="required">*</span></label>
        <div id="woCustomerSelected" style="display:none;"></div>
        <div class="search-container" id="woCustomerSearchContainer">
          <input type="text" class="form-input" id="woCustomerSearch" placeholder="Search by name or phone..." oninput="searchWOCustomers(this.value)" autocomplete="off">
          <div class="search-results" id="woCustomerResults"></div>
        </div>
        <div class="new-fields" id="woNewCustomerFields" style="display:none;">
          <div class="form-row">
            <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="woNewFirstName" placeholder="First name"></div>
            <div class="form-group"><label class="form-label">Last Name <span class="required">*</span></label><input type="text" class="form-input" id="woNewLastName" placeholder="Last name"></div>
          </div>
          <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="woNewPhone" placeholder="(555) 123-4567"></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Vehicle <span class="required">*</span></label>
        <div id="woVehicleSelected" style="display:none;"></div>
        <div class="search-container" id="woVehicleSearchContainer">
          <input type="text" class="form-input" id="woVehicleSearch" placeholder="Search or enter Year Make Model..." oninput="searchWOVehicles(this.value)" autocomplete="off">
          <div class="search-results" id="woVehicleResults"></div>
        </div>
        <div class="new-fields" id="woNewVehicleFields" style="display:none;">
          <div class="form-row">
            <div class="form-group"><label class="form-label">Year</label><input type="text" class="form-input" id="woNewVehYear" placeholder="2024" maxlength="4"></div>
            <div class="form-group"><label class="form-label">Make</label><input type="text" class="form-input" id="woNewVehMake" placeholder="Toyota"></div>
          </div>
          <div class="form-group"><label class="form-label">Model</label><input type="text" class="form-input" id="woNewVehModel" placeholder="Camry"></div>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Service Needed</label><textarea class="form-textarea" id="woDescription" placeholder="Brief description of service needed..."></textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="woDate"></div>
        <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="woTime" value="09:00"></div>
      </div>
      <div class="form-group"><label class="form-label">Assign Technician</label><select class="form-select" id="woTechnician"><option value="">-- Unassigned --</option></select></div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-buttons">
        <button class="btn-primary" id="woCreateBtn" onclick="createQuickWorkOrder()"><span id="woCreateText">Set Appt</span><span id="woCreateLoading" class="btn-loading" style="display:none;"></span></button>
        <button class="btn-outline" onclick="editWOCustomerProfile()">Edit Profile</button>
        <button class="btn-secondary" onclick="closeQuickWOModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Quick Appointment Modal -->
<div class="modal-overlay" id="quickApptModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Quick Appointment</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <button class="btn-outline" id="apptNewCustomerBtn" style="padding:8px 12px;font-size:12px;" onclick="showNewApptCustomerFields()">+ New</button>
        <button class="modal-close" onclick="closeQuickApptModal()">&times;</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Customer <span class="required">*</span></label>
        <div id="apptCustomerSelected" style="display:none;"></div>
        <div class="search-container" id="apptCustomerSearchContainer">
          <input type="text" class="form-input" id="apptCustomerSearch" placeholder="Search by name or phone..." oninput="searchApptCustomers(this.value)" autocomplete="off">
          <div class="search-results" id="apptCustomerResults"></div>
        </div>
        <div class="new-fields" id="apptNewCustomerFields" style="display:none;">
          <div class="form-group"><label class="form-label">Customer Name <span class="required">*</span></label><input type="text" class="form-input" id="apptCustomerName" placeholder="Full name"></div>
          <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="apptOrganization" placeholder="Company or organization name"></div>
          <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="apptPhone" placeholder="(555) 123-4567"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date <span class="required">*</span></label><input type="date" class="form-input" id="apptDate"></div>
        <div class="form-group"><label class="form-label">Time <span class="required">*</span></label><input type="time" class="form-input" id="apptTime" value="10:00"></div>
      </div>
      <div class="form-group"><label class="form-label">Appointment Type</label><select class="form-select" id="apptType"><option value="">Loading...</option></select></div>
      <div class="form-group"><label class="form-label">Vehicle Interest</label><input type="text" class="form-input" id="apptVehicleInterest" placeholder="e.g., 2024 Honda CR-V"></div>
      <div class="form-group"><label class="form-label">Assign Salesperson</label><select class="form-select" id="apptSalesperson"><option value="">-- Unassigned --</option></select></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="apptNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-buttons" id="apptFooterButtons">
        <button class="btn-primary" id="apptCreateBtn" onclick="createQuickAppointment()"><span id="apptCreateText">Set Appt</span><span id="apptCreateLoading" class="btn-loading" style="display:none;"></span></button>
        <button class="btn-outline" onclick="editApptCustomerProfile()">Edit Profile</button>
        <button class="btn-secondary" onclick="closeQuickApptModal()">Cancel</button>
      </div>
      <div class="modal-footer-buttons" id="apptEditFooterButtons" style="display:none;">
        <button class="btn-primary" id="apptSaveBtn" onclick="createQuickAppointment()"><span id="apptSaveText">Save Changes</span><span id="apptSaveLoading" class="btn-loading" style="display:none;"></span></button>
        <button class="btn-outline" onclick="editApptCustomerProfile()">Edit Profile</button>
        <button class="btn-secondary" style="background:rgba(239,68,68,0.15);border-color:#ef4444;color:#ef4444;" onclick="deleteAppointment()">Delete</button>
      </div>
    </div>
  </div>
</div>

<div class="mobile-action-buttons">
  <div class="mobile-action-grid">
    <button class="mobile-action-btn" onclick="openQuickWOModal()">+ Work Order</button>
    <button class="mobile-action-btn active">Scheduler</button>
    <button class="mobile-action-btn" onclick="openQuickApptModal()">+ Appointment</button>
  </div>
</div>
<nav class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-business.html" class="mobile-nav-btn related">Business</a>
    <a href="dashboard-search.html" class="mobile-nav-btn">Search</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn related">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn related">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn related">Sales</a>
  </div>
</nav>
<div class="toast" id="toast"></div>
<script>
var SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
var tenantId=null,technicians=[],salespeople=[],serviceJobs=[],fleetJobs=[],salesJobs=[],allCustomers=[],allVehicles=[],appointmentTypes=[];
var currentTab='service',currentViewStyle='lanes',selectedDate=0,currentFilter='all',lanesExpanded=false,isAnimating=false;
var woSelectedCustomer=null,woSelectedVehicle=null,woIsNewCustomer=false,woIsNewVehicle=false;
var lastCreatedCustomerId=null;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);}loadTheme();
var savedExpand=localStorage.getItem('lanes-expanded');if(savedExpand==='true')lanesExpanded=true;
var savedStyle=localStorage.getItem('scheduler-view-style');if(savedStyle&&['lanes','stack','grid'].indexOf(savedStyle)!==-1)currentViewStyle=savedStyle;
function toggleMobileMenu(b){document.getElementById('mobileHeaderContent').classList.toggle('expanded');b.classList.toggle('active');}
async function checkAuth(){var s=null;try{var r=await sb.auth.getSession();s=r.data.session;}catch(e){}if(!s){var t=localStorage.getItem('sb_access_token'),rt=localStorage.getItem('sb_refresh_token');if(t&&rt){try{var r=await sb.auth.setSession({access_token:t,refresh_token:rt});if(r.data&&r.data.session)return r.data.session;}catch(e){}}window.location.href='login.html';return null;}return s;}
async function loadBusinessSettings(){try{var r=await sb.from('business_settings').select('*').single();if(r.error){document.getElementById('businessName').textContent='My Business';return;}if(r.data){tenantId=r.data.tenant_id;document.getElementById('businessName').textContent=r.data.business_name||r.data.company_name||'My Business';}else{document.getElementById('businessName').textContent='My Business';}}catch(e){document.getElementById('businessName').textContent='My Business';}}
async function loadAllData(){if(!tenantId)return;try{await Promise.all([loadTechnicians(),loadSalespeople(),loadCustomersForSearch(),loadVehiclesForSearch(),loadAppointmentTypes()]);await loadServiceJobs();await loadSalesJobs();renderAll();}catch(e){}}
async function loadCustomersForSearch(){try{var r=await sb.from('customers').select('customer_id,full_name,phone,email').eq('tenant_id',tenantId).order('full_name',{ascending:true}).limit(500);if(r.data)allCustomers=r.data;}catch(e){}}
async function loadVehiclesForSearch(){try{var r=await sb.from('vehicles').select('vehicle_id,customer_id,year,make,model,vin,license_plate').eq('tenant_id',tenantId).order('year',{ascending:false}).limit(500);if(r.data)allVehicles=r.data;}catch(e){}}
async function loadAppointmentTypes(){
  try{
    var r=await sb.from('appointment_types').select('*').eq('tenant_id',tenantId).eq('is_active',true).order('sort_order',{ascending:true}).order('name',{ascending:true});
    if(r.data && r.data.length > 0){
      appointmentTypes=r.data;
    }else{
      appointmentTypes=[];
    }
    populateAppointmentTypeDropdown();
  }catch(e){
    console.error('Error loading appointment types:',e);
    appointmentTypes=[];
    populateAppointmentTypeDropdown();
  }
}
function populateAppointmentTypeDropdown(){
  var s=document.getElementById('apptType');
  s.innerHTML='';
  if(appointmentTypes.length===0){
    // Fallback defaults if no types configured
    s.innerHTML='<option value="consultation">Consultation</option><option value="test_drive">Test Drive</option><option value="vehicle_delivery">Vehicle Delivery</option><option value="trade_appraisal">Trade-In Appraisal</option><option value="follow_up">Follow Up</option><option value="other">Other</option>';
    return;
  }
  appointmentTypes.forEach(function(t){
    var opt = document.createElement('option');
    opt.value = t.name; // Use name as value for compatibility with existing data
    opt.textContent = t.name;
    s.appendChild(opt);
  });
}
async function loadTechnicians(){try{var r=await sb.from('employees').select('*').eq('tenant_id',tenantId).eq('is_active',true);if(r.data&&r.data.length>0){var st=r.data.filter(function(e){var d=(e.department||'').toLowerCase(),ro=(e.role||'').toLowerCase();return d==='service'||ro==='technician'||ro==='master_tech'||ro==='lube_tech'||ro==='mechanic'||ro.includes('tech');});technicians=st.map(function(e,i){var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown';var ini='??';if(e.first_name&&e.last_name)ini=(e.first_name[0]+e.last_name[0]).toUpperCase();return{id:e.employee_id,name:n,role:formatRole(e.role),initials:ini,color:getColorForIndex(i)};});}}catch(e){}technicians.push({id:'unassigned',name:'Unassigned',role:'Drag to assign',initials:'?',color:'purple'});populateTechnicianDropdown();}
function populateTechnicianDropdown(){var s=document.getElementById('woTechnician');s.innerHTML='<option value="">-- Unassigned --</option>';technicians.forEach(function(t){if(t.id!=='unassigned')s.innerHTML+='<option value="'+t.id+'">'+t.name+'</option>';});}
async function loadSalespeople(){try{var r=await sb.from('employees').select('*').eq('tenant_id',tenantId).eq('is_active',true);if(r.data&&r.data.length>0){var ss=r.data.filter(function(e){var d=(e.department||'').toLowerCase(),ro=(e.role||'').toLowerCase();return d==='sales'||ro==='sales_manager'||ro==='sales_consultant'||ro==='salesperson'||ro.includes('sales');});salespeople=ss.map(function(e,i){var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown';var ini='??';if(e.first_name&&e.last_name)ini=(e.first_name[0]+e.last_name[0]).toUpperCase();return{id:e.employee_id,name:n,role:formatRole(e.role),initials:ini,color:getColorForIndex(i)};});}}catch(e){}salespeople.push({id:'unassigned',name:'Unassigned',role:'Drag to assign',initials:'?',color:'purple'});populateSalespersonDropdown();}
function populateSalespersonDropdown(){var s=document.getElementById('apptSalesperson');s.innerHTML='<option value="">-- Unassigned --</option>';salespeople.forEach(function(sp){if(sp.id!=='unassigned')s.innerHTML+='<option value="'+sp.id+'">'+sp.name+'</option>';});}
function formatRole(r){if(!r)return'Staff';return r.replace(/_/g,' ').replace(/\b\w/g,function(l){return l.toUpperCase();});}
async function loadServiceJobs(){var today=new Date(),startDate=new Date(today),endDate=new Date(today);startDate.setDate(startDate.getDate()-7);endDate.setDate(endDate.getDate()+60);try{var r=await sb.from('work_orders').select('*').eq('tenant_id',tenantId).eq('deleted',false).gte('scheduled_start',startDate.toISOString()).lte('scheduled_start',endDate.toISOString()).order('scheduled_start',{ascending:true});if(r.error)return;if(r.data&&r.data.length>0){var cids=[...new Set(r.data.map(function(w){return w.customer_id;}).filter(Boolean))];var vids=[...new Set(r.data.map(function(w){return w.vehicle_id;}).filter(Boolean))];var cm={};if(cids.length>0){var cr=await sb.from('customers').select('customer_id,full_name').in('customer_id',cids);if(cr.data)cr.data.forEach(function(c){cm[c.customer_id]=c.full_name;});}var vm={};if(vids.length>0){var vr=await sb.from('vehicles').select('vehicle_id,make,model,year').in('vehicle_id',vids);if(vr.data)vr.data.forEach(function(v){vm[v.vehicle_id]=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');});}var nfj=r.data.filter(function(w){return!w.fleet_id;});serviceJobs=nfj.map(function(w){var jd=new Date(w.scheduled_start),ts=new Date(today.getFullYear(),today.getMonth(),today.getDate()),js=new Date(jd.getFullYear(),jd.getMonth(),jd.getDate()),off=Math.round((js-ts)/(1000*60*60*24));return{id:w.work_order_id,wo_number:w.wo_number,customer:cm[w.customer_id]||'WO #'+w.wo_number,vehicle:(vm[w.vehicle_id]||w.summary||'Service').trim(),time:formatTimeFromTimestamp(w.scheduled_start),status:mapStatus(w.status),tech:w.assigned_employee_id||'unassigned',amount:formatAmount(w.grand_total),date:off,fleet:false,priority:w.priority};});var fjs=r.data.filter(function(w){return w.fleet_id;});var fids=[...new Set(fjs.map(function(w){return w.fleet_id;}).filter(Boolean))];var fm={};if(fids.length>0){var fr=await sb.from('fleets').select('fleet_id,fleet_name').in('fleet_id',fids);if(fr.data)fr.data.forEach(function(f){fm[f.fleet_id]=f.fleet_name;});}fleetJobs=fjs.map(function(w){var jd=new Date(w.scheduled_start),ts=new Date(today.getFullYear(),today.getMonth(),today.getDate()),js=new Date(jd.getFullYear(),jd.getMonth(),jd.getDate()),off=Math.round((js-ts)/(1000*60*60*24));return{id:w.work_order_id,wo_number:w.wo_number,customer:fm[w.fleet_id]||'Fleet WO #'+w.wo_number,vehicle:(vm[w.vehicle_id]||w.summary||'Fleet Service').trim(),time:formatTimeFromTimestamp(w.scheduled_start),status:mapStatus(w.status),tech:w.assigned_employee_id||'unassigned',amount:formatAmount(w.grand_total),date:off,fleet:true,priority:w.priority};});}}catch(e){}}
async function loadSalesJobs(){var today=new Date(),startDate=new Date(today),endDate=new Date(today);startDate.setDate(startDate.getDate()-7);endDate.setDate(endDate.getDate()+60);try{var r=await sb.from('sales_appointments').select('*').eq('tenant_id',tenantId).gte('appointment_date',startDate.toISOString().split('T')[0]).lte('appointment_date',endDate.toISOString().split('T')[0]).order('appointment_date',{ascending:true});if(r.error)return;if(r.data&&r.data.length>0){salesJobs=r.data.map(function(a){var ad=new Date(a.appointment_date+'T00:00:00'),ts=new Date(today.getFullYear(),today.getMonth(),today.getDate()),off=Math.round((ad-ts)/(1000*60*60*24));var tid='unassigned';if(a.assigned_to){var f=salespeople.find(function(sp){return sp.name===a.assigned_to||sp.id===a.assigned_to;});if(f)tid=f.id;}return{id:a.appointment_id,customer:a.customer_name||'Unknown',vehicle:a.vehicle_interest||'General Inquiry',time:formatTime(a.appointment_time),status:mapStatus(a.status),tech:tid,amount:'',date:off,fleet:false,type:a.appointment_type||'Consultation'};});}}catch(e){}}
function formatTimeFromTimestamp(ts){if(!ts)return'TBD';try{var d=new Date(ts),h=d.getHours(),m=d.getMinutes().toString().padStart(2,'0'),ap=h>=12?'PM':'AM';h=h%12||12;return h+':'+m+' '+ap;}catch(e){return'TBD';}}
function getColorForIndex(i){var c=['','green','orange','purple','','green','orange'];return c[i%c.length];}
function formatTime(ts){if(!ts)return'TBD';try{var p=ts.split(':'),h=parseInt(p[0]),m=p[1]||'00',ap=h>=12?'PM':'AM';h=h%12||12;return h+':'+m+' '+ap;}catch(e){return ts;}}
function formatAmount(a){if(!a&&a!==0)return'TBD';var n=parseFloat(a);if(isNaN(n))return'TBD';return'$'+n.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});}
function mapStatus(s){if(!s)return'scheduled';var l=s.toLowerCase();if(l==='in_progress'||l==='in progress'||l==='active')return'in_progress';if(l==='parts_on_order'||l==='waiting'||l==='waiting for parts'||l==='parts')return'waiting';if(l==='completed'||l==='complete'||l==='done'||l==='invoiced')return'completed';if(l==='urgent'||l==='priority'||l==='rush')return'urgent';if(l==='confirmed')return'confirmed';return'scheduled';}
function openQuickWOModal(){woSelectedCustomer=null;woSelectedVehicle=null;woIsNewCustomer=false;woIsNewVehicle=false;lastCreatedCustomerId=null;document.getElementById('woCustomerSearch').value='';document.getElementById('woVehicleSearch').value='';document.getElementById('woDescription').value='';document.getElementById('woTechnician').value='';document.getElementById('woCustomerSelected').style.display='none';document.getElementById('woCustomerSearchContainer').style.display='block';document.getElementById('woNewCustomerFields').style.display='none';document.getElementById('woVehicleSelected').style.display='none';document.getElementById('woVehicleSearchContainer').style.display='block';document.getElementById('woNewVehicleFields').style.display='none';var td=new Date();td.setDate(td.getDate()+selectedDate);document.getElementById('woDate').value=td.toISOString().split('T')[0];document.getElementById('quickWOModal').classList.add('active');}
function closeQuickWOModal(){document.getElementById('quickWOModal').classList.remove('active');}
function editWOCustomerProfile(){if(woSelectedCustomer&&woSelectedCustomer.customer_id){window.location.href='customer-profile.html?id='+woSelectedCustomer.customer_id;}else{showToast('Select a customer first');}}
var woSearchTimeout=null;
function searchWOCustomers(q){clearTimeout(woSearchTimeout);var rd=document.getElementById('woCustomerResults');if(q.length<2){rd.classList.remove('show');return;}woSearchTimeout=setTimeout(function(){var ql=q.toLowerCase();var m=allCustomers.filter(function(c){return(c.full_name&&c.full_name.toLowerCase().includes(ql))||(c.phone&&c.phone.includes(q));}).slice(0,5);var h='';m.forEach(function(c){h+='<div class="search-result-item" onclick="selectWOCustomer(\''+c.customer_id+'\')"><div class="search-result-name">'+(c.full_name||'Unknown')+'</div><div class="search-result-sub">'+(c.phone||'No phone')+'</div></div>';});h+='<div class="search-result-item" onclick="showNewCustomerFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Customer</div></div>';rd.innerHTML=h;rd.classList.add('show');},200);}
function selectWOCustomer(cid){var c=allCustomers.find(function(x){return x.customer_id===cid;});if(!c)return;woSelectedCustomer=c;woIsNewCustomer=false;document.getElementById('woCustomerResults').classList.remove('show');document.getElementById('woCustomerSearchContainer').style.display='none';document.getElementById('woNewCustomerFields').style.display='none';document.getElementById('woCustomerSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+(c.full_name||'Unknown')+'</div><div class="selected-chip-sub">'+(c.phone||'No phone')+'</div></div><button class="selected-chip-remove" onclick="clearWOCustomer()">&times;</button></div>';document.getElementById('woCustomerSelected').style.display='block';loadVehiclesForCustomer(cid);}
function clearWOCustomer(){woSelectedCustomer=null;woIsNewCustomer=false;document.getElementById('woCustomerSelected').style.display='none';document.getElementById('woCustomerSearchContainer').style.display='block';document.getElementById('woCustomerSearch').value='';clearWOVehicle();}
function showNewCustomerFields(){woIsNewCustomer=true;woSelectedCustomer=null;document.getElementById('woCustomerResults').classList.remove('show');document.getElementById('woCustomerSearchContainer').style.display='none';document.getElementById('woNewCustomerFields').style.display='block';var sq=document.getElementById('woCustomerSearch').value.trim().split(' ');if(sq.length>=2){document.getElementById('woNewFirstName').value=sq[0];document.getElementById('woNewLastName').value=sq.slice(1).join(' ');}else if(sq.length===1){document.getElementById('woNewFirstName').value=sq[0];}document.getElementById('woNewFirstName').focus();}
function loadVehiclesForCustomer(cid){var cv=allVehicles.filter(function(v){return v.customer_id===cid;});if(cv.length===1){selectWOVehicle(cv[0].vehicle_id);}else if(cv.length>1){var rd=document.getElementById('woVehicleResults'),h='';cv.forEach(function(v){var vl=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');h+='<div class="search-result-item" onclick="selectWOVehicle(\''+v.vehicle_id+'\')"><div class="search-result-name">'+vl.trim()+'</div><div class="search-result-sub">'+(v.license_plate||v.vin||'')+'</div></div>';});h+='<div class="search-result-item" onclick="showNewVehicleFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Vehicle</div></div>';rd.innerHTML=h;rd.classList.add('show');}}
var woVehSearchTimeout=null;
function searchWOVehicles(q){clearTimeout(woVehSearchTimeout);var rd=document.getElementById('woVehicleResults');if(q.length<2){rd.classList.remove('show');return;}woVehSearchTimeout=setTimeout(function(){var ql=q.toLowerCase();var m=allVehicles.filter(function(v){var l=((v.year||'')+' '+(v.make||'')+' '+(v.model||'')).toLowerCase();return l.includes(ql)||(v.vin&&v.vin.toLowerCase().includes(ql))||(v.license_plate&&v.license_plate.toLowerCase().includes(ql));}).slice(0,5);var h='';m.forEach(function(v){var vl=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');h+='<div class="search-result-item" onclick="selectWOVehicle(\''+v.vehicle_id+'\')"><div class="search-result-name">'+vl.trim()+'</div><div class="search-result-sub">'+(v.license_plate||v.vin||'')+'</div></div>';});h+='<div class="search-result-item" onclick="showNewVehicleFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Vehicle</div></div>';rd.innerHTML=h;rd.classList.add('show');},200);}
function selectWOVehicle(vid){var v=allVehicles.find(function(x){return x.vehicle_id===vid;});if(!v)return;woSelectedVehicle=v;woIsNewVehicle=false;document.getElementById('woVehicleResults').classList.remove('show');document.getElementById('woVehicleSearchContainer').style.display='none';document.getElementById('woNewVehicleFields').style.display='none';var vl=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');document.getElementById('woVehicleSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+vl.trim()+'</div><div class="selected-chip-sub">'+(v.license_plate||v.vin||'')+'</div></div><button class="selected-chip-remove" onclick="clearWOVehicle()">&times;</button></div>';document.getElementById('woVehicleSelected').style.display='block';}
function clearWOVehicle(){woSelectedVehicle=null;woIsNewVehicle=false;document.getElementById('woVehicleSelected').style.display='none';document.getElementById('woVehicleSearchContainer').style.display='block';document.getElementById('woVehicleSearch').value='';document.getElementById('woNewVehicleFields').style.display='none';}
function showNewVehicleFields(){woIsNewVehicle=true;woSelectedVehicle=null;document.getElementById('woVehicleResults').classList.remove('show');document.getElementById('woVehicleSearchContainer').style.display='none';document.getElementById('woNewVehicleFields').style.display='block';var sq=document.getElementById('woVehicleSearch').value.trim().split(' ');if(sq.length>=1&&/^\d{4}$/.test(sq[0])){document.getElementById('woNewVehYear').value=sq[0];if(sq.length>=2)document.getElementById('woNewVehMake').value=sq[1];if(sq.length>=3)document.getElementById('woNewVehModel').value=sq.slice(2).join(' ');}document.getElementById('woNewVehYear').focus();}
async function createQuickWorkOrder(){var cid=null,vid=null;if(woIsNewCustomer){var fn=document.getElementById('woNewFirstName').value.trim(),ln=document.getElementById('woNewLastName').value.trim(),ph=document.getElementById('woNewPhone').value.trim();if(!fn||!ln||!ph){showToast('Please fill in customer name and phone');return;}try{var cr=await sb.from('customers').insert({tenant_id:tenantId,full_name:fn+' '+ln,first_name:fn,last_name:ln,phone:ph,created_at:new Date().toISOString()}).select().single();if(cr.error)throw cr.error;cid=cr.data.customer_id;lastCreatedCustomerId=cid;}catch(e){showToast('Error creating customer');return;}}else if(woSelectedCustomer){cid=woSelectedCustomer.customer_id;}else{showToast('Please select or add a customer');return;}if(woIsNewVehicle){var y=document.getElementById('woNewVehYear').value.trim(),mk=document.getElementById('woNewVehMake').value.trim(),md=document.getElementById('woNewVehModel').value.trim();if(!y&&!mk&&!md){showToast('Please enter vehicle information');return;}try{var vr=await sb.from('vehicles').insert({tenant_id:tenantId,customer_id:cid,year:y||null,make:mk||null,model:md||null,created_at:new Date().toISOString()}).select().single();if(vr.error)throw vr.error;vid=vr.data.vehicle_id;}catch(e){showToast('Error creating vehicle');return;}}else if(woSelectedVehicle){vid=woSelectedVehicle.vehicle_id;}else{showToast('Please select or add a vehicle');return;}document.getElementById('woCreateText').style.display='none';document.getElementById('woCreateLoading').style.display='inline-block';document.getElementById('woCreateBtn').disabled=true;try{var wnr=await sb.from('work_orders').select('wo_number').eq('tenant_id',tenantId).order('wo_number',{ascending:false}).limit(1);var nwn=1001;if(wnr.data&&wnr.data.length>0&&wnr.data[0].wo_number)nwn=parseInt(wnr.data[0].wo_number)+1;var sd=document.getElementById('woDate').value,st=document.getElementById('woTime').value||'09:00',ss=new Date(sd+'T'+st+':00');var tid=document.getElementById('woTechnician').value||null,desc=document.getElementById('woDescription').value.trim();var wor=await sb.from('work_orders').insert({tenant_id:tenantId,wo_number:nwn,customer_id:cid,vehicle_id:vid,summary:desc||'Service',status:'scheduled',scheduled_start:ss.toISOString(),assigned_employee_id:tid,created_at:new Date().toISOString(),deleted:false}).select().single();if(wor.error)throw wor.error;closeQuickWOModal();showToast('Work Order #'+nwn+' created!');setTimeout(function(){window.location.href='work-order-edit.html?id='+wor.data.work_order_id;},500);}catch(e){showToast('Error creating work order');document.getElementById('woCreateText').style.display='inline';document.getElementById('woCreateLoading').style.display='none';document.getElementById('woCreateBtn').disabled=false;}}
var apptCreatedCustomerId=null;
var editingAppointmentId=null;
var apptSelectedCustomer=null;
var apptIsNewCustomer=false;
function openQuickApptModal(){
  editingAppointmentId=null;
  apptCreatedCustomerId=null;
  apptSelectedCustomer=null;
  apptIsNewCustomer=false;
  document.querySelector('#quickApptModal .modal-title').textContent='Quick Appointment';
  document.getElementById('apptNewCustomerBtn').style.display='inline-block';
  // Reset customer search
  document.getElementById('apptCustomerSelected').style.display='none';
  document.getElementById('apptCustomerSearchContainer').style.display='block';
  document.getElementById('apptCustomerSearch').value='';
  document.getElementById('apptNewCustomerFields').style.display='none';
  document.getElementById('apptCustomerName').value='';
  document.getElementById('apptOrganization').value='';
  document.getElementById('apptPhone').value='';
  // Reset other fields
  document.getElementById('apptType').selectedIndex=0;
  document.getElementById('apptVehicleInterest').value='';
  document.getElementById('apptSalesperson').value='';
  document.getElementById('apptNotes').value='';
  var td=new Date();
  td.setDate(td.getDate()+selectedDate);
  document.getElementById('apptDate').value=td.toISOString().split('T')[0];
  document.getElementById('apptTime').value='10:00';
  // Show create footer, hide edit footer
  document.getElementById('apptFooterButtons').style.display='grid';
  document.getElementById('apptEditFooterButtons').style.display='none';
  document.getElementById('quickApptModal').classList.add('active');
}
var apptSearchTimeout=null;
function searchApptCustomers(q){
  clearTimeout(apptSearchTimeout);
  var rd=document.getElementById('apptCustomerResults');
  if(q.length<2){rd.classList.remove('show');return;}
  apptSearchTimeout=setTimeout(function(){
    var ql=q.toLowerCase();
    var m=allCustomers.filter(function(c){
      return(c.full_name&&c.full_name.toLowerCase().includes(ql))||(c.phone&&c.phone.includes(q));
    }).slice(0,5);
    var h='';
    m.forEach(function(c){
      h+='<div class="search-result-item" onclick="selectApptCustomer(\''+c.customer_id+'\')"><div class="search-result-name">'+(c.full_name||'Unknown')+'</div><div class="search-result-sub">'+(c.phone||'No phone')+'</div></div>';
    });
    h+='<div class="search-result-item" onclick="showNewApptCustomerFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Customer</div></div>';
    rd.innerHTML=h;
    rd.classList.add('show');
  },200);
}
function selectApptCustomer(cid){
  var c=allCustomers.find(function(x){return x.customer_id===cid;});
  if(!c)return;
  apptSelectedCustomer=c;
  apptIsNewCustomer=false;
  document.getElementById('apptCustomerResults').classList.remove('show');
  document.getElementById('apptCustomerSearchContainer').style.display='none';
  document.getElementById('apptNewCustomerFields').style.display='none';
  document.getElementById('apptNewCustomerBtn').style.display='none';
  document.getElementById('apptCustomerSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+(c.full_name||'Unknown')+'</div><div class="selected-chip-sub">'+(c.phone||'No phone')+'</div></div><button class="selected-chip-remove" onclick="clearApptCustomer()">&times;</button></div>';
  document.getElementById('apptCustomerSelected').style.display='block';
}
function clearApptCustomer(){
  apptSelectedCustomer=null;
  apptIsNewCustomer=false;
  document.getElementById('apptCustomerSelected').style.display='none';
  document.getElementById('apptCustomerSearchContainer').style.display='block';
  document.getElementById('apptCustomerSearch').value='';
  document.getElementById('apptNewCustomerFields').style.display='none';
  document.getElementById('apptNewCustomerBtn').style.display='inline-block';
}
function showNewApptCustomerFields(){
  apptIsNewCustomer=true;
  apptSelectedCustomer=null;
  document.getElementById('apptCustomerResults').classList.remove('show');
  document.getElementById('apptCustomerSearchContainer').style.display='none';
  document.getElementById('apptNewCustomerFields').style.display='block';
  document.getElementById('apptNewCustomerBtn').style.display='none';
  var sq=document.getElementById('apptCustomerSearch').value.trim().split(' ');
  if(sq.length>=1 && sq[0]){
    document.getElementById('apptCustomerName').value=document.getElementById('apptCustomerSearch').value.trim();
  }
  document.getElementById('apptCustomerName').focus();
}
async function editSalesAppointment(appointmentId){
  var r = await sb.from('sales_appointments').select('*').eq('appointment_id', appointmentId).single();
  if(r.error || !r.data){showToast('Could not load appointment');return;}
  var appt = r.data;
  editingAppointmentId = appointmentId;
  apptIsNewCustomer = false;
  apptSelectedCustomer = null;
  
  document.querySelector('#quickApptModal .modal-title').textContent='Edit Appointment';
  document.getElementById('apptNewCustomerBtn').style.display='none';
  
  // Try to find existing customer by phone or name
  var foundCustomer = null;
  if(appt.customer_phone){
    foundCustomer = allCustomers.find(function(c){ return c.phone === appt.customer_phone; });
  }
  if(!foundCustomer && appt.customer_name){
    foundCustomer = allCustomers.find(function(c){ return c.full_name && c.full_name.toLowerCase() === appt.customer_name.toLowerCase(); });
  }
  
  if(foundCustomer){
    // Customer exists - show selected chip
    apptSelectedCustomer = foundCustomer;
    document.getElementById('apptCustomerSearchContainer').style.display='none';
    document.getElementById('apptNewCustomerFields').style.display='none';
    document.getElementById('apptCustomerSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+(foundCustomer.full_name||'Unknown')+'</div><div class="selected-chip-sub">'+(foundCustomer.phone||'No phone')+'</div></div><button class="selected-chip-remove" onclick="clearApptCustomer()">&times;</button></div>';
    document.getElementById('apptCustomerSelected').style.display='block';
  } else {
    // No customer found - show as new with pre-filled data
    apptIsNewCustomer = true;
    document.getElementById('apptCustomerSelected').style.display='none';
    document.getElementById('apptCustomerSearchContainer').style.display='none';
    document.getElementById('apptNewCustomerFields').style.display='block';
    document.getElementById('apptCustomerName').value = appt.customer_name || '';
    document.getElementById('apptOrganization').value = appt.organization || '';
    document.getElementById('apptPhone').value = appt.customer_phone || '';
  }
  
  document.getElementById('apptDate').value = appt.appointment_date || '';
  document.getElementById('apptTime').value = appt.appointment_time || '10:00';
  // Set appointment type - try to match by name
  var typeSelect = document.getElementById('apptType');
  var typeValue = appt.appointment_type || '';
  typeSelect.value = typeValue;
  // If exact match failed, try case-insensitive
  if(typeSelect.value !== typeValue){
    for(var i=0; i<typeSelect.options.length; i++){
      if(typeSelect.options[i].value.toLowerCase() === typeValue.toLowerCase()){
        typeSelect.selectedIndex = i;
        break;
      }
    }
  }
  document.getElementById('apptVehicleInterest').value = appt.vehicle_interest || '';
  document.getElementById('apptNotes').value = appt.notes || '';
  var spSelect = document.getElementById('apptSalesperson');
  spSelect.value = '';
  if(appt.assigned_to){
    for(var i=0; i<spSelect.options.length; i++){
      var sp = salespeople.find(function(s){ return s.name === appt.assigned_to; });
      if(sp) spSelect.value = sp.id;
    }
  }
  // Show edit footer, hide create footer
  document.getElementById('apptFooterButtons').style.display='none';
  document.getElementById('apptEditFooterButtons').style.display='grid';
  document.getElementById('quickApptModal').classList.add('active');
}
function closeQuickApptModal(){
  document.getElementById('quickApptModal').classList.remove('active');
  // Reset create button state
  document.getElementById('apptCreateText').style.display='inline';
  document.getElementById('apptCreateLoading').style.display='none';
  document.getElementById('apptCreateBtn').disabled=false;
  // Reset edit button state
  document.getElementById('apptSaveText').style.display='inline';
  document.getElementById('apptSaveLoading').style.display='none';
  document.getElementById('apptSaveBtn').disabled=false;
  // Reset footer buttons
  document.getElementById('apptFooterButtons').style.display='grid';
  document.getElementById('apptEditFooterButtons').style.display='none';
  // Reset customer state
  apptSelectedCustomer=null;
  apptIsNewCustomer=false;
  editingAppointmentId=null;
}
async function deleteAppointment(){
  if(!editingAppointmentId){showToast('No appointment selected');return;}
  if(!confirm('Delete this appointment?\n\nThis will NOT delete the customer.')){return;}
  try{
    var r = await sb.from('sales_appointments').delete().eq('appointment_id', editingAppointmentId);
    if(r.error) throw r.error;
    closeQuickApptModal();
    showToast('Appointment deleted');
    await loadSalesJobs();
    renderAll();
  }catch(e){
    showToast('Error deleting appointment');
    console.error(e);
  }
}
async function editApptCustomerProfile(){
  // If we have a selected customer, go directly to their profile
  if(apptSelectedCustomer && apptSelectedCustomer.customer_id){
    window.location.href='customer-profile.html?id='+apptSelectedCustomer.customer_id;
    return;
  }
  // Otherwise check new customer fields
  var cn=document.getElementById('apptCustomerName').value.trim();
  var ph=document.getElementById('apptPhone').value.trim();
  var org=document.getElementById('apptOrganization').value.trim();
  if(!cn&&!ph){showToast('Select or enter a customer first');return;}
  // Try to find existing customer
  var existingCustomer=null;
  if(ph){var r=await sb.from('customers').select('customer_id').eq('tenant_id',tenantId).eq('phone',ph).limit(1);if(r.data&&r.data.length>0)existingCustomer=r.data[0];}
  if(!existingCustomer&&cn){var r=await sb.from('customers').select('customer_id').eq('tenant_id',tenantId).ilike('full_name',cn).limit(1);if(r.data&&r.data.length>0)existingCustomer=r.data[0];}
  if(existingCustomer){
    window.location.href='customer-profile.html?id='+existingCustomer.customer_id;
  }else{
    // Create new customer then go to profile
    var names=cn.split(' ');var fn=names[0]||'';var ln=names.slice(1).join(' ')||'';
    try{
      var cr=await sb.from('customers').insert({tenant_id:tenantId,full_name:cn,first_name:fn,last_name:ln,phone:ph||null,organization_name:org||null,customer_type:'sales',created_at:new Date().toISOString()}).select().single();
      if(cr.error)throw cr.error;
      window.location.href='customer-profile.html?id='+cr.data.customer_id;
    }catch(e){showToast('Error creating customer');}
  }
}
async function createQuickAppointment(){
  var cn, org, ph, customerId = null;
  
  // Get customer info from selected customer or new customer fields
  if(apptSelectedCustomer){
    cn = apptSelectedCustomer.full_name || '';
    ph = apptSelectedCustomer.phone || '';
    org = '';
    customerId = apptSelectedCustomer.customer_id;
  } else if(apptIsNewCustomer){
    cn = document.getElementById('apptCustomerName').value.trim();
    org = document.getElementById('apptOrganization').value.trim();
    ph = document.getElementById('apptPhone').value.trim();
  } else {
    showToast('Please select or add a customer');
    return;
  }
  
  var ad=document.getElementById('apptDate').value,
      at=document.getElementById('apptTime').value;
  var isEditing = !!editingAppointmentId;
  
  if(!cn){showToast('Please enter customer name');return;}
  if(!ph){showToast('Please enter phone number');return;}
  if(!ad){showToast('Please select a date');return;}
  if(!at){showToast('Please select a time');return;}
  
  // Handle loading state for both create and edit buttons
  if(isEditing){
    document.getElementById('apptSaveText').style.display='none';
    document.getElementById('apptSaveLoading').style.display='inline-block';
    document.getElementById('apptSaveBtn').disabled=true;
  } else {
    document.getElementById('apptCreateText').style.display='none';
    document.getElementById('apptCreateLoading').style.display='inline-block';
    document.getElementById('apptCreateBtn').disabled=true;
  }
  
  try{
    // If new customer, create customer record first
    if(apptIsNewCustomer && !customerId){
      var names = cn.split(' ');
      var firstName = names[0] || '';
      var lastName = names.slice(1).join(' ') || '';
      
      var customerData = {
        tenant_id: tenantId,
        full_name: cn,
        first_name: firstName,
        last_name: lastName,
        phone: ph || null,
        organization_name: org || null,
        customer_type: 'sales',
        created_at: new Date().toISOString()
      };
      
      var cr = await sb.from('customers').insert(customerData).select().single();
      if(cr.error) throw cr.error;
      customerId = cr.data.customer_id;
      
      // Add to local cache so search finds them immediately
      allCustomers.push({
        customer_id: customerId,
        full_name: cn,
        phone: ph
      });
      
      console.log('Created new customer:', customerId, cn);
    }
    
    var apt=document.getElementById('apptType').value,
        vi=document.getElementById('apptVehicleInterest').value.trim(),
        spid=document.getElementById('apptSalesperson').value,
        nt=document.getElementById('apptNotes').value.trim();
    var ato=null;
    if(spid){var sp=salespeople.find(function(s){return s.id===spid;});if(sp)ato=sp.name;}
    
    var appointmentData = {
      customer_name: cn,
      organization: org || null,
      customer_phone: ph,
      customer_id: customerId,
      appointment_date: ad,
      appointment_time: at,
      appointment_type: apt,
      vehicle_interest: vi || null,
      assigned_to: ato,
      notes: nt || null,
      updated_at: new Date().toISOString()
    };
    
    var ar;
    if(isEditing){
      ar = await sb.from('sales_appointments').update(appointmentData).eq('appointment_id', editingAppointmentId).select().single();
    } else {
      appointmentData.tenant_id = tenantId;
      appointmentData.status = 'confirmed';
      appointmentData.created_at = new Date().toISOString();
      ar = await sb.from('sales_appointments').insert(appointmentData).select().single();
    }
    if(ar.error) throw ar.error;
    closeQuickApptModal();
    showToast(isEditing ? 'Appointment updated!' : 'Appointment created!');
    await loadSalesJobs();
    renderAll();
  } catch(e) {
    showToast('Error: ' + (e.message || 'Failed to save appointment'));
    if(isEditing){
      document.getElementById('apptSaveText').style.display='inline';
      document.getElementById('apptSaveLoading').style.display='none';
      document.getElementById('apptSaveBtn').disabled=false;
    } else {
      document.getElementById('apptCreateText').style.display='inline';
      document.getElementById('apptCreateLoading').style.display='none';
      document.getElementById('apptCreateBtn').disabled=false;
    }
  }
}
document.addEventListener('click',function(e){if(!e.target.closest('.search-container'))document.querySelectorAll('.search-results').forEach(function(el){el.classList.remove('show');});});
document.addEventListener('dragover', function(e){
  if(!draggedJobId) return;
  var y = e.clientY;
  var vh = window.innerHeight;
  var scrollZone = 100;
  if(y < scrollZone){startAutoScroll('up');} else if(y > vh - scrollZone){startAutoScroll('down');} else {stopAutoScroll();}
});
document.addEventListener('dragend', function(){ stopAutoScroll(); });
function setViewStyle(s){currentViewStyle=s;document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('style'+s.charAt(0).toUpperCase()+s.slice(1)).classList.add('active');localStorage.setItem('scheduler-view-style',s);renderAll();showToast(s.charAt(0).toUpperCase()+s.slice(1)+' view');}
function switchTab(t){currentTab=t;document.querySelectorAll('.main-tab').forEach(function(b){b.classList.remove('active');});document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');currentFilter='all';renderAll();}
function toggleExpandPreference(){lanesExpanded=!lanesExpanded;localStorage.setItem('lanes-expanded',lanesExpanded?'true':'false');renderLanesControls();renderPages();}
function renderLanesControls(){var jobs=getJobsForDateOffset(selectedDate),all=jobs.length,waiting=jobs.filter(function(j){return j.status==='waiting';}).length,done=jobs.filter(function(j){return j.status==='completed';}).length;var ei=lanesExpanded?'▼':'☐',ec=lanesExpanded?' expanded':'';var h='<button class="lanes-today-btn" onclick="goToToday()">Today</button>';h+='<button class="lanes-filter-btn '+(currentFilter==='all'?'active':'')+'" onclick="setFilter(\'all\')">All <span class="count">'+all+'</span></button>';h+='<button class="lanes-filter-btn '+(currentFilter==='waiting'?'active':'')+'" onclick="setFilter(\'waiting\')">Waiting <span class="count">'+waiting+'</span></button>';h+='<button class="lanes-filter-btn '+(currentFilter==='completed'?'active':'')+'" onclick="setFilter(\'completed\')">Done <span class="count">'+done+'</span></button>';h+='<button class="expand-toggle-btn'+ec+'" onclick="toggleExpandPreference()">'+ei+'</button>';document.getElementById('lanesControlsRow').innerHTML=h;}
function goToToday(){if(selectedDate===0){centerOnToday();return;}selectedDate=0;renderAll();showToast('Today');setTimeout(centerOnToday,100);}
function centerOnToday(){var c=document.getElementById('lanesDateChips'),tc=document.getElementById('today-chip');if(tc&&c){var cw=c.offsetWidth,cl=tc.offsetLeft,chw=tc.offsetWidth;c.scrollLeft=cl-(cw/2)+(chw/2);}}
function renderLanesDateChips(){var c=document.getElementById('lanesDateChips'),days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],today=new Date(),so=-60,eo=120,mg={},mo=[];for(var i=so;i<eo;i++){var d=new Date(today);d.setDate(d.getDate()+i);var mk=d.getFullYear()+'-'+d.getMonth();if(!mg[mk]){mg[mk]={month:d.getMonth(),year:d.getFullYear(),label:months[d.getMonth()],days:[]};mo.push(mk);}mg[mk].days.push({offset:i,date:d,dayName:days[d.getDay()],dayNum:d.getDate(),isToday:i===0});}var h='',mi=0;for(var k=0;k<mo.length;k++){var key=mo[k],g=mg[key],eo=mi%2===0?'even':'odd';h+='<div class="month-section '+eo+'"><div class="month-label">'+g.label+'</div><div class="month-days">';for(var j=0;j<g.days.length;j++){var day=g.days[j],jc=getJobsForDateOffset(day.offset).length,ia=day.offset===selectedDate,cls='lanes-date-chip';if(ia)cls+=' active';if(day.isToday)cls+=' today';var ida=day.isToday?' id="today-chip"':'';h+='<button class="'+cls+'"'+ida+' data-offset="'+day.offset+'" onclick="selectDate('+day.offset+')"><span class="day-name">'+day.dayName+'</span><span class="day-num">'+day.dayNum+'</span>';if(jc>0)h+='<span class="job-count">'+jc+'</span>';h+='</button>';}h+='</div></div>';mi++;}c.innerHTML=h;}
function selectDate(o){if(o===selectedDate||isAnimating)return;selectedDate=o;renderAll();showToast(getDateLabel(selectedDate));}
function setFilter(f){currentFilter=f;renderLanesControls();renderPages();}
function getDateLabel(o){if(o===0)return'Today';if(o===1)return'Tomorrow';if(o===-1)return'Yesterday';var d=new Date();d.setDate(d.getDate()+o);return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});}
function getJobsForDateOffset(o){var jobs=[];if(currentTab==='service')jobs=serviceJobs.filter(function(j){return j.date===o;});else if(currentTab==='fleet')jobs=fleetJobs.filter(function(j){return j.date===o;});else if(currentTab==='sales')jobs=salesJobs.filter(function(j){return j.date===o;});return jobs;}
function getCurrentStaff(){return currentTab==='sales'?salespeople:technicians;}
function getTechById(id){var st=getCurrentStaff();for(var i=0;i<st.length;i++)if(st[i].id===id)return st[i];return{id:id,name:id,initials:'?',color:'purple',role:''};}
var statusLabels={'in_progress':'Active','waiting':'Parts','completed':'Done','urgent':'Urgent','scheduled':'Scheduled','confirmed':'Confirmed'};
function toggleLane(tid,dof){var l=document.getElementById('lane-'+tid+'-'+dof);if(l)l.classList.toggle('expanded');}
var draggedJobId = null;
var autoScrollInterval = null;
function onDragStart(e, jobId){draggedJobId = jobId;e.target.classList.add('dragging');e.dataTransfer.effectAllowed = 'move';}
function onDragEnd(e){e.target.classList.remove('dragging');draggedJobId = null;document.querySelectorAll('.tech-lane').forEach(function(l){ l.classList.remove('drop-target'); });stopAutoScroll();}
function startAutoScroll(direction){if(autoScrollInterval) return;var speed = direction === 'up' ? -10 : 10;autoScrollInterval = setInterval(function(){window.scrollBy(0, speed);}, 16);}
function stopAutoScroll(){if(autoScrollInterval){clearInterval(autoScrollInterval);autoScrollInterval = null;}}
function onDragOver(e){e.preventDefault();e.currentTarget.classList.add('drop-target');}
function onDragLeave(e){e.currentTarget.classList.remove('drop-target');}
async function onDrop(e, techId){
  e.preventDefault();
  e.currentTarget.classList.remove('drop-target');
  if(!draggedJobId) return;
  var job = null;
  if(currentTab === 'sales'){
    job = salesJobs.find(function(j){ return j.id === draggedJobId; });
    if(job){
      var assignedName = null;
      if(techId !== 'unassigned'){var sp = salespeople.find(function(s){ return s.id === techId; });if(sp) assignedName = sp.name;}
      var r = await sb.from('sales_appointments').update({ assigned_to: assignedName, updated_at: new Date().toISOString() }).eq('appointment_id', draggedJobId);
      if(r.error){ showToast('Error assigning'); return; }
      showToast('Assigned to ' + (assignedName || 'Unassigned'));
    }
  } else {
    job = serviceJobs.find(function(j){ return j.id === draggedJobId; }) || fleetJobs.find(function(j){ return j.id === draggedJobId; });
    if(job){
      var empId = techId === 'unassigned' ? null : techId;
      var r = await sb.from('work_orders').update({ assigned_employee_id: empId, updated_at: new Date().toISOString() }).eq('work_order_id', draggedJobId);
      if(r.error){ showToast('Error assigning'); return; }
      var techName = techId === 'unassigned' ? 'Unassigned' : technicians.find(function(t){ return t.id === techId; })?.name || 'Tech';
      showToast('Assigned to ' + techName);
    }
  }
  if(currentTab === 'sales'){ await loadSalesJobs(); } else { await loadServiceJobs(); }
  renderAll();
}
function renderLanesView(dof){
  var jobs = getJobsForDateOffset(dof);
  if(currentFilter !== 'all') jobs = jobs.filter(function(j){ return j.status === currentFilter; });
  var staff = getCurrentStaff();
  var staffSorted = staff.slice().map(function(p){
    var jobCount = jobs.filter(function(j){ return j.tech === p.id; }).length;
    return { person: p, jobCount: jobCount };
  }).sort(function(a, b){
    if(a.jobCount > 0 && b.jobCount > 0) return b.jobCount - a.jobCount;
    if(a.jobCount > 0 && b.jobCount === 0) return -1;
    if(a.jobCount === 0 && b.jobCount > 0) return 1;
    return 0;
  });
  if(staffSorted.length === 0) return '<div class="empty-state"><div class="empty-state-text">No staff available</div></div>';
  var h = '<div class="lanes-container">';
  staffSorted.forEach(function(item){
    var p = item.person;
    var pj = jobs.filter(function(j){ return j.tech === p.id; });
    var hrs = (pj.length * 1.5).toFixed(1);
    var ec = lanesExpanded ? ' expanded' : '';
    var hasJobs = pj.length > 0;
    var laneStyle = hasJobs ? '' : ' style="opacity:0.25;"';
    h += '<div class="tech-lane' + ec + '" id="lane-' + p.id + '-' + dof + '" data-tech="' + p.id + '" data-date="' + dof + '"' + laneStyle + ' ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event,\'' + p.id + '\')">';
    h += '<div class="lane-header" onclick="toggleLane(\'' + p.id + '\',' + dof + ')"><div class="lane-info"><div class="tech-avatar ' + p.color + '">' + p.initials + '</div><div class="tech-details"><h3>' + p.name + '</h3><span>' + p.role + '</span></div></div><div class="lane-header-right"><div class="lane-stats"><div class="stat-item"><div class="stat-value">' + pj.length + '</div><div class="stat-label">Jobs</div></div><div class="stat-item"><div class="stat-value">' + hrs + 'h</div><div class="stat-label">Booked</div></div></div><span class="lane-expand-icon">▼</span></div></div>';
    h += '<div class="lane-cards-wrapper"><div class="lane-cards">';
    pj.forEach(function(j){
      var detailsBtn = currentTab === 'sales' 
        ? '<button class="card-details-btn" onclick="event.stopPropagation();editSalesAppointment(\'' + j.id + '\')">Details</button>' 
        : '<button class="card-details-btn" onclick="event.stopPropagation();window.location.href=\'work-order-edit.html?id=' + j.id + '\'">Details</button>';
      h += '<div class="wo-card status-' + j.status + (j.fleet ? ' fleet' : '') + '" data-job-id="' + j.id + '" draggable="true" ondragstart="onDragStart(event,\'' + j.id + '\')" ondragend="onDragEnd(event)">';
      h += '<div class="card-time">' + j.time + '</div>';
      h += '<div class="card-customer">' + j.customer + '</div>';
      h += '<div class="card-info-row"><span class="card-vehicle">' + j.vehicle + '</span><span class="card-dot"></span><span class="card-status ' + j.status + '">' + (statusLabels[j.status] || j.status) + '</span><span class="card-amount">' + j.amount + '</span></div>';
      h += detailsBtn;
      h += '</div>';
    });
    var al = currentTab === 'sales' ? 'Appt' : 'Add';
    h += '<div class="add-card" onclick="event.stopPropagation();' + (currentTab === 'sales' ? 'openQuickApptModal()' : 'openQuickWOModal()') + '"><div class="add-card-icon">+</div><span>' + al + '</span></div>';
    h += '</div></div></div>';
  });
  h += '</div>';
  return h;
}
function renderStackView(dof){
  var jobs = getJobsForDateOffset(dof);
  if(currentFilter !== 'all') jobs = jobs.filter(function(j){ return j.status === currentFilter; });
  if(jobs.length === 0) return '<div class="empty-state"><div class="empty-state-text">No jobs for ' + getDateLabel(dof) + '</div></div>';
  jobs.sort(function(a,b){ return a.time.localeCompare(b.time); });
  var h = '<div class="stack-container">';
  jobs.forEach(function(j){
    var staff = getCurrentStaff();
    var assignee = staff.find(function(s){ return s.id === j.tech; });
    var assigneeName = assignee ? assignee.name : 'Unassigned';
    var assigneeInitials = assignee ? assignee.initials : '?';
    var assigneeColor = assignee ? assignee.color : 'purple';
    var detailsBtn = currentTab === 'sales' 
      ? '<button class="card-details-btn" onclick="event.stopPropagation();editSalesAppointment(\'' + j.id + '\')">Details</button>' 
      : '<button class="card-details-btn" onclick="event.stopPropagation();window.location.href=\'work-order-edit.html?id=' + j.id + '\'">Details</button>';
    h += '<div class="stack-card status-' + j.status + (j.fleet ? ' fleet' : '') + '" data-job-id="' + j.id + '">';
    h += '<div class="stack-card-left">';
    h += '<div class="stack-time">' + j.time + '</div>';
    h += '<div class="stack-customer">' + j.customer + '</div>';
    h += '<div class="stack-vehicle">' + j.vehicle + '</div>';
    h += '</div>';
    h += '<div class="stack-card-right">';
    h += '<div class="stack-assignee"><div class="tech-avatar small ' + assigneeColor + '">' + assigneeInitials + '</div><span>' + assigneeName + '</span></div>';
    h += '<span class="card-status ' + j.status + '">' + (statusLabels[j.status] || j.status) + '</span>';
    h += detailsBtn;
    h += '</div>';
    h += '</div>';
  });
  h += '</div>';
  return h;
}
function renderGridView(dof){
  var jobs = getJobsForDateOffset(dof);
  if(currentFilter !== 'all') jobs = jobs.filter(function(j){ return j.status === currentFilter; });
  if(jobs.length === 0) return '<div class="empty-state"><div class="empty-state-text">No jobs for ' + getDateLabel(dof) + '</div></div>';
  var h = '<div class="grid-container">';
  jobs.forEach(function(j){
    var staff = getCurrentStaff();
    var assignee = staff.find(function(s){ return s.id === j.tech; });
    var assigneeName = assignee ? assignee.name : 'Unassigned';
    var assigneeInitials = assignee ? assignee.initials : '?';
    var assigneeColor = assignee ? assignee.color : 'purple';
    var detailsBtn = currentTab === 'sales' 
      ? '<button class="card-details-btn" onclick="event.stopPropagation();editSalesAppointment(\'' + j.id + '\')">Details</button>' 
      : '<button class="card-details-btn" onclick="event.stopPropagation();window.location.href=\'work-order-edit.html?id=' + j.id + '\'">Details</button>';
    h += '<div class="grid-card status-' + j.status + (j.fleet ? ' fleet' : '') + '" data-job-id="' + j.id + '">';
    h += '<div class="grid-card-header">';
    h += '<span class="grid-time">' + j.time + '</span>';
    h += '<span class="card-status ' + j.status + '">' + (statusLabels[j.status] || j.status) + '</span>';
    h += '</div>';
    h += '<div class="grid-customer">' + j.customer + '</div>';
    h += '<div class="grid-vehicle">' + j.vehicle + '</div>';
    h += '<div class="grid-card-footer">';
    h += '<div class="grid-assignee"><div class="tech-avatar small ' + assigneeColor + '">' + assigneeInitials + '</div><span>' + assigneeName + '</span></div>';
    if(j.amount) h += '<span class="grid-amount">' + j.amount + '</span>';
    h += '</div>';
    h += detailsBtn;
    h += '</div>';
  });
  h += '</div>';
  return h;
}
function renderPages(){
  var content = '';
  if(currentViewStyle === 'stack'){content = renderStackView(selectedDate);} 
  else if(currentViewStyle === 'grid'){content = renderGridView(selectedDate);} 
  else {content = renderLanesView(selectedDate);}
  document.getElementById('currentPage').innerHTML = content;
  document.getElementById('prevPage').innerHTML = '';
  document.getElementById('nextPage').innerHTML = '';
}
function renderAll(){renderLanesControls();var dc=document.getElementById('lanesDateChips');dc.style.display='flex';renderLanesDateChips();renderPages();}
function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
async function init(){var s=await checkAuth();if(!s)return;await loadBusinessSettings();await loadAllData();var up=new URLSearchParams(window.location.search),tp=up.get('tab');if(tp&&['service','sales','fleet'].indexOf(tp)!==-1){currentTab=tp;document.querySelectorAll('.main-tab').forEach(function(b){b.classList.remove('active');});document.getElementById('tab'+tp.charAt(0).toUpperCase()+tp.slice(1)).classList.add('active');}document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('style'+currentViewStyle.charAt(0).toUpperCase()+currentViewStyle.slice(1)).classList.add('active');renderAll();requestAnimationFrame(function(){requestAnimationFrame(centerOnToday);});}
init();
</script>
</body>
</html>
