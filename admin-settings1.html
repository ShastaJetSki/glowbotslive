<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Platform Admin Console</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #111827;
      --bg-card: #1a2332;
      --border-color: #2a3441;
      --border-light: #3a4451;
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent-cyan: #22d3ee;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      --accent-purple: #a855f7;
      --accent-red: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
    }

    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

    .header { margin-bottom: 8px; }
    .header-title { font-size: 28px; font-weight: 700; }
    .header-subtitle { font-size: 14px; color: var(--accent-cyan); margin-top: 2px; }

    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 24px;
    }

    .nav-tabs { display: flex; gap: 24px; }

    .nav-tab {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      background: none;
      border: none;
      padding: 8px 0;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }

    .nav-tab:hover { color: var(--text-primary); }
    .nav-tab.active { color: var(--accent-cyan); }
    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: -17px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent-cyan);
    }

    .nav-actions { display: flex; gap: 10px; }

    .btn {
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      padding: 8px 16px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
      color: var(--text-primary);
    }

    .btn:hover { background: var(--bg-card); border-color: var(--text-secondary); }
    .btn-primary { border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .btn-primary:hover { background: rgba(34, 211, 238, 0.1); }
    .btn-success { border-color: var(--accent-green); color: var(--accent-green); }
    .btn-success:hover { background: rgba(34, 197, 94, 0.1); }
    .btn-danger { border-color: var(--accent-red); color: var(--accent-red); }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }
    .btn-sm { padding: 5px 10px; font-size: 12px; }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .kpi-grid { grid-template-columns: 1fr; } }

    .speedo-card {
      background: var(--bg-secondary);
      border: 1px dashed var(--border-color);
      border-radius: 8px;
      padding: 16px;
      transition: all 0.2s;
    }

    .speedo-card:hover { border-color: var(--accent-cyan); border-style: solid; }

    .speedo-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .speedo-label { font-size: 12px; font-weight: 500; color: var(--text-secondary); }
    .speedo-trend { font-size: 12px; font-weight: 600; }
    .speedo-trend.up { color: var(--accent-green); }
    .speedo-trend.down { color: var(--accent-orange); }

    .speedo-gauge { position: relative; width: 120px; height: 60px; margin: 0 auto 12px; }
    .speedo-gauge svg { width: 100%; height: 100%; overflow: visible; }
    .gauge-bg { fill: none; stroke: var(--bg-card); stroke-width: 6; stroke-linecap: round; }
    .gauge-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dasharray 1s ease; }
    .gauge-fill.cyan { stroke: var(--accent-cyan); }
    .gauge-fill.green { stroke: var(--accent-green); }
    .gauge-fill.orange { stroke: var(--accent-orange); }
    .gauge-fill.purple { stroke: var(--accent-purple); }

    .speedo-value { font-size: 28px; font-weight: 700; text-align: center; }
    .speedo-value.cyan { color: var(--accent-cyan); }
    .speedo-value.green { color: var(--accent-green); }
    .speedo-value.orange { color: var(--accent-orange); }
    .speedo-value.purple { color: var(--accent-purple); }

    .speedo-unit { font-size: 11px; color: var(--text-muted); text-align: center; }

    .speedo-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-muted);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .panel-title { font-size: 16px; font-weight: 600; }
    .panel-actions { display: flex; gap: 8px; }

    .info-box {
      background: rgba(34, 211, 238, 0.05);
      border: 1px solid rgba(34, 211, 238, 0.2);
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--accent-cyan);
    }

    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-label { font-size: 12px; font-weight: 500; color: var(--text-secondary); }

    .form-input, .form-select, .form-textarea {
      font-family: inherit;
      font-size: 14px;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-cyan); }
    .form-input::placeholder { color: var(--text-muted); }
    .form-textarea { resize: vertical; min-height: 80px; }

    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th {
      font-size: 12px;
      font-weight: 500;
      text-align: left;
      padding: 12px;
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
      vertical-align: middle;
    }

    .data-table tr:hover { background: rgba(255,255,255,0.02); }
    .data-table .actions { white-space: nowrap; }

    .badge { display: inline-block; font-size: 11px; font-weight: 500; padding: 4px 8px; border-radius: 4px; }
    .badge-cyan { background: rgba(34, 211, 238, 0.1); color: var(--accent-cyan); }
    .badge-green { background: rgba(34, 197, 94, 0.1); color: var(--accent-green); }
    .badge-orange { background: rgba(249, 115, 22, 0.1); color: var(--accent-orange); }
    .badge-purple { background: rgba(168, 85, 247, 0.1); color: var(--accent-purple); }
    .badge-red { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); }

    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .status-dot.active { background: var(--accent-green); }
    .status-dot.inactive { background: var(--text-muted); }
    .status-dot.trial { background: var(--accent-orange); }

    .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .checkbox-item:hover { border-color: var(--border-light); }
    .checkbox-item input { width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent-cyan); }
    .checkbox-item span { font-size: 13px; }

    .button-label-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; }
    .button-label-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }
    .button-label-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent-cyan); flex-shrink: 0; }
    .button-label-item .btn-id { font-size: 11px; color: var(--text-muted); width: 70px; flex-shrink: 0; }
    .button-label-item input[type="text"] {
      flex: 1;
      font-family: inherit;
      font-size: 13px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      min-width: 80px;
    }
    .button-label-item input[type="text"]:focus { border-color: var(--accent-cyan); outline: none; }
    .button-label-item input[type="text"]:disabled { opacity: 0.4; }

    .role-section {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .role-header { font-size: 14px; font-weight: 600; color: var(--accent-cyan); margin-bottom: 12px; }

    .button-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
    }
    .preview-btn {
      font-size: 12px;
      font-weight: 500;
      padding: 8px 14px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: transparent;
      color: var(--text-primary);
    }
    .preview-btn.primary { border-color: var(--accent-cyan); color: var(--accent-cyan); }

    .color-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .color-row label { font-size: 13px; color: var(--text-secondary); min-width: 120px; }
    .color-row input[type="color"] { width: 36px; height: 28px; border: none; border-radius: 4px; cursor: pointer; background: transparent; }
    .color-row input[type="text"] {
      flex: 1;
      font-family: monospace;
      font-size: 12px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      text-transform: uppercase;
    }

    .theme-preview-box {
      width: 100%;
      height: 100px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .theme-preview-header { height: 20px; display: flex; align-items: center; padding: 0 10px; gap: 6px; }
    .theme-preview-dot { width: 8px; height: 8px; border-radius: 50%; }
    .theme-preview-body { flex: 1; padding: 8px; display: flex; gap: 8px; }
    .theme-preview-sidebar { width: 25%; border-radius: 4px; }
    .theme-preview-content { flex: 1; border-radius: 4px; }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      background: var(--bg-secondary);
      z-index: 10;
    }
    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-close { background: transparent; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; line-height: 1; }
    .modal-close:hover { color: var(--accent-red); }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }

    .loading { text-align: center; padding: 40px; color: var(--text-muted); font-size: 14px; }
    .message { padding: 12px 16px; border-radius: 6px; margin-top: 12px; font-size: 13px; }
    .message.success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); color: var(--accent-green); }
    .message.error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: var(--accent-red); }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-title">Platform Admin</div>
    <div class="header-subtitle">App Owner Console</div>
  </div>

  <div class="top-nav">
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('tenants')">Tenants</button>
      <button class="nav-tab" onclick="switchTab('tiers')">Tiers</button>
      <button class="nav-tab" onclick="switchTab('presets')">Presets</button>
      <button class="nav-tab" onclick="switchTab('themes')">Themes</button>
      <button class="nav-tab" onclick="switchTab('roles')">Roles</button>
      <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
    </div>
    <div class="nav-actions">
      <button class="btn" onclick="refreshAllData()">Refresh</button>
      <button class="btn btn-primary" onclick="exportReport()">Export</button>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Monthly Recurring Revenue</span><span class="speedo-trend up" id="mrrTrend">+12.4%</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill cyan" id="mrrGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value cyan" id="mrrValue">$0</div>
      <div class="speedo-unit">Total MRR</div>
      <div class="speedo-footer"><span>Target: $50,000</span><span id="mrrPercent">0%</span></div>
    </div>
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Active Tenants</span><span class="speedo-trend up" id="tenantTrend">+8</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill green" id="tenantGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value green" id="tenantCount">0</div>
      <div class="speedo-unit">Active Accounts</div>
      <div class="speedo-footer"><span>Target: 100</span><span id="tenantPercent">0%</span></div>
    </div>
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Churn Rate</span><span class="speedo-trend down" id="churnTrend">-0.5%</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill orange" id="churnGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value orange" id="churnValue">0%</div>
      <div class="speedo-unit">Monthly Churn</div>
      <div class="speedo-footer"><span>Target: &lt;5%</span><span id="churnStatus">Healthy</span></div>
    </div>
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Trial Conversion</span><span class="speedo-trend up" id="convTrend">+3.2%</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill purple" id="convGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value purple" id="convValue">0%</div>
      <div class="speedo-unit">Conversion Rate</div>
      <div class="speedo-footer"><span>Target: 25%</span><span id="convStatus">Good</span></div>
    </div>
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Avg Revenue Per Tenant</span><span class="speedo-trend up" id="arptTrend">+$15</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill cyan" id="arptGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value cyan" id="arptValue">$0</div>
      <div class="speedo-unit">Per Tenant/Month</div>
      <div class="speedo-footer"><span>Target: $500</span><span id="arptPercent">0%</span></div>
    </div>
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Total Platform Users</span><span class="speedo-trend up" id="userTrend">+45</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill green" id="userGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value green" id="userCount">0</div>
      <div class="speedo-unit">Total Users</div>
      <div class="speedo-footer"><span>Target: 500</span><span id="userPercent">0%</span></div>
    </div>
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Customer Lifetime Value</span><span class="speedo-trend up" id="ltvTrend">+$200</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill orange" id="ltvGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value orange" id="ltvValue">$0</div>
      <div class="speedo-unit">Average LTV</div>
      <div class="speedo-footer"><span>Target: $6,000</span><span id="ltvPercent">0%</span></div>
    </div>
    <div class="speedo-card">
      <div class="speedo-header"><span class="speedo-label">Active Trials</span><span class="speedo-trend up" id="trialTrend">+5</span></div>
      <div class="speedo-gauge"><svg viewBox="0 0 120 65"><path class="gauge-bg" d="M 10 60 A 50 50 0 0 1 110 60"/><path class="gauge-fill purple" id="trialGauge" d="M 10 60 A 50 50 0 0 1 110 60" stroke-dasharray="0 157"/></svg></div>
      <div class="speedo-value purple" id="trialCount">0</div>
      <div class="speedo-unit">In Trial Period</div>
      <div class="speedo-footer"><span>Avg Trial: 14 days</span><span id="trialStatus">Pipeline</span></div>
    </div>
  </div>

  <div class="tab-content active" id="tenants">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Create Tenant Account</span><div class="panel-actions"><button class="btn" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;">Cancel</button><button class="btn btn-success" onclick="addTenantAndUser()" id="saveTenantBtn">Add Tenant</button></div></div>
      <div class="info-box">Creates a new tenant organization with owner account.</div>
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Owner Full Name *</label><input type="text" class="form-input" id="userName" placeholder="John Doe"></div>
        <div class="form-group"><label class="form-label">Owner Email *</label><input type="email" class="form-input" id="userEmail" placeholder="owner@company.com"></div>
        <div class="form-group"><label class="form-label">Company Name *</label><input type="text" class="form-input" id="companyName" placeholder="Acme Corp"></div>
        <div class="form-group"><label class="form-label">Domain</label><input type="text" class="form-input" id="userDomain" placeholder="acme.example.com"></div>
        <div class="form-group"><label class="form-label">UI Preset *</label><select class="form-select" id="uiPreset"></select></div>
        <div class="form-group"><label class="form-label">Subscription Tier</label><select class="form-select" id="userTier"></select></div>
        <div class="form-group"><label class="form-label">Global Theme</label><select class="form-select" id="userTheme"></select></div>
        <div class="form-group"><label class="form-label">Account Status</label><select class="form-select" id="userStatus"><option value="active">Active</option><option value="trial">Trial</option><option value="inactive">Inactive</option></select></div>
        <div class="form-group"><label class="form-label">Billing Cycle</label><select class="form-select" id="billingCycle"><option value="monthly">Monthly</option><option value="annual">Annual</option></select></div>
        <div class="form-group"><label class="form-label">Trial Days</label><input type="number" class="form-input" id="trialDays" value="14"></div>
        <div class="form-group full"><label class="form-label">Notes</label><textarea class="form-textarea" id="userNotes" placeholder="Internal notes..."></textarea></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">All Tenants</span><div class="panel-actions"><input type="text" class="form-input" id="tenantSearch" placeholder="Search..." style="width:180px;" oninput="filterTenants()"><button class="btn" onclick="loadTenants()">Refresh</button></div></div>
      <div id="tenantsLoading" class="loading">Loading...</div>
      <table class="data-table" id="tenantsTable" style="display:none;"><thead><tr><th>Company</th><th>Owner</th><th>Preset</th><th>Theme</th><th>Tier</th><th>MRR</th><th>Users</th><th>Status</th><th>Actions</th></tr></thead><tbody id="tenantsTableBody"></tbody></table>
    </div>
  </div>

  <div class="tab-content" id="tiers">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Subscription Tiers</span><button class="btn btn-success" onclick="openTierModal()">+ Add Tier</button></div>
      <div class="info-box">Define pricing tiers with features and Stripe integration.</div>
      <div id="tiersLoading" class="loading">Loading...</div>
      <table class="data-table" id="tiersTable" style="display:none;"><thead><tr><th>Tier</th><th>Monthly</th><th>Annual</th><th>Limits</th><th>Features</th><th>Subscribers</th><th>Status</th><th>Actions</th></tr></thead><tbody id="tiersTableBody"></tbody></table>
    </div>
  </div>

  <div class="tab-content" id="presets">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">UI Presets</span><button class="btn btn-success" onclick="openPresetModal()">+ Add Preset</button></div>
      <div class="info-box">UI Presets define navigation and action buttons for different industries.</div>
      <div id="presetsLoading" class="loading">Loading...</div>
      <table class="data-table" id="presetsTable" style="display:none;"><thead><tr><th>Preset</th><th>Industry</th><th>Buttons</th><th>Tenants</th><th>Status</th><th>Actions</th></tr></thead><tbody id="presetsTableBody"></tbody></table>
    </div>
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Built-in Templates</span></div>
      <div style="display:grid; gap:12px;">
        <div class="role-section"><div class="role-header">Car Dealership</div><div class="button-preview"><span class="preview-btn primary">Business</span><span class="preview-btn primary">Customers</span><span class="preview-btn primary">Vehicles</span><span class="preview-btn">Service</span><span class="preview-btn">Parts</span><span class="preview-btn">Sales</span></div></div>
        <div class="role-section"><div class="role-header">Law Firm</div><div class="button-preview"><span class="preview-btn primary">Business</span><span class="preview-btn primary">Clients</span><span class="preview-btn primary">Cases</span><span class="preview-btn">Tasks</span><span class="preview-btn">Billing</span></div></div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="themes">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Global Themes</span><button class="btn btn-success" onclick="openThemeModal()">+ Create Theme</button></div>
      <div class="info-box">Global themes apply across all tenant settings pages.</div>
      <div id="themesLoading" class="loading">Loading...</div>
      <table class="data-table" id="themesTable" style="display:none;"><thead><tr><th>Theme</th><th>Preview</th><th>Type</th><th>Tenants</th><th>Default</th><th>Actions</th></tr></thead><tbody id="themesTableBody"></tbody></table>
    </div>
  </div>

  <div class="tab-content" id="roles">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Role Permissions</span><button class="btn btn-primary" onclick="saveRolePermissions()">Save</button></div>
      <div class="info-box">Configure button access per role. Owners always have full access.</div>
      <div class="role-section"><div class="role-header">Owner - Full Access</div></div>
      <div class="role-section"><div class="role-header">Manager</div><div class="checkbox-grid" id="managerButtons"></div></div>
      <div class="role-section"><div class="role-header">Technician</div><div class="checkbox-grid" id="technicianButtons"></div></div>
      <div class="role-section"><div class="role-header">Admin</div><div class="checkbox-grid" id="adminButtons"></div></div>
      <div class="role-section"><div class="role-header">Sales</div><div class="checkbox-grid" id="salesButtons"></div></div>
      <div id="rolesSaveMessage"></div>
    </div>
  </div>

  <div class="tab-content" id="analytics">
    <div class="panel">
      <div class="panel-header"><span class="panel-title">Analytics</span><select class="form-select" id="analyticsRange" onchange="loadAnalytics()" style="width:140px;"><option value="7">Last 7 Days</option><option value="30" selected>Last 30 Days</option><option value="90">Last 90 Days</option></select></div>
      <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; margin-bottom:20px;">
        <div class="role-section" style="text-align:center;"><div class="speedo-label">New Signups</div><div class="speedo-value cyan" style="font-size:28px;" id="analyticSignups">0</div></div>
        <div class="role-section" style="text-align:center;"><div class="speedo-label">Revenue Growth</div><div class="speedo-value green" style="font-size:28px;" id="analyticGrowth">0%</div></div>
        <div class="role-section" style="text-align:center;"><div class="speedo-label">Support Tickets</div><div class="speedo-value orange" style="font-size:28px;" id="analyticTickets">0</div></div>
        <div class="role-section" style="text-align:center;"><div class="speedo-label">API Calls</div><div class="speedo-value purple" style="font-size:28px;" id="analyticAPI">0</div></div>
      </div>
      <div class="info-box">Revenue by Tier</div>
      <div id="revenueBreakdown" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:12px;"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="tierModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" id="tierModalTitle">Add Tier</span><button class="modal-close" onclick="closeTierModal()">&times;</button></div>
    <div class="modal-body">
      <input type="hidden" id="editTierId">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Tier Name *</label><input type="text" class="form-input" id="tierName"></div>
        <div class="form-group"><label class="form-label">Display Name</label><input type="text" class="form-input" id="tierDisplayName"></div>
        <div class="form-group"><label class="form-label">Monthly Price *</label><input type="number" class="form-input" id="tierMonthlyPrice" step="0.01"></div>
        <div class="form-group"><label class="form-label">Annual Price</label><input type="number" class="form-input" id="tierAnnualPrice" step="0.01"></div>
        <div class="form-group"><label class="form-label">Max Users</label><input type="number" class="form-input" id="tierMaxUsers"></div>
        <div class="form-group"><label class="form-label">Max Units</label><input type="number" class="form-input" id="tierMaxVehicles"></div>
        <div class="form-group"><label class="form-label">Stripe Monthly ID</label><input type="text" class="form-input" id="tierStripeMonthly"></div>
        <div class="form-group"><label class="form-label">Sort Order</label><input type="number" class="form-input" id="tierSortOrder" value="0"></div>
        <div class="form-group full"><label class="form-label">Features (one per line)</label><textarea class="form-textarea" id="tierFeatures"></textarea></div>
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="tierIsActive"><option value="true">Active</option><option value="false">Inactive</option></select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeTierModal()">Cancel</button><button class="btn btn-success" onclick="saveTier()">Save</button></div>
  </div>
</div>

<div class="modal-overlay" id="presetModal">
  <div class="modal" style="max-width:800px;">
    <div class="modal-header"><span class="modal-title" id="presetModalTitle">Add Preset</span><button class="modal-close" onclick="closePresetModal()">&times;</button></div>
    <div class="modal-body">
      <input type="hidden" id="editPresetId">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="presetName"></div>
        <div class="form-group"><label class="form-label">Industry</label><select class="form-select" id="presetIndustry"><option value="automotive">Automotive</option><option value="powersports">Powersports</option><option value="marine">Marine</option><option value="field_sales">Field Sales</option><option value="legal">Legal</option><option value="other">Other</option></select></div>
        <div class="form-group full"><label class="form-label">Description</label><input type="text" class="form-input" id="presetDescription"></div>
        <div class="form-group full"><label class="form-label">Navigation Buttons</label><div class="button-label-grid" id="presetNavButtons"></div></div>
        <div class="form-group full"><label class="form-label">Action Buttons</label><div class="button-label-grid" id="presetActionButtons"></div></div>
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="presetIsActive"><option value="true">Active</option><option value="false">Inactive</option></select></div>
        <div class="form-group full"><label class="form-label">Preview</label><div class="button-preview" id="presetPreview"><span style="color:var(--text-muted);">Select buttons...</span></div></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closePresetModal()">Cancel</button><button class="btn btn-success" onclick="savePreset()">Save</button></div>
  </div>
</div>

<div class="modal-overlay" id="themeModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" id="themeModalTitle">Create Theme</span><button class="modal-close" onclick="closeThemeModal()">&times;</button></div>
    <div class="modal-body">
      <input type="hidden" id="editThemeId">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="themeName"></div>
        <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="themeType" onchange="updateThemePreview()"><option value="dark">Dark</option><option value="light">Light</option></select></div>
        <div class="form-group full">
          <label class="form-label">Colors</label>
          <div class="color-row"><label>Primary</label><input type="color" id="themePrimary" value="#22d3ee" onchange="updateThemePreview()"><input type="text" id="themePrimaryHex" value="#22d3ee"></div>
          <div class="color-row"><label>Secondary</label><input type="color" id="themeSecondary" value="#22c55e" onchange="updateThemePreview()"><input type="text" id="themeSecondaryHex" value="#22c55e"></div>
          <div class="color-row"><label>Background</label><input type="color" id="themeBg" value="#0a0f1a" onchange="updateThemePreview()"><input type="text" id="themeBgHex" value="#0a0f1a"></div>
          <div class="color-row"><label>Card</label><input type="color" id="themeCard" value="#111827" onchange="updateThemePreview()"><input type="text" id="themeCardHex" value="#111827"></div>
          <div class="color-row"><label>Text</label><input type="color" id="themeText" value="#ffffff" onchange="updateThemePreview()"><input type="text" id="themeTextHex" value="#ffffff"></div>
          <div class="color-row"><label>Border</label><input type="color" id="themeBorder" value="#2a3441" onchange="updateThemePreview()"><input type="text" id="themeBorderHex" value="#2a3441"></div>
        </div>
        <div class="form-group full"><label class="form-label">Preview</label><div class="theme-preview-box" id="themePreviewBox"><div class="theme-preview-header" id="themePreviewHeader"><div class="theme-preview-dot" style="background:#ff5f57;"></div><div class="theme-preview-dot" style="background:#febc2e;"></div><div class="theme-preview-dot" style="background:#28c840;"></div></div><div class="theme-preview-body" id="themePreviewBody"><div class="theme-preview-sidebar" id="themePreviewSidebar"></div><div class="theme-preview-content" id="themePreviewContent"></div></div></div></div>
        <div class="form-group"><label class="form-label">Default</label><select class="form-select" id="themeIsDefault"><option value="false">No</option><option value="true">Yes</option></select></div>
        <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="themeIsActive"><option value="true">Active</option><option value="false">Inactive</option></select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeThemeModal()">Cancel</button><button class="btn btn-success" onclick="saveTheme()">Save</button></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ALL_NAV_BUTTONS = ['Business', 'Customers', 'Vehicles', 'Clients', 'Cases', 'Units', 'Boats', 'Settings'];
const ALL_ACTION_BUTTONS = ['Service', 'Parts', 'Sales', 'Fleet', 'Rentals', 'Scheduler', 'Calendar', 'Routes', 'Leads', 'Tasks', 'Documents', 'Billing', 'Storage', 'Inbox', 'Reports'];

let tiers = [], tenants = [], presets = [], themes = [], rolePermissions = {}, editingTenantId = null;

async function init() {
  await Promise.all([loadTiers(), loadTenants(), loadPresets(), loadThemes(), loadRolePermissions()]);
  populatePresetModal(); populateRolePermissions(); updateKPIs(); loadAnalytics();
}

function switchTab(tabName) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tabName).classList.add('active');
}

function updateKPIs() {
  const active = tenants.filter(t => t.status === 'active'), trials = tenants.filter(t => t.status === 'trial');
  const mrr = tenants.reduce((s, t) => s + (t.monthly_recurring_revenue || 0), 0);
  const users = tenants.reduce((s, t) => s + (t.user_count || 1), 0);
  document.getElementById('mrrValue').textContent = '$' + mrr.toLocaleString();
  document.getElementById('mrrPercent').textContent = ((mrr / 50000) * 100).toFixed(1) + '%';
  animateGauge('mrrGauge', Math.min((mrr / 50000) * 100, 100));
  document.getElementById('tenantCount').textContent = active.length;
  document.getElementById('tenantPercent').textContent = active.length + '%';
  animateGauge('tenantGauge', Math.min(active.length, 100));
  document.getElementById('churnValue').textContent = '3.2%'; animateGauge('churnGauge', 32);
  document.getElementById('convValue').textContent = '22.5%'; animateGauge('convGauge', 90);
  const arpt = active.length > 0 ? mrr / active.length : 0;
  document.getElementById('arptValue').textContent = '$' + arpt.toFixed(0);
  document.getElementById('arptPercent').textContent = ((arpt / 500) * 100).toFixed(1) + '%';
  animateGauge('arptGauge', Math.min((arpt / 500) * 100, 100));
  document.getElementById('userCount').textContent = users;
  document.getElementById('userPercent').textContent = ((users / 500) * 100).toFixed(1) + '%';
  animateGauge('userGauge', Math.min((users / 500) * 100, 100));
  const ltv = arpt * 12;
  document.getElementById('ltvValue').textContent = '$' + ltv.toFixed(0);
  document.getElementById('ltvPercent').textContent = ((ltv / 6000) * 100).toFixed(1) + '%';
  animateGauge('ltvGauge', Math.min((ltv / 6000) * 100, 100));
  document.getElementById('trialCount').textContent = trials.length;
  animateGauge('trialGauge', trials.length * 10);
}

function animateGauge(id, pct) { document.getElementById(id).setAttribute('stroke-dasharray', `${(pct / 100) * 157} 157`); }

async function loadTiers() {
  try { const { data } = await supabaseClient.from('subscription_tiers').select('*').order('sort_order'); tiers = data?.length ? data : getDefaultTiers(); } catch(e) { tiers = getDefaultTiers(); }
  renderTiers(); populateTierSelect();
}

function getDefaultTiers() { return [{tier_id:'starter',tier_display_name:'Starter',monthly_price:49,annual_price:490,max_users:3,is_active:true,features:['Basic Support']},{tier_id:'professional',tier_display_name:'Professional',monthly_price:149,annual_price:1490,max_users:10,is_active:true,features:['Priority Support','API Access']},{tier_id:'enterprise',tier_display_name:'Enterprise',monthly_price:399,annual_price:3990,is_active:true,features:['24/7 Support','Custom Integration']}]; }

function renderTiers() {
  document.getElementById('tiersLoading').style.display = 'none';
  document.getElementById('tiersTable').style.display = 'table';
  document.getElementById('tiersTableBody').innerHTML = tiers.map(t => `<tr><td><strong>${t.tier_display_name||t.tier_name}</strong></td><td>$${(t.monthly_price||0).toFixed(2)}</td><td>$${(t.annual_price||0).toFixed(2)}</td><td>${t.max_users?t.max_users+' users':'Unlimited'}</td><td>${(t.features||[]).slice(0,2).join(', ')}</td><td>${tenants.filter(tn=>tn.tier_id===t.tier_id).length}</td><td><span class="badge ${t.is_active?'badge-green':'badge-orange'}">${t.is_active?'Active':'Inactive'}</span></td><td class="actions"><button class="btn btn-sm" onclick="editTier('${t.tier_id}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteTier('${t.tier_id}')">Delete</button></td></tr>`).join('');
}

function populateTierSelect() { document.getElementById('userTier').innerHTML = '<option value="">-- Select --</option>' + tiers.filter(t=>t.is_active).map(t => `<option value="${t.tier_id}">${t.tier_display_name||t.tier_name} - $${t.monthly_price}/mo</option>`).join(''); }

function openTierModal() { ['editTierId','tierName','tierDisplayName','tierMonthlyPrice','tierAnnualPrice','tierMaxUsers','tierMaxVehicles','tierStripeMonthly','tierFeatures'].forEach(id=>document.getElementById(id).value=''); document.getElementById('tierSortOrder').value=tiers.length; document.getElementById('tierIsActive').value='true'; document.getElementById('tierModalTitle').textContent='Add Tier'; document.getElementById('tierModal').classList.add('active'); }
function closeTierModal() { document.getElementById('tierModal').classList.remove('active'); }

function editTier(id) { const t=tiers.find(x=>x.tier_id===id); if(!t)return; document.getElementById('editTierId').value=t.tier_id; document.getElementById('tierName').value=t.tier_name||''; document.getElementById('tierDisplayName').value=t.tier_display_name||''; document.getElementById('tierMonthlyPrice').value=t.monthly_price||''; document.getElementById('tierAnnualPrice').value=t.annual_price||''; document.getElementById('tierMaxUsers').value=t.max_users||''; document.getElementById('tierMaxVehicles').value=t.max_vehicles||''; document.getElementById('tierStripeMonthly').value=t.stripe_price_id_monthly||''; document.getElementById('tierSortOrder').value=t.sort_order||0; document.getElementById('tierFeatures').value=(t.features||[]).join('\n'); document.getElementById('tierIsActive').value=t.is_active?'true':'false'; document.getElementById('tierModalTitle').textContent='Edit Tier'; document.getElementById('tierModal').classList.add('active'); }

async function saveTier() { const id=document.getElementById('editTierId').value,name=document.getElementById('tierName').value.trim(),monthly=parseFloat(document.getElementById('tierMonthlyPrice').value)||0; if(!name||monthly<=0){alert('Name and price required');return;} const data={tier_name:name,tier_display_name:document.getElementById('tierDisplayName').value.trim()||name,monthly_price:monthly,annual_price:parseFloat(document.getElementById('tierAnnualPrice').value)||(monthly*10),max_users:parseInt(document.getElementById('tierMaxUsers').value)||null,max_vehicles:parseInt(document.getElementById('tierMaxVehicles').value)||null,stripe_price_id_monthly:document.getElementById('tierStripeMonthly').value.trim()||null,sort_order:parseInt(document.getElementById('tierSortOrder').value)||0,features:document.getElementById('tierFeatures').value.trim().split('\n').filter(f=>f.trim()),is_active:document.getElementById('tierIsActive').value==='true',updated_at:new Date().toISOString()}; try{if(id)await supabaseClient.from('subscription_tiers').update(data).eq('tier_id',id);else{data.tier_id=name.toLowerCase().replace(/[^a-z0-9]/g,'_');data.created_at=new Date().toISOString();await supabaseClient.from('subscription_tiers').insert([data]);}alert('Saved');closeTierModal();await loadTiers();}catch(e){alert('Error: '+e.message);} }

async function deleteTier(id) { if(!confirm('Delete tier?'))return; try{await supabaseClient.from('subscription_tiers').delete().eq('tier_id',id);await loadTiers();}catch(e){alert('Error: '+e.message);} }

async function loadPresets() { try{const{data}=await supabaseClient.from('ui_presets').select('*').order('name');presets=data?.length?data:getDefaultPresets();}catch(e){presets=getDefaultPresets();} renderPresets();populatePresetSelect(); }
function getDefaultPresets() { return [{id:'car_dealership',name:'Car Dealership',industry:'automotive',nav_buttons:['Business','Customers','Vehicles','Settings'],action_buttons:['Service','Parts','Sales','Scheduler'],button_labels:{},is_active:true},{id:'law_firm',name:'Law Firm',industry:'legal',nav_buttons:['Business','Clients','Cases','Settings'],action_buttons:['Tasks','Calendar','Documents','Billing'],button_labels:{},is_active:true},{id:'powersports',name:'Powersports',industry:'powersports',nav_buttons:['Business','Customers','Units','Settings'],action_buttons:['Service','Parts','Sales','Rentals'],button_labels:{},is_active:true}]; }
function renderPresets() { document.getElementById('presetsLoading').style.display='none'; document.getElementById('presetsTable').style.display='table'; document.getElementById('presetsTableBody').innerHTML=presets.map(p=>`<tr><td><strong>${p.name}</strong></td><td><span class="badge badge-cyan">${p.industry||'other'}</span></td><td>${[...(p.nav_buttons||[]),...(p.action_buttons||[])].slice(0,4).join(', ')}...</td><td>${tenants.filter(t=>t.ui_preset_id===p.id).length}</td><td><span class="badge ${p.is_active?'badge-green':'badge-orange'}">${p.is_active?'Active':'Inactive'}</span></td><td class="actions"><button class="btn btn-sm" onclick="editPreset('${p.id}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deletePreset('${p.id}')">Delete</button></td></tr>`).join(''); }
function populatePresetSelect() { document.getElementById('uiPreset').innerHTML=presets.filter(p=>p.is_active).map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
function populatePresetModal() { document.getElementById('presetNavButtons').innerHTML=ALL_NAV_BUTTONS.map(b=>`<div class="button-label-item"><input type="checkbox" value="${b}" onchange="toggleButtonLabel(this);updatePresetPreview()"><span class="btn-id">${b}</span><input type="text" id="label_${b}" value="${b}" disabled onkeyup="updatePresetPreview()"></div>`).join(''); document.getElementById('presetActionButtons').innerHTML=ALL_ACTION_BUTTONS.map(b=>`<div class="button-label-item"><input type="checkbox" value="${b}" onchange="toggleButtonLabel(this);updatePresetPreview()"><span class="btn-id">${b}</span><input type="text" id="label_${b}" value="${b}" disabled onkeyup="updatePresetPreview()"></div>`).join(''); }
function toggleButtonLabel(cb) { const inp=document.getElementById('label_'+cb.value); if(inp){inp.disabled=!cb.checked;if(cb.checked&&!inp.value)inp.value=cb.value;} }
function updatePresetPreview() { const nav=[...document.querySelectorAll('#presetNavButtons input[type="checkbox"]:checked')].map(c=>`<span class="preview-btn primary">${document.getElementById('label_'+c.value)?.value||c.value}</span>`); const act=[...document.querySelectorAll('#presetActionButtons input[type="checkbox"]:checked')].map(c=>`<span class="preview-btn">${document.getElementById('label_'+c.value)?.value||c.value}</span>`); document.getElementById('presetPreview').innerHTML=nav.join('')+act.join('')||'<span style="color:var(--text-muted)">Select buttons...</span>'; }
function openPresetModal() { populatePresetModal(); ['editPresetId','presetName','presetDescription'].forEach(id=>document.getElementById(id).value=''); document.getElementById('presetIndustry').value='automotive'; document.getElementById('presetIsActive').value='true'; document.querySelectorAll('#presetNavButtons input[type="checkbox"], #presetActionButtons input[type="checkbox"]').forEach(c=>{c.checked=false;toggleButtonLabel(c);}); document.getElementById('presetPreview').innerHTML='<span style="color:var(--text-muted)">Select buttons...</span>'; document.getElementById('presetModalTitle').textContent='Add Preset'; document.getElementById('presetModal').classList.add('active'); }
function closePresetModal() { document.getElementById('presetModal').classList.remove('active'); }
function editPreset(id) { populatePresetModal(); const p=presets.find(x=>x.id===id); if(!p)return; document.getElementById('editPresetId').value=p.id; document.getElementById('presetName').value=p.name||''; document.getElementById('presetIndustry').value=p.industry||'other'; document.getElementById('presetDescription').value=p.description||''; document.getElementById('presetIsActive').value=p.is_active?'true':'false'; document.querySelectorAll('#presetNavButtons input[type="checkbox"]').forEach(c=>{c.checked=(p.nav_buttons||[]).includes(c.value);toggleButtonLabel(c);}); document.querySelectorAll('#presetActionButtons input[type="checkbox"]').forEach(c=>{c.checked=(p.action_buttons||[]).includes(c.value);toggleButtonLabel(c);}); Object.entries(p.button_labels||{}).forEach(([k,v])=>{const inp=document.getElementById('label_'+k);if(inp)inp.value=v;}); updatePresetPreview(); document.getElementById('presetModalTitle').textContent='Edit Preset'; document.getElementById('presetModal').classList.add('active'); }
async function savePreset() { const id=document.getElementById('editPresetId').value,name=document.getElementById('presetName').value.trim(); if(!name){alert('Name required');return;} const labels={}; [...ALL_NAV_BUTTONS,...ALL_ACTION_BUTTONS].forEach(b=>{const cb=document.querySelector(`input[value="${b}"]`);const inp=document.getElementById('label_'+b);if(cb?.checked&&inp?.value&&inp.value!==b)labels[b]=inp.value;}); const data={name,industry:document.getElementById('presetIndustry').value,description:document.getElementById('presetDescription').value.trim(),nav_buttons:[...document.querySelectorAll('#presetNavButtons input[type="checkbox"]:checked')].map(c=>c.value),action_buttons:[...document.querySelectorAll('#presetActionButtons input[type="checkbox"]:checked')].map(c=>c.value),button_labels:labels,is_active:document.getElementById('presetIsActive').value==='true',updated_at:new Date().toISOString()}; try{if(id)await supabaseClient.from('ui_presets').update(data).eq('id',id);else{data.id=name.toLowerCase().replace(/[^a-z0-9]/g,'_');data.created_at=new Date().toISOString();await supabaseClient.from('ui_presets').insert([data]);}alert('Saved');closePresetModal();await loadPresets();}catch(e){if(id){const idx=presets.findIndex(x=>x.id===id);if(idx>=0)presets[idx]={...presets[idx],...data};}else{data.id=name.toLowerCase().replace(/[^a-z0-9]/g,'_');presets.push(data);}alert('Saved locally');closePresetModal();renderPresets();populatePresetSelect();} }
async function deletePreset(id) { if(!confirm('Delete?'))return; try{await supabaseClient.from('ui_presets').delete().eq('id',id);}catch(e){} presets=presets.filter(p=>p.id!==id); renderPresets();populatePresetSelect(); }

async function loadThemes() { themes=getDefaultThemes(); try{const{data}=await supabaseClient.from('global_themes').select('*').order('name');if(data?.length)themes=data;}catch(e){} renderThemes();populateThemeSelect(); }
function getDefaultThemes() { return [{id:'default_dark',name:'Default Dark',type:'dark',primary:'#22d3ee',secondary:'#22c55e',bg:'#0a0f1a',card:'#111827',text:'#ffffff',border:'#2a3441',is_default:true,is_active:true},{id:'ocean_blue',name:'Ocean Blue',type:'dark',primary:'#3b82f6',secondary:'#60a5fa',bg:'#0c1929',card:'#1e3a5f',text:'#ffffff',border:'#2d5a8a',is_active:true},{id:'forest_green',name:'Forest Green',type:'dark',primary:'#10b981',secondary:'#34d399',bg:'#0a1f1a',card:'#134e3a',text:'#ffffff',border:'#1f5c4a',is_active:true}]; }
function renderThemes() { document.getElementById('themesLoading').style.display='none'; document.getElementById('themesTable').style.display='table'; document.getElementById('themesTableBody').innerHTML=themes.map(t=>`<tr><td><strong>${t.name}</strong></td><td><div style="width:60px;height:30px;background:${t.bg};border:1px solid ${t.border};border-radius:4px;display:flex;align-items:center;justify-content:center;"><div style="width:8px;height:8px;background:${t.primary};border-radius:50%;"></div></div></td><td><span class="badge ${t.type==='dark'?'badge-purple':'badge-cyan'}">${t.type}</span></td><td>${tenants.filter(tn=>tn.theme_id===t.id).length}</td><td>${t.is_default?'<span class="badge badge-green">Default</span>':'-'}</td><td class="actions"><button class="btn btn-sm" onclick="editTheme('${t.id}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteTheme('${t.id}')">Delete</button></td></tr>`).join(''); }
function populateThemeSelect() { document.getElementById('userTheme').innerHTML=themes.filter(t=>t.is_active).map(t=>`<option value="${t.id}" ${t.is_default?'selected':''}>${t.name}</option>`).join(''); }
function openThemeModal() { document.getElementById('editThemeId').value=''; document.getElementById('themeName').value=''; document.getElementById('themeType').value='dark'; const defs={Primary:'#22d3ee',Secondary:'#22c55e',Bg:'#0a0f1a',Card:'#111827',Text:'#ffffff',Border:'#2a3441'}; Object.entries(defs).forEach(([n,v])=>{document.getElementById('theme'+n).value=v;document.getElementById('theme'+n+'Hex').value=v;}); document.getElementById('themeIsDefault').value='false'; document.getElementById('themeIsActive').value='true'; document.getElementById('themeModalTitle').textContent='Create Theme'; updateThemePreview(); document.getElementById('themeModal').classList.add('active'); }
function closeThemeModal() { document.getElementById('themeModal').classList.remove('active'); }
function editTheme(id) { const t=themes.find(x=>x.id===id); if(!t)return; document.getElementById('editThemeId').value=t.id; document.getElementById('themeName').value=t.name||''; document.getElementById('themeType').value=t.type||'dark'; ['Primary','Secondary','Bg','Card','Text','Border'].forEach(n=>{const v=t[n.toLowerCase()]||'#000000';document.getElementById('theme'+n).value=v;document.getElementById('theme'+n+'Hex').value=v;}); document.getElementById('themeIsDefault').value=t.is_default?'true':'false'; document.getElementById('themeIsActive').value=t.is_active?'true':'false'; document.getElementById('themeModalTitle').textContent='Edit Theme'; updateThemePreview(); document.getElementById('themeModal').classList.add('active'); }
function updateThemePreview() { const bg=document.getElementById('themeBg').value,card=document.getElementById('themeCard').value,border=document.getElementById('themeBorder').value; ['Primary','Secondary','Bg','Card','Text','Border'].forEach(n=>document.getElementById('theme'+n+'Hex').value=document.getElementById('theme'+n).value); document.getElementById('themePreviewBox').style.background=bg; document.getElementById('themePreviewHeader').style.background=card; document.getElementById('themePreviewBody').style.background=bg; document.getElementById('themePreviewSidebar').style.background=card; document.getElementById('themePreviewContent').style.background=card; document.getElementById('themePreviewContent').style.border='1px solid '+border; }
async function saveTheme() { const id=document.getElementById('editThemeId').value,name=document.getElementById('themeName').value.trim(); if(!name){alert('Name required');return;} const isDefault=document.getElementById('themeIsDefault').value==='true'; if(isDefault)themes.forEach(t=>t.is_default=false); const data={name,type:document.getElementById('themeType').value,primary:document.getElementById('themePrimary').value,secondary:document.getElementById('themeSecondary').value,bg:document.getElementById('themeBg').value,card:document.getElementById('themeCard').value,text:document.getElementById('themeText').value,border:document.getElementById('themeBorder').value,is_default:isDefault,is_active:document.getElementById('themeIsActive').value==='true',updated_at:new Date().toISOString()}; try{if(isDefault)await supabaseClient.from('global_themes').update({is_default:false}).neq('id',id||'none');if(id)await supabaseClient.from('global_themes').update(data).eq('id',id);else{data.id=name.toLowerCase().replace(/[^a-z0-9]/g,'_');data.created_at=new Date().toISOString();await supabaseClient.from('global_themes').insert([data]);}alert('Saved');}catch(e){if(id){const idx=themes.findIndex(x=>x.id===id);if(idx>=0)themes[idx]={...themes[idx],...data};}else{data.id=name.toLowerCase().replace(/[^a-z0-9]/g,'_');themes.push(data);}alert('Saved locally');} closeThemeModal();renderThemes();populateThemeSelect(); }
async function deleteTheme(id) { if(!confirm('Delete?'))return; try{await supabaseClient.from('global_themes').delete().eq('id',id);}catch(e){} themes=themes.filter(t=>t.id!==id); renderThemes();populateThemeSelect(); }

async function loadRolePermissions() { rolePermissions={owner:[...ALL_NAV_BUTTONS,...ALL_ACTION_BUTTONS],manager:['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Tasks'],technician:['Customers','Vehicles','Service','Parts','Tasks'],admin:['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Tasks','Billing'],sales:['Customers','Vehicles','Sales','Leads','Calendar','Tasks']}; try{const{data}=await supabaseClient.from('role_permissions').select('*');if(data)data.forEach(r=>rolePermissions[r.role]=r.allowed_buttons||[]);}catch(e){} }
function populateRolePermissions() { const all=[...ALL_NAV_BUTTONS,...ALL_ACTION_BUTTONS]; ['manager','technician','admin','sales'].forEach(role=>{const c=document.getElementById(role+'Buttons');if(c)c.innerHTML=all.map(b=>`<label class="checkbox-item"><input type="checkbox" value="${b}" ${(rolePermissions[role]||[]).includes(b)?'checked':''}><span>${b}</span></label>`).join('');}); }
async function saveRolePermissions() { ['manager','technician','admin','sales'].forEach(async role=>{const btns=[...document.querySelectorAll(`#${role}Buttons input:checked`)].map(c=>c.value);rolePermissions[role]=btns;try{await supabaseClient.from('role_permissions').upsert({role,allowed_buttons:btns,updated_at:new Date().toISOString()},{onConflict:'role'});}catch(e){}}); document.getElementById('rolesSaveMessage').innerHTML='<div class="message success">Saved</div>'; setTimeout(()=>document.getElementById('rolesSaveMessage').innerHTML='',3000); }

async function loadTenants() { try{const{data}=await supabaseClient.from('tenants').select('*, subscription_tiers(tier_display_name)').order('created_at',{ascending:false});tenants=data||[];for(let t of tenants){try{const{data:owner}=await supabaseClient.from('users').select('email').eq('tenant_id',t.tenant_id).eq('role','owner').limit(1).single();t.owner=owner;const{count}=await supabaseClient.from('users').select('*',{count:'exact',head:true}).eq('tenant_id',t.tenant_id);t.user_count=count||1;}catch(e){t.owner=null;t.user_count=1;}}renderTenants();updateKPIs();}catch(e){console.error(e);} }
function renderTenants() { document.getElementById('tenantsLoading').style.display='none'; document.getElementById('tenantsTable').style.display='table'; if(!tenants.length){document.getElementById('tenantsTableBody').innerHTML='<tr><td colspan="9" class="loading">No tenants yet</td></tr>';return;} document.getElementById('tenantsTableBody').innerHTML=tenants.map(t=>`<tr><td><strong>${t.company_name||t.tenant_name}</strong><br><small style="color:var(--text-muted)">${t.domain||''}</small></td><td>${t.owner?.email||t.billing_email||'-'}</td><td><span class="badge badge-cyan">${presets.find(p=>p.id===t.ui_preset_id)?.name||'-'}</span></td><td><span class="badge badge-purple">${themes.find(th=>th.id===t.theme_id)?.name||'Default'}</span></td><td>${t.subscription_tiers?.tier_display_name||'None'}</td><td style="color:var(--accent-green)">$${(t.monthly_recurring_revenue||0).toFixed(2)}</td><td>${t.user_count||1}</td><td><span class="status-dot ${t.status}"></span>${t.status}</td><td class="actions"><button class="btn btn-sm" onclick="editTenant('${t.tenant_id}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteTenant('${t.tenant_id}')">Delete</button></td></tr>`).join(''); }
function filterTenants() { const s=document.getElementById('tenantSearch').value.toLowerCase(); document.querySelectorAll('#tenantsTableBody tr').forEach(r=>r.style.display=r.textContent.toLowerCase().includes(s)?'':'none'); }

async function addTenantAndUser() { const name=document.getElementById('userName').value.trim(),email=document.getElementById('userEmail').value.trim(),company=document.getElementById('companyName').value.trim(); if(!name||!email||!company){alert('Name, email, and company required');return;} const now=new Date().toISOString(),tier=tiers.find(t=>t.tier_id===document.getElementById('userTier').value); try{if(editingTenantId){await supabaseClient.from('tenants').update({tenant_name:company,company_name:company,domain:document.getElementById('userDomain').value.trim()||null,ui_preset_id:document.getElementById('uiPreset').value||null,theme_id:document.getElementById('userTheme').value||null,tier_id:document.getElementById('userTier').value||null,status:document.getElementById('userStatus').value,billing_cycle:document.getElementById('billingCycle').value,billing_email:email,monthly_recurring_revenue:tier?.monthly_price||0,metadata:{notes:document.getElementById('userNotes').value,trial_days:parseInt(document.getElementById('trialDays').value)||14},updated_at:now}).eq('tenant_id',editingTenantId);alert('Updated');cancelEdit();await loadTenants();return;} const tenantId=crypto.randomUUID(),userId=crypto.randomUUID(); await supabaseClient.from('tenants').insert([{tenant_id:tenantId,tenant_name:company,company_name:company,domain:document.getElementById('userDomain').value.trim()||null,ui_preset_id:document.getElementById('uiPreset').value||null,theme_id:document.getElementById('userTheme').value||null,tier_id:document.getElementById('userTier').value||null,status:document.getElementById('userStatus').value,billing_cycle:document.getElementById('billingCycle').value,billing_email:email,monthly_recurring_revenue:tier?.monthly_price||0,metadata:{notes:document.getElementById('userNotes').value,trial_days:parseInt(document.getElementById('trialDays').value)||14},created_at:now,updated_at:now}]); await supabaseClient.from('users').insert([{user_id:userId,tenant_id:tenantId,email,role:'owner',is_active:true,created_at:now,updated_at:now}]); const[first,...rest]=name.split(' '); await supabaseClient.from('employees').insert([{employee_id:crypto.randomUUID(),tenant_id:tenantId,user_id:userId,first_name:first,last_name:rest.join(' ')||'',email,role:'owner',is_active:true,created_at:now}]); await supabaseClient.from('business_settings').insert([{tenant_id:tenantId,business_name:company,created_at:now,updated_at:now}]); alert('Created: '+company);clearTenantForm();await loadTenants();}catch(e){alert('Error: '+e.message);} }
function editTenant(id) { const t=tenants.find(x=>x.tenant_id===id); if(!t)return; editingTenantId=id; document.getElementById('userName').value=t.tenant_name||''; document.getElementById('userEmail').value=t.owner?.email||t.billing_email||''; document.getElementById('companyName').value=t.company_name||''; document.getElementById('userDomain').value=t.domain||''; document.getElementById('uiPreset').value=t.ui_preset_id||''; document.getElementById('userTheme').value=t.theme_id||''; document.getElementById('userTier').value=t.tier_id||''; document.getElementById('userStatus').value=t.status||'active'; document.getElementById('billingCycle').value=t.billing_cycle||'monthly'; document.getElementById('trialDays').value=t.metadata?.trial_days||14; document.getElementById('userNotes').value=t.metadata?.notes||''; document.getElementById('saveTenantBtn').textContent='Update'; document.getElementById('cancelEditBtn').style.display='inline-block'; window.scrollTo(0,0); }
function cancelEdit() { editingTenantId=null;clearTenantForm(); document.getElementById('saveTenantBtn').textContent='Add Tenant'; document.getElementById('cancelEditBtn').style.display='none'; }
function clearTenantForm() { ['userName','userEmail','companyName','userDomain','userNotes'].forEach(id=>document.getElementById(id).value=''); document.getElementById('trialDays').value='14'; }
async function deleteTenant(id) { if(!confirm('Delete tenant and all data?'))return; try{await supabaseClient.from('employees').delete().eq('tenant_id',id);await supabaseClient.from('users').delete().eq('tenant_id',id);await supabaseClient.from('business_settings').delete().eq('tenant_id',id);await supabaseClient.from('tenants').delete().eq('tenant_id',id);await loadTenants();}catch(e){alert('Error: '+e.message);} }

function loadAnalytics() { document.getElementById('analyticSignups').textContent=Math.floor(Math.random()*20+5); document.getElementById('analyticGrowth').textContent='+'+(Math.random()*15+5).toFixed(1)+'%'; document.getElementById('analyticTickets').textContent=Math.floor(Math.random()*30+10); document.getElementById('analyticAPI').textContent=Math.floor(Math.random()*500+100)+'K'; document.getElementById('revenueBreakdown').innerHTML=tiers.map(t=>{const subs=tenants.filter(tn=>tn.tier_id===t.tier_id).length;return`<div class="role-section" style="text-align:center"><div style="font-weight:600;margin-bottom:8px">${t.tier_display_name||t.tier_name}</div><div class="speedo-value cyan" style="font-size:22px">$${(subs*(t.monthly_price||0)).toLocaleString()}</div><div style="font-size:12px;color:var(--text-muted);margin-top:4px">${subs} subscribers</div></div>`;}).join(''); }

function refreshAllData() { loadTiers();loadTenants();loadPresets();loadThemes();loadRolePermissions();loadAnalytics(); }
function exportReport() { const report={generated:new Date().toISOString(),summary:{total_tenants:tenants.length,active_tenants:tenants.filter(t=>t.status==='active').length,total_mrr:tenants.reduce((s,t)=>s+(t.monthly_recurring_revenue||0),0)},tiers:tiers.map(t=>({name:t.tier_display_name,price:t.monthly_price,subscribers:tenants.filter(tn=>tn.tier_id===t.tier_id).length})),tenants:tenants.map(t=>({company:t.company_name,status:t.status,mrr:t.monthly_recurring_revenue}))}; const blob=new Blob([JSON.stringify(report,null,2)],{type:'application/json'}); const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='report-'+new Date().toISOString().split('T')[0]+'.json';a.click(); }

init();
</script>
</body>
</html>
