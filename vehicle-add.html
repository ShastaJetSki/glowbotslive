<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Add Vehicle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  
  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:0; font-family:system-ui; background:#0b0f14; color:#e8eef6; overflow-x:hidden; visibility:hidden; }
    body.auth-verified { visibility:visible; }
    
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }
    h3 { margin:16px 0 10px; font-size:14px; font-weight:700; color:#60a5fa; text-transform:uppercase; letter-spacing:0.5px; }
    
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:240px; }
    
    .card { 
      background:#0f1621; 
      border:2px solid #223044; 
      border-radius:12px; 
      padding:20px; 
      margin-bottom:16px;
      box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    label { 
      display:block; 
      font-size:12px; 
      color:#9fb0c3; 
      margin-bottom:6px; 
      font-weight:600; 
      text-transform:uppercase; 
      letter-spacing:0.5px; 
    }
    
    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #223044;
      background:#1a2535;
      color:#e8eef6;
      font-size:14px;
      outline:none;
      box-sizing:border-box;
    }
    input:focus, select:focus, textarea:focus { border-color:#3b82f6; }
    
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    textarea { min-height:90px; resize:vertical; }
    
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
      min-height: 44px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button:hover { background:#243648; }
    .primary { 
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }
    .primary:hover { 
      background:#2563eb; 
    }
    
    .muted { font-size:12px; color:#9fb0c3; }
    .error { color:#ffb3b3; }
    .success { color:#4ade80; }
    
    .autocomplete-dropdown {
      position: absolute;
      background: #1a2535;
      border: 1px solid #223044;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
      width: 100%;
      margin-top: 4px;
    }
    
    .autocomplete-dropdown.active {
      display: block;
    }
    
    .autocomplete-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #223044;
    }
    
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    .autocomplete-item:hover {
      background: #243648;
    }
    
    .autocomplete-item-title {
      font-size: 14px;
      font-weight: 600;
      color: #e8eef6;
    }
    
    .autocomplete-item-subtitle {
      font-size: 12px;
      color: #9fb0c3;
      margin-top: 2px;
    }
    
    /* Mobile Header */
    .mobile-header {
      display: none;
      background: #0f1621;
      border-bottom: 1px solid #223044;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .mobile-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
    }
    
    .mobile-menu-toggle {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: #6b7280;
      font-size: 20px;
      padding: 0;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mobile-header-center {
      flex: 1;
      margin-left: 12px;
    }
    
    .mobile-header-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-header { display: block; }
      
      .main-content {
        padding: 12px !important;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .col {
        min-width: 100%;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-header { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="goBack()">←</button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Add Vehicle</div>
      </div>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="desktop-header" style="position:sticky; top:0; z-index:100; background:#0b0f14; border-bottom:1px solid #223044;">
    <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
      <h1 style="margin:0; font-size:32px; font-weight:600;">Add Vehicle</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div style="padding:0 24px 12px;">
      <nav style="display:flex; gap:24px; overflow-x:auto;">
        <a href="dashboard-business.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Dashboard</a>
        <a href="dashboard-customer-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
        <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
        <a href="dashboard-settings.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Settings</a>
      </nav>
    </div>
    
    <div style="padding:0 24px 12px; border-top:1px solid #223044; padding-top:12px;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="goBack()" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Back</button>
        <button onclick="logout()" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Logout</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" style="padding:24px; max-width:1000px; margin:0 auto;">
    <div class="muted" id="hint" style="margin-bottom:16px;">Fill out the form below to add a new vehicle.</div>

    <div class="card" style="border-left: 4px solid #3b82f6;">
      <h2>Vehicle Information</h2>
      
      <!-- Customer Selection -->
      <h3>Select Customer</h3>
      <div class="col" style="max-width:100%;">
        <label>Customer *</label>
        <div style="position: relative;">
          <input 
            id="customerSearch" 
            type="text" 
            placeholder="Search customer by name, phone, or email..." 
            autocomplete="off"
            oninput="searchCustomers()"
            onfocus="searchCustomers()"
          />
          <div id="customerDropdown" class="autocomplete-dropdown"></div>
        </div>
        <div class="muted" style="margin-top:4px;">
          Selected: <span id="selectedCustomer" style="color:#60a5fa; font-weight:600;">None</span>
          <a href="#" onclick="clearCustomer(); return false;" style="color:#3b82f6; margin-left:8px; text-decoration:none;">Clear</a>
        </div>
      </div>
      
      <!-- Vehicle Basic Info -->
      <h3 style="margin-top:24px;">Basic Information</h3>
      <div class="row">
        <div class="col">
          <label>Year *</label>
          <input id="year" type="number" min="1900" max="2030" placeholder="2020" />
        </div>
        <div class="col">
          <label>Make *</label>
          <input id="make" type="text" placeholder="Toyota" />
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Model *</label>
          <input id="model" type="text" placeholder="Camry" />
        </div>
        <div class="col">
          <label>License Plate</label>
          <input id="plate" type="text" placeholder="ABC1234" />
        </div>
      </div>
      
      <!-- Additional Details -->
      <h3 style="margin-top:24px;">Additional Details (Optional)</h3>
      <div class="row">
        <div class="col">
          <label>VIN / CF Number</label>
          <input id="vin" type="text" placeholder="1HGBH41JXMN109186" maxlength="17" />
        </div>
        <div class="col">
          <label>Color</label>
          <input id="color" type="text" placeholder="Silver" />
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Engine</label>
          <input id="engine" type="text" placeholder="2.5L 4-Cyl" />
        </div>
        <div class="col">
          <label>Transmission</label>
          <input id="transmission" type="text" placeholder="Automatic" />
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Fleet Assignment</label>
          <select id="fleet">
            <option value="">None</option>
            <option value="Fleet 1">Fleet 1</option>
            <option value="Fleet 2">Fleet 2</option>
          </select>
        </div>
        <div class="col">
          <label>Unit Number</label>
          <input id="unit" type="text" placeholder="UNIT-001" />
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Vehicle Notes</label>
          <textarea id="notes" placeholder="Special equipment, known issues..."></textarea>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:20px; gap:12px;">
        <button onclick="goBack()">Cancel</button>
        <button class="primary" onclick="saveVehicle()">Save Vehicle</button>
      </div>

      <div id="msg" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let AUTH = null;
let TENANT_ID = null;
let customers = [];
let customersById = {};
let selectedCustomerId = null;

function goBack(){
  window.history.back();
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return null;

  const res = await fetch(`${API_BASE}/auth/v1/user`, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });

  if (!res.ok) return null;
  const user = await res.json();
  
  TENANT_ID = user?.user_metadata?.tenant_id || null;
  return token;
}

function searchCustomers(){
  const input = document.getElementById('customerSearch');
  const dropdown = document.getElementById('customerDropdown');
  const query = (input.value || '').trim().toLowerCase();
  
  if(query.length < 1){
    dropdown.classList.remove('active');
    return;
  }
  
  const matches = customers.filter(c => {
    const name = `${c.first_name||''} ${c.last_name||''}`.toLowerCase();
    const phone = (c.phone||'').toLowerCase();
    const email = (c.email||'').toLowerCase();
    return name.includes(query) || phone.includes(query) || email.includes(query);
  }).slice(0, 10);
  
  if(matches.length === 0){
    dropdown.innerHTML = '<div class="autocomplete-item">No customers found</div>';
    dropdown.classList.add('active');
    return;
  }
  
  dropdown.innerHTML = matches.map(c => {
    const name = `${c.first_name||''} ${c.last_name||''}`.trim() || 'Unknown';
    const subtitle = [c.phone, c.email].filter(Boolean).join(' • ');
    return `
      <div class="autocomplete-item" onclick="selectCustomer('${c.customer_id}')">
        <div class="autocomplete-item-title">${name}</div>
        ${subtitle ? `<div class="autocomplete-item-subtitle">${subtitle}</div>` : ''}
      </div>
    `;
  }).join('');
  
  dropdown.classList.add('active');
}

function selectCustomer(id){
  selectedCustomerId = id;
  const customer = customersById[id];
  const name = customer ? `${customer.first_name||''} ${customer.last_name||''}`.trim() : 'Unknown';
  
  document.getElementById('selectedCustomer').textContent = name;
  document.getElementById('customerSearch').value = name;
  document.getElementById('customerDropdown').classList.remove('active');
}

function clearCustomer(){
  selectedCustomerId = null;
  document.getElementById('selectedCustomer').textContent = 'None';
  document.getElementById('customerSearch').value = '';
  document.getElementById('customerDropdown').classList.remove('active');
}

document.addEventListener('click', function(e){
  if(!e.target.closest('#customerSearch') && !e.target.closest('#customerDropdown')){
    document.getElementById('customerDropdown').classList.remove('active');
  }
});

async function saveVehicle(){
  const msg = document.getElementById('msg');
  msg.textContent = '';
  msg.className = '';
  
  if(!selectedCustomerId){
    msg.textContent = 'Please select a customer';
    msg.className = 'error';
    return;
  }
  
  const year = document.getElementById('year').value.trim();
  const make = document.getElementById('make').value.trim();
  const model = document.getElementById('model').value.trim();
  
  if(!year || !make || !model){
    msg.textContent = 'Year, make, and model are required';
    msg.className = 'error';
    return;
  }
  
  try {
    msg.textContent = 'Saving vehicle...';
    msg.className = 'muted';
    
    const data = {
      tenant_id: TENANT_ID,
      customer_id: selectedCustomerId,
      year: parseInt(year),
      make: make,
      model: model,
      license_plate: document.getElementById('plate').value.trim() || null,
      vin_or_cf_number: document.getElementById('vin').value.trim() || null,
      color: document.getElementById('color').value.trim() || null,
      engine: document.getElementById('engine').value.trim() || null,
      transmission: document.getElementById('transmission').value.trim() || null,
      fleet: document.getElementById('fleet').value || null,
      unit_number: document.getElementById('unit').value.trim() || null,
      notes: document.getElementById('notes').value.trim() || null
    };
    
    const res = await fetch(`${REST_BASE}/vehicles`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${AUTH}`,
        'apikey': ANON_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(data)
    });
    
    if(!res.ok){
      const err = await res.text();
      throw new Error(err);
    }
    
    msg.textContent = '✓ Vehicle saved successfully! Redirecting...';
    msg.className = 'success';
    
    setTimeout(() => {
      location.href = 'dashboard-vehicle-search.html';
    }, 1000);
    
  } catch(err){
    console.error('Save error:', err);
    msg.textContent = `Error: ${err.message}`;
    msg.className = 'error';
  }
}

async function load(){
  const token = await validateAuth();
  if (!token) {
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
    return;
  }
  
  AUTH = token;
  document.body.classList.add('auth-verified');
  
  try {
    const hint = document.getElementById('hint');
    hint.textContent = 'Loading customers...';
    
    const res = await fetch(`${REST_BASE}/customers?select=*`, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });
    
    if(!res.ok) throw new Error(await res.text());
    
    customers = await res.json();
    customersById = {};
    customers.forEach(c => { if(c?.customer_id) customersById[c.customer_id] = c; });
    
    hint.textContent = 'Fill out the form below to add a new vehicle.';
    
  } catch(err){
    console.error('Load error:', err);
    document.getElementById('hint').textContent = `Error: ${err.message}`;
    document.getElementById('hint').className = 'error';
  }
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", load);
} else {
  load();
}
</script>

</body>
</html>
