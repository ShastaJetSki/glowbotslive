<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>New Work Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  
  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    /* ===== INLINE THEME DEFINITIONS ===== */
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8;
    }
    [data-theme="charcoal"] {
      --bg-primary: #121214; --bg-secondary: #18181b; --bg-card: #27272a; --bg-hover: #3f3f46;
      --border-default: #3f3f46; --text-primary: #fafafa; --text-secondary: #a1a1aa;
      --accent-primary: #a1a1aa; --accent-light: #d4d4d8;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80;
    }
    [data-theme="obsidian"] {
      --bg-primary: #050505; --bg-secondary: #0a0a0a; --bg-card: #141414; --bg-hover: #1c1c1c;
      --border-default: #252525; --text-primary: #e0e0e0; --text-secondary: #888888;
      --accent-primary: #0ea5e9; --accent-light: #38bdf8;
    }
    [data-theme="steel"] {
      --bg-primary: #0c0f13; --bg-secondary: #12161c; --bg-card: #1a2028; --bg-hover: #242c38;
      --border-default: #2c3644; --text-primary: #e4e8ed; --text-secondary: #8b95a5;
      --accent-primary: #64748b; --accent-light: #94a3b8;
    }
    [data-theme="espresso"] {
      --bg-primary: #0f0c0a; --bg-secondary: #161210; --bg-card: #211c18; --bg-hover: #2c2520;
      --border-default: #382f28; --text-primary: #f0ebe5; --text-secondary: #a89e94;
      --accent-primary: #a78b6e; --accent-light: #c4a88a;
    }
    [data-theme="onyx"] {
      --bg-primary: #000000; --bg-secondary: #080808; --bg-card: #121212; --bg-hover: #1a1a1a;
      --border-default: #222222; --text-primary: #f5f5f5; --text-secondary: #8c8c8c;
      --accent-primary: #06b6d4; --accent-light: #22d3ee;
    }
    /* ===== END THEME DEFINITIONS ===== */

    body { margin:0; padding:0; font-family:system-ui; background:var(--bg-primary); color:var(--text-primary); overflow-x:hidden; visibility:hidden; }
    body.auth-verified { visibility:visible; }
    
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }
    h3 { margin:16px 0 10px; font-size:14px; font-weight:700; color:var(--accent-light); text-transform:uppercase; letter-spacing:0.5px; }
    
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:240px; }
    
    /* Card styling */
    .card { 
      background:var(--bg-secondary); 
      border:2px solid var(--border-default); 
      border-radius:12px; 
      padding:20px; 
      margin-bottom:16px;
      box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    label { 
      display:block; 
      font-size:12px; 
      color:var(--text-secondary); 
      margin-bottom:6px; 
      font-weight:600; 
      text-transform:uppercase; 
      letter-spacing:0.5px; 
    }
    
    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border-default);
      background:var(--bg-card);
      color:var(--text-primary);
      font-size:14px;
      outline:none;
      box-sizing:border-box;
    }
    input:focus, select:focus, textarea:focus { border-color:var(--accent-primary); }
    
    /* Hide number input spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    textarea { min-height:90px; resize:vertical; }
    
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--border-default);
      background:var(--bg-card);
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
      min-height: 44px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button:hover { background:var(--bg-hover); }
    .primary { 
      background:var(--accent-primary); 
      border-color:var(--accent-primary);
      color:#fff;
    }
    .primary:hover { 
      opacity: 0.9;
    }
    .danger { 
      background:transparent; 
      border-color:transparent;
      border-width: 1px;
      color:#7f1d1d;
    }
    .danger:hover { 
      background:rgba(127, 29, 29, 0.1); 
    }
    
    .muted { font-size:12px; color:var(--text-secondary); }
    .error { color:#ffb3b3; }
    .success { color:#4ade80; }
    
    /* Autocomplete dropdown */
    .autocomplete-dropdown {
      position: absolute;
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
      width: 100%;
      margin-top: 4px;
    }
    
    .autocomplete-dropdown.active {
      display: block;
    }
    
    .autocomplete-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-default);
    }
    
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    .autocomplete-item:hover {
      background: var(--bg-hover);
    }
    
    .autocomplete-item-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .autocomplete-item-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    
    /* Accordion styles */
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      margin: 18px 0 10px;
    }

    .accordion-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .accordion-icon {
      font-size: 20px;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.active {
      max-height: 5000px;
    }

    /* Mobile Action Buttons */
    .mobile-action-buttons {
      display:none;
      position:fixed;
      bottom:102px;
      left:0;
      right:0;
      background:var(--bg-secondary);
      padding:8px 8px 0 8px;
      z-index:101;
    }

    .mobile-action-grid {
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:6px;
      margin-bottom:6px;
    }

    .mobile-action-btn {
      padding:10px 8px;
      border-radius:8px;
      border:1px solid var(--border-default);
      background:var(--bg-card);
      color:var(--text-secondary);
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      height:44px;
      box-sizing:border-box;
      text-decoration:none;
    }

    .mobile-action-btn:active {
      transform:scale(0.95);
      background:var(--bg-hover);
    }
    
    /* New Order button highlighted */
    .mobile-action-btn.active {
      background:var(--accent-primary);
      border-color:var(--accent-primary);
      color:#fff;
    }

    /* Mobile Bottom Nav */
    .mobile-bottom-nav {
      display:none;
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:var(--bg-secondary);
      padding:8px 8px 8px 8px;
      z-index:100;
    }

    .mobile-nav-grid {
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:6px;
      margin-bottom:6px;
    }

    .mobile-nav-secondary {
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:6px;
    }

    .mobile-nav-btn {
      padding:10px 8px;
      border-radius:8px;
      border:1px solid var(--border-default);
      background:var(--bg-card);
      color:var(--text-secondary);
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      height:44px;
      box-sizing:border-box;
    }

    .mobile-nav-btn.active {
      background:var(--accent-primary);
      border-color:var(--accent-primary);
      color:#fff;
    }

    .mobile-nav-btn:active {
      transform:scale(0.95);
    }

    .desktop-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-default);
    }
    
    .mobile-top-header {
      display: none;
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }

    .mobile-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
    }

    .mobile-menu-toggle {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 20px;
      padding: 0;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-header-center {
      flex: 1;
      margin-left: 12px;
    }

    .mobile-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .mobile-header-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .mobile-header-content.expanded {
      max-height: 200px;
    }

    .mobile-header-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 8px 12px 12px;
      background: var(--bg-primary);
      border-top: 1px solid var(--border-default);
    }

    .mobile-header-actions button {
      padding: 10px;
      font-size: 13px;
      background: var(--bg-card);
      border: 1px solid var(--accent-primary);
    }

    .accordion-icon-header {
      font-size: 20px;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .mobile-menu-toggle.active .accordion-icon-header {
      transform: rotate(180deg);
    }
    
    /* Toggle button styles */
    .toggle-btn-group {
      display:flex; 
      gap:8px; 
      margin-bottom:20px; 
      background:var(--bg-secondary); 
      padding:6px; 
      border-radius:12px; 
      border:1px solid var(--border-default);
    }
    
    .toggle-btn {
      flex:1; 
      padding:10px 16px; 
      border-radius:8px; 
      border:none; 
      background:transparent; 
      color:var(--text-secondary); 
      font-weight:600; 
      font-size:14px; 
      cursor:pointer; 
      transition: all 0.15s ease;
    }
    
    .toggle-btn.active {
      background:var(--bg-card); 
      color:var(--accent-light); 
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-btn.active-green {
      background:var(--bg-card); 
      color:#4ade80; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      .desktop-header { display:none !important; }
      .mobile-top-header { display:block; }
      .mobile-bottom-nav { display:block !important; }
      .mobile-action-buttons { display:block !important; }
      
      .main-content {
        padding: 12px !important;
      }
      
      body {
        padding-bottom:165px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .col {
        min-width: 100%;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display:none !important; }
      .mobile-bottom-nav { display:none !important; }
      .mobile-action-buttons { display:none !important; }
    }
  </style>
</head>

<body>
  <!-- Mobile Top Header -->
  <div class="mobile-top-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">
        <span class="accordion-icon-header">â˜°</span>
      </button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">New Work Order</div>
      </div>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-actions">
        <button onclick="location.href='dashboard-service.html'">Service</button>
        <button onclick="location.href='dashboard-parts.html'">Parts</button>
        <button onclick="location.href='dashboard-sales.html'">Sales</button>
      </div>
    </div>
  </div>

  <!-- Desktop Sticky Header -->
  <div class="desktop-header">
    <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
      <h1 style="margin:0; font-size:32px; font-weight:600;">New Work Order</h1>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
    </div>
    
    <div style="padding:0 24px 12px;">
      <nav style="display:flex; gap:24px; overflow-x:auto;">
        <a href="dashboard-business.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Dashboard</a>
        <a href="dashboard-customer-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
        <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
        <a href="dashboard-settings.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Settings</a>
      </nav>
    </div>
    
    <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="location.href='dashboard-service.html'" style="padding:8px 16px; background:var(--accent-primary); border:1px solid var(--accent-primary); color:#fff; border-radius:8px; cursor:pointer; font-size:14px;">Service</button>
        <button onclick="location.href='dashboard-parts.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer; font-size:14px;">Parts</button>
        <button onclick="location.href='dashboard-sales.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer; font-size:14px;">Sales</button>
      </div>
    </div>
  </div>

  <!-- Mobile Action Buttons -->
  <div class="mobile-action-buttons">
    <div class="mobile-action-grid">
      <button class="mobile-action-btn active" onclick="location.href='work-order-new.html'">New Order</button>
      <button class="mobile-action-btn" onclick="location.href='dashboard-scheduling.html'">Scheduler</button>
      <button class="mobile-action-btn" onclick="location.href='dashboard-fleet-settings.html'">Fleet</button>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <div class="mobile-bottom-nav">
    <div class="mobile-nav-grid">
      <a href="dashboard-business.html" class="mobile-nav-btn">Dashboard</a>
      <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
      <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
      <a href="dashboard-settings.html" class="mobile-nav-btn">Settings</a>
    </div>
    <div class="mobile-nav-secondary">
      <a href="dashboard-service.html" class="mobile-nav-btn active">Service</a>
      <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
      <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
    </div>
  </div>

  <!-- Main Content (Scrollable) -->
  <div class="main-content" style="padding:24px;">
    <div class="muted" id="hint" style="margin-bottom:16px;">Fill out the form below to create a new work order.</div>

    <!-- Customer & Vehicle Selection -->
    <div class="card" style="border-left: 4px solid var(--accent-primary);">
      <h2>Customer & Vehicle Information</h2>
      
      <!-- Customer Type Toggle -->
      <div class="toggle-btn-group">
        <button 
          id="btnExistingCustomer" 
          class="toggle-btn active" 
          onclick="setCustomerType('existing')"
        >
          Existing Customer
        </button>
        <button 
          id="btnNewCustomer" 
          class="toggle-btn" 
          onclick="setCustomerType('new')"
        >
          + New Customer
        </button>
      </div>
      
      <!-- EXISTING CUSTOMER SECTION -->
      <div id="existingCustomerSection">
        <div class="row">
          <div class="col">
            <label>Search Existing Customer *</label>
            <div style="position: relative;">
              <input 
                id="customerSearch" 
                type="text" 
                placeholder="Search customer by name, phone, or email..." 
                autocomplete="off"
                oninput="searchCustomers()"
                onfocus="searchCustomers()"
              />
              <div id="customerDropdown" class="autocomplete-dropdown"></div>
            </div>
            <div class="muted" style="margin-top:4px;">
              Selected: <span id="selectedCustomer" style="color:var(--accent-light); font-weight:600;">None</span>
              <a href="#" onclick="clearCustomer(); return false;" style="color:var(--accent-primary); margin-left:8px; text-decoration:none;">Clear</a>
            </div>
          </div>
        </div>
        
        <!-- Vehicle Section - Only shows when customer is selected -->
        <div id="existingCustomerVehicleSection" style="display:none; margin-top:20px; padding-top:20px; border-top:1px solid var(--border-default);">
          <h3 style="margin-bottom:16px;">Vehicle Selection</h3>
          
          <!-- Vehicle Type Toggle -->
          <div class="toggle-btn-group" style="display:inline-flex;">
            <button 
              id="btnExistingVehicle" 
              class="toggle-btn active" 
              onclick="setVehicleType('existing')"
              style="padding:8px 12px; font-size:13px;"
            >
              Customer's Vehicles
            </button>
            <button 
              id="btnNewVehicleForCustomer" 
              class="toggle-btn" 
              onclick="setVehicleType('new')"
              style="padding:8px 12px; font-size:13px;"
            >
              + Add New Vehicle
            </button>
          </div>
          
          <!-- Existing Vehicle Search -->
          <div id="existingVehicleSearch">
            <div class="col" style="max-width:100%;">
              <label>Select Vehicle *</label>
              <div style="position: relative;">
                <input 
                  id="vehicleSearch" 
                  type="text" 
                  placeholder="Search customer's vehicles..." 
                  autocomplete="off"
                  oninput="searchVehicles()"
                  onfocus="searchVehicles()"
                />
                <div id="vehicleDropdown" class="autocomplete-dropdown"></div>
              </div>
              <div class="muted" style="margin-top:4px;">
                Selected: <span id="selectedVehicle" style="color:var(--accent-light); font-weight:600;">None</span>
                <a href="#" onclick="clearVehicle(); return false;" style="color:var(--accent-primary); margin-left:8px; text-decoration:none;">Clear</a>
              </div>
            </div>
          </div>
          
          <!-- New Vehicle Form for Existing Customer -->
          <div id="newVehicleForCustomerSection" style="display:none;">
            <div class="row">
              <div class="col">
                <label>Year *</label>
                <input id="existing_customer_new_vehicle_year" type="number" min="1900" max="2030" placeholder="2020" />
              </div>
              <div class="col">
                <label>Make *</label>
                <input id="existing_customer_new_vehicle_make" type="text" placeholder="Toyota" />
              </div>
            </div>
            
            <div class="row" style="margin-top:12px;">
              <div class="col">
                <label>Model *</label>
                <input id="existing_customer_new_vehicle_model" type="text" placeholder="Camry" />
              </div>
              <div class="col">
                <label>License Plate</label>
                <input id="existing_customer_new_vehicle_plate" type="text" placeholder="ABC1234" />
              </div>
            </div>
            
            <div class="row" style="margin-top:12px;">
              <div class="col">
                <label>VIN / CF Number</label>
                <input id="existing_customer_new_vehicle_vin" type="text" placeholder="1HGBH41JXMN109186" maxlength="17" />
              </div>
              <div class="col">
                <label>Color</label>
                <input id="existing_customer_new_vehicle_color" type="text" placeholder="Silver" />
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- NEW CUSTOMER SECTION -->
      <div id="newCustomerSection" style="display:none;">
        
        <!-- Quick Entry Mode Toggle -->
        <div class="toggle-btn-group" style="display:inline-flex; margin-bottom:20px;">
          <button 
            id="btnQuickEntry" 
            class="toggle-btn active-green" 
            onclick="setEntryMode('quick')"
            style="padding:8px 14px; font-size:13px;"
          >
            âš¡ Quick Entry
          </button>
          <button 
            id="btnDetailedEntry" 
            class="toggle-btn" 
            onclick="setEntryMode('detailed')"
            style="padding:8px 14px; font-size:13px;"
          >
            ðŸ“‹ Detailed Onboarding
          </button>
        </div>
        
        <!-- CUSTOMER BASIC INFO (Always Visible) -->
        <h3>Customer Basic Information</h3>
        <div class="row">
          <div class="col">
            <label>First Name *</label>
            <input id="new_customer_first_name" type="text" placeholder="John" />
          </div>
          <div class="col">
            <label>Last Name *</label>
            <input id="new_customer_last_name" type="text" placeholder="Smith" />
          </div>
        </div>
        
        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Phone Number *</label>
            <input id="new_customer_phone" type="tel" placeholder="(555) 123-4567" />
          </div>
          <div class="col">
            <label>Email Address</label>
            <input id="new_customer_email" type="email" placeholder="john@example.com" />
          </div>
        </div>
        
        <!-- CUSTOMER DETAILED INFO (Collapsible) -->
        <div id="detailedCustomerSection" style="display:none;">
          <h3>Additional Customer Details</h3>
          <div class="row">
            <div class="col">
              <label>Company Name</label>
              <input id="new_customer_company" type="text" placeholder="ABC Corp" />
            </div>
            <div class="col">
              <label>Customer Type</label>
              <select id="new_customer_type">
                <option value="individual">Individual</option>
                <option value="business">Business</option>
                <option value="fleet">Fleet</option>
              </select>
            </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col">
              <label>Street Address</label>
              <input id="new_customer_address" type="text" placeholder="123 Main St" />
            </div>
            <div class="col">
              <label>City</label>
              <input id="new_customer_city" type="text" placeholder="Sacramento" />
            </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col">
              <label>State / Province</label>
              <input id="new_customer_state" type="text" placeholder="CA" />
            </div>
            <div class="col">
              <label>ZIP / Postal Code</label>
              <input id="new_customer_zip" type="text" placeholder="95814" />
            </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col">
              <label>Customer Notes</label>
              <textarea id="new_customer_notes" placeholder="Preferred contact method, special instructions..."></textarea>
            </div>
          </div>
        </div>
        
        <!-- VEHICLE BASIC INFO (Always Visible for New Customer) -->
        <h3 style="margin-top:24px;">Vehicle Basic Information</h3>
        <div class="row">
          <div class="col">
            <label>Year *</label>
            <input id="new_vehicle_year" type="number" min="1900" max="2030" placeholder="2020" />
          </div>
          <div class="col">
            <label>Make *</label>
            <input id="new_vehicle_make" type="text" placeholder="Toyota" />
          </div>
        </div>
        
        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Model *</label>
            <input id="new_vehicle_model" type="text" placeholder="Camry" />
          </div>
          <div class="col">
            <label>License Plate</label>
            <input id="new_vehicle_plate" type="text" placeholder="ABC1234" />
          </div>
        </div>
        
        <!-- VEHICLE DETAILED INFO (Collapsible) -->
        <div id="detailedVehicleSection" style="display:none;">
          <h3>Additional Vehicle Details</h3>
          <div class="row">
            <div class="col">
              <label>VIN / CF Number</label>
              <input id="new_vehicle_vin" type="text" placeholder="1HGBH41JXMN109186" maxlength="17" />
            </div>
            <div class="col">
              <label>Color</label>
              <input id="new_vehicle_color" type="text" placeholder="Silver" />
            </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col">
              <label>Engine</label>
              <input id="new_vehicle_engine" type="text" placeholder="2.5L 4-Cyl" />
            </div>
            <div class="col">
              <label>Transmission</label>
              <input id="new_vehicle_transmission" type="text" placeholder="Automatic" />
            </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col">
              <label>Fleet Assignment</label>
              <select id="new_vehicle_fleet">
                <option value="">None</option>
                <option value="Fleet 1">Fleet 1</option>
                <option value="Fleet 2">Fleet 2</option>
              </select>
            </div>
            <div class="col">
              <label>Unit Number</label>
              <input id="new_vehicle_unit" type="text" placeholder="UNIT-001" />
            </div>
          </div>
          
          <div class="row" style="margin-top:12px;">
            <div class="col">
              <label>Vehicle Notes</label>
              <textarea id="new_vehicle_notes" placeholder="Special equipment, known issues..."></textarea>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <!-- Work Order Details -->
    <button class="accordion-header active" onclick="toggleAccordion(this)">
      <h2>Work Order Details</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content active">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>Status</label>
            <select id="status">
              <option value="draft">Draft</option>
              <option value="scheduled" selected>Scheduled</option>
              <option value="diagnosis_required">Diagnosis Required</option>
              <option value="awaiting_parts">Awaiting Parts</option>
              <option value="customer_approval">Customer Approval</option>
              <option value="in_progress">In Progress</option>
              <option value="repairing">Repairing</option>
              <option value="testing">Testing</option>
              <option value="ready_for_pickup">Ready for Pickup</option>
              <option value="completed">Completed</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div class="col">
            <label>Priority</label>
            <select id="priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="col">
            <label>Assigned To</label>
            <select id="assigned_employee_id">
              <option value="">Unassigned</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Scheduled Start *</label>
            <input id="scheduled_start" type="datetime-local" />
          </div>
          <div class="col">
            <label>Scheduled End</label>
            <input id="scheduled_end" type="datetime-local" />
          </div>
          <div class="col">
            <label>Vehicle Arrived</label>
            <input id="vehicle_arrived_at" type="datetime-local" />
            <div class="muted" style="margin-top:4px;">When vehicle arrived at shop</div>
          </div>
          <div class="col">
            <label>Customer Deadline</label>
            <input id="customer_deadline" type="datetime-local" />
            <div class="muted" style="margin-top:4px;">Customer requested completion</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Odometer / Hours</label>
            <input id="odometer" type="number" min="0" step="1" placeholder="12345" />
            <div class="muted" style="margin-top:4px;">Current mileage or engine hours</div>
          </div>
          <div class="col">
            <label>Shop Tag / Reference</label>
            <input id="reference" type="text" placeholder="WO-2025-001" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Customer Concern / Notes</label>
            <textarea id="customer_notes" placeholder="Customer states: check engine light is on..."></textarea>
          </div>
          <div class="col">
            <label>Internal Notes</label>
            <textarea id="internal_notes" placeholder="Tech notes, advisor notes..."></textarea>
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:16px; gap:12px;">
          <button onclick="cancelNew()">Cancel</button>
          <button class="primary" onclick="createWorkOrder()">Create Work Order</button>
        </div>

        <div id="msg" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

<script>
// Theme support
function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let AUTH = null;
let TENANT_ID = null;

let customers = [];
let customersById = {};
let vehicles = [];
let vehiclesById = {};
let employees = [];

let selectedCustomerId = null;
let selectedVehicleId = null;
let customerType = 'existing';
let vehicleType = 'existing';
let entryMode = 'quick';

function toggleMobileMenu(button) {
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
  button.classList.toggle('active');
}

function toggleAccordion(button) {
  const content = button.nextElementSibling;
  button.classList.toggle('active');
  content.classList.toggle('active');
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function cancelNew(){
  location.href = "dashboard-service.html";
}

function setCustomerType(type){
  customerType = type;
  
  const btnExisting = document.getElementById('btnExistingCustomer');
  const btnNew = document.getElementById('btnNewCustomer');
  const existingSection = document.getElementById('existingCustomerSection');
  const newSection = document.getElementById('newCustomerSection');
  
  if(type === 'existing'){
    btnExisting.classList.add('active');
    btnNew.classList.remove('active');
    btnNew.classList.remove('active-green');
    
    existingSection.style.display = 'block';
    newSection.style.display = 'none';
    
    clearNewCustomerFields();
  } else {
    btnNew.classList.add('active-green');
    btnExisting.classList.remove('active');
    
    existingSection.style.display = 'none';
    newSection.style.display = 'block';
    
    clearCustomer();
    clearVehicle();
  }
}

function setVehicleType(type){
  vehicleType = type;
  
  const btnExisting = document.getElementById('btnExistingVehicle');
  const btnNew = document.getElementById('btnNewVehicleForCustomer');
  const existingVehicleSearch = document.getElementById('existingVehicleSearch');
  const newVehicleSection = document.getElementById('newVehicleForCustomerSection');
  
  if(type === 'existing'){
    btnExisting.classList.add('active');
    btnNew.classList.remove('active');
    btnNew.classList.remove('active-green');
    
    existingVehicleSearch.style.display = 'block';
    newVehicleSection.style.display = 'none';
    
    clearNewVehicleForCustomerFields();
  } else {
    btnNew.classList.add('active-green');
    btnExisting.classList.remove('active');
    
    existingVehicleSearch.style.display = 'none';
    newVehicleSection.style.display = 'block';
    
    clearVehicle();
  }
}

function setEntryMode(mode){
  entryMode = mode;
  
  const btnQuick = document.getElementById('btnQuickEntry');
  const btnDetailed = document.getElementById('btnDetailedEntry');
  const detailedCustomerSection = document.getElementById('detailedCustomerSection');
  const detailedVehicleSection = document.getElementById('detailedVehicleSection');
  
  if(mode === 'quick'){
    btnQuick.classList.add('active-green');
    btnDetailed.classList.remove('active');
    
    detailedCustomerSection.style.display = 'none';
    detailedVehicleSection.style.display = 'none';
  } else {
    btnDetailed.classList.add('active');
    btnQuick.classList.remove('active-green');
    
    detailedCustomerSection.style.display = 'block';
    detailedVehicleSection.style.display = 'block';
  }
}

function clearNewVehicleForCustomerFields(){
  document.getElementById('existing_customer_new_vehicle_year').value = '';
  document.getElementById('existing_customer_new_vehicle_make').value = '';
  document.getElementById('existing_customer_new_vehicle_model').value = '';
  document.getElementById('existing_customer_new_vehicle_plate').value = '';
  document.getElementById('existing_customer_new_vehicle_vin').value = '';
  document.getElementById('existing_customer_new_vehicle_color').value = '';
}

function clearNewCustomerFields(){
  document.getElementById('new_customer_first_name').value = '';
  document.getElementById('new_customer_last_name').value = '';
  document.getElementById('new_customer_phone').value = '';
  document.getElementById('new_customer_email').value = '';
  document.getElementById('new_customer_company').value = '';
  document.getElementById('new_customer_type').value = 'individual';
  document.getElementById('new_customer_address').value = '';
  document.getElementById('new_customer_city').value = '';
  document.getElementById('new_customer_state').value = '';
  document.getElementById('new_customer_zip').value = '';
  document.getElementById('new_customer_notes').value = '';
  
  document.getElementById('new_vehicle_year').value = '';
  document.getElementById('new_vehicle_make').value = '';
  document.getElementById('new_vehicle_model').value = '';
  document.getElementById('new_vehicle_plate').value = '';
  document.getElementById('new_vehicle_vin').value = '';
  document.getElementById('new_vehicle_color').value = '';
  document.getElementById('new_vehicle_engine').value = '';
  document.getElementById('new_vehicle_transmission').value = '';
  document.getElementById('new_vehicle_fleet').value = '';
  document.getElementById('new_vehicle_unit').value = '';
  document.getElementById('new_vehicle_notes').value = '';
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return null;

  const res = await fetch(`${API_BASE}/auth/v1/user`, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });

  if (!res.ok) return null;
  const user = await res.json();
  
  // Try to get tenant_id from user metadata first
  TENANT_ID = user?.user_metadata?.tenant_id || null;
  
  // If not in metadata, try to get from business_settings
  if (!TENANT_ID) {
    try {
      const settingsRes = await fetch(`${REST_BASE}/business_settings?select=tenant_id&limit=1`, {
        headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
      });
      if (settingsRes.ok) {
        const settings = await settingsRes.json();
        if (settings && settings[0]?.tenant_id) {
          TENANT_ID = settings[0].tenant_id;
        }
      }
    } catch (e) {
      console.log('Could not fetch tenant_id from business_settings');
    }
  }
  
  return token;
}

async function fetchJson(url, token){
  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function fetchTable(table, token){
  const res = await fetch(`${REST_BASE}/${table}?select=*`, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function searchCustomers(){
  const input = document.getElementById('customerSearch');
  const dropdown = document.getElementById('customerDropdown');
  const query = (input.value || '').trim().toLowerCase();
  
  if(query.length < 1){
    dropdown.classList.remove('active');
    return;
  }
  
  const matches = customers.filter(c => {
    const name = `${c.first_name||''} ${c.last_name||''}`.toLowerCase();
    const phone = (c.phone||'').toLowerCase();
    const email = (c.email||'').toLowerCase();
    return name.includes(query) || phone.includes(query) || email.includes(query);
  }).slice(0, 10);
  
  if(matches.length === 0){
    dropdown.innerHTML = '<div class="autocomplete-item">No customers found</div>';
    dropdown.classList.add('active');
    return;
  }
  
  dropdown.innerHTML = matches.map(c => {
    const name = `${c.first_name||''} ${c.last_name||''}`.trim() || 'Unknown';
    const subtitle = [c.phone, c.email].filter(Boolean).join(' â€¢ ');
    return `
      <div class="autocomplete-item" onclick="selectCustomer('${c.customer_id}')">
        <div class="autocomplete-item-title">${name}</div>
        ${subtitle ? `<div class="autocomplete-item-subtitle">${subtitle}</div>` : ''}
      </div>
    `;
  }).join('');
  
  dropdown.classList.add('active');
}

function selectCustomer(id){
  selectedCustomerId = id;
  const customer = customersById[id];
  const name = customer ? `${customer.first_name||''} ${customer.last_name||''}`.trim() : 'Unknown';
  
  document.getElementById('selectedCustomer').textContent = name;
  document.getElementById('customerSearch').value = name;
  document.getElementById('customerDropdown').classList.remove('active');
  
  const vehicleSection = document.getElementById('existingCustomerVehicleSection');
  if(vehicleSection){
    vehicleSection.style.display = 'block';
  }
  
  vehicleType = 'existing';
  setVehicleType('existing');
  clearVehicle();
  
  document.getElementById('vehicleSearch').value = '';
}

function clearCustomer(){
  selectedCustomerId = null;
  document.getElementById('selectedCustomer').textContent = 'None';
  document.getElementById('customerSearch').value = '';
  document.getElementById('customerDropdown').classList.remove('active');
  
  const vehicleSection = document.getElementById('existingCustomerVehicleSection');
  if(vehicleSection){
    vehicleSection.style.display = 'none';
  }
  
  clearVehicle();
  clearNewVehicleForCustomerFields();
}

function searchVehicles(){
  const input = document.getElementById('vehicleSearch');
  const dropdown = document.getElementById('vehicleDropdown');
  const query = (input.value || '').trim().toLowerCase();
  
  let customerVehicles = vehicles;
  if(selectedCustomerId){
    customerVehicles = vehicles.filter(v => v.customer_id === selectedCustomerId);
  }
  
  if(query.length < 1){
    if(customerVehicles.length === 0){
      dropdown.innerHTML = '<div class="autocomplete-item" style="color:var(--text-secondary); font-style:italic;">No vehicles found for this customer</div>';
      dropdown.classList.add('active');
      return;
    }
    
    dropdown.innerHTML = customerVehicles.slice(0, 10).map(v => {
      const desc = `${v.year||''} ${v.make||''} ${v.model||''}`.trim() || 'Unknown Vehicle';
      const subtitle = [v.license_plate, v.vin_or_cf_number].filter(Boolean).join(' â€¢ ');
      return `
        <div class="autocomplete-item" onclick="selectVehicle('${v.vehicle_id}')">
          <div class="autocomplete-item-title">${desc}</div>
          ${subtitle ? `<div class="autocomplete-item-subtitle">${subtitle}</div>` : ''}
        </div>
      `;
    }).join('');
    dropdown.classList.add('active');
    return;
  }
  
  const matches = customerVehicles.filter(v => {
    const desc = `${v.year||''} ${v.make||''} ${v.model||''}`.toLowerCase();
    const vin = (v.vin_or_cf_number||'').toLowerCase();
    const plate = (v.license_plate||'').toLowerCase();
    return desc.includes(query) || vin.includes(query) || plate.includes(query);
  }).slice(0, 10);
  
  if(matches.length === 0){
    dropdown.innerHTML = '<div class="autocomplete-item" style="color:var(--text-secondary); font-style:italic;">No matching vehicles found</div>';
    dropdown.classList.add('active');
    return;
  }
  
  dropdown.innerHTML = matches.map(v => {
    const desc = `${v.year||''} ${v.make||''} ${v.model||''}`.trim() || 'Unknown Vehicle';
    const subtitle = [v.license_plate, v.vin_or_cf_number].filter(Boolean).join(' â€¢ ');
    return `
      <div class="autocomplete-item" onclick="selectVehicle('${v.vehicle_id}')">
        <div class="autocomplete-item-title">${desc}</div>
        ${subtitle ? `<div class="autocomplete-item-subtitle">${subtitle}</div>` : ''}
      </div>
    `;
  }).join('');
  
  dropdown.classList.add('active');
}

function selectVehicle(id){
  selectedVehicleId = id;
  const vehicle = vehiclesById[id];
  const desc = vehicle ? `${vehicle.year||''} ${vehicle.make||''} ${vehicle.model||''}`.trim() : 'Unknown';
  
  document.getElementById('selectedVehicle').textContent = desc;
  document.getElementById('vehicleSearch').value = desc;
  document.getElementById('vehicleDropdown').classList.remove('active');
}

function clearVehicle(){
  selectedVehicleId = null;
  document.getElementById('selectedVehicle').textContent = 'None';
  document.getElementById('vehicleSearch').value = '';
  document.getElementById('vehicleDropdown').classList.remove('active');
}

document.addEventListener('click', function(e){
  if(!e.target.closest('#customerSearch') && !e.target.closest('#customerDropdown')){
    document.getElementById('customerDropdown').classList.remove('active');
  }
  if(!e.target.closest('#vehicleSearch') && !e.target.closest('#vehicleDropdown')){
    document.getElementById('vehicleDropdown').classList.remove('active');
  }
});

async function createWorkOrder(){
  const msg = document.getElementById('msg');
  msg.textContent = '';
  msg.className = '';
  
  if(customerType === 'existing'){
    if(!selectedCustomerId){
      msg.textContent = 'Please select a customer';
      msg.className = 'error';
      return;
    }
    
    if(vehicleType === 'existing'){
      if(!selectedVehicleId){
        msg.textContent = 'Please select a vehicle';
        msg.className = 'error';
        return;
      }
    } else {
      const year = document.getElementById('existing_customer_new_vehicle_year').value.trim();
      const make = document.getElementById('existing_customer_new_vehicle_make').value.trim();
      const model = document.getElementById('existing_customer_new_vehicle_model').value.trim();
      
      if(!year || !make || !model){
        msg.textContent = 'Vehicle year, make, and model are required';
        msg.className = 'error';
        return;
      }
    }
  } else {
    const firstName = document.getElementById('new_customer_first_name').value.trim();
    const lastName = document.getElementById('new_customer_last_name').value.trim();
    const phone = document.getElementById('new_customer_phone').value.trim();
    
    if(!firstName || !lastName){
      msg.textContent = 'Customer first name and last name are required';
      msg.className = 'error';
      return;
    }
    
    if(!phone){
      msg.textContent = 'Customer phone number is required';
      msg.className = 'error';
      return;
    }
    
    const year = document.getElementById('new_vehicle_year').value.trim();
    const make = document.getElementById('new_vehicle_make').value.trim();
    const model = document.getElementById('new_vehicle_model').value.trim();
    
    if(!year || !make || !model){
      msg.textContent = 'Vehicle year, make, and model are required';
      msg.className = 'error';
      return;
    }
  }
  
  const scheduled_start = document.getElementById('scheduled_start').value;
  if(!scheduled_start){
    msg.textContent = 'Please select a scheduled start date/time';
    msg.className = 'error';
    return;
  }
  
  try {
    msg.textContent = 'Creating work order...';
    msg.className = 'muted';
    
    let customerId = selectedCustomerId;
    let vehicleId = selectedVehicleId;
    
    // Build base data object - only include tenant_id if we have one
    const baseData = TENANT_ID ? { tenant_id: TENANT_ID } : {};
    
    if(customerType === 'new'){
      msg.textContent = 'Creating new customer...';
      
      const customerData = {
        ...baseData,
        first_name: document.getElementById('new_customer_first_name').value.trim(),
        last_name: document.getElementById('new_customer_last_name').value.trim(),
        phone: document.getElementById('new_customer_phone').value.trim(),
        email: document.getElementById('new_customer_email').value.trim() || null,
        company_name: document.getElementById('new_customer_company').value.trim() || null,
        customer_type: document.getElementById('new_customer_type').value || 'individual',
        address: document.getElementById('new_customer_address').value.trim() || null,
        city: document.getElementById('new_customer_city').value.trim() || null,
        state: document.getElementById('new_customer_state').value.trim() || null,
        zip: document.getElementById('new_customer_zip').value.trim() || null,
        notes: document.getElementById('new_customer_notes').value.trim() || null
      };
      
      const custRes = await fetch(`${REST_BASE}/customers`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${AUTH}`,
          'apikey': ANON_KEY,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(customerData)
      });
      
      if(!custRes.ok){
        const err = await custRes.text();
        throw new Error(`Failed to create customer: ${err}`);
      }
      
      const createdCustomer = await custRes.json();
      customerId = createdCustomer[0]?.customer_id;
      
      if(!customerId){
        throw new Error('Customer created but no ID returned');
      }
      
      msg.textContent = 'Creating new vehicle...';
      
      const vehicleData = {
        ...baseData,
        customer_id: customerId,
        year: parseInt(document.getElementById('new_vehicle_year').value),
        make: document.getElementById('new_vehicle_make').value.trim(),
        model: document.getElementById('new_vehicle_model').value.trim(),
        license_plate: document.getElementById('new_vehicle_plate').value.trim() || null,
        vin_or_cf_number: document.getElementById('new_vehicle_vin').value.trim() || null,
        color: document.getElementById('new_vehicle_color').value.trim() || null,
        engine: document.getElementById('new_vehicle_engine').value.trim() || null,
        transmission: document.getElementById('new_vehicle_transmission').value.trim() || null,
        fleet: document.getElementById('new_vehicle_fleet').value || null,
        unit_number: document.getElementById('new_vehicle_unit').value.trim() || null,
        notes: document.getElementById('new_vehicle_notes').value.trim() || null
      };
      
      const vehRes = await fetch(`${REST_BASE}/vehicles`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${AUTH}`,
          'apikey': ANON_KEY,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(vehicleData)
      });
      
      if(!vehRes.ok){
        const err = await vehRes.text();
        throw new Error(`Failed to create vehicle: ${err}`);
      }
      
      const createdVehicle = await vehRes.json();
      vehicleId = createdVehicle[0]?.vehicle_id;
      
      if(!vehicleId){
        throw new Error('Vehicle created but no ID returned');
      }
    }
    else if(customerType === 'existing' && vehicleType === 'new'){
      msg.textContent = 'Adding new vehicle to customer...';
      
      const vehicleData = {
        ...baseData,
        customer_id: customerId,
        year: parseInt(document.getElementById('existing_customer_new_vehicle_year').value),
        make: document.getElementById('existing_customer_new_vehicle_make').value.trim(),
        model: document.getElementById('existing_customer_new_vehicle_model').value.trim(),
        license_plate: document.getElementById('existing_customer_new_vehicle_plate').value.trim() || null,
        vin_or_cf_number: document.getElementById('existing_customer_new_vehicle_vin').value.trim() || null,
        color: document.getElementById('existing_customer_new_vehicle_color').value.trim() || null
      };
      
      const vehRes = await fetch(`${REST_BASE}/vehicles`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${AUTH}`,
          'apikey': ANON_KEY,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(vehicleData)
      });
      
      if(!vehRes.ok){
        const err = await vehRes.text();
        throw new Error(`Failed to create vehicle: ${err}`);
      }
      
      const createdVehicle = await vehRes.json();
      vehicleId = createdVehicle[0]?.vehicle_id;
      
      if(!vehicleId){
        throw new Error('Vehicle created but no ID returned');
      }
    }
    
    msg.textContent = 'Creating work order...';
    
    const data = {
      ...baseData,
      customer_id: customerId,
      vehicle_id: vehicleId,
      status: document.getElementById('status').value || 'scheduled',
      priority: document.getElementById('priority').value || 'medium',
      assigned_employee_id: document.getElementById('assigned_employee_id').value || null,
      scheduled_start: scheduled_start,
      scheduled_end: document.getElementById('scheduled_end').value || null,
      vehicle_arrived_at: document.getElementById('vehicle_arrived_at').value || null,
      customer_deadline: document.getElementById('customer_deadline').value || null,
      odometer: parseInt(document.getElementById('odometer').value) || null,
      reference: document.getElementById('reference').value || null,
      customer_notes: document.getElementById('customer_notes').value || null,
      internal_notes: document.getElementById('internal_notes').value || null
    };
    
    const res = await fetch(`${REST_BASE}/work_orders`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${AUTH}`,
        'apikey': ANON_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(data)
    });
    
    if(!res.ok){
      const err = await res.text();
      throw new Error(err);
    }
    
    const created = await res.json();
    const woId = created[0]?.work_order_id || created[0]?.id;
    
    msg.textContent = 'âœ“ Work order created successfully! Redirecting...';
    msg.className = 'success';
    
    setTimeout(() => {
      location.href = `work-order-edit.html?id=${woId}`;
    }, 1000);
    
  } catch(err){
    console.error('Create error:', err);
    msg.textContent = `Error: ${err.message}`;
    msg.className = 'error';
  }
}

async function load(){
  const token = await validateAuth();
  if (!token) {
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
    return;
  }
  
  AUTH = token;
  document.body.classList.add('auth-verified');
  
  try {
    const hint = document.getElementById('hint');
    hint.textContent = 'Loading customers and vehicles...';
    
    // Load customers and vehicles first (these use REST API)
    const [cust, veh] = await Promise.all([
      fetchTable('customers', token),
      fetchTable('vehicles', token)
    ]);
    
    customers = Array.isArray(cust) ? cust : [];
    customersById = {};
    customers.forEach(c => { if(c?.customer_id) customersById[c.customer_id] = c; });
    
    vehicles = Array.isArray(veh) ? veh : [];
    vehiclesById = {};
    vehicles.forEach(v => { if(v?.vehicle_id) vehiclesById[v.vehicle_id] = v; });
    
    // Try to load employees separately (uses Edge Function which may fail)
    try {
      const emp = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);
      employees = Array.isArray(emp) ? emp : [];
    } catch (empErr) {
      console.log('Could not load employees:', empErr.message);
      // Try fetching from employees table directly as fallback
      try {
        const empDirect = await fetchTable('employees', token);
        employees = Array.isArray(empDirect) ? empDirect : [];
      } catch (e) {
        employees = [];
      }
    }
    
    const empSelect = document.getElementById('assigned_employee_id');
    empSelect.innerHTML = '<option value="">Unassigned</option>' + 
      employees
        .filter(e => e.role === 'technician' || e.role === 'manager' || !e.role)
        .map(e => {
          const name = `${e.first_name||''} ${e.last_name||''}`.trim() || e.name || 'Unknown';
          return `<option value="${e.employee_id}">${name}</option>`;
        }).join('');
    
    hint.textContent = 'Fill out the form below to create a new work order.';
    
  } catch(err){
    console.error('Load error:', err);
    document.getElementById('hint').textContent = `Error: ${err.message}`;
    document.getElementById('hint').className = 'error';
  }
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", load);
} else {
  load();
}
</script>

</body>
</html>
