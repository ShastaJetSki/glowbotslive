<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>New Work Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  
  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:0; font-family:system-ui; background:#0b0f14; color:#e8eef6; overflow-x:hidden; visibility:hidden; }
    body.auth-verified { visibility:visible; }
    
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }
    
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:240px; }
    
    /* Card styling */
    .card { 
      background:#0f1621; 
      border:2px solid #223044; 
      border-radius:12px; 
      padding:20px; 
      margin-bottom:16px;
      box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    label { 
      display:block; 
      font-size:12px; 
      color:#9fb0c3; 
      margin-bottom:6px; 
      font-weight:600; 
      text-transform:uppercase; 
      letter-spacing:0.5px; 
    }
    
    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #223044;
      background:#1a2535;
      color:#e8eef6;
      font-size:14px;
      outline:none;
      box-sizing:border-box;
    }
    input:focus, select:focus, textarea:focus { border-color:#3b82f6; }
    
    /* Hide number input spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    textarea { min-height:90px; resize:vertical; }
    
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
      min-height: 44px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button:hover { background:#243648; }
    .primary { 
      background:transparent; 
      border-color:transparent;
      border-width: 1px;
      color:#3b82f6;
    }
    .primary:hover { 
      background:rgba(59, 130, 246, 0.1); 
    }
    .danger { 
      background:transparent; 
      border-color:transparent;
      border-width: 1px;
      color:#7f1d1d;
    }
    .danger:hover { 
      background:rgba(127, 29, 29, 0.1); 
    }
    
    .muted { font-size:12px; color:#9fb0c3; }
    .error { color:#ffb3b3; }
    .success { color:#4ade80; }
    
    /* Autocomplete dropdown */
    .autocomplete-dropdown {
      position: absolute;
      background: #1a2535;
      border: 1px solid #223044;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
      width: 100%;
      margin-top: 4px;
    }
    
    .autocomplete-dropdown.active {
      display: block;
    }
    
    .autocomplete-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #223044;
    }
    
    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    .autocomplete-item:hover {
      background: #243648;
    }
    
    .autocomplete-item-title {
      font-size: 14px;
      font-weight: 600;
      color: #e8eef6;
    }
    
    .autocomplete-item-subtitle {
      font-size: 12px;
      color: #9fb0c3;
      margin-top: 2px;
    }
    
    /* Accordion styles */
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      margin: 18px 0 10px;
    }

    .accordion-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .accordion-icon {
      font-size: 20px;
      color: #9fb0c3;
      transition: transform 0.2s ease;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.active {
      max-height: 5000px;
    }
    
    /* Mobile Header Styles */
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      
      .mobile-header {
        display: block;
        background: #0f1621;
        border-bottom: 1px solid #223044;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .mobile-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
      }
      
      .mobile-menu-toggle {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px;
        color: #6b7280;
        font-size: 20px;
        padding: 0;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }
      
      .mobile-menu-toggle:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
        color: #3b82f6;
      }
      
      .mobile-menu-toggle:active {
        transform: scale(0.95);
      }
      
      .mobile-header-center {
        flex: 1;
        margin-left: 12px;
      }
      
      .mobile-header-title {
        font-size: 18px;
        font-weight: 600;
      }
      
      .mobile-header-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      
      .mobile-header-content.expanded {
        max-height: 400px;
      }
      
      .mobile-header-nav {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        overflow-x: auto;
        background: #0b0f14;
        border-top: 1px solid #223044;
      }
      
      .mobile-header-nav a {
        padding: 8px 12px;
        color: #9fb0c3;
        text-decoration: none;
        font-size: 13px;
        white-space: nowrap;
        border-radius: 6px;
      }
      
      .mobile-header-nav a.active {
        background: #3b82f6;
        color: #fff;
      }
      
      .mobile-header-actions {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        background: #0b0f14;
        border-top: 1px solid #223044;
      }
      
      .mobile-header-actions button {
        flex: 1;
        padding: 10px;
        font-size: 13px;
        background: #1a2535;
        border: 1px solid #3b82f6;
        border-left: 3px solid #3b82f6;
        transition: all 0.2s;
      }
      
      .mobile-header-actions button:active {
        background: #243648;
      }
      
      .accordion-icon-header {
        font-size: 20px;
        color: #9fb0c3;
        transition: transform 0.2s ease;
      }
      
      .mobile-menu-toggle.active .accordion-icon-header {
        transform: rotate(180deg);
      }
      
      /* Consistent mobile padding */
      .main-content {
        padding: 12px !important;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .col {
        min-width: 100%;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-header { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle active" onclick="toggleMobileMenu(this)">
        <span class="accordion-icon-header">☰</span>
      </button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">New Work Order</div>
      </div>
    </div>
    
    <div class="mobile-header-content expanded" id="mobileHeaderContent">
      <div class="mobile-header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html">Scheduling</a>
      </div>
      <div class="mobile-header-actions">
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Desktop Sticky Header -->
  <div class="desktop-header" style="position:sticky; top:0; z-index:100; background:#0b0f14; border-bottom:1px solid #223044;">
    <!-- Title and Logo Bar -->
    <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
      <h1 style="margin:0; font-size:32px; font-weight:600;">New Work Order</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <!-- Navigation Tabs -->
    <div style="padding:0 24px 12px;">
      <nav style="display:flex; gap:24px; overflow-x:auto;">
        <a href="dashboard-business.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Dashboard</a>
        <a href="dashboard-customer-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
        <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
        <a href="dashboard-scheduling.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Scheduling</a>
      </nav>
    </div>
    
    <!-- Settings/Logout buttons BELOW divider -->
    <div style="padding:0 24px 12px; border-top:1px solid #223044; padding-top:12px;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="goToSettings()" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Settings</button>
        <button onclick="logout()" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Logout</button>
      </div>
    </div>
  </div>

  <!-- Main Content (Scrollable) -->
  <div class="main-content" style="padding:24px;">
    <div class="muted" id="hint" style="margin-bottom:16px;">Fill out the form below to create a new work order.</div>

    <!-- Customer & Vehicle Selection -->
    <div class="card" style="border-left: 4px solid #3b82f6;">
      <h2>Customer & Vehicle Information</h2>
      
      <div class="row">
        <div class="col">
          <label>Customer *</label>
          <div style="position: relative;">
            <input 
              id="customerSearch" 
              type="text" 
              placeholder="Search customer by name, phone, or email..." 
              autocomplete="off"
              oninput="searchCustomers()"
              onfocus="searchCustomers()"
            />
            <div id="customerDropdown" class="autocomplete-dropdown"></div>
          </div>
          <div class="muted" style="margin-top:4px;">
            Selected: <span id="selectedCustomer">None</span>
            <a href="#" onclick="clearCustomer(); return false;" style="color:#3b82f6; margin-left:8px;">Clear</a>
          </div>
        </div>
        
        <div class="col">
          <label>Vehicle *</label>
          <div style="position: relative;">
            <input 
              id="vehicleSearch" 
              type="text" 
              placeholder="Search vehicle by make, model, VIN, or plate..." 
              autocomplete="off"
              oninput="searchVehicles()"
              onfocus="searchVehicles()"
            />
            <div id="vehicleDropdown" class="autocomplete-dropdown"></div>
          </div>
          <div class="muted" style="margin-top:4px;">
            Selected: <span id="selectedVehicle">None</span>
            <a href="#" onclick="clearVehicle(); return false;" style="color:#3b82f6; margin-left:8px;">Clear</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Work Order Details -->
    <button class="accordion-header active" onclick="toggleAccordion(this)">
      <h2>Work Order Details</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content active">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>Status</label>
            <select id="status">
              <option value="draft">Draft</option>
              <option value="scheduled" selected>Scheduled</option>
              <option value="diagnosis_required">Diagnosis Required</option>
              <option value="awaiting_parts">Awaiting Parts</option>
              <option value="customer_approval">Customer Approval</option>
              <option value="in_progress">In Progress</option>
              <option value="repairing">Repairing</option>
              <option value="testing">Testing</option>
              <option value="ready_for_pickup">Ready for Pickup</option>
              <option value="completed">Completed</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div class="col">
            <label>Priority</label>
            <select id="priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="col">
            <label>Assigned To</label>
            <select id="assigned_employee_id">
              <option value="">Unassigned</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Scheduled Start *</label>
            <input id="scheduled_start" type="datetime-local" />
          </div>
          <div class="col">
            <label>Scheduled End</label>
            <input id="scheduled_end" type="datetime-local" />
          </div>
          <div class="col">
            <label>Vehicle Arrived</label>
            <input id="vehicle_arrived_at" type="datetime-local" />
            <div class="muted" style="margin-top:4px;">When vehicle arrived at shop</div>
          </div>
          <div class="col">
            <label>Customer Deadline</label>
            <input id="customer_deadline" type="datetime-local" />
            <div class="muted" style="margin-top:4px;">Customer requested completion</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Odometer / Hours</label>
            <input id="odometer" type="number" min="0" step="1" placeholder="12345" />
          </div>
          <div class="col">
            <label>Shop Tag / Reference</label>
            <input id="reference" type="text" placeholder="WO-2025-001" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <label>Customer Concern / Notes</label>
            <textarea id="customer_notes" placeholder="Customer states: check engine light is on..."></textarea>
          </div>
          <div class="col">
            <label>Internal Notes</label>
            <textarea id="internal_notes" placeholder="Tech notes, advisor notes..."></textarea>
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:16px; gap:12px;">
          <button onclick="cancelNew()">Cancel</button>
          <button class="primary" onclick="createWorkOrder()" style="background:#3b82f6; color:#fff; padding:12px 24px;">Create Work Order</button>
        </div>

        <div id="msg" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let AUTH = null;
let TENANT_ID = null;

let customers = [];
let customersById = {};
let vehicles = [];
let vehiclesById = {};
let employees = [];

let selectedCustomerId = null;
let selectedVehicleId = null;

// Mobile menu toggle
function toggleMobileMenu(button) {
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
  button.classList.toggle('active');
}

// Accordion toggle
function toggleAccordion(button) {
  const content = button.nextElementSibling;
  button.classList.toggle('active');
  content.classList.toggle('active');
}

// Settings navigation
function goToSettings() {
  location.href = "dashboard-settings.html";
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function cancelNew(){
  location.href = "dashboard-business.html";
}

/* AUTH */
async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return null;

  const res = await fetch(`${API_BASE}/auth/v1/user`, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });

  if (!res.ok) return null;
  const user = await res.json();
  
  TENANT_ID = user?.user_metadata?.tenant_id || null;
  return token;
}

async function fetchJson(url, token){
  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function fetchTable(table, token){
  const res = await fetch(`${REST_BASE}/${table}?select=*`, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* Customer Search */
function searchCustomers(){
  const input = document.getElementById('customerSearch');
  const dropdown = document.getElementById('customerDropdown');
  const query = (input.value || '').trim().toLowerCase();
  
  if(query.length < 1){
    dropdown.classList.remove('active');
    return;
  }
  
  const matches = customers.filter(c => {
    const name = `${c.first_name||''} ${c.last_name||''}`.toLowerCase();
    const phone = (c.phone||'').toLowerCase();
    const email = (c.email||'').toLowerCase();
    return name.includes(query) || phone.includes(query) || email.includes(query);
  }).slice(0, 10);
  
  if(matches.length === 0){
    dropdown.innerHTML = '<div class="autocomplete-item">No customers found</div>';
    dropdown.classList.add('active');
    return;
  }
  
  dropdown.innerHTML = matches.map(c => {
    const name = `${c.first_name||''} ${c.last_name||''}`.trim() || 'Unknown';
    const subtitle = [c.phone, c.email].filter(Boolean).join(' • ');
    return `
      <div class="autocomplete-item" onclick="selectCustomer('${c.customer_id}')">
        <div class="autocomplete-item-title">${name}</div>
        ${subtitle ? `<div class="autocomplete-item-subtitle">${subtitle}</div>` : ''}
      </div>
    `;
  }).join('');
  
  dropdown.classList.add('active');
}

function selectCustomer(id){
  selectedCustomerId = id;
  const customer = customersById[id];
  const name = customer ? `${customer.first_name||''} ${customer.last_name||''}`.trim() : 'Unknown';
  
  document.getElementById('selectedCustomer').textContent = name;
  document.getElementById('customerSearch').value = name;
  document.getElementById('customerDropdown').classList.remove('active');
}

function clearCustomer(){
  selectedCustomerId = null;
  document.getElementById('selectedCustomer').textContent = 'None';
  document.getElementById('customerSearch').value = '';
  document.getElementById('customerDropdown').classList.remove('active');
}

/* Vehicle Search */
function searchVehicles(){
  const input = document.getElementById('vehicleSearch');
  const dropdown = document.getElementById('vehicleDropdown');
  const query = (input.value || '').trim().toLowerCase();
  
  if(query.length < 1){
    dropdown.classList.remove('active');
    return;
  }
  
  const matches = vehicles.filter(v => {
    const desc = `${v.year||''} ${v.make||''} ${v.model||''}`.toLowerCase();
    const vin = (v.vin_or_cf_number||'').toLowerCase();
    const plate = (v.license_plate||'').toLowerCase();
    return desc.includes(query) || vin.includes(query) || plate.includes(query);
  }).slice(0, 10);
  
  if(matches.length === 0){
    dropdown.innerHTML = '<div class="autocomplete-item">No vehicles found</div>';
    dropdown.classList.add('active');
    return;
  }
  
  dropdown.innerHTML = matches.map(v => {
    const desc = `${v.year||''} ${v.make||''} ${v.model||''}`.trim() || 'Unknown Vehicle';
    const subtitle = [v.license_plate, v.vin_or_cf_number].filter(Boolean).join(' • ');
    return `
      <div class="autocomplete-item" onclick="selectVehicle('${v.vehicle_id}')">
        <div class="autocomplete-item-title">${desc}</div>
        ${subtitle ? `<div class="autocomplete-item-subtitle">${subtitle}</div>` : ''}
      </div>
    `;
  }).join('');
  
  dropdown.classList.add('active');
}

function selectVehicle(id){
  selectedVehicleId = id;
  const vehicle = vehiclesById[id];
  const desc = vehicle ? `${vehicle.year||''} ${vehicle.make||''} ${vehicle.model||''}`.trim() : 'Unknown';
  
  document.getElementById('selectedVehicle').textContent = desc;
  document.getElementById('vehicleSearch').value = desc;
  document.getElementById('vehicleDropdown').classList.remove('active');
}

function clearVehicle(){
  selectedVehicleId = null;
  document.getElementById('selectedVehicle').textContent = 'None';
  document.getElementById('vehicleSearch').value = '';
  document.getElementById('vehicleDropdown').classList.remove('active');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e){
  if(!e.target.closest('#customerSearch') && !e.target.closest('#customerDropdown')){
    document.getElementById('customerDropdown').classList.remove('active');
  }
  if(!e.target.closest('#vehicleSearch') && !e.target.closest('#vehicleDropdown')){
    document.getElementById('vehicleDropdown').classList.remove('active');
  }
});

/* Create Work Order */
async function createWorkOrder(){
  const msg = document.getElementById('msg');
  msg.textContent = '';
  msg.className = '';
  
  // Validate required fields
  if(!selectedCustomerId){
    msg.textContent = 'Please select a customer';
    msg.className = 'error';
    return;
  }
  
  if(!selectedVehicleId){
    msg.textContent = 'Please select a vehicle';
    msg.className = 'error';
    return;
  }
  
  const scheduled_start = document.getElementById('scheduled_start').value;
  if(!scheduled_start){
    msg.textContent = 'Please select a scheduled start date/time';
    msg.className = 'error';
    return;
  }
  
  // Gather form data
  const data = {
    tenant_id: TENANT_ID,
    customer_id: selectedCustomerId,
    vehicle_id: selectedVehicleId,
    status: document.getElementById('status').value || 'scheduled',
    priority: document.getElementById('priority').value || 'medium',
    assigned_employee_id: document.getElementById('assigned_employee_id').value || null,
    scheduled_start: scheduled_start,
    scheduled_end: document.getElementById('scheduled_end').value || null,
    vehicle_arrived_at: document.getElementById('vehicle_arrived_at').value || null,
    customer_deadline: document.getElementById('customer_deadline').value || null,
    odometer: parseInt(document.getElementById('odometer').value) || null,
    reference: document.getElementById('reference').value || null,
    customer_notes: document.getElementById('customer_notes').value || null,
    internal_notes: document.getElementById('internal_notes').value || null
  };
  
  try {
    msg.textContent = 'Creating work order...';
    msg.className = 'muted';
    
    const res = await fetch(`${REST_BASE}/work_orders`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${AUTH}`,
        'apikey': ANON_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(data)
    });
    
    if(!res.ok){
      const err = await res.text();
      throw new Error(err);
    }
    
    const created = await res.json();
    const woId = created[0]?.work_order_id || created[0]?.id;
    
    msg.textContent = 'Work order created successfully! Redirecting...';
    msg.className = 'success';
    
    setTimeout(() => {
      location.href = `work-order-edit.html?id=${woId}`;
    }, 1000);
    
  } catch(err){
    console.error('Create error:', err);
    msg.textContent = `Error creating work order: ${err.message}`;
    msg.className = 'error';
  }
}

/* Load Data */
async function load(){
  const token = await validateAuth();
  if (!token) {
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
    return;
  }
  
  AUTH = token;
  document.body.classList.add('auth-verified');
  
  try {
    const hint = document.getElementById('hint');
    hint.textContent = 'Loading customers, vehicles, and employees...';
    
    const [cust, veh, emp] = await Promise.all([
      fetchTable('customers', token),
      fetchTable('vehicles', token),
      fetchJson(`${FUNCTIONS_BASE}/employees`, token)
    ]);
    
    customers = Array.isArray(cust) ? cust : [];
    customersById = {};
    customers.forEach(c => { if(c?.customer_id) customersById[c.customer_id] = c; });
    
    vehicles = Array.isArray(veh) ? veh : [];
    vehiclesById = {};
    vehicles.forEach(v => { if(v?.vehicle_id) vehiclesById[v.vehicle_id] = v; });
    
    employees = Array.isArray(emp) ? emp : [];
    
    // Populate employee dropdown
    const empSelect = document.getElementById('assigned_employee_id');
    empSelect.innerHTML = '<option value="">Unassigned</option>' + 
      employees
        .filter(e => e.role === 'technician' || e.role === 'manager')
        .map(e => {
          const name = `${e.first_name||''} ${e.last_name||''}`.trim() || e.name || 'Unknown';
          return `<option value="${e.employee_id}">${name}</option>`;
        }).join('');
    
    hint.textContent = 'Fill out the form below to create a new work order.';
    
  } catch(err){
    console.error('Load error:', err);
    document.getElementById('hint').textContent = `Error: ${err.message}`;
    document.getElementById('hint').className = 'error';
  }
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", load);
} else {
  load();
}
</script>

</body>
</html>
