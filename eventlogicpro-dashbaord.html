<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard – Event Logic Pro</title>
  <link rel="icon" href="favicon-eventlogic.ico">
  <link rel="icon" type="image/png" href="favicon-eventlogic-32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="favicon-eventlogic-192.png">
  <meta name="apple-mobile-web-app-title" content="Event Logic Pro">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg-primary:#f4f5f7;--bg-secondary:#ebedf1;--bg-card:#ffffff;--bg-hover:#f0f0f3;
  --border:#e2e4e8;--text-primary:#1a1a1a;--text-secondary:#6b7280;
  --accent:#DC2626;--accent-hover:#B91C1C;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.10);--accent-glow2:rgba(220,38,38,.06);
  --shadow:0 2px 12px rgba(0,0,0,.06);--input-bg:#fafafa;--modal-overlay:rgba(0,0,0,.45);
}
body.dark{
  --bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#222;--bg-hover:#2a2a2a;
  --border:#333;--text-primary:#f0f0f0;--text-secondary:#999;
  --accent:#DC2626;--accent-hover:#EF4444;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.15);--accent-glow2:rgba(220,38,38,.08);
  --shadow:0 2px 12px rgba(0,0,0,.3);--input-bg:#1a1a1a;--modal-overlay:rgba(0,0,0,.75);
}
html{background:var(--bg-primary);scrollbar-gutter:stable;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;padding-bottom:120px;}

/* ===== HEADER ===== */
.desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border);}
.header-top{padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;}
.header-brand{display:flex;align-items:center;gap:14px;cursor:pointer;}
.header-logo{height:48px;}
.header-titles h1{font-size:28px;font-weight:700;letter-spacing:-.3px;}
.header-titles .sub{font-size:12px;color:var(--accent);font-weight:600;letter-spacing:.3px;}
.header-right{display:flex;align-items:center;gap:14px;}
.header-right-stack{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.dark-toggle{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.dark-toggle:hover{border-color:var(--accent);color:var(--accent);}
.dark-toggle svg{width:18px;height:18px;fill:currentColor;}
.logout-link{color:var(--text-secondary);cursor:pointer;font-size:13px;text-decoration:none;transition:color .2s;}
.logout-link:hover{color:var(--accent);}
.settings-link{color:var(--text-secondary);cursor:pointer;font-size:13px;text-decoration:none;transition:color .2s;}
.settings-link:hover{color:var(--accent);}

/* ===== DESKTOP NAV ===== */
.nav-bar{display:flex;gap:2px;padding:0 24px;overflow-x:auto;}
.nav-btn{padding:10px 18px;font-size:13px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;}
.nav-btn:hover{color:var(--accent);}
.nav-btn.active{color:var(--accent);border-bottom-color:var(--accent);}

/* ===== MOBILE HEADER ===== */
.mobile-header{display:none;padding:12px 16px;background:var(--bg-primary);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
.mobile-header-row{display:flex;justify-content:space-between;align-items:center;}
.mobile-logo{height:28px;}
.mobile-right{display:flex;gap:8px;align-items:center;}

/* ===== MOBILE NAV ===== */
.mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);padding:8px 8px calc(8px + env(safe-area-inset-bottom));z-index:200;}
.m-nav-top,.m-nav-bot{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;}
.m-nav-bot{grid-template-columns:1fr 1fr;margin-top:4px;}
.m-nav-btn{text-align:center;padding:8px 4px;font-size:11px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-radius:8px;background:var(--bg-hover);transition:all .2s;}
.m-nav-btn:hover,.m-nav-btn.active{background:var(--accent);color:#fff;}

/* ===== MAIN CONTENT ===== */
.main-content{max-width:1200px;margin:0 auto;padding:24px;}

/* ===== WELCOME SECTION ===== */
.welcome-section{margin-bottom:28px;}
.welcome-text{font-size:22px;font-weight:700;color:var(--text-primary);}
.welcome-sub{font-size:14px;color:var(--text-secondary);margin-top:4px;}

/* ===== KPI CARDS ===== */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px;}
.kpi-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:var(--shadow);transition:all .2s;}
.kpi-card:hover{border-color:var(--accent);box-shadow:0 4px 20px var(--accent-glow);}

.kpi-value{font-size:28px;font-weight:800;color:var(--text-primary);line-height:1;}
.kpi-label{font-size:13px;color:var(--text-secondary);margin-top:4px;font-weight:500;}

/* ===== SECTION HEADER ===== */
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.section-title{font-size:18px;font-weight:700;}
.btn-primary{background:var(--accent);color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary:hover{background:var(--accent-hover);}
.btn-secondary{background:var(--bg-hover);color:var(--text-primary);border:1px solid var(--border);padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:#DC2626;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-danger:hover{background:#B91C1C;}

/* ===== EVENT CARDS GRID ===== */
.events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;}
.event-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);cursor:pointer;transition:all .25s;position:relative;}
.event-card:hover{border-color:var(--accent);box-shadow:0 6px 24px var(--accent-glow);transform:translateY(-2px);}
.event-card-stripe{height:5px;}
.event-card-body{padding:20px;}
.event-card-name{font-size:18px;font-weight:700;color:var(--text-primary);margin-bottom:4px;}
.event-card-date{font-size:13px;color:var(--text-secondary);margin-bottom:14px;}
.event-card-date svg{width:14px;height:14px;vertical-align:-2px;margin-right:4px;}
.event-card-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.event-stat{display:flex;flex-direction:column;}
.event-stat-value{font-size:16px;font-weight:700;color:var(--text-primary);}
.event-stat-label{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;font-weight:600;}
.event-card-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.event-status{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:4px 10px;border-radius:20px;}
.event-status.planning{background:rgba(59,130,246,.1);color:#3B82F6;}
.event-status.active{background:rgba(16,185,129,.1);color:#10B981;}
.event-status.completed{background:rgba(107,114,128,.1);color:#6B7280;}
.event-status.cancelled{background:rgba(239,68,68,.1);color:#EF4444;}
.event-members-count{font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:4px;}
.event-members-count svg{width:14px;height:14px;}

/* ===== EMPTY STATE ===== */
.empty-state{text-align:center;padding:60px 20px;background:var(--bg-card);border:2px dashed var(--border);border-radius:12px;}
.empty-icon{font-size:48px;margin-bottom:12px;}
.empty-title{font-size:18px;font-weight:700;color:var(--text-primary);margin-bottom:6px;}
.empty-text{font-size:14px;color:var(--text-secondary);margin-bottom:20px;}

/* ===== MODAL ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:var(--modal-overlay);z-index:500;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-content{background:var(--bg-card);border-radius:14px;width:90%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border);}
.modal-title{font-size:18px;font-weight:700;}
.modal-close{background:none;border:none;font-size:24px;color:var(--text-secondary);cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .2s;}
.modal-close:hover{background:var(--bg-hover);color:var(--accent);}
.modal-body{padding:24px;}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;}

/* ===== FORM ===== */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;}
.form-input,.form-textarea,.form-select{width:100%;padding:10px 14px;font-size:14px;border:1px solid var(--border);border-radius:8px;background:var(--input-bg);color:var(--text-primary);font-family:inherit;transition:border-color .2s;}
.form-input:focus,.form-textarea:focus,.form-select:focus{outline:none;border-color:var(--accent);}
.form-textarea{resize:vertical;min-height:80px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-check{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary);margin-top:8px;}
.form-check input[type="checkbox"]{accent-color:var(--accent);}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--text-primary);color:var(--bg-card);padding:10px 24px;border-radius:8px;font-size:13px;font-weight:600;opacity:0;transition:all .3s;z-index:9999;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ===== FOOTER ===== */
.footer-bar{padding:20px 24px;text-align:center;border-top:1px solid var(--border);margin-top:40px;}
.footer-powered{display:flex;align-items:center;justify-content:center;gap:6px;font-size:12px;color:var(--text-secondary);margin-bottom:4px;}
.footer-powered img{height:16px;}
.footer-powered a{color:var(--accent);text-decoration:none;}
.footer-copy{font-size:11px;color:var(--text-secondary);}

/* ===== LOADING ===== */
.loading-spinner{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-secondary);font-size:14px;}
.loading-spinner::before{content:'';width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-right:10px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ===== RESPONSIVE ===== */
@media(max-width:900px){
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:768px){
  .desktop-header{display:none;}
  .mobile-header{display:block;}
  .mobile-bottom-nav{display:block;}
  .main-content{padding:16px;}
  .kpi-grid{grid-template-columns:1fr 1fr;gap:10px;}
  .kpi-card{padding:14px;}
  .kpi-value{font-size:22px;}
  .events-grid{grid-template-columns:1fr;}
  .form-row{grid-template-columns:1fr;}
  .welcome-text{font-size:18px;}
  body{padding-bottom:140px;}
}
@media(max-width:400px){
  .kpi-grid{grid-template-columns:1fr 1fr;gap:8px;}
  .kpi-card{padding:12px;}
  .kpi-value{font-size:20px;}
}
  </style>
</head>
<body>

<!-- DESKTOP HEADER -->
<div class="desktop-header">
  <div class="header-top">
    <div class="header-titles">
      <h1>Dashboard</h1>
      <div class="sub" id="headerEmail"></div>
    </div>
    <div class="header-right">
      <div class="header-right-stack">
        <div style="display:flex;gap:10px;align-items:center;">
          <img src="eventlogicpro-logo.png" alt="Event Logic Pro" class="header-logo" id="headerLogo">
          <a href="eventlogicpro-settings.html" class="settings-link">Settings</a>
          <button class="dark-toggle" onclick="toggleDark()" title="Toggle dark mode">
            <svg id="dMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>
            <svg id="dSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
          </button>
          <a class="logout-link" onclick="doLogout()">Logout</a>
        </div>
      </div>
    </div>
  </div>
  <div class="nav-bar">
    <a href="eventlogicpro-dashboard.html" class="nav-btn active">Dashboard</a>
    <a href="eventlogicpro-calendar.html" class="nav-btn">Calendar</a>
    <a href="eventlogicpro.html" class="nav-btn">Tasks</a>
    <a href="eventlogicpro-budget.html" class="nav-btn">Budget</a>
    <a href="eventlogicpro-sponsors.html" class="nav-btn">Packages</a>
    <a href="eventlogicpro-contacts.html" class="nav-btn">Contacts</a>
    <a href="eventlogicpro-sitemap.html" class="nav-btn">Site Maps</a>
  </div>
</div>

<!-- MOBILE HEADER -->
<div class="mobile-header">
  <div class="mobile-header-row">
    <img src="eventlogicpro-logo.png" alt="Event Logic Pro" class="mobile-logo" id="mHeaderLogo">
    <div class="mobile-right">
      <a href="eventlogicpro-settings.html" class="settings-link">Settings</a>
      <button class="dark-toggle" onclick="toggleDark()" title="Toggle dark mode">
        <svg id="mMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>
        <svg id="mSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </button>
      <a class="logout-link" onclick="doLogout()">Logout</a>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">

  <!-- WELCOME -->
  <div class="welcome-section">
    <div class="welcome-text" id="welcomeText">Welcome back</div>
    <div class="welcome-sub" id="welcomeSub">Here's what's happening across your events</div>
  </div>

  <!-- KPI CARDS -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-value" id="kpiEvents">-</div>
      <div class="kpi-label">Active Events</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value" id="kpiBudget">-</div>
      <div class="kpi-label">Total Budget</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value" id="kpiTasks">-</div>
      <div class="kpi-label">Tasks Completed</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-value" id="kpiDeadlines">-</div>
      <div class="kpi-label">Upcoming Deadlines</div>
    </div>
  </div>

  <!-- EVENTS SECTION -->
  <div class="section-header">
    <div class="section-title">Your Events</div>
    <button class="btn-primary" onclick="openNewEventModal()">+ New Event</button>
  </div>

  <div id="eventsContainer">
    <div class="loading-spinner">Loading events...</div>
  </div>

</div>

<!-- FOOTER -->
<div class="footer-bar">
  <div class="footer-powered">
    <span>Powered by</span>
    <img src="glowbot.png" alt="GlowBot">
    <a href="https://glowbotslive.com" target="_blank">GlowBotsLive.com</a>
  </div>
  <div class="footer-copy">&copy; 2026 Event Logic Pro. All rights reserved.</div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-bottom-nav">
  <div class="m-nav-top">
    <a href="eventlogicpro-dashboard.html" class="m-nav-btn active">Dashboard</a>
    <a href="eventlogicpro-calendar.html" class="m-nav-btn">Calendar</a>
    <a href="eventlogicpro.html" class="m-nav-btn">Tasks</a>
    <a href="eventlogicpro-budget.html" class="m-nav-btn">Budget</a>
  </div>
  <div class="m-nav-bot" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:4px;">
    <a href="eventlogicpro-sponsors.html" class="m-nav-btn">Packages</a>
    <a href="eventlogicpro-contacts.html" class="m-nav-btn">Contacts</a>
    <a href="eventlogicpro-sitemap.html" class="m-nav-btn">Site Maps</a>
  </div>
</div>

<!-- NEW EVENT MODAL -->
<div class="modal-overlay" id="newEventModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">New Event</div>
      <button class="modal-close" onclick="closeNewEventModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Event Name *</label>
        <input type="text" class="form-input" id="newEvName" placeholder="e.g. Redding Rock 2026">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-input" id="newEvDate">
        </div>
        <div class="form-group">
          <label class="form-label">End Date</label>
          <input type="date" class="form-input" id="newEvEndDate">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Budget ($)</label>
          <input type="number" class="form-input" id="newEvBudget" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
          <label class="form-label">Color Tag</label>
          <input type="color" class="form-input" id="newEvColor" value="#DC2626" style="height:42px;padding:4px;">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Venue</label>
        <input type="text" class="form-input" id="newEvVenue" placeholder="Venue name">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="newEvDesc" placeholder="Brief description of the event..."></textarea>
      </div>
      <div class="form-check">
        <input type="checkbox" id="newEvTemplates" checked>
        <label for="newEvTemplates">Load department templates (~16 departments, ~160 tasks)</label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewEventModal()">Cancel</button>
      <button class="btn-primary" onclick="createEvent()">Create Event</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== DARK MODE ===== */
var isDark = localStorage.getItem('elp_dark_mode') === 'true';
if (isDark) document.body.classList.add('dark');

function applyDarkIcons() {
  var d = document.body.classList.contains('dark');
  ['d','m'].forEach(function(p) {
    var moon = document.getElementById(p + 'Moon');
    var sun = document.getElementById(p + 'Sun');
    if (moon) moon.style.display = d ? 'none' : 'block';
    if (sun) sun.style.display = d ? 'block' : 'none';
  });
  var logo = document.getElementById('headerLogo');
  if (logo) logo.src = d ? 'eventlogicpro-logo-dark.png' : 'eventlogicpro-logo.png';
  var mLogo = document.getElementById('mHeaderLogo');
  if (mLogo) mLogo.src = d ? 'eventlogicpro-logo-dark.png' : 'eventlogicpro-logo.png';
}
applyDarkIcons();

function toggleDark() {
  document.body.classList.toggle('dark');
  isDark = document.body.classList.contains('dark');
  localStorage.setItem('elp_dark_mode', isDark);
  applyDarkIcons();
}

/* ===== SUPABASE ===== */
var SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var tenantId = null, userId = null, teamId = null;
var allProjects = [], allTasks = [], allMembers = [];

function toast(m) {
  var t = document.getElementById('toast');
  t.textContent = m;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2500);
}

async function doLogout() {
  await sb.auth.signOut();
  localStorage.removeItem('sb_access_token');
  localStorage.removeItem('sb_refresh_token');
  location.replace('/');
}

async function checkAuth() {
  var r = await sb.auth.getSession();
  var s = r.data.session;
  if (!s) {
    var t = localStorage.getItem('sb_access_token');
    var rf = localStorage.getItem('sb_refresh_token');
    if (t && rf) {
      var sr = await sb.auth.setSession({ access_token: t, refresh_token: rf });
      s = sr.data?.session;
    }
    if (!s) { location.replace('/'); return null; }
  }
  return s;
}

async function getUserTenantId(email) {
  var r = await sb.from('users').select('tenant_id').eq('email', email).single();
  if (r.data) return r.data.tenant_id;
  var b = await sb.from('business_settings').select('tenant_id').limit(1).single();
  return b.data?.tenant_id || null;
}

async function getUserTeamId(authUserId) {
  var r = await sb.from('event_team_members').select('team_id').eq('user_id', authUserId).limit(1).single();
  return r.data?.team_id || null;
}

/* ===== INIT ===== */
async function init() {
  var session = await checkAuth();
  if (!session) return;

  userId = session.user.id;
  var email = session.user.email;
  tenantId = await getUserTenantId(email);
  teamId = await getUserTeamId(userId);

  if (!tenantId) {
    toast('Cannot determine tenant');
    return;
  }

  // Welcome message
  var name = email.split('@')[0];
  document.getElementById('welcomeText').textContent = 'Welcome back, ' + name;
  document.getElementById('headerEmail').textContent = email;

  await Promise.all([loadProjects(), loadTasks(), loadMembers()]);
  renderKPIs();
  renderEvents();
}

/* ===== DATA LOADING ===== */
async function loadProjects() {
  var r = await sb.from('event_projects').select('*').eq('tenant_id', tenantId).order('event_date', { ascending: true, nullsFirst: false });
  allProjects = r.data || [];
}

async function loadTasks() {
  var projectIds = allProjects.map(function(p) { return p.event_project_id; });
  if (!projectIds.length) { allTasks = []; return; }
  var r = await sb.from('event_tasks').select('event_task_id, event_project_id, is_complete, is_cancelled, deadline').in('event_project_id', projectIds);
  allTasks = r.data || [];
}

async function loadMembers() {
  var r = await sb.from('event_members').select('member_id, first_name, last_name, is_active').eq('tenant_id', tenantId).eq('is_active', true);
  allMembers = r.data || [];
}

/* ===== KPIs ===== */
function renderKPIs() {
  // Active events (not completed or cancelled)
  var active = allProjects.filter(function(p) {
    return !p.status || p.status === 'planning' || p.status === 'active';
  });
  document.getElementById('kpiEvents').textContent = active.length;

  // Total budget
  var totalBudget = 0;
  allProjects.forEach(function(p) { totalBudget += parseFloat(p.total_budget) || 0; });
  document.getElementById('kpiBudget').textContent = '$' + totalBudget.toLocaleString(undefined, { maximumFractionDigits: 0 });

  // Tasks completed
  var completed = allTasks.filter(function(t) { return t.is_complete; }).length;
  var total = allTasks.filter(function(t) { return !t.is_cancelled; }).length;
  document.getElementById('kpiTasks').textContent = completed + '/' + total;

  // Upcoming deadlines (next 14 days)
  var now = new Date();
  var twoWeeks = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);
  var upcoming = allTasks.filter(function(t) {
    if (t.is_complete || t.is_cancelled || !t.deadline) return false;
    var d = new Date(t.deadline);
    return d >= now && d <= twoWeeks;
  }).length;
  document.getElementById('kpiDeadlines').textContent = upcoming;
}

/* ===== RENDER EVENTS ===== */
function renderEvents() {
  var container = document.getElementById('eventsContainer');

  if (!allProjects.length) {
    container.innerHTML = '<div class="empty-state">' +
      '<div class="empty-icon">&#127881;</div>' +
      '<div class="empty-title">No events yet</div>' +
      '<div class="empty-text">Create your first event to get started</div>' +
      '<button class="btn-primary" onclick="openNewEventModal()">+ Create Event</button>' +
      '</div>';
    return;
  }

  var html = '<div class="events-grid">';
  allProjects.forEach(function(p) {
    var color = p.color_tag || '#DC2626';
    var status = p.status || 'planning';
    var dateStr = p.event_date ? formatDate(p.event_date) : 'No date set';
    if (p.event_end_date) dateStr += ' – ' + formatDate(p.event_end_date);

    // Task stats for this event
    var eTasks = allTasks.filter(function(t) { return t.event_project_id === p.event_project_id; });
    var eTotal = eTasks.filter(function(t) { return !t.is_cancelled; }).length;
    var eDone = eTasks.filter(function(t) { return t.is_complete; }).length;
    var pct = eTotal > 0 ? Math.round(eDone / eTotal * 100) : 0;

    var budget = parseFloat(p.total_budget) || 0;

    html += '<div class="event-card" onclick="goToEvent(\'' + p.event_project_id + '\')">';
    html += '<div class="event-card-stripe" style="background:' + esc(color) + ';"></div>';
    html += '<div class="event-card-body">';
    html += '<div class="event-card-name">' + esc(p.event_name) + '</div>';
    html += '<div class="event-card-date"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' + dateStr + '</div>';
    html += '<div class="event-card-stats">';
    html += '<div class="event-stat"><div class="event-stat-value">$' + budget.toLocaleString(undefined, { maximumFractionDigits: 0 }) + '</div><div class="event-stat-label">Budget</div></div>';
    html += '<div class="event-stat"><div class="event-stat-value">' + pct + '%</div><div class="event-stat-label">Tasks (' + eDone + '/' + eTotal + ')</div></div>';
    html += '</div></div>';
    html += '<div class="event-card-footer">';
    html += '<span class="event-status ' + status + '">' + status + '</span>';
    if (p.venue) html += '<span class="event-members-count"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' + esc(p.venue) + '</span>';
    html += '</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

/* ===== CREATE EVENT ===== */
function openNewEventModal() {
  document.getElementById('newEvName').value = '';
  document.getElementById('newEvDate').value = '';
  document.getElementById('newEvEndDate').value = '';
  document.getElementById('newEvBudget').value = '';
  document.getElementById('newEvVenue').value = '';
  document.getElementById('newEvDesc').value = '';
  document.getElementById('newEvColor').value = '#DC2626';
  document.getElementById('newEvTemplates').checked = true;
  document.getElementById('newEventModal').classList.add('show');
}

function closeNewEventModal() {
  document.getElementById('newEventModal').classList.remove('show');
}

async function createEvent() {
  var name = document.getElementById('newEvName').value.trim();
  if (!name) { toast('Event name is required'); return; }

  var data = {
    tenant_id: tenantId,
    team_id: teamId,
    event_name: name,
    event_date: document.getElementById('newEvDate').value || null,
    event_end_date: document.getElementById('newEvEndDate').value || null,
    total_budget: parseFloat(document.getElementById('newEvBudget').value) || 0,
    venue: document.getElementById('newEvVenue').value.trim() || null,
    description: document.getElementById('newEvDesc').value.trim() || null,
    color_tag: document.getElementById('newEvColor').value || '#DC2626',
    status: 'planning',
    created_by: userId
  };

  var r = await sb.from('event_projects').insert(data).select().single();
  if (r.error) {
    toast('Error: ' + r.error.message);
    return;
  }

  var newProject = r.data;

  // Load templates if checked
  if (document.getElementById('newEvTemplates').checked) {
    await loadTemplatesForEvent(newProject.event_project_id);
  }

  closeNewEventModal();
  toast('Event created!');
  await Promise.all([loadProjects(), loadTasks()]);
  renderKPIs();
  renderEvents();
}

async function loadTemplatesForEvent(projectId) {
  // Get all department templates
  var dt = await sb.from('event_task_templates').select('*').or('tenant_id.is.null,tenant_id.eq.' + tenantId);
  var templates = dt.data || [];
  if (!templates.length) return;

  // Group by department
  var depts = {};
  templates.forEach(function(t) {
    var dName = t.department_name || 'General';
    if (!depts[dName]) depts[dName] = [];
    depts[dName].push(t);
  });

  var sortOrder = 0;
  for (var deptName in depts) {
    // Create department
    var dr = await sb.from('event_departments').insert({
      event_project_id: projectId,
      department_name: deptName,
      sort_order: sortOrder++
    }).select().single();

    if (!dr.data) continue;
    var deptId = dr.data.event_department_id;

    // Create tasks for this department
    var taskRows = depts[deptName].map(function(t, i) {
      return {
        event_project_id: projectId,
        event_department_id: deptId,
        task_title: t.task_title || t.title || 'Untitled',
        cost: parseFloat(t.cost) || 0,
        timing: t.timing || null,
        notes: t.notes || null,
        sort_order: i
      };
    });

    if (taskRows.length) {
      await sb.from('event_tasks').insert(taskRows);
    }
  }
}

/* ===== NAVIGATION ===== */
function goToEvent(projectId) {
  window.location.href = 'eventlogicpro.html?event=' + projectId;
}

/* ===== UTILITIES ===== */
function esc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function formatDate(str) {
  if (!str) return '';
  var d = new Date(str + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

/* ===== START ===== */
init();
</script>
</body>
</html>
