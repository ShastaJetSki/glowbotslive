<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Analytics - GlowBots Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0b0f14; color: #e8eef6; min-height: 100vh; }
    .header { background: #0f1621; border-bottom: 1px solid #223044; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .back-btn { padding: 8px 16px; background: transparent; border: 1px solid #223044; color: #9fb0c3; border-radius: 8px; cursor: pointer; font-size: 14px; text-decoration: none; }
    .back-btn:hover { background: #1a2535; color: #fff; }
    .header-title { font-size: 20px; font-weight: 700; color: #e8eef6; }
    .refresh-btn { padding: 8px 16px; background: #3b82f6; border: none; color: #fff; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .refresh-btn:hover { background: #2563eb; }

    .container { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }

    .section { margin-bottom: 32px; }
    .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #e8eef6; padding-bottom: 8px; border-bottom: 1px solid #223044; }

    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .kpi-card { background: #1a2535; border: 1px solid #223044; border-radius: 12px; padding: 20px; }
    .kpi-card.highlight { border-color: #3b82f6; background: linear-gradient(135deg, #1a2535 0%, rgba(59, 130, 246, 0.1) 100%); }
    .kpi-value { font-size: 32px; font-weight: 700; color: #3b82f6; }
    .kpi-value.green { color: #22c55e; }
    .kpi-value.yellow { color: #fbbf24; }
    .kpi-value.red { color: #ef4444; }
    .kpi-label { font-size: 13px; color: #9fb0c3; margin-top: 4px; }
    .kpi-change { font-size: 12px; margin-top: 8px; }
    .kpi-change.up { color: #22c55e; }
    .kpi-change.down { color: #ef4444; }

    .chart-container { background: #1a2535; border: 1px solid #223044; border-radius: 12px; padding: 24px; margin-bottom: 16px; }
    .chart-title { font-size: 14px; font-weight: 600; color: #9fb0c3; margin-bottom: 16px; }
    .bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 200px; padding-top: 20px; }
    .bar { flex: 1; background: linear-gradient(to top, #3b82f6, #60a5fa); border-radius: 4px 4px 0 0; min-width: 30px; position: relative; transition: all 0.3s; }
    .bar:hover { background: linear-gradient(to top, #2563eb, #3b82f6); }
    .bar-label { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #9fb0c3; white-space: nowrap; }
    .bar-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #e8eef6; font-weight: 600; }

    .table-container { background: #1a2535; border: 1px solid #223044; border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 600; color: #9fb0c3; text-transform: uppercase; background: #0f1621; border-bottom: 1px solid #223044; }
    td { padding: 14px 16px; border-bottom: 1px solid #223044; font-size: 14px; }
    tr:hover { background: #223044; }
    tr:last-child td { border-bottom: none; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="admin-settings.html" class="back-btn">Back to Admin</a>
    <span class="header-title">System Analytics</span>
  </div>
  <button class="refresh-btn" onclick="loadAllData()">Refresh Data</button>
</div>

<div class="container">

  <!-- Platform Overview -->
  <div class="section">
    <div class="section-title">Platform Overview</div>
    <div class="kpi-grid">
      <div class="kpi-card highlight">
        <div class="kpi-value" id="kpiTenants">-</div>
        <div class="kpi-label">Total Tenants</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiUsers">-</div>
        <div class="kpi-label">Total Users</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiEmployees">-</div>
        <div class="kpi-label">Total Employees</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiCustomers">-</div>
        <div class="kpi-label">Total Customers</div>
      </div>
    </div>
  </div>

  <!-- Business Metrics -->
  <div class="section">
    <div class="section-title">Business Metrics</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-value" id="kpiEvents">-</div>
        <div class="kpi-label">Total Events</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiEventsToday">-</div>
        <div class="kpi-label">Events Today</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiEventsWeek">-</div>
        <div class="kpi-label">Events This Week</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiEventsMonth">-</div>
        <div class="kpi-label">Events This Month</div>
      </div>
    </div>
  </div>

  <!-- Support Metrics -->
  <div class="section">
    <div class="section-title">Support Metrics</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-value" id="kpiTicketsTotal">-</div>
        <div class="kpi-label">Total Tickets</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value yellow" id="kpiTicketsOpen">-</div>
        <div class="kpi-label">Open Tickets</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiTicketsProgress">-</div>
        <div class="kpi-label">In Progress</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value green" id="kpiTicketsResolved">-</div>
        <div class="kpi-label">Resolved</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value red" id="kpiTicketsUrgent">-</div>
        <div class="kpi-label">Urgent</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="kpiTicketsToday">-</div>
        <div class="kpi-label">New Today</div>
      </div>
    </div>
  </div>

  <!-- Tenant Activity -->
  <div class="section">
    <div class="section-title">Tenant Activity</div>
    <div class="grid-2">
      <div class="chart-container">
        <div class="chart-title">Events by Tenant (Last 30 Days)</div>
        <div class="bar-chart" id="eventsByTenant"></div>
      </div>
      <div class="chart-container">
        <div class="chart-title">Customers by Tenant</div>
        <div class="bar-chart" id="customersByTenant"></div>
      </div>
    </div>
  </div>

  <!-- Top Tenants -->
  <div class="section">
    <div class="section-title">Tenant Breakdown</div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Tenant</th>
            <th>Users</th>
            <th>Employees</th>
            <th>Customers</th>
            <th>Events</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tenantTable">
          <tr><td colspan="6" style="text-align:center;color:#9fb0c3;padding:40px;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="section">
    <div class="section-title">Recent Support Tickets</div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Subject</th>
            <th>From</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody id="recentTickets">
          <tr><td colspan="5" style="text-align:center;color:#9fb0c3;padding:40px;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  let tenantMap = {};

  async function init() {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
      const token = localStorage.getItem('sb_access_token');
      const refresh = localStorage.getItem('sb_refresh_token');
      if (token && refresh) {
        await sb.auth.setSession({ access_token: token, refresh_token: refresh });
      } else {
        window.location.href = 'login.html';
        return;
      }
    }
    await loadTenantMap();
    loadAllData();
  }

  async function loadTenantMap() {
    const { data: tenants } = await sb.from('tenants').select('tenant_id, tenant_name').neq('tenant_id', '00000000-0000-0000-0000-000000000000');
    if (tenants) {
      tenants.forEach(t => { tenantMap[t.tenant_id] = t.tenant_name || 'Unknown'; });
    }
  }

  async function loadAllData() {
    await Promise.all([
      loadPlatformOverview(),
      loadBusinessMetrics(),
      loadSupportMetrics(),
      loadTenantBreakdown(),
      loadCharts(),
      loadRecentTickets()
    ]);
  }

  async function loadPlatformOverview() {
    const { count: tenants } = await sb.from('tenants').select('*', { count: 'exact', head: true }).neq('tenant_id', '00000000-0000-0000-0000-000000000000');
    const { count: users } = await sb.from('users').select('*', { count: 'exact', head: true });
    const { count: employees } = await sb.from('employees').select('*', { count: 'exact', head: true });
    const { count: customers } = await sb.from('customers').select('*', { count: 'exact', head: true });

    document.getElementById('kpiTenants').textContent = tenants || 0;
    document.getElementById('kpiUsers').textContent = users || 0;
    document.getElementById('kpiEmployees').textContent = employees || 0;
    document.getElementById('kpiCustomers').textContent = customers || 0;
  }

  async function loadBusinessMetrics() {
    const { count: events } = await sb.from('events').select('*', { count: 'exact', head: true });
    document.getElementById('kpiEvents').textContent = events || 0;

    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
    const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();

    const { count: eventsToday } = await sb.from('events').select('*', { count: 'exact', head: true }).gte('created_at', today);
    const { count: eventsWeek } = await sb.from('events').select('*', { count: 'exact', head: true }).gte('created_at', weekAgo);
    const { count: eventsMonth } = await sb.from('events').select('*', { count: 'exact', head: true }).gte('created_at', monthAgo);

    document.getElementById('kpiEventsToday').textContent = eventsToday || 0;
    document.getElementById('kpiEventsWeek').textContent = eventsWeek || 0;
    document.getElementById('kpiEventsMonth').textContent = eventsMonth || 0;
  }

  async function loadSupportMetrics() {
    const { count: total } = await sb.from('support_tickets').select('*', { count: 'exact', head: true });
    const { count: open } = await sb.from('support_tickets').select('*', { count: 'exact', head: true }).eq('status', 'open');
    const { count: progress } = await sb.from('support_tickets').select('*', { count: 'exact', head: true }).eq('status', 'in_progress');
    const { count: resolved } = await sb.from('support_tickets').select('*', { count: 'exact', head: true }).eq('status', 'resolved');
    const { count: urgent } = await sb.from('support_tickets').select('*', { count: 'exact', head: true }).eq('priority', 'urgent').neq('status', 'resolved').neq('status', 'closed');

    const today = new Date().toISOString().split('T')[0];
    const { count: newToday } = await sb.from('support_tickets').select('*', { count: 'exact', head: true }).gte('created_at', today);

    document.getElementById('kpiTicketsTotal').textContent = total || 0;
    document.getElementById('kpiTicketsOpen').textContent = open || 0;
    document.getElementById('kpiTicketsProgress').textContent = progress || 0;
    document.getElementById('kpiTicketsResolved').textContent = resolved || 0;
    document.getElementById('kpiTicketsUrgent').textContent = urgent || 0;
    document.getElementById('kpiTicketsToday').textContent = newToday || 0;
  }

  async function loadTenantBreakdown() {
    const { data: tenants } = await sb.from('tenants').select('tenant_id, tenant_name, status').neq('tenant_id', '00000000-0000-0000-0000-000000000000').order('tenant_name');
    if (!tenants || tenants.length === 0) {
      document.getElementById('tenantTable').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9fb0c3;">No tenants</td></tr>';
      return;
    }

    const rows = await Promise.all(tenants.map(async t => {
      const { count: users } = await sb.from('users').select('*', { count: 'exact', head: true }).eq('tenant_id', t.tenant_id);
      const { count: employees } = await sb.from('employees').select('*', { count: 'exact', head: true }).eq('tenant_id', t.tenant_id);
      const { count: customers } = await sb.from('customers').select('*', { count: 'exact', head: true }).eq('tenant_id', t.tenant_id);
      const { count: events } = await sb.from('events').select('*', { count: 'exact', head: true }).eq('tenant_id', t.tenant_id);

      const statusClass = t.status === 'active' ? 'green' : t.status === 'trial' ? 'yellow' : 'red';
      return `<tr>
        <td>${escapeHtml(t.tenant_name || 'Unknown')}</td>
        <td>${users || 0}</td>
        <td>${employees || 0}</td>
        <td>${customers || 0}</td>
        <td>${events || 0}</td>
        <td><span style="color:var(--${statusClass});">${t.status || 'active'}</span></td>
      </tr>`;
    }));

    document.getElementById('tenantTable').innerHTML = rows.join('');
  }

  async function loadCharts() {
    const { data: tenants } = await sb.from('tenants').select('tenant_id, tenant_name').neq('tenant_id', '00000000-0000-0000-0000-000000000000').limit(6);
    if (!tenants) return;

    // Events by tenant
    const eventCounts = await Promise.all(tenants.map(async t => {
      const { count } = await sb.from('events').select('*', { count: 'exact', head: true }).eq('tenant_id', t.tenant_id);
      return { name: t.tenant_name?.substring(0, 10) || 'Unknown', count: count || 0 };
    }));
    renderBarChart('eventsByTenant', eventCounts);

    // Customers by tenant
    const customerCounts = await Promise.all(tenants.map(async t => {
      const { count } = await sb.from('customers').select('*', { count: 'exact', head: true }).eq('tenant_id', t.tenant_id);
      return { name: t.tenant_name?.substring(0, 10) || 'Unknown', count: count || 0 };
    }));
    renderBarChart('customersByTenant', customerCounts);
  }

  function renderBarChart(containerId, data) {
    const container = document.getElementById(containerId);
    const max = Math.max(...data.map(d => d.count), 1);
    container.innerHTML = data.map(d => {
      const height = (d.count / max) * 160;
      return `<div class="bar" style="height:${Math.max(height, 4)}px;">
        <span class="bar-value">${d.count}</span>
        <span class="bar-label">${escapeHtml(d.name)}</span>
      </div>`;
    }).join('');
  }

  async function loadRecentTickets() {
    const { data: tickets } = await sb.from('support_tickets').select('*').order('created_at', { ascending: false }).limit(10);
    if (!tickets || tickets.length === 0) {
      document.getElementById('recentTickets').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#9fb0c3;">No tickets</td></tr>';
      return;
    }

    document.getElementById('recentTickets').innerHTML = tickets.map(t => {
      const statusColor = t.status === 'open' ? '#3b82f6' : t.status === 'resolved' ? '#22c55e' : t.status === 'in_progress' ? '#fbbf24' : '#9ca3af';
      const priorityColor = t.priority === 'urgent' ? '#ef4444' : t.priority === 'high' ? '#fbbf24' : '#9ca3af';
      return `<tr>
        <td>${escapeHtml(t.subject?.substring(0, 40) || 'No subject')}${t.subject?.length > 40 ? '...' : ''}</td>
        <td>${escapeHtml(t.submitter_email || '-')}</td>
        <td><span style="color:${statusColor};">${t.status || '-'}</span></td>
        <td><span style="color:${priorityColor};">${t.priority || '-'}</span></td>
        <td>${formatDate(t.created_at)}</td>
      </tr>`;
    }).join('');
  }

  function formatDate(d) {
    if (!d) return '-';
    return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  init();
</script>
</body>
</html>
