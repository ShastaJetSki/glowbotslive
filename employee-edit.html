<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Employee - WorkLogic Pro</title>
  
  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui;
      background: #0b0f14;
      color: #e8eef6;
    }
    
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #0b0f14;
      border-bottom: 1px solid #223044;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .card {
      background: #0f1621;
      border: 1px solid #223044;
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .avatar-section {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 16px;
      border: 3px solid #223044;
      background: #0f1621;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 40px;
      color: #e8eef6;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .avatar-preview:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }
    
    .avatar-preview::after {
      content: 'ðŸ“·';
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(59, 130, 246, 0.9);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .avatar-preview:hover::after {
      opacity: 1;
    }
    
    .avatar-info {
      flex: 1;
    }
    
    .avatar-info h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
    }
    
    .avatar-info .muted {
      font-size: 14px;
      color: #9fb0c3;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #9fb0c3;
      margin: 0 0 16px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-row {
      margin-bottom: 16px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #9fb0c3;
      margin-bottom: 6px;
    }
    
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #223044;
      background: #1a2535;
      color: #e8eef6;
      font-family: inherit;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    button {
      padding: 10px 18px;
      border-radius: 10px;
      border: 1px solid #2a3b55;
      background: #1a2535;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    
    button:hover {
      background: #243648;
    }
    
    button.primary {
      background: #3b82f6;
      border-color: #3b82f6;
    }
    
    button.primary:hover {
      background: #2563eb;
    }
    
    button.danger {
      background: transparent;
      border-color: #ef4444;
      color: #ef4444;
    }
    
    button.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .message.success {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid #4ade80;
      color: #4ade80;
    }
    
    .message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge.active {
      background: rgba(74, 222, 128, 0.15);
      color: #4ade80;
    }
    
    .badge.inactive {
      background: rgba(156, 163, 175, 0.15);
      color: #9ca3af;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .divider {
      height: 1px;
      background: #223044;
      margin: 24px 0;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }
    
    @media (max-width: 640px) {
      .avatar-section {
        flex-direction: column;
        text-align: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .header-actions {
        flex-direction: column;
        width: 100%;
      }
      
      .header-actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="pageTitle">Edit Employee</h1>
    <div class="header-actions">
      <button onclick="cancel()">Cancel</button>
      <button class="primary" onclick="saveEmployee()">Save Employee</button>
    </div>
  </div>

  <div class="container">
    <div id="messageArea"></div>

    <div class="card">
      <!-- Avatar Section -->
      <div class="avatar-section">
        <div class="avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarUpload').click()">
          <span id="avatarInitials">??</span>
        </div>
        <div class="avatar-info">
          <h2 id="employeeName">New Employee</h2>
          <div class="muted">Click the photo to upload a new image</div>
          <div style="margin-top:8px;">
            <span class="badge" id="statusBadge">Active</span>
            <span class="badge" id="roleBadge" style="background:rgba(59,130,246,0.15); color:#3b82f6; margin-left:8px;">Technician</span>
          </div>
        </div>
      </div>
      
      <input type="file" id="avatarUpload" accept="image/*" />

      <!-- Personal Information -->
      <div class="section-title">Personal Information</div>
      
      <div class="form-grid">
        <div class="form-row">
          <label for="firstName">First Name *</label>
          <input type="text" id="firstName" required />
        </div>
        
        <div class="form-row">
          <label for="lastName">Last Name *</label>
          <input type="text" id="lastName" required />
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-row">
          <label for="email">Email</label>
          <input type="email" id="email" />
        </div>
        
        <div class="form-row">
          <label for="phone">Phone</label>
          <input type="tel" id="phone" placeholder="555-555-5555" />
        </div>
      </div>
      
      <div class="form-row">
        <label for="street">Street Address</label>
        <input type="text" id="street" />
      </div>
      
      <div class="form-grid">
        <div class="form-row">
          <label for="city">City</label>
          <input type="text" id="city" />
        </div>
        
        <div class="form-row">
          <label for="state">State</label>
          <input type="text" id="state" maxlength="2" placeholder="CA" />
        </div>
        
        <div class="form-row">
          <label for="zip">ZIP</label>
          <input type="text" id="zip" maxlength="10" placeholder="96001" />
        </div>
      </div>
      
      <div class="form-row">
        <label for="birthday">Birthday</label>
        <input type="date" id="birthday" />
      </div>

      <div class="divider"></div>

      <!-- Employment Information -->
      <div class="section-title">Employment Information</div>
      
      <div class="form-grid">
        <div class="form-row">
          <label for="employeeRole">Role *</label>
          <select id="employeeRole" required>
            <option value="technician">Technician</option>
            <option value="service_advisor">Service Advisor</option>
            <option value="manager">Manager</option>
            <option value="owner">Owner</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        
        <div class="form-row">
          <label for="laborRate">Hourly Labor Rate ($)</label>
          <input type="number" id="laborRate" step="0.01" min="0" placeholder="125.00" />
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-row">
          <label for="hireDate">Hire Date</label>
          <input type="date" id="hireDate" />
        </div>
        
        <div class="form-row">
          <label for="isActive">Status</label>
          <select id="isActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Additional Information -->
      <div class="section-title">Additional Information</div>
      
      <div class="form-row">
        <label for="certifications">Certifications (comma-separated)</label>
        <input type="text" id="certifications" placeholder="ASE Certified, Brake Specialist, etc." />
      </div>
      
      <div class="form-row">
        <label for="emergencyContact">Emergency Contact</label>
        <input type="text" id="emergencyContact" placeholder="Name: Phone" />
      </div>
      
      <div class="form-row">
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Additional notes about this employee..."></textarea>
      </div>
    </div>

    <!-- Delete Section -->
    <div class="card" id="deleteSection" style="display:none;">
      <div class="section-title" style="color:#ef4444;">Danger Zone</div>
      <p style="color:#9fb0c3; margin:0 0 16px 0;">Deleting this employee will remove them from all records. This action cannot be undone.</p>
      <button class="danger" onclick="deleteEmployee()">Delete Employee</button>
    </div>
  </div>

  <script>
    const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
    const API_BASE = `https://${PROJECT_REF}.supabase.co`;
    const STORAGE_URL = `${API_BASE}/storage/v1`;
    const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

    const urlParams = new URLSearchParams(window.location.search);
    const employeeId = urlParams.get('id');
    const isNewEmployee = urlParams.get('new') === 'true';

    let currentEmployee = null;

    // Phone formatting
    function formatPhoneNumber(value) {
      if (!value) return '';
      const cleaned = value.replace(/\D/g, '');
      if (cleaned.length <= 3) return cleaned;
      if (cleaned.length <= 6) return `${cleaned.slice(0, 3)}-${cleaned.slice(3)}`;
      return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
    }

    document.getElementById('phone').addEventListener('input', function(e) {
      const cursorStart = this.selectionStart;
      const oldLength = this.value.length;
      this.value = formatPhoneNumber(this.value);
      const newLength = this.value.length;
      const diff = newLength - oldLength;
      this.setSelectionRange(cursorStart + diff, cursorStart + diff);
    });

    // Avatar upload
    document.getElementById('avatarUpload').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) return;
      if (file.size > 5 * 1024 * 1024) {
        showMessage('Image must be < 5MB', 'error');
        return;
      }
      
      if (employeeId) {
        await uploadAvatar(file);
      } else {
        // Preview for new employee
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('avatarPreview');
          preview.style.backgroundImage = `url('${e.target.result}')`;
          document.getElementById('avatarInitials').style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });

    async function uploadAvatar(file) {
      const token = localStorage.getItem('sb_access_token');
      if (!token || !employeeId) return;

      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${employeeId}-${Date.now()}.${fileExt}`;

        const uploadResponse = await fetch(`${STORAGE_URL}/object/avatars/${fileName}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'apikey': ANON_KEY,
            'Content-Type': file.type
          },
          body: file
        });

        if (!uploadResponse.ok) throw new Error('Upload failed');

        await fetch(`${API_BASE}/rest/v1/employees?employee_id=eq.${employeeId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': ANON_KEY
          },
          body: JSON.stringify({ avatar_url: fileName })
        });

        showMessage('Photo uploaded!', 'success');
        loadEmployee();
      } catch (err) {
        showMessage('Upload error: ' + err.message, 'error');
      }
    }

    async function validateAuth() {
      const token = localStorage.getItem('sb_access_token');
      if (!token) return null;
      
      const r = await fetch(`${API_BASE}/auth/v1/user`, {
        headers: {
          'apikey': ANON_KEY,
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!r.ok) return null;
      const user = await r.json();
      return { token, user };
    }

    async function getTenantId(token) {
      const r = await fetch(`${API_BASE}/auth/v1/user`, {
        headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
      });
      if (!r.ok) throw new Error("Failed to load user");
      const u = await r.json();
      return u.user_metadata?.tenant_id || u.id;
    }

    function initialsFromName(first, last) {
      const f = (first || "").trim();
      const l = (last || "").trim();
      if (!f && !l) return "??";
      return ((f[0] || "") + (l[0] || "")).toUpperCase();
    }

    function getAvatarUrl(employee) {
      if (employee.avatar_url) {
        if (employee.avatar_url.startsWith('http')) return employee.avatar_url;
        return `${STORAGE_URL}/object/public/avatars/${employee.avatar_url}`;
      }
      return null;
    }

    async function loadEmployee() {
      if (isNewEmployee) {
        document.getElementById('pageTitle').textContent = 'Add New Employee';
        document.getElementById('employeeName').textContent = 'New Employee';
        document.getElementById('deleteSection').style.display = 'none';
        return;
      }

      if (!employeeId) {
        showMessage('No employee ID provided', 'error');
        return;
      }

      const token = localStorage.getItem('sb_access_token');
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/rest/v1/employees?employee_id=eq.${employeeId}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'apikey': ANON_KEY
          }
        });

        if (!response.ok) throw new Error('Failed to load employee');

        const employees = await response.json();
        if (!employees.length) throw new Error('Employee not found');

        currentEmployee = employees[0];
        populateForm(currentEmployee);
        document.getElementById('deleteSection').style.display = 'block';

      } catch (err) {
        showMessage('Error loading employee: ' + err.message, 'error');
      }
    }

    function populateForm(employee) {
      const name = `${employee.first_name || ''} ${employee.last_name || ''}`.trim();
      document.getElementById('pageTitle').textContent = `Edit ${name}`;
      document.getElementById('employeeName').textContent = name || 'Employee';
      
      document.getElementById('firstName').value = employee.first_name || '';
      document.getElementById('lastName').value = employee.last_name || '';
      document.getElementById('employeeRole').value = employee.role || 'technician';
      document.getElementById('isActive').value = employee.is_active ? 'true' : 'false';
      document.getElementById('laborRate').value = employee.hourly_labor_rate || '';

      // Update badges
      document.getElementById('statusBadge').textContent = employee.is_active ? 'Active' : 'Inactive';
      document.getElementById('statusBadge').className = 'badge ' + (employee.is_active ? 'active' : 'inactive');
      document.getElementById('roleBadge').textContent = employee.role || 'Technician';

      // Metadata
      let metadata = {};
      if (employee.metadata) {
        if (typeof employee.metadata === 'string') {
          try { metadata = JSON.parse(employee.metadata); } catch {}
        } else { metadata = employee.metadata; }
      }

      document.getElementById('email').value = metadata.email || '';
      document.getElementById('phone').value = metadata.phone || '';
      document.getElementById('street').value = metadata.street || '';
      document.getElementById('city').value = metadata.city || '';
      document.getElementById('state').value = metadata.state || '';
      document.getElementById('zip').value = metadata.zip || '';
      document.getElementById('birthday').value = metadata.birthday || '';
      document.getElementById('hireDate').value = metadata.hire_date || '';
      document.getElementById('emergencyContact').value = metadata.emergency_contact || '';
      document.getElementById('notes').value = metadata.notes || '';

      if (metadata.certifications && Array.isArray(metadata.certifications)) {
        document.getElementById('certifications').value = metadata.certifications.join(', ');
      }

      // Avatar
      const initials = initialsFromName(employee.first_name, employee.last_name);
      document.getElementById('avatarInitials').textContent = initials;

      const avatarUrl = getAvatarUrl(employee);
      if (avatarUrl) {
        document.getElementById('avatarPreview').style.backgroundImage = `url('${avatarUrl}')`;
        document.getElementById('avatarInitials').style.display = 'none';
      }
    }

    async function saveEmployee() {
      const token = localStorage.getItem('sb_access_token');
      if (!token) {
        showMessage('Not authenticated', 'error');
        return;
      }

      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();

      if (!firstName || !lastName) {
        showMessage('First and last name are required', 'error');
        return;
      }

      try {
        const certInput = document.getElementById('certifications').value.trim();
        const certifications = certInput ? certInput.split(',').map(c => c.trim()).filter(Boolean) : [];

        const metadata = {
          email: document.getElementById('email').value.trim() || null,
          phone: document.getElementById('phone').value.trim() || null,
          street: document.getElementById('street').value.trim() || null,
          city: document.getElementById('city').value.trim() || null,
          state: document.getElementById('state').value.trim() || null,
          zip: document.getElementById('zip').value.trim() || null,
          birthday: document.getElementById('birthday').value || null,
          hire_date: document.getElementById('hireDate').value || null,
          emergency_contact: document.getElementById('emergencyContact').value.trim() || null,
          certifications: certifications.length > 0 ? certifications : null,
          notes: document.getElementById('notes').value.trim() || null
        };

        const employeeData = {
          first_name: firstName,
          last_name: lastName,
          role: document.getElementById('employeeRole').value,
          is_active: document.getElementById('isActive').value === 'true',
          metadata: metadata
        };

        const laborRate = document.getElementById('laborRate').value;
        if (laborRate) {
          employeeData.hourly_labor_rate = parseFloat(laborRate);
        }

        if (isNewEmployee) {
          // Create new employee
          const tenantId = await getTenantId(token);
          employeeData.tenant_id = tenantId;

          const response = await fetch(`${API_BASE}/rest/v1/employees`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'apikey': ANON_KEY,
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(employeeData)
          });

          if (!response.ok) {
            const error = await response.text();
            throw new Error(error || 'Failed to create employee');
          }

          showMessage('Employee created successfully!', 'success');
        } else {
          // Update existing employee
          const response = await fetch(`${API_BASE}/rest/v1/employees?employee_id=eq.${employeeId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'apikey': ANON_KEY,
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(employeeData)
          });

          if (!response.ok) {
            const error = await response.text();
            throw new Error(error || 'Failed to update employee');
          }

          showMessage('Employee updated successfully!', 'success');
        }

        setTimeout(() => {
          window.location.href = 'dashboard-settings.html';
        }, 1500);

      } catch (err) {
        console.error('Save error:', err);
        showMessage('Error saving: ' + err.message, 'error');
      }
    }

    async function deleteEmployee() {
      if (!confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
        return;
      }

      const token = localStorage.getItem('sb_access_token');
      if (!token) return;

      try {
        const response = await fetch(`${API_BASE}/rest/v1/employees?employee_id=eq.${employeeId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'apikey': ANON_KEY
          }
        });

        if (!response.ok) {
          throw new Error('Failed to delete employee');
        }

        showMessage('Employee deleted successfully!', 'success');

        setTimeout(() => {
          window.location.href = 'dashboard-settings.html';
        }, 1000);

      } catch (err) {
        console.error('Delete error:', err);
        showMessage('Error deleting: ' + err.message, 'error');
      }
    }

    function cancel() {
      window.location.href = 'dashboard-settings.html';
    }

    function showMessage(msg, type) {
      const area = document.getElementById('messageArea');
      area.innerHTML = `<div class="message ${type}">${msg}</div>`;
      setTimeout(() => { area.innerHTML = ''; }, 5000);
    }

    async function init() {
      const auth = await validateAuth();
      if (!auth) {
        window.location.href = 'login.html';
        return;
      }

      loadEmployee();
    }

    init();
  </script>
</body>
</html>
