<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMzMzUzNDcsImV4cCI6MjA0ODkxMTM0N30.lXiCI05K9r_1vd6qPn-bXWzRJjQgs38geg71uxiv4CU">
  <title>Work Order - WorkLogicPro</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:#0a0e1a;
      color:#e8eef6;
      line-height:1.6;
    }

    /* Header */
    .header {
      background:#0f1621;
      border-bottom:1px solid #223044;
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:100;
    }
    .businessName {
      font-size:20px;
      font-weight:700;
      color:#e8eef6;
    }
    .logo {
      font-size:16px;
      font-weight:600;
      color:#60a5fa;
    }
    .userInfo {
      font-size:14px;
      color:#9fb0c3;
    }

    /* Container */
    .container {
      max-width:1200px;
      margin:0 auto;
      padding:24px;
    }

    /* Back button */
    .backBtn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      color:#60a5fa;
      text-decoration:none;
      font-size:14px;
      margin-bottom:24px;
    }
    .backBtn:hover {
      background:#2a3b55;
    }

    /* Page title */
    .pageTitle {
      font-size:28px;
      font-weight:700;
      margin-bottom:24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .woNumber {
      font-size:14px;
      color:#9fb0c3;
      font-weight:400;
    }

    /* Card */
    .card {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:12px;
      padding:20px;
      margin-bottom:20px;
    }
    .cardTitle {
      font-size:16px;
      font-weight:600;
      margin-bottom:16px;
      color:#e8eef6;
      padding-bottom:12px;
      border-bottom:1px solid #223044;
    }

    /* Form groups */
    .formRow {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-bottom:16px;
    }
    .formRow.single {
      grid-template-columns:1fr;
    }
    .formGroup {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .formLabel {
      font-size:13px;
      font-weight:600;
      color:#9fb0c3;
    }
    .formLabel.required::after {
      content:" *";
      color:#ef4444;
    }
    .formInput, .formSelect, .formTextarea {
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      padding:10px 12px;
      color:#e8eef6;
      font-size:14px;
      font-family:inherit;
    }
    .formInput:focus, .formSelect:focus, .formTextarea:focus {
      outline:none;
      border-color:#60a5fa;
    }
    .formTextarea {
      min-height:100px;
      resize:vertical;
    }
    .formInput:disabled, .formSelect:disabled {
      opacity:0.6;
      cursor:not-allowed;
    }

    /* Status badges */
    .statusBadge {
      display:inline-block;
      padding:4px 12px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
    }
    .status-draft { background:#374151; color:#d1d5db; }
    .status-scheduled { background:#1e3a8a; color:#93c5fd; }
    .status-in_progress { background:#ea580c; color:#fed7aa; }
    .status-repairing { background:#ea580c; color:#fed7aa; }
    .status-testing { background:#7c3aed; color:#ddd6fe; }
    .status-ready_for_pickup { background:#15803d; color:#bbf7d0; }
    .status-completed { background:#064e3b; color:#a7f3d0; }
    .status-closed { background:#064e3b; color:#a7f3d0; }
    .status-diagnosis_required { background:#ca8a04; color:#fef3c7; }
    .status-customer_approval { background:#ca8a04; color:#fef3c7; }
    .status-awaiting_parts { background:#dc2626; color:#fecaca; }
    .status-parts_on_order { background:#dc2626; color:#fecaca; }

    /* Priority badges */
    .priorityBadge {
      display:inline-block;
      padding:4px 12px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
    }
    .priority-urgent { background:#dc2626; color:#fecaca; }
    .priority-high { background:#ea580c; color:#fed7aa; }
    .priority-normal { background:#1e3a8a; color:#93c5fd; }
    .priority-low { background:#374151; color:#d1d5db; }

    /* Totals section */
    .totalsGrid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:16px;
    }
    .totalRow {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #223044;
    }
    .totalRow:last-child {
      border-bottom:none;
      font-size:18px;
      font-weight:700;
      color:#60a5fa;
    }
    .totalLabel {
      font-size:14px;
      color:#9fb0c3;
    }
    .totalValue {
      font-size:16px;
      font-weight:600;
      color:#e8eef6;
    }

    /* Buttons */
    .btnGroup {
      display:flex;
      gap:12px;
      margin-top:24px;
    }
    .btn {
      padding:12px 24px;
      border-radius:8px;
      border:none;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
    }
    .btnPrimary {
      background:#2563eb;
      color:#fff;
    }
    .btnPrimary:hover {
      background:#1d4ed8;
    }
    .btnSecondary {
      background:#1a2535;
      border:1px solid #223044;
      color:#e8eef6;
    }
    .btnSecondary:hover {
      background:#2a3b55;
    }
    .btnDanger {
      background:#dc2626;
      color:#fff;
    }
    .btnDanger:hover {
      background:#b91c1c;
    }
    .btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }

    /* Timeline */
    .timeline {
      margin-top:16px;
    }
    .timelineItem {
      display:flex;
      gap:12px;
      padding:12px 0;
      border-left:2px solid #223044;
      padding-left:16px;
      position:relative;
    }
    .timelineItem::before {
      content:'';
      position:absolute;
      left:-5px;
      top:16px;
      width:8px;
      height:8px;
      background:#60a5fa;
      border-radius:50%;
    }
    .timelineContent {
      flex:1;
    }
    .timelineText {
      font-size:14px;
      color:#e8eef6;
    }
    .timelineTime {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    /* Messages */
    .message {
      padding:12px 16px;
      border-radius:8px;
      margin-bottom:16px;
      font-size:14px;
    }
    .messageSuccess {
      background:#064e3b;
      border:1px solid #065f46;
      color:#a7f3d0;
    }
    .messageError {
      background:#7f1d1d;
      border:1px solid #991b1b;
      color:#fecaca;
    }

    /* Loading */
    .loading {
      text-align:center;
      padding:40px;
      color:#9fb0c3;
    }

    /* Role info */
    .roleInfo {
      font-size:12px;
      color:#9fb0c3;
      font-style:italic;
      margin-top:8px;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .formRow {
        grid-template-columns:1fr;
      }
      .totalsGrid {
        grid-template-columns:1fr;
      }
      .btnGroup {
        flex-direction:column;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="businessName" id="businessName">Loading...</div>
    <div class="logo">WorkLogicPro</div>
    <div class="userInfo" id="userInfo">Loading...</div>
  </div>

  <div class="container">
    <a href="work-orders.html" class="backBtn">‚Üê Back to Work Orders</a>

    <div class="pageTitle">
      <span id="pageTitle">Loading...</span>
      <span class="woNumber" id="woNumber"></span>
    </div>

    <div id="message"></div>
    <div id="content" class="loading">Loading work order...</div>
  </div>

<script>
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
  const REST_BASE = `${API_BASE}/rest/v1`;
  const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

  let currentUser = null;
  let currentEmployee = null;
  let customers = [];
  let vehicles = [];
  let employees = [];

  // Get work order ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const isNew = true; // Always creating new work orders on this page
  let workOrderId = null;
  let workOrder = null;

  async function validateAuth() {
    const token = localStorage.getItem("sb_access_token");
    if (!token) return null;
    
    try {
      const res = await fetch(`${API_BASE}/auth/v1/user`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) return null;
      return token;
    } catch {
      return null;
    }
  }

  async function fetchJson(url, token) {
    const res = await fetch(url, {
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function fetchRest(table, token, params = "") {
    const url = `${REST_BASE}/${table}?${params}`;
    return fetchJson(url, token);
  }

  function showMessage(text, type = "success") {
    const msg = document.getElementById("message");
    msg.innerHTML = `<div class="message message${type === 'error' ? 'Error' : 'Success'}">${text}</div>`;
    setTimeout(() => msg.innerHTML = "", 5000);
  }

  async function load() {
    const token = await validateAuth();
    if (!token) {
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
      return;
    }

    try {
      // Load current user
      const userRes = await fetch(`${API_BASE}/auth/v1/user`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      currentUser = await userRes.json();

      // Try to get employee record by user_id
      let empData = await fetchRest('employees', token, `user_id=eq.${currentUser.id}`);
      
      // If not found by user_id, get first employee for this tenant (fallback)
      if (!empData || empData.length === 0) {
        // Get tenant_id from localStorage or use default
        const tenantId = localStorage.getItem('tenant_id') || '11111111-1111-1111-1111-111111111111';
        empData = await fetchRest('employees', token, `tenant_id=eq.${tenantId}&limit=1`);
      }
      
      currentEmployee = empData[0];

      if (!currentEmployee) {
        // If still no employee, create a mock one for now
        currentEmployee = {
          employee_id: 'temp',
          tenant_id: '11111111-1111-1111-1111-111111111111',
          first_name: 'User',
          last_name: '',
          role: 'manager' // Default to manager permissions
        };
      }

      // Set user info
      document.getElementById('userInfo').textContent = 
        `${currentEmployee.first_name} ${currentEmployee.last_name} (${currentEmployee.role})`;
      document.getElementById('businessName').textContent = 'Shasta Jet Ski Service';

      // Load data
      const [customersData, vehiclesData, employeesData] = await Promise.all([
        fetchRest('customers', token, `tenant_id=eq.${currentEmployee.tenant_id}&order=last_name`),
        fetchRest('vehicles', token, `tenant_id=eq.${currentEmployee.tenant_id}`),
        fetchRest('employees', token, `tenant_id=eq.${currentEmployee.tenant_id}&role=eq.technician&order=last_name`)
      ]);

      customers = customersData;
      vehicles = vehiclesData;
      employees = employeesData;

      render();

    } catch (err) {
      console.error('Load error:', err);
      document.getElementById('content').innerHTML = 
        `<div class="message messageError">Error loading: ${err.message}</div>`;
    }
  }

  function render() {
    const isOwnerOrManager = ['owner', 'manager'].includes(currentEmployee.role);
    const isTech = currentEmployee.role === 'technician';

    document.getElementById('pageTitle').textContent = 'Create Work Order';
    document.getElementById('woNumber').textContent = '';

    const content = `
      ${renderCustomerVehicleSection()}
      ${renderServiceDetailsSection(isTech)}
      ${renderSchedulingSection(isOwnerOrManager)}
      ${renderTotalsSection(isOwnerOrManager)}
      ${renderButtons(isOwnerOrManager)}
    `;

    document.getElementById('content').innerHTML = content;

    // Attach event listeners
    attachEventListeners();
  }

  function renderCustomerVehicleSection() {
    const disabled = workOrder && currentEmployee.role === 'technician' ? 'disabled' : '';
    
    return `
      <div class="card">
        <div class="cardTitle">Customer & Vehicle</div>
        <div class="formRow">
          <div class="formGroup">
            <label class="formLabel required">Customer</label>
            <select class="formSelect" id="customer_id" ${disabled}>
              <option value="">Select customer...</option>
              ${customers.map(c => `
                <option value="${c.customer_id}" ${workOrder?.customer_id === c.customer_id ? 'selected' : ''}>
                  ${c.first_name} ${c.last_name}
                </option>
              `).join('')}
            </select>
          </div>
          <div class="formGroup">
            <label class="formLabel required">Vehicle</label>
            <select class="formSelect" id="vehicle_id" ${disabled}>
              <option value="">Select vehicle...</option>
              ${vehicles.map(v => `
                <option value="${v.vehicle_id}" ${workOrder?.vehicle_id === v.vehicle_id ? 'selected' : ''}>
                  ${v.year} ${v.make} ${v.model}
                </option>
              `).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  }

  function renderServiceDetailsSection(isTech) {
    const summaryDisabled = (workOrder && isTech) ? 'disabled' : '';
    
    return `
      <div class="card">
        <div class="cardTitle">Service Details</div>
        <div class="formRow single">
          <div class="formGroup">
            <label class="formLabel required">Service Summary</label>
            <input type="text" class="formInput" id="summary" 
              value="${workOrder?.summary || ''}" 
              placeholder="e.g., Brake system overhaul"
              ${summaryDisabled}>
          </div>
        </div>
        <div class="formRow single">
          <div class="formGroup">
            <label class="formLabel">Customer Concerns / Details</label>
            <textarea class="formTextarea" id="customer_notes" 
              placeholder="What is the customer reporting?">${workOrder?.customer_notes || ''}</textarea>
          </div>
        </div>
        <div class="formRow single">
          <div class="formGroup">
            <label class="formLabel">Service Details</label>
            <textarea class="formTextarea" id="details" 
              placeholder="Detailed description of work to be performed...">${workOrder?.details || ''}</textarea>
          </div>
        </div>
        <div class="formRow single">
          <div class="formGroup">
            <label class="formLabel">Tech Notes (Internal)</label>
            <textarea class="formTextarea" id="internal_notes" 
              placeholder="Internal notes visible only to staff...">${workOrder?.internal_notes || ''}</textarea>
            ${isTech ? '<div class="roleInfo">As a technician, you can edit tech notes.</div>' : ''}
          </div>
        </div>
      </div>
    `;
  }

  function renderSchedulingSection(isOwnerOrManager) {
    const disabled = !isOwnerOrManager ? 'disabled' : '';
    
    return `
      <div class="card">
        <div class="cardTitle">Scheduling & Assignment</div>
        <div class="formRow">
          <div class="formGroup">
            <label class="formLabel required">Status</label>
            <select class="formSelect" id="status">
              <option value="draft" ${workOrder?.status === 'draft' ? 'selected' : ''}>Draft</option>
              <option value="scheduled" ${workOrder?.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
              <option value="in_progress" ${workOrder?.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
              <option value="repairing" ${workOrder?.status === 'repairing' ? 'selected' : ''}>Repairing</option>
              <option value="testing" ${workOrder?.status === 'testing' ? 'selected' : ''}>Testing</option>
              <option value="ready_for_pickup" ${workOrder?.status === 'ready_for_pickup' ? 'selected' : ''}>Ready for Pickup</option>
              <option value="completed" ${workOrder?.status === 'completed' ? 'selected' : ''}>Completed</option>
              <option value="closed" ${workOrder?.status === 'closed' ? 'selected' : ''}>Closed</option>
              <option value="diagnosis_required" ${workOrder?.status === 'diagnosis_required' ? 'selected' : ''}>Diagnosis Required</option>
              <option value="customer_approval" ${workOrder?.status === 'customer_approval' ? 'selected' : ''}>Customer Approval</option>
              <option value="awaiting_parts" ${workOrder?.status === 'awaiting_parts' ? 'selected' : ''}>Awaiting Parts</option>
              <option value="parts_on_order" ${workOrder?.status === 'parts_on_order' ? 'selected' : ''}>Parts on Order</option>
            </select>
          </div>
          <div class="formGroup">
            <label class="formLabel required">Priority</label>
            <select class="formSelect" id="priority">
              <option value="low" ${workOrder?.priority === 'low' ? 'selected' : ''}>Low</option>
              <option value="normal" ${!workOrder || workOrder?.priority === 'normal' ? 'selected' : ''}>Normal</option>
              <option value="high" ${workOrder?.priority === 'high' ? 'selected' : ''}>High</option>
              <option value="urgent" ${workOrder?.priority === 'urgent' ? 'selected' : ''}>Urgent</option>
            </select>
          </div>
        </div>
        <div class="formRow">
          <div class="formGroup">
            <label class="formLabel">Assigned Technician</label>
            <select class="formSelect" id="assigned_employee_id" ${disabled}>
              <option value="">Unassigned</option>
              ${employees.map(e => `
                <option value="${e.employee_id}" ${workOrder?.assigned_employee_id === e.employee_id ? 'selected' : ''}>
                  ${e.first_name} ${e.last_name}
                </option>
              `).join('')}
            </select>
            ${!isOwnerOrManager ? '<div class="roleInfo">Only managers can reassign work orders.</div>' : ''}
          </div>
          <div class="formGroup">
            <label class="formLabel">Scheduled Start</label>
            <input type="datetime-local" class="formInput" id="scheduled_start" 
              value="${workOrder?.scheduled_start ? new Date(workOrder.scheduled_start).toISOString().slice(0, 16) : ''}">
          </div>
        </div>
        <div class="formRow">
          <div class="formGroup">
            <label class="formLabel">Scheduled End</label>
            <input type="datetime-local" class="formInput" id="scheduled_end" 
              value="${workOrder?.scheduled_end ? new Date(workOrder.scheduled_end).toISOString().slice(0, 16) : ''}">
          </div>
          <div class="formGroup">
            <!-- Spacer -->
          </div>
        </div>
      </div>
    `;
  }

  function renderTotalsSection(isOwnerOrManager) {
    const disabled = !isOwnerOrManager ? 'disabled' : '';
    
    return `
      <div class="card">
        <div class="cardTitle">Pricing & Totals</div>
        ${!isOwnerOrManager ? '<div class="roleInfo">Only managers can edit pricing.</div>' : ''}
        <div class="formRow">
          <div class="formGroup">
            <label class="formLabel">Labor Total</label>
            <input type="number" class="formInput" id="labor_total" 
              value="${workOrder?.labor_total || '0.00'}" 
              step="0.01" min="0" ${disabled}>
          </div>
          <div class="formGroup">
            <label class="formLabel">Parts Total</label>
            <input type="number" class="formInput" id="parts_total" 
              value="${workOrder?.parts_total || '0.00'}" 
              step="0.01" min="0" ${disabled}>
          </div>
        </div>
        <div class="formRow">
          <div class="formGroup">
            <label class="formLabel">Tax Total</label>
            <input type="number" class="formInput" id="tax_total" 
              value="${workOrder?.tax_total || '0.00'}" 
              step="0.01" min="0" ${disabled}>
          </div>
          <div class="formGroup">
            <label class="formLabel">Grand Total</label>
            <input type="number" class="formInput" id="grand_total" 
              value="${workOrder?.grand_total || '0.00'}" 
              step="0.01" min="0" ${disabled}>
          </div>
        </div>
        <div class="totalsGrid">
          <div>
            <div class="totalRow">
              <span class="totalLabel">Labor:</span>
              <span class="totalValue" id="display_labor">$${parseFloat(workOrder?.labor_total || 0).toFixed(2)}</span>
            </div>
            <div class="totalRow">
              <span class="totalLabel">Parts:</span>
              <span class="totalValue" id="display_parts">$${parseFloat(workOrder?.parts_total || 0).toFixed(2)}</span>
            </div>
          </div>
          <div>
            <div class="totalRow">
              <span class="totalLabel">Tax:</span>
              <span class="totalValue" id="display_tax">$${parseFloat(workOrder?.tax_total || 0).toFixed(2)}</span>
            </div>
            <div class="totalRow">
              <span class="totalLabel">Grand Total:</span>
              <span class="totalValue" id="display_grand">$${parseFloat(workOrder?.grand_total || 0).toFixed(2)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderHistorySection() {
    if (!workOrder) return '';
    
    return `
      <div class="card">
        <div class="cardTitle">Change History</div>
        <div class="timeline">
          <div class="timelineItem">
            <div class="timelineContent">
              <div class="timelineText">Work order created</div>
              <div class="timelineTime">${new Date(workOrder.created_at).toLocaleString()}</div>
            </div>
          </div>
          ${workOrder.last_change_summary ? `
            <div class="timelineItem">
              <div class="timelineContent">
                <div class="timelineText">${workOrder.last_change_summary}</div>
                <div class="timelineTime">
                  ${new Date(workOrder.last_change_at).toLocaleString()} 
                  by ${workOrder.last_change_role}
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  function renderButtons(isOwnerOrManager) {
    return `
      <div class="btnGroup">
        <button class="btn btnPrimary" onclick="saveWorkOrder()">
          Create Work Order
        </button>
        <button class="btn btnSecondary" onclick="window.location.href='work-orders.html'">
          Cancel
        </button>
      </div>
    `;
  }

  function attachEventListeners() {
    // Update totals display when inputs change
    ['labor_total', 'parts_total', 'tax_total', 'grand_total'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          const val = parseFloat(el.value) || 0;
          document.getElementById(`display_${id.replace('_total', '')}`).textContent = 
            `$${val.toFixed(2)}`;
        });
      }
    });
  }

  async function saveWorkOrder() {
    const token = await validateAuth();
    if (!token) {
      location.replace("login.html");
      return;
    }

    try {
      // Gather form data
      const data = {
        tenant_id: currentEmployee.tenant_id,
        customer_id: document.getElementById('customer_id').value,
        vehicle_id: document.getElementById('vehicle_id').value,
        status: document.getElementById('status').value,
        priority: document.getElementById('priority').value,
        summary: document.getElementById('summary').value,
        details: document.getElementById('details').value || null,
        customer_notes: document.getElementById('customer_notes').value || null,
        internal_notes: document.getElementById('internal_notes').value || null,
        assigned_employee_id: document.getElementById('assigned_employee_id').value || null,
        scheduled_start: document.getElementById('scheduled_start').value ? new Date(document.getElementById('scheduled_start').value).toISOString() : null,
        scheduled_end: document.getElementById('scheduled_end').value ? new Date(document.getElementById('scheduled_end').value).toISOString() : null,
        labor_total: parseFloat(document.getElementById('labor_total').value) || 0,
        parts_total: parseFloat(document.getElementById('parts_total').value) || 0,
        tax_total: parseFloat(document.getElementById('tax_total').value) || 0,
        grand_total: parseFloat(document.getElementById('grand_total').value) || 0,
        last_change_summary: isNew ? 'Work order created' : 'Work order updated',
        last_change_role: currentEmployee.role,
        last_change_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      // Validate required fields
      if (!data.customer_id || !data.vehicle_id || !data.summary || !data.status) {
        throw new Error('Please fill in all required fields');
      }

      let url = `${REST_BASE}/work_orders`;
      let method = 'POST';
      data.created_at = new Date().toISOString();
      data.deleted = false;

      const res = await fetch(url, {
        method: method,
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          "Prefer": "return=representation"
        },
        body: JSON.stringify(data)
      });

      if (!res.ok) {
        const error = await res.text();
        throw new Error(`Save failed: ${error}`);
      }

      showMessage('Work order created successfully!');
      
      setTimeout(() => {
        window.location.href = 'work-orders.html';
      }, 1500);

    } catch (err) {
      console.error('Save error:', err);
      showMessage(err.message, 'error');
    }
  }

  async function deleteWorkOrder() {
    if (!confirm('Are you sure you want to delete this work order? This action cannot be undone.')) {
      return;
    }

    const token = await validateAuth();
    if (!token) {
      location.replace("login.html");
      return;
    }

    try {
      const res = await fetch(`${REST_BASE}/work_orders?work_order_id=eq.${workOrderId}`, {
        method: 'PATCH',
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          deleted: true,
          last_change_summary: 'Work order deleted',
          last_change_role: currentEmployee.role,
          last_change_at: new Date().toISOString()
        })
      });

      if (!res.ok) {
        throw new Error('Delete failed');
      }

      showMessage('Work order deleted successfully!');
      setTimeout(() => {
        window.location.href = 'dashboard-business.html';
      }, 1500);

    } catch (err) {
      console.error('Delete error:', err);
      showMessage(err.message, 'error');
    }
  }

  // Initialize
  load();
</script>

</body>
</html>
