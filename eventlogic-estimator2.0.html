<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Event Estimator â€” EventLogicPro</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ===== THEME DEFINITIONS ===== */
    :root { --bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa; }
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fefcf8;--bg-secondary:#faf6ee;--bg-card:#fff;--bg-hover:#f5efe0;--border-default:#e8dcc8;--text-primary:#44402a;--text-secondary:#6a6550;--accent-primary:#a89060;--accent-light:#c4aa78;}

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;}
    body{padding-bottom:120px;}
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}

    /* === SHARED LAYOUT (from eventlogicpro.html) === */
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .theme-toast{position:fixed;bottom:200px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;z-index:1000;display:none;}
    .theme-toast.show{display:block;animation:toastIn .3s ease;}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
    .desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border-default);}
    .mobile-top-header{display:block;position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);}
    .mobile-header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px;gap:12px;}
    .mobile-menu-toggle{background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text-secondary);font-size:20px;padding:0;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-appearance:none;}
    .mobile-header-center{flex:1;}.mobile-header-title{font-size:18px;font-weight:600;}
    .business-name{font-size:12px;color:var(--accent-light);}
    .mobile-header-right{display:flex;align-items:center;gap:12px;}
    .accordion-icon-header{font-size:20px;color:var(--text-secondary);transition:transform .2s ease;}
    .mobile-menu-toggle.active .accordion-icon-header{transform:rotate(180deg);}
    .mobile-header-content{max-height:0;overflow:hidden;transition:max-height .3s ease;}
    .mobile-header-content.expanded{max-height:200px;}
    .mobile-header-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:8px 12px 12px;background:var(--bg-primary);border-top:1px solid var(--border-default);}
    .mobile-header-actions button{padding:10px;font-size:13px;background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border:1px solid color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--accent-light);border-radius:8px;cursor:pointer;-webkit-appearance:none;}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:6px 8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;}
    .mobile-nav-btn{padding:8px 4px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:40px;-webkit-appearance:none;transition:all .2s;}
    .mobile-nav-btn:active{transform:scale(.95);}
    .mobile-nav-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}
    .content{padding:12px;max-width:1100px;margin:0 auto;}
    @media(max-width:768px){.desktop-header{display:none!important;}.mobile-top-header{display:block;}.mobile-bottom-nav{display:block!important;}}
    @media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}body{padding-bottom:20px;}}

    /* === ESTIMATOR SPECIFIC === */
    .ebar{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid var(--border-default);}
    .ebar-row{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;align-items:end;}
    @media(max-width:640px){.ebar-row{grid-template-columns:1fr;}}
    .fl{display:block;font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
    .fi{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:14px;font-family:inherit;-webkit-appearance:none;}
    .fi:focus{outline:none;border-color:var(--accent-primary);}
    .esel{flex:1;min-width:140px;padding:10px 12px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:14px;font-weight:600;-webkit-appearance:none;cursor:pointer;}

    /* Summary cards */
    .sbar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
    .scard{background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;padding:14px 16px;text-align:center;}
    .scard .slb{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:4px;}
    .scard .svl{font-size:22px;font-weight:800;font-variant-numeric:tabular-nums;}
    .scard.ex .svl{color:#ef4444;}.scard.rv .svl{color:#22c55e;}
    .scard.pf .svl.pos{color:#22c55e;}.scard.pf .svl.neg{color:#ef4444;}
    .scard.it .svl{color:var(--accent-light);}
    @media(max-width:640px){.sbar{grid-template-columns:repeat(2,1fr);}}

    /* Category sections */
    .csec{background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;margin-bottom:6px;overflow:hidden;transition:transform .15s,box-shadow .15s,border-color .15s;}
    .csec.drag-over{border-color:var(--accent-primary);box-shadow:0 0 0 2px color-mix(in srgb,var(--accent-primary) 30%,transparent);}
    .csec.dragging{opacity:.5;transform:scale(.98);}
    .chdr{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;user-select:none;-webkit-user-select:none;transition:background .15s;}
    .chdr:hover{background:var(--bg-hover);}
    .cleft{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
    .cdrag{width:20px;height:20px;cursor:grab;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);opacity:.4;flex-shrink:0;font-size:14px;transition:opacity .15s;}
    .cdrag:hover{opacity:1;}
    .cdrag:active{cursor:grabbing;}
    .cdot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
    .cttl{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .ccnt{font-size:11px;color:var(--text-secondary);}
    .cright{display:flex;align-items:center;gap:10px;}
    .ctot{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums;}
    .cdel{width:24px;height:24px;border-radius:6px;border:none;background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .15s;}
    .chdr:hover .cdel{opacity:.6;}
    .cdel:hover{opacity:1!important;background:rgba(239,68,68,.15);color:#ef4444;}
    .cchv{font-size:11px;color:var(--text-secondary);transition:transform .2s;flex-shrink:0;}
    .csec.expanded .cchv{transform:rotate(180deg);}
    .cbody{max-height:0;overflow:hidden;transition:max-height .35s ease;}
    .csec.expanded .cbody{max-height:5000px;}
    .cinner{padding:0 16px 14px;}

    /* Line items */
    .lhdr{display:grid;grid-template-columns:1fr 110px 110px 28px;gap:8px;padding:0 0 6px;border-bottom:2px solid var(--border-default);margin-bottom:2px;}
    .lhdr span{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);}
    .lhdr span:nth-child(2),.lhdr span:nth-child(3){text-align:right;}
    .lrow{display:grid;grid-template-columns:1fr 110px 110px 28px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid var(--border-default);}
    .lrow:last-child{border-bottom:none;}
    .lname{background:transparent;border:none;color:var(--text-primary);font-size:13px;font-family:inherit;width:100%;outline:none;padding:4px 0;}
    .lname::placeholder{color:var(--text-secondary);opacity:.5;}
    .lrow input[type="number"]{width:100%;padding:6px 8px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-primary);color:var(--text-primary);font-size:13px;font-family:inherit;text-align:right;font-variant-numeric:tabular-nums;-moz-appearance:textfield;-webkit-appearance:none;}
    .lrow input[type="number"]:focus{outline:none;border-color:var(--accent-primary);}
    .lrm{width:24px;height:24px;border-radius:6px;border:none;background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .lrm:hover{background:rgba(239,68,68,.15);color:#ef4444;}
    .ladd{display:inline-block;padding:6px 0;font-size:12px;font-weight:600;color:var(--accent-light);background:transparent;border:none;cursor:pointer;font-family:inherit;margin-top:4px;}
    .ladd:hover{text-decoration:underline;}
    @media(max-width:640px){.lrow,.lhdr{grid-template-columns:1fr 80px 80px 24px;}}

    /* Toolbar */
    .tbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;}
    .tlbl{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);}
    .tbtns{display:flex;gap:6px;}
    .tbtn{padding:6px 12px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;}
    .tbtn:hover{background:var(--bg-hover);color:var(--text-primary);}

    /* Action bar */
    .actbar{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border-default);}
    .abtn{padding:10px 18px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;}
    .abtn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .abtn.pri{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);}
    .abtn.pri:hover{opacity:.9;}
    @media(max-width:640px){.actbar{flex-wrap:wrap;}.abtn{flex:1;text-align:center;}}

    /* Add category modal */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-bg.show{display:flex;}
    .modal{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;padding:24px;width:90%;max-width:400px;}
    .modal h3{margin-bottom:16px;font-size:18px;}
    .modal .fi{margin-bottom:12px;}
    .modal-row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}
    .color-picks{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
    .cpick{width:28px;height:28px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:border-color .15s;}
    .cpick.sel{border-color:var(--text-primary);}

    @media print{.desktop-header,.mobile-top-header,.mobile-bottom-nav,.actbar,.ladd,.lrm,.tbtns,.cdrag,.cdel{display:none!important;}body{background:#fff;color:#000;padding:0;}.content{max-width:100%;padding:10px;}.scard,.csec,.ebar{border:1px solid #ddd;break-inside:avoid;}.cbody{max-height:none!important;overflow:visible!important;}}
  </style>
</head>
<body>

<!-- Mobile Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="togMob(this)"><span class="accordion-icon-header">&#9776;</span></button>
    <div class="mobile-header-center"><div class="mobile-header-title">Event Estimator</div><div class="business-name" id="mobBiz">Loading...</div></div>
    <div class="mobile-header-right"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button></div>
  </div>
  <div class="mobile-header-content" id="mobMenu"><div class="mobile-header-actions"><button onclick="location.href='eventlogicpro-settings.html'">Settings</button><button onclick="doLogout()">Logout</button></div></div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;">
    <div><h1 style="margin:0;font-size:32px;font-weight:600;">EventLogicPro</h1><div class="business-name" id="deskBiz">Loading...</div></div>
    <div style="display:flex;align-items:center;gap:16px;"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button><a onclick="doLogout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a></div>
  </div>
  <div style="padding:0 24px 12px;"><nav style="display:flex;gap:24px;"><a href="eventlogicpro.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Events</a><a href="eventlogicpro-scheduler.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Scheduler</a><a href="eventlogicpro-members.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Members</a><a href="eventlogicpro-estimator.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">Estimator</a><a href="eventlogicpro-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a></nav></div>
</div>

<div class="content">
  <!-- Event Info -->
  <div class="ebar">
    <div class="ebar-row">
      <div><label class="fl">Event Name</label><input type="text" class="fi" id="eName" placeholder="e.g., Summer Bash 2026" oninput="markDirty()"></div>
      <div><label class="fl">Event Date</label><input type="date" class="fi" id="eDate" oninput="markDirty()"></div>
      <div><label class="fl">Expected Attendance</label><input type="number" class="fi" id="eAtt" placeholder="200" oninput="markDirty()"></div>
    </div>
  </div>

  <!-- Summary -->
  <div class="sbar">
    <div class="scard ex"><div class="slb">Total Expenses</div><div class="svl" id="totExp">$0</div></div>
    <div class="scard rv"><div class="slb">Total Revenue</div><div class="svl" id="totRev">$0</div></div>
    <div class="scard pf"><div class="slb">Net Profit / Loss</div><div class="svl" id="totNet">$0</div></div>
    <div class="scard it"><div class="slb">Line Items</div><div class="svl" id="totLI">0</div></div>
  </div>

  <!-- Expense Toolbar -->
  <div class="tbar"><span class="tlbl">Expense Departments</span><div class="tbtns"><button class="tbtn" onclick="openAddCat('expense')">+ Add Dept</button><button class="tbtn" onclick="togAll()" id="togBtn">Expand All</button><button class="tbtn" onclick="window.print()">Print</button></div></div>
  <div id="expBox"></div>

  <!-- Revenue Toolbar -->
  <div class="tbar" style="margin-top:20px;"><span class="tlbl" style="color:#22c55e;">Revenue Sources</span><div class="tbtns"><button class="tbtn" onclick="openAddCat('revenue')">+ Add Source</button></div></div>
  <div id="revBox"></div>

  <!-- Actions -->
  <div class="actbar">
    <button class="abtn" onclick="resetValues()">Reset Values</button>
    <button class="abtn" onclick="exportCSV()">Export CSV</button>
    <button class="abtn pri" onclick="saveToDb()">Save Estimate</button>
  </div>
</div>

<!-- Add Category Modal -->
<div class="modal-bg" id="addModal">
  <div class="modal">
    <h3 id="addModalTitle">Add Department</h3>
    <label class="fl">Name</label>
    <input type="text" class="fi" id="newCatName" placeholder="Department name">
    <label class="fl">Color</label>
    <div class="color-picks" id="colorPicks"></div>
    <div class="modal-row">
      <button class="abtn" onclick="closeModal()">Cancel</button>
      <button class="abtn pri" onclick="confirmAddCat()">Add</button>
    </div>
  </div>
</div>

<div id="themeToast" class="theme-toast"></div>
<div class="mobile-bottom-nav"><div class="mobile-nav-top"><a href="eventlogicpro.html" class="mobile-nav-btn">Events</a><a href="eventlogicpro-scheduler.html" class="mobile-nav-btn">Scheduler</a><a href="eventlogicpro-members.html" class="mobile-nav-btn">Members</a><a href="eventlogicpro-estimator.html" class="mobile-nav-btn active">Estimator</a><a href="eventlogicpro-settings.html" class="mobile-nav-btn">Settings</a></div></div>

<script>
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);
var tenantId=null,userId=null,dirty=false;

// ===== THEME =====
var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal','cyber','amber','honey','crimson','coral','rose','sand'];
var ti=themes.indexOf(localStorage.getItem('app-theme')||'dark-blue');if(ti<0)ti=0;
function cycleTheme(){ti=(ti+1)%themes.length;var t=themes[ti];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);toast('Theme: '+t.replace(/-/g,' '));}
function toast(m){var t=document.getElementById('themeToast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2500);}
function togMob(b){document.getElementById('mobMenu').classList.toggle('expanded');b.classList.toggle('active');}
async function doLogout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}

// ===== AUTH =====
async function checkAuth(){
  var r=await sb.auth.getSession();var s=r.data.session;
  if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');
    if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}
    if(!s){window.location.href='login.html';return null;}}
  return s;
}

// ===== PALETTE =====
var COLORS=['#3b82f6','#f97316','#8b5cf6','#ec4899','#14b8a6','#6366f1','#ef4444','#0ea5e9','#a78bfa','#f472b6','#fbbf24','#22c55e','#fb923c','#dc2626','#06b6d4','#84cc16','#e879f9','#f43f5e','#10b981','#64748b'];

// ===== DEFAULT CATEGORIES =====
var DEF_EXP=[
  {id:'venue',color:'#3b82f6',title:'Venue',items:['Locate potential venues / get rental details','Construct proposal with budget','Secure venue','Site plan for event considering all depts','Power upgrades']},
  {id:'food',color:'#f97316',title:'Food',items:['Multi-level menu creation','Sponsor menu','Food shopping','Food service area setup','Rental equipment for food service']},
  {id:'bar',color:'#8b5cf6',title:'Bar',items:['Inventory & restock order','Specials drink menu','Sponsor drink special','Hire bartenders / bar backs','Ice machine / coolers','Outside bar setup']},
  {id:'entertainment',color:'#ec4899',title:'Entertainment Booking',items:['Headliner booking','Band support','Band opener','Go-Go dancers / performers','Deposits & payments','Backstage area setup','Sound/stage requirements']},
  {id:'rentals',color:'#14b8a6',title:'Rentals',items:['Department rental needs collection','Porta potties & sinks','Shuttle vans','Tables / chairs / tents','Delivery & pickup scheduling']},
  {id:'stage_sound',color:'#6366f1',title:'Stage / Lights / Sound',items:['Indoor equipment test & setup','Outdoor equipment test & setup','XLR cables count & test','Speaker repair/replace','Dance platform setup','Lighting setup (indoor/outdoor/cage)','Live sound operation']},
  {id:'security',color:'#ef4444',title:'Security',items:['Pay gate setup','Lower gate post','Guard schedules (pay gate & lower gate)','Shuttle driver schedules','Radios (inspect/test/charge)','Security post manning','Personnel pay']},
  {id:'parking',color:'#0ea5e9',title:'Parking',items:['Secure Parking Lot A','Secure Parking Lot B','Secure Parking Lot C (overflow)','Security coordination per lot','Signage creation','Post locations to socials & web']},
  {id:'permits',color:'#a78bfa',title:'Permits & Licenses',items:['Identify permits & licenses needed','Application fees','Permit processing']},
  {id:'media',color:'#f472b6',title:'Media & Print',items:['Handbill flyer design & print','Poster AD 11x17','Event ticket design & print','Shirt design (front & back)','Poster for sale at event','Website ads','Mobile ads']},
  {id:'merch',color:'#fbbf24',title:'Merchandise',items:['Merch budget establishment','Event shirt order','Merch booth items (shirts, hats, etc.)','Poker chips','Sponsor shirt bagging','Thank you notes with event art','Merch booth setup']},
  {id:'sponsors',color:'#22c55e',title:'Sponsors',items:['Sponsor donation collection','VIP sponsor experience package','Banner locations & posting','Sponsor certificates','Thank you notes & invoices']},
  {id:'vendors',color:'#fb923c',title:'Vendors',items:['Vendor power mapping','Web booking slot setup','Vendor site map creation','Powered/non-powered zone pricing','Vendor location verification']},
  {id:'medical',color:'#dc2626',title:'Medical',items:['Medical supply inventory','Supply restock','Emergency medical location/tent','Medical water cooler']},
  {id:'socials',color:'#06b6d4',title:'Social Media',items:['Social media countdown campaign','Media asset meetings','Campaign ad creation','Post scheduling']},
  {id:'website',color:'#84cc16',title:'Website',items:['Event page creation/updates','Ticket integration','Site map hosting','Event info updates']}
];
var DEF_REV=[
  {id:'rev_tickets',color:'#22c55e',title:'Ticket Sales',items:['General admission','VIP tickets','Early bird tickets']},
  {id:'rev_sponsors',color:'#16a34a',title:'Sponsor Revenue',items:['Platinum sponsors','Gold sponsors','Silver sponsors','Media sponsors']},
  {id:'rev_vendors',color:'#059669',title:'Vendor Fees',items:['Powered booth fees','Non-powered booth fees']},
  {id:'rev_bar',color:'#10b981',title:'Bar Revenue',items:['Drink sales estimate']},
  {id:'rev_merch',color:'#34d399',title:'Merch Sales',items:['Shirt sales','Hat sales','Other merch']}
];

// ===== STATE =====
var expCats=[],revCats=[]; // {id,color,title,items:[{name,est,act}]}
var expandedSet=new Set(),allExpanded=false;
var addingType='expense',selColor=COLORS[0];
var dragSrcIdx=null,dragType=null;

function initDefaults(){
  expCats=DEF_EXP.map(function(c){return{id:c.id,color:c.color,title:c.title,items:c.items.map(function(n){return{name:n,est:0,act:0};})};});
  revCats=DEF_REV.map(function(c){return{id:c.id,color:c.color,title:c.title,items:c.items.map(function(n){return{name:n,est:0,act:0};})};});
}

// ===== RENDERING =====
function render(){
  document.getElementById('expBox').innerHTML=expCats.map(function(c,i){return renderCat(c,i,'expense');}).join('');
  document.getElementById('revBox').innerHTML=revCats.map(function(c,i){return renderCat(c,i,'revenue');}).join('');
  expandedSet.forEach(function(id){var e=document.getElementById('sec-'+id);if(e)e.classList.add('expanded');});
  if(allExpanded)document.querySelectorAll('.csec').forEach(function(e){e.classList.add('expanded');});
  calcTotals();
  attachDragHandles();
}

function renderCat(c,idx,type){
  var items=c.items||[];
  var tot=items.reduce(function(s,i){return s+(parseFloat(i.est)||0);},0);
  var filled=items.filter(function(i){return(parseFloat(i.est)||0)>0;}).length;
  var h='<div class="csec" id="sec-'+c.id+'" data-idx="'+idx+'" data-type="'+type+'">';
  h+='<div class="chdr">';
  h+='<div class="cleft">';
  h+='<div class="cdrag" draggable="true" title="Drag to reorder">&#9783;</div>';
  h+='<div class="cdot" style="background:'+c.color+';"></div>';
  h+='<div style="min-width:0;"><div class="cttl">'+esc(c.title)+'</div>';
  h+='<div class="ccnt">'+filled+' of '+items.length+' items budgeted</div></div></div>';
  h+='<div class="cright">';
  h+='<div class="ctot" style="color:'+c.color+';">$'+fmt(tot)+'</div>';
  h+='<button class="cdel" onclick="event.stopPropagation();deleteCat(\''+type+'\','+idx+')" title="Delete">&times;</button>';
  h+='<span class="cchv" onclick="toggleSec(\''+c.id+'\')">&#9660;</span>';
  h+='</div></div>';
  h+='<div class="cbody"><div class="cinner">';
  h+='<div class="lhdr"><span>Item</span><span>Estimated</span><span>Actual</span><span></span></div>';
  items.forEach(function(item,li){
    h+='<div class="lrow">';
    h+='<input type="text" class="lname" value="'+esc(item.name)+'" onchange="updName(\''+type+'\','+idx+','+li+',this.value)" placeholder="Line item name">';
    h+='<input type="number" value="'+(item.est||'')+'" placeholder="0.00" step="0.01" oninput="updVal(\''+type+'\','+idx+','+li+',\'est\',this.value)">';
    h+='<input type="number" value="'+(item.act||'')+'" placeholder="0.00" step="0.01" oninput="updVal(\''+type+'\','+idx+','+li+',\'act\',this.value)">';
    h+='<button class="lrm" onclick="rmItem(\''+type+'\','+idx+','+li+')" title="Remove">&times;</button>';
    h+='</div>';
  });
  h+='<button class="ladd" onclick="addItem(\''+type+'\','+idx+')">+ Add line item</button>';
  h+='</div></div></div>';
  return h;
}

// ===== DRAG & DROP =====
function attachDragHandles(){
  document.querySelectorAll('.cdrag').forEach(function(handle){
    var sec=handle.closest('.csec');
    handle.addEventListener('dragstart',function(e){
      dragSrcIdx=parseInt(sec.dataset.idx);
      dragType=sec.dataset.type;
      sec.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
      e.dataTransfer.setData('text/plain',dragSrcIdx);
    });
    handle.addEventListener('dragend',function(){
      sec.classList.remove('dragging');
      document.querySelectorAll('.csec').forEach(function(s){s.classList.remove('drag-over');});
      dragSrcIdx=null;dragType=null;
    });
    sec.addEventListener('dragover',function(e){
      if(dragType!==sec.dataset.type)return;
      e.preventDefault();e.dataTransfer.dropEffect='move';
      sec.classList.add('drag-over');
    });
    sec.addEventListener('dragleave',function(){sec.classList.remove('drag-over');});
    sec.addEventListener('drop',function(e){
      e.preventDefault();sec.classList.remove('drag-over');
      if(dragType!==sec.dataset.type)return;
      var toIdx=parseInt(sec.dataset.idx);
      if(dragSrcIdx===null||dragSrcIdx===toIdx)return;
      var arr=dragType==='expense'?expCats:revCats;
      var moved=arr.splice(dragSrcIdx,1)[0];
      arr.splice(toIdx,0,moved);
      render();markDirty();
    });
  });
}

// ===== SECTION TOGGLE =====
function toggleSec(id){
  var el=document.getElementById('sec-'+id);
  if(!el)return;
  el.classList.toggle('expanded');
  if(el.classList.contains('expanded'))expandedSet.add(id);else expandedSet.delete(id);
}

// Click on header (not drag handle, not delete, not chevron) toggles
document.addEventListener('click',function(e){
  var hdr=e.target.closest('.chdr');
  if(!hdr)return;
  if(e.target.closest('.cdrag')||e.target.closest('.cdel')||e.target.closest('.cchv'))return;
  var sec=hdr.closest('.csec');if(sec)toggleSec(sec.id.replace('sec-',''));
});

function togAll(){
  allExpanded=!allExpanded;
  document.querySelectorAll('.csec').forEach(function(s){
    var id=s.id.replace('sec-','');
    if(allExpanded){s.classList.add('expanded');expandedSet.add(id);}
    else{s.classList.remove('expanded');expandedSet.delete(id);}
  });
  document.getElementById('togBtn').textContent=allExpanded?'Collapse All':'Expand All';
}

// ===== DATA OPS =====
function updVal(type,ci,li,field,val){
  var arr=type==='expense'?expCats:revCats;
  if(arr[ci]&&arr[ci].items[li]){arr[ci].items[li][field]=parseFloat(val)||0;calcTotals();updateCatDisplay(type,ci);markDirty();}
}
function updName(type,ci,li,val){
  var arr=type==='expense'?expCats:revCats;
  if(arr[ci]&&arr[ci].items[li]){arr[ci].items[li].name=val;markDirty();}
}
function addItem(type,ci){
  var arr=type==='expense'?expCats:revCats;
  if(!arr[ci])return;
  arr[ci].items.push({name:'',est:0,act:0});
  expandedSet.add(arr[ci].id);
  render();
  var sec=document.getElementById('sec-'+arr[ci].id);
  if(sec){sec.classList.add('expanded');var inputs=sec.querySelectorAll('.lname');if(inputs.length)inputs[inputs.length-1].focus();}
  markDirty();
}
function rmItem(type,ci,li){
  var arr=type==='expense'?expCats:revCats;
  if(arr[ci])arr[ci].items.splice(li,1);
  render();markDirty();
}
function deleteCat(type,ci){
  var arr=type==='expense'?expCats:revCats;
  var name=arr[ci]?arr[ci].title:'';
  if(!confirm('Delete "'+name+'" and all its line items?'))return;
  arr.splice(ci,1);
  render();markDirty();
}

function updateCatDisplay(type,ci){
  var arr=type==='expense'?expCats:revCats;
  var c=arr[ci];if(!c)return;
  var sec=document.getElementById('sec-'+c.id);if(!sec)return;
  var tot=c.items.reduce(function(s,i){return s+(parseFloat(i.est)||0);},0);
  var filled=c.items.filter(function(i){return(parseFloat(i.est)||0)>0;}).length;
  var te=sec.querySelector('.ctot');if(te)te.textContent='$'+fmt(tot);
  var ce=sec.querySelector('.ccnt');if(ce)ce.textContent=filled+' of '+c.items.length+' items budgeted';
}

function calcTotals(){
  var exp=0,rev=0,cnt=0;
  expCats.forEach(function(c){c.items.forEach(function(i){exp+=(parseFloat(i.est)||0);});cnt+=c.items.length;});
  revCats.forEach(function(c){c.items.forEach(function(i){rev+=(parseFloat(i.est)||0);});cnt+=c.items.length;});
  var net=rev-exp;
  document.getElementById('totExp').textContent='$'+fmt(exp);
  document.getElementById('totRev').textContent='$'+fmt(rev);
  var ne=document.getElementById('totNet');
  ne.textContent=(net>=0?'+$':'-$')+fmt(Math.abs(net));
  ne.className='svl '+(net>=0?'pos':'neg');
  document.getElementById('totLI').textContent=cnt;
}

// ===== ADD CATEGORY MODAL =====
function openAddCat(type){
  addingType=type;selColor=COLORS[0];
  document.getElementById('addModalTitle').textContent=type==='expense'?'Add Department':'Add Revenue Source';
  document.getElementById('newCatName').value='';
  var cp=document.getElementById('colorPicks');cp.innerHTML='';
  COLORS.forEach(function(c){
    var d=document.createElement('div');d.className='cpick'+(c===selColor?' sel':'');
    d.style.background=c;d.onclick=function(){selColor=c;cp.querySelectorAll('.cpick').forEach(function(p){p.classList.remove('sel');});d.classList.add('sel');};
    cp.appendChild(d);
  });
  document.getElementById('addModal').classList.add('show');
  setTimeout(function(){document.getElementById('newCatName').focus();},100);
}
function closeModal(){document.getElementById('addModal').classList.remove('show');}
function confirmAddCat(){
  var name=document.getElementById('newCatName').value.trim();
  if(!name){toast('Enter a name');return;}
  var id=name.toLowerCase().replace(/[^a-z0-9]+/g,'_')+'_'+Date.now();
  var cat={id:id,color:selColor,title:name,items:[{name:'',est:0,act:0}]};
  if(addingType==='expense')expCats.push(cat);else revCats.push(cat);
  closeModal();expandedSet.add(id);render();markDirty();toast('"'+name+'" added');
}

// ===== SAVE / LOAD (localStorage + Supabase) =====
function markDirty(){dirty=true;localSave();}
var saveTimer=null;
function localSave(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(function(){
    localStorage.setItem('elp-est-data',JSON.stringify({
      eName:document.getElementById('eName').value,
      eDate:document.getElementById('eDate').value,
      eAtt:document.getElementById('eAtt').value,
      expCats:expCats,revCats:revCats
    }));
  },400);
}
function localLoad(){
  try{
    var d=JSON.parse(localStorage.getItem('elp-est-data'));
    if(!d)return false;
    if(d.eName)document.getElementById('eName').value=d.eName;
    if(d.eDate)document.getElementById('eDate').value=d.eDate;
    if(d.eAtt)document.getElementById('eAtt').value=d.eAtt;
    if(d.expCats&&d.expCats.length)expCats=d.expCats;
    if(d.revCats&&d.revCats.length)revCats=d.revCats;
    return true;
  }catch(e){return false;}
}

async function saveToDb(){
  localSave();
  if(!tenantId){toast('Saved locally');return;}
  // Upsert to event_estimates + estimate_line_items
  var exp=0,rev=0;
  expCats.forEach(function(c){c.items.forEach(function(i){exp+=(parseFloat(i.est)||0);});});
  revCats.forEach(function(c){c.items.forEach(function(i){rev+=(parseFloat(i.est)||0);});});
  var estData={
    tenant_id:tenantId,
    event_name:document.getElementById('eName').value||'Untitled',
    event_date:document.getElementById('eDate').value||null,
    expected_attendance:parseInt(document.getElementById('eAtt').value)||0,
    total_expenses:exp,total_revenue:rev,net_profit:rev-exp
  };
  // Check if estimate exists
  var existing=localStorage.getItem('elp-est-id');
  var estId=null;
  try{
    if(existing){
      var upd=await sb.from('event_estimates').update(estData).eq('estimate_id',existing).select().single();
      if(upd.data)estId=upd.data.estimate_id;
    }
    if(!estId){
      var ins=await sb.from('event_estimates').insert(estData).select().single();
      if(ins.data){estId=ins.data.estimate_id;localStorage.setItem('elp-est-id',estId);}
    }
    if(estId){
      // Delete old line items, insert fresh
      await sb.from('estimate_line_items').delete().eq('estimate_id',estId);
      var rows=[];var order=0;
      expCats.forEach(function(c){c.items.forEach(function(i){
        rows.push({estimate_id:estId,tenant_id:tenantId,category:c.id,category_type:'expense',item_name:i.name||'(unnamed)',estimated_cost:parseFloat(i.est)||0,actual_cost:parseFloat(i.act)||0,sort_order:order++});
      });});
      revCats.forEach(function(c){c.items.forEach(function(i){
        rows.push({estimate_id:estId,tenant_id:tenantId,category:c.id,category_type:'revenue',item_name:i.name||'(unnamed)',estimated_cost:parseFloat(i.est)||0,actual_cost:parseFloat(i.act)||0,sort_order:order++});
      });});
      if(rows.length)await sb.from('estimate_line_items').insert(rows);
      toast('Saved to database');dirty=false;
    }else{toast('Saved locally');}
  }catch(e){console.error(e);toast('Saved locally (DB unavailable)');}
}

function resetValues(){
  if(!confirm('Reset all dollar values to zero?'))return;
  expCats.forEach(function(c){c.items.forEach(function(i){i.est=0;i.act=0;});});
  revCats.forEach(function(c){c.items.forEach(function(i){i.est=0;i.act=0;});});
  render();markDirty();toast('Values reset');
}

// ===== EXPORT =====
function exportCSV(){
  var rows=[['Category','Type','Item','Estimated','Actual']];
  expCats.forEach(function(c){c.items.forEach(function(i){rows.push([c.title,'Expense','"'+(i.name||'').replace(/"/g,'""')+'"',i.est||0,i.act||0]);});});
  revCats.forEach(function(c){c.items.forEach(function(i){rows.push([c.title,'Revenue','"'+(i.name||'').replace(/"/g,'""')+'"',i.est||0,i.act||0]);});});
  var csv=rows.map(function(r){return r.join(',');}).join('\n');
  var b=new Blob([csv],{type:'text/csv'});var u=URL.createObjectURL(b);
  var a=document.createElement('a');a.href=u;a.download=(document.getElementById('eName').value||'estimate')+'.csv';a.click();URL.revokeObjectURL(u);
  toast('CSV exported');
}

// ===== UTILS =====
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ===== INIT =====
async function init(){
  var s=await checkAuth();if(!s)return;
  userId=s.user.id;var email=s.user.email||'';
  if(email){
    var ur=await sb.from('users').select('tenant_id,user_id').eq('email',email).single();
    if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}
    document.getElementById('mobBiz').textContent=email;
    document.getElementById('deskBiz').textContent=email;
  }
  if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}

  // Load data: try localStorage first, else defaults
  initDefaults();
  localLoad();
  render();
}
init();
</script>
</body>
</html>
