<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>EventLogicPro</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ===== THEME DEFINITIONS ===== */
    :root { --bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa; }
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fefcf8;--bg-secondary:#faf6ee;--bg-card:#fff;--bg-hover:#f5efe0;--border-default:#e8dcc8;--text-primary:#44402a;--text-secondary:#6a6550;--accent-primary:#a89060;--accent-light:#c4aa78;}

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;}
    body{padding-bottom:120px;}
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .theme-toast{position:fixed;bottom:200px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;z-index:1000;display:none;}
    .theme-toast.show{display:block;animation:toastIn .3s ease;}
    .desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border-default);}
    .mobile-top-header{display:block;position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);}
    .mobile-header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px;gap:12px;}
    .mobile-menu-toggle{background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text-secondary);font-size:20px;padding:0;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-appearance:none;}
    .mobile-header-center{flex:1;}
    .mobile-header-title{font-size:18px;font-weight:600;}
    .business-name{font-size:12px;color:var(--accent-light);}
    .mobile-header-right{display:flex;align-items:center;gap:12px;}
    .accordion-icon-header{font-size:20px;color:var(--text-secondary);transition:transform .2s ease;}
    .mobile-menu-toggle.active .accordion-icon-header{transform:rotate(180deg);}
    .mobile-header-content{max-height:0;overflow:hidden;transition:max-height .3s ease;}
    .mobile-header-content.expanded{max-height:200px;}
    .mobile-header-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:8px 12px 12px;background:var(--bg-primary);border-top:1px solid var(--border-default);}
    .mobile-header-actions button{padding:10px;font-size:13px;background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border:1px solid color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--accent-light);border-radius:8px;cursor:pointer;-webkit-appearance:none;}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;}
    .mobile-nav-btn{padding:10px 8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:44px;-webkit-appearance:none;transition:all .2s;}
    .mobile-nav-btn:active{transform:scale(.95);}
    .mobile-nav-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}
    .content{padding:12px;max-width:1100px;margin:0 auto;}

    /* Event selector bar */
    .event-bar{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid var(--border-default);}
    .event-bar-top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;}
    .event-select{flex:1;min-width:140px;padding:12px 16px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:15px;font-weight:600;-webkit-appearance:none;cursor:pointer;}
    .event-bar-btn{padding:12px 16px;border-radius:8px;border:none;background:var(--accent-primary);color:#fff;font-size:14px;font-weight:600;cursor:pointer;white-space:nowrap;-webkit-appearance:none;}
    .event-bar-btn:active{opacity:.9;transform:scale(.98);}

    /* KPI Grid */
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:12px;}
    .kpi-card{background:var(--bg-card);border-radius:10px;padding:16px;border:1px solid var(--border-default);text-align:center;}
    .kpi-value{font-size:28px;font-weight:700;line-height:1.1;}
    .kpi-label{font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-top:4px;letter-spacing:.5px;}
    .kpi-sub{font-size:11px;color:var(--text-secondary);margin-top:2px;}
    .kpi-green{color:#22c55e;}
    .kpi-blue{color:var(--accent-light);}
    .kpi-yellow{color:#eab308;}
    .kpi-red{color:#ef4444;}

    /* Overall progress */
    .progress-section{background:var(--bg-card);border-radius:10px;padding:16px;margin-bottom:12px;border:1px solid var(--border-default);}
    .progress-bar-bg{height:10px;background:var(--bg-hover);border-radius:5px;overflow:hidden;}
    .progress-bar-fill{height:100%;border-radius:5px;transition:width .5s ease;}
    .progress-label{font-size:13px;color:var(--text-secondary);margin-top:6px;display:flex;justify-content:space-between;}

    /* Section divider */
    .section-label{font-size:12px;font-weight:700;text-transform:uppercase;color:var(--accent-light);letter-spacing:1px;padding:12px 0 6px;border-bottom:1px solid var(--border-default);margin-bottom:8px;}

    /* Department cards with KPIs */
    .dept-card{background:var(--bg-card);border-radius:10px;margin-bottom:8px;border:1px solid var(--border-default);overflow:hidden;}
    .dept-card.my-dept{border-left:3px solid var(--accent-primary);}
    .dept-card-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;transition:background .2s;}
    .dept-card-header:hover{background:var(--bg-hover);}
    .dept-card-left{display:flex;align-items:center;gap:12px;flex:1;min-width:0;}
    .dept-name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .dept-lead-tag{font-size:11px;color:var(--text-secondary);white-space:nowrap;}
    .dept-card-kpis{display:flex;gap:0;align-items:center;flex-shrink:0;}
    .dept-kpi{text-align:center;width:60px;}
    .dept-kpi-val{font-size:16px;font-weight:700;}
    .dept-kpi-lbl{font-size:9px;color:var(--text-secondary);text-transform:uppercase;}
    .dept-mini-progress{width:60px;height:6px;background:var(--bg-hover);border-radius:3px;overflow:hidden;}
    .dept-mini-progress-fill{height:100%;border-radius:3px;transition:width .3s;}
    .dept-expand{font-size:12px;color:var(--text-secondary);transition:transform .2s;margin-left:8px;}
    .dept-card-header.collapsed .dept-expand{transform:rotate(-90deg);}
    .dept-budget-tag{font-size:11px;color:#22c55e;}

    .dept-body{border-top:1px solid var(--border-default);overflow:hidden;transition:max-height .3s ease;}
    .dept-body.collapsed{max-height:0 !important;border-top:none;}

    /* Task rows */
    .task-row{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border-default);transition:background .2s;}
    .task-row:last-child{border-bottom:none;}
    .task-row:hover{background:var(--bg-hover);}
    .task-row.completed{opacity:.6;}
    .task-row.cancelled{opacity:.5;}
    .task-row.cancelled .task-title{text-decoration:line-through;color:#ef4444;}
    .task-checkbox{width:24px;height:24px;border-radius:6px;border:2px solid var(--accent-light);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;transition:all .2s;-webkit-appearance:none;background:transparent;color:transparent;font-size:14px;opacity:.7;}
    .task-checkbox:hover{border-color:var(--accent-primary);opacity:1;}
    .task-checkbox.checked{background:#22c55e;border-color:#22c55e;color:#fff;opacity:1;}
    .task-checkbox.cancelled{background:#ef4444;border-color:#ef4444;color:#fff;opacity:1;}
    .task-content{flex:1;min-width:0;cursor:pointer;}
    .task-title{font-size:14px;font-weight:500;margin-bottom:4px;}
    .task-row.completed .task-title{text-decoration:line-through;color:var(--text-secondary);}
    .task-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .task-meta-tag{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg-hover);color:var(--text-secondary);border:1px solid var(--border-default);white-space:nowrap;}
    .task-meta-tag.cost{color:#22c55e;}
    .task-meta-tag.overdue{color:#ef4444;border-color:#ef4444;}
    .task-meta-tag.lead{color:var(--accent-light);border-color:var(--accent-primary);}
    .task-actions{display:flex;gap:6px;flex-shrink:0;}
    .task-edit-btn{padding:6px 10px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:11px;cursor:pointer;-webkit-appearance:none;}
    .task-edit-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .dept-footer{padding:10px 16px;background:var(--bg-card);border-top:1px solid var(--border-default);display:flex;gap:8px;}
    .dept-footer-btn{padding:8px 14px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer;-webkit-appearance:none;}
    .dept-footer-btn:hover{background:var(--bg-hover);}
    .dept-footer-btn.primary{background:color-mix(in srgb,var(--accent-primary) 20%,transparent);border-color:var(--accent-primary);color:var(--accent-light);}
    .empty-state{text-align:center;padding:40px 20px;color:var(--text-secondary);}

    /* Modal */
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:2000;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.active{display:flex;}
    .modal-content{background:var(--bg-secondary);border-radius:12px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;border:1px solid var(--border-default);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border-default);}
    .modal-title{font-size:18px;font-weight:600;}
    .modal-close{background:transparent;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;padding:0;line-height:1;}
    .modal-body{padding:20px;}
    .modal-footer{display:flex;gap:12px;justify-content:flex-end;padding:16px 20px;border-top:1px solid var(--border-default);}
    .form-group{margin-bottom:16px;}
    .form-label{display:block;font-size:13px;font-weight:500;color:var(--text-secondary);margin-bottom:6px;}
    .form-input,.form-select,.form-textarea{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:14px;-webkit-appearance:none;}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent-primary);}
    .form-textarea{resize:vertical;min-height:60px;font-family:inherit;}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .form-check{display:flex;gap:8px;align-items:center;padding:10px 0;}
    .form-check input[type="checkbox"]{width:18px;height:18px;}
    .btn-primary{padding:12px 20px;border-radius:8px;border:none;background:var(--accent-primary);color:#fff;font-size:14px;font-weight:600;cursor:pointer;-webkit-appearance:none;}
    .btn-secondary{padding:12px 20px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;-webkit-appearance:none;}
    .btn-danger{padding:12px 20px;border-radius:8px;border:1px solid #ef4444;background:rgba(239,68,68,.15);color:#ef4444;font-size:14px;cursor:pointer;-webkit-appearance:none;}
    .toast{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--accent-primary);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;font-weight:500;z-index:3000;display:none;}
    .toast.show{display:block;animation:toastIn .3s ease;}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

    /* Detail Panel */
    .detail-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:2000;}
    .detail-overlay.active{display:block;}
    .detail-panel{position:fixed;top:0;right:0;bottom:0;width:100%;max-width:520px;background:var(--bg-primary);overflow-y:auto;z-index:2001;transform:translateX(100%);transition:transform .3s ease;border-left:1px solid var(--border-default);}
    .detail-panel.open{transform:translateX(0);}
    .detail-panel-header{position:sticky;top:0;background:var(--bg-secondary);padding:16px 20px;border-bottom:1px solid var(--border-default);display:flex;justify-content:space-between;align-items:center;z-index:10;}
    .detail-panel-title{font-size:16px;font-weight:600;flex:1;margin-right:12px;}
    .detail-panel-close{background:transparent;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;padding:0;line-height:1;-webkit-appearance:none;}
    .detail-body{padding:20px;}
    .detail-field{margin-bottom:20px;}
    .detail-field-label{font-size:11px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:4px;font-weight:600;}
    .detail-field-value{font-size:15px;}
    .detail-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .detail-status{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;}
    .detail-status.done{background:rgba(34,197,94,.15);color:#22c55e;}
    .detail-status.pending{background:rgba(234,179,8,.15);color:#eab308;}
    .detail-status.overdue{background:rgba(239,68,68,.15);color:#ef4444;}
    .detail-status.cancelled{background:rgba(239,68,68,.15);color:#ef4444;}
    .detail-notes{background:var(--bg-card);padding:14px;border-radius:8px;border:1px solid var(--border-default);font-size:14px;white-space:pre-wrap;line-height:1.5;min-height:60px;color:var(--text-secondary);}
    .line-items-section{margin-top:20px;}
    .line-items-title{font-size:13px;font-weight:600;margin-bottom:10px;}
    .line-item-row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border-default);border-radius:6px;margin-bottom:6px;}
    .line-item-desc{font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .line-item-amt{font-size:13px;font-weight:600;color:#22c55e;margin-left:12px;white-space:nowrap;}
    .line-item-del{background:transparent;border:none;color:#ef4444;cursor:pointer;font-size:16px;margin-left:8px;padding:0;-webkit-appearance:none;}
    .line-items-total{display:flex;justify-content:space-between;padding:10px 12px;font-weight:600;font-size:14px;border-top:2px solid var(--border-default);margin-top:8px;}
    .line-items-total .total-amt{color:#22c55e;}
    .add-line-item-row{display:flex;gap:8px;margin-top:8px;}
    .add-line-item-row input{flex:1;padding:8px 10px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:13px;-webkit-appearance:none;}
    .add-line-item-row input:focus{outline:none;border-color:var(--accent-primary);}
    .add-line-item-row button{padding:8px 14px;border-radius:6px;border:none;background:var(--accent-primary);color:#fff;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;-webkit-appearance:none;}
    .detail-actions{display:flex;gap:10px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border-default);}
    .detail-actions button{flex:1;}

    /* Event Details Section */
    .event-details-section{background:var(--bg-card);border-radius:10px;margin-bottom:12px;border:1px solid var(--border-default);overflow:hidden;}
    .event-details-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;cursor:pointer;-webkit-user-select:none;user-select:none;}
    .event-details-header:hover{background:var(--bg-hover);}
    .event-details-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;}
    .event-details-collapse{font-size:12px;color:var(--text-secondary);transition:transform .2s;}
    .event-details-section.collapsed .event-details-collapse{transform:rotate(-90deg);}
    .event-details-body{border-top:1px solid var(--border-default);overflow:hidden;transition:max-height .3s ease;}
    .event-details-section.collapsed .event-details-body{max-height:0 !important;border-top:none;}
    .ed-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:16px;}
    .ed-field{display:flex;flex-direction:column;gap:4px;}
    .ed-label{font-size:11px;text-transform:uppercase;color:var(--text-secondary);font-weight:600;}
    .ed-value{font-size:14px;}
    .ed-input{padding:8px 10px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:13px;}
    .ed-input:focus{outline:none;border-color:var(--accent-primary);}
    .ed-textarea{padding:8px 10px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:13px;resize:vertical;min-height:50px;font-family:inherit;}
    .ed-textarea:focus{outline:none;border-color:var(--accent-primary);}
    .ed-full{grid-column:1/-1;}
    .ed-save-row{grid-column:1/-1;display:flex;justify-content:flex-end;gap:8px;padding-top:4px;}
    .ed-save-btn{padding:8px 16px;border-radius:6px;border:none;background:var(--accent-primary);color:#fff;font-size:12px;font-weight:600;cursor:pointer;}
    .ed-saved{font-size:12px;color:#22c55e;align-self:center;opacity:0;transition:opacity .3s;}
    .ed-saved.show{opacity:1;}

    /* Vendors list */
    .vendor-section{padding:0 16px 16px;}
    .vendor-section-title{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .vendor-row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:6px;margin-bottom:6px;}
    .vendor-info{flex:1;min-width:0;}
    .vendor-name{font-size:13px;font-weight:600;}
    .vendor-meta{font-size:11px;color:var(--text-secondary);display:flex;gap:8px;flex-wrap:wrap;margin-top:2px;}
    .vendor-type{font-size:10px;padding:2px 6px;border-radius:4px;background:color-mix(in srgb,var(--accent-primary) 15%,transparent);color:var(--accent-light);}
    .vendor-actions{display:flex;gap:6px;flex-shrink:0;margin-left:8px;}
    .vendor-btn{padding:4px 10px;border-radius:4px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:11px;cursor:pointer;}
    .vendor-btn:hover{background:var(--bg-hover);}
    .vendor-btn.del{color:#ef4444;border-color:#ef4444;}

    @media(max-width:768px){
      .desktop-header{display:none !important;}.mobile-top-header{display:block;}.mobile-bottom-nav{display:block !important;}
      .modal-overlay{align-items:flex-end;padding:0;}.modal-content{border-radius:20px 20px 0 0;max-height:85vh;}
      .form-row{grid-template-columns:1fr;}
      .kpi-grid{grid-template-columns:repeat(3,1fr);}
      .dept-card-header{flex-wrap:wrap;padding:12px 14px;}
      .dept-card-left{flex-direction:column;align-items:flex-start;gap:2px;width:100%;}
      .dept-name{white-space:normal;overflow:visible;font-size:14px;line-height:1.3;}
      .dept-lead-tag{font-size:11px;}
      .dept-card-kpis{width:100%;justify-content:flex-end;margin-top:6px;gap:0;}
      .dept-kpi{width:50px;}
      .dept-kpi-val{font-size:13px;}
      .ed-grid{grid-template-columns:1fr;}
    }
    @media(min-width:769px){.mobile-top-header{display:none !important;}.mobile-bottom-nav{display:none !important;}body{padding-bottom:20px;}}
  </style>
</head>
<body>

<!-- Mobile Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span class="accordion-icon-header">&#9776;</span></button>
    <div class="mobile-header-center"><div class="mobile-header-title">EventLogicPro</div><div class="business-name" id="mobileBusinessName">Loading...</div></div>
    <div class="mobile-header-right"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button></div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent"><div class="mobile-header-actions"><button onclick="location.href='eventlogicpro-settings.html'">Settings</button><button onclick="logout()">Logout</button></div></div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;">
    <div><h1 style="margin:0;font-size:32px;font-weight:600;">EventLogicPro</h1><div class="business-name" id="desktopBusinessName">Loading...</div></div>
    <div style="display:flex;align-items:center;gap:16px;"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button><a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a></div>
  </div>
  <div style="padding:0 24px 12px;"><nav style="display:flex;gap:24px;"><a href="eventlogicpro.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">Events</a><a href="eventlogicpro-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a></nav></div>
</div>

<!-- Main Content -->
<div class="content">
  <div class="event-bar">
    <div class="event-bar-top">
      <select class="event-select" id="eventProjectSelect" onchange="switchEvent()"><option value="">-- Select Event --</option></select>
      <select class="event-select" id="memberSelect" onchange="switchMember()" style="max-width:160px;font-size:13px;"><option value="">-- You --</option></select>
      <button class="event-bar-btn" id="btnNewEvent" onclick="openNewEventProjectModal()" style="display:none;">+ New Event</button>
    </div>
  </div>

  <!-- Event Details -->
  <div class="event-details-section collapsed" id="eventDetailsSection" style="display:none;">
    <div class="event-details-header" onclick="toggleEventDetails()">
      <div class="event-details-title">Event Details & Vendors</div>
      <span class="event-details-collapse">&#9660;</span>
    </div>
    <div class="event-details-body" id="eventDetailsBody">
      <div class="ed-grid">
        <div class="ed-field"><div class="ed-label">Venue Name</div><input class="ed-input" id="edVenue" placeholder="Venue name"></div>
        <div class="ed-field"><div class="ed-label">Venue Cost</div><input class="ed-input" id="edVenueCost" placeholder="$0" onfocus="this.value=this.value.replace(/[^0-9.]/g,'')" onblur="formatEdCost(this)"></div>
        <div class="ed-field"><div class="ed-label">Venue Address</div><input class="ed-input" id="edVenueAddr" placeholder="Address / Location"></div>
        <div class="ed-field"><div class="ed-label">Venue Contact</div><input class="ed-input" id="edVenueContact" placeholder="Contact name"></div>
        <div class="ed-field"><div class="ed-label">Venue Phone</div><input class="ed-input" id="edVenuePhone" placeholder="Phone"></div>
        <div class="ed-field"><div class="ed-label">Venue Email</div><input class="ed-input" id="edVenueEmail" placeholder="Email"></div>
        <div class="ed-field ed-full"><div class="ed-label">Requirements / Notes</div><textarea class="ed-textarea" id="edVenueReqs" placeholder="Insurance, permits, capacity, load-in times..."></textarea></div>
        <div class="ed-save-row"><span class="ed-saved" id="edSaved">Saved</span><button class="ed-save-btn" onclick="saveEventDetails()">Save Details</button></div>
      </div>
      <div class="vendor-section">
        <div class="vendor-section-title"><span>Vendors & Contacts</span><button class="ed-save-btn" onclick="openVendorModal()">+ Add</button></div>
        <div id="vendorList"><div style="padding:12px;text-align:center;color:var(--text-secondary);font-size:13px;">No vendors added yet</div></div>
      </div>
    </div>
  </div>

  <!-- Global KPIs -->
  <div id="kpiArea" style="display:none;">
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-value kpi-blue" id="kpiDepts">0</div><div class="kpi-label">Departments</div></div>
      <div class="kpi-card"><div class="kpi-value" id="kpiTasks">0</div><div class="kpi-label">Total Tasks</div></div>
      <div class="kpi-card"><div class="kpi-value kpi-green" id="kpiDone">0</div><div class="kpi-label">Completed</div></div>
      <div class="kpi-card"><div class="kpi-value kpi-red" id="kpiOverdue">0</div><div class="kpi-label">Overdue</div></div>
      <div class="kpi-card"><div class="kpi-value kpi-blue" id="kpiBudget">$0</div><div class="kpi-label">Budget</div></div>
      <div class="kpi-card"><div class="kpi-value kpi-green" id="kpiCost">$0</div><div class="kpi-label">Total Cost</div></div>
    </div>
    <div class="progress-section">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%;background:linear-gradient(90deg,var(--accent-primary),#22c55e);"></div></div>
      <div class="progress-label"><span id="progressText">0% Complete</span><span id="progressCount">0 / 0</span></div>
    </div>
  </div>

  <!-- Departments -->
  <div id="departmentsArea"><div class="empty-state">Select or create an event to get started</div></div>
</div>

<div id="themeToast" class="theme-toast"></div>
<div id="toast" class="toast"></div>

<!-- Task Detail Panel -->
<div class="detail-overlay" id="detailOverlay" onclick="closeDetailPanel()"></div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-panel-header"><div class="detail-panel-title" id="detailTitle">Task Details</div><button class="detail-panel-close" onclick="closeDetailPanel()">&times;</button></div>
  <div class="detail-body" id="detailBody"></div>
</div>

<!-- New Event Modal -->
<div class="modal-overlay" id="newEventProjectModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Event</div><button class="modal-close" onclick="closeNewEventProjectModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Event Name *</label><input type="text" class="form-input" id="epName"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Event Date</label><input type="date" class="form-input" id="epDate"></div><div class="form-group"><label class="form-label">Budget ($)</label><input type="number" class="form-input" id="epBudget" step="0.01"></div></div>
      <div class="form-group"><label class="form-label">Venue</label><input type="text" class="form-input" id="epVenue"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="epNotes"></textarea></div>
      <div class="form-check"><input type="checkbox" id="epLoadTemplates" checked><label>Load all department templates (16 departments, ~160 tasks)</label></div>
    </div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeNewEventProjectModal()">Cancel</button><button class="btn-primary" onclick="saveNewEventProject()">Create Event</button></div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title" id="taskModalTitle">New Task</div><button class="modal-close" onclick="closeTaskModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Task Title *</label><input type="text" class="form-input" id="tmTitle"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Lead</label><select class="form-select" id="tmLead"><option value="">-- None --</option></select></div><div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="tmAssigned"><option value="">-- None --</option></select></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="tmStart"></div><div class="form-group"><label class="form-label">Deadline</label><input type="date" class="form-input" id="tmDeadline"></div></div>
      <div class="form-group"><label class="form-label">Cost ($)</label><input type="number" class="form-input" id="tmCost" step="0.01"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="tmNotes"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn-danger" id="tmDeleteBtn" style="display:none;" onclick="deleteTask()">Delete</button><button class="btn-secondary" onclick="closeTaskModal()">Cancel</button><button class="btn-primary" onclick="saveTask()">Save</button></div>
  </div>
</div>

<!-- Department Lead Modal -->
<div class="modal-overlay" id="deptLeadModal">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header"><div class="modal-title" id="deptLeadTitle">Department Lead & Budget</div><button class="modal-close" onclick="closeDeptLeadModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Department Lead</label><select class="form-select" id="dlLead"><option value="">-- None --</option></select></div>
      <div class="form-group"><label class="form-label">Department Budget ($)</label><input type="number" class="form-input" id="dlBudget" placeholder="0.00" step="0.01"></div>
    </div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeDeptLeadModal()">Cancel</button><button class="btn-primary" onclick="saveDeptLead()">Save</button></div>
  </div>
</div>

<!-- Vendor Modal -->
<div class="modal-overlay" id="vendorModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title" id="vendorModalTitle">Add Vendor / Contact</div><button class="modal-close" onclick="closeVendorModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Type *</label><select class="form-select" id="vmType"><option value="vendor">Vendor</option><option value="rental">Rental Company</option><option value="contact">Contact</option><option value="venue">Venue</option><option value="catering">Catering</option><option value="security">Security</option><option value="medical">Medical</option><option value="insurance">Insurance</option><option value="permits">Permits / Government</option><option value="audio_visual">Audio / Visual</option><option value="transport">Transportation</option><option value="decor">Decor / Staging</option><option value="sponsor">Sponsor</option><option value="other">Other</option></select></div>
      <div class="form-group"><label class="form-label">Company / Name *</label><input type="text" class="form-input" id="vmName"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Contact Person</label><input type="text" class="form-input" id="vmContact"></div>
        <div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="vmPhone"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="vmEmail"></div>
        <div class="form-group"><label class="form-label">Website</label><input type="text" class="form-input" id="vmWebsite" placeholder="https://"></div>
      </div>
      <div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="vmAddress"></div>
      <div class="form-group"><label class="form-label">Cost / Amount</label><input type="text" class="form-input" id="vmCost" placeholder="$0" onfocus="this.value=this.value.replace(/[^0-9.]/g,'')" onblur="formatEdCost(this)"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="vmNotes" placeholder="Contract details, requirements, etc."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn-danger" id="vmDeleteBtn" style="display:none;" onclick="deleteVendor()">Delete</button><button class="btn-secondary" onclick="closeVendorModal()">Cancel</button><button class="btn-primary" onclick="saveVendor()">Save</button></div>
  </div>
</div>

<div class="mobile-bottom-nav"><div class="mobile-nav-top"><a href="eventlogicpro.html" class="mobile-nav-btn active">Events</a><a href="eventlogicpro-settings.html" class="mobile-nav-btn">Settings</a></div></div>

<script>
var SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

var tenantId=null,userId=null;
var allProjects=[],allDepartments=[],allTasks=[],allMembers=[];
var currentProjectId=null;
var editingTaskId=null,editingTaskDeptId=null,editingDeptId=null;
var currentMember=null;
var userRole='team';

// ===== THEME =====
var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal','cyber','amber','honey','crimson','coral','rose','sand'];
var themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=themes.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){themeIndex=(themeIndex+1)%themes.length;var t=themes[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(t.replace(/-/g,' '));}
function showThemeToast(msg){var t=document.getElementById('themeToast');t.textContent='Theme: '+msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
loadTheme();

function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2500);}
function toggleMobileMenu(btn){document.getElementById('mobileHeaderContent').classList.toggle('expanded');btn.classList.toggle('active');}
async function logout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}

// ===== AUTH =====
async function checkAuth(){
  var r=await sb.auth.getSession();var s=r.data.session;
  if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');
    if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}
    if(!s){window.location.href='login.html';return null;}}
  return s;
}

// ===== MEMBERS =====
async function loadMembers(){
  var r=await sb.from('event_members').select('*').eq('tenant_id',tenantId).eq('is_active',true).order('first_name');
  allMembers=r.data||[];
}
async function seedDefaultMembers(){
  var r=await sb.from('event_members').select('member_id').eq('tenant_id',tenantId).limit(1);
  if(r.data&&r.data.length>0)return;
  var defaults=[{first_name:'Kevin',role_level:'admin'},{first_name:'Allen',role_level:'manager'},{first_name:'Matt',role_level:'manager'},{first_name:'Brian',role_level:'team'},{first_name:'Dave',role_level:'team'},{first_name:'Hunter',role_level:'team'},{first_name:'Joe',role_level:'team'},{first_name:'James',role_level:'team'},{first_name:'Jimmy',role_level:'team'},{first_name:'Dan',role_level:'team'}];
  await sb.from('event_members').insert(defaults.map(function(d){return{tenant_id:tenantId,first_name:d.first_name,role_level:d.role_level};}));
  await loadMembers();
}
async function identifyCurrentMember(email){
  if(email){var m=allMembers.find(function(x){return x.email&&x.email.toLowerCase()===email.toLowerCase();});if(m){currentMember=m;userRole=m.role_level||'team';return;}}
  var savedId=localStorage.getItem('elp-member-id');
  if(savedId){var m=allMembers.find(function(x){return x.member_id===savedId;});if(m){currentMember=m;userRole=m.role_level||'team';return;}}
  var admin=allMembers.find(function(x){return x.role_level==='admin';});
  currentMember=admin||allMembers[0]||null;
  userRole=currentMember?currentMember.role_level:'team';
  if(currentMember)localStorage.setItem('elp-member-id',currentMember.member_id);
}
function canEdit(){return userRole==='admin'||userRole==='manager';}
function canAdmin(){return userRole==='admin';}
function empName(id){if(!id)return '';var e=allMembers.find(function(m){return m.member_id===id;});return e?((e.first_name||'')+' '+(e.last_name||'')).trim():'Unknown';}

function renderMemberSelect(){
  var sel=document.getElementById('memberSelect');sel.innerHTML='';
  allMembers.forEach(function(m){
    var name=((m.first_name||'')+' '+(m.last_name||'')).trim()||'Unknown';
    var badge=m.role_level==='admin'?' [A]':(m.role_level==='manager'?' [M]':'');
    var selected=currentMember&&m.member_id===currentMember.member_id?' selected':'';
    sel.innerHTML+='<option value="'+m.member_id+'"'+selected+'>'+name+badge+'</option>';
  });
}
function switchMember(){
  var id=document.getElementById('memberSelect').value;
  var m=allMembers.find(function(x){return x.member_id===id;});
  if(m){currentMember=m;userRole=m.role_level||'team';localStorage.setItem('elp-member-id',m.member_id);}
  applyPermissions();renderAll();
}
function applyPermissions(){var btn=document.getElementById('btnNewEvent');if(btn)btn.style.display=canAdmin()?'block':'none';}

// ===== LOAD DATA =====
async function loadProjects(){
  var r=await sb.from('event_projects').select('*').eq('tenant_id',tenantId).order('created_at',{ascending:false});
  allProjects=r.data||[];renderProjectSelect();
}
async function loadProjectData(){
  if(!currentProjectId)return;
  var dr=await sb.from('event_departments').select('*').eq('event_project_id',currentProjectId).order('sort_order');
  allDepartments=dr.data||[];
  var tr=await sb.from('event_tasks').select('*').eq('event_project_id',currentProjectId).order('sort_order');
  allTasks=tr.data||[];
}
function renderProjectSelect(){
  var sel=document.getElementById('eventProjectSelect');
  sel.innerHTML='<option value="">-- Select Event --</option>';
  allProjects.forEach(function(p){
    var selected=p.event_project_id===currentProjectId?' selected':'';
    sel.innerHTML+='<option value="'+p.event_project_id+'"'+selected+'>'+p.event_name+(p.event_date?' ('+p.event_date+')':'')+'</option>';
  });
}

// ===== RENDER =====
function renderAll(){renderKPIs();loadEventDetailsUI();renderDepartments();}

function renderKPIs(){
  var area=document.getElementById('kpiArea');
  if(!currentProjectId){area.style.display='none';return;}
  area.style.display='block';
  var total=allTasks.length;
  var done=allTasks.filter(function(t){return t.is_complete;}).length;
  var cancelled=allTasks.filter(function(t){return t.is_cancelled;}).length;
  var now=new Date();
  var overdue=allTasks.filter(function(t){return !t.is_complete&&!t.is_cancelled&&t.deadline&&new Date(t.deadline)<now;}).length;
  var cost=allTasks.reduce(function(s,t){return s+(parseFloat(t.cost)||0);},0);
  var budget=allDepartments.reduce(function(s,d){return s+(parseFloat(d.budget)||0);},0);
  var pct=total>0?Math.round(done/total*100):0;

  document.getElementById('kpiDepts').textContent=allDepartments.length;
  document.getElementById('kpiTasks').textContent=total;
  document.getElementById('kpiDone').textContent=done;
  document.getElementById('kpiOverdue').textContent=overdue;
  document.getElementById('kpiBudget').textContent='$'+budget.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
  document.getElementById('kpiCost').textContent='$'+cost.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
  document.getElementById('progressFill').style.width=pct+'%';
  document.getElementById('progressText').textContent=pct+'% Complete';
  document.getElementById('progressCount').textContent=done+' / '+total+' tasks';
}

function getGroupedDepartments(){
  // Group departments by lead, current user first, then other leads alpha, then unassigned
  var groups={};
  var unassigned=[];
  allDepartments.forEach(function(dept){
    if(dept.lead_employee_id){
      if(!groups[dept.lead_employee_id]) groups[dept.lead_employee_id]=[];
      groups[dept.lead_employee_id].push(dept);
    } else {
      unassigned.push(dept);
    }
  });
  // Sort depts within each group alphabetically
  Object.keys(groups).forEach(function(k){groups[k].sort(function(a,b){return a.department_name.localeCompare(b.department_name);});});
  unassigned.sort(function(a,b){return a.department_name.localeCompare(b.department_name);});

  // Build ordered list of groups: current user first, then other leads alpha by name, then unassigned
  var orderedGroups=[];
  var myId=currentMember?currentMember.member_id:null;
  if(myId&&groups[myId]){
    var memberName=currentMember?((currentMember.first_name||'')+' '+(currentMember.last_name||'')).trim():'You';
    orderedGroups.push({label:memberName,depts:groups[myId],isMine:true});
  }
  // Other leads sorted by name
  var otherLeadIds=Object.keys(groups).filter(function(k){return k!==myId;});
  otherLeadIds.sort(function(a,b){return empName(a).localeCompare(empName(b));});
  otherLeadIds.forEach(function(id){
    orderedGroups.push({label:empName(id),depts:groups[id],isMine:false});
  });
  if(unassigned.length){
    orderedGroups.push({label:'Unassigned',depts:unassigned,isMine:false});
  }
  return orderedGroups;
}

function renderDepartments(){
  var area=document.getElementById('departmentsArea');
  if(!currentProjectId){area.innerHTML='<div class="empty-state">Select or create an event to get started</div>';return;}
  if(!allDepartments.length){area.innerHTML='<div class="empty-state">No departments yet'+(canAdmin()?'<br><button class="btn-primary" style="margin-top:12px;" onclick="addDepartmentPrompt()">+ Add Department</button>':'')+'</div>';return;}

  var groups=getGroupedDepartments();
  var html='';

  groups.forEach(function(group){
    html+='<div class="section-label">'+group.label+(group.isMine?'':' ')+'</div>';
    group.depts.forEach(function(dept){html+=renderDeptCard(dept,group.isMine);});
  });

  html+='<div style="padding:12px 0;display:flex;gap:8px;">';
  if(canAdmin()) html+='<button class="btn-primary" onclick="addDepartmentPrompt()" style="font-size:13px;padding:10px 16px;">+ Add Department</button>';
  html+='<button class="btn-secondary" onclick="expandAllDepts()" style="font-size:13px;padding:10px 16px;">Expand All</button>';
  html+='<button class="btn-secondary" onclick="collapseAllDepts()" style="font-size:13px;padding:10px 16px;">Collapse All</button>';
  html+='</div>';
  area.innerHTML=html;
}

function renderDeptCard(dept,isMine){
  var tasks=allTasks.filter(function(t){return t.event_department_id===dept.event_department_id;});
  var done=tasks.filter(function(t){return t.is_complete;}).length;
  var now=new Date();
  var overdue=tasks.filter(function(t){return !t.is_complete&&!t.is_cancelled&&t.deadline&&new Date(t.deadline)<now;}).length;
  var cost=tasks.reduce(function(s,t){return s+(parseFloat(t.cost)||0);},0);
  var pct=tasks.length>0?Math.round(done/tasks.length*100):0;
  var leadName=empName(dept.lead_employee_id);
  var budget=parseFloat(dept.budget)||0;
  var pctColor=pct>=100?'#22c55e':(pct>=50?'#eab308':'var(--accent-primary)');

  var h='<div class="dept-card'+(isMine?' my-dept':'')+'" id="dept-'+dept.event_department_id+'">';
  h+='<div class="dept-card-header collapsed" onclick="toggleDept(\''+dept.event_department_id+'\')">';
  h+='<div class="dept-card-left"><span class="dept-name">'+dept.department_name+'</span>';
  if(leadName) h+='<span class="dept-lead-tag">'+leadName+'</span>';
  h+='</div>';
  h+='<div class="dept-card-kpis">';
  h+='<div class="dept-kpi"><div class="dept-kpi-val">'+tasks.length+'</div><div class="dept-kpi-lbl">Tasks</div></div>';
  h+='<div class="dept-kpi"><div class="dept-kpi-val kpi-green">'+done+'</div><div class="dept-kpi-lbl">Done</div></div>';
  h+='<div class="dept-kpi"><div class="dept-kpi-val kpi-blue" style="font-size:13px;">'+(budget>0?'$'+budget.toLocaleString():'')+'</div><div class="dept-kpi-lbl">'+(budget>0?'Budget':'')+'</div></div>';
  h+='<div class="dept-kpi"><div class="dept-kpi-val kpi-green" style="font-size:13px;">'+(cost>0?'$'+cost.toLocaleString():'')+'</div><div class="dept-kpi-lbl">'+(cost>0?'Cost':'')+'</div></div>';
  h+='<div class="dept-mini-progress"><div class="dept-mini-progress-fill" style="width:'+pct+'%;background:'+pctColor+';"></div></div>';
  h+='<span class="dept-expand">&#9660;</span>';
  h+='</div></div>';

  // Body
  h+='<div class="dept-body collapsed" id="deptBody-'+dept.event_department_id+'">';
  tasks.forEach(function(task){
    var isComplete=task.is_complete;
    var isCancelled=task.is_cancelled;
    var isOverdue=!isComplete&&!isCancelled&&task.deadline&&new Date(task.deadline)<now;
    var assignedName=empName(task.assigned_to);
    var taskLeadName=empName(task.lead_employee_id);
    var canToggle=canEdit()||(currentMember&&task.assigned_to===currentMember.member_id);
    var rowClass=isCancelled?' cancelled':(isComplete?' completed':'');
    var cbClass=isCancelled?' cancelled':(isComplete?' checked':'');
    var cbIcon=isCancelled?'&#10007;':(isComplete?'&#10003;':'');
    h+='<div class="task-row'+rowClass+'">';
    h+='<button class="task-checkbox'+cbClass+'" onclick="event.stopPropagation();cycleTaskStatus(\''+task.event_task_id+'\')">'+cbIcon+'</button>';
    h+='<div class="task-content" onclick="event.stopPropagation();openDetailPanel(\''+task.event_task_id+'\')"><div class="task-title">'+task.task_title+'</div><div class="task-meta">';
    if(taskLeadName) h+='<span class="task-meta-tag lead">Lead: '+taskLeadName+'</span>';
    if(assignedName) h+='<span class="task-meta-tag">'+assignedName+'</span>';
    if(task.deadline) h+='<span class="task-meta-tag'+(isOverdue?' overdue':'')+'">Due: '+task.deadline+'</span>';
    if(task.cost>0) h+='<span class="task-meta-tag cost">$'+parseFloat(task.cost).toLocaleString()+'</span>';
    if(isCancelled) h+='<span class="task-meta-tag overdue">Cancelled</span>';
    h+='</div></div>';
    if(canEdit()) h+='<div class="task-actions"><button class="task-edit-btn" onclick="event.stopPropagation();openEditTask(\''+task.event_task_id+'\')">Edit</button></div>';
    h+='</div>';
  });
  h+='<div class="dept-footer">';
  if(canEdit()) h+='<button class="dept-footer-btn primary" onclick="openNewTask(\''+dept.event_department_id+'\')">+ Task</button>';
  if(canEdit()) h+='<button class="dept-footer-btn" onclick="openDeptLeadModal(\''+dept.event_department_id+'\')">Lead</button>';
  h+='</div>';
  h+='</div></div>';
  return h;
}

function toggleDept(id){
  var header=document.querySelector('#dept-'+id+' .dept-card-header');
  var body=document.getElementById('deptBody-'+id);
  header.classList.toggle('collapsed');
  if(body.classList.contains('collapsed')){body.classList.remove('collapsed');body.style.maxHeight=body.scrollHeight+'px';}
  else{body.style.maxHeight='0px';setTimeout(function(){body.classList.add('collapsed');},300);}
}
function expandAllDepts(){document.querySelectorAll('.dept-card-header.collapsed').forEach(function(h){h.click();});}
function collapseAllDepts(){document.querySelectorAll('.dept-card-header:not(.collapsed)').forEach(function(h){h.click();});}

// ===== EVENT SWITCHING =====
async function switchEvent(){
  currentProjectId=document.getElementById('eventProjectSelect').value||null;
  if(currentProjectId){await loadProjectData();await loadVendors();}else{allDepartments=[];allTasks=[];allVendors=[];}
  renderAll();
}

// ===== NEW EVENT =====
function openNewEventProjectModal(){document.getElementById('epName').value='';document.getElementById('epDate').value='';document.getElementById('epBudget').value='';document.getElementById('epVenue').value='';document.getElementById('epNotes').value='';document.getElementById('epLoadTemplates').checked=true;document.getElementById('newEventProjectModal').classList.add('active');}
function closeNewEventProjectModal(){document.getElementById('newEventProjectModal').classList.remove('active');}

async function saveNewEventProject(){
  var name=document.getElementById('epName').value.trim();if(!name){showToast('Enter an event name');return;}
  var data={tenant_id:tenantId,event_name:name,event_date:document.getElementById('epDate').value||null,total_budget:parseFloat(document.getElementById('epBudget').value)||0,venue:document.getElementById('epVenue').value.trim()||null,notes:document.getElementById('epNotes').value.trim()||null,status:'planning',created_by:userId};
  var r=await sb.from('event_projects').insert(data).select().single();
  if(r.error){showToast('Error: '+r.error.message);return;}
  var projectId=r.data.event_project_id;
  if(document.getElementById('epLoadTemplates').checked){await loadTemplatesIntoProject(projectId);}
  closeNewEventProjectModal();showToast('Event created!');
  currentProjectId=projectId;await loadProjects();await loadProjectData();renderAll();
}

async function loadTemplatesIntoProject(projectId){
  var tr=await sb.from('event_task_templates').select('department_name,task_title,sort_order').or('tenant_id.is.null,tenant_id.eq.'+tenantId).order('department_name').order('sort_order');
  var templates=tr.data||[];if(!templates.length)return;
  var deptMap={};templates.forEach(function(t){if(!deptMap[t.department_name])deptMap[t.department_name]=[];deptMap[t.department_name].push(t);});
  var deptNames=Object.keys(deptMap);
  var deptInserts=deptNames.map(function(name,i){return{tenant_id:tenantId,event_project_id:projectId,department_name:name,sort_order:i};});
  var dr=await sb.from('event_departments').insert(deptInserts).select();
  if(dr.error){console.error(dr.error);return;}
  var taskInserts=[];
  dr.data.forEach(function(dept){(deptMap[dept.department_name]||[]).forEach(function(t){taskInserts.push({tenant_id:tenantId,event_project_id:projectId,event_department_id:dept.event_department_id,task_title:t.task_title,sort_order:t.sort_order,is_complete:false,cost:0,created_by:userId});});});
  for(var i=0;i<taskInserts.length;i+=50){await sb.from('event_tasks').insert(taskInserts.slice(i,i+50));}
}

// ===== TASKS =====
function populateEmpDropdowns(){
  ['tmLead','tmAssigned','dlLead'].forEach(function(id){
    var sel=document.getElementById(id);if(!sel)return;var cur=sel.value;
    sel.innerHTML='<option value="">-- None --</option>';
    allMembers.forEach(function(e){sel.innerHTML+='<option value="'+e.member_id+'">'+((e.first_name||'')+' '+(e.last_name||'')).trim()+'</option>';});
    if(cur)sel.value=cur;
  });
}
function openNewTask(deptId){editingTaskId=null;editingTaskDeptId=deptId;document.getElementById('taskModalTitle').textContent='New Task';document.getElementById('tmTitle').value='';document.getElementById('tmStart').value='';document.getElementById('tmDeadline').value='';document.getElementById('tmCost').value='';document.getElementById('tmNotes').value='';document.getElementById('tmDeleteBtn').style.display='none';populateEmpDropdowns();var dept=allDepartments.find(function(d){return d.event_department_id===deptId;});var deptLead=dept?dept.lead_employee_id||'':'';document.getElementById('tmLead').value=deptLead;document.getElementById('tmAssigned').value=deptLead;document.getElementById('taskModal').classList.add('active');}
function openEditTask(taskId){var task=allTasks.find(function(t){return t.event_task_id===taskId;});if(!task)return;editingTaskId=taskId;editingTaskDeptId=task.event_department_id;document.getElementById('taskModalTitle').textContent='Edit Task';document.getElementById('tmTitle').value=task.task_title||'';document.getElementById('tmStart').value=task.projected_start||'';document.getElementById('tmDeadline').value=task.deadline||'';document.getElementById('tmCost').value=task.cost||'';document.getElementById('tmNotes').value=task.notes||'';document.getElementById('tmDeleteBtn').style.display=canAdmin()?'block':'none';populateEmpDropdowns();document.getElementById('tmLead').value=task.lead_employee_id||'';document.getElementById('tmAssigned').value=task.assigned_to||'';document.getElementById('taskModal').classList.add('active');}
function closeTaskModal(){document.getElementById('taskModal').classList.remove('active');}

async function saveTask(){
  var title=document.getElementById('tmTitle').value.trim();if(!title){showToast('Enter a task title');return;}
  var data={task_title:title,lead_employee_id:document.getElementById('tmLead').value||null,assigned_to:document.getElementById('tmAssigned').value||null,projected_start:document.getElementById('tmStart').value||null,deadline:document.getElementById('tmDeadline').value||null,cost:parseFloat(document.getElementById('tmCost').value)||0,notes:document.getElementById('tmNotes').value.trim()||null,updated_at:new Date().toISOString()};
  if(editingTaskId){await sb.from('event_tasks').update(data).eq('event_task_id',editingTaskId);showToast('Task updated');}
  else{data.tenant_id=tenantId;data.event_project_id=currentProjectId;data.event_department_id=editingTaskDeptId;data.is_complete=false;data.created_by=userId;await sb.from('event_tasks').insert(data);showToast('Task added');}
  closeTaskModal();await loadProjectData();renderAll();
}
async function deleteTask(){if(!editingTaskId||!canAdmin()||!confirm('Delete this task permanently?'))return;await sb.from('event_tasks').delete().eq('event_task_id',editingTaskId);closeTaskModal();showToast('Deleted');await loadProjectData();renderAll();}
async function deleteTaskFromDetail(taskId){if(!canAdmin()||!confirm('Delete this task permanently?'))return;await sb.from('event_tasks').delete().eq('event_task_id',taskId);closeDetailPanel();showToast('Deleted');await loadProjectData();renderAll();}
async function cycleTaskStatus(taskId){
  var task=allTasks.find(function(t){return t.event_task_id===taskId;});
  if(!task) return;
  var canToggle=canEdit()||(currentMember&&task.assigned_to===currentMember.member_id);
  if(!canToggle){showToast('You can only check off tasks assigned to you');return;}
  var data={updated_at:new Date().toISOString()};
  if(!task.is_complete&&!task.is_cancelled){
    // pending  done
    data.is_complete=true;data.is_cancelled=false;data.completed_at=new Date().toISOString();data.completed_by=userId;data.cancel_notes=null;
  } else if(task.is_complete&&!task.is_cancelled){
    // done  cancelled (prompt for notes)
    var notes=prompt('Cancel reason (optional):');
    if(notes===null) return; // user hit cancel on prompt
    data.is_complete=false;data.is_cancelled=true;data.completed_at=null;data.completed_by=null;data.cancel_notes=notes||null;
  } else {
    // cancelled  pending
    data.is_complete=false;data.is_cancelled=false;data.completed_at=null;data.completed_by=null;data.cancel_notes=null;
  }
  await sb.from('event_tasks').update(data).eq('event_task_id',taskId);
  await loadProjectData();renderAll();
}
async function toggleTask(taskId,complete){cycleTaskStatus(taskId);}

// ===== DEPT LEAD =====
function openDeptLeadModal(deptId){editingDeptId=deptId;var dept=allDepartments.find(function(d){return d.event_department_id===deptId;});document.getElementById('deptLeadTitle').textContent=(dept?dept.department_name:'Department')+' - Lead & Budget';populateEmpDropdowns();document.getElementById('dlLead').value=dept?.lead_employee_id||'';document.getElementById('dlBudget').value=dept?.budget||'';document.getElementById('deptLeadModal').classList.add('active');}
function closeDeptLeadModal(){document.getElementById('deptLeadModal').classList.remove('active');}
async function saveDeptLead(){if(!editingDeptId)return;var leadId=document.getElementById('dlLead').value||null;await sb.from('event_departments').update({lead_employee_id:leadId,budget:parseFloat(document.getElementById('dlBudget').value)||0}).eq('event_department_id',editingDeptId);if(leadId){await sb.from('event_tasks').update({assigned_to:leadId,updated_at:new Date().toISOString()}).eq('event_department_id',editingDeptId).is('assigned_to',null);}closeDeptLeadModal();showToast('Updated');await loadProjectData();renderAll();}

// ===== ADD DEPT =====
async function addDepartmentPrompt(){var name=prompt('Department name:');if(!name||!name.trim())return;await sb.from('event_departments').insert({tenant_id:tenantId,event_project_id:currentProjectId,department_name:name.trim(),sort_order:allDepartments.length});showToast('Department added');await loadProjectData();renderAll();}

// ===== DETAIL PANEL =====
var detailTaskId=null,detailLineItems=[];
async function openDetailPanel(taskId){
  detailTaskId=taskId;var task=allTasks.find(function(t){return t.event_task_id===taskId;});if(!task){showToast('Task not found');return;}
  document.getElementById('detailTitle').textContent=task.task_title;
  var lr=await sb.from('event_task_line_items').select('*').eq('event_task_id',taskId).order('sort_order');
  detailLineItems=lr.data||[];renderDetailBody(task);
  document.getElementById('detailOverlay').classList.add('active');document.getElementById('detailPanel').classList.add('open');
}
function closeDetailPanel(){document.getElementById('detailOverlay').classList.remove('active');document.getElementById('detailPanel').classList.remove('open');detailTaskId=null;}

function renderDetailBody(task){
  var isComplete=task.is_complete;var isCancelled=task.is_cancelled;
  var isOverdue=!isComplete&&!isCancelled&&task.deadline&&new Date(task.deadline)<new Date();
  var statusClass=isCancelled?'cancelled':(isComplete?'done':(isOverdue?'overdue':'pending'));
  var statusText=isCancelled?'Cancelled':(isComplete?'Complete':(isOverdue?'Overdue':'Pending'));
  var leadName=empName(task.lead_employee_id);var assignedName=empName(task.assigned_to);
  var dept=allDepartments.find(function(d){return d.event_department_id===task.event_department_id;});
  var lineTotal=detailLineItems.reduce(function(s,li){return s+(parseFloat(li.amount)||0);},0);
  var taskCost=parseFloat(task.cost)||0;
  var h='';
  h+='<div class="detail-field"><div class="detail-field-label">Status</div><span class="detail-status '+statusClass+'">'+statusText+'</span></div>';
  h+='<div class="detail-field"><div class="detail-field-label">Department</div><div class="detail-field-value">'+(dept?dept.department_name:'')+'</div></div>';
  h+='<div class="detail-row"><div class="detail-field"><div class="detail-field-label">Lead</div><div class="detail-field-value">'+(leadName||'')+'</div></div><div class="detail-field"><div class="detail-field-label">Assigned To</div><div class="detail-field-value">'+(assignedName||'')+'</div></div></div>';
  h+='<div class="detail-row"><div class="detail-field"><div class="detail-field-label">Start Date</div><div class="detail-field-value">'+(task.projected_start||'')+'</div></div><div class="detail-field"><div class="detail-field-label">Deadline</div><div class="detail-field-value">'+(task.deadline||'')+'</div></div></div>';
  h+='<div class="detail-field"><div class="detail-field-label">Task Cost</div><div class="detail-field-value" style="font-size:20px;font-weight:700;color:#22c55e;">$'+(taskCost>0?taskCost.toLocaleString():'0')+'</div></div>';
  h+='<div class="detail-field"><div class="detail-field-label">Notes</div><div class="detail-notes">'+(task.notes||'No notes')+'</div></div>';
  if(isCancelled&&task.cancel_notes) h+='<div class="detail-field"><div class="detail-field-label" style="color:#ef4444;">Cancel Reason</div><div class="detail-notes" style="border-color:#ef4444;">'+task.cancel_notes+'</div></div>';
  h+='<div class="line-items-section"><div class="line-items-title">Cost Line Items</div>';
  if(detailLineItems.length){detailLineItems.forEach(function(li){h+='<div class="line-item-row"><span class="line-item-desc">'+li.description+'</span><span class="line-item-amt">$'+(parseFloat(li.amount)||0).toLocaleString(undefined,{minimumFractionDigits:2})+'</span><button class="line-item-del" onclick="deleteLineItem(\''+li.line_item_id+'\')">&times;</button></div>';});h+='<div class="line-items-total"><span>Total</span><span class="total-amt">$'+lineTotal.toLocaleString(undefined,{minimumFractionDigits:2})+'</span></div>';}
  else{h+='<div style="padding:12px;text-align:center;color:var(--text-secondary);font-size:13px;">No line items</div>';}
  h+='<div class="add-line-item-row"><input type="text" id="liDesc" placeholder="Description"><input type="number" id="liAmt" placeholder="0.00" step="0.01" style="max-width:100px;"><button onclick="addLineItem()">Add</button></div></div>';
  h+='<div class="detail-actions">';
  if(canEdit()) h+='<button class="btn-primary" onclick="openEditTask(\''+task.event_task_id+'\');closeDetailPanel();">Edit Task</button>';
  var canToggleThis=canEdit()||(currentMember&&task.assigned_to===currentMember.member_id);
  if(canToggleThis){
    if(!isComplete&&!isCancelled) h+='<button class="btn-secondary" onclick="cycleTaskStatus(\''+task.event_task_id+'\');closeDetailPanel();">Mark Done</button>';
    else if(isComplete) h+='<button class="btn-secondary" style="border-color:#ef4444;color:#ef4444;" onclick="cycleTaskStatus(\''+task.event_task_id+'\');closeDetailPanel();">Cancel Task</button>';
    else h+='<button class="btn-secondary" onclick="cycleTaskStatus(\''+task.event_task_id+'\');closeDetailPanel();">Reopen Task</button>';
  }
  if(canAdmin()) h+='<button class="btn-danger" style="padding:10px 16px;font-size:13px;" onclick="deleteTaskFromDetail(\''+task.event_task_id+'\')">Delete</button>';
  h+='</div>';
  document.getElementById('detailBody').innerHTML=h;
}

async function addLineItem(){if(!detailTaskId)return;var desc=document.getElementById('liDesc').value.trim();var amt=parseFloat(document.getElementById('liAmt').value)||0;if(!desc){showToast('Enter a description');return;}await sb.from('event_task_line_items').insert({tenant_id:tenantId,event_task_id:detailTaskId,description:desc,amount:amt,sort_order:detailLineItems.length});var lr=await sb.from('event_task_line_items').select('amount').eq('event_task_id',detailTaskId);var newTotal=(lr.data||[]).reduce(function(s,li){return s+(parseFloat(li.amount)||0);},0);await sb.from('event_tasks').update({cost:newTotal,updated_at:new Date().toISOString()}).eq('event_task_id',detailTaskId);await loadProjectData();renderAll();await openDetailPanel(detailTaskId);}
async function deleteLineItem(lineId){await sb.from('event_task_line_items').delete().eq('line_item_id',lineId);var lr=await sb.from('event_task_line_items').select('amount').eq('event_task_id',detailTaskId);var newTotal=(lr.data||[]).reduce(function(s,li){return s+(parseFloat(li.amount)||0);},0);await sb.from('event_tasks').update({cost:newTotal,updated_at:new Date().toISOString()}).eq('event_task_id',detailTaskId);await loadProjectData();renderAll();await openDetailPanel(detailTaskId);}

// ===== EVENT DETAILS & VENDORS =====
var allVendors=[];
var editingVendorId=null;

function toggleEventDetails(){
  var sec=document.getElementById('eventDetailsSection');
  var body=document.getElementById('eventDetailsBody');
  if(sec.classList.contains('collapsed')){sec.classList.remove('collapsed');body.style.maxHeight=body.scrollHeight+'px';setTimeout(function(){body.style.maxHeight='none';},300);}
  else{body.style.maxHeight=body.scrollHeight+'px';requestAnimationFrame(function(){body.style.maxHeight='0px';});sec.classList.add('collapsed');}
}

function formatEdCost(el){
  var num=parseFloat(el.value.replace(/[^0-9.]/g,''))||0;
  el.value=num>0?'$'+num.toLocaleString():'';
}

function loadEventDetailsUI(){
  var sec=document.getElementById('eventDetailsSection');
  if(!currentProjectId){sec.style.display='none';return;}
  sec.style.display='block';
  var proj=allProjects.find(function(p){return p.event_project_id===currentProjectId;});
  if(!proj) return;
  document.getElementById('edVenue').value=proj.venue||'';
  document.getElementById('edVenueCost').value=proj.venue_cost?'$'+Number(proj.venue_cost).toLocaleString():'';
  document.getElementById('edVenueAddr').value=proj.venue_address||'';
  document.getElementById('edVenueContact').value=proj.venue_contact||'';
  document.getElementById('edVenuePhone').value=proj.venue_phone||'';
  document.getElementById('edVenueEmail').value=proj.venue_email||'';
  document.getElementById('edVenueReqs').value=proj.venue_requirements||'';
}

async function saveEventDetails(){
  if(!currentProjectId) return;
  var rawCost=document.getElementById('edVenueCost').value.replace(/[^0-9.]/g,'');
  var data={
    venue:document.getElementById('edVenue').value.trim()||null,
    venue_cost:parseFloat(rawCost)||0,
    venue_address:document.getElementById('edVenueAddr').value.trim()||null,
    venue_contact:document.getElementById('edVenueContact').value.trim()||null,
    venue_phone:document.getElementById('edVenuePhone').value.trim()||null,
    venue_email:document.getElementById('edVenueEmail').value.trim()||null,
    venue_requirements:document.getElementById('edVenueReqs').value.trim()||null
  };
  await sb.from('event_projects').update(data).eq('event_project_id',currentProjectId);
  // Update local cache
  var proj=allProjects.find(function(p){return p.event_project_id===currentProjectId;});
  if(proj) Object.assign(proj,data);
  var saved=document.getElementById('edSaved');
  saved.classList.add('show');setTimeout(function(){saved.classList.remove('show');},2000);
}

async function loadVendors(){
  if(!currentProjectId){allVendors=[];return;}
  var r=await sb.from('event_vendors').select('*').eq('event_project_id',currentProjectId).order('vendor_type').order('company_name');
  allVendors=r.data||[];
  renderVendors();
}

function renderVendors(){
  var el=document.getElementById('vendorList');
  if(!allVendors.length){el.innerHTML='<div style="padding:12px;text-align:center;color:var(--text-secondary);font-size:13px;">No vendors added yet</div>';return;}
  var h='';
  allVendors.forEach(function(v){
    h+='<div class="vendor-row">';
    h+='<div class="vendor-info"><div class="vendor-name"><span class="vendor-type">'+formatVendorType(v.vendor_type)+'</span> '+v.company_name+'</div>';
    h+='<div class="vendor-meta">';
    if(v.contact_person) h+='<span>'+v.contact_person+'</span>';
    if(v.phone) h+='<span>'+v.phone+'</span>';
    if(v.email) h+='<span>'+v.email+'</span>';
    if(v.cost>0) h+='<span style="color:#22c55e;">$'+Number(v.cost).toLocaleString()+'</span>';
    h+='</div></div>';
    h+='<div class="vendor-actions"><button class="vendor-btn" onclick="openEditVendor(\''+v.vendor_id+'\')">Edit</button><button class="vendor-btn del" onclick="quickDeleteVendor(\''+v.vendor_id+'\')">x</button></div>';
    h+='</div>';
  });
  el.innerHTML=h;
}

function formatVendorType(t){
  var map={vendor:'Vendor',rental:'Rental',contact:'Contact',venue:'Venue',catering:'Catering',security:'Security',medical:'Medical',insurance:'Insurance',permits:'Permits',audio_visual:'A/V',transport:'Transport',decor:'Decor',sponsor:'Sponsor',other:'Other'};
  return map[t]||t||'Other';
}

function openVendorModal(){
  editingVendorId=null;
  document.getElementById('vendorModalTitle').textContent='Add Vendor / Contact';
  document.getElementById('vmType').value='vendor';
  document.getElementById('vmName').value='';
  document.getElementById('vmContact').value='';
  document.getElementById('vmPhone').value='';
  document.getElementById('vmEmail').value='';
  document.getElementById('vmWebsite').value='';
  document.getElementById('vmAddress').value='';
  document.getElementById('vmCost').value='';
  document.getElementById('vmNotes').value='';
  document.getElementById('vmDeleteBtn').style.display='none';
  document.getElementById('vendorModal').classList.add('active');
}

function openEditVendor(id){
  var v=allVendors.find(function(x){return x.vendor_id===id;});
  if(!v) return;
  editingVendorId=id;
  document.getElementById('vendorModalTitle').textContent='Edit Vendor / Contact';
  document.getElementById('vmType').value=v.vendor_type||'vendor';
  document.getElementById('vmName').value=v.company_name||'';
  document.getElementById('vmContact').value=v.contact_person||'';
  document.getElementById('vmPhone').value=v.phone||'';
  document.getElementById('vmEmail').value=v.email||'';
  document.getElementById('vmWebsite').value=v.website||'';
  document.getElementById('vmAddress').value=v.address||'';
  document.getElementById('vmCost').value=v.cost?'$'+Number(v.cost).toLocaleString():'';
  document.getElementById('vmNotes').value=v.notes||'';
  document.getElementById('vmDeleteBtn').style.display='block';
  document.getElementById('vendorModal').classList.add('active');
}

function closeVendorModal(){document.getElementById('vendorModal').classList.remove('active');}

async function saveVendor(){
  var name=document.getElementById('vmName').value.trim();
  if(!name){showToast('Enter a company/name');return;}
  var rawCost=document.getElementById('vmCost').value.replace(/[^0-9.]/g,'');
  var data={
    vendor_type:document.getElementById('vmType').value,
    company_name:name,
    contact_person:document.getElementById('vmContact').value.trim()||null,
    phone:document.getElementById('vmPhone').value.trim()||null,
    email:document.getElementById('vmEmail').value.trim()||null,
    website:document.getElementById('vmWebsite').value.trim()||null,
    address:document.getElementById('vmAddress').value.trim()||null,
    cost:parseFloat(rawCost)||0,
    notes:document.getElementById('vmNotes').value.trim()||null
  };
  if(editingVendorId){
    await sb.from('event_vendors').update(data).eq('vendor_id',editingVendorId);
    showToast('Vendor updated');
  } else {
    data.tenant_id=tenantId;
    data.event_project_id=currentProjectId;
    await sb.from('event_vendors').insert(data);
    showToast('Vendor added');
  }
  closeVendorModal();
  await loadVendors();
}

async function deleteVendor(){
  if(!editingVendorId||!confirm('Delete this vendor?')) return;
  await sb.from('event_vendors').delete().eq('vendor_id',editingVendorId);
  closeVendorModal();showToast('Vendor deleted');
  await loadVendors();
}

async function quickDeleteVendor(id){
  if(!confirm('Remove this vendor?')) return;
  await sb.from('event_vendors').delete().eq('vendor_id',id);
  showToast('Removed');
  await loadVendors();
}

// ===== INIT =====
async function init(){
  var s=await checkAuth();if(!s)return;userId=s.user.id;var userEmail=s.user.email||'';
  if(userEmail){var ur=await sb.from('users').select('tenant_id,user_id').eq('email',userEmail).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}
    document.getElementById('mobileBusinessName').textContent=userEmail;document.getElementById('desktopBusinessName').textContent=userEmail;}
  if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}
  if(!tenantId){showToast('Could not determine tenant');return;}
  await seedDefaultMembers();await loadMembers();await identifyCurrentMember(userEmail);
  renderMemberSelect();applyPermissions();
  await loadProjects();
  if(allProjects.length&&!currentProjectId){currentProjectId=allProjects[0].event_project_id;document.getElementById('eventProjectSelect').value=currentProjectId;await loadProjectData();await loadVendors();}
  renderAll();
}
init();
</script>
</body>
</html>
