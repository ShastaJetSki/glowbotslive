<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Create Purchase Order</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui; 
      background: #0b0f14; 
      color: #e8eef6;
      padding-bottom: 100px;
    }
    
    .header {
      background: #1a2535;
      padding: 16px 20px;
      border-bottom: 1px solid #2d3f56;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 { color: #60a5fa; font-size: 20px; }
    
    .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    
    /* PO Header Info */
    .po-header {
      background: #1a2535;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      color: #94a3b8;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    input, select, textarea {
      padding: 10px 12px;
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 6px;
      color: #e8eef6;
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    /* Part Search */
    .search-section {
      background: #1a2535;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-title {
      color: #60a5fa;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .search-input {
      flex: 1;
      padding: 12px 16px;
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      color: #e8eef6;
      font-size: 15px;
    }
    
    /* Part Results */
    .part-results {
      display: grid;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .part-card {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 16px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 100px;
      gap: 16px;
      align-items: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .part-card:hover {
      border-color: #3b82f6;
      background: #1a2535;
    }
    .part-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .part-number {
      color: #60a5fa;
      font-weight: 600;
      font-size: 14px;
    }
    .part-name {
      color: #e8eef6;
      font-size: 13px;
    }
    .part-supplier {
      color: #94a3b8;
      font-size: 12px;
    }
    .part-detail {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .detail-label {
      color: #94a3b8;
      font-size: 11px;
      text-transform: uppercase;
    }
    .detail-value {
      color: #e8eef6;
      font-weight: 600;
      font-size: 14px;
    }
    
    /* Selected Parts List */
    .selected-parts {
      background: #1a2535;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .selected-item {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: 2fr 100px 120px 120px 40px;
      gap: 16px;
      align-items: center;
    }
    .qty-input {
      width: 100%;
      padding: 8px;
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 6px;
      color: #e8eef6;
      text-align: center;
      font-size: 14px;
    }
    .remove-btn {
      width: 40px;
      height: 40px;
      background: #dc2626;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 20px;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    .btn-primary:active {
      background: #2563eb;
    }
    .btn-secondary {
      background: #475569;
      color: white;
    }
    .btn-success {
      background: #059669;
      color: white;
    }
    .btn-add {
      background: #3b82f6;
      padding: 8px 16px;
      font-size: 13px;
    }
    
    /* Summary */
    .po-summary {
      background: #1a2535;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #2d3f56;
    }
    .summary-row:last-child {
      border-bottom: none;
      font-size: 18px;
      font-weight: 700;
      color: #60a5fa;
    }
    .summary-label {
      color: #94a3b8;
    }
    .summary-value {
      color: #e8eef6;
      font-weight: 600;
    }
    
    /* Bottom Actions */
    .bottom-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a2535;
      border-top: 1px solid #2d3f56;
      padding: 16px 20px;
      display: flex;
      gap: 12px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      background: #1e3a8a;
      color: #60a5fa;
    }
    
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .part-card {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .selected-item {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .bottom-actions {
        flex-direction: column;
      }
      input, select {
        font-size: 16px; /* Prevent zoom on iOS */
      }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>Create Purchase Order</h1>
  <button class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
</div>

<div class="container">
  
  <!-- PO Header -->
  <div class="po-header">
    <div class="form-row">
      <div class="form-group">
        <label>Supplier *</label>
        <select id="supplierId" onchange="filterPartsBySupplier()" required>
          <option value="">Select Supplier...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Expected Date</label>
        <input type="date" id="expectedDate">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>PO Number</label>
        <input type="text" id="poNumber" placeholder="Auto-generated" readonly>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="poStatus">
          <option value="draft">Draft</option>
          <option value="pending">Pending</option>
          <option value="ordered">Ordered</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="poNotes" rows="2" placeholder="Special instructions..."></textarea>
    </div>
  </div>

  <!-- Part Search -->
  <div class="search-section">
    <div class="section-title">Add Parts to Order</div>
    <div class="search-bar">
      <input 
        type="text" 
        id="partSearch" 
        class="search-input" 
        placeholder="Search by part number, name, or manufacturer..."
        oninput="searchParts()"
      >
    </div>
    <div id="partResults" class="part-results"></div>
  </div>

  <!-- Selected Parts -->
  <div class="selected-parts">
    <div class="section-title">Order Items (<span id="itemCount">0</span>)</div>
    <div id="selectedItems"></div>
  </div>

  <!-- Summary -->
  <div class="po-summary">
    <div class="section-title">Order Summary</div>
    <div class="summary-row">
      <span class="summary-label">Subtotal:</span>
      <span class="summary-value" id="subtotal">$0.00</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Tax (8%):</span>
      <span class="summary-value" id="tax">$0.00</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Shipping:</span>
      <span class="summary-value" id="shipping">$0.00</span>
    </div>
    <div class="summary-row">
      <span class="summary-label">Total:</span>
      <span class="summary-value" id="total">$0.00</span>
    </div>
  </div>

</div>

<!-- Bottom Actions -->
<div class="bottom-actions">
  <button class="btn btn-success" onclick="savePO('ordered')" style="flex:1;">Create & Send PO</button>
  <button class="btn btn-primary" onclick="savePO('draft')" style="flex:1;">Save as Draft</button>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let tenantId = '11111111-1111-1111-1111-111111111111';
let parts = [];
let suppliers = [];
let selectedParts = [];

async function init() {
  await loadSuppliers();
  await loadParts();
  generatePONumber();
  
  // Set default expected date (2 weeks out)
  const twoWeeks = new Date();
  twoWeeks.setDate(twoWeeks.getDate() + 14);
  document.getElementById('expectedDate').valueAsDate = twoWeeks;
  
  // Check if part ID in URL
  const urlParams = new URLSearchParams(window.location.search);
  const partId = urlParams.get('part');
  if (partId) {
    // Wait for parts to load, then auto-add the part
    setTimeout(() => {
      const part = parts.find(p => p.part_id === partId);
      if (part && part.primary_supplier_id) {
        document.getElementById('supplierId').value = part.primary_supplier_id;
        filterPartsBySupplier();
        addPart(partId);
      }
    }, 500);
  }
}

async function loadSuppliers() {
  const { data } = await sb.from('parts_suppliers').select('*').eq('tenant_id', tenantId);
  suppliers = data || [];
  
  const select = document.getElementById('supplierId');
  select.innerHTML = '<option value="">All Suppliers</option>' + 
    suppliers.map(s => `<option value="${s.supplier_id}">${s.supplier_name}</option>`).join('');
}

async function loadParts() {
  const { data } = await sb.from('parts_inventory').select('*').eq('tenant_id', tenantId);
  parts = data || [];
  
  // Join supplier names
  parts.forEach(p => {
    const sup = suppliers.find(s => s.supplier_id === p.primary_supplier_id);
    p.supplier_name = sup?.supplier_name || 'No Supplier';
  });
}

function generatePONumber() {
  const date = new Date();
  const poNum = `PO-${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}-${Math.floor(Math.random()*1000)}`;
  document.getElementById('poNumber').value = poNum;
}

function searchParts() {
  const query = document.getElementById('partSearch').value.toLowerCase();
  const supplierId = document.getElementById('supplierId').value;
  
  let filtered = parts;
  
  // Filter by supplier if selected
  if (supplierId) {
    filtered = filtered.filter(p => p.primary_supplier_id === supplierId);
  }
  
  // Filter by search query
  if (query.length >= 2) {
    filtered = filtered.filter(p => 
      p.part_number.toLowerCase().includes(query) ||
      p.part_name.toLowerCase().includes(query) ||
      (p.manufacturer && p.manufacturer.toLowerCase().includes(query)) ||
      (p.manufacturer_part_number && p.manufacturer_part_number.toLowerCase().includes(query))
    );
  }
  
  renderPartResults(filtered.slice(0, 20));
}

function filterPartsBySupplier() {
  searchParts();
}

function renderPartResults(results) {
  const container = document.getElementById('partResults');
  
  if (!results.length) {
    container.innerHTML = '<div class="empty">No parts found. Try a different search.</div>';
    return;
  }
  
  container.innerHTML = results.map(p => `
    <div class="part-card" onclick="addPart('${p.part_id}')">
      <div class="part-info">
        <div class="part-number">${p.part_number}</div>
        <div class="part-name">${p.part_name}</div>
        <div class="part-supplier">${p.supplier_name}</div>
      </div>
      <div class="part-detail">
        <div class="detail-label">On Hand</div>
        <div class="detail-value">${p.quantity_on_hand}</div>
      </div>
      <div class="part-detail">
        <div class="detail-label">Cost</div>
        <div class="detail-value">$${p.cost_price.toFixed(2)}</div>
      </div>
      <button class="btn btn-add" onclick="event.stopPropagation(); addPart('${p.part_id}')">Add</button>
    </div>
  `).join('');
}

function addPart(partId) {
  const part = parts.find(p => p.part_id === partId);
  if (!part) return;
  
  // Check if already added
  if (selectedParts.find(p => p.part_id === partId)) {
    alert('Part already added to order');
    return;
  }
  
  // Calculate suggested order qty
  const suggestedQty = part.reorder_quantity || (part.reorder_point * 2) || 10;
  
  selectedParts.push({
    part_id: part.part_id,
    part_number: part.part_number,
    part_name: part.part_name,
    quantity: suggestedQty,
    cost: part.cost_price
  });
  
  renderSelectedParts();
  updateSummary();
}

function removePart(partId) {
  selectedParts = selectedParts.filter(p => p.part_id !== partId);
  renderSelectedParts();
  updateSummary();
}

function updateQty(partId, qty) {
  const part = selectedParts.find(p => p.part_id === partId);
  if (part) {
    part.quantity = Math.max(1, parseInt(qty) || 1);
    updateSummary();
  }
}

function renderSelectedParts() {
  const container = document.getElementById('selectedItems');
  document.getElementById('itemCount').textContent = selectedParts.length;
  
  if (!selectedParts.length) {
    container.innerHTML = '<div class="empty">No parts added yet. Search and add parts above.</div>';
    return;
  }
  
  container.innerHTML = selectedParts.map(p => `
    <div class="selected-item">
      <div class="part-info">
        <div class="part-number">${p.part_number}</div>
        <div class="part-name">${p.part_name}</div>
      </div>
      <input 
        type="number" 
        class="qty-input" 
        value="${p.quantity}" 
        min="1"
        onchange="updateQty('${p.part_id}', this.value)"
      >
      <div class="part-detail">
        <div class="detail-label">Unit Cost</div>
        <div class="detail-value">$${p.cost.toFixed(2)}</div>
      </div>
      <div class="part-detail">
        <div class="detail-label">Line Total</div>
        <div class="detail-value">$${(p.quantity * p.cost).toFixed(2)}</div>
      </div>
      <button class="remove-btn" onclick="removePart('${p.part_id}')">Ã—</button>
    </div>
  `).join('');
}

function updateSummary() {
  const subtotal = selectedParts.reduce((sum, p) => sum + (p.quantity * p.cost), 0);
  const tax = subtotal * 0.08;
  const shipping = 0; // Could add shipping logic
  const total = subtotal + tax + shipping;
  
  document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
  document.getElementById('tax').textContent = '$' + tax.toFixed(2);
  document.getElementById('shipping').textContent = '$' + shipping.toFixed(2);
  document.getElementById('total').textContent = '$' + total.toFixed(2);
}

async function savePO(status) {
  if (!document.getElementById('supplierId').value) {
    alert('Please select a supplier');
    return;
  }
  
  if (!selectedParts.length) {
    alert('Please add at least one part to the order');
    return;
  }
  
  const subtotal = selectedParts.reduce((sum, p) => sum + (p.quantity * p.cost), 0);
  const tax = subtotal * 0.08;
  const total = subtotal + tax;
  
  // Create PO
  const { data: po, error: poError } = await sb.from('parts_purchase_orders').insert({
    tenant_id: tenantId,
    po_number: document.getElementById('poNumber').value,
    supplier_id: document.getElementById('supplierId').value,
    order_date: new Date().toISOString().split('T')[0],
    expected_date: document.getElementById('expectedDate').value || null,
    status: status,
    subtotal: subtotal,
    tax_amount: tax,
    shipping_cost: 0,
    total_amount: total,
    notes: document.getElementById('poNotes').value || null
  }).select().single();
  
  if (poError) {
    alert('Error creating PO: ' + poError.message);
    return;
  }
  
  // Create PO lines
  const lines = selectedParts.map((p, index) => ({
    tenant_id: tenantId,
    po_id: po.po_id,
    part_id: p.part_id,
    line_number: index + 1,
    quantity_ordered: p.quantity,
    unit_cost: p.cost
  }));
  
  const { error: linesError } = await sb.from('parts_purchase_order_lines').insert(lines);
  
  if (linesError) {
    alert('Error adding items: ' + linesError.message);
    return;
  }
  
  // Update parts on_order quantity
  for (const p of selectedParts) {
    const part = parts.find(part => part.part_id === p.part_id);
    await sb.from('parts_inventory')
      .update({ quantity_on_order: (part.quantity_on_order || 0) + p.quantity })
      .eq('part_id', p.part_id);
  }
  
  alert(`PO ${po.po_number} created successfully!`);
  window.location.href = 'parts-dashboard-final.html';
}

init();
</script>

</body>
</html>
