<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Work Order Details</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="theme-system.css">
  <style>
    /* ===== INLINE THEME DEFINITIONS ===== */
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8;
    }
    [data-theme="charcoal"] {
      --bg-primary: #121214; --bg-secondary: #18181b; --bg-card: #27272a; --bg-hover: #3f3f46;
      --border-default: #3f3f46; --text-primary: #fafafa; --text-secondary: #a1a1aa;
      --accent-primary: #a1a1aa; --accent-light: #d4d4d8;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80;
    }
    [data-theme="obsidian"] {
      --bg-primary: #050505; --bg-secondary: #0a0a0a; --bg-card: #141414; --bg-hover: #1c1c1c;
      --border-default: #252525; --text-primary: #e0e0e0; --text-secondary: #888888;
      --accent-primary: #0ea5e9; --accent-light: #38bdf8;
    }
    [data-theme="steel"] {
      --bg-primary: #0c0f13; --bg-secondary: #12161c; --bg-card: #1a2028; --bg-hover: #242c38;
      --border-default: #2c3644; --text-primary: #e4e8ed; --text-secondary: #8b95a5;
      --accent-primary: #64748b; --accent-light: #94a3b8;
    }
    [data-theme="espresso"] {
      --bg-primary: #0f0c0a; --bg-secondary: #161210; --bg-card: #211c18; --bg-hover: #2c2520;
      --border-default: #382f28; --text-primary: #f0ebe5; --text-secondary: #a89e94;
      --accent-primary: #a78b6e; --accent-light: #c4a88a;
    }
    [data-theme="onyx"] {
      --bg-primary: #000000; --bg-secondary: #080808; --bg-card: #121212; --bg-hover: #1a1a1a;
      --border-default: #222222; --text-primary: #f5f5f5; --text-secondary: #8c8c8c;
      --accent-primary: #06b6d4; --accent-light: #22d3ee;
    }
    /* ===== END THEME DEFINITIONS ===== */

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: #0b0f14; background-color: #0b0f14; }
    body { 
      font-family: system-ui; 
      background: var(--bg-primary); 
      color: var(--text-primary);
      padding-bottom: 120px;
    }
    
    /* Mobile Header */
    .mobile-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .back-btn {
      background: transparent;
      border: none;
      color: var(--accent-light);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .header-title {
      flex: 1;
    }
    .header-title h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .header-title .wo-number {
      font-size: 13px;
      color: var(--accent-light);
      font-weight: 600;
    }
    
    /* Main Content */
    .main-content {
      padding: 16px;
    }
    
    /* Section Cards */
    .section-card {
      background: var(--bg-card);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border-default);
      cursor: pointer;
    }
    
    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title svg {
      width: 18px;
      height: 18px;
      fill: var(--accent-light);
    }
    
    .section-toggle {
      font-size: 14px;
      color: var(--text-secondary);
      transition: transform 0.2s;
    }
    
    .section-header.collapsed .section-toggle {
      transform: rotate(-90deg);
    }
    
    .section-content {
      padding: 16px;
      transition: max-height 0.3s ease;
      overflow: hidden;
    }
    
    .section-content.collapsed {
      max-height: 0 !important;
      padding: 0 16px;
    }
    
    /* Info Rows */
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-default);
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .info-value {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      text-align: right;
    }
    
    .info-value.accent {
      color: var(--accent-light);
    }
    
    /* Editable Fields */
    .edit-field {
      width: 100%;
      margin-bottom: 16px;
    }
    
    .edit-field label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .edit-field input,
    .edit-field select,
    .edit-field textarea {
      width: 100%;
      padding: 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 16px;
    }
    
    .edit-field input:focus,
    .edit-field select:focus,
    .edit-field textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
    }
    
    .edit-field textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* Status/Priority Badges */
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      background: transparent;
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
    }
    
    .badge-large {
      padding: 10px 16px;
      font-size: 14px;
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    
    .btn {
      padding: 16px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      text-align: center;
      transition: opacity 0.2s;
    }
    
    .btn:active {
      opacity: 0.8;
    }
    
    .btn-primary {
      background: var(--accent-primary);
      color: white;
    }
    
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
    }
    
    .btn-success {
      background: #059669;
      color: white;
    }
    
    .btn-danger {
      background: transparent;
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    
    /* Line Items */
    .line-item {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 10px;
    }
    
    .line-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .line-item-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .line-item-price {
      font-size: 15px;
      font-weight: 600;
      color: var(--accent-light);
    }
    
    .line-item-details {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .line-item-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .line-item-btn {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border-default);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    /* Totals Section */
    .totals-section {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }
    
    .total-row.grand-total {
      border-top: 1px solid var(--border-default);
      margin-top: 8px;
      padding-top: 12px;
      font-size: 18px;
      font-weight: 700;
    }
    
    .total-row.grand-total .total-value {
      color: var(--accent-light);
    }
    
    /* Mobile Bottom Nav */
    .mobile-bottom-nav {
      display: block;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      padding: 8px;
      z-index: 100;
    }

    .mobile-nav-top {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .mobile-nav-top .mobile-nav-btn {
      background: var(--bg-hover);
    }

    .mobile-nav-secondary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .mobile-nav-btn {
      padding: 10px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }

    .mobile-nav-btn.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }
    
    /* Quick Actions Bar */
    .quick-actions {
      position: fixed;
      bottom: 102px;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      padding: 12px 16px;
      display: flex;
      gap: 10px;
      z-index: 101;
      border-top: 1px solid var(--border-default);
    }
    
    .quick-actions .btn {
      flex: 1;
      padding: 14px;
      font-size: 14px;
    }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: 12px 20px;
      color: var(--text-primary);
      font-size: 14px;
      z-index: 200;
      display: none;
    }
    
    .toast.show {
      display: block;
      animation: fadeInOut 2s ease;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }
  </style>
</head>
<body>

<div class="mobile-header">
  <button class="back-btn" onclick="history.back()">←</button>
  <div class="header-title">
    <h1>Work Order Details</h1>
    <div class="wo-number" id="woNumberHeader">Loading...</div>
  </div>
</div>

<div class="toast" id="toast">Saved!</div>

<div class="main-content" id="mainContent">
  <div class="loading">Loading work order...</div>
</div>

<!-- Quick Actions -->
<div class="quick-actions" id="quickActions" style="display: none;">
  <button class="btn btn-primary" onclick="saveWorkOrder()">Save Changes</button>
  <button class="btn btn-success" onclick="updateStatus('completed')">Complete</button>
</div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
    <a href="dashboard-search.html" class="mobile-nav-btn">Search</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn active">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let workOrder = null;
let customer = null;
let vehicle = null;
let employee = null;
let lineItems = [];

// Theme support
function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

// Get work order ID from URL
function getWorkOrderId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

// Toggle section collapse
function toggleSection(header) {
  header.classList.toggle('collapsed');
  const content = header.nextElementSibling;
  content.classList.toggle('collapsed');
  if (!content.classList.contains('collapsed')) {
    content.style.maxHeight = content.scrollHeight + 'px';
  }
}

// Show toast notification
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// Format date
function formatDate(dateStr) {
  if (!dateStr) return '--';
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Format time
function formatTime(dateTimeStr) {
  if (!dateTimeStr) return '--';
  const d = new Date(dateTimeStr);
  const hours = d.getHours();
  const mins = d.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const hour12 = hours % 12 || 12;
  return `${hour12}:${mins} ${ampm}`;
}

// Format currency
function formatCurrency(amount) {
  return '$' + (parseFloat(amount) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Load work order data
async function loadWorkOrder() {
  const woId = getWorkOrderId();
  if (!woId) {
    document.getElementById('mainContent').innerHTML = '<div class="loading">No work order ID provided</div>';
    return;
  }
  
  // Load work order
  const { data: woData, error: woError } = await sb
    .from('work_orders')
    .select('*')
    .eq('work_order_id', woId)
    .single();
  
  if (woError || !woData) {
    document.getElementById('mainContent').innerHTML = '<div class="loading">Work order not found</div>';
    return;
  }
  
  workOrder = woData;
  
  // Load customer
  if (workOrder.customer_id) {
    const { data: custData } = await sb
      .from('customers')
      .select('*')
      .eq('customer_id', workOrder.customer_id)
      .single();
    customer = custData;
  }
  
  // Load vehicle
  if (workOrder.vehicle_id) {
    const { data: vehData } = await sb
      .from('vehicles')
      .select('*')
      .eq('vehicle_id', workOrder.vehicle_id)
      .single();
    vehicle = vehData;
  }
  
  // Load assigned employee
  if (workOrder.assigned_employee_id) {
    const { data: empData } = await sb
      .from('employees')
      .select('*')
      .eq('employee_id', workOrder.assigned_employee_id)
      .single();
    employee = empData;
  }
  
  // Load line items
  const { data: itemsData } = await sb
    .from('work_order_items')
    .select('*')
    .eq('work_order_id', woId);
  lineItems = itemsData || [];
  
  renderWorkOrder();
}

// Render work order
function renderWorkOrder() {
  const woNum = workOrder.wo_number || workOrder.work_order_number || workOrder.work_order_id.slice(0, 8);
  document.getElementById('woNumberHeader').textContent = 'WO-' + woNum;
  document.title = 'WO-' + woNum + ' Details';
  
  const customerName = customer ? (customer.full_name || `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'Unknown') : 'Unknown';
  const vehicleName = vehicle ? `${vehicle.year || ''} ${vehicle.make || ''} ${vehicle.model || ''}`.trim() : 'Unknown';
  const techName = employee ? `${employee.first_name || ''} ${employee.last_name || ''}`.trim() : 'Unassigned';
  
  const status = workOrder.status || 'scheduled';
  const priority = workOrder.priority || 'normal';
  
  const html = `
    <!-- Status & Priority Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection(this)">
        <span class="section-title">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          Status & Priority
        </span>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">
        <div class="edit-field">
          <label>Status</label>
          <select id="statusSelect" onchange="workOrder.status = this.value">
            <option value="scheduled" ${status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
            <option value="checked_in" ${status === 'checked_in' ? 'selected' : ''}>Checked In</option>
            <option value="in_progress" ${status === 'in_progress' ? 'selected' : ''}>In Progress</option>
            <option value="waiting_parts" ${status === 'waiting_parts' ? 'selected' : ''}>Waiting Parts</option>
            <option value="parts_on_order" ${status === 'parts_on_order' ? 'selected' : ''}>Parts On Order</option>
            <option value="customer_approval" ${status === 'customer_approval' ? 'selected' : ''}>Customer Approval</option>
            <option value="approved" ${status === 'approved' ? 'selected' : ''}>Approved</option>
            <option value="diagnosis_required" ${status === 'diagnosis_required' ? 'selected' : ''}>Diagnosis Required</option>
            <option value="repairing" ${status === 'repairing' ? 'selected' : ''}>Repairing</option>
            <option value="testing" ${status === 'testing' ? 'selected' : ''}>Testing</option>
            <option value="quality_check" ${status === 'quality_check' ? 'selected' : ''}>Quality Check</option>
            <option value="ready_for_pickup" ${status === 'ready_for_pickup' ? 'selected' : ''}>Ready for Pickup</option>
            <option value="ready_invoice" ${status === 'ready_invoice' ? 'selected' : ''}>Ready to Invoice</option>
            <option value="completed" ${status === 'completed' ? 'selected' : ''}>Completed</option>
            <option value="closed" ${status === 'closed' ? 'selected' : ''}>Closed</option>
            <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
          </select>
        </div>
        <div class="edit-field">
          <label>Priority</label>
          <select id="prioritySelect" onchange="workOrder.priority = this.value">
            <option value="low" ${priority === 'low' ? 'selected' : ''}>Low</option>
            <option value="normal" ${priority === 'normal' ? 'selected' : ''}>Normal</option>
            <option value="high" ${priority === 'high' ? 'selected' : ''}>High</option>
            <option value="urgent" ${priority === 'urgent' ? 'selected' : ''}>Urgent</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Customer & Vehicle Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection(this)">
        <span class="section-title">
          <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          Customer & Vehicle
        </span>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">
        <div class="info-row">
          <span class="info-label">Customer</span>
          <span class="info-value">${customerName}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Phone</span>
          <span class="info-value accent">${customer?.phone || customer?.phone_number || '--'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value">${customer?.email || '--'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Vehicle</span>
          <span class="info-value">${vehicleName}</span>
        </div>
        <div class="info-row">
          <span class="info-label">VIN</span>
          <span class="info-value" style="font-size:12px;">${vehicle?.vin || '--'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Mileage</span>
          <span class="info-value">${vehicle?.mileage ? vehicle.mileage.toLocaleString() + ' mi' : '--'}</span>
        </div>
      </div>
    </div>
    
    <!-- Job Details Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection(this)">
        <span class="section-title">
          <svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
          Job Details
        </span>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">
        <div class="info-row">
          <span class="info-label">Assigned Tech</span>
          <span class="info-value">${techName}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Scheduled</span>
          <span class="info-value">${formatDate(workOrder.scheduled_start)} ${formatTime(workOrder.scheduled_start)}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Created</span>
          <span class="info-value">${formatDate(workOrder.created_at)}</span>
        </div>
        <div class="edit-field" style="margin-top:16px;">
          <label>Job Description</label>
          <textarea id="jobDescription">${workOrder.description || workOrder.job_description || ''}</textarea>
        </div>
        <div class="edit-field">
          <label>Internal Notes</label>
          <textarea id="internalNotes">${workOrder.notes || workOrder.internal_notes || ''}</textarea>
        </div>
      </div>
    </div>
    
    <!-- Line Items Section -->
    <div class="section-card">
      <div class="section-header" onclick="toggleSection(this)">
        <span class="section-title">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
          Line Items (${lineItems.length})
        </span>
        <span class="section-toggle">▼</span>
      </div>
      <div class="section-content">
        ${lineItems.length === 0 ? '<div style="text-align:center; padding:20px; color:var(--text-secondary);">No line items</div>' : 
          lineItems.map(item => `
            <div class="line-item">
              <div class="line-item-header">
                <span class="line-item-name">${item.description || item.name || 'Item'}</span>
                <span class="line-item-price">${formatCurrency(item.total || item.amount || 0)}</span>
              </div>
              <div class="line-item-details">
                ${item.quantity ? `Qty: ${item.quantity}` : ''} 
                ${item.unit_price ? ` @ ${formatCurrency(item.unit_price)}` : ''}
                ${item.type ? ` • ${item.type}` : ''}
              </div>
            </div>
          `).join('')
        }
        
        <button class="btn btn-secondary" style="width:100%; margin-top:12px;" onclick="alert('Add item coming soon!')">+ Add Line Item</button>
        
        <div class="totals-section">
          <div class="total-row">
            <span>Labor</span>
            <span>${formatCurrency(workOrder.labor_total || 0)}</span>
          </div>
          <div class="total-row">
            <span>Parts</span>
            <span>${formatCurrency(workOrder.parts_total || 0)}</span>
          </div>
          <div class="total-row">
            <span>Tax</span>
            <span>${formatCurrency(workOrder.tax_amount || 0)}</span>
          </div>
          <div class="total-row grand-total">
            <span>Total</span>
            <span class="total-value">${formatCurrency(workOrder.total_amount || 0)}</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Actions Section -->
    <div class="action-buttons">
      <button class="btn btn-secondary" onclick="window.print()">Print Work Order</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Delete Work Order</button>
    </div>
  `;
  
  document.getElementById('mainContent').innerHTML = html;
  document.getElementById('quickActions').style.display = 'flex';
}

// Update status directly
async function updateStatus(newStatus) {
  const { error } = await sb
    .from('work_orders')
    .update({ status: newStatus, updated_at: new Date().toISOString() })
    .eq('work_order_id', workOrder.work_order_id);
  
  if (error) {
    alert('Error updating status: ' + error.message);
    return;
  }
  
  workOrder.status = newStatus;
  showToast('Status updated to ' + newStatus);
  renderWorkOrder();
}

// Save work order
async function saveWorkOrder() {
  const status = document.getElementById('statusSelect')?.value || workOrder.status;
  const priority = document.getElementById('prioritySelect')?.value || workOrder.priority;
  const description = document.getElementById('jobDescription')?.value || '';
  const notes = document.getElementById('internalNotes')?.value || '';
  
  const { error } = await sb
    .from('work_orders')
    .update({
      status: status,
      priority: priority,
      description: description,
      notes: notes,
      updated_at: new Date().toISOString()
    })
    .eq('work_order_id', workOrder.work_order_id);
  
  if (error) {
    alert('Error saving: ' + error.message);
    return;
  }
  
  workOrder.status = status;
  workOrder.priority = priority;
  showToast('Work order saved!');
}

// Confirm delete
function confirmDelete() {
  if (confirm('Are you sure you want to delete this work order? This cannot be undone.')) {
    deleteWorkOrder();
  }
}

// Delete work order
async function deleteWorkOrder() {
  const { error } = await sb
    .from('work_orders')
    .delete()
    .eq('work_order_id', workOrder.work_order_id);
  
  if (error) {
    alert('Error deleting: ' + error.message);
    return;
  }
  
  window.location.href = 'dashboard-service.html';
}

// Auth check
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refreshToken = localStorage.getItem('sb_refresh_token');
    
    if (token && refreshToken) {
      const { data, error } = await sb.auth.setSession({
        access_token: token,
        refresh_token: refreshToken
      });
      if (error || !data.session) {
        window.location.href = 'login.html';
        return null;
      }
      return data.session;
    }
    window.location.href = 'login.html';
    return null;
  }
  return session;
}

// Init
async function init() {
  const session = await checkAuth();
  if (!session) return;
  
  await loadWorkOrder();
}

init();
</script>

</body>
</html>
