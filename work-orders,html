<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4">
  <title>Work Orders - WorkLogicPro</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:#0a0e1a;
      color:#e8eef6;
      line-height:1.6;
    }

    /* Header */
    .header {
      background:#0f1621;
      border-bottom:1px solid #223044;
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:100;
    }
    .businessName {
      font-size:20px;
      font-weight:700;
      color:#e8eef6;
    }
    .logo {
      font-size:16px;
      font-weight:600;
      color:#60a5fa;
    }
    .userInfo {
      font-size:14px;
      color:#9fb0c3;
    }

    /* Container */
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:24px;
    }

    /* Back button */
    .backBtn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      color:#60a5fa;
      text-decoration:none;
      font-size:14px;
      margin-bottom:24px;
    }
    .backBtn:hover {
      background:#2a3b55;
    }

    /* Page header */
    .pageHeader {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
    }
    .pageTitle {
      font-size:28px;
      font-weight:700;
    }
    .createBtn {
      padding:12px 24px;
      background:#2563eb;
      border:none;
      border-radius:8px;
      color:#fff;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
      display:inline-block;
    }
    .createBtn:hover {
      background:#1d4ed8;
    }

    /* Filters */
    .filters {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:12px;
      padding:20px;
      margin-bottom:20px;
    }
    .filterRow {
      display:grid;
      grid-template-columns:1fr 1fr 1fr 1fr;
      gap:16px;
      margin-bottom:16px;
    }
    .filterRow:last-child {
      margin-bottom:0;
    }
    .filterGroup {
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .filterLabel {
      font-size:13px;
      font-weight:600;
      color:#9fb0c3;
    }
    .filterInput, .filterSelect {
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      padding:10px 12px;
      color:#e8eef6;
      font-size:14px;
      font-family:inherit;
    }
    .filterInput:focus, .filterSelect:focus {
      outline:none;
      border-color:#60a5fa;
    }
    .filterBtns {
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    .filterBtn {
      padding:10px 20px;
      border-radius:8px;
      border:1px solid #223044;
      background:#1a2535;
      color:#e8eef6;
      font-size:14px;
      cursor:pointer;
    }
    .filterBtn:hover {
      background:#2a3b55;
    }

    /* Stats */
    .stats {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
      margin-bottom:24px;
    }
    .statCard {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:12px;
      padding:16px;
    }
    .statValue {
      font-size:28px;
      font-weight:700;
      color:#60a5fa;
    }
    .statLabel {
      font-size:13px;
      color:#9fb0c3;
      margin-top:4px;
    }

    /* Table */
    .tableContainer {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:12px;
      overflow:hidden;
    }
    .table {
      width:100%;
      border-collapse:collapse;
    }
    .table thead {
      background:#1a2535;
    }
    .table th {
      padding:16px;
      text-align:left;
      font-size:13px;
      font-weight:600;
      color:#9fb0c3;
      border-bottom:1px solid #223044;
    }
    .table th.sortable {
      cursor:pointer;
      user-select:none;
    }
    .table th.sortable:hover {
      color:#60a5fa;
    }
    .table td {
      padding:16px;
      border-bottom:1px solid #223044;
      font-size:14px;
    }
    .table tbody tr {
      cursor:pointer;
      transition:background 0.2s;
    }
    .table tbody tr:hover {
      background:#1a2535;
    }

    /* Status badges */
    .statusBadge {
      display:inline-block;
      padding:4px 12px;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
    }
    .status-draft { background:#374151; color:#d1d5db; }
    .status-scheduled { background:#1e3a8a; color:#93c5fd; }
    .status-in_progress { background:#ea580c; color:#fed7aa; }
    .status-repairing { background:#ea580c; color:#fed7aa; }
    .status-testing { background:#7c3aed; color:#ddd6fe; }
    .status-ready_for_pickup { background:#15803d; color:#bbf7d0; }
    .status-completed { background:#064e3b; color:#a7f3d0; }
    .status-closed { background:#064e3b; color:#a7f3d0; }
    .status-diagnosis_required { background:#ca8a04; color:#fef3c7; }
    .status-customer_approval { background:#ca8a04; color:#fef3c7; }
    .status-awaiting_parts { background:#dc2626; color:#fecaca; }
    .status-parts_on_order { background:#dc2626; color:#fecaca; }

    /* Priority badges */
    .priorityBadge {
      display:inline-block;
      padding:4px 12px;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
    }
    .priority-urgent { background:#dc2626; color:#fecaca; }
    .priority-high { background:#ea580c; color:#fed7aa; }
    .priority-normal { background:#1e3a8a; color:#93c5fd; }
    .priority-low { background:#374151; color:#d1d5db; }

    /* Loading */
    .loading {
      text-align:center;
      padding:40px;
      color:#9fb0c3;
    }

    /* Empty state */
    .emptyState {
      text-align:center;
      padding:60px 20px;
      color:#9fb0c3;
    }
    .emptyState h3 {
      font-size:20px;
      margin-bottom:8px;
      color:#e8eef6;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .filterRow {
        grid-template-columns:1fr;
      }
      .table {
        font-size:12px;
      }
      .table th, .table td {
        padding:12px 8px;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="businessName">Shasta Jet Ski Service</div>
    <div class="logo">WorkLogicPro</div>
    <div class="userInfo" id="userInfo">Loading...</div>
  </div>

  <div class="container">
    <a href="dashboard-business.html" class="backBtn">‚Üê Back to Dashboard</a>

    <div class="pageHeader">
      <div class="pageTitle">Work Orders</div>
      <a href="work-orders-create.html" class="createBtn">+ Create Work Order</a>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="statCard">
        <div class="statValue" id="statTotal">0</div>
        <div class="statLabel">Total Work Orders</div>
      </div>
      <div class="statCard">
        <div class="statValue" id="statInProgress">0</div>
        <div class="statLabel">In Progress</div>
      </div>
      <div class="statCard">
        <div class="statValue" id="statScheduled">0</div>
        <div class="statLabel">Scheduled</div>
      </div>
      <div class="statCard">
        <div class="statValue" id="statReady">0</div>
        <div class="statLabel">Ready for Pickup</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filterRow">
        <div class="filterGroup">
          <label class="filterLabel">Search</label>
          <input type="text" class="filterInput" id="searchInput" placeholder="Customer, vehicle, summary...">
        </div>
        <div class="filterGroup">
          <label class="filterLabel">Status</label>
          <select class="filterSelect" id="statusFilter">
            <option value="">All Statuses</option>
            <option value="draft">Draft</option>
            <option value="scheduled">Scheduled</option>
            <option value="in_progress">In Progress</option>
            <option value="repairing">Repairing</option>
            <option value="testing">Testing</option>
            <option value="ready_for_pickup">Ready for Pickup</option>
            <option value="completed">Completed</option>
            <option value="closed">Closed</option>
            <option value="diagnosis_required">Diagnosis Required</option>
            <option value="customer_approval">Customer Approval</option>
            <option value="awaiting_parts">Awaiting Parts</option>
            <option value="parts_on_order">Parts on Order</option>
          </select>
        </div>
        <div class="filterGroup">
          <label class="filterLabel">Priority</label>
          <select class="filterSelect" id="priorityFilter">
            <option value="">All Priorities</option>
            <option value="urgent">Urgent</option>
            <option value="high">High</option>
            <option value="normal">Normal</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="filterGroup">
          <label class="filterLabel">Technician</label>
          <select class="filterSelect" id="techFilter">
            <option value="">All Technicians</option>
          </select>
        </div>
      </div>
      <div class="filterRow">
        <div class="filterBtns">
          <button class="filterBtn" onclick="applyFilters()">Apply Filters</button>
          <button class="filterBtn" onclick="clearFilters()">Clear</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div id="content" class="loading">Loading work orders...</div>
  </div>

<script>
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
  const REST_BASE = `${API_BASE}/rest/v1`;
  const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

  let currentEmployee = null;
  let allWorkOrders = [];
  let filteredWorkOrders = [];
  let customers = {};
  let vehicles = {};
  let employees = {};

  async function validateAuth() {
    const token = localStorage.getItem("sb_access_token");
    if (!token) return null;
    
    try {
      const res = await fetch(`${API_BASE}/auth/v1/user`, {
        headers: { 
          Authorization: `Bearer ${token}`,
          "apikey": ANON_KEY
        }
      });
      if (!res.ok) return null;
      return token;
    } catch {
      return null;
    }
  }

  async function fetchJson(url, token) {
    const res = await fetch(url, {
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
        "apikey": ANON_KEY
      }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function fetchRest(table, token, params = "") {
    const url = `${REST_BASE}/${table}?${params}`;
    return fetchJson(url, token);
  }

  async function load() {
    console.log('üöÄ Starting work-orders.html load...');
    
    const token = await validateAuth();
    console.log('Token check:', token ? 'Found' : 'Not found');
    
    if (!token) {
      console.log('‚ùå No token, redirecting to login');
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
      return;
    }

    try {
      console.log('üì• Fetching user info...');
      
      // Get current user
      const userRes = await fetch(`${API_BASE}/auth/v1/user`, {
        headers: { 
          Authorization: `Bearer ${token}`,
          "apikey": ANON_KEY
        }
      });
      
      console.log('User response status:', userRes.status);
      
      if (!userRes.ok) {
        throw new Error(`User fetch failed: ${userRes.status}`);
      }
      
      const currentUser = await userRes.json();
      console.log('‚úÖ Current user:', currentUser.email);

      // Try to get employee record by user_id
      console.log('üì• Fetching employee by user_id...');
      let empData = await fetchRest('employees', token, `user_id=eq.${currentUser.id}`);
      console.log('Employee by user_id result:', empData?.length || 0, 'records');
      
      // If not found by user_id, get first employee for this tenant (fallback)
      if (!empData || empData.length === 0) {
        console.log('‚ö†Ô∏è No employee by user_id, trying by tenant...');
        const tenantId = localStorage.getItem('tenant_id') || '11111111-1111-1111-1111-111111111111';
        console.log('Using tenant_id:', tenantId);
        empData = await fetchRest('employees', token, `tenant_id=eq.${tenantId}&limit=1`);
        console.log('Employee by tenant result:', empData?.length || 0, 'records');
      }
      
      currentEmployee = empData[0];

      if (!currentEmployee) {
        console.log('‚ö†Ô∏è No employee found, using fallback');
        // If still no employee, create a mock one
        currentEmployee = {
          employee_id: 'temp',
          tenant_id: '11111111-1111-1111-1111-111111111111',
          first_name: 'User',
          last_name: '',
          role: 'manager'
        };
      }

      console.log('‚úÖ Employee loaded:', currentEmployee.first_name, currentEmployee.last_name, `(${currentEmployee.role})`);

      document.getElementById('userInfo').textContent = 
        `${currentEmployee.first_name} ${currentEmployee.last_name} (${currentEmployee.role})`;

      console.log('üì• Loading work orders and related data...');

      // Load all data
      const [workOrdersData, customersData, vehiclesData, employeesData] = await Promise.all([
        fetchRest('work_orders', token, `tenant_id=eq.${currentEmployee.tenant_id}&deleted=eq.false&order=created_at.desc`),
        fetchRest('customers', token, `tenant_id=eq.${currentEmployee.tenant_id}`),
        fetchRest('vehicles', token, `tenant_id=eq.${currentEmployee.tenant_id}`),
        fetchRest('employees', token, `tenant_id=eq.${currentEmployee.tenant_id}&role=eq.technician`)
      ]);

      console.log('‚úÖ Data loaded:', {
        workOrders: workOrdersData.length,
        customers: customersData.length,
        vehicles: vehiclesData.length,
        employees: employeesData.length
      });

      allWorkOrders = workOrdersData;
      
      // Create lookup objects
      customersData.forEach(c => customers[c.customer_id] = c);
      vehiclesData.forEach(v => vehicles[v.vehicle_id] = v);
      employeesData.forEach(e => employees[e.employee_id] = e);

      // Populate tech filter
      const techFilter = document.getElementById('techFilter');
      employeesData.forEach(e => {
        const option = document.createElement('option');
        option.value = e.employee_id;
        option.textContent = `${e.first_name} ${e.last_name}`;
        techFilter.appendChild(option);
      });

      console.log('‚úÖ Initial render...');
      // Initial render
      applyFilters();
      
      console.log('‚úÖ Load complete!');

    } catch (err) {
      console.error('‚ùå Load error:', err);
      console.error('Error stack:', err.stack);
      document.getElementById('content').innerHTML = 
        `<div class="emptyState">
          <h3>Error loading work orders</h3>
          <p>${err.message}</p>
          <p style="font-size:12px;color:#9fb0c3;margin-top:12px;">Check browser console for details</p>
        </div>`;
    }
  }

  function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    const techFilter = document.getElementById('techFilter').value;

    filteredWorkOrders = allWorkOrders.filter(wo => {
      // Search filter
      if (searchTerm) {
        const customer = customers[wo.customer_id];
        const vehicle = vehicles[wo.vehicle_id];
        const customerName = customer ? `${customer.first_name} ${customer.last_name}`.toLowerCase() : '';
        const vehicleName = vehicle ? `${vehicle.year} ${vehicle.make} ${vehicle.model}`.toLowerCase() : '';
        const summary = wo.summary?.toLowerCase() || '';
        
        if (!customerName.includes(searchTerm) && 
            !vehicleName.includes(searchTerm) && 
            !summary.includes(searchTerm)) {
          return false;
        }
      }

      // Status filter
      if (statusFilter && wo.status !== statusFilter) return false;

      // Priority filter
      if (priorityFilter && wo.priority !== priorityFilter) return false;

      // Tech filter
      if (techFilter && wo.assigned_employee_id !== techFilter) return false;

      return true;
    });

    renderStats();
    renderTable();
  }

  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('techFilter').value = '';
    applyFilters();
  }

  function renderStats() {
    document.getElementById('statTotal').textContent = allWorkOrders.length;
    document.getElementById('statInProgress').textContent = 
      allWorkOrders.filter(wo => wo.status === 'in_progress' || wo.status === 'repairing').length;
    document.getElementById('statScheduled').textContent = 
      allWorkOrders.filter(wo => wo.status === 'scheduled').length;
    document.getElementById('statReady').textContent = 
      allWorkOrders.filter(wo => wo.status === 'ready_for_pickup').length;
  }

  function renderTable() {
    const content = document.getElementById('content');

    if (filteredWorkOrders.length === 0) {
      content.innerHTML = `
        <div class="emptyState">
          <h3>No work orders found</h3>
          <p>Try adjusting your filters or create a new work order</p>
        </div>
      `;
      return;
    }

    content.innerHTML = `
      <div class="tableContainer">
        <table class="table">
          <thead>
            <tr>
              <th>WO #</th>
              <th>Customer</th>
              <th>Vehicle</th>
              <th>Summary</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Technician</th>
              <th>Total</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            ${filteredWorkOrders.map(wo => {
              const customer = customers[wo.customer_id];
              const vehicle = vehicles[wo.vehicle_id];
              const tech = employees[wo.assigned_employee_id];
              
              return `
                <tr onclick="window.location.href='work-orders-edit.html?id=${wo.work_order_id}'">
                  <td><strong>#${wo.work_order_id.substring(0, 8).toUpperCase()}</strong></td>
                  <td>${customer ? `${customer.first_name} ${customer.last_name}` : 'Unknown'}</td>
                  <td>${vehicle ? `${vehicle.year} ${vehicle.make} ${vehicle.model}` : 'Unknown'}</td>
                  <td>${wo.summary}</td>
                  <td><span class="statusBadge status-${wo.status}">${formatStatus(wo.status)}</span></td>
                  <td><span class="priorityBadge priority-${wo.priority}">${wo.priority?.toUpperCase() || 'NORMAL'}</span></td>
                  <td>${tech ? `${tech.first_name} ${tech.last_name}` : 'Unassigned'}</td>
                  <td><strong>$${parseFloat(wo.grand_total || 0).toFixed(2)}</strong></td>
                  <td>${new Date(wo.created_at).toLocaleDateString()}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function formatStatus(status) {
    return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  }

  // Initialize
  load();

  // Live search
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }
  });
</script>

</body>
</html>
