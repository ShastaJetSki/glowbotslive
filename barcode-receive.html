<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Receive Parts</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui; 
      background: #0b0f14; 
      color: #e8eef6;
      padding-bottom: 80px;
    }
    
    .header {
      background: #1a2535;
      padding: 16px 20px;
      border-bottom: 1px solid #2d3f56;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 { color: #60a5fa; font-size: 20px; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      background: #1a2535;
      border-bottom: 1px solid #2d3f56;
    }
    .tab {
      flex: 1;
      padding: 16px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab.active {
      color: #60a5fa;
      border-bottom-color: #60a5fa;
      background: #0f1621;
    }
    
    .container { padding: 20px; max-width: 800px; margin: 0 auto; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat {
      background: #1a2535;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-label {
      color: #94a3b8;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .stat-value {
      color: #e8eef6;
      font-size: 24px;
      font-weight: 700;
    }
    
    /* Scanner Section */
    .scanner-section {
      background: #1a2535;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    #reader {
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    /* PO Section */
    .po-section {
      background: #1a2535;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-title {
      color: #60a5fa;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    /* PO List */
    .po-list {
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
    }
    .po-card {
      background: #0f1621;
      border: 2px solid #2d3f56;
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .po-card:hover {
      border-color: #3b82f6;
    }
    .po-card.selected {
      border-color: #60a5fa;
      background: #1a2535;
    }
    .po-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .po-number {
      color: #60a5fa;
      font-weight: 600;
      font-size: 16px;
    }
    .po-status {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending { background: #f59e0b; color: #0b0f14; }
    .status-partial { background: #3b82f6; color: white; }
    .status-complete { background: #10b981; color: white; }
    .po-info {
      color: #94a3b8;
      font-size: 13px;
    }
    
    /* PO Items */
    .po-items {
      display: grid;
      gap: 12px;
    }
    .po-item {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 16px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 16px;
      align-items: center;
    }
    .item-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .item-number {
      color: #60a5fa;
      font-weight: 600;
      font-size: 14px;
    }
    .item-name {
      color: #e8eef6;
      font-size: 13px;
    }
    .item-detail {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .detail-label {
      color: #94a3b8;
      font-size: 11px;
      text-transform: uppercase;
    }
    .detail-value {
      color: #e8eef6;
      font-weight: 600;
      font-size: 14px;
    }
    .receive-input {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .qty-input {
      width: 80px;
      padding: 8px;
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 6px;
      color: #e8eef6;
      text-align: center;
      font-size: 14px;
    }
    .check-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 6px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .check-btn.unchecked {
      background: #475569;
      color: #94a3b8;
    }
    .check-btn.checked {
      background: #10b981;
      color: white;
    }
    
    /* Scanned Items List */
    .scanned-items {
      background: #1a2535;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .item {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .item-barcode {
      color: #60a5fa;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .item-name {
      color: #e8eef6;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .item-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .qty-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 6px;
      background: #475569;
      color: white;
      font-size: 20px;
      cursor: pointer;
      touch-action: manipulation;
    }
    .qty-btn:active { background: #334155; }
    .remove-btn {
      background: #dc2626;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
      margin-bottom: 12px;
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:active { background: #2563eb; }
    .btn-success { background: #059669; color: white; }
    .btn-success:active { background: #047857; }
    .btn-secondary { background: #475569; color: white; }
    .btn-secondary:active { background: #334155; }
    
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a2535;
      border: 1px solid #3b82f6;
      padding: 16px 24px;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      min-width: 200px;
      text-align: center;
    }
    .toast.show { display: block; }
    
    /* Bottom Actions */
    .bottom-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1a2535;
      border-top: 1px solid #2d3f56;
      padding: 16px 20px;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .po-item {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .stats {
        grid-template-columns: 1fr 1fr;
      }
      input, select {
        font-size: 16px; /* Prevent zoom on iOS */
      }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>Receive Parts</h1>
  <button class="btn-secondary" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;" onclick="window.location.href='parts-dashboard-final.html'">Back</button>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('barcode')">Barcode Scan</button>
  <button class="tab" onclick="switchTab('po')">Receive PO</button>
</div>

<div class="container">
  
  <!-- Barcode Tab -->
  <div id="barcodeTab" class="tab-content active">
    
    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="stat-label">Items Scanned</div>
        <div class="stat-value" id="itemCount">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Total Quantity</div>
        <div class="stat-value" id="totalQty">0</div>
      </div>
    </div>

    <!-- Scanner -->
    <div class="scanner-section">
      <div class="section-title">Scan Barcode</div>
      <div id="reader"></div>
      <button id="toggleScanner" class="btn btn-primary">Start Scanner</button>
      <button id="manualEntry" class="btn btn-secondary">Manual Entry</button>
    </div>

    <!-- Scanned Items -->
    <div class="scanned-items">
      <div class="section-title">Scanned Items (<span id="itemCountText">0</span>)</div>
      <div id="itemsList">
        <div class="empty">No items scanned yet. Start scanning barcodes above.</div>
      </div>
    </div>

  </div>
  
  <!-- PO Tab -->
  <div id="poTab" class="tab-content">
    
    <!-- Select PO -->
    <div class="po-section">
      <div class="section-title">Select Purchase Order</div>
      <div id="poList" class="po-list"></div>
    </div>
    
    <!-- PO Items -->
    <div id="poItemsSection" style="display: none;">
      <div class="po-section">
        <div class="section-title">Items to Receive</div>
        <div id="poItems" class="po-items"></div>
      </div>
    </div>
    
  </div>

</div>

<!-- Bottom Actions -->
<div class="bottom-actions">
  <button id="receiveAllBtn" class="btn btn-success" disabled>Receive All Items</button>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let tenantId = '11111111-1111-1111-1111-111111111111';
let scannedItems = [];
let scanner = null;
let isScanning = false;
let currentTab = 'barcode';
let purchaseOrders = [];
let selectedPO = null;
let poItemsReceiveState = {};

// Initialize
async function init() {
  document.getElementById('toggleScanner').addEventListener('click', toggleScanner);
  document.getElementById('manualEntry').addEventListener('click', manualEntry);
  document.getElementById('receiveAllBtn').addEventListener('click', receiveAll);
  
  await loadPurchaseOrders();
}

// Tab Switching
function switchTab(tab) {
  currentTab = tab;
  
  // Update tab buttons
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  // Update tab content
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(tab === 'barcode' ? 'barcodeTab' : 'poTab').classList.add('active');
  
  // Update bottom button
  updateReceiveButton();
  
  // Stop scanner if switching away
  if (tab === 'po' && isScanning) {
    stopScanner();
  }
}

// Barcode Scanning
async function toggleScanner() {
  if (isScanning) {
    stopScanner();
  } else {
    startScanner();
  }
}

async function startScanner() {
  const config = {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    aspectRatio: 1.0
  };
  
  try {
    scanner = new Html5Qrcode("reader");
    await scanner.start(
      { facingMode: "environment" },
      config,
      onScanSuccess,
      onScanError
    );
    
    isScanning = true;
    document.getElementById('toggleScanner').textContent = 'Stop Scanner';
    document.getElementById('toggleScanner').classList.remove('btn-primary');
    document.getElementById('toggleScanner').classList.add('btn-secondary');
  } catch (err) {
    console.error('Scanner error:', err);
    showToast('Camera access denied or not available');
  }
}

function stopScanner() {
  if (scanner) {
    scanner.stop();
    scanner = null;
  }
  isScanning = false;
  document.getElementById('toggleScanner').textContent = 'Start Scanner';
  document.getElementById('toggleScanner').classList.remove('btn-secondary');
  document.getElementById('toggleScanner').classList.add('btn-primary');
}

async function onScanSuccess(decodedText) {
  // Check if already scanned
  const existing = scannedItems.find(item => item.barcode === decodedText);
  if (existing) {
    existing.quantity++;
    showToast('Quantity increased to ' + existing.quantity);
  } else {
    // Look up part in database
    const { data, error } = await sb
      .from('parts_inventory')
      .select('*')
      .eq('barcode', decodedText)
      .eq('tenant_id', tenantId)
      .single();
    
    if (data) {
      scannedItems.push({
        barcode: decodedText,
        part_id: data.part_id,
        part_number: data.part_number,
        part_name: data.part_name,
        quantity: 1
      });
      showToast('Added: ' + data.part_name);
    } else {
      scannedItems.push({
        barcode: decodedText,
        part_id: null,
        part_number: 'UNKNOWN',
        part_name: 'Unknown Part - ' + decodedText,
        quantity: 1
      });
      showToast('Unknown barcode added');
    }
  }
  
  renderBarcodeItems();
  updateBarcodeStats();
  updateReceiveButton();
}

function onScanError(error) {
  // Ignore scan errors
}

function manualEntry() {
  const barcode = prompt('Enter barcode manually:');
  if (barcode) {
    onScanSuccess(barcode);
  }
}

function renderBarcodeItems() {
  const container = document.getElementById('itemsList');
  
  if (scannedItems.length === 0) {
    container.innerHTML = '<div class="empty">No items scanned yet. Start scanning barcodes above.</div>';
    return;
  }
  
  container.innerHTML = scannedItems.map((item, index) => `
    <div class="item">
      <div class="item-barcode">${item.barcode}</div>
      <div class="item-name">${item.part_number} - ${item.part_name}</div>
      <div class="item-controls">
        <button class="qty-btn" onclick="changeBarcodeQty(${index}, -1)">−</button>
        <input type="number" class="qty-input" value="${item.quantity}" onchange="setBarcodeQty(${index}, this.value)" min="1">
        <button class="qty-btn" onclick="changeBarcodeQty(${index}, 1)">+</button>
        <button class="remove-btn" onclick="removeBarcodeItem(${index})">Remove</button>
      </div>
    </div>
  `).join('');
}

function changeBarcodeQty(index, delta) {
  scannedItems[index].quantity = Math.max(1, scannedItems[index].quantity + delta);
  renderBarcodeItems();
  updateBarcodeStats();
}

function setBarcodeQty(index, value) {
  scannedItems[index].quantity = Math.max(1, parseInt(value) || 1);
  renderBarcodeItems();
  updateBarcodeStats();
}

function removeBarcodeItem(index) {
  scannedItems.splice(index, 1);
  renderBarcodeItems();
  updateBarcodeStats();
  updateReceiveButton();
}

function updateBarcodeStats() {
  const itemCount = scannedItems.length;
  const totalQty = scannedItems.reduce((sum, item) => sum + item.quantity, 0);
  
  document.getElementById('itemCount').textContent = itemCount;
  document.getElementById('totalQty').textContent = totalQty;
  document.getElementById('itemCountText').textContent = itemCount;
}

// Purchase Order Receiving
async function loadPurchaseOrders() {
  const { data } = await sb
    .from('parts_purchase_orders')
    .select('*, parts_suppliers(supplier_name)')
    .eq('tenant_id', tenantId)
    .in('status', ['pending', 'ordered', 'partial'])
    .order('created_at', { ascending: false });
  
  purchaseOrders = data || [];
  renderPOList();
}

function renderPOList() {
  const container = document.getElementById('poList');
  
  if (!purchaseOrders.length) {
    container.innerHTML = '<div class="empty">No pending purchase orders</div>';
    return;
  }
  
  container.innerHTML = purchaseOrders.map(po => `
    <div class="po-card ${selectedPO?.po_id === po.po_id ? 'selected' : ''}" onclick="selectPO('${po.po_id}')">
      <div class="po-header">
        <div class="po-number">${po.po_number}</div>
        <div class="po-status status-${po.status}">${po.status.toUpperCase()}</div>
      </div>
      <div class="po-info">
        ${po.parts_suppliers?.supplier_name || 'Unknown Supplier'} • 
        ${new Date(po.order_date).toLocaleDateString()} • 
        $${po.total_amount.toFixed(2)}
      </div>
    </div>
  `).join('');
}

async function selectPO(poId) {
  const po = purchaseOrders.find(p => p.po_id === poId);
  if (!po) return;
  
  selectedPO = po;
  renderPOList();
  
  // Load PO items
  const { data: lines } = await sb
    .from('parts_purchase_order_lines')
    .select('*, parts_inventory(part_number, part_name, quantity_on_hand)')
    .eq('po_id', poId)
    .order('line_number');
  
  selectedPO.lines = lines || [];
  
  // Initialize receive state
  poItemsReceiveState = {};
  lines.forEach(line => {
    const remaining = line.quantity_ordered - (line.quantity_received || 0);
    poItemsReceiveState[line.line_id] = {
      toReceive: remaining,
      received: false
    };
  });
  
  renderPOItems();
  document.getElementById('poItemsSection').style.display = 'block';
  updateReceiveButton();
}

function renderPOItems() {
  const container = document.getElementById('poItems');
  
  if (!selectedPO || !selectedPO.lines.length) {
    container.innerHTML = '<div class="empty">No items in this PO</div>';
    return;
  }
  
  container.innerHTML = selectedPO.lines.map(line => {
    const remaining = line.quantity_ordered - (line.quantity_received || 0);
    const state = poItemsReceiveState[line.line_id] || { toReceive: remaining, received: false };
    
    return `
    <div class="po-item">
      <div class="item-info">
        <div class="item-number">${line.parts_inventory?.part_number || 'Unknown'}</div>
        <div class="item-name">${line.parts_inventory?.part_name || 'Unknown Part'}</div>
      </div>
      <div class="item-detail">
        <div class="detail-label">Ordered / Received</div>
        <div class="detail-value">${line.quantity_ordered} / ${line.quantity_received || 0}</div>
      </div>
      <div class="receive-input">
        <input 
          type="number" 
          class="qty-input" 
          value="${state.toReceive}" 
          min="0"
          max="${remaining}"
          onchange="updatePOItemQty('${line.line_id}', this.value)"
        >
        <button 
          class="check-btn ${state.received ? 'checked' : 'unchecked'}" 
          onclick="togglePOItem('${line.line_id}')"
        >
          ${state.received ? '✓' : '○'}
        </button>
      </div>
    </div>
  `;}).join('');
}

function updatePOItemQty(lineId, qty) {
  const line = selectedPO.lines.find(l => l.line_id === lineId);
  const remaining = line.quantity_ordered - (line.quantity_received || 0);
  
  poItemsReceiveState[lineId].toReceive = Math.min(Math.max(0, parseInt(qty) || 0), remaining);
  renderPOItems();
}

function togglePOItem(lineId) {
  const state = poItemsReceiveState[lineId];
  state.received = !state.received;
  
  // If unchecking, reset quantity
  if (!state.received) {
    const line = selectedPO.lines.find(l => l.line_id === lineId);
    const remaining = line.quantity_ordered - (line.quantity_received || 0);
    state.toReceive = remaining;
  }
  
  renderPOItems();
  updateReceiveButton();
}

function updateReceiveButton() {
  const btn = document.getElementById('receiveAllBtn');
  
  if (currentTab === 'barcode') {
    btn.disabled = scannedItems.length === 0;
    btn.textContent = 'Receive All Items';
  } else {
    const hasChecked = Object.values(poItemsReceiveState).some(s => s.received);
    btn.disabled = !hasChecked;
    btn.textContent = 'Receive Checked Items';
  }
}

async function receiveAll() {
  if (currentTab === 'barcode') {
    await receiveBarcodeItems();
  } else {
    await receivePOItems();
  }
}

async function receiveBarcodeItems() {
  if (scannedItems.length === 0) return;
  
  if (!confirm(`Receive ${scannedItems.length} items (${scannedItems.reduce((s,i) => s + i.quantity, 0)} total quantity)?`)) {
    return;
  }
  
  document.getElementById('receiveAllBtn').disabled = true;
  document.getElementById('receiveAllBtn').textContent = 'Receiving...';
  
  try {
    for (const item of scannedItems) {
      if (item.part_id) {
        const { data: current } = await sb
          .from('parts_inventory')
          .select('quantity_on_hand, quantity_available')
          .eq('part_id', item.part_id)
          .single();
        
        if (current) {
          await sb
            .from('parts_inventory')
            .update({
              quantity_on_hand: current.quantity_on_hand + item.quantity,
              quantity_available: current.quantity_available + item.quantity
            })
            .eq('part_id', item.part_id);
          
          await sb
            .from('parts_transactions')
            .insert({
              tenant_id: tenantId,
              part_id: item.part_id,
              transaction_type: 'Receipt',
              quantity_change: item.quantity,
              quantity_before: current.quantity_on_hand,
              quantity_after: current.quantity_on_hand + item.quantity,
              reference_type: 'Barcode Scan',
              notes: 'Mobile receiving - Barcode: ' + item.barcode
            });
        }
      }
    }
    
    showToast('✓ All items received successfully!');
    scannedItems = [];
    renderBarcodeItems();
    updateBarcodeStats();
    
    setTimeout(() => {
      if (confirm('Items received! Return to Parts Dashboard?')) {
        window.location.href = 'parts-dashboard-final.html';
      }
    }, 1500);
    
  } catch (error) {
    console.error('Receive error:', error);
    showToast('Error receiving items: ' + error.message);
  } finally {
    document.getElementById('receiveAllBtn').disabled = false;
    document.getElementById('receiveAllBtn').textContent = 'Receive All Items';
  }
}

async function receivePOItems() {
  const itemsToReceive = Object.entries(poItemsReceiveState)
    .filter(([lineId, state]) => state.received && state.toReceive > 0);
  
  if (!itemsToReceive.length) {
    alert('Please check items to receive');
    return;
  }
  
  if (!confirm(`Receive ${itemsToReceive.length} items from PO ${selectedPO.po_number}?`)) {
    return;
  }
  
  document.getElementById('receiveAllBtn').disabled = true;
  document.getElementById('receiveAllBtn').textContent = 'Receiving...';
  
  try {
    for (const [lineId, state] of itemsToReceive) {
      const line = selectedPO.lines.find(l => l.line_id === lineId);
      
      // Update PO line
      await sb
        .from('parts_purchase_order_lines')
        .update({
          quantity_received: (line.quantity_received || 0) + state.toReceive,
          received_date: new Date().toISOString().split('T')[0]
        })
        .eq('line_id', lineId);
      
      // Update inventory
      const { data: current } = await sb
        .from('parts_inventory')
        .select('quantity_on_hand, quantity_available, quantity_on_order')
        .eq('part_id', line.part_id)
        .single();
      
      if (current) {
        await sb
          .from('parts_inventory')
          .update({
            quantity_on_hand: current.quantity_on_hand + state.toReceive,
            quantity_available: current.quantity_available + state.toReceive,
            quantity_on_order: Math.max(0, current.quantity_on_order - state.toReceive)
          })
          .eq('part_id', line.part_id);
        
        // Log transaction
        await sb
          .from('parts_transactions')
          .insert({
            tenant_id: tenantId,
            part_id: line.part_id,
            transaction_type: 'Receipt',
            quantity_change: state.toReceive,
            quantity_before: current.quantity_on_hand,
            quantity_after: current.quantity_on_hand + state.toReceive,
            reference_type: 'Purchase Order',
            reference_id: selectedPO.po_id,
            notes: `Received against PO ${selectedPO.po_number}`
          });
      }
    }
    
    // Update PO status
    const allReceived = selectedPO.lines.every(line => 
      (line.quantity_received || 0) + (poItemsReceiveState[line.line_id]?.toReceive || 0) >= line.quantity_ordered
    );
    
    const newStatus = allReceived ? 'complete' : 'partial';
    
    await sb
      .from('parts_purchase_orders')
      .update({ status: newStatus })
      .eq('po_id', selectedPO.po_id);
    
    showToast(`✓ Received ${itemsToReceive.length} items from PO`);
    
    // Reload POs
    await loadPurchaseOrders();
    selectedPO = null;
    document.getElementById('poItemsSection').style.display = 'none';
    
    setTimeout(() => {
      if (confirm('Items received! Return to Parts Dashboard?')) {
        window.location.href = 'parts-dashboard-final.html';
      }
    }, 1500);
    
  } catch (error) {
    console.error('Receive error:', error);
    showToast('Error receiving items: ' + error.message);
  } finally {
    document.getElementById('receiveAllBtn').disabled = false;
    document.getElementById('receiveAllBtn').textContent = 'Receive Checked Items';
  }
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

window.addEventListener('beforeunload', (e) => {
  if (scannedItems.length > 0 || (selectedPO && Object.values(poItemsReceiveState).some(s => s.received))) {
    e.preventDefault();
    e.returnValue = '';
  }
});

init();
</script>

</body>
</html>
