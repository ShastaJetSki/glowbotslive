<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .invoice-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .actions {
      max-width: 800px;
      margin: 20px auto;
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #3b82f6;
      color: white;
    }
    .btn-secondary {
      background: #64748b;
    }
    
    /* Invoice Header */
    .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #3b82f6;
    }
    .company-info h1 {
      color: #1e293b;
      font-size: 28px;
      margin-bottom: 8px;
    }
    .company-info p {
      color: #64748b;
      font-size: 14px;
      line-height: 1.6;
    }
    .invoice-meta {
      text-align: right;
    }
    .invoice-number {
      font-size: 24px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 8px;
    }
    .invoice-date {
      color: #64748b;
      font-size: 14px;
    }
    .invoice-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 8px;
    }
    .status-paid {
      background: #dcfce7;
      color: #166534;
    }
    
    /* Customer Info */
    .customer-section {
      margin-bottom: 40px;
    }
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .customer-name {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 4px;
    }
    .customer-details {
      color: #64748b;
      font-size: 14px;
    }
    
    /* Items Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    thead {
      background: #f1f5f9;
    }
    th {
      text-align: left;
      padding: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      border-bottom: 2px solid #e2e8f0;
    }
    th:last-child {
      text-align: right;
    }
    td {
      padding: 12px;
      color: #1e293b;
      border-bottom: 1px solid #e2e8f0;
    }
    td:last-child {
      text-align: right;
      font-weight: 600;
    }
    .part-number {
      font-weight: 600;
      color: #3b82f6;
    }
    .part-name {
      color: #64748b;
      font-size: 14px;
    }
    
    /* Totals */
    .totals {
      margin-left: auto;
      width: 300px;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      font-size: 14px;
    }
    .total-label {
      color: #64748b;
    }
    .total-value {
      font-weight: 600;
      color: #1e293b;
    }
    .total-final {
      border-top: 2px solid #e2e8f0;
      margin-top: 8px;
      padding-top: 12px;
      font-size: 18px;
    }
    .total-final .total-value {
      color: #3b82f6;
      font-size: 24px;
    }
    
    /* Footer */
    .invoice-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e2e8f0;
      text-align: center;
      color: #94a3b8;
      font-size: 12px;
    }
    .payment-method {
      margin-top: 20px;
      padding: 12px;
      background: #f1f5f9;
      border-radius: 6px;
      font-size: 14px;
      color: #475569;
    }
    
    /* Print Styles */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      .actions {
        display: none;
      }
      .invoice-container {
        box-shadow: none;
        padding: 20px;
      }
    }
  </style>
</head>
<body>

<div class="actions">
  <button class="btn" onclick="window.print()">Print Invoice</button>
  <button class="btn btn-secondary" onclick="emailInvoice()">Email to Customer</button>
  <button class="btn btn-secondary" onclick="window.close()">Close</button>
</div>

<div class="invoice-container">
  
  <!-- Header -->
  <div class="invoice-header">
    <div class="company-info">
      <h1>Your Company Name</h1>
      <p>
        123 Main Street<br>
        Sacramento, CA 95814<br>
        Phone: (555) 123-4567<br>
        Email: parts@yourcompany.com
      </p>
    </div>
    <div class="invoice-meta">
      <div class="invoice-number" id="invoiceNumber">INV-000000</div>
      <div class="invoice-date" id="invoiceDate">Date: 12/30/2024</div>
      <div class="invoice-status status-paid" id="invoiceStatus">PAID</div>
    </div>
  </div>
  
  <!-- Customer -->
  <div class="customer-section">
    <div class="section-title">Bill To</div>
    <div class="customer-name" id="customerName">Customer Name</div>
    <div class="customer-details" id="customerDetails"></div>
  </div>
  
  <!-- Items -->
  <table>
    <thead>
      <tr>
        <th>Part #</th>
        <th>Description</th>
        <th style="text-align: center;">Qty</th>
        <th style="text-align: right;">Unit Price</th>
        <th style="text-align: right;">Total</th>
      </tr>
    </thead>
    <tbody id="invoiceItems"></tbody>
  </table>
  
  <!-- Totals -->
  <div class="totals">
    <div class="total-row">
      <span class="total-label">Subtotal:</span>
      <span class="total-value" id="subtotal">$0.00</span>
    </div>
    <div class="total-row">
      <span class="total-label">Tax (<span id="taxRate">8</span>%):</span>
      <span class="total-value" id="tax">$0.00</span>
    </div>
    <div class="total-row total-final">
      <span class="total-label">Total:</span>
      <span class="total-value" id="total">$0.00</span>
    </div>
  </div>
  
  <!-- Payment Info -->
  <div class="payment-method" id="paymentMethod"></div>
  
  <!-- Notes -->
  <div id="notesSection" style="display: none; margin-top: 20px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b;">
    <div style="font-weight: 600; font-size: 12px; text-transform: uppercase; color: #92400e; margin-bottom: 4px;">Notes</div>
    <div id="notes" style="color: #78350f; font-size: 14px;"></div>
  </div>
  
  <!-- Footer -->
  <div class="invoice-footer">
    Thank you for your business!<br>
    For questions about this invoice, please contact us at (555) 123-4567
  </div>

</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let tenantId = '11111111-1111-1111-1111-111111111111';
let invoice = null;

async function init() {
  const urlParams = new URLSearchParams(window.location.search);
  const invoiceId = urlParams.get('id');
  
  if (!invoiceId) {
    alert('No invoice ID provided');
    return;
  }
  
  await loadInvoice(invoiceId);
}

async function loadInvoice(invoiceId) {
  // Load invoice
  const { data: inv, error: invError } = await sb
    .from('parts_invoices')
    .select('*')
    .eq('invoice_id', invoiceId)
    .single();
  
  if (invError || !inv) {
    alert('Invoice not found');
    return;
  }
  
  invoice = inv;
  
  // Load invoice lines
  const { data: lines } = await sb
    .from('parts_invoice_lines')
    .select('*, parts_inventory(part_number, part_name)')
    .eq('invoice_id', invoiceId)
    .order('line_number');
  
  invoice.lines = lines || [];
  
  renderInvoice();
}

function renderInvoice() {
  // Header
  document.getElementById('invoiceNumber').textContent = invoice.invoice_number;
  document.getElementById('invoiceDate').textContent = 'Date: ' + new Date(invoice.created_at).toLocaleDateString();
  document.getElementById('invoiceStatus').textContent = invoice.status.toUpperCase();
  
  // Customer
  document.getElementById('customerName').textContent = invoice.customer_name;
  
  let customerDetails = '';
  if (invoice.customer_phone) customerDetails += invoice.customer_phone + '<br>';
  if (invoice.customer_email) customerDetails += invoice.customer_email;
  document.getElementById('customerDetails').innerHTML = customerDetails;
  
  // Items
  document.getElementById('invoiceItems').innerHTML = invoice.lines.map(line => `
    <tr>
      <td class="part-number">${line.parts_inventory?.part_number || 'N/A'}</td>
      <td>
        <div class="part-name">${line.parts_inventory?.part_name || 'Unknown Part'}</div>
      </td>
      <td style="text-align: center;">${line.quantity}</td>
      <td style="text-align: right;">$${line.unit_price.toFixed(2)}</td>
      <td>$${line.line_total.toFixed(2)}</td>
    </tr>
  `).join('');
  
  // Totals
  document.getElementById('subtotal').textContent = '$' + invoice.subtotal.toFixed(2);
  document.getElementById('taxRate').textContent = (invoice.tax_rate * 100).toFixed(0);
  document.getElementById('tax').textContent = '$' + invoice.tax_amount.toFixed(2);
  document.getElementById('total').textContent = '$' + invoice.total_amount.toFixed(2);
  
  // Payment
  const paymentLabels = {
    cash: 'Cash',
    card: 'Credit/Debit Card',
    check: 'Check',
    account: 'Account'
  };
  document.getElementById('paymentMethod').innerHTML = `
    <strong>Payment Method:</strong> ${paymentLabels[invoice.payment_method] || invoice.payment_method}
  `;
  
  // Notes
  if (invoice.notes) {
    document.getElementById('notesSection').style.display = 'block';
    document.getElementById('notes').textContent = invoice.notes;
  }
  
  // Update page title
  document.title = invoice.invoice_number + ' - Invoice';
}

function emailInvoice() {
  if (!invoice.customer_email) {
    alert('No email address on file for this customer');
    return;
  }
  
  // Simulate email (would need backend)
  alert(`Invoice ${invoice.invoice_number} would be emailed to ${invoice.customer_email}\n\nNote: Email integration requires backend setup.`);
}

init();
</script>

</body>
</html>
