<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Management - Settings</title>
  <meta name="supabase-url" content="https://kxqkwpkmtgvmthpafoqx.supabase.co">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0ODE0MzIsImV4cCI6MjA0ODA1NzQzMn0.sG_vertrcVEw7NwfQRx9DUt5k2s3DkU2sKtLVyNjvk0">
  
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { 
      font-family:system-ui,-apple-system,sans-serif;
      background:#0b0f14;
      color:#e8eef6;
      min-height:100vh;
    }

    /* Scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #223044 #0f1621;
    }

    *::-webkit-scrollbar { width: 10px; }
    *::-webkit-scrollbar-track { background: #0f1621; }
    *::-webkit-scrollbar-thumb { background: #223044; border-radius: 5px; }

    .header {
      background:#0f1621;
      border-bottom:1px solid #223044;
      padding:20px 24px;
      position:sticky;
      top:0;
      z-index:100;
    }

    .header-content {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .header-title {
      font-size:24px;
      font-weight:700;
    }

    .back-link {
      color:#3b82f6;
      text-decoration:none;
      font-size:14px;
      font-weight:600;
    }

    .container {
      max-width:1200px;
      margin:0 auto;
      padding:40px 24px;
    }

    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
    }

    .section-title {
      font-size:20px;
      font-weight:700;
      color:#e8eef6;
    }

    .btn-primary {
      background:#3b82f6;
      border:1px solid #3b82f6;
      color:#fff;
      padding:10px 20px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.15s;
    }

    .btn-primary:hover {
      background:#2563eb;
    }

    .fleet-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
      gap:20px;
      margin-bottom:40px;
    }

    .fleet-card {
      background:#0f1621;
      border:2px solid #223044;
      border-left:4px solid;
      border-radius:12px;
      padding:20px;
      transition:all 0.15s;
    }

    .fleet-card:hover {
      border-color:#3b82f6;
      transform:translateY(-2px);
    }

    .fleet-card-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:12px;
    }

    .fleet-icon {
      font-size:32px;
      margin-bottom:8px;
    }

    .fleet-name {
      font-size:18px;
      font-weight:700;
      color:#e8eef6;
      margin-bottom:4px;
    }

    .fleet-description {
      font-size:13px;
      color:#9fb0c3;
      margin-bottom:12px;
      line-height:1.4;
    }

    .fleet-stats {
      display:flex;
      gap:16px;
      margin-bottom:12px;
      padding-top:12px;
      border-top:1px solid #223044;
    }

    .fleet-stat {
      font-size:12px;
      color:#9fb0c3;
    }

    .fleet-stat-value {
      font-size:16px;
      font-weight:700;
      color:#3b82f6;
    }

    .fleet-actions {
      display:flex;
      gap:8px;
    }

    .btn-icon {
      background:transparent;
      border:1px solid #223044;
      color:#9fb0c3;
      padding:8px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      transition:all 0.15s;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .btn-icon:hover {
      border-color:#3b82f6;
      color:#3b82f6;
    }

    .btn-icon.danger:hover {
      border-color:#ef4444;
      color:#ef4444;
    }

    /* Modal Styles */
    .modal {
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.85);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .modal.active {
      display:flex;
    }

    .modal-content {
      background:#0f1621;
      border:2px solid #3b82f6;
      border-radius:12px;
      padding:32px;
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
    }

    .modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
      padding-bottom:16px;
      border-bottom:2px solid #223044;
    }

    .modal-title {
      font-size:20px;
      font-weight:700;
    }

    .modal-close {
      background:transparent;
      border:none;
      color:#9fb0c3;
      font-size:24px;
      cursor:pointer;
      padding:0;
      width:32px;
      height:32px;
    }

    .form-group {
      margin-bottom:20px;
    }

    .form-label {
      display:block;
      font-size:13px;
      font-weight:600;
      color:#9fb0c3;
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .form-input {
      width:100%;
      padding:12px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      color:#e8eef6;
      font-size:14px;
    }

    .form-input:focus {
      outline:none;
      border-color:#3b82f6;
    }

    textarea.form-input {
      min-height:80px;
      resize:vertical;
    }

    .color-picker-group {
      display:flex;
      gap:12px;
      align-items:center;
    }

    .color-preview {
      width:48px;
      height:48px;
      border-radius:8px;
      border:2px solid #223044;
    }

    input[type="color"] {
      width:48px;
      height:48px;
      border:none;
      border-radius:8px;
      cursor:pointer;
    }

    .icon-picker {
      display:grid;
      grid-template-columns:repeat(8, 1fr);
      gap:8px;
      margin-top:8px;
    }

    .icon-option {
      font-size:24px;
      padding:8px;
      background:#1a2535;
      border:2px solid #223044;
      border-radius:8px;
      cursor:pointer;
      text-align:center;
      transition:all 0.15s;
    }

    .icon-option:hover,
    .icon-option.selected {
      border-color:#3b82f6;
      background:#243648;
    }

    .modal-actions {
      display:flex;
      gap:12px;
      margin-top:24px;
    }

    .btn-secondary {
      flex:1;
      background:transparent;
      border:1px solid #223044;
      color:#9fb0c3;
      padding:12px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }

    .btn-secondary:hover {
      border-color:#3b82f6;
      color:#3b82f6;
    }

    .btn-primary-full {
      flex:1;
      background:#3b82f6;
      border:1px solid #3b82f6;
      color:#fff;
      padding:12px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }

    .btn-primary-full:hover {
      background:#2563eb;
    }

    .vehicle-assignment-section {
      margin-top:24px;
      padding-top:24px;
      border-top:2px solid #223044;
    }

    .vehicle-list {
      max-height:300px;
      overflow-y:auto;
      border:1px solid #223044;
      border-radius:8px;
      padding:8px;
      background:#1a2535;
    }

    .vehicle-item {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px;
      border-radius:6px;
      margin-bottom:4px;
    }

    .vehicle-item:hover {
      background:#243648;
    }

    .vehicle-item input[type="checkbox"] {
      width:18px;
      height:18px;
      cursor:pointer;
    }

    .vehicle-item-info {
      flex:1;
      font-size:14px;
      color:#e8eef6;
    }

    .empty-state {
      text-align:center;
      padding:40px;
      color:#6b7280;
      font-size:14px;
    }

    @media (max-width: 768px) {
      .fleet-grid {
        grid-template-columns:1fr;
      }

      .container {
        padding:20px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-title">Fleet Management</div>
      <a href="dashboard-scheduling-new.html" class="back-link">‚Üê Back to Dashboard</a>
    </div>
  </div>

  <div class="container">
    <div class="section-header">
      <div class="section-title">Your Fleets</div>
      <button class="btn-primary" onclick="openCreateModal()">+ Create Fleet</button>
    </div>

    <div class="fleet-grid" id="fleetGrid">
      <div class="empty-state">Loading fleets...</div>
    </div>
  </div>

  <!-- Create/Edit Fleet Modal -->
  <div class="modal" id="fleetModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Create Fleet</div>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>

      <form id="fleetForm" onsubmit="saveFleet(event)">
        <div class="form-group">
          <label class="form-label">Fleet Name *</label>
          <input type="text" class="form-input" id="fleetName" required placeholder="e.g., Main Fleet">
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-input" id="fleetDescription" placeholder="Optional description"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Color</label>
          <div class="color-picker-group">
            <input type="color" id="fleetColor" value="#3b82f6">
            <div class="color-preview" id="colorPreview" style="background:#3b82f6;"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Icon</label>
          <div class="icon-picker" id="iconPicker">
            <!-- Icons will be populated by JS -->
          </div>
        </div>

        <div class="vehicle-assignment-section" id="vehicleSection">
          <label class="form-label">Assign Vehicles</label>
          <div class="vehicle-list" id="vehicleList">
            <!-- Vehicles will be populated by JS -->
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn-primary-full">Save Fleet</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const REST_BASE = document.querySelector('meta[name="supabase-url"]').content + "/rest/v1";
    const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

    let fleets = [];
    let vehicles = [];
    let currentFleetId = null;
    let selectedIcon = 'üöó';

    const FLEET_ICONS = ['üöó', 'üöô', 'üöï', 'üöö', 'üöõ', 'üöê', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöå', 'üöú', 'üèóÔ∏è', '‚öôÔ∏è', 'üîß', 'üõ†Ô∏è'];

    async function validateAuth() {
      const token = localStorage.getItem("sb_access_token");
      if (!token) return null;

      try {
        const response = await fetch(`${REST_BASE.replace('/rest/v1', '')}/auth/v1/user`, {
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          localStorage.removeItem("sb_access_token");
          return null;
        }

        return token;
      } catch (error) {
        console.error("Auth validation error:", error);
        return null;
      }
    }

    async function loadData() {
      const token = await validateAuth();
      if (!token) {
        location.href = 'login.html';
        return;
      }

      try {
        // Load fleets
        const fleetsRes = await fetch(`${REST_BASE}/fleets?select=*&order=fleet_name`, {
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        fleets = await fleetsRes.json();

        // Load vehicles
        const vehiclesRes = await fetch(`${REST_BASE}/vehicles?select=*&order=year.desc,make,model`, {
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        vehicles = await vehiclesRes.json();

        // Load fleet assignments
        const assignmentsRes = await fetch(`${REST_BASE}/vehicle_fleet_assignments?select=*`, {
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        const assignments = await assignmentsRes.json();

        // Add vehicle counts to fleets
        fleets.forEach(fleet => {
          fleet.vehicle_count = assignments.filter(a => a.fleet_id === fleet.fleet_id).length;
        });

        renderFleets();
        renderIconPicker();

      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function renderFleets() {
      const grid = document.getElementById('fleetGrid');
      
      if (fleets.length === 0) {
        grid.innerHTML = '<div class="empty-state">No fleets yet. Create your first fleet!</div>';
        return;
      }

      grid.innerHTML = fleets.map(fleet => `
        <div class="fleet-card" style="border-left-color: ${fleet.color};">
          <div class="fleet-card-header">
            <div>
              <div class="fleet-icon">${fleet.icon}</div>
              <div class="fleet-name">${fleet.fleet_name}</div>
            </div>
          </div>
          ${fleet.description ? `<div class="fleet-description">${fleet.description}</div>` : ''}
          <div class="fleet-stats">
            <div class="fleet-stat">
              <div class="fleet-stat-value">${fleet.vehicle_count || 0}</div>
              <div>Vehicles</div>
            </div>
          </div>
          <div class="fleet-actions">
            <button class="btn-icon" onclick="editFleet('${fleet.fleet_id}')" title="Edit">‚úèÔ∏è</button>
            <button class="btn-icon" onclick="manageVehicles('${fleet.fleet_id}')" title="Manage Vehicles">üöó</button>
            <button class="btn-icon danger" onclick="deleteFleet('${fleet.fleet_id}')" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function renderIconPicker() {
      const picker = document.getElementById('iconPicker');
      picker.innerHTML = FLEET_ICONS.map(icon => `
        <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">
          ${icon}
        </div>
      `).join('');
    }

    function selectIcon(icon) {
      selectedIcon = icon;
      document.querySelectorAll('.icon-option').forEach(el => {
        el.classList.toggle('selected', el.textContent.trim() === icon);
      });
    }

    function openCreateModal() {
      currentFleetId = null;
      document.getElementById('modalTitle').textContent = 'Create Fleet';
      document.getElementById('fleetForm').reset();
      document.getElementById('fleetColor').value = '#3b82f6';
      document.getElementById('colorPreview').style.background = '#3b82f6';
      selectedIcon = 'üöó';
      renderIconPicker();
      renderVehicleList();
      document.getElementById('fleetModal').classList.add('active');
    }

    function editFleet(fleetId) {
      currentFleetId = fleetId;
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      
      document.getElementById('modalTitle').textContent = 'Edit Fleet';
      document.getElementById('fleetName').value = fleet.fleet_name;
      document.getElementById('fleetDescription').value = fleet.description || '';
      document.getElementById('fleetColor').value = fleet.color;
      document.getElementById('colorPreview').style.background = fleet.color;
      selectedIcon = fleet.icon;
      renderIconPicker();
      renderVehicleList(fleetId);
      document.getElementById('fleetModal').classList.add('active');
    }

    async function renderVehicleList(fleetId = null) {
      const token = localStorage.getItem('sb_access_token');
      let assignments = [];
      
      if (fleetId) {
        const res = await fetch(`${REST_BASE}/vehicle_fleet_assignments?fleet_id=eq.${fleetId}`, {
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        assignments = await res.json();
      }

      const vehicleList = document.getElementById('vehicleList');
      vehicleList.innerHTML = vehicles.map(v => {
        const isAssigned = assignments.some(a => a.vehicle_id === v.vehicle_id);
        return `
          <div class="vehicle-item">
            <input type="checkbox" 
              value="${v.vehicle_id}" 
              ${isAssigned ? 'checked' : ''}
              id="vehicle_${v.vehicle_id}">
            <label for="vehicle_${v.vehicle_id}" class="vehicle-item-info">
              ${v.year} ${v.make} ${v.model}
            </label>
          </div>
        `;
      }).join('');
    }

    async function saveFleet(event) {
      event.preventDefault();
      const token = localStorage.getItem('sb_access_token');

      const fleetData = {
        fleet_name: document.getElementById('fleetName').value,
        description: document.getElementById('fleetDescription').value,
        color: document.getElementById('fleetColor').value,
        icon: selectedIcon,
        is_active: true
      };

      try {
        let fleetId;

        if (currentFleetId) {
          // Update existing fleet
          await fetch(`${REST_BASE}/fleets?fleet_id=eq.${currentFleetId}`, {
            method: 'PATCH',
            headers: {
              'apikey': ANON_KEY,
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(fleetData)
          });
          fleetId = currentFleetId;
        } else {
          // Create new fleet
          const res = await fetch(`${REST_BASE}/fleets`, {
            method: 'POST',
            headers: {
              'apikey': ANON_KEY,
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(fleetData)
          });
          const newFleet = await res.json();
          fleetId = newFleet[0].fleet_id;
        }

        // Update vehicle assignments
        await updateVehicleAssignments(fleetId, token);

        closeModal();
        loadData();

      } catch (error) {
        console.error('Error saving fleet:', error);
        alert('Error saving fleet: ' + error.message);
      }
    }

    async function updateVehicleAssignments(fleetId, token) {
      // Get current assignments
      const currentRes = await fetch(`${REST_BASE}/vehicle_fleet_assignments?fleet_id=eq.${fleetId}`, {
        headers: {
          'apikey': ANON_KEY,
          'Authorization': `Bearer ${token}`
        }
      });
      const currentAssignments = await currentRes.json();

      // Get selected vehicles
      const selectedVehicles = Array.from(document.querySelectorAll('#vehicleList input:checked'))
        .map(input => input.value);

      // Remove unselected assignments
      for (const assignment of currentAssignments) {
        if (!selectedVehicles.includes(assignment.vehicle_id)) {
          await fetch(`${REST_BASE}/vehicle_fleet_assignments?assignment_id=eq.${assignment.assignment_id}`, {
            method: 'DELETE',
            headers: {
              'apikey': ANON_KEY,
              'Authorization': `Bearer ${token}`
            }
          });
        }
      }

      // Add new assignments
      const currentVehicleIds = currentAssignments.map(a => a.vehicle_id);
      for (const vehicleId of selectedVehicles) {
        if (!currentVehicleIds.includes(vehicleId)) {
          await fetch(`${REST_BASE}/vehicle_fleet_assignments`, {
            method: 'POST',
            headers: {
              'apikey': ANON_KEY,
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              vehicle_id: vehicleId,
              fleet_id: fleetId
            })
          });
        }
      }
    }

    async function deleteFleet(fleetId) {
      if (!confirm('Are you sure you want to delete this fleet? Vehicle assignments will be removed.')) {
        return;
      }

      const token = localStorage.getItem('sb_access_token');

      try {
        await fetch(`${REST_BASE}/fleets?fleet_id=eq.${fleetId}`, {
          method: 'DELETE',
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });

        loadData();
      } catch (error) {
        console.error('Error deleting fleet:', error);
        alert('Error deleting fleet');
      }
    }

    function manageVehicles(fleetId) {
      editFleet(fleetId);
    }

    function closeModal() {
      document.getElementById('fleetModal').classList.remove('active');
    }

    // Color picker preview update
    document.addEventListener('DOMContentLoaded', () => {
      const colorInput = document.getElementById('fleetColor');
      const colorPreview = document.getElementById('colorPreview');
      
      if (colorInput) {
        colorInput.addEventListener('input', (e) => {
          colorPreview.style.background = e.target.value;
        });
      }

      loadData();
    });

    // Close modal on background click
    document.getElementById('fleetModal').addEventListener('click', (e) => {
      if (e.target.id === 'fleetModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
