<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Management</title>
  <meta name="supabase-url" content="https://kxqkwpkmtgvmthpafoqx.supabase.co">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0ODE0MzIsImV4cCI6MjA0ODA1NzQzMn0.sG_vertrcVEw7NwfQRx9DUt5k2s3DkU2sKtLVyNjvk0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family:system-ui,-apple-system,sans-serif; 
      background:#0b0f14; 
      color:#e8eef6;
      min-height:100vh;
    }
    
    /* Scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #223044 #0f1621;
    }
    *::-webkit-scrollbar { width:10px; height:10px; }
    *::-webkit-scrollbar-track { background:#0f1621; }
    *::-webkit-scrollbar-thumb { background:#223044; border-radius:5px; }
    *::-webkit-scrollbar-thumb:hover { background:#2d3f56; }
    
    /* Mobile Header */
    .mobile-header {
      display:none;
      background:#0f1621;
      border-bottom:1px solid #223044;
      position:sticky;
      top:0;
      z-index:100;
    }

    .mobile-header-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
    }

    .mobile-menu-toggle {
      background:transparent;
      border:1px solid transparent;
      border-radius:6px;
      color:#6b7280;
      font-size:20px;
      padding:0;
      width:36px;
      height:36px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }

    .mobile-menu-toggle:hover {
      background:rgba(59,130,246,0.1);
      border-color:#3b82f6;
      color:#3b82f6;
    }

    .mobile-header-center {
      flex:1;
      margin-left:12px;
    }

    .mobile-header-title {
      font-size:18px;
      font-weight:600;
    }

    .mobile-header-subtitle {
      font-size:12px;
      color:#9fb0c3;
      margin-top:2px;
    }

    .mobile-header-content {
      max-height:0;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }

    .mobile-header-content.open {
      max-height:500px;
    }

    .mobile-header-nav {
      padding:8px 12px;
      border-bottom:1px solid #223044;
    }

    .mobile-header-nav a {
      display:block;
      padding:12px;
      color:#9fb0c3;
      text-decoration:none;
      border-radius:6px;
      transition:all 0.15s ease;
      font-size:15px;
    }

    .mobile-header-nav a:hover {
      background:#1a2535;
      color:#e8eef6;
    }

    .mobile-header-nav a.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .mobile-header-actions {
      padding:12px;
      display:flex;
      gap:8px;
    }

    .mobile-header-actions button {
      flex:1;
      padding:10px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#9fb0c3;
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s ease;
    }

    .mobile-header-actions button:hover {
      background:#1e2a3d;
      color:#e8eef6;
    }

    /* Desktop Header */
    .desktop-header {
      display:block;
      background:#0f1621;
      border-bottom:1px solid #223044;
      padding:20px 40px;
      position:sticky;
      top:0;
      z-index:100;
    }

    .header-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .header-top h1 {
      font-size:24px;
      font-weight:600;
      color:#e8eef6;
    }

    .header-nav {
      display:flex;
      gap:8px;
      padding-bottom:12px;
    }

    .header-nav a {
      padding:8px 16px;
      border-radius:6px;
      color:#9fb0c3;
      text-decoration:none;
      font-size:14px;
      transition:all 0.15s ease;
    }

    .header-nav a:hover {
      background:#1a2535;
      color:#e8eef6;
    }

    .header-nav a.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .header-actions {
      display:flex;
      gap:16px;
      justify-content:space-between;
      align-items:center;
      padding-top:12px;
      border-top:1px solid #223044;
    }
    
    .view-tabs-header {
      display:flex;
      gap:4px;
      background:#0f1621;
      padding:4px;
      border-radius:8px;
      border:1px solid #223044;
    }
    
    .view-tab {
      padding:8px 16px;
      border-radius:6px;
      color:#9fb0c3;
      font-size:13px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-weight:500;
      user-select:none;
    }
    
    .view-tab:hover {
      background:#1a2535;
      color:#e8eef6;
    }
    
    .view-tab.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .header-actions button {
      padding:8px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#9fb0c3;
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-weight:500;
    }

    .header-actions button:hover {
      background:#1e2a3d;
      color:#e8eef6;
      border-color:#3b82f6;
    }
    
    .header-actions .fleet-btn-active {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }
    
    .header-actions .fleet-btn-active:hover {
      background:#2563eb;
      border-color:#2563eb;
    }
    
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    
    /* Fleet Selector Cards */
    .fleet-selector-cards {
      display:flex;
      gap:16px;
      margin-bottom:24px;
      overflow-x:auto;
      padding-bottom:8px;
    }
    
    .fleet-cards-grid {
      display:flex;
      gap:16px;
      flex:1;
    }
    
    .fleet-selector-card {
      background:#1a2535;
      border:2px solid #223044;
      border-radius:8px;
      padding:20px;
      min-width:280px;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
    }
    
    .fleet-selector-card::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:4px;
      height:100%;
      background:var(--fleet-color);
      opacity:0.5;
      transition:all 0.3s;
    }
    
    .fleet-selector-card:hover {
      border-color:#3b82f6;
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.4);
    }
    
    .fleet-selector-card:hover::before {
      width:8px;
      opacity:1;
    }
    
    .fleet-selector-card.active {
      border-color:var(--fleet-color);
      background:#1e2a3d;
      box-shadow:0 8px 20px rgba(59,130,246,0.3);
    }
    
    .fleet-selector-card.active::before {
      width:100%;
      opacity:0.08;
    }
    
    .fleet-card-top {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .fleet-card-icon {
      font-size:28px;
      width:48px;
      height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(59,130,246,0.1);
      border-radius:8px;
      border:1px solid rgba(59,130,246,0.2);
    }
    
    .fleet-selector-card.active .fleet-card-icon {
      background:var(--fleet-color);
      background:linear-gradient(135deg, var(--fleet-color) 0%, rgba(0,0,0,0.2) 100%);
      border-color:var(--fleet-color);
    }
    
    .fleet-card-title {
      flex:1;
    }
    
    .fleet-card-name {
      font-size:16px;
      font-weight:600;
      color:#e8eef6;
      margin-bottom:4px;
    }
    
    .fleet-card-subtitle {
      font-size:11px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .fleet-card-metrics {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid #223044;
    }
    
    .fleet-metric {
      text-align:left;
    }
    
    .fleet-metric-label {
      font-size:10px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px;
      font-weight:600;
    }
    
    .fleet-metric-value {
      font-size:18px;
      font-weight:700;
      color:#60a5fa;
      letter-spacing:-0.5px;
    }
    
    .fleet-selector-card.active .fleet-metric-value {
      color:var(--fleet-color);
    }
    
    .add-fleet-card {
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      padding:20px;
      min-width:140px;
      cursor:pointer;
      transition:all 0.3s;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:#9fb0c3;
    }
    
    .add-fleet-card:hover {
      background:#1e2a3d;
      border-color:#3b82f6;
      color:#e8eef6;
      transform:translateY(-4px);
    }
    
    .add-fleet-icon {
      font-size:32px;
      font-weight:300;
    }
    
    .add-fleet-text {
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    /* Fleet Overview */
    .fleet-overview {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:24px;
      padding-bottom:16px;
      border-bottom:1px solid #223044;
    }
    
    .fleet-meta {
      flex:1;
    }
    
    .fleet-description-text {
      color:#9fb0c3;
      font-size:14px;
      margin-bottom:8px;
    }
    
    .fleet-vehicle-count {
      color:#60a5fa;
      font-size:13px;
      font-weight:600;
    }
    
    .fleet-actions-top {
      display:flex;
      gap:8px;
    }
    
    .fleet-actions-top .fleet-btn {
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.2);
      color:#60a5fa;
      padding:10px 20px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      transition:all 0.2s;
    }
    
    .fleet-actions-top .fleet-btn:hover {
      background:rgba(59,130,246,0.15);
      border-color:rgba(59,130,246,0.4);
    }
    
    .fleet-actions-top .fleet-btn.delete {
      background:rgba(239,68,68,0.1);
      border-color:rgba(239,68,68,0.2);
      color:#ef4444;
    }
    
    .fleet-actions-top .fleet-btn.delete:hover {
      background:rgba(239,68,68,0.15);
      border-color:rgba(239,68,68,0.4);
    }
    
    /* Vehicle Stats Table */
    .vehicle-stats-table {
      margin-top:16px;
    }
    
    .vehicle-stats-table h4 {
      font-size:14px;
      font-weight:600;
      margin-bottom:12px;
      color:#9fb0c3;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .vehicle-table {
      width:100%;
      border-collapse:collapse;
    }
    
    .vehicle-table th {
      text-align:left;
      padding:12px;
      background:#0f1621;
      border-bottom:2px solid #223044;
      color:#6b7280;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      font-weight:600;
    }
    
    .vehicle-table td {
      padding:12px;
      border-bottom:1px solid #1a2535;
      color:#e8eef6;
      font-size:13px;
    }
    
    .vehicle-table tr:hover {
      background:#141824;
    }
    
    .vehicle-name {
      font-weight:600;
      color:#e8eef6;
    }
    
    .vehicle-cost {
      color:#fbbf24;
      font-weight:600;
    }
    
    .vehicle-charges {
      color:#60a5fa;
      font-weight:600;
    }
    
    .vehicle-tech {
      color:#9fb0c3;
    }
    
    .vehicle-completion {
      color:#60a5fa;
      font-weight:500;
    }
    
    .vehicle-days {
      color:#60a5fa;
    }
    
    .vehicle-status {
      font-size:11px;
      padding:4px 8px;
      border-radius:4px;
      font-weight:600;
      text-transform:uppercase;
    }
    
    .vehicle-status.active {
      background:#1e4d2b;
      color:#34d399;
    }
    
    .vehicle-status.in-shop {
      background:#4d3820;
      color:#fbbf24;
    }
    
    /* Collapsible Section */
    .section {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:8px;
      margin-bottom:16px;
      overflow:hidden;
    }
    
    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      cursor:pointer;
      user-select:none;
      transition:background 0.2s;
    }
    
    .section-header:hover {
      background:#141824;
    }
    
    .section-title {
      font-size:18px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .section-icon {
      font-size:22px;
    }
    
    .section-toggle {
      font-size:20px;
      color:#6b7280;
      transition:transform 0.3s;
    }
    
    .section.collapsed .section-toggle {
      transform:rotate(-90deg);
    }
    
    .section-content {
      max-height:5000px;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }
    
    .section.collapsed .section-content {
      max-height:0;
    }
    
    .section-body {
      padding:20px;
      border-top:1px solid #223044;
    }
    
    /* Metrics Grid */
    .metrics-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }
    
    .metric-card {
      background:#1a2535;
      padding:20px;
      border-radius:8px;
      border:1px solid #223044;
      border-left:3px solid #3b82f6;
      transition:all 0.2s;
    }
    
    .metric-card:hover {
      border-left-color:#60a5fa;
      background:#1e2a3d;
    }
    
    .metric-card.metric-editable {
      cursor:pointer;
    }
    
    .metric-card.metric-editable:hover {
      border-left-color:#fbbf24;
      background:#1e2a3d;
    }
    
    .edit-icon {
      color:#fbbf24;
      font-size:13px;
      margin-left:4px;
    }
    
    .metric-label {
      color:#6b7280;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      margin-bottom:10px;
      font-weight:600;
    }
    
    .metric-value {
      font-size:32px;
      font-weight:700;
      color:#e8eef6;
      margin-bottom:6px;
      letter-spacing:-0.5px;
    }
    
    .metric-change {
      font-size:11px;
      display:flex;
      align-items:center;
      gap:4px;
      font-weight:500;
    }
    
    .metric-change.up { color:#34d399; }
    .metric-change.down { color:#f87171; }
    
    /* Charts Grid */
    .charts-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
    }
    
    .chart-card {
      background:#141824;
      padding:20px;
      border-radius:8px;
      border:1px solid #1a2535;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    
    .chart-card h3 {
      font-size:13px;
      font-weight:600;
      margin-bottom:16px;
      color:#9fb0c3;
      display:flex;
      align-items:center;
      gap:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .chart-container {
      position:relative;
      height:240px;
    }
    
    /* Fleet Management */
    .create-fleet-btn {
      background:#3b82f6;
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      transition:all 0.2s;
    }
    
    .create-fleet-btn:hover {
      background:#2563eb;
    }
    
    .fleet-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:16px;
    }
    
    .fleet-card {
      background:#1a2535;
      border-radius:8px;
      padding:20px;
      border-left:4px solid #3b82f6;
      border:1px solid #223044;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fleet-card:hover {
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.4);
      border-left-width:4px;
    }
    
    .fleet-card-header {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .fleet-icon {
      font-size:28px;
    }
    
    .fleet-name {
      font-size:18px;
      font-weight:600;
      flex:1;
    }
    
    .fleet-description {
      color:#9fb0c3;
      font-size:13px;
      margin-bottom:12px;
      line-height:1.4;
    }
    
    .fleet-spend-metrics {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:12px;
      padding:12px;
      background:#0f1621;
      border-radius:6px;
      border:1px solid #223044;
    }
    
    .spend-metric {
      text-align:center;
    }
    
    .spend-label {
      color:#6b7280;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px;
      font-weight:600;
    }
    
    .spend-value {
      color:#34d399;
      font-size:20px;
      font-weight:700;
      letter-spacing:-0.5px;
    }
    
    .fleet-count {
      color:#60a5fa;
      font-size:13px;
      margin-bottom:12px;
    }
    
    .fleet-actions {
      display:flex;
      gap:8px;
      margin-top:4px;
    }
    
    .fleet-btn {
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.2);
      color:#60a5fa;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-size:12px;
      font-weight:500;
      transition:all 0.2s;
      flex:1;
      text-align:center;
    }
    
    .fleet-btn:hover {
      background:rgba(59,130,246,0.15);
      border-color:rgba(59,130,246,0.4);
      color:#3b82f6;
    }
    
    .fleet-btn.delete {
      background:rgba(239,68,68,0.1);
      border-color:rgba(239,68,68,0.2);
      color:#ef4444;
    }
    
    .fleet-btn.delete:hover {
      background:rgba(239,68,68,0.15);
      border-color:rgba(239,68,68,0.4);
      color:#dc2626;
    }
    
    /* Modal */
    .modal {
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.8);
      z-index:1000;
      overflow-y:auto;
    }
    
    .modal.active {
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    
    .modal-content {
      background:#0f1621;
      border-radius:12px;
      max-width:600px;
      width:100%;
      border:1px solid #223044;
    }
    
    .modal-header {
      padding:20px;
      border-bottom:1px solid #223044;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .modal-title {
      font-size:20px;
      font-weight:600;
    }
    
    .modal-close {
      background:transparent;
      border:none;
      color:#9fb0c3;
      font-size:24px;
      cursor:pointer;
      padding:0;
      width:32px;
      height:32px;
      border-radius:4px;
      transition:all 0.2s;
    }
    
    .modal-close:hover {
      background:#1a2535;
      color:#e8eef6;
    }
    
    .modal-body {
      padding:20px;
    }
    
    .form-group {
      margin-bottom:16px;
    }
    
    .form-label {
      display:block;
      color:#9fb0c3;
      font-size:13px;
      margin-bottom:6px;
      font-weight:600;
    }
    
    .form-input,
    .form-textarea {
      width:100%;
      background:#1a2535;
      border:1px solid #223044;
      color:#e8eef6;
      padding:10px;
      border-radius:6px;
      font-size:14px;
      font-family:inherit;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline:none;
      border-color:#3b82f6;
    }
    
    .form-textarea {
      resize:vertical;
      min-height:80px;
    }
    
    .color-picker-group {
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .color-preview {
      width:40px;
      height:40px;
      border-radius:6px;
      border:2px solid #223044;
    }
    
    .icon-picker {
      display:grid;
      grid-template-columns:repeat(8,1fr);
      gap:8px;
    }
    
    .icon-option {
      font-size:24px;
      padding:8px;
      border:2px solid transparent;
      border-radius:6px;
      cursor:pointer;
      text-align:center;
      transition:all 0.2s;
    }
    
    .icon-option:hover {
      background:#1a2535;
    }
    
    .icon-option.selected {
      border-color:#3b82f6;
      background:#1e3a5f;
    }
    
    .vehicle-list {
      max-height:250px;
      overflow-y:auto;
      border:1px solid #223044;
      border-radius:6px;
      padding:8px;
    }
    
    .vehicle-item {
      display:flex;
      align-items:center;
      padding:8px;
      border-radius:4px;
      transition:background 0.2s;
    }
    
    .vehicle-item:hover {
      background:#1a2535;
    }
    
    .vehicle-item input {
      margin-right:10px;
    }
    
    .vehicle-item-info {
      font-size:14px;
      cursor:pointer;
    }
    
    .modal-footer {
      padding:20px;
      border-top:1px solid #223044;
      display:flex;
      gap:12px;
      justify-content:flex-end;
    }
    
    .btn {
      padding:10px 20px;
      border-radius:6px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      border:none;
    }
    
    .btn-primary {
      background:#3b82f6;
      color:#fff;
    }
    
    .btn-primary:hover {
      background:#2563eb;
    }
    
    .btn-secondary {
      background:#1a2535;
      color:#9fb0c3;
      border:1px solid #223044;
    }
    
    .btn-secondary:hover {
      background:#243242;
    }
    
    .empty-state {
      text-align:center;
      padding:60px 20px;
      color:#6b7280;
    }
    
    .empty-state-icon {
      font-size:48px;
      margin-bottom:16px;
    }
    
    /* Tablet */
    @media (max-width: 1024px) and (min-width: 769px) {
      .charts-grid {
        grid-template-columns:repeat(2,1fr);
      }
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .desktop-header { display:none; }
      .mobile-header { display:block; }
      .container { padding:12px; }
      
      .fleet-selector-cards {
        flex-direction:column;
        overflow-x:visible;
      }
      
      .fleet-cards-grid {
        flex-direction:column;
      }
      
      .fleet-selector-card {
        min-width:100%;
      }
      
      .add-fleet-card {
        min-width:100%;
      }
      
      .fleet-overview {
        flex-direction:column;
        gap:12px;
      }
      
      .fleet-actions-top {
        width:100%;
      }
      
      .fleet-actions-top .fleet-btn {
        flex:1;
      }
      
      .vehicle-table {
        font-size:12px;
      }
      
      .vehicle-table th,
      .vehicle-table td {
        padding:8px 6px;
      }
      
      .section-header {
        padding:12px;
      }
      
      .section-title {
        font-size:16px;
      }
      
      .section-body {
        padding:12px;
      }
      
      .metrics-grid {
        grid-template-columns:repeat(2,1fr);
        gap:12px;
      }
      
      .metric-value {
        font-size:24px;
      }
      
      .charts-grid {
        grid-template-columns:1fr;
      }
      
      .chart-container {
        height:220px;
      }
      
      .fleet-spend-metrics {
        grid-template-columns:1fr;
        gap:8px;
        padding:8px;
      }
      
      .spend-value {
        font-size:18px;
      }
      
      .modal-content {
        margin:20px;
      }
      
      .icon-picker {
        grid-template-columns:repeat(6,1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Fleet Management</div>
        <div class="mobile-header-subtitle" id="mobileFleetSubtitle">Select a Fleet</div>
      </div>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <!-- Fleet Selector -->
      <div style="padding:12px; border-bottom:1px solid #223044;">
        <div style="font-size:11px; color:#6b7280; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; font-weight:600;">Active Fleets</div>
        <div id="mobileFleetButtons" style="display:flex; flex-direction:column; gap:8px;">
          <!-- Fleet buttons populated here -->
        </div>
        <button style="margin-top:8px; width:100%; padding:10px; background:#3b82f6; border:1px solid #3b82f6; border-radius:6px; color:#fff; font-size:14px; cursor:pointer; font-weight:600;" onclick="openCreateModal()">+ New Fleet</button>
      </div>
      
      <div class="mobile-header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html">Scheduling</a>
        <a href="dashboard-fleet-settings.html" class="active">Fleet Management</a>
      </div>
      <div class="mobile-header-actions">
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="desktop-header">
    <div class="header-top">
      <h1>Fleet Management</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div class="header-nav">
      <a href="dashboard-business.html">Dashboard</a>
      <a href="dashboard-customer-search.html">Customers</a>
      <a href="dashboard-vehicle-search.html">Vehicles</a>
      <a href="dashboard-scheduling.html">Scheduling</a>
      <a href="dashboard-fleet-settings.html" class="active">Fleet Management</a>
    </div>
    
    <div class="header-actions">
      <div class="view-tabs-header" id="desktopFleetButtons">
        <!-- Fleet buttons populated here -->
      </div>
      
      <div style="display:flex; gap:8px;">
        <button onclick="openCreateModal()" style="padding:8px 16px; background:#3b82f6; border:1px solid #3b82f6; border-radius:6px; color:#fff; font-size:14px; cursor:pointer; transition:all 0.15s ease; font-weight:500;">+ New Fleet</button>
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Fleet Selector Cards -->
    <div class="fleet-selector-cards">
      <div class="fleet-cards-grid" id="fleetSelectorCards">
        <!-- Fleet selector cards populated here -->
      </div>
      <button class="add-fleet-card" onclick="openCreateModal()">
        <div class="add-fleet-icon">+</div>
        <div class="add-fleet-text">New Fleet</div>
      </button>
    </div>

    <!-- Selected Fleet Card -->
    <div class="section" id="fleetCardSection">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon" id="selectedFleetIcon">▣</span>
          <span id="selectedFleetName">Select a Fleet</span>
        </div>
        <div class="section-toggle">▼</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="fleet-overview">
            <div class="fleet-meta">
              <div class="fleet-description-text" id="selectedFleetDescription"></div>
              <div class="fleet-vehicle-count" id="selectedFleetVehicleCount"></div>
            </div>
            <div class="fleet-actions-top">
              <button class="fleet-btn" onclick="editCurrentFleet()">Edit Fleet</button>
              <button class="fleet-btn delete" onclick="deleteCurrentFleet()">Delete Fleet</button>
            </div>
          </div>
          
          <!-- Vehicle List -->
          <div class="vehicle-stats-table">
            <h4>Vehicles Currently In Shop</h4>
            <table class="vehicle-table">
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Service</th>
                  <th>Technician</th>
                  <th>Expected Completion</th>
                  <th>Current Charges</th>
                </tr>
              </thead>
              <tbody id="fleetVehiclesTable">
                <!-- Vehicles populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Fleet Metrics Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">▣</span>
          <span>Performance Metrics</span>
        </div>
        <div class="section-toggle">▼</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="metrics-grid" id="fleetMetrics">
            <!-- Metrics populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">◧</span>
          <span>Analytics & Trends</span>
        </div>
        <div class="section-toggle">▼</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="charts-grid">
            <div class="chart-card">
              <h3>▬ Monthly Revenue Trend</h3>
              <div class="chart-container">
                <canvas id="costTrendChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>▥ Technician Performance</h3>
              <div class="chart-container">
                <canvas id="topVehiclesChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>◉ Service Type Distribution</h3>
              <div class="chart-container">
                <canvas id="maintenanceTypeChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fleet Modal -->
  <div class="modal" id="fleetModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Create Fleet</div>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form id="fleetForm" onsubmit="saveFleet(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Fleet Name</label>
            <input type="text" class="form-input" id="fleetName" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="fleetDescription"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Color</label>
            <div class="color-picker-group">
              <input type="color" class="form-input" id="fleetColor" value="#3b82f6">
              <div class="color-preview" id="colorPreview" style="background:#3b82f6"></div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Icon</label>
            <div class="icon-picker" id="iconPicker">
              <!-- Icons populated here -->
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Assign Vehicles</label>
            <div class="vehicle-list" id="vehicleList">
              <!-- Vehicles populated here -->
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Fleet</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const REST_BASE = document.querySelector('meta[name="supabase-url"]').content + "/rest/v1";
    const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

    let fleets = [];
    let vehicles = [];
    let currentFleetId = null;
    let selectedIcon = '▣';
    let selectedFleetId = null; // Currently viewing fleet
    let costTrendChart, topVehiclesChart, maintenanceChart;

    const FLEET_ICONS = ['▣', '▤', '▥', '▦', '▧', '▨', '▩', '▪', '▫', '◧', '◨', '◩', '◪', '⬒', '⬓', '⬔'];

    // Mock fleet-specific data - SERVICE MANAGER VIEW
    const fleetSpecificData = {
      'mock-1': {
        totalRevenue: 52400,
        openWO: 8,
        avgServiceTime: 2.8,
        retention: 98,
        partsMarkup: 35,
        scheduledDue: 12,
        vehiclesInShop: [
          { name: '2019 Ford F-150 #A142', service: 'Transmission Repair', tech: 'Mike Johnson', completion: 'Today 4PM', charges: 2450 },
          { name: '2020 Chevy Silverado #A089', service: 'Oil Change + Inspection', tech: 'Sarah Chen', completion: 'Today 2PM', charges: 185 },
          { name: '2021 Ram 2500 #A201', service: 'Brake Service', tech: 'Mike Johnson', completion: 'Tomorrow 10AM', charges: 890 },
          { name: '2018 GMC Sierra #A156', service: 'AC Repair', tech: 'Tom Rodriguez', completion: 'Today 5PM', charges: 1200 },
          { name: '2020 Ford Transit #A078', service: 'Preventive Maintenance', tech: 'Sarah Chen', completion: 'Tomorrow 2PM', charges: 320 }
        ],
        techPerformance: [
          { name: 'Mike Johnson', completionRate: 94, jobsCompleted: 47 },
          { name: 'Sarah Chen', completionRate: 98, jobsCompleted: 52 },
          { name: 'Tom Rodriguez', completionRate: 91, jobsCompleted: 38 },
          { name: 'Lisa Martinez', completionRate: 96, jobsCompleted: 44 },
          { name: 'James Wilson', completionRate: 89, jobsCompleted: 35 }
        ],
        monthlyRevenue: [
          { month: 'Jul', revenue: 42100 },
          { month: 'Aug', revenue: 45800 },
          { month: 'Sep', revenue: 48200 },
          { month: 'Oct', revenue: 50100 },
          { month: 'Nov', revenue: 49800 },
          { month: 'Dec', revenue: 52400 }
        ],
        serviceTypes: [
          { type: 'Preventive Maint.', value: 45 },
          { type: 'Repairs', value: 38 },
          { type: 'Inspections', value: 17 }
        ]
      },
      'mock-2': {
        totalRevenue: 38900,
        openWO: 5,
        avgServiceTime: 2.1,
        retention: 100,
        partsMarkup: 32,
        scheduledDue: 8,
        vehiclesInShop: [
          { name: '2021 Honda Civic #R432', service: 'Oil Change', tech: 'Sarah Chen', completion: 'Today 1PM', charges: 89 },
          { name: '2020 Toyota Camry #R218', service: 'Tire Rotation + Balance', tech: 'Tom Rodriguez', completion: 'Today 3PM', charges: 120 },
          { name: '2022 Nissan Altima #R509', service: 'State Inspection', tech: 'Mike Johnson', completion: 'Tomorrow 9AM', charges: 45 },
          { name: '2021 Mazda CX-5 #R387', service: 'Brake Pads', tech: 'Sarah Chen', completion: 'Tomorrow 11AM', charges: 485 },
          { name: '2020 Honda Accord #R156', service: 'Full Service', tech: 'Tom Rodriguez', completion: 'Tomorrow 4PM', charges: 295 }
        ],
        techPerformance: [
          { name: 'Mike Johnson', completionRate: 97, jobsCompleted: 41 },
          { name: 'Sarah Chen', completionRate: 99, jobsCompleted: 48 },
          { name: 'Tom Rodriguez', completionRate: 95, jobsCompleted: 39 },
          { name: 'Lisa Martinez', completionRate: 98, jobsCompleted: 42 },
          { name: 'James Wilson', completionRate: 93, jobsCompleted: 36 }
        ],
        monthlyRevenue: [
          { month: 'Jul', revenue: 32100 },
          { month: 'Aug', revenue: 34200 },
          { month: 'Sep', revenue: 35800 },
          { month: 'Oct', revenue: 37100 },
          { month: 'Nov', revenue: 36900 },
          { month: 'Dec', revenue: 38900 }
        ],
        serviceTypes: [
          { type: 'Preventive Maint.', value: 52 },
          { type: 'Repairs', value: 30 },
          { type: 'Inspections', value: 18 }
        ]
      },
      'mock-3': {
        totalRevenue: 67200,
        openWO: 12,
        avgServiceTime: 3.2,
        retention: 95,
        partsMarkup: 38,
        scheduledDue: 18,
        vehiclesInShop: [
          { name: '2018 Freightliner #E042', service: 'Engine Overhaul', tech: 'Mike Johnson', completion: 'Dec 30 2PM', charges: 8400 },
          { name: '2019 Kenworth T680 #E123', service: 'Suspension Repair', tech: 'Tom Rodriguez', completion: 'Tomorrow 5PM', charges: 3200 },
          { name: '2020 Peterbilt 579 #E089', service: 'DOT Inspection', tech: 'Sarah Chen', completion: 'Today 6PM', charges: 350 },
          { name: '2017 Volvo VNL #E201', service: 'Transmission Service', tech: 'Mike Johnson', completion: 'Dec 31 10AM', charges: 4500 },
          { name: '2021 Mack Anthem #E156', service: 'Preventive Maintenance', tech: 'Tom Rodriguez', completion: 'Tomorrow 1PM', charges: 890 }
        ],
        techPerformance: [
          { name: 'Mike Johnson', completionRate: 92, jobsCompleted: 34 },
          { name: 'Sarah Chen', completionRate: 96, jobsCompleted: 38 },
          { name: 'Tom Rodriguez', completionRate: 88, jobsCompleted: 31 },
          { name: 'Lisa Martinez', completionRate: 94, jobsCompleted: 35 },
          { name: 'James Wilson', completionRate: 90, jobsCompleted: 29 }
        ],
        monthlyRevenue: [
          { month: 'Jul', revenue: 58200 },
          { month: 'Aug', revenue: 61500 },
          { month: 'Sep', revenue: 59800 },
          { month: 'Oct', revenue: 64200 },
          { month: 'Nov', revenue: 65100 },
          { month: 'Dec', revenue: 67200 }
        ],
        serviceTypes: [
          { type: 'Preventive Maint.', value: 38 },
          { type: 'Repairs', value: 48 },
          { type: 'Inspections', value: 14 }
        ]
      }
    };

    // Toggle section
    function toggleSection(header) {
      header.parentElement.classList.toggle('collapsed');
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      const content = document.getElementById('mobileHeaderContent');
      content.classList.toggle('open');
    }

    // Navigation functions
    function logout() {
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
    }

    function goToSettings() {
      location.href = "dashboard-settings.html";
    }

    // Render fleet selector cards
    function renderFleetTabs() {
      const container = document.getElementById('fleetSelectorCards');
      container.innerHTML = fleets.map(fleet => {
        const monthRevenue = getFleetMonthRevenue(fleet.fleet_id);
        const ytdRevenue = getFleetTotalRevenue(fleet.fleet_id);
        const isActive = selectedFleetId === fleet.fleet_id;
        
        return `
          <div class="fleet-selector-card ${isActive ? 'active' : ''}" 
               onclick="selectFleet('${fleet.fleet_id}')"
               style="--fleet-color:${fleet.color}">
            <div class="fleet-card-top">
              <div class="fleet-card-icon">${fleet.icon}</div>
              <div class="fleet-card-title">
                <div class="fleet-card-name">${fleet.fleet_name}</div>
                <div class="fleet-card-subtitle">${fleet.vehicle_count || 0} Vehicles</div>
              </div>
            </div>
            <div class="fleet-card-metrics">
              <div class="fleet-metric">
                <div class="fleet-metric-label">This Month</div>
                <div class="fleet-metric-value">$${monthRevenue}</div>
              </div>
              <div class="fleet-metric">
                <div class="fleet-metric-label">Total (YTD)</div>
                <div class="fleet-metric-value">$${ytdRevenue}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Also render header buttons
      const headerButtons = document.getElementById('desktopFleetButtons');
      if (headerButtons) {
        headerButtons.innerHTML = fleets.map(fleet => {
          const isActive = selectedFleetId === fleet.fleet_id;
          return `
            <div class="view-tab ${isActive ? 'active' : ''}" onclick="selectFleet('${fleet.fleet_id}')">
              <span style="margin-right:4px;">${fleet.icon}</span>${fleet.fleet_name}
            </div>
          `;
        }).join('');
      }
      
      // Mobile fleet buttons
      const mobileButtons = document.getElementById('mobileFleetButtons');
      if (mobileButtons) {
        mobileButtons.innerHTML = fleets.map(fleet => {
          const isActive = selectedFleetId === fleet.fleet_id;
          return `
            <button onclick="selectFleet('${fleet.fleet_id}')" style="padding:10px; background:${isActive ? '#1e3a5f' : '#1a2535'}; border:1px solid ${isActive ? '#3b82f6' : '#223044'}; border-radius:6px; color:${isActive ? '#60a5fa' : '#9fb0c3'}; font-size:14px; cursor:pointer; text-align:left; transition:all 0.15s ease;">
              <span style="margin-right:8px; font-size:16px;">${fleet.icon}</span>${fleet.fleet_name}
            </button>
          `;
        }).join('');
      }
      
      // Update mobile subtitle
      const mobileSubtitle = document.getElementById('mobileFleetSubtitle');
      if (mobileSubtitle && selectedFleetId) {
        const fleet = fleets.find(f => f.fleet_id === selectedFleetId);
        if (fleet) {
          mobileSubtitle.textContent = fleet.fleet_name;
        }
      }
    }

    // Select fleet and update view
    function selectFleet(fleetId) {
      selectedFleetId = fleetId;
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!fleet) return;

      // Update fleet tabs
      renderFleetTabs();

      // Update fleet card header
      document.getElementById('selectedFleetIcon').textContent = fleet.icon;
      document.getElementById('selectedFleetName').textContent = fleet.fleet_name;
      document.getElementById('selectedFleetDescription').textContent = fleet.description || 'No description';
      document.getElementById('selectedFleetVehicleCount').textContent = `${fleet.vehicle_count || 0} Vehicles`;

      // Update metrics
      updateFleetMetrics(fleetId);

      // Update vehicle list
      updateVehicleList(fleetId);

      // Update charts
      updateFleetCharts(fleetId);
    }

    // Update metrics for selected fleet
    function updateFleetMetrics(fleetId) {
      const data = fleetSpecificData[fleetId];
      if (!data) return;

      // Calculate combined revenue across all fleets
      const combinedRevenue = Object.values(fleetSpecificData).reduce((sum, fleet) => sum + fleet.totalRevenue, 0);

      const metricsHTML = `
        <div class="metric-card">
          <div class="metric-label">Combined Fleet Revenue (30d)</div>
          <div class="metric-value">$${combinedRevenue.toLocaleString()}</div>
          <div class="metric-change up">All active fleets</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Open Work Orders</div>
          <div class="metric-value">${data.openWO}</div>
          <div class="metric-change">Currently in shop</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Avg Service Time</div>
          <div class="metric-value">${data.avgServiceTime} days</div>
          <div class="metric-change down">-12% vs last month</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Customer Retention</div>
          <div class="metric-value">${data.retention}%</div>
          <div class="metric-change up">Strong relationship</div>
        </div>
        
        <div class="metric-card metric-editable" onclick="editPartsMarkup('${fleetId}')">
          <div class="metric-label">Parts Markup</div>
          <div class="metric-value">${data.partsMarkup}%</div>
          <div class="metric-change">Fleet contract rate <span class="edit-icon">✎</span></div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Scheduled Maint. Due</div>
          <div class="metric-value">${data.scheduledDue}</div>
          <div class="metric-change">Next 30 days</div>
        </div>
      `;

      document.getElementById('fleetMetrics').innerHTML = metricsHTML;
    }

    // Edit parts markup
    function editPartsMarkup(fleetId) {
      const data = fleetSpecificData[fleetId];
      const newMarkup = prompt(`Edit Parts Markup % for this fleet:\n\nCurrent: ${data.partsMarkup}%`, data.partsMarkup);
      
      if (newMarkup !== null && !isNaN(newMarkup)) {
        data.partsMarkup = parseFloat(newMarkup);
        updateFleetMetrics(fleetId);
        alert(`✅ Parts markup updated to ${newMarkup}%`);
      }
    }

    // Update vehicle list for selected fleet
    function updateVehicleList(fleetId) {
      const data = fleetSpecificData[fleetId];
      if (!data || !data.vehiclesInShop) {
        document.getElementById('fleetVehiclesTable').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280;">No vehicles currently in shop</td></tr>';
        return;
      }

      const vehiclesHTML = data.vehiclesInShop.map(v => `
        <tr>
          <td class="vehicle-name">${v.name}</td>
          <td>${v.service}</td>
          <td class="vehicle-tech">${v.tech}</td>
          <td class="vehicle-completion">${v.completion}</td>
          <td class="vehicle-charges">$${v.charges.toLocaleString()}</td>
        </tr>
      `).join('');

      document.getElementById('fleetVehiclesTable').innerHTML = vehiclesHTML;
    }

    // Edit current fleet
    function editCurrentFleet() {
      if (selectedFleetId) {
        editFleet(selectedFleetId);
      }
    }

    // Delete current fleet
    function deleteCurrentFleet() {
      if (selectedFleetId) {
        deleteFleet(selectedFleetId);
      }
    }

    // Load data
    async function loadData() {
      try {
        fleets = [
          { fleet_id: 'mock-1', fleet_name: 'U-Haul Moving Trucks', description: '24 vehicle fleet - moving trucks & vans', color: '#f59e0b', icon: '▦', is_active: true, vehicle_count: 24 },
          { fleet_id: 'mock-2', fleet_name: 'Avis Rental Cars', description: '18 vehicle fleet - passenger vehicles', color: '#ef4444', icon: '▧', is_active: true, vehicle_count: 18 },
          { fleet_id: 'mock-3', fleet_name: 'Enterprise Fleet Services', description: '32 vehicle fleet - mixed commercial', color: '#10b981', icon: '▨', is_active: true, vehicle_count: 32 }
        ];

        vehicles = [
          { id: 'v1', year: 2020, make: 'Honda', model: 'Civic', vin: 'MOCK123' },
          { id: 'v2', year: 2021, make: 'Toyota', model: 'Camry', vin: 'MOCK456' },
          { id: 'v3', year: 2019, make: 'Ford', model: 'F-150', vin: 'MOCK789' }
        ];

        renderFleetTabs();
        renderFleets();
        renderIconPicker();

        // Select first fleet by default
        if (fleets.length > 0) {
          selectFleet(fleets[0].fleet_id);
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function renderFleets() {
      // Fleet configuration section removed - editing now done via selected fleet card
      return;
    }

    // Get fleet revenue helpers
    function getFleetTotalRevenue(fleetId) {
      const data = fleetSpecificData[fleetId];
      if (!data) return '0';
      // Calculate YTD (6 months of data)
      const ytd = data.monthlyRevenue.reduce((sum, m) => sum + m.revenue, 0);
      return ytd.toLocaleString();
    }

    function getFleetMonthRevenue(fleetId) {
      const data = fleetSpecificData[fleetId];
      if (!data) return '0';
      // Get last month's revenue
      const lastMonth = data.monthlyRevenue[data.monthlyRevenue.length - 1];
      return lastMonth ? lastMonth.revenue.toLocaleString() : '0';
    }

    // Update charts for selected fleet
    function updateFleetCharts(fleetId) {
      const data = fleetSpecificData[fleetId];
      if (!data) return;

      // Destroy existing charts
      if (costTrendChart) costTrendChart.destroy();
      if (topVehiclesChart) topVehiclesChart.destroy();
      if (maintenanceChart) maintenanceChart.destroy();

      // Revenue Trend Chart
      costTrendChart = new Chart(document.getElementById('costTrendChart'), {
        type: 'line',
        data: {
          labels: data.monthlyRevenue.map(d => d.month),
          datasets: [{
            label: 'Revenue',
            data: data.monthlyRevenue.map(d => d.revenue),
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96, 165, 250, 0.05)',
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#60a5fa',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: '#3b82f6',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (context) => '$' + context.parsed.y.toLocaleString()
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              border: { display: false },
              ticks: { 
                callback: value => '$' + (value/1000) + 'k',
                color: '#6b7280',
                font: { size: 11 }
              },
              grid: { color: '#1a2535', drawTicks: false }
            },
            x: {
              border: { display: false },
              ticks: { color: '#6b7280', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });

      // Technician Performance Chart
      topVehiclesChart = new Chart(document.getElementById('topVehiclesChart'), {
        type: 'bar',
        data: {
          labels: data.techPerformance.map(t => t.name),
          datasets: [{
            label: 'Completion Rate (%)',
            data: data.techPerformance.map(t => t.completionRate),
            backgroundColor: (context) => {
              const colors = ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe'];
              return colors[context.dataIndex] || '#60a5fa';
            },
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: '#3b82f6',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (context) => {
                  const tech = data.techPerformance[context.dataIndex];
                  return [
                    `Completion Rate: ${context.parsed.x}%`,
                    `Jobs Completed: ${tech.jobsCompleted}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              min: 80,
              max: 100,
              border: { display: false },
              ticks: {
                callback: value => value + '%',
                color: '#6b7280',
                font: { size: 11 }
              },
              grid: { color: '#1a2535', drawTicks: false }
            },
            y: {
              border: { display: false },
              ticks: { color: '#9fb0c3', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });

      // Service Type Chart
      maintenanceChart = new Chart(document.getElementById('maintenanceTypeChart'), {
        type: 'doughnut',
        data: {
          labels: data.serviceTypes.map(t => t.type),
          datasets: [{
            data: data.serviceTypes.map(t => t.value),
            backgroundColor: ['#60a5fa', '#3b82f6', '#e8eef6'],
            borderWidth: 0,
            hoverOffset: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: '#9fb0c3',
                padding: 15,
                font: { size: 12 },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: '#3b82f6',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: (context) => context.label + ': ' + context.parsed + '%'
              }
            }
          }
        }
      });
    }

    function renderIconPicker() {
      const picker = document.getElementById('iconPicker');
      picker.innerHTML = FLEET_ICONS.map(icon => `
        <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">${icon}</div>
      `).join('');
    }

    function selectIcon(icon) {
      selectedIcon = icon;
      renderIconPicker();
    }

    function openCreateModal() {
      currentFleetId = null;
      document.getElementById('fleetForm').reset();
      document.getElementById('colorPreview').style.background = '#3b82f6';
      selectedIcon = '▣';
      renderIconPicker();
      renderVehicleList();
      document.getElementById('fleetModal').classList.add('active');
    }

    function editFleet(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!fleet) return;

      currentFleetId = fleetId;
      document.getElementById('fleetName').value = fleet.fleet_name;
      document.getElementById('fleetDescription').value = fleet.description || '';
      document.getElementById('fleetColor').value = fleet.color;
      document.getElementById('colorPreview').style.background = fleet.color;
      selectedIcon = fleet.icon;
      renderIconPicker();
      renderVehicleList(fleetId);
      document.getElementById('fleetModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('fleetModal').classList.remove('active');
    }

    async function renderVehicleList(fleetId = null) {
      const list = document.getElementById('vehicleList');
      let assignments = [];

      list.innerHTML = vehicles.map(v => {
        const vehicleId = v.id || v.vehicle_id;
        const isAssigned = assignments.some(a => a.vehicle_id === vehicleId);
        return `
          <div class="vehicle-item">
            <input type="checkbox" value="${vehicleId}" ${isAssigned ? 'checked' : ''} id="vehicle_${vehicleId}">
            <label for="vehicle_${vehicleId}" class="vehicle-item-info">
              ${v.year} ${v.make} ${v.model}
            </label>
          </div>
        `;
      }).join('');
    }

    async function saveFleet(event) {
      event.preventDefault();

      const fleetData = {
        fleet_id: currentFleetId || 'mock-fleet-' + Date.now(),
        fleet_name: document.getElementById('fleetName').value,
        description: document.getElementById('fleetDescription').value,
        color: document.getElementById('fleetColor').value,
        icon: selectedIcon,
        is_active: true,
        vehicle_count: 0
      };

      try {
        if (currentFleetId) {
          const index = fleets.findIndex(f => f.fleet_id === currentFleetId);
          if (index !== -1) {
            fleets[index] = { ...fleets[index], ...fleetData };
          }
        } else {
          fleets.push(fleetData);
        }

        const selectedVehicles = Array.from(document.querySelectorAll('#vehicleList input:checked'))
          .map(input => input.value);
        
        const fleet = fleets.find(f => f.fleet_id === fleetData.fleet_id);
        if (fleet) {
          fleet.vehicle_count = selectedVehicles.length;
        }

        alert(`✅ Fleet "${fleetData.fleet_name}" saved successfully!`);
        closeModal();
        renderFleets();
        renderFleetTabs();
        
        // Select the saved fleet
        if (fleetData.fleet_id) {
          selectFleet(fleetData.fleet_id);
        }
      } catch (error) {
        console.error('Error saving fleet:', error);
        alert('Error saving fleet: ' + error.message);
      }
    }

    async function deleteFleet(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!confirm(`Are you sure you want to delete "${fleet?.fleet_name}"?`)) return;

      try {
        const index = fleets.findIndex(f => f.fleet_id === fleetId);
        if (index !== -1) {
          fleets.splice(index, 1);
        }
        
        renderFleets();
        renderFleetTabs();
        
        // Select first fleet if current was deleted
        if (selectedFleetId === fleetId && fleets.length > 0) {
          selectFleet(fleets[0].fleet_id);
        } else if (fleets.length === 0) {
          selectedFleetId = null;
          document.getElementById('selectedFleetName').textContent = 'No fleets';
          document.getElementById('fleetMetrics').innerHTML = '<p style="color:#6b7280;text-align:center;padding:40px;">Create a fleet to view metrics</p>';
          document.getElementById('fleetVehiclesTable').innerHTML = '';
        }
      } catch (error) {
        console.error('Error deleting fleet:', error);
        alert('Error deleting fleet');
      }
    }

    function manageVehicles(fleetId) {
      editFleet(fleetId);
    }

    // Color picker
    document.addEventListener('DOMContentLoaded', () => {
      const colorInput = document.getElementById('fleetColor');
      const colorPreview = document.getElementById('colorPreview');
      
      if (colorInput) {
        colorInput.addEventListener('input', (e) => {
          colorPreview.style.background = e.target.value;
        });
      }

      loadData();
    });

    // Close modal on background click
    document.getElementById('fleetModal').addEventListener('click', (e) => {
      if (e.target.id === 'fleetModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
