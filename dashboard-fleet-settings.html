<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Management</title>
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family:system-ui,-apple-system,sans-serif; 
      background:#0b0f14; 
      color:#e8eef6;
      min-height:100vh;
    }
    
    /* Scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #223044 #0f1621;
    }
    *::-webkit-scrollbar { width:10px; height:10px; }
    *::-webkit-scrollbar-track { background:#0f1621; }
    *::-webkit-scrollbar-thumb { background:#223044; border-radius:5px; }
    *::-webkit-scrollbar-thumb:hover { background:#2d3f56; }
    
    /* Mobile Header */
    .mobile-header {
      display:none;
      background:#0f1621;
      border-bottom:1px solid #223044;
      position:sticky;
      top:0;
      z-index:100;
    }

    .mobile-header-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
    }

    .mobile-menu-toggle {
      background:transparent;
      border:1px solid transparent;
      border-radius:6px;
      color:#6b7280;
      font-size:20px;
      padding:0;
      width:36px;
      height:36px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }

    .mobile-menu-toggle:hover {
      background:rgba(59,130,246,0.1);
      border-color:#3b82f6;
      color:#3b82f6;
    }

    .mobile-header-center {
      flex:1;
      margin-left:12px;
    }

    .mobile-header-title {
      font-size:18px;
      font-weight:600;
    }

    .mobile-header-subtitle {
      font-size:12px;
      color:#9fb0c3;
      margin-top:2px;
    }

    .mobile-header-content {
      max-height:0;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }

    .mobile-header-content.open {
      max-height:500px;
    }

    .mobile-header-nav {
      padding:8px 12px;
      border-bottom:1px solid #223044;
    }

    .mobile-header-nav a {
      display:block;
      padding:12px;
      color:#9fb0c3;
      text-decoration:none;
      border-radius:6px;
      transition:all 0.15s ease;
      font-size:15px;
    }

    .mobile-header-nav a:hover {
      background:#1a2535;
      color:#e8eef6;
    }

    .mobile-header-nav a.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .mobile-header-actions {
      padding:12px;
      display:flex;
      gap:8px;
    }

    .mobile-header-actions button {
      flex:1;
      padding:10px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#9fb0c3;
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s ease;
    }

    .mobile-header-actions button:hover {
      background:#1e2a3d;
      color:#e8eef6;
    }

    /* Mobile Action Buttons */
    .mobile-action-buttons {
      display:none;
      position:fixed;
      bottom:102px;
      left:0;
      right:0;
      background:#0f1621;
      padding:8px 8px 0 8px;
      z-index:101;
    }

    .mobile-action-grid {
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:6px;
      margin-bottom:6px;
    }

    .mobile-action-btn {
      padding:10px 8px;
      border-radius:8px;
      border:1px solid #223044;
      background:#1a2535;
      color:#9fb0c3;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      height:44px;
      box-sizing:border-box;
      text-decoration:none;
    }

    .mobile-action-btn:active {
      transform:scale(0.95);
      background:#243648;
    }

    /* Mobile Bottom Nav */
    .mobile-bottom-nav {
      display:none;
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#0f1621;
      padding:8px 8px 8px 8px;
      z-index:100;
    }

    .mobile-nav-grid {
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:6px;
      margin-bottom:6px;
    }
    
    .mobile-nav-grid .mobile-nav-btn {
      background:#1f2e40;
    }

    .mobile-nav-secondary {
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:6px;
    }

    .mobile-bottom-nav .mobile-nav-btn {
      padding:10px 8px;
      border-radius:8px;
      border:1px solid #223044;
      background:#1a2535;
      color:#9fb0c3;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      height:44px;
      box-sizing:border-box;
    }

    .mobile-bottom-nav .mobile-nav-btn.active, 
    .mobile-bottom-nav .mobile-nav-btn:hover {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }

    .mobile-bottom-nav .mobile-nav-btn:active {
      transform:scale(0.95);
    }

    /* Desktop Header */
    .desktop-header {
      display:block;
      background:#0f1621;
      border-bottom:1px solid #223044;
      padding:20px 40px;
      position:sticky;
      top:0;
      z-index:100;
    }

    .header-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .header-top h1 {
      font-size:24px;
      font-weight:600;
      color:#e8eef6;
    }

    .header-nav {
      display:flex;
      gap:8px;
      padding-bottom:12px;
    }

    .header-nav a {
      padding:8px 16px;
      border-radius:6px;
      color:#9fb0c3;
      text-decoration:none;
      font-size:14px;
      transition:all 0.15s ease;
    }

    .header-nav a:hover {
      background:#1a2535;
      color:#e8eef6;
    }

    .header-nav a.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .header-actions {
      display:flex;
      gap:16px;
      justify-content:space-between;
      align-items:center;
      padding-top:12px;
      border-top:1px solid #223044;
    }
    
    .view-tabs-header {
      display:flex;
      gap:4px;
      background:#0f1621;
      padding:4px;
      border-radius:8px;
      border:1px solid #223044;
    }
    
    .view-tab {
      padding:8px 16px;
      border-radius:6px;
      color:#9fb0c3;
      font-size:13px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-weight:500;
      user-select:none;
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    .view-tab:hover {
      background:#1a2535;
      color:#e8eef6;
    }
    
    .view-tab.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .header-actions button {
      padding:8px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#9fb0c3;
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-weight:500;
    }

    .header-actions button:hover {
      background:#1e2a3d;
      color:#e8eef6;
      border-color:#3b82f6;
    }
    
    .header-actions .btn-primary {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }
    
    .header-actions .btn-primary:hover {
      background:#2563eb;
      border-color:#2563eb;
    }
    
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    
    /* Fleet Selector Cards */
    .fleet-selector-cards {
      display:flex;
      gap:16px;
      margin-bottom:24px;
      overflow-x:auto;
      padding-bottom:8px;
    }
    
    .fleet-cards-grid {
      display:flex;
      gap:16px;
      flex:1;
    }
    
    .fleet-selector-card {
      background:#1a2535;
      border:2px solid #223044;
      border-radius:8px;
      padding:20px;
      min-width:280px;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
    }
    
    .fleet-selector-card::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:4px;
      height:100%;
      background:var(--fleet-color);
      opacity:0.5;
      transition:all 0.3s;
    }
    
    .fleet-selector-card:hover {
      border-color:#3b82f6;
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.4);
    }
    
    .fleet-selector-card:hover::before {
      width:8px;
      opacity:1;
    }
    
    .fleet-selector-card.active {
      border-color:var(--fleet-color);
      background:#1e2a3d;
      box-shadow:0 8px 20px rgba(59,130,246,0.3);
    }
    
    .fleet-selector-card.active::before {
      width:100%;
      opacity:0.08;
    }
    
    .fleet-card-top {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .fleet-card-icon-wrapper {
      width:60px;
      height:60px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#0f1621;
      border-radius:8px;
      border:1px solid #223044;
      position:relative;
    }
    
    .fleet-card-icon-wrapper svg {
      width:32px;
      height:32px;
      stroke:#60a5fa;
      fill:none;
    }
    
    .fleet-selector-card.active .fleet-card-icon-wrapper {
      background:var(--fleet-color);
      background:linear-gradient(135deg, var(--fleet-color) 0%, rgba(0,0,0,0.3) 100%);
      border-color:var(--fleet-color);
    }
    
    .fleet-selector-card.active .fleet-card-icon-wrapper svg {
      stroke:#fff;
    }
    
    .fleet-card-title {
      flex:1;
    }
    
    .fleet-card-name {
      font-size:16px;
      font-weight:600;
      color:#e8eef6;
      margin-bottom:4px;
    }
    
    .fleet-card-subtitle {
      font-size:11px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .fleet-card-metrics {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid #223044;
    }
    
    .fleet-metric {
      text-align:left;
    }
    
    .fleet-metric-label {
      font-size:10px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px;
      font-weight:600;
    }
    
    .fleet-metric-value {
      font-size:18px;
      font-weight:700;
      color:#60a5fa;
      letter-spacing:-0.5px;
    }
    
    .fleet-selector-card.active .fleet-metric-value {
      color:var(--fleet-color);
    }
    
    .add-fleet-card {
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      padding:20px;
      min-width:140px;
      cursor:pointer;
      transition:all 0.3s;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:#9fb0c3;
    }
    
    .add-fleet-card:hover {
      background:#1e2a3d;
      border-color:#3b82f6;
      color:#e8eef6;
      transform:translateY(-4px);
    }
    
    .add-fleet-card svg {
      width:32px;
      height:32px;
      stroke:currentColor;
    }
    
    .add-fleet-text {
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    /* Action Icon Buttons - Matching User's Theme */
    .action-icon-btn {
      width:36px;
      height:36px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.2s;
      color:#60a5fa;
    }
    
    .action-icon-btn svg {
      width:16px;
      height:16px;
      stroke:currentColor;
    }
    
    .action-icon-btn:hover {
      background:#243648;
      border-color:#3b82f6;
      color:#3b82f6;
    }
    
    .action-icon-btn.delete {
      color:#ef4444;
    }
    
    .action-icon-btn.delete:hover {
      background:#2d1f1f;
      border-color:#ef4444;
    }
    
    /* Fleet Overview */
    .fleet-overview {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:24px;
      padding-bottom:16px;
      border-bottom:1px solid #223044;
    }
    
    .fleet-meta {
      flex:1;
    }
    
    .fleet-description-text {
      color:#9fb0c3;
      font-size:14px;
      margin-bottom:8px;
    }
    
    .fleet-vehicle-count {
      color:#60a5fa;
      font-size:13px;
      font-weight:600;
    }
    
    .fleet-actions-top {
      display:flex;
      gap:8px;
    }
    
    /* Vehicle Stats Table */
    .vehicle-stats-table {
      margin-top:16px;
    }
    
    .vehicle-stats-table h4 {
      font-size:14px;
      font-weight:600;
      margin-bottom:12px;
      color:#9fb0c3;
      text-transform:uppercase;
      letter-spacing:0.5px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .vehicle-stats-table h4 svg {
      width:18px;
      height:18px;
      stroke:#60a5fa;
    }
    
    .vehicle-table {
      width:100%;
      border-collapse:collapse;
    }
    
    .vehicle-table th {
      text-align:left;
      padding:12px;
      background:#0f1621;
      border-bottom:2px solid #223044;
      color:#6b7280;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      font-weight:600;
    }
    
    .vehicle-table td {
      padding:12px;
      border-bottom:1px solid #1a2535;
      color:#e8eef6;
      font-size:13px;
    }
    
    .vehicle-table tr:hover {
      background:#141824;
    }
    
    .vehicle-name {
      font-weight:600;
      color:#e8eef6;
    }
    
    /* Collapsible Section */
    .section {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:8px;
      margin-bottom:16px;
      overflow:hidden;
    }
    
    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      cursor:pointer;
      user-select:none;
      transition:background 0.2s;
    }
    
    .section-header:hover {
      background:#141824;
    }
    
    .section-title {
      font-size:18px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .section-icon svg {
      width:22px;
      height:22px;
      stroke:#60a5fa;
    }
    
    .section-toggle {
      font-size:20px;
      color:#6b7280;
      transition:transform 0.3s;
    }
    
    .section.collapsed .section-toggle {
      transform:rotate(-90deg);
    }
    
    .section-content {
      max-height:5000px;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }
    
    .section.collapsed .section-content {
      max-height:0;
    }
    
    .section-body {
      padding:20px;
      border-top:1px solid #223044;
    }
    
    /* Metrics Grid */
    .metrics-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }
    
    .metric-card {
      background:#1a2535;
      padding:20px;
      border-radius:8px;
      border:1px solid #223044;
      border-left:3px solid #3b82f6;
      transition:all 0.2s;
    }
    
    .metric-card:hover {
      border-left-color:#60a5fa;
      background:#1e2a3d;
    }
    
    .metric-label {
      color:#6b7280;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      margin-bottom:10px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    .metric-label svg {
      width:14px;
      height:14px;
      stroke:currentColor;
    }
    
    .metric-value {
      font-size:32px;
      font-weight:700;
      color:#e8eef6;
      margin-bottom:6px;
      letter-spacing:-0.5px;
    }
    
    .metric-change {
      font-size:11px;
      display:flex;
      align-items:center;
      gap:4px;
      font-weight:500;
    }
    
    .metric-change.up { color:#34d399; }
    .metric-change.down { color:#f87171; }
    
    /* Charts Grid */
    .charts-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
    }
    
    .chart-card {
      background:#141824;
      padding:20px;
      border-radius:8px;
      border:1px solid #1a2535;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    
    .chart-card h3 {
      font-size:13px;
      font-weight:600;
      margin-bottom:16px;
      color:#9fb0c3;
      display:flex;
      align-items:center;
      gap:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .chart-card h3 svg {
      width:16px;
      height:16px;
      stroke:currentColor;
    }
    
    .chart-container {
      position:relative;
      height:240px;
    }
    
    /* Modal */
    .modal {
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.8);
      z-index:1000;
      overflow-y:auto;
    }
    
    .modal.active {
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    
    .modal-content {
      background:#0f1621;
      border-radius:12px;
      max-width:600px;
      width:100%;
      border:1px solid #223044;
    }
    
    .modal-header {
      padding:20px;
      border-bottom:1px solid #223044;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .modal-title {
      font-size:20px;
      font-weight:600;
    }
    
    .modal-close {
      background:transparent;
      border:none;
      color:#9fb0c3;
      font-size:24px;
      cursor:pointer;
      padding:0;
      width:32px;
      height:32px;
      border-radius:4px;
      transition:all 0.2s;
    }
    
    .modal-close:hover {
      background:#1a2535;
      color:#e8eef6;
    }
    
    .modal-body {
      padding:20px;
    }
    
    .form-group {
      margin-bottom:16px;
    }
    
    .form-label {
      display:block;
      color:#9fb0c3;
      font-size:13px;
      margin-bottom:6px;
      font-weight:600;
    }
    
    .form-input,
    .form-textarea {
      width:100%;
      background:#1a2535;
      border:1px solid #223044;
      color:#e8eef6;
      padding:10px;
      border-radius:6px;
      font-size:14px;
      font-family:inherit;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline:none;
      border-color:#3b82f6;
    }
    
    .form-textarea {
      resize:vertical;
      min-height:80px;
    }
    
    .color-picker-group {
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .color-preview {
      width:40px;
      height:40px;
      border-radius:6px;
      border:2px solid #223044;
    }
    
    .icon-picker {
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:8px;
    }
    
    .icon-option {
      padding:12px;
      border:2px solid transparent;
      border-radius:6px;
      cursor:pointer;
      text-align:center;
      transition:all 0.2s;
      background:#1a2535;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .icon-option svg {
      width:28px;
      height:28px;
      stroke:#60a5fa;
    }
    
    .icon-option:hover {
      background:#243648;
      border-color:#3b82f6;
    }
    
    .icon-option.selected {
      border-color:#3b82f6;
      background:#1e3a5f;
    }
    
    .icon-option.selected svg {
      stroke:#3b82f6;
    }
    
    .modal-footer {
      padding:20px;
      border-top:1px solid #223044;
      display:flex;
      gap:12px;
      justify-content:flex-end;
    }
    
    .btn {
      padding:10px 20px;
      border-radius:6px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      border:none;
    }
    
    .btn-primary {
      background:#3b82f6;
      color:#fff;
    }
    
    .btn-primary:hover {
      background:#2563eb;
    }
    
    .btn-secondary {
      background:#1a2535;
      color:#9fb0c3;
      border:1px solid #223044;
    }
    
    .btn-secondary:hover {
      background:#243242;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .desktop-header { display:none; }
      .mobile-header { display:block; }
      .mobile-action-buttons { display:block !important; }
      .mobile-bottom-nav { display:block !important; }
      .container { padding:12px; }
      
      body {
        padding-bottom:165px;
      }
      
      .fleet-selector-cards {
        flex-direction:column;
        overflow-x:visible;
      }
      
      .fleet-cards-grid {
        flex-direction:column;
      }
      
      .fleet-selector-card {
        min-width:100%;
      }
      
      .add-fleet-card {
        min-width:100%;
      }
      
      .charts-grid {
        grid-template-columns:1fr;
      }
      
      .icon-picker {
        grid-template-columns:repeat(4,1fr);
      }
    }
    
    @media (min-width: 769px) {
      .mobile-action-buttons { display:none !important; }
      .mobile-bottom-nav { display:none !important; }
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Fleet Management</div>
        <div class="mobile-header-subtitle" id="mobileFleetSubtitle">Loading...</div>
      </div>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html">Scheduling</a>
        <a href="dashboard-fleet-settings.html" class="active">Fleet Management</a>
      </div>
      <div class="mobile-header-actions">
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="desktop-header">
    <div class="header-top">
      <h1>Fleet Management</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div class="header-nav">
      <a href="dashboard-business.html">Dashboard</a>
      <a href="dashboard-customer-search.html">Customers</a>
      <a href="dashboard-vehicle-search.html">Vehicles</a>
      <a href="dashboard-scheduling.html">Scheduling</a>
      <a href="dashboard-fleet-settings.html" class="active">Fleet Management</a>
    </div>
    
    <div class="header-actions">
      <div class="view-tabs-header" id="desktopFleetButtons">
        <!-- Fleet buttons populated here -->
      </div>
      
      <div style="display:flex; gap:8px;">
        <button class="btn-primary" onclick="openCreateModal()">+ New Fleet</button>
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Mobile Action Buttons -->
  <div class="mobile-action-buttons">
    <div class="mobile-action-grid">
      <button class="mobile-action-btn" onclick="location.href='work-order-new.html'">New Order</button>
      <button class="mobile-action-btn" onclick="location.href='dashboard-scheduling.html'">Scheduler</button>
      <button class="mobile-action-btn" onclick="location.href='dashboard-fleet-settings.html'">Fleet</button>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <div class="mobile-bottom-nav">
    <div class="mobile-nav-grid">
      <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
      <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
      <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
      <button class="mobile-nav-btn" onclick="location.href='dashboard-settings.html'">Settings</button>
    </div>
    <div class="mobile-nav-secondary">
      <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
      <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
      <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
    </div>
  </div>

  <div class="container">
    <!-- Fleet Selector Cards -->
    <div class="section collapsed">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <path d="M3 9h18"></path>
              <path d="M9 21V9"></path>
            </svg>
          </span>
          <span>Fleet Overview</span>
        </div>
        <div class="section-toggle">▼</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="fleet-selector-cards">
            <div class="fleet-cards-grid" id="fleetSelectorCards">
              <!-- Fleet selector cards populated here -->
            </div>
            <button class="add-fleet-card" onclick="openCreateModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <div class="add-fleet-text">New Fleet</div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Selected Fleet Card -->
    <div class="section" id="fleetCardSection">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon" id="selectedFleetIconWrapper">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <path d="M5 17H4a2 2 0 01-2-2V5c0-1.1.9-2 2-2h16a2 2 0 012 2v10a2 2 0 01-2 2h-1"></path>
              <polygon points="12 17 18 22 18 17 12 17"></polygon>
              <polygon points="12 17 6 22 6 17 12 17"></polygon>
              <rect x="8" y="12" width="8" height="5"></rect>
            </svg>
          </span>
          <span id="selectedFleetName">Select a Fleet</span>
        </div>
        <div class="section-toggle">▼</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="fleet-overview">
            <div class="fleet-meta">
              <div class="fleet-description-text" id="selectedFleetDescription"></div>
              <div class="fleet-vehicle-count" id="selectedFleetVehicleCount"></div>
            </div>
            <div class="fleet-actions-top">
              <button class="action-icon-btn" onclick="editCurrentFleet()" title="Edit Fleet">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="action-icon-btn delete" onclick="deleteCurrentFleet()" title="Delete Fleet">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Vehicle List -->
          <div class="vehicle-stats-table">
            <h4>
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <path d="M5 17H4a2 2 0 01-2-2V5c0-1.1.9-2 2-2h16a2 2 0 012 2v10a2 2 0 01-2 2h-1"></path>
                <polygon points="12 17 18 22 18 17 12 17"></polygon>
                <polygon points="12 17 6 22 6 17 12 17"></polygon>
                <rect x="8" y="12" width="8" height="5"></rect>
              </svg>
              Assigned Fleet Vehicles
            </h4>
            <table class="vehicle-table">
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Year</th>
                  <th>License Plate</th>
                  <th>VIN</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="fleetVehiclesTable">
                <!-- Vehicles populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Fleet Metrics Section -->
    <div class="section collapsed">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
          </span>
          <span>Performance Metrics</span>
        </div>
        <div class="section-toggle">▼</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="metrics-grid" id="fleetMetrics">
            <!-- Metrics populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
          </span>
          <span>Analytics & Trends</span>
        </div>
        <div class="section-toggle">▼</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="charts-grid">
            <div class="chart-card">
              <h3>
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                Monthly Revenue Trend
              </h3>
              <div class="chart-container">
                <canvas id="costTrendChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Work Order Volume
              </h3>
              <div class="chart-container">
                <canvas id="topVehiclesChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Fleet Distribution
              </h3>
              <div class="chart-container">
                <canvas id="maintenanceTypeChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fleet Modal -->
  <div class="modal" id="fleetModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Create Fleet</div>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <form id="fleetForm" onsubmit="saveFleet(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Fleet Name</label>
            <input type="text" class="form-input" id="fleetName" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="fleetDescription"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Fleet Color</label>
            <div class="color-picker-group">
              <input type="color" class="form-input" id="fleetColor" value="#3b82f6" style="width:80px;">
              <div class="color-preview" id="colorPreview" style="background:#3b82f6"></div>
              <span style="color:#9fb0c3; font-size:13px; margin-left:8px;">Work order card border color</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Fleet Icon</label>
            <div class="icon-picker" id="iconPicker">
              <!-- Icons populated here -->
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Fleet</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
    const API_BASE = `https://${PROJECT_REF}.supabase.co`;
    const REST_BASE = `${API_BASE}/rest/v1`;
    const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

    let fleets = [];
    let vehicles = [];
    let vehicleFleetAssignments = [];
    let workOrders = [];
    let selectedFleetId = null;
    let currentFleetId = null;
    let selectedIcon = 'truck';
    let costTrendChart, topVehiclesChart, maintenanceChart;

    // SVG Icons Library
    const SVG_ICONS = {
      truck: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>',
      car: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 17H4a2 2 0 01-2-2V5c0-1.1.9-2 2-2h16a2 2 0 012 2v10a2 2 0 01-2 2h-1"></path><polygon points="12 17 18 22 18 17 12 17"></polygon><polygon points="12 17 6 22 6 17 12 17"></polygon><rect x="8" y="12" width="8" height="5"></rect></svg>',
      van: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14H6a2 2 0 01-2-2V4a2 2 0 012-2h8v12z"></path><path d="M14 4h4l3 3v7a2 2 0 01-2 2h-1"></path><circle cx="6.5" cy="18.5" r="2.5"></circle><circle cx="17.5" cy="18.5" r="2.5"></circle></svg>',
      bus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="14" rx="2"></rect><path d="M3 10h18M8 18v2m8-2v2M8 4v2m8-2v2"></path></svg>',
      motorcycle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="18" r="3"></circle><circle cx="19" cy="18" r="3"></circle><path d="M5 18H2l5-11h4m0 0l4 6m-4-6l4-3 4 3"></path></svg>',
      tool: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>'
    };

    // Toggle section
    function toggleSection(header) {
      header.parentElement.classList.toggle('collapsed');
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      const content = document.getElementById('mobileHeaderContent');
      content.classList.toggle('open');
    }

    // Navigation functions
    function logout() {
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
    }

    function goToSettings() {
      location.href = "dashboard-settings.html";
    }

    async function validateAuth() {
      const token = localStorage.getItem("sb_access_token");
      if(!token) return null;
      const r = await fetch(`${API_BASE}/auth/v1/user`, {
        headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
      });
      return r.ok ? token : null;
    }

    async function fetchTable(table, token) {
      const r = await fetch(`${REST_BASE}/${table}?select=*`, {
        headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // Calculate monthly and YTD revenue
    function calculateFleetRevenue(fleetId) {
      const fleetWOs = workOrders.filter(wo => wo.fleet_id === fleetId && wo.status === 'completed');
      
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      let monthRevenue = 0;
      let ytdRevenue = 0;
      
      fleetWOs.forEach(wo => {
        const revenue = parseFloat(wo.total_price) || 0;
        ytdRevenue += revenue;
        
        if (wo.scheduled_start) {
          const woDate = new Date(wo.scheduled_start);
          if (woDate.getMonth() === currentMonth && woDate.getFullYear() === currentYear) {
            monthRevenue += revenue;
          }
        }
      });
      
      return { monthRevenue, ytdRevenue };
    }

    // Render fleet selector cards
    function renderFleetTabs() {
      const container = document.getElementById('fleetSelectorCards');
      
      if (fleets.length === 0) {
        container.innerHTML = `
          <div style="padding:60px 20px; text-align:center; color:#6b7280; width:100%;">
            <svg style="width:48px; height:48px; stroke:#6b7280; margin:0 auto 16px;" viewBox="0 0 24 24" fill="none" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="15"></line>
              <line x1="15" y1="9" x2="9" y2="15"></line>
            </svg>
            <div style="font-size:18px; margin-bottom:8px;">No Fleets Found</div>
            <div style="font-size:14px;">Create your first fleet to get started</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = fleets.map(fleet => {
        const vehicleCount = vehicleFleetAssignments.filter(a => a.fleet_id === fleet.fleet_id && a.is_active).length;
        const isActive = selectedFleetId === fleet.fleet_id;
        const { monthRevenue, ytdRevenue } = calculateFleetRevenue(fleet.fleet_id);
        const iconSvg = SVG_ICONS[fleet.icon] || SVG_ICONS.car;
        
        return `
          <div class="fleet-selector-card ${isActive ? 'active' : ''}" 
               onclick="selectFleet('${fleet.fleet_id}')"
               style="--fleet-color:${fleet.color}">
            <div class="fleet-card-top">
              <div class="fleet-card-icon-wrapper">
                ${iconSvg}
              </div>
              <div class="fleet-card-title">
                <div class="fleet-card-name">${fleet.fleet_name}</div>
                <div class="fleet-card-subtitle">${vehicleCount} Vehicles</div>
              </div>
            </div>
            <div class="fleet-card-metrics">
              <div class="fleet-metric">
                <div class="fleet-metric-label">This Month</div>
                <div class="fleet-metric-value">$${monthRevenue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
              </div>
              <div class="fleet-metric">
                <div class="fleet-metric-label">Total (YTD)</div>
                <div class="fleet-metric-value">$${ytdRevenue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Also render header buttons
      const headerButtons = document.getElementById('desktopFleetButtons');
      if (headerButtons) {
        headerButtons.innerHTML = fleets.map(fleet => {
          const isActive = selectedFleetId === fleet.fleet_id;
          const iconSvg = SVG_ICONS[fleet.icon] || SVG_ICONS.car;
          return `
            <div class="view-tab ${isActive ? 'active' : ''}" onclick="selectFleet('${fleet.fleet_id}')">
              <span style="width:16px;height:16px;display:inline-flex;">${iconSvg}</span>${fleet.fleet_name}
            </div>
          `;
        }).join('');
      }
      
      // Update mobile subtitle
      const mobileSubtitle = document.getElementById('mobileFleetSubtitle');
      if (mobileSubtitle && selectedFleetId) {
        const fleet = fleets.find(f => f.fleet_id === selectedFleetId);
        if (fleet) {
          mobileSubtitle.textContent = fleet.fleet_name;
        }
      } else if (mobileSubtitle) {
        mobileSubtitle.textContent = 'Select a Fleet';
      }
    }

    // Select fleet and update view
    function selectFleet(fleetId) {
      selectedFleetId = fleetId;
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!fleet) return;

      console.log('Selected fleet:', fleet.fleet_name);

      // Update fleet tabs
      renderFleetTabs();

      // Update fleet card header with SVG icon
      const iconSvg = SVG_ICONS[fleet.icon] || SVG_ICONS.car;
      document.getElementById('selectedFleetIconWrapper').innerHTML = iconSvg;
      document.getElementById('selectedFleetName').textContent = fleet.fleet_name;
      document.getElementById('selectedFleetDescription').textContent = fleet.description || 'No description provided';
      
      const vehicleCount = vehicleFleetAssignments.filter(a => a.fleet_id === fleetId && a.is_active).length;
      document.getElementById('selectedFleetVehicleCount').textContent = `${vehicleCount} Vehicles Assigned`;

      // Update metrics
      updateFleetMetrics(fleetId);

      // Update vehicle list
      updateVehicleList(fleetId);

      // Update charts
      updateFleetCharts(fleetId);
    }

    // Update metrics for selected fleet
    function updateFleetMetrics(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      const vehicleCount = vehicleFleetAssignments.filter(a => a.fleet_id === fleetId && a.is_active).length;
      const woCount = workOrders.filter(wo => wo.fleet_id === fleetId).length;
      const scheduledWO = workOrders.filter(wo => wo.fleet_id === fleetId && wo.status === 'scheduled').length;
      const completedWO = workOrders.filter(wo => wo.fleet_id === fleetId && wo.status === 'completed').length;
      
      const { monthRevenue, ytdRevenue } = calculateFleetRevenue(fleetId);

      const metricsHTML = `
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <path d="M5 17H4a2 2 0 01-2-2V5c0-1.1.9-2 2-2h16a2 2 0 012 2v10a2 2 0 01-2 2h-1"></path>
              <rect x="8" y="12" width="8" height="5"></rect>
            </svg>
            Total Vehicles
          </div>
          <div class="metric-value">${vehicleCount}</div>
          <div class="metric-change">Assigned to ${fleet.fleet_name}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Total Work Orders
          </div>
          <div class="metric-value">${woCount}</div>
          <div class="metric-change">All time</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Scheduled Work Orders
          </div>
          <div class="metric-value">${scheduledWO}</div>
          <div class="metric-change">Currently scheduled</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Completed Work Orders
          </div>
          <div class="metric-value">${completedWO}</div>
          <div class="metric-change up">Finished</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            This Month Revenue
          </div>
          <div class="metric-value">$${monthRevenue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
          <div class="metric-change up">Current month</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            YTD Revenue
          </div>
          <div class="metric-value">$${ytdRevenue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
          <div class="metric-change up">Year to date</div>
        </div>
      `;

      document.getElementById('fleetMetrics').innerHTML = metricsHTML;
    }

    // Update vehicle list for selected fleet
    function updateVehicleList(fleetId) {
      const assignedVehicleIds = vehicleFleetAssignments
        .filter(a => a.fleet_id === fleetId && a.is_active)
        .map(a => a.vehicle_id);
      
      const assignedVehicles = vehicles.filter(v => assignedVehicleIds.includes(v.vehicle_id));
      
      if (assignedVehicles.length === 0) {
        document.getElementById('fleetVehiclesTable').innerHTML = 
          '<tr><td colspan="6" style="text-align:center;color:#6b7280;padding:40px;">No vehicles assigned to this fleet. Use SQL to assign vehicles.</td></tr>';
        return;
      }

      const vehiclesHTML = assignedVehicles.map(v => `
        <tr>
          <td class="vehicle-name">${v.year} ${v.make} ${v.model}</td>
          <td>${v.year}</td>
          <td>${v.license_plate || 'N/A'}</td>
          <td style="font-size:11px; color:#6b7280;">${v.vin ? v.vin.substring(0, 10) + '...' : 'N/A'}</td>
          <td><span style="padding:4px 8px; background:#1e4d2b; color:#34d399; border-radius:4px; font-size:11px; font-weight:600;">ACTIVE</span></td>
          <td>
            <button class="action-icon-btn delete" onclick="unassignVehicle('${v.vehicle_id}')" title="Unassign">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </td>
        </tr>
      `).join('');

      document.getElementById('fleetVehiclesTable').innerHTML = vehiclesHTML;
    }

    async function unassignVehicle(vehicleId) {
      if (!confirm('Remove this vehicle from the fleet?')) return;
      
      const token = localStorage.getItem("sb_access_token");
      if (!token) return;
      
      try {
        const assignment = vehicleFleetAssignments.find(a => a.vehicle_id === vehicleId && a.fleet_id === selectedFleetId);
        if (!assignment) return;
        
        await fetch(`${REST_BASE}/vehicle_fleet_assignments?assignment_id=eq.${assignment.assignment_id}`, {
          method: 'DELETE',
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        
        alert('Vehicle unassigned successfully!');
        await loadData();
      } catch(err) {
        console.error('Error unassigning vehicle:', err);
        alert('Error unassigning vehicle');
      }
    }

    // Update charts for selected fleet
    function updateFleetCharts(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      const fleetWorkOrders = workOrders.filter(wo => wo.fleet_id === fleetId);

      // Destroy existing charts
      if (costTrendChart) costTrendChart.destroy();
      if (topVehiclesChart) topVehiclesChart.destroy();
      if (maintenanceChart) maintenanceChart.destroy();

      // Group work orders by month for revenue trend
      const monthlyData = {};
      fleetWorkOrders.forEach(wo => {
        if (wo.scheduled_start && wo.total_price) {
          const date = new Date(wo.scheduled_start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
          monthlyData[monthKey] += parseFloat(wo.total_price) || 0;
        }
      });

      const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
      const monthLabels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
      });
      const monthRevenue = sortedMonths.map(m => monthlyData[m]);

      // Revenue Trend Chart
      costTrendChart = new Chart(document.getElementById('costTrendChart'), {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Revenue',
            data: monthRevenue,
            borderColor: fleet.color,
            backgroundColor: fleet.color + '20',
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: fleet.color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: fleet.color,
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (context) => '$' + context.parsed.y.toLocaleString()
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              border: { display: false },
              ticks: { 
                callback: value => '$' + (value/1000) + 'k',
                color: '#6b7280',
                font: { size: 11 }
              },
              grid: { color: '#1a2535', drawTicks: false }
            },
            x: {
              border: { display: false },
              ticks: { color: '#6b7280', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });

      // Work Order Volume by Month
      const monthlyWOCount = {};
      fleetWorkOrders.forEach(wo => {
        if (wo.scheduled_start) {
          const date = new Date(wo.scheduled_start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyWOCount[monthKey]) monthlyWOCount[monthKey] = 0;
          monthlyWOCount[monthKey]++;
        }
      });

      const woMonths = Object.keys(monthlyWOCount).sort().slice(-6);
      const woLabels = woMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
      });
      const woCounts = woMonths.map(m => monthlyWOCount[m]);

      topVehiclesChart = new Chart(document.getElementById('topVehiclesChart'), {
        type: 'bar',
        data: {
          labels: woLabels,
          datasets: [{
            label: 'Work Orders',
            data: woCounts,
            backgroundColor: fleet.color,
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: fleet.color,
              borderWidth: 1,
              padding: 12,
              displayColors: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              border: { display: false },
              ticks: { color: '#6b7280', font: { size: 11 } },
              grid: { color: '#1a2535', drawTicks: false }
            },
            x: {
              border: { display: false },
              ticks: { color: '#9fb0c3', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });

      // Fleet Distribution (all fleets)
      const fleetCounts = fleets.map(f => {
        return vehicleFleetAssignments.filter(a => a.fleet_id === f.fleet_id && a.is_active).length;
      });

      maintenanceChart = new Chart(document.getElementById('maintenanceTypeChart'), {
        type: 'doughnut',
        data: {
          labels: fleets.map(f => f.fleet_name),
          datasets: [{
            data: fleetCounts,
            backgroundColor: fleets.map(f => f.color),
            borderWidth: 0,
            hoverOffset: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: '#9fb0c3',
                padding: 15,
                font: { size: 12 },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: fleet.color,
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: (context) => context.label + ': ' + context.parsed + ' vehicles'
              }
            }
          }
        }
      });
    }

    // Modal functions
    function renderIconPicker() {
      const picker = document.getElementById('iconPicker');
      picker.innerHTML = Object.keys(SVG_ICONS).map(iconKey => `
        <div class="icon-option ${iconKey === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${iconKey}')">
          ${SVG_ICONS[iconKey]}
        </div>
      `).join('');
    }

    function selectIcon(icon) {
      selectedIcon = icon;
      renderIconPicker();
    }

    function openCreateModal() {
      currentFleetId = null;
      document.getElementById('modalTitle').textContent = 'Create New Fleet';
      document.getElementById('fleetForm').reset();
      document.getElementById('fleetColor').value = '#3b82f6';
      document.getElementById('colorPreview').style.background = '#3b82f6';
      selectedIcon = 'car';
      renderIconPicker();
      document.getElementById('fleetModal').classList.add('active');
    }

    function editCurrentFleet() {
      if (!selectedFleetId) return;
      const fleet = fleets.find(f => f.fleet_id === selectedFleetId);
      if (!fleet) return;

      currentFleetId = selectedFleetId;
      document.getElementById('modalTitle').textContent = 'Edit Fleet';
      document.getElementById('fleetName').value = fleet.fleet_name;
      document.getElementById('fleetDescription').value = fleet.description || '';
      document.getElementById('fleetColor').value = fleet.color;
      document.getElementById('colorPreview').style.background = fleet.color;
      selectedIcon = fleet.icon || 'car';
      renderIconPicker();
      document.getElementById('fleetModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('fleetModal').classList.remove('active');
    }

    async function saveFleet(event) {
      event.preventDefault();
      const token = localStorage.getItem("sb_access_token");
      if (!token) return;

      const fleetData = {
        fleet_name: document.getElementById('fleetName').value,
        description: document.getElementById('fleetDescription').value,
        color: document.getElementById('fleetColor').value,
        icon: selectedIcon,
        is_active: true
      };

      try {
        if (currentFleetId) {
          // Update existing fleet
          await fetch(`${REST_BASE}/fleets?fleet_id=eq.${currentFleetId}`, {
            method: 'PATCH',
            headers: {
              'apikey': ANON_KEY,
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(fleetData)
          });
          alert(`Fleet "${fleetData.fleet_name}" updated successfully!`);
        } else {
          // Create new fleet
          await fetch(`${REST_BASE}/fleets`, {
            method: 'POST',
            headers: {
              'apikey': ANON_KEY,
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(fleetData)
          });
          alert(`Fleet "${fleetData.fleet_name}" created successfully!`);
        }

        closeModal();
        await loadData();
      } catch (error) {
        console.error('Error saving fleet:', error);
        alert('Error saving fleet: ' + error.message);
      }
    }

    async function deleteCurrentFleet() {
      if (!selectedFleetId) return;
      const fleet = fleets.find(f => f.fleet_id === selectedFleetId);
      if (!fleet) return;
      
      if (!confirm(`Are you sure you want to delete "${fleet.fleet_name}"?\n\nThis will unassign all vehicles from this fleet.`)) return;

      const token = localStorage.getItem("sb_access_token");
      if (!token) return;

      try {
        // Delete fleet
        await fetch(`${REST_BASE}/fleets?fleet_id=eq.${selectedFleetId}`, {
          method: 'DELETE',
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        
        alert(`Fleet "${fleet.fleet_name}" deleted successfully!`);
        selectedFleetId = null;
        await loadData();
      } catch(err) {
        console.error('Error deleting fleet:', err);
        alert('Error deleting fleet: ' + err.message);
      }
    }

    // Color picker
    document.addEventListener('DOMContentLoaded', () => {
      const colorInput = document.getElementById('fleetColor');
      const colorPreview = document.getElementById('colorPreview');
      
      if (colorInput) {
        colorInput.addEventListener('input', (e) => {
          colorPreview.style.background = e.target.value;
        });
      }

      loadData();
    });

    // Close modal on background click
    document.getElementById('fleetModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'fleetModal') {
        closeModal();
      }
    });

    // Load data
    async function loadData() {
      const token = await validateAuth();
      if(!token) return location.replace("login.html");
      
      try {
        console.log('Loading fleet data from database...');
        
        fleets = await fetchTable("fleets", token);
        vehicles = await fetchTable("vehicles", token);
        vehicleFleetAssignments = await fetchTable("vehicle_fleet_assignments", token);
        workOrders = await fetchTable("work_orders", token);
        
        console.log(`Loaded ${fleets.length} fleets`);
        console.log(`Loaded ${vehicles.length} vehicles`);
        console.log(`Loaded ${vehicleFleetAssignments.length} assignments`);
        console.log(`Loaded ${workOrders.length} work orders`);
        
        renderFleetTabs();
        
        // Select first fleet by default
        if (fleets.length > 0) {
          selectFleet(fleets[0].fleet_id);
        }
      } catch(err) {
        console.error('Error loading fleet data:', err);
        alert('Error loading fleet data. Check console for details.');
      }
    }
  </script>
</body>
</html>
