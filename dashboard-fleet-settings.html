<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Management</title>
  <meta name="supabase-url" content="https://kxqkwpkmtgvmthpafoqx.supabase.co">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0ODE0MzIsImV4cCI6MjA0ODA1NzQzMn0.sG_vertrcVEw7NwfQRx9DUt5k2s3DkU2sKtLVyNjvk0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family:system-ui,-apple-system,sans-serif; 
      background:#0b0f14; 
      color:#e8eef6;
      min-height:100vh;
    }
    
    /* Scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #223044 #0f1621;
    }
    *::-webkit-scrollbar { width:10px; height:10px; }
    *::-webkit-scrollbar-track { background:#0f1621; }
    *::-webkit-scrollbar-thumb { background:#223044; border-radius:5px; }
    *::-webkit-scrollbar-thumb:hover { background:#2d3f56; }
    
    /* Mobile Header */
    .mobile-header {
      display:none;
      background:#0f1621;
      border-bottom:1px solid #223044;
      position:sticky;
      top:0;
      z-index:100;
    }
    
    .mobile-header-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
    }
    
    .mobile-menu-toggle {
      background:transparent;
      border:1px solid transparent;
      border-radius:6px;
      color:#6b7280;
      font-size:20px;
      padding:0;
      width:36px;
      height:36px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .mobile-menu-toggle:hover {
      background:rgba(59,130,246,0.1);
      border-color:#3b82f6;
      color:#3b82f6;
    }
    
    .mobile-header-title {
      font-size:18px;
      font-weight:600;
      margin-left:12px;
    }
    
    /* Desktop Header */
    .header {
      background:#0f1621;
      padding:20px 40px;
      border-bottom:1px solid #223044;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .header h1 {
      font-size:24px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:12px;
    }
    
    .back-link {
      color:#60a5fa;
      text-decoration:none;
      padding:10px 20px;
      border-radius:6px;
      background:#1e3a5f;
      transition:all 0.2s;
      font-size:14px;
    }
    
    .back-link:hover {
      background:#2d4a6f;
    }
    
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    
    /* Collapsible Section */
    .section {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:8px;
      margin-bottom:16px;
      overflow:hidden;
    }
    
    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      cursor:pointer;
      user-select:none;
      transition:background 0.2s;
    }
    
    .section-header:hover {
      background:#141824;
    }
    
    .section-title {
      font-size:18px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .section-icon {
      font-size:22px;
    }
    
    .section-toggle {
      font-size:20px;
      color:#6b7280;
      transition:transform 0.3s;
    }
    
    .section.collapsed .section-toggle {
      transform:rotate(-90deg);
    }
    
    .section-content {
      max-height:5000px;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }
    
    .section.collapsed .section-content {
      max-height:0;
    }
    
    .section-body {
      padding:20px;
      border-top:1px solid #223044;
    }
    
    /* Metrics Grid */
    .metrics-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }
    
    .metric-card {
      background:#1a2535;
      padding:20px;
      border-radius:8px;
      border:1px solid #223044;
      position:relative;
    }
    
    .metric-label {
      color:#9fb0c3;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:8px;
    }
    
    .metric-value {
      font-size:28px;
      font-weight:700;
      color:#fff;
      margin-bottom:4px;
    }
    
    .metric-change {
      font-size:12px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    
    .metric-change.up { color:#34d399; }
    .metric-change.down { color:#f87171; }
    .metric-icon {
      font-size:20px;
      position:absolute;
      top:16px;
      right:16px;
      opacity:0.3;
    }
    
    /* Charts Grid */
    .charts-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
      gap:16px;
    }
    
    .chart-card {
      background:#1a2535;
      padding:20px;
      border-radius:8px;
      border:1px solid #223044;
    }
    
    .chart-card h3 {
      font-size:15px;
      font-weight:600;
      margin-bottom:16px;
      color:#e8eef6;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .chart-container {
      position:relative;
      height:280px;
    }
    
    /* Fleet Management */
    .fleet-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    
    .create-fleet-btn {
      background:#3b82f6;
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      transition:all 0.2s;
    }
    
    .create-fleet-btn:hover {
      background:#2563eb;
    }
    
    .fleet-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:16px;
    }
    
    .fleet-card {
      background:#1a2535;
      border-radius:8px;
      padding:20px;
      border-left:4px solid #3b82f6;
      border:1px solid #223044;
      transition:all 0.2s;
    }
    
    .fleet-card:hover {
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    
    .fleet-card-header {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .fleet-icon {
      font-size:28px;
    }
    
    .fleet-name {
      font-size:18px;
      font-weight:600;
      flex:1;
    }
    
    .fleet-description {
      color:#9fb0c3;
      font-size:13px;
      margin-bottom:12px;
      line-height:1.4;
    }
    
    .fleet-count {
      color:#60a5fa;
      font-size:13px;
      margin-bottom:12px;
    }
    
    .fleet-actions {
      display:flex;
      gap:8px;
    }
    
    .fleet-btn {
      background:#1e3a5f;
      border:1px solid #3b82f6;
      color:#60a5fa;
      padding:6px 12px;
      border-radius:4px;
      cursor:pointer;
      font-size:12px;
      transition:all 0.2s;
    }
    
    .fleet-btn:hover {
      background:#2d4a6f;
    }
    
    .fleet-btn.delete {
      background:#3d1e1e;
      border-color:#ef4444;
      color:#f87171;
    }
    
    .fleet-btn.delete:hover {
      background:#4d2525;
    }
    
    /* Modal */
    .modal {
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.8);
      z-index:1000;
      overflow-y:auto;
    }
    
    .modal.active {
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    
    .modal-content {
      background:#0f1621;
      border-radius:12px;
      max-width:600px;
      width:100%;
      border:1px solid #223044;
    }
    
    .modal-header {
      padding:20px;
      border-bottom:1px solid #223044;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .modal-title {
      font-size:20px;
      font-weight:600;
    }
    
    .modal-close {
      background:transparent;
      border:none;
      color:#9fb0c3;
      font-size:24px;
      cursor:pointer;
      padding:0;
      width:32px;
      height:32px;
      border-radius:4px;
      transition:all 0.2s;
    }
    
    .modal-close:hover {
      background:#1a2535;
      color:#e8eef6;
    }
    
    .modal-body {
      padding:20px;
    }
    
    .form-group {
      margin-bottom:16px;
    }
    
    .form-label {
      display:block;
      color:#9fb0c3;
      font-size:13px;
      margin-bottom:6px;
      font-weight:600;
    }
    
    .form-input,
    .form-textarea {
      width:100%;
      background:#1a2535;
      border:1px solid #223044;
      color:#e8eef6;
      padding:10px;
      border-radius:6px;
      font-size:14px;
      font-family:inherit;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline:none;
      border-color:#3b82f6;
    }
    
    .form-textarea {
      resize:vertical;
      min-height:80px;
    }
    
    .color-picker-group {
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .color-preview {
      width:40px;
      height:40px;
      border-radius:6px;
      border:2px solid #223044;
    }
    
    .icon-picker {
      display:grid;
      grid-template-columns:repeat(8,1fr);
      gap:8px;
    }
    
    .icon-option {
      font-size:24px;
      padding:8px;
      border:2px solid transparent;
      border-radius:6px;
      cursor:pointer;
      text-align:center;
      transition:all 0.2s;
    }
    
    .icon-option:hover {
      background:#1a2535;
    }
    
    .icon-option.selected {
      border-color:#3b82f6;
      background:#1e3a5f;
    }
    
    .vehicle-list {
      max-height:250px;
      overflow-y:auto;
      border:1px solid #223044;
      border-radius:6px;
      padding:8px;
    }
    
    .vehicle-item {
      display:flex;
      align-items:center;
      padding:8px;
      border-radius:4px;
      transition:background 0.2s;
    }
    
    .vehicle-item:hover {
      background:#1a2535;
    }
    
    .vehicle-item input {
      margin-right:10px;
    }
    
    .vehicle-item-info {
      font-size:14px;
      cursor:pointer;
    }
    
    .modal-footer {
      padding:20px;
      border-top:1px solid #223044;
      display:flex;
      gap:12px;
      justify-content:flex-end;
    }
    
    .btn {
      padding:10px 20px;
      border-radius:6px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      border:none;
    }
    
    .btn-primary {
      background:#3b82f6;
      color:#fff;
    }
    
    .btn-primary:hover {
      background:#2563eb;
    }
    
    .btn-secondary {
      background:#1a2535;
      color:#9fb0c3;
      border:1px solid #223044;
    }
    
    .btn-secondary:hover {
      background:#243242;
    }
    
    .empty-state {
      text-align:center;
      padding:60px 20px;
      color:#6b7280;
    }
    
    .empty-state-icon {
      font-size:48px;
      margin-bottom:16px;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .header { display:none; }
      .mobile-header { display:block; }
      .container { padding:12px; }
      
      .section-header {
        padding:12px;
      }
      
      .section-title {
        font-size:16px;
      }
      
      .section-body {
        padding:12px;
      }
      
      .metrics-grid {
        grid-template-columns:repeat(2,1fr);
        gap:12px;
      }
      
      .metric-value {
        font-size:24px;
      }
      
      .charts-grid {
        grid-template-columns:1fr;
      }
      
      .fleet-grid {
        grid-template-columns:1fr;
      }
      
      .modal-content {
        margin:20px;
      }
      
      .icon-picker {
        grid-template-columns:repeat(6,1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="location.href='dashboard-scheduling.html'">‚Üê</button>
      <div class="mobile-header-title">‚öôÔ∏è Fleet Management</div>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="header">
    <h1>‚öôÔ∏è Fleet Management</h1>
    <a href="dashboard-scheduling.html" class="back-link">‚Üê Back to Scheduling</a>
  </div>

  <div class="container">
    <!-- Fleet Metrics Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">üìä</span>
          <span>Fleet Performance Metrics</span>
        </div>
        <div class="section-toggle">‚ñº</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-icon">üíµ</div>
              <div class="metric-label">Total Cost (30d)</div>
              <div class="metric-value">$<span id="totalCost">45,280</span></div>
              <div class="metric-change up">+8.2% vs last month</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-icon">üìä</div>
              <div class="metric-label">Avg Cost/Vehicle</div>
              <div class="metric-value">$<span id="avgCost">3,773</span></div>
              <div class="metric-change">Per 30 days</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-icon">üîß</div>
              <div class="metric-label">Avg Time in Shop</div>
              <div class="metric-value"><span id="avgDays">2.4</span> days</div>
              <div class="metric-change down">-15% vs last month</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-icon">‚úÖ</div>
              <div class="metric-label">Fleet Uptime</div>
              <div class="metric-value"><span id="uptime">94.2</span>%</div>
              <div class="metric-change up">+2.3% vs last month</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-icon">‚öôÔ∏è</div>
              <div class="metric-label">Preventive Maint. Ratio</div>
              <div class="metric-value"><span id="pmRatio">68</span>%</div>
              <div class="metric-change">Target: 70%</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-icon">üõ£Ô∏è</div>
              <div class="metric-label">Cost Per Mile</div>
              <div class="metric-value">$<span id="costPerMile">0.42</span></div>
              <div class="metric-change">Industry: $0.45</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">üìà</span>
          <span>Analytics & Trends</span>
        </div>
        <div class="section-toggle">‚ñº</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="charts-grid">
            <div class="chart-card">
              <h3>üìà Monthly Cost Trend</h3>
              <div class="chart-container">
                <canvas id="costTrendChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>üöó Top 5 Costliest Vehicles</h3>
              <div class="chart-container">
                <canvas id="topVehiclesChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>üîß Maintenance Type Breakdown</h3>
              <div class="chart-container">
                <canvas id="maintenanceTypeChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fleet Management Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">üöó</span>
          <span>Fleet Configuration</span>
        </div>
        <div class="section-toggle">‚ñº</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="fleet-header">
            <h3 style="font-size:16px; font-weight:600;">Your Fleets</h3>
            <button class="create-fleet-btn" onclick="openCreateModal()">+ Create Fleet</button>
          </div>
          <div class="fleet-grid" id="fleetGrid">
            <!-- Fleets populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fleet Modal -->
  <div class="modal" id="fleetModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Create Fleet</div>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <form id="fleetForm" onsubmit="saveFleet(event)">
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Fleet Name</label>
            <input type="text" class="form-input" id="fleetName" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="fleetDescription"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Color</label>
            <div class="color-picker-group">
              <input type="color" class="form-input" id="fleetColor" value="#3b82f6">
              <div class="color-preview" id="colorPreview" style="background:#3b82f6"></div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Icon</label>
            <div class="icon-picker" id="iconPicker">
              <!-- Icons populated here -->
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Assign Vehicles</label>
            <div class="vehicle-list" id="vehicleList">
              <!-- Vehicles populated here -->
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Fleet</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const REST_BASE = document.querySelector('meta[name="supabase-url"]').content + "/rest/v1";
    const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

    let fleets = [];
    let vehicles = [];
    let currentFleetId = null;
    let selectedIcon = 'üöó';

    const FLEET_ICONS = ['üöó', 'üöô', 'üöï', 'üöö', 'üöõ', 'üöê', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöå', 'üöú', 'üèóÔ∏è', '‚öôÔ∏è', 'üîß', 'üõ†Ô∏è'];

    // Mock data
    const fleetData = {
      monthlyTrend: [
        { month: 'Jul', cost: 38200 },
        { month: 'Aug', cost: 41500 },
        { month: 'Sep', cost: 39800 },
        { month: 'Oct', cost: 43200 },
        { month: 'Nov', cost: 42100 },
        { month: 'Dec', cost: 45280 }
      ],
      topVehicles: [
        { name: '2019 Ford F-150', cost: 8450 },
        { name: '2020 Chevy Silverado', cost: 6230 },
        { name: '2018 Ram 1500', cost: 5890 },
        { name: '2021 Honda Civic', cost: 3420 },
        { name: '2020 Toyota Camry', cost: 2980 }
      ],
      maintenanceTypes: [
        { type: 'Preventive', value: 68, color: '#34d399' },
        { type: 'Repairs', value: 24, color: '#fbbf24' },
        { type: 'Inspections', value: 8, color: '#60a5fa' }
      ]
    };

    // Toggle section
    function toggleSection(header) {
      header.parentElement.classList.toggle('collapsed');
    }

    // Load data
    async function loadData() {
      try {
        fleets = [
          { fleet_id: 'mock-1', fleet_name: 'Main Fleet', description: 'Primary service vehicles', color: '#3b82f6', icon: 'üöó', is_active: true, vehicle_count: 0 },
          { fleet_id: 'mock-2', fleet_name: 'Delivery', description: 'Delivery and pickup vehicles', color: '#34d399', icon: 'üöö', is_active: true, vehicle_count: 0 },
          { fleet_id: 'mock-3', fleet_name: 'Heavy Equipment', description: 'Large trucks and equipment', color: '#f59e0b', icon: 'üèóÔ∏è', is_active: true, vehicle_count: 0 }
        ];

        vehicles = [
          { id: 'v1', year: 2020, make: 'Honda', model: 'Civic', vin: 'MOCK123' },
          { id: 'v2', year: 2021, make: 'Toyota', model: 'Camry', vin: 'MOCK456' },
          { id: 'v3', year: 2019, make: 'Ford', model: 'F-150', vin: 'MOCK789' }
        ];

        renderFleets();
        renderIconPicker();
        renderCharts();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function renderFleets() {
      const grid = document.getElementById('fleetGrid');
      
      if (fleets.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üöó</div>
            <h3>No fleets yet</h3>
            <p>Create your first fleet to get started</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = fleets.map(fleet => `
        <div class="fleet-card" style="border-left-color:${fleet.color}">
          <div class="fleet-card-header">
            <div class="fleet-icon">${fleet.icon}</div>
            <div class="fleet-name">${fleet.fleet_name}</div>
          </div>
          <div class="fleet-description">${fleet.description || 'No description'}</div>
          <div class="fleet-count">${fleet.vehicle_count || 0} Vehicles</div>
          <div class="fleet-actions">
            <button class="fleet-btn" onclick="editFleet('${fleet.fleet_id}')">‚úèÔ∏è Edit</button>
            <button class="fleet-btn" onclick="manageVehicles('${fleet.fleet_id}')">üöó Vehicles</button>
            <button class="fleet-btn delete" onclick="deleteFleet('${fleet.fleet_id}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    }

    function renderIconPicker() {
      const picker = document.getElementById('iconPicker');
      picker.innerHTML = FLEET_ICONS.map(icon => `
        <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">${icon}</div>
      `).join('');
    }

    function selectIcon(icon) {
      selectedIcon = icon;
      renderIconPicker();
    }

    function openCreateModal() {
      currentFleetId = null;
      document.getElementById('fleetForm').reset();
      document.getElementById('colorPreview').style.background = '#3b82f6';
      selectedIcon = 'üöó';
      renderIconPicker();
      renderVehicleList();
      document.getElementById('fleetModal').classList.add('active');
    }

    function editFleet(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!fleet) return;

      currentFleetId = fleetId;
      document.getElementById('fleetName').value = fleet.fleet_name;
      document.getElementById('fleetDescription').value = fleet.description || '';
      document.getElementById('fleetColor').value = fleet.color;
      document.getElementById('colorPreview').style.background = fleet.color;
      selectedIcon = fleet.icon;
      renderIconPicker();
      renderVehicleList(fleetId);
      document.getElementById('fleetModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('fleetModal').classList.remove('active');
    }

    async function renderVehicleList(fleetId = null) {
      const list = document.getElementById('vehicleList');
      let assignments = [];

      list.innerHTML = vehicles.map(v => {
        const vehicleId = v.id || v.vehicle_id;
        const isAssigned = assignments.some(a => a.vehicle_id === vehicleId);
        return `
          <div class="vehicle-item">
            <input type="checkbox" value="${vehicleId}" ${isAssigned ? 'checked' : ''} id="vehicle_${vehicleId}">
            <label for="vehicle_${vehicleId}" class="vehicle-item-info">
              ${v.year} ${v.make} ${v.model}
            </label>
          </div>
        `;
      }).join('');
    }

    async function saveFleet(event) {
      event.preventDefault();

      const fleetData = {
        fleet_id: currentFleetId || 'mock-fleet-' + Date.now(),
        fleet_name: document.getElementById('fleetName').value,
        description: document.getElementById('fleetDescription').value,
        color: document.getElementById('fleetColor').value,
        icon: selectedIcon,
        is_active: true,
        vehicle_count: 0
      };

      try {
        if (currentFleetId) {
          const index = fleets.findIndex(f => f.fleet_id === currentFleetId);
          if (index !== -1) {
            fleets[index] = { ...fleets[index], ...fleetData };
          }
        } else {
          fleets.push(fleetData);
        }

        const selectedVehicles = Array.from(document.querySelectorAll('#vehicleList input:checked'))
          .map(input => input.value);
        
        const fleet = fleets.find(f => f.fleet_id === fleetData.fleet_id);
        if (fleet) {
          fleet.vehicle_count = selectedVehicles.length;
        }

        alert(`‚úÖ Fleet "${fleetData.fleet_name}" saved successfully!`);
        closeModal();
        renderFleets();
      } catch (error) {
        console.error('Error saving fleet:', error);
        alert('Error saving fleet: ' + error.message);
      }
    }

    async function deleteFleet(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!confirm(`Are you sure you want to delete "${fleet?.fleet_name}"?`)) return;

      try {
        const index = fleets.findIndex(f => f.fleet_id === fleetId);
        if (index !== -1) {
          fleets.splice(index, 1);
        }
        renderFleets();
      } catch (error) {
        console.error('Error deleting fleet:', error);
        alert('Error deleting fleet');
      }
    }

    function manageVehicles(fleetId) {
      editFleet(fleetId);
    }

    function renderCharts() {
      // Cost Trend Chart
      new Chart(document.getElementById('costTrendChart'), {
        type: 'line',
        data: {
          labels: fleetData.monthlyTrend.map(d => d.month),
          datasets: [{
            label: 'Fleet Cost',
            data: fleetData.monthlyTrend.map(d => d.cost),
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96, 165, 250, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: value => '$' + value.toLocaleString(), color: '#9fb0c3' },
              grid: { color: '#223044' }
            },
            x: {
              ticks: { color: '#9fb0c3' },
              grid: { display: false }
            }
          }
        }
      });

      // Top Vehicles Chart
      new Chart(document.getElementById('topVehiclesChart'), {
        type: 'bar',
        data: {
          labels: fleetData.topVehicles.map(v => v.name),
          datasets: [{
            label: 'Cost',
            data: fleetData.topVehicles.map(v => v.cost),
            backgroundColor: ['#ef4444', '#f59e0b', '#fbbf24', '#34d399', '#60a5fa']
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              ticks: { callback: value => '$' + value.toLocaleString(), color: '#9fb0c3' },
              grid: { color: '#223044' }
            },
            y: {
              ticks: { color: '#9fb0c3' },
              grid: { display: false }
            }
          }
        }
      });

      // Maintenance Type Chart
      new Chart(document.getElementById('maintenanceTypeChart'), {
        type: 'doughnut',
        data: {
          labels: fleetData.maintenanceTypes.map(t => t.type),
          datasets: [{
            data: fleetData.maintenanceTypes.map(t => t.value),
            backgroundColor: fleetData.maintenanceTypes.map(t => t.color),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#e8eef6', padding: 15 }
            }
          }
        }
      });
    }

    // Color picker
    document.addEventListener('DOMContentLoaded', () => {
      const colorInput = document.getElementById('fleetColor');
      const colorPreview = document.getElementById('colorPreview');
      
      if (colorInput) {
        colorInput.addEventListener('input', (e) => {
          colorPreview.style.background = e.target.value;
        });
      }

      loadData();
    });

    // Close modal on background click
    document.getElementById('fleetModal').addEventListener('click', (e) => {
      if (e.target.id === 'fleetModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
