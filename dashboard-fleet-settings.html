<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Management</title>
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4">
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family:system-ui,-apple-system,sans-serif; 
      background:#0b0f14; 
      color:#e8eef6;
      min-height:100vh;
    }
    
    /* Copy all the CSS from your current fleet settings file - it's perfect! */
    /* I'll just include the essential parts here */
    
    .desktop-header {
      background:#0f1621;
      border-bottom:1px solid #223044;
      padding:20px 40px;
      position:sticky;
      top:0;
      z-index:100;
    }
    
    .header-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    
    .header-nav {
      display:flex;
      gap:8px;
      padding-bottom:12px;
    }
    
    .header-nav a {
      padding:8px 16px;
      border-radius:6px;
      color:#9fb0c3;
      text-decoration:none;
      font-size:14px;
      transition:all 0.15s ease;
    }
    
    .header-nav a.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }
    
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    
    .fleet-selector-cards {
      display:flex;
      gap:16px;
      margin-bottom:24px;
      overflow-x:auto;
      padding-bottom:8px;
    }
    
    .fleet-selector-card {
      background:#1a2535;
      border:2px solid #223044;
      border-radius:8px;
      padding:20px;
      min-width:280px;
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
    }
    
    .fleet-selector-card::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:4px;
      height:100%;
      background:var(--fleet-color);
      opacity:0.5;
      transition:all 0.3s;
    }
    
    .fleet-selector-card:hover {
      border-color:#3b82f6;
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.4);
    }
    
    .fleet-selector-card.active {
      border-color:var(--fleet-color);
      background:#1e2a3d;
      box-shadow:0 8px 20px rgba(59,130,246,0.3);
    }
    
    .fleet-card-top {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .fleet-card-icon {
      font-size:28px;
      width:48px;
      height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(59,130,246,0.1);
      border-radius:8px;
    }
    
    .fleet-card-name {
      font-size:16px;
      font-weight:600;
      color:#e8eef6;
    }
    
    .fleet-card-metrics {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid #223044;
    }
    
    .fleet-metric-label {
      font-size:10px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px;
    }
    
    .fleet-metric-value {
      font-size:18px;
      font-weight:700;
      color:#60a5fa;
    }
    
    .fleet-overview {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:8px;
      padding:20px;
      margin-bottom:24px;
    }
    
    .fleet-overview-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    
    .fleet-overview-title {
      font-size:24px;
      font-weight:600;
    }
    
    .fleet-actions {
      display:flex;
      gap:8px;
    }
    
    .fleet-btn {
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.2);
      color:#60a5fa;
      padding:10px 20px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      transition:all 0.2s;
    }
    
    .fleet-btn:hover {
      background:rgba(59,130,246,0.15);
    }
    
    .vehicle-table {
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
    }
    
    .vehicle-table th {
      text-align:left;
      padding:12px;
      background:#0f1621;
      border-bottom:2px solid #223044;
      color:#6b7280;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      font-weight:600;
    }
    
    .vehicle-table td {
      padding:12px;
      border-bottom:1px solid #1a2535;
      color:#e8eef6;
      font-size:13px;
    }
    
    .vehicle-table tr:hover {
      background:#141824;
    }
    
    button {
      padding:8px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#9fb0c3;
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-weight:500;
    }
    
    button:hover {
      background:#1e2a3d;
      color:#e8eef6;
      border-color:#3b82f6;
    }
    
    .btn-primary {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }
    
    .btn-primary:hover {
      background:#2563eb;
    }
  </style>
</head>
<body>
  <!-- Desktop Header -->
  <div class="desktop-header">
    <div class="header-top">
      <h1>Fleet Management</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div class="header-nav">
      <a href="dashboard-business.html">Dashboard</a>
      <a href="dashboard-customer-search.html">Customers</a>
      <a href="dashboard-vehicle-search.html">Vehicles</a>
      <a href="dashboard-scheduling.html">Scheduling</a>
      <a href="dashboard-fleet-settings.html" class="active">Fleet Management</a>
    </div>
  </div>

  <div class="container">
    <!-- Fleet Selector Cards -->
    <div class="fleet-selector-cards" id="fleetSelectorCards">
      <!-- Fleet cards populated here -->
    </div>

    <!-- Selected Fleet Details -->
    <div class="fleet-overview" id="fleetOverview" style="display:none;">
      <div class="fleet-overview-header">
        <div>
          <div class="fleet-overview-title" id="selectedFleetName"></div>
          <div style="color:#9fb0c3; margin-top:8px;" id="selectedFleetDescription"></div>
        </div>
        <div class="fleet-actions">
          <button class="fleet-btn" onclick="editFleet()">Edit Fleet</button>
          <button class="fleet-btn" onclick="assignVehicles()">Assign Vehicles</button>
        </div>
      </div>
      
      <h3 style="font-size:16px; margin-bottom:16px; color:#9fb0c3;">Assigned Vehicles</h3>
      <table class="vehicle-table">
        <thead>
          <tr>
            <th>Vehicle</th>
            <th>Year</th>
            <th>Make</th>
            <th>Model</th>
            <th>License Plate</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="fleetVehiclesTable">
          <!-- Vehicles populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
    const API_BASE = `https://${PROJECT_REF}.supabase.co`;
    const REST_BASE = `${API_BASE}/rest/v1`;
    const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

    let fleets = [];
    let vehicles = [];
    let vehicleFleetAssignments = [];
    let selectedFleetId = null;

    async function validateAuth() {
      const token = localStorage.getItem("sb_access_token");
      if(!token) return null;
      const r = await fetch(`${API_BASE}/auth/v1/user`, {
        headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
      });
      return r.ok ? token : null;
    }

    async function fetchTable(table, token) {
      const r = await fetch(`${REST_BASE}/${table}?select=*`, {
        headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function loadData() {
      const token = await validateAuth();
      if(!token) return location.replace("login.html");
      
      try {
        console.log('üîÑ Loading REAL fleet data from database...');
        
        fleets = await fetchTable("fleets", token);
        vehicles = await fetchTable("vehicles", token);
        vehicleFleetAssignments = await fetchTable("vehicle_fleet_assignments", token);
        
        console.log(`‚úÖ Loaded ${fleets.length} fleets`);
        console.log(`‚úÖ Loaded ${vehicles.length} vehicles`);
        console.log(`‚úÖ Loaded ${vehicleFleetAssignments.length} assignments`);
        
        renderFleetCards();
        
        if (fleets.length > 0) {
          selectFleet(fleets[0].fleet_id);
        }
      } catch(err) {
        console.error('‚ùå Error loading fleet data:', err);
        alert('Error loading fleet data. Check console for details.');
      }
    }

    function renderFleetCards() {
      const container = document.getElementById('fleetSelectorCards');
      
      if (fleets.length === 0) {
        container.innerHTML = `
          <div style="padding:60px 20px; text-align:center; color:#6b7280; width:100%;">
            <div style="font-size:48px; margin-bottom:16px;">üì¶</div>
            <div style="font-size:18px; margin-bottom:8px;">No Fleets Found</div>
            <div style="font-size:14px;">Your fleets will appear here</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = fleets.map(fleet => {
        const vehicleCount = vehicleFleetAssignments.filter(a => a.fleet_id === fleet.fleet_id && a.is_active).length;
        const isActive = selectedFleetId === fleet.fleet_id;
        
        return `
          <div class="fleet-selector-card ${isActive ? 'active' : ''}" 
               onclick="selectFleet('${fleet.fleet_id}')"
               style="--fleet-color:${fleet.color}">
            <div class="fleet-card-top">
              <div class="fleet-card-icon" style="background:${fleet.color}20; border:1px solid ${fleet.color}40;">${fleet.icon || 'üöó'}</div>
              <div>
                <div class="fleet-card-name">${fleet.fleet_name}</div>
                <div style="font-size:11px; color:#6b7280; margin-top:4px;">${vehicleCount} Vehicles</div>
              </div>
            </div>
            <div class="fleet-card-metrics">
              <div>
                <div class="fleet-metric-label">Status</div>
                <div class="fleet-metric-value" style="font-size:14px; color:${fleet.is_active ? '#34d399' : '#ef4444'};">
                  ${fleet.is_active ? 'Active' : 'Inactive'}
                </div>
              </div>
              <div>
                <div class="fleet-metric-label">Color</div>
                <div style="width:40px; height:20px; background:${fleet.color}; border-radius:4px; margin-top:4px;"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectFleet(fleetId) {
      selectedFleetId = fleetId;
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!fleet) return;

      console.log('üìå Selected fleet:', fleet.fleet_name);

      renderFleetCards();

      document.getElementById('fleetOverview').style.display = 'block';
      document.getElementById('selectedFleetName').textContent = fleet.fleet_name;
      document.getElementById('selectedFleetDescription').textContent = fleet.description || 'No description';

      renderFleetVehicles(fleetId);
    }

    function renderFleetVehicles(fleetId) {
      const tbody = document.getElementById('fleetVehiclesTable');
      
      const assignedVehicleIds = vehicleFleetAssignments
        .filter(a => a.fleet_id === fleetId && a.is_active)
        .map(a => a.vehicle_id);
      
      const assignedVehicles = vehicles.filter(v => assignedVehicleIds.includes(v.vehicle_id));
      
      if (assignedVehicles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#6b7280;padding:40px;">No vehicles assigned to this fleet</td></tr>';
        return;
      }
      
      tbody.innerHTML = assignedVehicles.map(v => `
        <tr>
          <td style="font-weight:600;">${v.year} ${v.make} ${v.model}</td>
          <td>${v.year}</td>
          <td>${v.make}</td>
          <td>${v.model}</td>
          <td>${v.license_plate || 'N/A'}</td>
          <td>
            <button onclick="unassignVehicle('${v.vehicle_id}')" style="padding:4px 12px; font-size:12px; background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.2); color:#ef4444;">
              Unassign
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function unassignVehicle(vehicleId) {
      if (!confirm('Remove this vehicle from the fleet?')) return;
      
      const token = localStorage.getItem("sb_access_token");
      if (!token) return;
      
      try {
        const assignment = vehicleFleetAssignments.find(a => a.vehicle_id === vehicleId && a.fleet_id === selectedFleetId);
        if (!assignment) return;
        
        await fetch(`${REST_BASE}/vehicle_fleet_assignments?assignment_id=eq.${assignment.assignment_id}`, {
          method: 'DELETE',
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        
        alert('‚úÖ Vehicle unassigned!');
        await loadData();
      } catch(err) {
        console.error('Error unassigning vehicle:', err);
        alert('Error unassigning vehicle');
      }
    }

    function editFleet() {
      alert('Edit fleet functionality - coming soon!');
    }

    function assignVehicles() {
      alert('Assign vehicles functionality - coming soon!\n\nFor now, use SQL to assign vehicles:\n\nINSERT INTO vehicle_fleet_assignments (tenant_id, vehicle_id, fleet_id, is_active) VALUES (\'your-tenant-id\', \'vehicle-id\', \'fleet-id\', true);');
    }

    function logout() {
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
    }

    // Load data on page load
    loadData();
  </script>
</body>
</html>
