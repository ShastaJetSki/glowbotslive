<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Management</title>
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { 
      font-family:system-ui,-apple-system,sans-serif; 
      background:#0b0f14; 
      color:#e8eef6;
      min-height:100vh;
    }
    
    /* Scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #223044 #0f1621;
    }
    *::-webkit-scrollbar { width:10px; height:10px; }
    *::-webkit-scrollbar-track { background:#0f1621; }
    *::-webkit-scrollbar-thumb { background:#223044; border-radius:5px; }
    *::-webkit-scrollbar-thumb:hover { background:#2d3f56; }
    
    /* Mobile Header */
    .mobile-header {
      display:none;
      background:#0f1621;
      border-bottom:1px solid #223044;
      position:sticky;
      top:0;
      z-index:100;
    }

    .mobile-header-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px;
    }

    .mobile-menu-toggle {
      background:transparent;
      border:1px solid transparent;
      border-radius:6px;
      color:#6b7280;
      font-size:20px;
      padding:0;
      width:36px;
      height:36px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }

    .mobile-menu-toggle:hover {
      background:rgba(59,130,246,0.1);
      border-color:#3b82f6;
      color:#3b82f6;
    }

    .mobile-header-center {
      flex:1;
      margin-left:12px;
    }

    .mobile-header-title {
      font-size:18px;
      font-weight:600;
    }

    .mobile-header-subtitle {
      font-size:12px;
      color:#9fb0c3;
      margin-top:2px;
    }

    .mobile-header-content {
      max-height:0;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }

    .mobile-header-content.open {
      max-height:500px;
    }

    .mobile-header-nav {
      padding:8px 12px;
      border-bottom:1px solid #223044;
    }

    .mobile-header-nav a {
      display:block;
      padding:12px;
      color:#9fb0c3;
      text-decoration:none;
      border-radius:6px;
      transition:all 0.15s ease;
      font-size:15px;
    }

    .mobile-header-nav a:hover {
      background:#1a2535;
      color:#e8eef6;
    }

    .mobile-header-nav a.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .mobile-header-actions {
      padding:12px;
      display:flex;
      gap:8px;
    }

    .mobile-header-actions button {
      flex:1;
      padding:10px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#9fb0c3;
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s ease;
    }

    .mobile-header-actions button:hover {
      background:#1e2a3d;
      color:#e8eef6;
    }

    /* Desktop Header */
    .desktop-header {
      display:block;
      background:#0f1621;
      border-bottom:1px solid #223044;
      padding:20px 40px;
      position:sticky;
      top:0;
      z-index:100;
    }

    .header-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .header-top h1 {
      font-size:24px;
      font-weight:600;
      color:#e8eef6;
    }

    .header-nav {
      display:flex;
      gap:8px;
      padding-bottom:12px;
    }

    .header-nav a {
      padding:8px 16px;
      border-radius:6px;
      color:#9fb0c3;
      text-decoration:none;
      font-size:14px;
      transition:all 0.15s ease;
    }

    .header-nav a:hover {
      background:#1a2535;
      color:#e8eef6;
    }

    .header-nav a.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .header-actions {
      display:flex;
      gap:16px;
      justify-content:space-between;
      align-items:center;
      padding-top:12px;
      border-top:1px solid #223044;
    }
    
    .view-tabs-header {
      display:flex;
      gap:4px;
      background:#0f1621;
      padding:4px;
      border-radius:8px;
      border:1px solid #223044;
    }
    
    .view-tab {
      padding:8px 16px;
      border-radius:6px;
      color:#9fb0c3;
      font-size:13px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-weight:500;
      user-select:none;
    }
    
    .view-tab:hover {
      background:#1a2535;
      color:#e8eef6;
    }
    
    .view-tab.active {
      background:#1e3a5f;
      color:#60a5fa;
      font-weight:600;
    }

    .header-actions button {
      padding:8px 16px;
      background:#1a2535;
      border:1px solid #223044;
      border-radius:6px;
      color:#9fb0c3;
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s ease;
      font-weight:500;
    }

    .header-actions button:hover {
      background:#1e2a3d;
      color:#e8eef6;
      border-color:#3b82f6;
    }
    
    .header-actions .fleet-btn-active {
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }
    
    .header-actions .fleet-btn-active:hover {
      background:#2563eb;
      border-color:#2563eb;
    }
    
    .container {
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    
    /* Fleet Selector Cards */
    .fleet-selector-cards {
      display:flex;
      gap:16px;
      margin-bottom:24px;
      overflow-x:auto;
      padding-bottom:8px;
    }
    
    .fleet-cards-grid {
      display:flex;
      gap:16px;
      flex:1;
    }
    
    .fleet-selector-card {
      background:#1a2535;
      border:2px solid #223044;
      border-radius:8px;
      padding:20px;
      min-width:280px;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
    }
    
    .fleet-selector-card::before {
      content:'';
      position:absolute;
      top:0;
      left:0;
      width:4px;
      height:100%;
      background:var(--fleet-color);
      opacity:0.5;
      transition:all 0.3s;
    }
    
    .fleet-selector-card:hover {
      border-color:#3b82f6;
      transform:translateY(-4px);
      box-shadow:0 8px 16px rgba(0,0,0,0.4);
    }
    
    .fleet-selector-card:hover::before {
      width:8px;
      opacity:1;
    }
    
    .fleet-selector-card.active {
      border-color:var(--fleet-color);
      background:#1e2a3d;
      box-shadow:0 8px 20px rgba(59,130,246,0.3);
    }
    
    .fleet-selector-card.active::before {
      width:100%;
      opacity:0.08;
    }
    
    .fleet-card-top {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .fleet-card-icon {
      font-size:28px;
      width:48px;
      height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(59,130,246,0.1);
      border-radius:8px;
      border:1px solid rgba(59,130,246,0.2);
    }
    
    .fleet-selector-card.active .fleet-card-icon {
      background:var(--fleet-color);
      background:linear-gradient(135deg, var(--fleet-color) 0%, rgba(0,0,0,0.2) 100%);
      border-color:var(--fleet-color);
    }
    
    .fleet-card-title {
      flex:1;
    }
    
    .fleet-card-name {
      font-size:16px;
      font-weight:600;
      color:#e8eef6;
      margin-bottom:4px;
    }
    
    .fleet-card-subtitle {
      font-size:11px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .fleet-card-metrics {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid #223044;
    }
    
    .fleet-metric {
      text-align:left;
    }
    
    .fleet-metric-label {
      font-size:10px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px;
      font-weight:600;
    }
    
    .fleet-metric-value {
      font-size:18px;
      font-weight:700;
      color:#60a5fa;
      letter-spacing:-0.5px;
    }
    
    .fleet-selector-card.active .fleet-metric-value {
      color:var(--fleet-color);
    }
    
    .add-fleet-card {
      background:#1a2535;
      border:1px solid #223044;
      border-radius:8px;
      padding:20px;
      min-width:140px;
      cursor:pointer;
      transition:all 0.3s;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:#9fb0c3;
    }
    
    .add-fleet-card:hover {
      background:#1e2a3d;
      border-color:#3b82f6;
      color:#e8eef6;
      transform:translateY(-4px);
    }
    
    .add-fleet-icon {
      font-size:32px;
      font-weight:300;
    }
    
    .add-fleet-text {
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    /* Fleet Overview */
    .fleet-overview {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:24px;
      padding-bottom:16px;
      border-bottom:1px solid #223044;
    }
    
    .fleet-meta {
      flex:1;
    }
    
    .fleet-description-text {
      color:#9fb0c3;
      font-size:14px;
      margin-bottom:8px;
    }
    
    .fleet-vehicle-count {
      color:#60a5fa;
      font-size:13px;
      font-weight:600;
    }
    
    .fleet-actions-top {
      display:flex;
      gap:8px;
    }
    
    .fleet-actions-top .fleet-btn {
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.2);
      color:#60a5fa;
      padding:10px 20px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      transition:all 0.2s;
    }
    
    .fleet-actions-top .fleet-btn:hover {
      background:rgba(59,130,246,0.15);
      border-color:rgba(59,130,246,0.4);
    }
    
    .fleet-actions-top .fleet-btn.delete {
      background:rgba(239,68,68,0.1);
      border-color:rgba(239,68,68,0.2);
      color:#ef4444;
    }
    
    .fleet-actions-top .fleet-btn.delete:hover {
      background:rgba(239,68,68,0.15);
      border-color:rgba(239,68,68,0.4);
    }
    
    /* Vehicle Stats Table */
    .vehicle-stats-table {
      margin-top:16px;
    }
    
    .vehicle-stats-table h4 {
      font-size:14px;
      font-weight:600;
      margin-bottom:12px;
      color:#9fb0c3;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .vehicle-table {
      width:100%;
      border-collapse:collapse;
    }
    
    .vehicle-table th {
      text-align:left;
      padding:12px;
      background:#0f1621;
      border-bottom:2px solid #223044;
      color:#6b7280;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      font-weight:600;
    }
    
    .vehicle-table td {
      padding:12px;
      border-bottom:1px solid #1a2535;
      color:#e8eef6;
      font-size:13px;
    }
    
    .vehicle-table tr:hover {
      background:#141824;
    }
    
    .vehicle-name {
      font-weight:600;
      color:#e8eef6;
    }
    
    /* Collapsible Section */
    .section {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:8px;
      margin-bottom:16px;
      overflow:hidden;
    }
    
    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      cursor:pointer;
      user-select:none;
      transition:background 0.2s;
    }
    
    .section-header:hover {
      background:#141824;
    }
    
    .section-title {
      font-size:18px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .section-icon {
      font-size:22px;
    }
    
    .section-toggle {
      font-size:20px;
      color:#6b7280;
      transition:transform 0.3s;
    }
    
    .section.collapsed .section-toggle {
      transform:rotate(-90deg);
    }
    
    .section-content {
      max-height:5000px;
      overflow:hidden;
      transition:max-height 0.3s ease;
    }
    
    .section.collapsed .section-content {
      max-height:0;
    }
    
    .section-body {
      padding:20px;
      border-top:1px solid #223044;
    }
    
    /* Metrics Grid */
    .metrics-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }
    
    .metric-card {
      background:#1a2535;
      padding:20px;
      border-radius:8px;
      border:1px solid #223044;
      border-left:3px solid #3b82f6;
      transition:all 0.2s;
    }
    
    .metric-card:hover {
      border-left-color:#60a5fa;
      background:#1e2a3d;
    }
    
    .metric-label {
      color:#6b7280;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      margin-bottom:10px;
      font-weight:600;
    }
    
    .metric-value {
      font-size:32px;
      font-weight:700;
      color:#e8eef6;
      margin-bottom:6px;
      letter-spacing:-0.5px;
    }
    
    .metric-change {
      font-size:11px;
      display:flex;
      align-items:center;
      gap:4px;
      font-weight:500;
    }
    
    .metric-change.up { color:#34d399; }
    .metric-change.down { color:#f87171; }
    
    /* Charts Grid */
    .charts-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
    }
    
    .chart-card {
      background:#141824;
      padding:20px;
      border-radius:8px;
      border:1px solid #1a2535;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    
    .chart-card h3 {
      font-size:13px;
      font-weight:600;
      margin-bottom:16px;
      color:#9fb0c3;
      display:flex;
      align-items:center;
      gap:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .chart-container {
      position:relative;
      height:240px;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .desktop-header { display:none; }
      .mobile-header { display:block; }
      .container { padding:12px; }
      
      .fleet-selector-cards {
        flex-direction:column;
        overflow-x:visible;
      }
      
      .fleet-cards-grid {
        flex-direction:column;
      }
      
      .fleet-selector-card {
        min-width:100%;
      }
      
      .add-fleet-card {
        min-width:100%;
      }
      
      .charts-grid {
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Fleet Management</div>
        <div class="mobile-header-subtitle" id="mobileFleetSubtitle">Loading...</div>
      </div>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html">Scheduling</a>
        <a href="dashboard-fleet-settings.html" class="active">Fleet Management</a>
      </div>
      <div class="mobile-header-actions">
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="desktop-header">
    <div class="header-top">
      <h1>Fleet Management</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div class="header-nav">
      <a href="dashboard-business.html">Dashboard</a>
      <a href="dashboard-customer-search.html">Customers</a>
      <a href="dashboard-vehicle-search.html">Vehicles</a>
      <a href="dashboard-scheduling.html">Scheduling</a>
      <a href="dashboard-fleet-settings.html" class="active">Fleet Management</a>
    </div>
    
    <div class="header-actions">
      <div class="view-tabs-header" id="desktopFleetButtons">
        <!-- Fleet buttons populated here -->
      </div>
      
      <div style="display:flex; gap:8px;">
        <button onclick="goToSettings()">Settings</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Fleet Selector Cards -->
    <div class="fleet-selector-cards">
      <div class="fleet-cards-grid" id="fleetSelectorCards">
        <!-- Fleet selector cards populated here -->
      </div>
    </div>

    <!-- Selected Fleet Card -->
    <div class="section" id="fleetCardSection">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon" id="selectedFleetIcon">‚ñ£</span>
          <span id="selectedFleetName">Select a Fleet</span>
        </div>
        <div class="section-toggle">‚ñº</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="fleet-overview">
            <div class="fleet-meta">
              <div class="fleet-description-text" id="selectedFleetDescription"></div>
              <div class="fleet-vehicle-count" id="selectedFleetVehicleCount"></div>
            </div>
            <div class="fleet-actions-top">
              <button class="fleet-btn" onclick="viewScheduling()">View in Scheduling</button>
            </div>
          </div>
          
          <!-- Vehicle List -->
          <div class="vehicle-stats-table">
            <h4>Assigned Fleet Vehicles</h4>
            <table class="vehicle-table">
              <thead>
                <tr>
                  <th>Vehicle</th>
                  <th>Year</th>
                  <th>License Plate</th>
                  <th>VIN</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="fleetVehiclesTable">
                <!-- Vehicles populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Fleet Metrics Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">‚ñ£</span>
          <span>Performance Metrics</span>
        </div>
        <div class="section-toggle">‚ñº</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="metrics-grid" id="fleetMetrics">
            <!-- Metrics populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title">
          <span class="section-icon">‚óß</span>
          <span>Analytics & Trends</span>
        </div>
        <div class="section-toggle">‚ñº</div>
      </div>
      <div class="section-content">
        <div class="section-body">
          <div class="charts-grid">
            <div class="chart-card">
              <h3>‚ñ¨ Monthly Revenue Trend</h3>
              <div class="chart-container">
                <canvas id="costTrendChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>‚ñ• Work Order Volume</h3>
              <div class="chart-container">
                <canvas id="topVehiclesChart"></canvas>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>‚óâ Fleet Distribution</h3>
              <div class="chart-container">
                <canvas id="maintenanceTypeChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
    const API_BASE = `https://${PROJECT_REF}.supabase.co`;
    const REST_BASE = `${API_BASE}/rest/v1`;
    const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

    let fleets = [];
    let vehicles = [];
    let vehicleFleetAssignments = [];
    let workOrders = [];
    let selectedFleetId = null;
    let costTrendChart, topVehiclesChart, maintenanceChart;

    // Toggle section
    function toggleSection(header) {
      header.parentElement.classList.toggle('collapsed');
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      const content = document.getElementById('mobileHeaderContent');
      content.classList.toggle('open');
    }

    // Navigation functions
    function logout() {
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
    }

    function goToSettings() {
      location.href = "dashboard-settings.html";
    }
    
    function viewScheduling() {
      location.href = "dashboard-scheduling.html";
    }

    async function validateAuth() {
      const token = localStorage.getItem("sb_access_token");
      if(!token) return null;
      const r = await fetch(`${API_BASE}/auth/v1/user`, {
        headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
      });
      return r.ok ? token : null;
    }

    async function fetchTable(table, token) {
      const r = await fetch(`${REST_BASE}/${table}?select=*`, {
        headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // Render fleet selector cards
    function renderFleetTabs() {
      const container = document.getElementById('fleetSelectorCards');
      
      if (fleets.length === 0) {
        container.innerHTML = `
          <div style="padding:60px 20px; text-align:center; color:#6b7280; width:100%;">
            <div style="font-size:48px; margin-bottom:16px;">üì¶</div>
            <div style="font-size:18px; margin-bottom:8px;">No Fleets Found</div>
            <div style="font-size:14px;">Fleets created in SQL will appear here</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = fleets.map(fleet => {
        const vehicleCount = vehicleFleetAssignments.filter(a => a.fleet_id === fleet.fleet_id && a.is_active).length;
        const isActive = selectedFleetId === fleet.fleet_id;
        
        // Count work orders for this fleet
        const woCount = workOrders.filter(wo => wo.fleet_id === fleet.fleet_id).length;
        
        return `
          <div class="fleet-selector-card ${isActive ? 'active' : ''}" 
               onclick="selectFleet('${fleet.fleet_id}')"
               style="--fleet-color:${fleet.color}">
            <div class="fleet-card-top">
              <div class="fleet-card-icon">${fleet.icon || 'üöó'}</div>
              <div class="fleet-card-title">
                <div class="fleet-card-name">${fleet.fleet_name}</div>
                <div class="fleet-card-subtitle">${vehicleCount} Vehicles</div>
              </div>
            </div>
            <div class="fleet-card-metrics">
              <div class="fleet-metric">
                <div class="fleet-metric-label">Work Orders</div>
                <div class="fleet-metric-value">${woCount}</div>
              </div>
              <div class="fleet-metric">
                <div class="fleet-metric-label">Status</div>
                <div class="fleet-metric-value" style="font-size:14px; color:${fleet.is_active ? '#34d399' : '#ef4444'};">
                  ${fleet.is_active ? 'Active' : 'Inactive'}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Also render header buttons
      const headerButtons = document.getElementById('desktopFleetButtons');
      if (headerButtons) {
        headerButtons.innerHTML = fleets.map(fleet => {
          const isActive = selectedFleetId === fleet.fleet_id;
          return `
            <div class="view-tab ${isActive ? 'active' : ''}" onclick="selectFleet('${fleet.fleet_id}')">
              <span style="margin-right:4px;">${fleet.icon}</span>${fleet.fleet_name}
            </div>
          `;
        }).join('');
      }
      
      // Update mobile subtitle
      const mobileSubtitle = document.getElementById('mobileFleetSubtitle');
      if (mobileSubtitle && selectedFleetId) {
        const fleet = fleets.find(f => f.fleet_id === selectedFleetId);
        if (fleet) {
          mobileSubtitle.textContent = fleet.fleet_name;
        }
      } else if (mobileSubtitle) {
        mobileSubtitle.textContent = 'Select a Fleet';
      }
    }

    // Select fleet and update view
    function selectFleet(fleetId) {
      selectedFleetId = fleetId;
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      if (!fleet) return;

      console.log('üìå Selected fleet:', fleet.fleet_name);

      // Update fleet tabs
      renderFleetTabs();

      // Update fleet card header
      document.getElementById('selectedFleetIcon').textContent = fleet.icon;
      document.getElementById('selectedFleetName').textContent = fleet.fleet_name;
      document.getElementById('selectedFleetDescription').textContent = fleet.description || 'No description';
      
      const vehicleCount = vehicleFleetAssignments.filter(a => a.fleet_id === fleetId && a.is_active).length;
      document.getElementById('selectedFleetVehicleCount').textContent = `${vehicleCount} Vehicles Assigned`;

      // Update metrics
      updateFleetMetrics(fleetId);

      // Update vehicle list
      updateVehicleList(fleetId);

      // Update charts
      updateFleetCharts(fleetId);
    }

    // Update metrics for selected fleet
    function updateFleetMetrics(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      const vehicleCount = vehicleFleetAssignments.filter(a => a.fleet_id === fleetId && a.is_active).length;
      const woCount = workOrders.filter(wo => wo.fleet_id === fleetId).length;
      const scheduledWO = workOrders.filter(wo => wo.fleet_id === fleetId && wo.status === 'scheduled').length;
      const completedWO = workOrders.filter(wo => wo.fleet_id === fleetId && wo.status === 'completed').length;
      
      // Calculate total revenue (estimate from work orders)
      const totalRevenue = workOrders
        .filter(wo => wo.fleet_id === fleetId && wo.status === 'completed')
        .reduce((sum, wo) => sum + (parseFloat(wo.total_price) || 0), 0);

      const metricsHTML = `
        <div class="metric-card">
          <div class="metric-label">Total Vehicles</div>
          <div class="metric-value">${vehicleCount}</div>
          <div class="metric-change">Assigned to ${fleet.fleet_name}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Total Work Orders</div>
          <div class="metric-value">${woCount}</div>
          <div class="metric-change">All time</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Scheduled Work Orders</div>
          <div class="metric-value">${scheduledWO}</div>
          <div class="metric-change">Currently scheduled</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Completed Work Orders</div>
          <div class="metric-value">${completedWO}</div>
          <div class="metric-change up">Finished</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Total Revenue</div>
          <div class="metric-value">$${totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
          <div class="metric-change up">From completed work</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Fleet Status</div>
          <div class="metric-value" style="font-size:20px; color:${fleet.is_active ? '#34d399' : '#ef4444'};">
            ${fleet.is_active ? 'Active' : 'Inactive'}
          </div>
          <div class="metric-change">${fleet.color}</div>
        </div>
      `;

      document.getElementById('fleetMetrics').innerHTML = metricsHTML;
    }

    // Update vehicle list for selected fleet
    function updateVehicleList(fleetId) {
      const assignedVehicleIds = vehicleFleetAssignments
        .filter(a => a.fleet_id === fleetId && a.is_active)
        .map(a => a.vehicle_id);
      
      const assignedVehicles = vehicles.filter(v => assignedVehicleIds.includes(v.vehicle_id));
      
      if (assignedVehicles.length === 0) {
        document.getElementById('fleetVehiclesTable').innerHTML = 
          '<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:40px;">No vehicles assigned to this fleet</td></tr>';
        return;
      }

      const vehiclesHTML = assignedVehicles.map(v => `
        <tr>
          <td class="vehicle-name">${v.year} ${v.make} ${v.model}</td>
          <td>${v.year}</td>
          <td>${v.license_plate || 'N/A'}</td>
          <td style="font-size:11px; color:#6b7280;">${v.vin ? v.vin.substring(0, 10) + '...' : 'N/A'}</td>
          <td><span style="padding:4px 8px; background:#1e4d2b; color:#34d399; border-radius:4px; font-size:11px; font-weight:600;">ACTIVE</span></td>
        </tr>
      `).join('');

      document.getElementById('fleetVehiclesTable').innerHTML = vehiclesHTML;
    }

    // Update charts for selected fleet
    function updateFleetCharts(fleetId) {
      const fleet = fleets.find(f => f.fleet_id === fleetId);
      const fleetWorkOrders = workOrders.filter(wo => wo.fleet_id === fleetId);

      // Destroy existing charts
      if (costTrendChart) costTrendChart.destroy();
      if (topVehiclesChart) topVehiclesChart.destroy();
      if (maintenanceChart) maintenanceChart.destroy();

      // Group work orders by month for revenue trend
      const monthlyData = {};
      fleetWorkOrders.forEach(wo => {
        if (wo.scheduled_start && wo.total_price) {
          const date = new Date(wo.scheduled_start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
          monthlyData[monthKey] += parseFloat(wo.total_price) || 0;
        }
      });

      const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
      const monthLabels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
      });
      const monthRevenue = sortedMonths.map(m => monthlyData[m]);

      // Revenue Trend Chart
      costTrendChart = new Chart(document.getElementById('costTrendChart'), {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Revenue',
            data: monthRevenue,
            borderColor: fleet.color,
            backgroundColor: fleet.color + '20',
            fill: true,
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: fleet.color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: fleet.color,
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (context) => '$' + context.parsed.y.toLocaleString()
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              border: { display: false },
              ticks: { 
                callback: value => '$' + (value/1000) + 'k',
                color: '#6b7280',
                font: { size: 11 }
              },
              grid: { color: '#1a2535', drawTicks: false }
            },
            x: {
              border: { display: false },
              ticks: { color: '#6b7280', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });

      // Work Order Volume by Month
      const monthlyWOCount = {};
      fleetWorkOrders.forEach(wo => {
        if (wo.scheduled_start) {
          const date = new Date(wo.scheduled_start);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyWOCount[monthKey]) monthlyWOCount[monthKey] = 0;
          monthlyWOCount[monthKey]++;
        }
      });

      const woMonths = Object.keys(monthlyWOCount).sort().slice(-6);
      const woLabels = woMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
      });
      const woCounts = woMonths.map(m => monthlyWOCount[m]);

      topVehiclesChart = new Chart(document.getElementById('topVehiclesChart'), {
        type: 'bar',
        data: {
          labels: woLabels,
          datasets: [{
            label: 'Work Orders',
            data: woCounts,
            backgroundColor: fleet.color,
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: fleet.color,
              borderWidth: 1,
              padding: 12,
              displayColors: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              border: { display: false },
              ticks: { color: '#6b7280', font: { size: 11 } },
              grid: { color: '#1a2535', drawTicks: false }
            },
            x: {
              border: { display: false },
              ticks: { color: '#9fb0c3', font: { size: 11 } },
              grid: { display: false }
            }
          }
        }
      });

      // Fleet Distribution (all fleets)
      const fleetCounts = fleets.map(f => {
        return vehicleFleetAssignments.filter(a => a.fleet_id === f.fleet_id && a.is_active).length;
      });

      maintenanceChart = new Chart(document.getElementById('maintenanceTypeChart'), {
        type: 'doughnut',
        data: {
          labels: fleets.map(f => f.fleet_name),
          datasets: [{
            data: fleetCounts,
            backgroundColor: fleets.map(f => f.color),
            borderWidth: 0,
            hoverOffset: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: '#9fb0c3',
                padding: 15,
                font: { size: 12 },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: '#0f1621',
              borderColor: fleet.color,
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: (context) => context.label + ': ' + context.parsed + ' vehicles'
              }
            }
          }
        }
      });
    }

    // Load data
    async function loadData() {
      const token = await validateAuth();
      if(!token) return location.replace("login.html");
      
      try {
        console.log('üîÑ Loading fleet data from database...');
        
        fleets = await fetchTable("fleets", token);
        vehicles = await fetchTable("vehicles", token);
        vehicleFleetAssignments = await fetchTable("vehicle_fleet_assignments", token);
        workOrders = await fetchTable("work_orders", token);
        
        console.log(`‚úÖ Loaded ${fleets.length} fleets`);
        console.log(`‚úÖ Loaded ${vehicles.length} vehicles`);
        console.log(`‚úÖ Loaded ${vehicleFleetAssignments.length} assignments`);
        console.log(`‚úÖ Loaded ${workOrders.length} work orders`);
        
        renderFleetTabs();
        
        // Select first fleet by default
        if (fleets.length > 0) {
          selectFleet(fleets[0].fleet_id);
        }
      } catch(err) {
        console.error('‚ùå Error loading fleet data:', err);
        alert('Error loading fleet data. Check console for details.');
      }
    }

    // Load data on page load
    loadData();
  </script>
</body>
</html>
