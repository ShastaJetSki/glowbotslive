<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Work Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; visibility:hidden; }
    body.auth-verified { visibility:visible; }
    
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }
    
    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:34px; }
    
    .sub-nav {
      display:flex;
      gap:16px;
      margin: 8px 0 0;
      padding-bottom:10px;
      border-bottom:1px solid #1f2937;
      flex-wrap:wrap;
    }
    .sub-nav-link {
      font-size:14px;
      color:#9ca3af;
      text-decoration:none;
      padding:4px 2px;
      position:relative;
    }
    .sub-nav-link:hover { color:#e5e7eb; }
    .sub-nav-link.active { color:#38bdf8; font-weight:500; }
    
    .header-buttons { display:flex; gap:8px; align-items:center; }
    
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:#243648; }
    .primary { background:#3b82f6; border-color:#3b82f6; }
    .primary:hover { background:#2563eb; }
    .danger { background:#ef4444; border-color:#ef4444; }
    .danger:hover { background:#dc2626; }
    
    .card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:20px; margin-bottom:16px; }
    
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th, td { border-bottom:1px solid #223044; padding:12px 8px; text-align:left; }
    th { font-size:12px; color:#9fb0c3; font-weight:600; text-transform:uppercase; }
    td { font-size:14px; }
    
    .status-pill {
      display:inline-block;
      padding:4px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
    }
    .status-draft { background:#374151; color:#9ca3af; }
    .status-scheduled { background:#1e3a8a; color:#93c5fd; }
    .status-in_progress { background:#854d0e; color:#fbbf24; }
    .status-completed { background:#14532d; color:#86efac; }
    .status-closed { background:#1f2937; color:#6b7280; }
    
    .priority-pill {
      display:inline-block;
      padding:4px 8px;
      border-radius:8px;
      font-size:11px;
      font-weight:500;
    }
    .priority-low { background:#1e293b; color:#64748b; }
    .priority-medium { background:#1e3a8a; color:#60a5fa; }
    .priority-high { background:#7c2d12; color:#fb923c; }
    
    .actions { display:flex; gap:8px; }
    .btn-sm {
      padding:6px 10px;
      font-size:12px;
    }
    
    .empty-state {
      text-align:center;
      padding:60px 20px;
      color:#9fb0c3;
    }
    
    .search-bar {
      display:flex;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    
    input[type="text"], input[type="search"] {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #223044;
      background:#1a2535;
      color:#e8eef6;
      font-size:14px;
      outline:none;
      flex:1;
      min-width:200px;
    }
    input:focus { border-color:#3b82f6; }
    
    .muted { font-size:12px; color:#9fb0c3; }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <div>
      <h1>Work Orders</h1>
      <div class="sub-nav">
        <a href="dashboard-business.html" class="sub-nav-link">Dashboard</a>
        <a href="dashboard-customer-search.html" class="sub-nav-link">Customers</a>
        <a href="dashboard-vehicle-search.html" class="sub-nav-link">Vehicles</a>
        <a href="work-orders.html" class="sub-nav-link active">Work Orders</a>
        <a href="dashboard-settings.html" class="sub-nav-link">Settings</a>
      </div>
    </div>

    <div class="header-buttons">
      <button class="primary" onclick="location.href='work-order-new.html'">+ New Work Order</button>
      <button class="danger" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="card">
    <div class="search-bar">
      <input type="search" id="searchInput" placeholder="Search by customer, vehicle, or reference..." oninput="filterWorkOrders()" />
      <button onclick="loadWorkOrders()">Refresh</button>
    </div>

    <div id="workOrdersContainer">
      <div style="text-align:center; padding:40px; color:#9fb0c3;">
        Loading work orders...
      </div>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let AUTH = null;
let TENANT_ID = null;
let allWorkOrders = [];

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;
  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey: ANON_KEY, Authorization: `Bearer ${token}` }
  });
  if(!r.ok) return null;
  return { token, user: await r.json() };
}

async function getTenantId(token){
  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey: ANON_KEY, Authorization: `Bearer ${token}` }
  });
  if(!r.ok) throw new Error("Failed to load user");
  const u = await r.json();
  return u.user_metadata?.tenant_id || u.id;
}

async function sbFetch(path, { token, method="GET", body=null }){
  const headers = { apikey: ANON_KEY, Authorization: `Bearer ${token}` };
  if(body !== null) headers["Content-Type"] = "application/json";
  return fetch(path, { method, headers, body: body !== null ? JSON.stringify(body) : null });
}

function formatDate(isoString){
  if(!isoString) return '-';
  const d = new Date(isoString);
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

function getStatusClass(status){
  const normalized = (status || 'draft').toLowerCase().replace(/[^a-z]/g, '_');
  return `status-${normalized}`;
}

function getPriorityClass(priority){
  return `priority-${(priority || 'medium').toLowerCase()}`;
}

async function loadWorkOrders(){
  try {
    // Load work orders with customer and vehicle info
    const r = await sbFetch(
      `${REST_BASE}/work_orders?select=*,customers(first_name,last_name,business_name),vehicles(year,make,model,license_plate)&tenant_id=eq.${TENANT_ID}&order=created_at.desc`,
      { token: AUTH.token }
    );

    if(!r.ok) throw new Error("Failed to load work orders");

    allWorkOrders = await r.json();
    renderWorkOrders(allWorkOrders);
  } catch(err) {
    console.error(err);
    document.getElementById('workOrdersContainer').innerHTML = `
      <div class="empty-state">
        <div style="color:#ef4444;">Error loading work orders</div>
        <div class="muted">${err.message}</div>
      </div>
    `;
  }
}

function renderWorkOrders(orders){
  const container = document.getElementById('workOrdersContainer');
  
  if(!orders || orders.length === 0){
    container.innerHTML = `
      <div class="empty-state">
        <div style="font-size:48px; margin-bottom:16px;">ðŸ“‹</div>
        <div style="font-size:18px; font-weight:600; margin-bottom:8px;">No Work Orders Yet</div>
        <div class="muted">Create your first work order to get started</div>
        <button class="primary" onclick="location.href='work-order-new.html'" style="margin-top:20px;">+ Create Work Order</button>
      </div>
    `;
    return;
  }

  container.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>WO #</th>
          <th>Customer</th>
          <th>Vehicle</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${orders.map(wo => {
          const customerName = wo.customers 
            ? (wo.customers.business_name || `${wo.customers.first_name || ''} ${wo.customers.last_name || ''}`.trim())
            : 'No Customer';
          
          const vehicleInfo = wo.vehicles
            ? `${wo.vehicles.year || ''} ${wo.vehicles.make || ''} ${wo.vehicles.model || ''}`.trim()
            : 'No Vehicle';
            
          const plate = wo.vehicles?.license_plate ? ` â€¢ ${wo.vehicles.license_plate}` : '';
          
          return `
            <tr>
              <td><strong>${wo.reference || wo.work_order_id.slice(0,8)}</strong></td>
              <td>${customerName}</td>
              <td>${vehicleInfo}${plate}</td>
              <td><span class="status-pill ${getStatusClass(wo.status)}">${wo.status || 'draft'}</span></td>
              <td><span class="priority-pill ${getPriorityClass(wo.priority)}">${wo.priority || 'medium'}</span></td>
              <td class="muted">${formatDate(wo.created_at)}</td>
              <td>
                <div class="actions">
                  <button class="btn-sm primary" onclick="location.href='work-order-edit.html?id=${wo.work_order_id}'">Edit</button>
                  <button class="btn-sm" onclick="viewWorkOrder('${wo.work_order_id}')">View</button>
                </div>
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

function filterWorkOrders(){
  const query = document.getElementById('searchInput').value.toLowerCase();
  
  if(!query){
    renderWorkOrders(allWorkOrders);
    return;
  }
  
  const filtered = allWorkOrders.filter(wo => {
    const customerName = wo.customers 
      ? (wo.customers.business_name || `${wo.customers.first_name || ''} ${wo.customers.last_name || ''}`.trim()).toLowerCase()
      : '';
    
    const vehicleInfo = wo.vehicles
      ? `${wo.vehicles.year || ''} ${wo.vehicles.make || ''} ${wo.vehicles.model || ''}`.toLowerCase()
      : '';
      
    const plate = wo.vehicles?.license_plate?.toLowerCase() || '';
    const reference = (wo.reference || '').toLowerCase();
    const woId = wo.work_order_id.toLowerCase();
    
    return customerName.includes(query) || 
           vehicleInfo.includes(query) || 
           plate.includes(query) ||
           reference.includes(query) ||
           woId.includes(query);
  });
  
  renderWorkOrders(filtered);
}

function viewWorkOrder(id){
  // For now, just go to edit. Later you can create a read-only view page
  location.href = `work-order-edit.html?id=${id}`;
}

async function load(){
  AUTH = await validateAuth();
  if(!AUTH) return location.replace("login.html");
  
  document.body.classList.add('auth-verified');
  
  TENANT_ID = await getTenantId(AUTH.token);
  
  await loadWorkOrders();
}

load();
</script>
</body>
</html>
