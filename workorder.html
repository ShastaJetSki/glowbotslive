<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Work Order - Service Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --charcoal: #36454f;
      --white: #ffffff;
      --bg: #f5f7fa;
      --shadow: rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--charcoal);
      min-height: 100vh;
    }

    /* Topbar */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: var(--white);
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      z-index: 100;
      box-shadow: 0 2px 10px var(--shadow);
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .back-btn {
      margin-left: auto;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.625rem 1.25rem;
      background: var(--white);
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      color: var(--charcoal);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Main Content */
    .main-content {
      margin-top: 70px;
      padding: 2.5rem 2rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .page-header {
      margin-bottom: 2.5rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-subtitle {
      font-size: 1rem;
      color: #666;
      font-weight: 500;
    }

    /* Form Card */
    .form-card {
      background: var(--white);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 4px 20px var(--shadow);
      border: 1px solid #f0f0f0;
    }

    .form-section {
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #f0f0f0;
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--charcoal);
      margin-bottom: 1.5rem;
      letter-spacing: -0.3px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .form-grid.two-col {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 0.5rem;
      letter-spacing: 0.3px;
    }

    input, select, textarea {
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      padding: 0.875rem 1rem;
      background: var(--white);
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      color: var(--charcoal);
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    input::placeholder, textarea::placeholder {
      color: #999;
      font-weight: 400;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2.5rem;
    }

    .btn {
      flex: 1;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.2px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-secondary {
      background: var(--white);
      border: 2px solid #e0e0e0;
      color: var(--charcoal);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Customer Search Results */
    .customer-results {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-top: 0.5rem;
      box-shadow: 0 4px 20px var(--shadow);
      display: none;
    }

    .customer-results.show {
      display: block;
    }

    .customer-result-item {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .customer-result-item:hover {
      background: #f9fafb;
    }

    .customer-result-item:last-child {
      border-bottom: none;
    }

    .customer-result-name {
      font-weight: 700;
      color: var(--charcoal);
      margin-bottom: 0.25rem;
    }

    .customer-result-details {
      font-size: 0.875rem;
      color: #666;
    }

    .customer-result-phone {
      font-size: 0.875rem;
      color: var(--primary);
      font-weight: 600;
    }

    .no-results {
      padding: 1rem;
      text-align: center;
      color: #666;
      font-size: 0.875rem;
    }

    /* Quick Service Buttons */
    .quick-service-btn {
      font-family: 'Inter', sans-serif;
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      color: var(--charcoal);
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-service-btn:hover {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-color: transparent;
      color: white;
    }

    /* Alert */
    .alert {
      padding: 1.25rem;
      border-radius: 12px;
      margin-top: 1.5rem;
      font-weight: 600;
      text-align: center;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }

    @media (max-width: 768px) {
      .page-title { font-size: 2rem; }
      .form-card { padding: 2rem 1.5rem; }
      .button-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="logo">Service Manager</div>
    <a href="dashboard.html" class="back-btn">← Back</a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="page-header">
      <h1 class="page-title">New Work Order</h1>
      <p class="page-subtitle">Create a new service appointment for your customer</p>
    </div>

    <!-- Form -->
    <div class="form-card">
      <form id="workOrderForm">
        <!-- Customer Selection -->
        <div class="form-section">
          <h3 class="section-title">Customer Information</h3>
          <div class="form-grid" style="max-width: 30%;">
            <div class="form-group">
              <label>Customer Phone Number</label>
              <input 
                type="tel" 
                id="phoneSearch" 
                placeholder="Search by phone number..."
                autocomplete="off"
              >
              <div id="customerResults" class="customer-results"></div>
            </div>
          </div>

          <!-- Selected Customer Display -->
          <div id="selectedCustomer" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 0.25rem;" id="customerName"></div>
                <div style="font-size: 0.875rem; color: #666;" id="customerDetails"></div>
              </div>
              <button type="button" onclick="clearCustomer()" style="font-size: 0.875rem; padding: 0.5rem 1rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-weight: 600;">Change</button>
            </div>
          </div>

          <!-- New Customer Form -->
          <div id="newCustomerForm" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
            <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 1rem;">New Customer - Not Found</div>
            <div class="form-grid two-col">
              <div class="form-group">
                <label>First Name</label>
                <input type="text" id="firstName" placeholder="Enter first name">
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="lastName" placeholder="Enter last name">
              </div>
            </div>
            <div class="form-grid two-col" style="margin-top: 1.5rem;">
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="newPhone" placeholder="Phone number" readonly>
              </div>
              <div class="form-group">
                <label>Vehicle/Equipment</label>
                <input type="text" id="vehicle" placeholder="e.g., 2021 Honda Accord">
              </div>
            </div>
          </div>
        </div>

        <!-- Service Details -->
        <div class="form-section">
          <h3 class="section-title">Service Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Service Description</label>
              <textarea 
                id="serviceDescription" 
                placeholder="Describe the service needed or select from common services below..."
                style="min-height: 100px;"
                required
              ></textarea>
            </div>

            <!-- Quick Service Buttons -->
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
              <button type="button" class="quick-service-btn" onclick="insertService('Oil Change & Filter')">Oil Change</button>
              <button type="button" class="quick-service-btn" onclick="insertService('Brake Service')">Brake Service</button>
              <button type="button" class="quick-service-btn" onclick="insertService('Engine Service')">Engine Service</button>
              <button type="button" class="quick-service-btn" onclick="insertService('General Inspection')">Inspection</button>
              <button type="button" class="quick-service-btn" onclick="insertService('Transmission Service')">Transmission</button>
              <button type="button" class="quick-service-btn" onclick="insertService('Tire Rotation')">Tire Rotation</button>
            </div>

            <div class="form-grid two-col" style="margin-top: 1.5rem;">
              <div class="form-group">
                <label>Scheduled Date</label>
                <input type="date" id="scheduledDate" required>
              </div>
              <div class="form-group">
                <label>Start Time</label>
                <input type="time" id="startTime" value="10:00" required>
              </div>
            </div>

            <div class="form-grid two-col">
              <div class="form-group">
                <label>End Time</label>
                <input type="time" id="endTime" value="11:00" required>
              </div>
              <div class="form-group">
                <label>Priority</label>
                <select id="priority" required>
                  <option value="low">Low</option>
                  <option value="normal" selected>Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Internal Notes (Optional)</label>
              <textarea id="notes" placeholder="Add any internal notes or special instructions..." style="min-height: 80px;"></textarea>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="form-section">
          <h3 class="section-title">Pricing & Payment</h3>
          <div class="form-grid two-col">
            <div class="form-group">
              <label>Labor Cost</label>
              <input type="number" id="laborTotal" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
            <div class="form-group">
              <label>Parts Cost</label>
              <input type="number" id="partsTotal" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
          </div>

          <div class="form-grid two-col">
            <div class="form-group">
              <label>Additional Fees</label>
              <input type="number" id="additionalFees" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
            <div class="form-group">
              <label>Discount</label>
              <input type="number" id="discount" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
          </div>

          <!-- Bill Summary -->
          <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #0ea5e9;">
            <div style="font-weight: 700; font-size: 1.125rem; color: var(--charcoal); margin-bottom: 1rem;">Bill Summary</div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Labor:</span>
              <span style="font-weight: 600;" id="summaryLabor">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Parts:</span>
              <span style="font-weight: 600;" id="summaryParts">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Additional Fees:</span>
              <span style="font-weight: 600;" id="summaryFees">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Discount:</span>
              <span style="font-weight: 600; color: #10b981;" id="summaryDiscount">-$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 2px solid #0ea5e9;">
              <span style="color: #666; font-weight: 600;">Subtotal:</span>
              <span style="font-weight: 700;" id="summarySubtotal">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Tax (8.5%):</span>
              <span style="font-weight: 600;" id="summaryTax">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 1rem 0 0.5rem 0;">
              <span style="font-weight: 700; font-size: 1.25rem; color: var(--primary);">Total:</span>
              <span style="font-weight: 700; font-size: 1.5rem; color: var(--primary);" id="summaryTotal">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Technician Assignment -->
        <div class="form-section">
          <h3 class="section-title">Technician Assignment</h3>
          <div class="form-grid" style="max-width: 50%;">
            <div class="form-group">
              <label>Assigned Technician</label>
              <select id="technician" required>
                <option value="">Select technician...</option>
                <option value="John Smith">John Smith - Senior Technician</option>
                <option value="Maria Garcia">Maria Garcia - Master Technician</option>
                <option value="David Chen">David Chen - Technician</option>
                <option value="Sarah Johnson">Sarah Johnson - Senior Technician</option>
                <option value="Mike Wilson">Mike Wilson - Apprentice</option>
              </select>
            </div>
          </div>

          <!-- Selected Technician Display -->
          <div id="selectedTechnician" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.25rem;" id="techInitials"></div>
              <div>
                <div style="font-weight: 700; color: var(--charcoal);" id="techName"></div>
                <div style="font-size: 0.875rem; color: #666;" id="techRole"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="button-group">
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset Form</button>
          <button type="submit" class="btn btn-primary">Create Work Order</button>
        </div>
      </form>

      <div id="alert" class="alert"></div>
    </div>
  </div>

  <script>
    if (!sessionStorage.getItem('isAuthenticated')) {
      window.location.href = 'login.html';
    }

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('scheduledDate').value = tomorrow.toISOString().split('T')[0];

    // Customer database
    const customers = [
      { name: 'Michael Brown', phone: '4085552001', vehicle: '2021 Honda Accord' },
      { name: 'Amanda Davis', phone: '4085552002', vehicle: '2023 Tesla Model 3' },
      { name: 'Robert Martinez', phone: '5105551001', vehicle: '2019 Sea Ray Sundancer' },
      { name: 'James Miller', phone: '4085553001', vehicle: '2020 John Deere X350' },
      { name: 'Daniel Taylor', phone: '6505554001', vehicle: 'Samsung Refrigerator RF28R7201SR' }
    ];

    let selectedCustomer = null;
    const TAX_RATE = 0.085; // 8.5% tax

    // Calculate total with tax
    function calculateTotal() {
      const labor = parseFloat(document.getElementById('laborTotal').value) || 0;
      const parts = parseFloat(document.getElementById('partsTotal').value) || 0;
      const fees = parseFloat(document.getElementById('additionalFees').value) || 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;

      const subtotal = labor + parts + fees - discount;
      const tax = subtotal * TAX_RATE;
      const total = subtotal + tax;

      // Update summary
      document.getElementById('summaryLabor').textContent = '$' + labor.toFixed(2);
      document.getElementById('summaryParts').textContent = '$' + parts.toFixed(2);
      document.getElementById('summaryFees').textContent = '$' + fees.toFixed(2);
      document.getElementById('summaryDiscount').textContent = '-$' + discount.toFixed(2);
      document.getElementById('summarySubtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('summaryTax').textContent = '$' + tax.toFixed(2);
      document.getElementById('summaryTotal').textContent = '$' + total.toFixed(2);
    }

    // Technician selection
    document.getElementById('technician').addEventListener('change', function() {
      const selectedValue = this.value;
      if (selectedValue) {
        const parts = selectedValue.split(' - ');
        const name = parts[0];
        const role = parts[1] || 'Technician';
        const initials = name.split(' ').map(n => n[0]).join('');

        document.getElementById('techName').textContent = name;
        document.getElementById('techRole').textContent = role;
        document.getElementById('techInitials').textContent = initials;
        document.getElementById('selectedTechnician').style.display = 'block';
      } else {
        document.getElementById('selectedTechnician').style.display = 'none';
      }
    });

    // Phone search functionality
    const phoneSearch = document.getElementById('phoneSearch');
    const customerResults = document.getElementById('customerResults');

    phoneSearch.addEventListener('input', function() {
      const searchValue = this.value.replace(/\D/g, ''); // Remove non-digits
      
      if (searchValue.length >= 3) {
        const matches = customers.filter(c => c.phone.includes(searchValue));
        
        if (matches.length > 0) {
          let html = '';
          matches.forEach(customer => {
            html += `
              <div class="customer-result-item" onclick="selectCustomer('${customer.name}', '${customer.phone}', '${customer.vehicle}')">
                <div class="customer-result-name">${customer.name}</div>
                <div class="customer-result-phone">${formatPhone(customer.phone)}</div>
                <div class="customer-result-details">${customer.vehicle}</div>
              </div>
            `;
          });
          customerResults.innerHTML = html;
          customerResults.classList.add('show');
        } else {
          // No customer found - show new customer form
          customerResults.innerHTML = '<div class="no-results">No customer found with this number</div>';
          customerResults.classList.add('show');
          
          // Show new customer form after a delay
          setTimeout(() => {
            customerResults.classList.remove('show');
            document.getElementById('newCustomerForm').style.display = 'block';
            document.getElementById('newPhone').value = formatPhone(searchValue);
            document.getElementById('firstName').required = true;
            document.getElementById('lastName').required = true;
            document.getElementById('vehicle').required = true;
          }, 1500);
        }
      } else {
        customerResults.classList.remove('show');
        document.getElementById('newCustomerForm').style.display = 'none';
      }
    });

    // Format phone number
    function formatPhone(phone) {
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 10) {
        return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)}-${cleaned.substring(6)}`;
      }
      return phone;
    }

    // Select customer from search results
    function selectCustomer(name, phone, vehicle) {
      selectedCustomer = { name, phone, vehicle };
      
      // Hide search results
      customerResults.classList.remove('show');
      
      // Show selected customer
      document.getElementById('customerName').textContent = name;
      document.getElementById('customerDetails').textContent = `${formatPhone(phone)} • ${vehicle}`;
      document.getElementById('selectedCustomer').style.display = 'block';
      
      // Hide phone search
      phoneSearch.style.display = 'none';
      
      // Hide new customer form if shown
      document.getElementById('newCustomerForm').style.display = 'none';
    }

    // Clear customer selection
    function clearCustomer() {
      selectedCustomer = null;
      document.getElementById('selectedCustomer').style.display = 'none';
      document.getElementById('phoneSearch').style.display = 'block';
      document.getElementById('phoneSearch').value = '';
      document.getElementById('phoneSearch').focus();
    }

    // Insert service into description
    function insertService(serviceName) {
      const textarea = document.getElementById('serviceDescription');
      if (textarea.value.trim() === '') {
        textarea.value = serviceName;
      } else {
        textarea.value += '\n' + serviceName;
      }
      textarea.focus();
    }

    // Form submission
    document.getElementById('workOrderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      await createWorkOrder();
    });

    async function createWorkOrder() {
      let customerName, phone, vehicle;
      
      if (selectedCustomer) {
        // Existing customer
        customerName = selectedCustomer.name;
        phone = selectedCustomer.phone;
        vehicle = selectedCustomer.vehicle;
      } else {
        // New customer
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        
        if (!firstName || !lastName) {
          showAlert('Please complete customer information or search by phone', 'error');
          return;
        }
        
        customerName = `${firstName} ${lastName}`;
        phone = document.getElementById('newPhone').value.replace(/\D/g, '');
        vehicle = document.getElementById('vehicle').value;
      }

      const serviceDescription = document.getElementById('serviceDescription').value;
      const scheduledDate = document.getElementById('scheduledDate').value;
      const technician = document.getElementById('technician').value;

      if (!technician) {
        showAlert('Please assign a technician', 'error');
        return;
      }

      // Get calculated total from summary
      const totalText = document.getElementById('summaryTotal').textContent;
      const totalAmount = parseFloat(totalText.replace('$', '').replace(',', ''));

      showAlert('Creating work order...', 'success');

      await new Promise(resolve => setTimeout(resolve, 1000));

      const orderNumber = 'RO-2025-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');

      let mockOrders = JSON.parse(sessionStorage.getItem('mockOrders') || '[]');
      mockOrders.push({
        id: mockOrders.length + 4,
        order_number: orderNumber,
        customer: customerName,
        phone: formatPhone(phone),
        vehicle: vehicle,
        service: serviceDescription.split('\n')[0].substring(0, 50), // First line, max 50 chars
        scheduled_date: scheduledDate,
        status: 'scheduled',
        total_amount: totalAmount,
        technician: technician.split(' - ')[0] // Just the name
      });
      sessionStorage.setItem('mockOrders', JSON.stringify(mockOrders));

      showAlert(`✓ Work order ${orderNumber} created! Assigned to ${technician.split(' - ')[0]}`, 'success');
      
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 1500);
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert ${type} show`;
    }

    function resetForm() {
      document.getElementById('workOrderForm').reset();
      document.getElementById('alert').classList.remove('show');
      document.getElementById('selectedCustomer').style.display = 'none';
      document.getElementById('newCustomerForm').style.display = 'none';
      document.getElementById('selectedTechnician').style.display = 'none';
      document.getElementById('phoneSearch').style.display = 'block';
      document.getElementById('phoneSearch').value = '';
      selectedCustomer = null;
      
      // Reset calculations
      calculateTotal();
      
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('scheduledDate').value = tomorrow.toISOString().split('T')[0];
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!phoneSearch.contains(e.target) && !customerResults.contains(e.target)) {
        customerResults.classList.remove('show');
      }
    });
  </script>
</body>
</html>
