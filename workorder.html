<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Work Order - Service Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --charcoal: #36454f;
      --white: #ffffff;
      --bg: #f5f7fa;
      --shadow: rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--charcoal);
      min-height: 100vh;
    }

    /* Topbar */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: var(--white);
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      z-index: 100;
      box-shadow: 0 2px 10px var(--shadow);
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .back-btn {
      margin-left: auto;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.625rem 1.25rem;
      background: var(--white);
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      color: var(--charcoal);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Main Content */
    .main-content {
      margin-top: 70px;
      padding: 2.5rem 2rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .page-header {
      margin-bottom: 2.5rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-subtitle {
      font-size: 1rem;
      color: #666;
      font-weight: 500;
    }

    /* Form Card */
    .form-card {
      background: var(--white);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 4px 20px var(--shadow);
      border: 1px solid #f0f0f0;
    }

    .form-section {
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #f0f0f0;
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--charcoal);
      margin-bottom: 1.5rem;
      letter-spacing: -0.3px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .form-grid.two-col {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 0.5rem;
      letter-spacing: 0.3px;
    }

    input, select, textarea {
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      padding: 0.875rem 1rem;
      background: var(--white);
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      color: var(--charcoal);
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    input::placeholder, textarea::placeholder {
      color: #999;
      font-weight: 400;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2.5rem;
    }

    .btn {
      flex: 1;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.2px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-secondary {
      background: var(--white);
      border: 2px solid #e0e0e0;
      color: var(--charcoal);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Customer Search Results */
    .customer-results {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-top: 0.5rem;
      box-shadow: 0 4px 20px var(--shadow);
      display: none;
    }

    .customer-results.show {
      display: block;
    }

    .customer-result-item {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .customer-result-item:hover {
      background: #f9fafb;
    }

    .customer-result-item:last-child {
      border-bottom: none;
    }

    .customer-result-name {
      font-weight: 700;
      color: var(--charcoal);
      margin-bottom: 0.25rem;
    }

    .customer-result-details {
      font-size: 0.875rem;
      color: #666;
    }

    .customer-result-phone {
      font-size: 0.875rem;
      color: var(--primary);
      font-weight: 600;
    }

    .no-results {
      padding: 1rem;
      text-align: center;
      color: #666;
      font-size: 0.875rem;
    }

    /* Quick Service Buttons */
    .quick-service-btn {
      font-family: 'Inter', sans-serif;
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      color: var(--charcoal);
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-service-btn:hover {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-color: transparent;
      color: white;
    }

    .add-btn {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .labor-line {
      background: #f9fafb;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .labor-line-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .labor-line-number {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--primary);
    }

    .remove-line-btn {
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      background: #fee2e2;
      border: 2px solid #ef4444;
      border-radius: 8px;
      color: #991b1b;
      cursor: pointer;
      transition: all 0.2s;
    }

    .remove-line-btn:hover {
      background: #ef4444;
      color: white;
    }

    /* Alert */
    .alert {
      padding: 1.25rem;
      border-radius: 12px;
      margin-top: 1.5rem;
      font-weight: 600;
      text-align: center;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }

    @media (max-width: 768px) {
      .page-title { font-size: 2rem; }
      .form-card { padding: 2rem 1.5rem; }
      .button-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="logo">Service Manager</div>
    <a href="dashboard.html" class="back-btn">← Back</a>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="page-header">
      <h1 class="page-title">New Work Order</h1>
      <p class="page-subtitle">Create a new service appointment for your customer</p>
    </div>

    <!-- Form -->
    <div class="form-card">
      <form id="workOrderForm">
        <!-- Customer & Vehicle -->
        <div class="form-section">
          <h3 class="section-title">Customer & Vehicle</h3>
          <div class="form-grid two-col">
            <div class="form-group" id="field_phone">
              <label>Customer Phone Number</label>
              <input 
                type="tel" 
                id="phoneSearch" 
                placeholder="Search by phone number..."
                autocomplete="off"
              >
              <div id="customerResults" class="customer-results"></div>
            </div>

            <div class="form-group" id="field_licensePlate">
              <label>License Plate Number</label>
              <input 
                type="text" 
                id="licensePlateSearch" 
                placeholder="Search by license plate..."
                autocomplete="off"
              >
              <div id="vehicleResults" class="customer-results"></div>
            </div>
          </div>

          <div class="form-grid two-col" style="margin-top: 1.5rem;">
            <div class="form-group" id="field_technician">
              <label>Assigned Technician</label>
              <select id="technician" required>
                <option value="">Select technician...</option>
                <option value="John Smith">John Smith - Senior Technician</option>
                <option value="Maria Garcia">Maria Garcia - Master Technician</option>
                <option value="David Chen">David Chen - Technician</option>
                <option value="Sarah Johnson">Sarah Johnson - Senior Technician</option>
                <option value="Mike Wilson">Mike Wilson - Apprentice</option>
              </select>
            </div>

            <div class="form-group" id="field_estimatedHours">
              <label>Estimated Hours (Total from labor lines)</label>
              <input 
                type="number" 
                id="estimatedHours" 
                step="0.25" 
                placeholder="0.0"
                min="0"
                readonly
                style="background: #f9fafb;"
              >
            </div>
          </div>

          <div class="form-group" id="field_vin" style="margin-top: 1.5rem;">
            <label>VIN Number</label>
            <input 
              type="text" 
              id="vinNumber" 
              placeholder="Enter 17-character VIN..."
              maxlength="17"
              style="text-transform: uppercase;"
            >
          </div>

          <!-- Selected Customer Display -->
          <div id="selectedCustomer" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 0.25rem;" id="customerName"></div>
                <div style="font-size: 0.875rem; color: #666;" id="customerDetails"></div>
              </div>
              <button type="button" onclick="clearCustomer()" style="font-size: 0.875rem; padding: 0.5rem 1rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-weight: 600;">Change</button>
            </div>
          </div>

          <!-- Selected Vehicle Display -->
          <div id="selectedVehicle" style="display: none; margin-top: 1rem; padding: 1rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 0.25rem;" id="vehicleInfo"></div>
                <div style="font-size: 0.875rem; color: #666;" id="vehiclePlate"></div>
              </div>
              <button type="button" onclick="clearVehicle()" style="font-size: 0.875rem; padding: 0.5rem 1rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-weight: 600;">Change</button>
            </div>
          </div>

          <!-- Selected Technician Display -->
          <div id="selectedTechnician" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.25rem;" id="techInitials"></div>
              <div style="flex: 1;">
                <div style="font-weight: 700; color: var(--charcoal);" id="techName"></div>
                <div style="font-size: 0.875rem; color: #666;" id="techRole"></div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 0.875rem; color: #666;">Estimated Time</div>
                <div style="font-weight: 700; font-size: 1.125rem; color: var(--primary);" id="techHours">-- hrs</div>
              </div>
            </div>
          </div>

          <!-- New Customer Form -->
          <div id="newCustomerForm" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
            <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 1rem;">New Customer - Not Found</div>
            <div class="form-grid two-col">
              <div class="form-group">
                <label>First Name</label>
                <input type="text" id="firstName" placeholder="Enter first name">
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="lastName" placeholder="Enter last name">
              </div>
            </div>
            <div class="form-group" style="margin-top: 1.5rem;">
              <label>Phone</label>
              <input type="tel" id="newPhone" placeholder="Phone number" readonly>
            </div>
            <div class="form-group" style="margin-top: 1.5rem;">
              <label>Vehicle/Equipment</label>
              <input type="text" id="vehicle" placeholder="e.g., 2021 Honda Accord">
            </div>
          </div>
        </div>

        <!-- Service Details -->
        <div class="form-section">
          <h3 class="section-title">Service Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Service Description</label>
              <textarea 
                id="serviceDescription" 
                placeholder="Describe the service needed in detail..."
                style="min-height: 120px;"
                required
              ></textarea>
            </div>
          </div>

          <div class="form-grid two-col" style="margin-top: 1.5rem;">
            <div class="form-group" id="field_scheduledDate">
              <label>Scheduled Date</label>
              <input type="date" id="scheduledDate" required>
            </div>
            <div class="form-group" id="field_priority">
              <label>Priority</label>
              <select id="priority" required>
                <option value="low">Low</option>
                <option value="normal" selected>Normal</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>

          <div class="form-group" id="field_notes" style="margin-top: 1.5rem;">
            <label>Internal Notes (Optional)</label>
            <textarea id="notes" placeholder="Add any internal notes or special instructions..." style="min-height: 80px;"></textarea>
          </div>
        </div>

        <!-- Common Jobs -->
        <div class="form-section">
          <h3 class="section-title">Common Jobs (Quick Add)</h3>
          <div id="commonJobsButtons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <!-- Buttons will be loaded from settings -->
          </div>
        </div>

        <!-- Labor Lines -->
        <div class="form-section">
          <h3 class="section-title">Labor Lines</h3>
          <div id="laborLines">
            <!-- Labor lines will be added here -->
          </div>
          <button type="button" class="add-btn" onclick="addLaborLine()" style="margin-top: 1rem; font-size: 0.875rem; padding: 0.75rem 1.5rem;">+ Add Labor Line</button>
        </div>

        <!-- Pricing -->
        <div class="form-section">
          <h3 class="section-title">Pricing & Payment</h3>
          <div class="form-grid two-col">
            <div class="form-group">
              <label>Labor Cost (Auto-calculated from hours)</label>
              <input type="number" id="laborTotal" step="0.01" placeholder="0.00" value="0" readonly style="background: #f9fafb;">
            </div>
            <div class="form-group">
              <label>Parts Cost</label>
              <input type="number" id="partsTotal" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
          </div>

          <div class="form-grid two-col">
            <div class="form-group">
              <label>Additional Fees</label>
              <input type="number" id="additionalFees" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
            <div class="form-group">
              <label>Discount</label>
              <input type="number" id="discount" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
          </div>

          <!-- Bill Summary -->
          <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #0ea5e9;">
            <div style="font-weight: 700; font-size: 1.125rem; color: var(--charcoal); margin-bottom: 1rem;">Bill Summary</div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Labor:</span>
              <span style="font-weight: 600;" id="summaryLabor">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Parts:</span>
              <span style="font-weight: 600;" id="summaryParts">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Additional Fees:</span>
              <span style="font-weight: 600;" id="summaryFees">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Discount:</span>
              <span style="font-weight: 600; color: #10b981;" id="summaryDiscount">-$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 2px solid #0ea5e9;">
              <span style="color: #666; font-weight: 600;">Subtotal:</span>
              <span style="font-weight: 700;" id="summarySubtotal">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Tax (8.5%):</span>
              <span style="font-weight: 600;" id="summaryTax">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 1rem 0 0.5rem 0;">
              <span style="font-weight: 700; font-size: 1.25rem; color: var(--primary);">Total:</span>
              <span style="font-weight: 700; font-size: 1.5rem; color: var(--primary);" id="summaryTotal">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="button-group">
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset Form</button>
          <button type="submit" class="btn btn-primary">Create Work Order</button>
        </div>
      </form>

      <div id="alert" class="alert"></div>
    </div>
  </div>

  <script>
    if (!sessionStorage.getItem('isAuthenticated')) {
      window.location.href = 'login.html';
    }

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('scheduledDate').value = tomorrow.toISOString().split('T')[0];

    // Customer database
    const customers = [
      { name: 'Michael Brown', phone: '4085552001', vehicle: '2021 Honda Accord' },
      { name: 'Amanda Davis', phone: '4085552002', vehicle: '2023 Tesla Model 3' },
      { name: 'Robert Martinez', phone: '5105551001', vehicle: '2019 Sea Ray Sundancer' },
      { name: 'James Miller', phone: '4085553001', vehicle: '2020 John Deere X350' },
      { name: 'Daniel Taylor', phone: '6505554001', vehicle: 'Samsung Refrigerator RF28R7201SR' }
    ];

    // Vehicle database with license plates
    const vehicles = [
      { plate: '7ABC123', make: 'Honda', model: 'Accord', year: '2021', owner: 'Michael Brown' },
      { plate: '8XYZ456', make: 'Tesla', model: 'Model 3', year: '2023', owner: 'Amanda Davis' },
      { plate: '5DEF789', make: 'Sea Ray', model: 'Sundancer', year: '2019', owner: 'Robert Martinez' },
      { plate: 'JD350', make: 'John Deere', model: 'X350', year: '2020', owner: 'James Miller' },
      { plate: 'N/A', make: 'Samsung', model: 'Refrigerator RF28R7201SR', year: '2024', owner: 'Daniel Taylor' }
    ];

    let selectedCustomer = null;
    let selectedVehicle = null;
    let TAX_RATE = 0.085; // Will be loaded from settings
    let LABOR_RATE = 95.00; // Will be loaded from settings

    // Load settings
    function loadSettings() {
      // Load tax rate
      const savedTaxRate = localStorage.getItem('taxRate');
      if (savedTaxRate) {
        TAX_RATE = parseFloat(savedTaxRate) / 100; // Convert percentage to decimal
      }

      // Load labor rate
      const savedLaborRate = localStorage.getItem('laborRate');
      if (savedLaborRate) {
        LABOR_RATE = parseFloat(savedLaborRate);
      }

      // Load field visibility
      const fieldVisibility = JSON.parse(localStorage.getItem('fieldVisibility') || '{}');
      const fields = ['phone', 'licensePlate', 'technician', 'estimatedHours', 'vin', 'scheduledDate', 'priority', 'notes'];
      
      fields.forEach(field => {
        const fieldElement = document.getElementById('field_' + field);
        if (fieldElement) {
          if (fieldVisibility[field] === false) {
            fieldElement.style.display = 'none';
          }
        }
      });
    }

    // Load settings on page load
    loadSettings();

    // Load common jobs from settings
    function loadCommonJobs() {
      const commonJobs = JSON.parse(localStorage.getItem('commonJobs') || '[]');
      
      // Default jobs if none set
      if (commonJobs.length === 0) {
        const defaultJobs = [
          { name: 'Oil Change', fullText: 'Oil Change & Filter' },
          { name: 'Brake Service', fullText: 'Brake Service' },
          { name: 'Engine Service', fullText: 'Engine Service' },
          { name: 'Inspection', fullText: 'General Inspection' },
          { name: 'Transmission', fullText: 'Transmission Service' },
          { name: 'Tire Rotation', fullText: 'Tire Rotation' },
          { name: 'Battery', fullText: 'Battery Service' },
          { name: 'A/C Service', fullText: 'A/C Service' },
          { name: 'Fluid Change', fullText: 'Fluid Change' },
          { name: 'Tune-Up', fullText: 'Tune-Up' }
        ];
        localStorage.setItem('commonJobs', JSON.stringify(defaultJobs));
        renderCommonJobs(defaultJobs);
      } else {
        renderCommonJobs(commonJobs);
      }
    }

    function renderCommonJobs(jobs) {
      const container = document.getElementById('commonJobsButtons');
      container.innerHTML = jobs.map(job => 
        `<button type="button" class="quick-service-btn" onclick="insertService('${job.fullText.replace(/'/g, "\\'")}')">${job.name}</button>`
      ).join('');
    }

    // Initialize common jobs on page load
    loadCommonJobs();

    // Labor lines management
    let laborLines = [];
    let laborLineCounter = 0;

    function addLaborLine() {
      laborLineCounter++;
      laborLines.push({
        id: laborLineCounter,
        description: '',
        technician: '',
        hours: 0,
        partsCost: 0
      });
      renderLaborLines();
    }

    function removeLaborLine(id) {
      laborLines = laborLines.filter(line => line.id !== id);
      renderLaborLines();
      calculateTotalFromLines();
    }

    function updateLaborLine(id, field, value) {
      const line = laborLines.find(l => l.id === id);
      if (line) {
        line[field] = value;
        calculateTotalFromLines();
      }
    }

    function renderLaborLines() {
      const container = document.getElementById('laborLines');
      if (laborLines.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666; font-size: 0.875rem;">No labor lines added. Click "+ Add Labor Line" to add work items.</div>';
        return;
      }

      container.innerHTML = laborLines.map(line => `
        <div class="labor-line">
          <div class="labor-line-header">
            <span class="labor-line-number">Line #${line.id}</span>
            <button type="button" class="remove-line-btn" onclick="removeLaborLine(${line.id})">Remove</button>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Job Description</label>
              <input 
                type="text" 
                value="${line.description}" 
                onchange="updateLaborLine(${line.id}, 'description', this.value)"
                placeholder="e.g., Oil Change & Filter"
              >
            </div>
          </div>
          <div class="form-grid two-col" style="margin-top: 1rem;">
            <div class="form-group">
              <label>Technician</label>
              <select onchange="updateLaborLine(${line.id}, 'technician', this.value)">
                <option value="">Select technician...</option>
                <option value="John Smith" ${line.technician === 'John Smith' ? 'selected' : ''}>John Smith - Senior</option>
                <option value="Maria Garcia" ${line.technician === 'Maria Garcia' ? 'selected' : ''}>Maria Garcia - Master</option>
                <option value="David Chen" ${line.technician === 'David Chen' ? 'selected' : ''}>David Chen</option>
                <option value="Sarah Johnson" ${line.technician === 'Sarah Johnson' ? 'selected' : ''}>Sarah Johnson - Senior</option>
                <option value="Mike Wilson" ${line.technician === 'Mike Wilson' ? 'selected' : ''}>Mike Wilson - Apprentice</option>
              </select>
            </div>
            <div class="form-group">
              <label>Labor Hours</label>
              <input 
                type="number" 
                step="0.25"
                value="${line.hours}" 
                onchange="updateLaborLine(${line.id}, 'hours', parseFloat(this.value) || 0)"
                placeholder="0.0"
              >
            </div>
          </div>
          <div class="form-grid" style="margin-top: 1rem;">
            <div class="form-group">
              <label>Parts Cost ($)</label>
              <input 
                type="number" 
                step="0.01"
                value="${line.partsCost}" 
                onchange="updateLaborLine(${line.id}, 'partsCost', parseFloat(this.value) || 0)"
                placeholder="0.00"
              >
            </div>
          </div>
        </div>
      `).join('');
    }

    function calculateTotalFromLines() {
      let totalLaborHours = 0;
      let totalPartsCost = 0;

      laborLines.forEach(line => {
        totalLaborHours += parseFloat(line.hours) || 0;
        totalPartsCost += parseFloat(line.partsCost) || 0;
      });

      // Calculate labor cost from hours
      const laborCost = totalLaborHours * LABOR_RATE;
      
      // Update fields
      document.getElementById('laborTotal').value = laborCost.toFixed(2);
      document.getElementById('partsTotal').value = totalPartsCost.toFixed(2);
      
      // Update estimated hours display
      document.getElementById('estimatedHours').value = totalLaborHours.toFixed(2);
      updateTechHours();
      
      calculateTotal();
    }

    // Modified insertService to add as labor line
    function insertService(text) {
      const job = JSON.parse(localStorage.getItem('commonJobs') || '[]').find(j => j.fullText === text);
      
      if (job) {
        laborLineCounter++;
        laborLines.push({
          id: laborLineCounter,
          description: job.fullText,
          technician: '',
          hours: parseFloat(job.laborHours) || 0,
          partsCost: parseFloat(job.partsCost) || 0
        });
        renderLaborLines();
        calculateTotalFromLines();
      }
    }

    // Calculate total with tax
    function calculateTotal() {
      const labor = parseFloat(document.getElementById('laborTotal').value) || 0;
      const parts = parseFloat(document.getElementById('partsTotal').value) || 0;
      const fees = parseFloat(document.getElementById('additionalFees').value) || 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;

      const subtotal = labor + parts + fees - discount;
      const tax = subtotal * TAX_RATE;
      const total = subtotal + tax;

      // Update summary
      document.getElementById('summaryLabor').textContent = '$' + labor.toFixed(2);
      document.getElementById('summaryParts').textContent = '$' + parts.toFixed(2);
      document.getElementById('summaryFees').textContent = '$' + fees.toFixed(2);
      document.getElementById('summaryDiscount').textContent = '-$' + discount.toFixed(2);
      document.getElementById('summarySubtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('summaryTax').textContent = '$' + tax.toFixed(2);
      document.getElementById('summaryTotal').textContent = '$' + total.toFixed(2);
    }

    // Technician selection
    document.getElementById('technician').addEventListener('change', function() {
      const selectedValue = this.value;
      if (selectedValue) {
        const parts = selectedValue.split(' - ');
        const name = parts[0];
        const role = parts[1] || 'Technician';
        const initials = name.split(' ').map(n => n[0]).join('');

        document.getElementById('techName').textContent = name;
        document.getElementById('techRole').textContent = role;
        document.getElementById('techInitials').textContent = initials;
        
        // Update hours display if entered
        updateTechHours();
        
        document.getElementById('selectedTechnician').style.display = 'block';
      } else {
        document.getElementById('selectedTechnician').style.display = 'none';
      }
    });

    function updateTechHours() {
      const hours = parseFloat(document.getElementById('estimatedHours').value) || 0;
      if (hours > 0) {
        document.getElementById('techHours').textContent = hours.toFixed(2) + (hours === 1 ? ' hr' : ' hrs');
      } else {
        document.getElementById('techHours').textContent = '-- hrs';
      }
    }

    // License plate search functionality
    const licensePlateSearch = document.getElementById('licensePlateSearch');
    const vehicleResults = document.getElementById('vehicleResults');

    licensePlateSearch.addEventListener('input', function() {
      const searchValue = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      
      if (searchValue.length >= 2) {
        const matches = vehicles.filter(v => v.plate.includes(searchValue));
        
        if (matches.length > 0) {
          let html = '';
          matches.forEach(vehicle => {
            const vehicleDesc = `${vehicle.year} ${vehicle.make} ${vehicle.model}`;
            html += `
              <div class="customer-result-item" onclick="selectVehicle('${vehicle.plate}', '${vehicleDesc}', '${vehicle.owner}')">
                <div class="customer-result-name">${vehicleDesc}</div>
                <div class="customer-result-phone">Plate: ${vehicle.plate}</div>
                <div class="customer-result-details">Owner: ${vehicle.owner}</div>
              </div>
            `;
          });
          vehicleResults.innerHTML = html;
          vehicleResults.classList.add('show');
        } else {
          vehicleResults.innerHTML = '<div class="no-results">No vehicle found with this plate</div>';
          vehicleResults.classList.add('show');
        }
      } else {
        vehicleResults.classList.remove('show');
      }
    });

    // Select vehicle from search results
    function selectVehicle(plate, vehicleDesc, owner) {
      selectedVehicle = { plate, vehicleDesc, owner };
      
      // Hide search results
      vehicleResults.classList.remove('show');
      
      // Show selected vehicle
      document.getElementById('vehicleInfo').textContent = vehicleDesc;
      document.getElementById('vehiclePlate').textContent = `License Plate: ${plate} • Owner: ${owner}`;
      document.getElementById('selectedVehicle').style.display = 'block';
      
      // Hide license plate search and manual entry
      licensePlateSearch.style.display = 'none';
      document.getElementById('vehicle').style.display = 'none';
      
      // Auto-fill vehicle field
      document.getElementById('vehicle').value = vehicleDesc;
    }

    // Clear vehicle selection
    function clearVehicle() {
      selectedVehicle = null;
      document.getElementById('selectedVehicle').style.display = 'none';
      document.getElementById('licensePlateSearch').style.display = 'block';
      document.getElementById('vehicle').style.display = 'block';
      document.getElementById('licensePlateSearch').value = '';
      document.getElementById('vehicle').value = '';
      licensePlateSearch.focus();
    }

    // Phone search functionality
    const phoneSearch = document.getElementById('phoneSearch');
    const customerResults = document.getElementById('customerResults');

    phoneSearch.addEventListener('input', function() {
      const searchValue = this.value.replace(/\D/g, ''); // Remove non-digits
      
      if (searchValue.length >= 3) {
        const matches = customers.filter(c => c.phone.includes(searchValue));
        
        if (matches.length > 0) {
          let html = '';
          matches.forEach(customer => {
            html += `
              <div class="customer-result-item" onclick="selectCustomer('${customer.name}', '${customer.phone}', '${customer.vehicle}')">
                <div class="customer-result-name">${customer.name}</div>
                <div class="customer-result-phone">${formatPhone(customer.phone)}</div>
                <div class="customer-result-details">${customer.vehicle}</div>
              </div>
            `;
          });
          customerResults.innerHTML = html;
          customerResults.classList.add('show');
        } else {
          // No customer found - show new customer form
          customerResults.innerHTML = '<div class="no-results">No customer found with this number</div>';
          customerResults.classList.add('show');
          
          // Show new customer form after a delay
          setTimeout(() => {
            customerResults.classList.remove('show');
            document.getElementById('newCustomerForm').style.display = 'block';
            document.getElementById('newPhone').value = formatPhone(searchValue);
            document.getElementById('firstName').required = true;
            document.getElementById('lastName').required = true;
            document.getElementById('vehicle').required = true;
          }, 1500);
        }
      } else {
        customerResults.classList.remove('show');
        document.getElementById('newCustomerForm').style.display = 'none';
      }
    });

    // Format phone number
    function formatPhone(phone) {
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 10) {
        return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)}-${cleaned.substring(6)}`;
      }
      return phone;
    }

    // Select customer from search results
    function selectCustomer(name, phone, vehicle) {
      selectedCustomer = { name, phone, vehicle };
      
      // Hide search results
      customerResults.classList.remove('show');
      
      // Show selected customer
      document.getElementById('customerName').textContent = name;
      document.getElementById('customerDetails').textContent = `${formatPhone(phone)} • ${vehicle}`;
      document.getElementById('selectedCustomer').style.display = 'block';
      
      // Hide phone search
      phoneSearch.style.display = 'none';
      
      // Hide new customer form if shown
      document.getElementById('newCustomerForm').style.display = 'none';
    }

    // Clear customer selection
    function clearCustomer() {
      selectedCustomer = null;
      document.getElementById('selectedCustomer').style.display = 'none';
      document.getElementById('phoneSearch').style.display = 'block';
      document.getElementById('phoneSearch').value = '';
      document.getElementById('phoneSearch').focus();
    }

    // Insert service into description
    function insertService(serviceName) {
      const textarea = document.getElementById('serviceDescription');
      if (textarea.value.trim() === '') {
        textarea.value = serviceName;
      } else {
        textarea.value += '\n' + serviceName;
      }
      textarea.focus();
    }

    // Form submission
    document.getElementById('workOrderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      await createWorkOrder();
    });

    async function createWorkOrder() {
      let customerName, phone, vehicle;
      
      if (selectedCustomer) {
        customerName = selectedCustomer.name;
        phone = selectedCustomer.phone;
        vehicle = selectedCustomer.vehicle;
      } else {
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        
        if (!firstName || !lastName) {
          showAlert('Please complete customer information or search by phone', 'error');
          return;
        }
        
        customerName = `${firstName} ${lastName}`;
        phone = document.getElementById('newPhone').value.replace(/\D/g, '');
      }

      if (selectedVehicle) {
        vehicle = selectedVehicle.vehicleDesc;
      } else {
        vehicle = document.getElementById('vehicle').value;
        if (!vehicle) {
          showAlert('Please select or enter vehicle information', 'error');
          return;
        }
      }

      const serviceDescription = document.getElementById('serviceDescription').value;
      const scheduledDate = document.getElementById('scheduledDate').value;
      const technician = document.getElementById('technician').value;
      const estimatedHours = parseFloat(document.getElementById('estimatedHours').value) || 0;

      if (!technician) {
        showAlert('Please assign a technician', 'error');
        return;
      }

      if (laborLines.length === 0) {
        showAlert('Please add at least one labor line', 'error');
        return;
      }

      const totalText = document.getElementById('summaryTotal').textContent;
      const totalAmount = parseFloat(totalText.replace('$', '').replace(',', ''));

      if (totalAmount <= 0) {
        showAlert('Please enter pricing information', 'error');
        return;
      }

      showAlert('Creating work order...', 'success');

      await new Promise(resolve => setTimeout(resolve, 1000));

      const orderNumber = 'RO-2025-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');

      let mockOrders = JSON.parse(sessionStorage.getItem('mockOrders') || '[]');
      mockOrders.push({
        id: mockOrders.length + 4,
        order_number: orderNumber,
        customer: customerName,
        phone: formatPhone(phone),
        vehicle: vehicle,
        service: laborLines.map(l => l.description).join(', '),
        scheduled_date: scheduledDate,
        status: 'scheduled',
        total_amount: totalAmount,
        technician: technician.split(' - ')[0],
        estimated_hours: estimatedHours,
        labor_lines: laborLines
      });
      sessionStorage.setItem('mockOrders', JSON.stringify(mockOrders));

      showAlert(`✓ Work order ${orderNumber} created! Assigned to ${technician.split(' - ')[0]}${estimatedHours > 0 ? ' (' + estimatedHours.toFixed(2) + ' hrs)' : ''}`, 'success');
      
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 1500);
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert ${type} show`;
    }

    function resetForm() {
      document.getElementById('workOrderForm').reset();
      document.getElementById('alert').classList.remove('show');
      document.getElementById('selectedCustomer').style.display = 'none';
      document.getElementById('newCustomerForm').style.display = 'none';
      document.getElementById('selectedTechnician').style.display = 'none';
      document.getElementById('selectedVehicle').style.display = 'none';
      document.getElementById('phoneSearch').style.display = 'block';
      document.getElementById('phoneSearch').value = '';
      document.getElementById('licensePlateSearch').style.display = 'block';
      document.getElementById('licensePlateSearch').value = '';
      document.getElementById('vehicle').style.display = 'block';
      selectedCustomer = null;
      selectedVehicle = null;
      
      // Reset calculations
      calculateTotal();
      
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('scheduledDate').value = tomorrow.toISOString().split('T')[0];
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!phoneSearch.contains(e.target) && !customerResults.contains(e.target)) {
        customerResults.classList.remove('show');
      }
      if (!licensePlateSearch.contains(e.target) && !vehicleResults.contains(e.target)) {
        vehicleResults.classList.remove('show');
      }
    });
  </script>
</body>
</html>
