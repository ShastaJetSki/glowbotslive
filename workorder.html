<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Work Order - Service Logic Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/supabase-config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --primary-dark: #764ba2;
      --charcoal: #36454f;
      --white: #ffffff;
      --bg: #f5f7fa;
      --shadow: rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--charcoal);
      min-height: 100vh;
    }

    /* Topbar */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: var(--white);
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      z-index: 100;
      box-shadow: 0 2px 10px var(--shadow);
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .back-btn {
      margin-left: auto;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.625rem 1.25rem;
      background: var(--white);
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      color: var(--charcoal);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Main Content */
    .main-content {
      margin-top: 70px;
      padding: 2.5rem 2rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .page-header {
      margin-bottom: 2.5rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-subtitle {
      font-size: 1rem;
      color: #666;
      font-weight: 500;
    }

    /* Form Card */
    .form-card {
      background: var(--white);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 4px 20px var(--shadow);
      border: 1px solid #f0f0f0;
    }

    .form-section {
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #f0f0f0;
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--charcoal);
      margin-bottom: 1.5rem;
      letter-spacing: -0.3px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .form-grid.two-col {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 0.5rem;
      letter-spacing: 0.3px;
    }

    input, select, textarea {
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      padding: 0.875rem 1rem;
      background: var(--white);
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      color: var(--charcoal);
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    input::placeholder, textarea::placeholder {
      color: #999;
      font-weight: 400;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2.5rem;
    }

    .btn {
      flex: 1;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.2px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-secondary {
      background: var(--white);
      border: 2px solid #e0e0e0;
      color: var(--charcoal);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Customer Search Results */
    .customer-results {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-top: 0.5rem;
      box-shadow: 0 4px 20px var(--shadow);
      display: none;
    }

    .customer-results.show {
      display: block;
    }

    .customer-result-item {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .customer-result-item:hover {
      background: #f9fafb;
    }

    .customer-result-item:last-child {
      border-bottom: none;
    }

    .customer-result-name {
      font-weight: 700;
      color: var(--charcoal);
      margin-bottom: 0.25rem;
    }

    .customer-result-details {
      font-size: 0.875rem;
      color: #666;
    }

    .customer-result-phone {
      font-size: 0.875rem;
      color: var(--primary);
      font-weight: 600;
    }

    .no-results {
      padding: 1rem;
      text-align: center;
      color: #666;
      font-size: 0.875rem;
    }

    /* Quick Service Buttons */
    .quick-service-btn {
      font-family: 'Inter', sans-serif;
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      color: var(--charcoal);
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-service-btn:hover {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-color: transparent;
      color: white;
    }

    .add-btn {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--white);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .labor-line {
      background: #f9fafb;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .labor-line-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .labor-line-number {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--primary);
    }

    .remove-line-btn {
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      background: #fee2e2;
      border: 2px solid #ef4444;
      border-radius: 8px;
      color: #991b1b;
      cursor: pointer;
      transition: all 0.2s;
    }

    .remove-line-btn:hover {
      background: #ef4444;
      color: white;
    }

    /* Alert */
    .alert {
      padding: 1.25rem;
      border-radius: 12px;
      margin-top: 1.5rem;
      font-weight: 600;
      text-align: center;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }

    @media (max-width: 768px) {
      .page-title { font-size: 2rem; }
      .form-card { padding: 2rem 1.5rem; }
      .button-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="logo">Service Manager</div>
    <div style="display: flex; gap: 1rem; margin-left: auto;">
      <a href="settings.html" class="back-btn" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none;">‚öôÔ∏è Settings</a>
      <a href="dashboard.html" class="back-btn">‚Üê Back</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="page-header">
      <h1 class="page-title">New Work Order</h1>
      <p class="page-subtitle">Create a new service appointment for your customer</p>
    </div>

    <!-- Form -->
    <div class="form-card">
      <form id="workOrderForm">
        <!-- Customer & Vehicle -->
        <div class="form-section">
          <h3 class="section-title">Customer & Vehicle</h3>
          <div class="form-grid two-col">
            <div class="form-group" id="field_phone">
              <label>Customer Phone Number</label>
              <input 
                type="tel" 
                id="phoneSearch" 
                placeholder="Search by phone number..."
                autocomplete="off"
              >
              <div id="customerResults" class="customer-results"></div>
            </div>

            <div class="form-group" id="field_licensePlate">
              <label>License Plate Number</label>
              <input 
                type="text" 
                id="licensePlateSearch" 
                placeholder="Search by license plate..."
                autocomplete="off"
              >
              <div id="vehicleResults" class="customer-results"></div>
            </div>
          </div>

          <div class="form-grid two-col" style="margin-top: 1.5rem;">
            <div class="form-group" id="field_technician">
              <label>Assigned Technician</label>
              <select id="technician" required>
                <option value="">Select technician...</option>
              </select>
            </div>

            <div class="form-group" id="field_estimatedHours">
              <label>Estimated Hours (Total from labor lines)</label>
              <input 
                type="number" 
                id="estimatedHours" 
                step="0.25" 
                placeholder="0.0"
                min="0"
                readonly
                style="background: #f9fafb;"
              >
            </div>
          </div>

          <div class="form-group" id="field_vin" style="margin-top: 1.5rem;">
            <label>VIN Number</label>
            <input 
              type="text" 
              id="vinNumber" 
              placeholder="Enter 17-character VIN..."
              maxlength="17"
              style="text-transform: uppercase;"
            >
          </div>

          <!-- Selected Customer Display -->
          <div id="selectedCustomer" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 0.25rem;" id="customerName"></div>
                <div style="font-size: 0.875rem; color: #666;" id="customerDetails"></div>
              </div>
              <button type="button" onclick="clearCustomer()" style="font-size: 0.875rem; padding: 0.5rem 1rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-weight: 600;">Change</button>
            </div>
          </div>

          <!-- Selected Vehicle Display -->
          <div id="selectedVehicle" style="display: none; margin-top: 1rem; padding: 1rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 0.25rem;" id="vehicleInfo"></div>
                <div style="font-size: 0.875rem; color: #666;" id="vehiclePlate"></div>
              </div>
              <button type="button" onclick="clearVehicle()" style="font-size: 0.875rem; padding: 0.5rem 1rem; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-weight: 600;">Change</button>
            </div>
          </div>

          <!-- Selected Technician Display -->
          <div id="selectedTechnician" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.25rem;" id="techInitials"></div>
              <div style="flex: 1;">
                <div style="font-weight: 700; color: var(--charcoal);" id="techName"></div>
                <div style="font-size: 0.875rem; color: #666;" id="techRole"></div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 0.875rem; color: #666;">Estimated Time</div>
                <div style="font-weight: 700; font-size: 1.125rem; color: var(--primary);" id="techHours">-- hrs</div>
              </div>
            </div>
          </div>

          <!-- New Customer Form -->
          <div id="newCustomerForm" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;">
            <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 1rem;">New Customer - Not Found</div>
            <div class="form-grid two-col">
              <div class="form-group">
                <label>First Name *</label>
                <input type="text" id="firstName" placeholder="Enter first name" required>
              </div>
              <div class="form-group">
                <label>Last Name *</label>
                <input type="text" id="lastName" placeholder="Enter last name" required>
              </div>
            </div>
            <div class="form-grid two-col" style="margin-top: 1rem;">
              <div class="form-group">
                <label>Phone *</label>
                <input type="tel" id="newPhone" placeholder="Phone number" readonly>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="newEmail" placeholder="customer@email.com">
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Address</label>
              <input type="text" id="newAddress" placeholder="Street address">
            </div>
            <div class="form-grid three-col" style="margin-top: 1rem;">
              <div class="form-group">
                <label>City</label>
                <input type="text" id="newCity" placeholder="City">
              </div>
              <div class="form-group">
                <label>State</label>
                <input type="text" id="newState" placeholder="CA" maxlength="2">
              </div>
              <div class="form-group">
                <label>ZIP</label>
                <input type="text" id="newZip" placeholder="94102">
              </div>
            </div>
            <button type="button" onclick="saveNewCustomer()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              Save Customer & Continue
            </button>
          </div>

          <!-- New Vehicle Form -->
          <div id="newVehicleForm" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 12px;">
            <div style="font-weight: 700; color: var(--charcoal); margin-bottom: 1rem;">Add Vehicle for Customer</div>
            <div class="form-grid two-col">
              <div class="form-group">
                <label>Year *</label>
                <input type="number" id="vehicleYear" placeholder="2024" min="1900" max="2030" required>
              </div>
              <div class="form-group">
                <label>Make *</label>
                <input type="text" id="vehicleMake" placeholder="Toyota" required>
              </div>
            </div>
            <div class="form-grid two-col" style="margin-top: 1rem;">
              <div class="form-group">
                <label>Model *</label>
                <input type="text" id="vehicleModel" placeholder="Camry" required>
              </div>
              <div class="form-group">
                <label>Color</label>
                <input type="text" id="vehicleColor" placeholder="Silver">
              </div>
            </div>
            <div class="form-grid two-col" style="margin-top: 1rem;">
              <div class="form-group">
                <label>VIN</label>
                <input type="text" id="vehicleVin" placeholder="17-character VIN" maxlength="17">
              </div>
              <div class="form-group">
                <label>License Plate</label>
                <input type="text" id="vehiclePlate" placeholder="ABC123">
              </div>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label>Mileage</label>
              <input type="number" id="vehicleMileage" placeholder="Current odometer reading">
            </div>
            <button type="button" onclick="saveNewVehicle()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              Save Vehicle & Continue
            </button>
          </div>
        </div>

        <!-- Service Details -->
        <div class="form-section">
          <h3 class="section-title">Service Details</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Service Description</label>
              <textarea 
                id="serviceDescription" 
                placeholder="Describe the service needed in detail..."
                style="min-height: 120px;"
                required
              ></textarea>
            </div>
          </div>

          <div class="form-grid two-col" style="margin-top: 1.5rem;">
            <div class="form-group" id="field_scheduledDate">
              <label>Scheduled Date</label>
              <input type="date" id="scheduledDate" required>
            </div>
            <div class="form-group" id="field_priority">
              <label>Priority</label>
              <select id="priority" required>
                <option value="low">Low</option>
                <option value="normal" selected>Normal</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>

          <div class="form-group" id="field_notes" style="margin-top: 1.5rem;">
            <label>Internal Notes (Optional)</label>
            <textarea id="notes" placeholder="Add any internal notes or special instructions..." style="min-height: 80px;"></textarea>
          </div>
        </div>

        <!-- Common Jobs -->
        <div class="form-section">
          <h3 class="section-title">Common Jobs (Quick Add)</h3>
          <div id="commonJobsButtons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <!-- Buttons will be loaded from settings -->
          </div>
        </div>

        <!-- Labor Lines -->
        <div class="form-section">
          <h3 class="section-title">Labor Lines</h3>
          <div id="laborLines">
            <!-- Labor lines will be added here -->
          </div>
          <button type="button" class="add-btn" onclick="addLaborLine()" style="margin-top: 1rem; font-size: 0.875rem; padding: 0.75rem 1.5rem;">+ Add Labor Line</button>
        </div>

        <!-- Pricing -->
        <div class="form-section">
          <h3 class="section-title">Pricing & Payment</h3>
          <div class="form-grid two-col">
            <div class="form-group">
              <label>Labor Cost (Auto-calculated from hours)</label>
              <input type="number" id="laborTotal" step="0.01" placeholder="0.00" value="0" readonly style="background: #f9fafb;">
            </div>
            <div class="form-group">
              <label>Parts Cost</label>
              <input type="number" id="partsTotal" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
          </div>

          <div class="form-grid two-col">
            <div class="form-group">
              <label>Additional Fees</label>
              <input type="number" id="additionalFees" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
            <div class="form-group">
              <label>Discount</label>
              <input type="number" id="discount" step="0.01" placeholder="0.00" value="0" oninput="calculateTotal()">
            </div>
          </div>

          <!-- Bill Summary -->
          <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 2px solid #0ea5e9;">
            <div style="font-weight: 700; font-size: 1.125rem; color: var(--charcoal); margin-bottom: 1rem;">Bill Summary</div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Labor:</span>
              <span style="font-weight: 600;" id="summaryLabor">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Parts:</span>
              <span style="font-weight: 600;" id="summaryParts">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Additional Fees:</span>
              <span style="font-weight: 600;" id="summaryFees">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Discount:</span>
              <span style="font-weight: 600; color: #10b981;" id="summaryDiscount">-$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 2px solid #0ea5e9;">
              <span style="color: #666; font-weight: 600;">Subtotal:</span>
              <span style="font-weight: 700;" id="summarySubtotal">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #bae6fd;">
              <span style="color: #666;">Tax (8.5%):</span>
              <span style="font-weight: 600;" id="summaryTax">$0.00</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; padding: 1rem 0 0.5rem 0;">
              <span style="font-weight: 700; font-size: 1.25rem; color: var(--primary);">Total:</span>
              <span style="font-weight: 700; font-size: 1.5rem; color: var(--primary);" id="summaryTotal">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="button-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
          <button type="button" class="btn btn-secondary" onclick="resetForm()">üóëÔ∏è Reset</button>
          <button type="button" class="btn btn-secondary" onclick="loadDraft()" style="background: #6366f1; color: white;">üìÇ Load Draft</button>
          <button type="button" class="btn btn-secondary" onclick="saveDraft()" style="background: #f59e0b; color: white;">üíæ Save Draft</button>
          <button type="submit" class="btn btn-primary">‚úì Create Order</button>
        </div>
      </form>

      <div id="alert" class="alert"></div>
    </div>
  </div>

  <script>
    if (!sessionStorage.getItem('isAuthenticated')) {
      window.location.href = 'login.html';
    }

    // Check if viewing existing order
    const urlParams = new URLSearchParams(window.location.search);
    const orderNumber = urlParams.get('order');

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('scheduledDate').value = tomorrow.toISOString().split('T')[0];

    // Load existing order after page setup
    if (orderNumber) {
      setTimeout(() => loadExistingOrder(orderNumber), 100);
    }

    // Customer database
    const customers = [
      { name: 'Michael Brown', phone: '4085552001', vehicle: '2021 Honda Accord' },
      { name: 'Amanda Davis', phone: '4085552002', vehicle: '2023 Tesla Model 3' },
      { name: 'Robert Martinez', phone: '5105551001', vehicle: '2019 Sea Ray Sundancer' },
      { name: 'James Miller', phone: '4085553001', vehicle: '2020 John Deere X350' },
      { name: 'Daniel Taylor', phone: '6505554001', vehicle: 'Samsung Refrigerator RF28R7201SR' }
    ];

    // Vehicle database with license plates
    const vehicles = [
      { plate: '7ABC123', make: 'Honda', model: 'Accord', year: '2021', owner: 'Michael Brown' },
      { plate: '8XYZ456', make: 'Tesla', model: 'Model 3', year: '2023', owner: 'Amanda Davis' },
      { plate: '5DEF789', make: 'Sea Ray', model: 'Sundancer', year: '2019', owner: 'Robert Martinez' },
      { plate: 'JD350', make: 'John Deere', model: 'X350', year: '2020', owner: 'James Miller' },
      { plate: 'N/A', make: 'Samsung', model: 'Refrigerator RF28R7201SR', year: '2024', owner: 'Daniel Taylor' }
    ];

    let selectedCustomer = null;
    let selectedVehicle = null;
    let TAX_RATE = 0.085; // Will be loaded from settings
    let LABOR_RATE = 95.00; // Will be loaded from settings

    // Load settings
    function loadSettings() {
      // Load tax rate
      const savedTaxRate = localStorage.getItem('taxRate');
      if (savedTaxRate) {
        TAX_RATE = parseFloat(savedTaxRate) / 100; // Convert percentage to decimal
      }

      // Load labor rate
      const savedLaborRate = localStorage.getItem('laborRate');
      if (savedLaborRate) {
        LABOR_RATE = parseFloat(savedLaborRate);
      }

      // Load field visibility
      const fieldVisibility = JSON.parse(localStorage.getItem('fieldVisibility') || '{}');
      const fields = ['phone', 'licensePlate', 'technician', 'estimatedHours', 'vin', 'scheduledDate', 'priority', 'notes'];
      
      fields.forEach(field => {
        const fieldElement = document.getElementById('field_' + field);
        if (fieldElement) {
          if (fieldVisibility[field] === false) {
            fieldElement.style.display = 'none';
          }
        }
      });
    }

    // Load settings on page load
    loadSettings();
    loadTechnicians();

    // Load technicians from Supabase
    async function loadTechnicians() {
      try {
        const techs = await window.ServiceLogicDB.fetchTechnicians();
        const select = document.getElementById('technician');
        
        techs.forEach(tech => {
          const option = document.createElement('option');
          option.value = tech.id;
          option.textContent = `${tech.full_name}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading technicians:', error);
      }
    }

    // Load common jobs from settings
    function loadCommonJobs() {
      const commonJobs = JSON.parse(localStorage.getItem('commonJobs') || '[]');
      
      // Default jobs if none set
      if (commonJobs.length === 0) {
        const defaultJobs = [
          { name: 'Oil Change', fullText: 'Oil Change & Filter' },
          { name: 'Brake Service', fullText: 'Brake Service' },
          { name: 'Engine Service', fullText: 'Engine Service' },
          { name: 'Inspection', fullText: 'General Inspection' },
          { name: 'Transmission', fullText: 'Transmission Service' },
          { name: 'Tire Rotation', fullText: 'Tire Rotation' },
          { name: 'Battery', fullText: 'Battery Service' },
          { name: 'A/C Service', fullText: 'A/C Service' },
          { name: 'Fluid Change', fullText: 'Fluid Change' },
          { name: 'Tune-Up', fullText: 'Tune-Up' }
        ];
        localStorage.setItem('commonJobs', JSON.stringify(defaultJobs));
        renderCommonJobs(defaultJobs);
      } else {
        renderCommonJobs(commonJobs);
      }
    }

    function renderCommonJobs(jobs) {
      const container = document.getElementById('commonJobsButtons');
      container.innerHTML = jobs.map(job => 
        `<button type="button" class="quick-service-btn" onclick="insertService('${job.fullText.replace(/'/g, "\\'")}')">${job.name}</button>`
      ).join('');
    }

    // Initialize common jobs on page load
    loadCommonJobs();

    // Labor lines management
    let laborLines = [];
    let laborLineCounter = 0;

    function addLaborLine() {
      laborLineCounter++;
      laborLines.push({
        id: laborLineCounter,
        description: '',
        technician: '',
        hours: 0,
        partsCost: 0
      });
      renderLaborLines();
    }

    function removeLaborLine(id) {
      laborLines = laborLines.filter(line => line.id !== id);
      renderLaborLines();
      calculateTotalFromLines();
    }

    function updateLaborLine(id, field, value) {
      const line = laborLines.find(l => l.id === id);
      if (line) {
        line[field] = value;
        calculateTotalFromLines();
      }
    }

    function renderLaborLines() {
      const container = document.getElementById('laborLines');
      if (laborLines.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666; font-size: 0.875rem;">No labor lines added. Click "+ Add Labor Line" to add work items.</div>';
        return;
      }

      container.innerHTML = laborLines.map(line => `
        <div class="labor-line">
          <div class="labor-line-header">
            <span class="labor-line-number">Line #${line.id}</span>
            <button type="button" class="remove-line-btn" onclick="removeLaborLine(${line.id})">Remove</button>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Job Description</label>
              <input 
                type="text" 
                value="${line.description}" 
                onchange="updateLaborLine(${line.id}, 'description', this.value)"
                placeholder="e.g., Oil Change & Filter"
              >
            </div>
          </div>
          <div class="form-grid two-col" style="margin-top: 1rem;">
            <div class="form-group">
              <label>Technician</label>
              <select onchange="updateLaborLine(${line.id}, 'technician', this.value)">
                <option value="">Select technician...</option>
                <option value="John Smith" ${line.technician === 'John Smith' ? 'selected' : ''}>John Smith - Senior</option>
                <option value="Maria Garcia" ${line.technician === 'Maria Garcia' ? 'selected' : ''}>Maria Garcia - Master</option>
                <option value="David Chen" ${line.technician === 'David Chen' ? 'selected' : ''}>David Chen</option>
                <option value="Sarah Johnson" ${line.technician === 'Sarah Johnson' ? 'selected' : ''}>Sarah Johnson - Senior</option>
                <option value="Mike Wilson" ${line.technician === 'Mike Wilson' ? 'selected' : ''}>Mike Wilson - Apprentice</option>
              </select>
            </div>
            <div class="form-group">
              <label>Labor Hours</label>
              <input 
                type="number" 
                step="0.25"
                value="${line.hours}" 
                onchange="updateLaborLine(${line.id}, 'hours', parseFloat(this.value) || 0)"
                placeholder="0.0"
              >
            </div>
          </div>
          <div class="form-grid" style="margin-top: 1rem;">
            <div class="form-group">
              <label>Parts Cost ($)</label>
              <input 
                type="number" 
                step="0.01"
                value="${line.partsCost}" 
                onchange="updateLaborLine(${line.id}, 'partsCost', parseFloat(this.value) || 0)"
                placeholder="0.00"
              >
            </div>
          </div>
        </div>
      `).join('');
    }

    function calculateTotalFromLines() {
      let totalLaborHours = 0;
      let totalPartsCost = 0;

      laborLines.forEach(line => {
        totalLaborHours += parseFloat(line.hours) || 0;
        totalPartsCost += parseFloat(line.partsCost) || 0;
      });

      // Calculate labor cost from hours
      const laborCost = totalLaborHours * LABOR_RATE;
      
      // Update fields
      document.getElementById('laborTotal').value = laborCost.toFixed(2);
      document.getElementById('partsTotal').value = totalPartsCost.toFixed(2);
      
      // Update estimated hours display
      document.getElementById('estimatedHours').value = totalLaborHours.toFixed(2);
      updateTechHours();
      
      calculateTotal();
    }

    // Modified insertService to add as labor line
    function insertService(text) {
      const job = JSON.parse(localStorage.getItem('commonJobs') || '[]').find(j => j.fullText === text);
      
      if (job) {
        laborLineCounter++;
        laborLines.push({
          id: laborLineCounter,
          description: job.fullText,
          technician: '',
          hours: parseFloat(job.laborHours) || 0,
          partsCost: parseFloat(job.partsCost) || 0
        });
        renderLaborLines();
        calculateTotalFromLines();
      }
    }

    // Calculate total with tax
    function calculateTotal() {
      const labor = parseFloat(document.getElementById('laborTotal').value) || 0;
      const parts = parseFloat(document.getElementById('partsTotal').value) || 0;
      const fees = parseFloat(document.getElementById('additionalFees').value) || 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;

      const subtotal = labor + parts + fees - discount;
      const tax = subtotal * TAX_RATE;
      const total = subtotal + tax;

      // Update summary
      document.getElementById('summaryLabor').textContent = '$' + labor.toFixed(2);
      document.getElementById('summaryParts').textContent = '$' + parts.toFixed(2);
      document.getElementById('summaryFees').textContent = '$' + fees.toFixed(2);
      document.getElementById('summaryDiscount').textContent = '-$' + discount.toFixed(2);
      document.getElementById('summarySubtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('summaryTax').textContent = '$' + tax.toFixed(2);
      document.getElementById('summaryTotal').textContent = '$' + total.toFixed(2);
    }

    // Technician selection
    document.getElementById('technician').addEventListener('change', function() {
      const selectedValue = this.value;
      if (selectedValue) {
        const parts = selectedValue.split(' - ');
        const name = parts[0];
        const role = parts[1] || 'Technician';
        const initials = name.split(' ').map(n => n[0]).join('');

        document.getElementById('techName').textContent = name;
        document.getElementById('techRole').textContent = role;
        document.getElementById('techInitials').textContent = initials;
        
        // Update hours display if entered
        updateTechHours();
        
        document.getElementById('selectedTechnician').style.display = 'block';
      } else {
        document.getElementById('selectedTechnician').style.display = 'none';
      }
    });

    function updateTechHours() {
      const hours = parseFloat(document.getElementById('estimatedHours').value) || 0;
      if (hours > 0) {
        document.getElementById('techHours').textContent = hours.toFixed(2) + (hours === 1 ? ' hr' : ' hrs');
      } else {
        document.getElementById('techHours').textContent = '-- hrs';
      }
    }

    // License plate search functionality
    const licensePlateSearch = document.getElementById('licensePlateSearch');
    const vehicleResults = document.getElementById('vehicleResults');

    licensePlateSearch.addEventListener('input', function() {
      const searchValue = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      
      if (searchValue.length >= 2) {
        const matches = vehicles.filter(v => v.plate.includes(searchValue));
        
        if (matches.length > 0) {
          let html = '';
          matches.forEach(vehicle => {
            const vehicleDesc = `${vehicle.year} ${vehicle.make} ${vehicle.model}`;
            html += `
              <div class="customer-result-item" onclick="selectVehicle('${vehicle.plate}', '${vehicleDesc}', '${vehicle.owner}')">
                <div class="customer-result-name">${vehicleDesc}</div>
                <div class="customer-result-phone">Plate: ${vehicle.plate}</div>
                <div class="customer-result-details">Owner: ${vehicle.owner}</div>
              </div>
            `;
          });
          vehicleResults.innerHTML = html;
          vehicleResults.classList.add('show');
        } else {
          vehicleResults.innerHTML = '<div class="no-results">No vehicle found with this plate</div>';
          vehicleResults.classList.add('show');
        }
      } else {
        vehicleResults.classList.remove('show');
      }
    });

    // Select vehicle from search results
    function selectVehicle(plate, vehicleDesc, owner) {
      selectedVehicle = { plate, vehicleDesc, owner };
      
      // Hide search results
      vehicleResults.classList.remove('show');
      
      // Show selected vehicle
      document.getElementById('vehicleInfo').textContent = vehicleDesc;
      document.getElementById('vehiclePlate').textContent = `License Plate: ${plate} ‚Ä¢ Owner: ${owner}`;
      document.getElementById('selectedVehicle').style.display = 'block';
      
      // Hide license plate search and manual entry
      licensePlateSearch.style.display = 'none';
      document.getElementById('vehicle').style.display = 'none';
      
      // Auto-fill vehicle field
      document.getElementById('vehicle').value = vehicleDesc;
    }

    // Clear vehicle selection
    function clearVehicle() {
      selectedVehicle = null;
      document.getElementById('selectedVehicle').style.display = 'none';
      document.getElementById('licensePlateSearch').style.display = 'block';
      document.getElementById('vehicle').style.display = 'block';
      document.getElementById('licensePlateSearch').value = '';
      document.getElementById('vehicle').value = '';
      licensePlateSearch.focus();
    }

    // Phone search functionality - SUPABASE VERSION
    const phoneSearch = document.getElementById('phoneSearch');
    const customerResults = document.getElementById('customerResults');
    let searchTimeout;

    phoneSearch.addEventListener('input', async function() {
      const searchValue = this.value.replace(/\D/g, ''); // Remove non-digits
      
      // Clear previous timeout
      clearTimeout(searchTimeout);
      
      if (searchValue.length >= 3) {
        // Debounce search
        searchTimeout = setTimeout(async () => {
          await searchCustomerInDatabase(searchValue);
        }, 500);
      } else {
        customerResults.classList.remove('show');
        document.getElementById('newCustomerForm').style.display = 'none';
      }
    });

    // Search customer in Supabase
    async function searchCustomerInDatabase(phone) {
      const businessId = sessionStorage.getItem('businessId');
      
      const { data: contacts, error } = await supabase
        .from('contacts')
        .select(`
          *,
          vehicles (*)
        `)
        .eq('account_id', businessId)
        .ilike('phone', `%${phone}%`)
        .limit(5);

      if (contacts && contacts.length > 0) {
        // Display results
        let html = '';
        contacts.forEach(contact => {
          const fullName = `${contact.first_name} ${contact.last_name}`;
          const vehicleInfo = contact.vehicles && contact.vehicles.length > 0 
            ? `${contact.vehicles[0].year} ${contact.vehicles[0].make} ${contact.vehicles[0].model}`
            : 'No vehicles';
          
          html += `
            <div class="customer-result-item" onclick='selectExistingCustomer(${JSON.stringify(contact).replace(/'/g, "&apos;")})'>
              <div class="customer-result-name">${fullName}</div>
              <div class="customer-result-phone">${formatPhone(contact.phone)}</div>
              <div class="customer-result-details">${vehicleInfo}</div>
            </div>
          `;
        });
        customerResults.innerHTML = html;
        customerResults.classList.add('show');
      } else {
        // No customer found - show new customer form
        customerResults.innerHTML = '<div class="no-results">No customer found with this number</div>';
        customerResults.classList.add('show');
        
        // Show new customer form after a delay
        setTimeout(() => {
          customerResults.classList.remove('show');
          document.getElementById('newCustomerForm').style.display = 'block';
          document.getElementById('newPhone').value = formatPhone(phone);
          document.getElementById('firstName').required = true;
          document.getElementById('lastName').required = true;
        }, 1500);
      }
    }

    // Select existing customer from search results
    window.selectExistingCustomer = function(contact) {
      // Store customer data globally
      window.selectedCustomer = contact;
      
      // Display customer info
      const fullName = `${contact.first_name} ${contact.last_name}`;
      document.getElementById('customerName').textContent = fullName;
      document.getElementById('customerDetails').textContent = `${contact.phone} ‚Ä¢ ${contact.email || 'No email'}`;
      
      // Show selected customer card
      document.getElementById('selectedCustomer').style.display = 'block';
      customerResults.classList.remove('show');
      phoneSearch.value = '';
      
      // Load customer's vehicles
      loadCustomerVehicles(contact.id, contact.vehicles || []);
    };

    // Load customer vehicles
    function loadCustomerVehicles(contactId, vehicles) {
      if (vehicles && vehicles.length > 0) {
        // Show vehicle selection
        showVehicleSelection(vehicles);
      } else {
        // No vehicles - show add vehicle form
        document.getElementById('newVehicleForm').style.display = 'block';
        alert('This customer has no vehicles. Please add a vehicle.');
      }
    }

    // Show vehicle selection
    function showVehicleSelection(vehicles) {
      const vehicleSelect = document.createElement('select');
      vehicleSelect.id = 'vehicleSelect';
      vehicleSelect.style.cssText = 'width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; margin: 1rem 0;';
      
      let options = '<option value="">-- Select Vehicle --</option>';
      vehicles.forEach(v => {
        options += `<option value="${v.id}">${v.year} ${v.make} ${v.model} - ${v.registration_number || 'No plate'}</option>`;
      });
      vehicleSelect.innerHTML = options;
      
      vehicleSelect.onchange = function() {
        const selectedVehicle = vehicles.find(v => v.id === this.value);
        if (selectedVehicle) {
          window.selectedVehicle = selectedVehicle;
          displaySelectedVehicle(selectedVehicle);
        }
      };
      
      // Insert after selectedCustomer
      const selectedCustomerDiv = document.getElementById('selectedCustomer');
      const existingSelect = document.getElementById('vehicleSelect');
      if (existingSelect) existingSelect.remove();
      selectedCustomerDiv.insertAdjacentElement('afterend', vehicleSelect);
    }

    // Display selected vehicle
    function displaySelectedVehicle(vehicle) {
      document.getElementById('vehicleInfo').textContent = `${vehicle.year} ${vehicle.make} ${vehicle.model}`;
      document.getElementById('vehiclePlate').textContent = `Plate: ${vehicle.registration_number || 'N/A'} ‚Ä¢ VIN: ${vehicle.vin || 'N/A'}`;
      document.getElementById('selectedVehicle').style.display = 'block';
      
      // Pre-fill VIN if available
      if (vehicle.vin) {
        document.getElementById('vinNumber').value = vehicle.vin;
      }
    }

    // Save new customer to Supabase
    window.saveNewCustomer = async function() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const phone = document.getElementById('newPhone').value.replace(/\D/g, '');
      
      if (!firstName || !lastName || !phone) {
        alert('Please fill in required fields: First Name, Last Name, and Phone');
        return;
      }

      const businessId = sessionStorage.getItem('businessId');

      const { data, error } = await supabase
        .from('contacts')
        .insert([{
          account_id: businessId,
          first_name: firstName,
          last_name: lastName,
          phone: phone,
          email: document.getElementById('newEmail').value,
          address_line1: document.getElementById('newAddress').value,
          city: document.getElementById('newCity').value,
          state: document.getElementById('newState').value,
          zip: document.getElementById('newZip').value
        }])
        .select()
        .single();

      if (error) {
        alert('Error creating customer: ' + error.message);
        return;
      }

      // Customer created successfully
      window.selectedCustomer = data;
      
      // Display customer
      document.getElementById('customerName').textContent = `${data.first_name} ${data.last_name}`;
      document.getElementById('customerDetails').textContent = `${data.phone} ‚Ä¢ ${data.email || 'No email'}`;
      document.getElementById('selectedCustomer').style.display = 'block';
      document.getElementById('newCustomerForm').style.display = 'none';
      
      // Show vehicle form
      document.getElementById('newVehicleForm').style.display = 'block';
      alert('Customer created! Now add a vehicle.');
    };

    // Save new vehicle to Supabase
    window.saveNewVehicle = async function() {
      const year = document.getElementById('vehicleYear').value;
      const make = document.getElementById('vehicleMake').value.trim();
      const model = document.getElementById('vehicleModel').value.trim();

      if (!year || !make || !model || !window.selectedCustomer) {
        alert('Please fill in required fields: Year, Make, and Model');
        return;
      }

      const businessId = sessionStorage.getItem('businessId');
      
      // Get automobile category ID
      const { data: category } = await supabase
        .from('vehicle_categories')
        .select('id')
        .eq('name', 'automobile')
        .single();

      const { data, error } = await supabase
        .from('vehicles')
        .insert([{
          account_id: businessId,
          contact_id: window.selectedCustomer.id,
          category_id: category.id,
          year: parseInt(year),
          make: make,
          model: model,
          vin: document.getElementById('vehicleVin').value,
          registration_number: document.getElementById('vehiclePlate').value,
          color: document.getElementById('vehicleColor').value,
          odometer_miles: document.getElementById('vehicleMileage').value ? parseInt(document.getElementById('vehicleMileage').value) : null
        }])
        .select()
        .single();

      if (error) {
        alert('Error creating vehicle: ' + error.message);
        return;
      }

      // Vehicle created successfully
      window.selectedVehicle = data;
      displaySelectedVehicle(data);
      document.getElementById('newVehicleForm').style.display = 'none';
      alert('Vehicle added successfully! You can now fill out the service details.');
    };

    // Format phone number
    function formatPhone(phone) {
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 10) {
        return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)}-${cleaned.substring(6)}`;
      }
      return phone;
    }

    // Select customer from search results
    function selectCustomer(name, phone, vehicle) {
      selectedCustomer = { name, phone, vehicle };
      
      // Hide search results
      customerResults.classList.remove('show');
      
      // Show selected customer
      document.getElementById('customerName').textContent = name;
      document.getElementById('customerDetails').textContent = `${formatPhone(phone)} ‚Ä¢ ${vehicle}`;
      document.getElementById('selectedCustomer').style.display = 'block';
      
      // Hide phone search
      phoneSearch.style.display = 'none';
      
      // Hide new customer form if shown
      document.getElementById('newCustomerForm').style.display = 'none';
    }

    // Clear customer selection
    function clearCustomer() {
      selectedCustomer = null;
      document.getElementById('selectedCustomer').style.display = 'none';
      document.getElementById('phoneSearch').style.display = 'block';
      document.getElementById('phoneSearch').value = '';
      document.getElementById('phoneSearch').focus();
    }

    // Insert service into description
    function insertService(serviceName) {
      const textarea = document.getElementById('serviceDescription');
      if (textarea.value.trim() === '') {
        textarea.value = serviceName;
      } else {
        textarea.value += '\n' + serviceName;
      }
      textarea.focus();
    }

    // Form submission
    document.getElementById('workOrderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      await createWorkOrder();
    });

    async function createWorkOrder() {
      // Validate customer and vehicle are selected
      if (!window.selectedCustomer) {
        showAlert('Please search for a customer or create a new one', 'error');
        return;
      }

      if (!window.selectedVehicle) {
        showAlert('Please select or add a vehicle', 'error');
        return;
      }

      const serviceDescription = document.getElementById('serviceDescription').value;
      const scheduledDate = document.getElementById('scheduledDate').value;
      const technician = document.getElementById('technician').value;
      
      if (!serviceDescription || !scheduledDate) {
        showAlert('Please fill in service description and scheduled date', 'error');
        return;
      }

      // Calculate totals from labor lines
      const laborTotal = laborLines.reduce((sum, line) => sum + line.total, 0);
      const partsTotal = 0; // TODO: Add parts calculation if needed
      const subtotal = laborTotal + partsTotal;
      
      // Get tax rate from settings or use default
      const taxRate = parseFloat(localStorage.getItem('taxRate') || '8.5');
      const taxAmount = subtotal * (taxRate / 100);
      const totalAmount = subtotal + taxAmount;

      if (totalAmount <= 0) {
        showAlert('Please add labor lines with pricing', 'error');
        return;
      }

      showAlert('Creating work order...', 'success');

      // Generate order number
      const orderNumber = 'RO-' + new Date().getFullYear() + '-' + String(Math.floor(Math.random() * 10000)).padStart(4, '0');

      // Create order in Supabase
      const orderData = {
        order_number: orderNumber,
        contact_id: window.selectedCustomer.id,
        vehicle_id: window.selectedVehicle.id,
        assigned_to: technician || null,
        status: 'scheduled',
        scheduled_date: scheduledDate,
        service_description: serviceDescription,
        labor_total: laborTotal,
        parts_total: partsTotal,
        tax_amount: taxAmount,
        total_amount: totalAmount,
        labor_hours: laborLines.reduce((sum, line) => sum + line.hours, 0)
      };

      try {
        const result = await window.ServiceLogicDB.createWorkOrder(orderData);
        
        if (result) {
          showAlert(`Work order ${orderNumber} created successfully!`, 'success');
          
          // Redirect to dashboard after 1 second
          setTimeout(() => {
            window.location.href = '/dashboard.html';
          }, 1000);
        }
      } catch (error) {
        console.error('Error creating work order:', error);
        showAlert('Error creating work order: ' + error.message, 'error');
      }
    }
        service: laborLines.map(l => l.description).join(', '),
        scheduled_date: scheduledDate,
        status: 'scheduled',
        total_amount: totalAmount,
        technician: technician.split(' - ')[0],
        estimated_hours: estimatedHours,
        labor_lines: laborLines
      });
      sessionStorage.setItem('mockOrders', JSON.stringify(mockOrders));

      showAlert(`‚úì Work order ${orderNumber} created! Assigned to ${technician.split(' - ')[0]}${estimatedHours > 0 ? ' (' + estimatedHours.toFixed(2) + ' hrs)' : ''}`, 'success');
      
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 1500);
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert ${type} show`;
    }

    function resetForm() {
      document.getElementById('workOrderForm').reset();
      document.getElementById('alert').classList.remove('show');
      document.getElementById('selectedCustomer').style.display = 'none';
      document.getElementById('newCustomerForm').style.display = 'none';
      document.getElementById('selectedTechnician').style.display = 'none';
      document.getElementById('selectedVehicle').style.display = 'none';
      document.getElementById('phoneSearch').style.display = 'block';
      document.getElementById('phoneSearch').value = '';
      document.getElementById('licensePlateSearch').style.display = 'block';
      document.getElementById('licensePlateSearch').value = '';
      document.getElementById('vehicle').style.display = 'block';
      selectedCustomer = null;
      selectedVehicle = null;
      laborLines = [];
      laborLineCounter = 0;
      renderLaborLines();
      
      calculateTotal();
      
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('scheduledDate').value = tomorrow.toISOString().split('T')[0];
    }

    function saveDraft() {
      const draft = {
        selectedCustomer,
        selectedVehicle,
        laborLines,
        laborLineCounter,
        serviceDescription: document.getElementById('serviceDescription').value,
        scheduledDate: document.getElementById('scheduledDate').value,
        priority: document.getElementById('priority').value,
        technician: document.getElementById('technician').value,
        vinNumber: document.getElementById('vinNumber').value,
        notes: document.getElementById('notes').value,
        additionalFees: document.getElementById('additionalFees').value,
        discount: document.getElementById('discount').value,
        timestamp: new Date().toISOString()
      };
      
      localStorage.setItem('workOrderDraft', JSON.stringify(draft));
      showAlert('‚úì Draft saved successfully!', 'success');
    }

    function loadDraft() {
      const draftJson = localStorage.getItem('workOrderDraft');
      if (!draftJson) {
        showAlert('No draft found', 'error');
        return;
      }

      const draft = JSON.parse(draftJson);
      
      // Restore customer
      if (draft.selectedCustomer) {
        selectedCustomer = draft.selectedCustomer;
        document.getElementById('customerName').textContent = selectedCustomer.name;
        document.getElementById('customerDetails').textContent = formatPhone(selectedCustomer.phone) + ' ‚Ä¢ ' + selectedCustomer.vehicle;
        document.getElementById('selectedCustomer').style.display = 'block';
        document.getElementById('phoneSearch').style.display = 'none';
      }

      // Restore vehicle
      if (draft.selectedVehicle) {
        selectedVehicle = draft.selectedVehicle;
        document.getElementById('vehicleInfo').textContent = selectedVehicle.vehicleDesc;
        document.getElementById('vehiclePlate').textContent = 'License Plate: ' + selectedVehicle.plate + ' ‚Ä¢ Owner: ' + selectedVehicle.owner;
        document.getElementById('selectedVehicle').style.display = 'block';
        document.getElementById('licensePlateSearch').style.display = 'none';
      }

      // Restore labor lines
      laborLines = draft.laborLines || [];
      laborLineCounter = draft.laborLineCounter || 0;
      renderLaborLines();
      calculateTotalFromLines();

      // Restore form fields
      document.getElementById('serviceDescription').value = draft.serviceDescription || '';
      document.getElementById('scheduledDate').value = draft.scheduledDate || '';
      document.getElementById('priority').value = draft.priority || 'normal';
      document.getElementById('technician').value = draft.technician || '';
      document.getElementById('vinNumber').value = draft.vinNumber || '';
      document.getElementById('notes').value = draft.notes || '';
      document.getElementById('additionalFees').value = draft.additionalFees || '0';
      document.getElementById('discount').value = draft.discount || '0';

      // Trigger technician display
      if (draft.technician) {
        document.getElementById('technician').dispatchEvent(new Event('change'));
      }

      calculateTotal();
      showAlert('‚úì Draft loaded successfully!', 'success');
    }

    function loadExistingOrder(orderNumber) {
      const mockOrders = [
        { id: 1, order_number: 'RO-2025-001', customer: 'Michael Brown', phone: '408-555-2001', vehicle: '2021 Honda Accord', service: 'Oil Change', scheduled_date: '2025-12-10', status: 'scheduled', total_amount: 89.99, technician: 'John Smith' },
        { id: 2, order_number: 'RO-2025-002', customer: 'Amanda Davis', phone: '408-555-2002', vehicle: '2023 Tesla Model 3', service: 'Brake Service', scheduled_date: '2025-12-11', status: 'confirmed', total_amount: 399.99, technician: 'Maria Garcia' },
        { id: 3, order_number: 'RO-2025-003', customer: 'Robert Martinez', phone: '510-555-1001', vehicle: '2019 Sea Ray Sundancer', service: 'Engine Service', scheduled_date: '2025-12-12', status: 'in_progress', total_amount: 450.00, technician: 'David Chen' }
      ];
      const userOrders = JSON.parse(sessionStorage.getItem('mockOrders') || '[]');
      const allOrders = [...mockOrders, ...userOrders];
      const order = allOrders.find(o => o.order_number === orderNumber);
      
      if (!order) return;

      document.querySelector('.page-title').textContent = 'View Work Order';
      document.querySelector('.page-subtitle').textContent = 'Order #' + orderNumber;

      selectedCustomer = {
        name: order.customer,
        phone: order.phone.replace(/\D/g, ''),
        vehicle: order.vehicle
      };
      document.getElementById('customerName').textContent = order.customer;
      document.getElementById('customerDetails').textContent = order.phone + ' ‚Ä¢ ' + order.vehicle;
      document.getElementById('selectedCustomer').style.display = 'block';
      document.getElementById('phoneSearch').style.display = 'none';

      if (order.labor_lines && order.labor_lines.length > 0) {
        laborLines = order.labor_lines;
        laborLineCounter = laborLines.length;
        renderLaborLines();
        calculateTotalFromLines();
      }

      document.getElementById('serviceDescription').value = order.service || '';
      document.getElementById('scheduledDate').value = order.scheduled_date || '';
      document.getElementById('technician').value = order.technician || '';

      if (order.technician) {
        setTimeout(() => {
          document.getElementById('technician').dispatchEvent(new Event('change'));
        }, 200);
      }

      document.querySelector('.btn-submit').textContent = '‚úì Update Order';
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
      if (!phoneSearch.contains(e.target) && !customerResults.contains(e.target)) {
        customerResults.classList.remove('show');
      }
      if (!licensePlateSearch.contains(e.target) && !vehicleResults.contains(e.target)) {
        vehicleResults.classList.remove('show');
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + S = Save Draft
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveDraft();
      }
      // Ctrl/Cmd + L = Load Draft
      if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
        e.preventDefault();
        loadDraft();
      }
      // Ctrl/Cmd + Enter = Submit Form
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('workOrderForm').dispatchEvent(new Event('submit'));
      }
    });

    // Auto-save every 2 minutes
    setInterval(() => {
      if (laborLines.length > 0 || document.getElementById('serviceDescription').value) {
        saveDraft();
        console.log('Auto-saved draft');
      }
    }, 120000); // 2 minutes

    // Show keyboard shortcuts hint
    setTimeout(() => {
      const hint = document.createElement('div');
      hint.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 1rem; border-radius: 12px; font-size: 0.75rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;';
      hint.innerHTML = `
        <div style="font-weight: 700; margin-bottom: 0.5rem;">‚å®Ô∏è Keyboard Shortcuts</div>
        <div>Ctrl/‚åò + S = Save Draft</div>
        <div>Ctrl/‚åò + L = Load Draft</div>
        <div>Ctrl/‚åò + Enter = Create Order</div>
      `;
      document.body.appendChild(hint);
      setTimeout(() => hint.remove(), 5000);
    }, 2000);
  </script>
</body>
</html>
