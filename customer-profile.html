<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Customer Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="theme-system.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: var(--bg-primary, #0b0f14); color: var(--text-primary, #e8eef6); }
    
    .desktop-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-primary, #0b0f14);
      border-bottom: 1px solid var(--border-default, #223044);
    }
    
    .mobile-top-header {
      display: none;
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary, #0f1621);
      border-bottom: 1px solid var(--border-default, #223044);
    }

    .mobile-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
    }

    .mobile-back-btn {
      background: transparent;
      border: none;
      color: var(--accent-light, #60a5fa);
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
    }

    .mobile-header-center {
      flex: 1;
      text-align: center;
    }

    .mobile-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .business-name { font-size: 12px; color: var(--accent-primary, #60a5fa); }

    .mobile-action-buttons {
      display: none;
      position: fixed;
      bottom: 102px;
      left: 0;
      right: 0;
      background: var(--bg-secondary, #0f1621);
      padding: 8px 8px 0 8px;
      z-index: 101;
    }

    .mobile-action-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .mobile-action-btn {
      padding: 10px 8px;
      border-radius: 8px;
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--accent-light, #60a5fa);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      text-decoration: none;
    }

    .mobile-action-btn:hover {
      background: color-mix(in srgb, var(--accent-primary) 20%, transparent);
    }

    .mobile-action-btn:active {
      transform: scale(0.95);
      background: color-mix(in srgb, var(--accent-primary) 25%, transparent);
    }

    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary, #0f1621);
      padding: 8px 8px 8px 8px;
      z-index: 100;
    }

    .mobile-nav-top {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .mobile-nav-secondary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .mobile-nav-btn {
      padding: 10px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-default, #223044);
      background: var(--bg-card, #1a2535);
      color: var(--text-secondary, #9fb0c3);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      min-height: 44px;
    }
    
    .mobile-nav-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary, #3b82f6);
      color: var(--text-primary);
    }
    
    .mobile-nav-btn.related {
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--text-primary);
    }

    .mobile-nav-btn:active {
      transform: scale(0.95);
    }
    
    .main { display: flex; flex-direction: column; min-height: 100vh; }
    .content { flex: 1; padding: 20px; }
    
    .btn { 
      padding: 8px 16px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 13px; 
      min-height: 36px;
    }
    .btn-primary { 
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent); 
      border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--accent-light, #60a5fa); 
    }
    .btn-primary:hover { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); }
    .btn-secondary { background: var(--bg-hover, #475569); color: white; }
    .btn-success { background: #059669; color: white; }
    
    /* Profile Header Card */
    .profile-header {
      background: var(--bg-card, #1a2535);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 12px;
    }
    .profile-header-top {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    .profile-avatar {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: var(--bg-hover, #223044);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-light, #60a5fa);
      flex-shrink: 0;
      border: 3px solid var(--accent-primary, #3b82f6);
    }
    .profile-info { flex: 1; min-width: 0; }
    .profile-name { font-size: 22px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
    .profile-type { font-size: 12px; color: var(--accent-light, #60a5fa); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .profile-contact { font-size: 14px; color: var(--text-secondary); }
    .profile-contact a { color: var(--accent-light, #60a5fa); text-decoration: none; }
    .profile-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .profile-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .profile-badge.vip { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .profile-badge.at-risk { background: #dc2626; color: white; }
    .profile-badge.pre-approved { background: #16a34a; color: white; }

    .profile-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-default, #223044);
    }
    .profile-stat { text-align: center; }
    .profile-stat-value { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .profile-stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 12px;
      background: var(--bg-secondary, #0f1621);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .quick-action-btn {
      padding: 12px 8px;
      border-radius: 8px;
      background: var(--bg-card, #1a2535);
      border: 1px solid var(--border-default, #223044);
      color: var(--text-primary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .quick-action-btn:hover { background: var(--bg-hover); border-color: var(--accent-primary); }
    .quick-action-btn .icon { font-size: 18px; }

    /* Section Headers - Matching sales dashboard */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--bg-card, #1a2535);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      scroll-margin-top: 70px;
    }
    .section-header:hover { background: var(--bg-hover, #223044); }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    
    .section-header-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-light, #60a5fa);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-header-title .count-badge {
      background: transparent;
      color: var(--accent-light, #60a5fa);
      font-size: 16px;
      padding: 0;
      font-weight: 600;
    }
    
    .section-header-icon {
      font-size: 24px;
      color: var(--text-secondary, #9fb0c3);
      transition: transform 0.2s;
    }
    
    .section-content {
      overflow: hidden;
      transition: max-height 0.3s ease;
      margin-bottom: 8px;
    }
    .section-content.collapsed { max-height: 0 !important; margin-bottom: 0; }

    /* KPI Container - Matching sales dashboard */
    .kpi-container {
      background: var(--bg-card, #1a2535);
      border-radius: 8px;
      padding: 16px;
    }
    
    .kpi-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-default, #223044);
    }
    .kpi-row:last-child { border-bottom: none; }
    .kpi-label { font-size: 13px; color: var(--text-secondary, #9fb0c3); }
    .kpi-value { font-size: 16px; font-weight: 600; color: var(--text-primary, #e8eef6); }
    .kpi-value a { color: var(--accent-light, #60a5fa); text-decoration: none; }

    /* Item Cards - Matching sales dashboard */
    .item-card {
      background: var(--bg-card, #1a2535);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid var(--accent-primary, #3b82f6);
      position: relative;
      cursor: pointer;
    }
    .item-card:hover { background: var(--bg-hover, #223044); }
    
    .item-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .item-card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary, #e8eef6);
    }
    .item-card-subtitle {
      font-size: 13px;
      color: var(--text-secondary, #94a3b8);
      margin-top: 2px;
    }
    .item-card-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }
    .item-card-detail {
      font-size: 13px;
    }
    .item-card-detail-label {
      color: var(--text-secondary, #94a3b8);
    }
    .item-card-detail-value {
      color: var(--text-primary, #e8eef6);
      font-weight: 500;
    }

    .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-success { background: transparent; color: #34d399; border: 1px solid rgba(52, 211, 153, 0.5); }
    .badge-warning { background: transparent; color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.5); }
    .badge-info { background: transparent; color: var(--accent-primary, #60a5fa); border: 1px solid rgba(96, 165, 250, 0.5); }
    .badge-danger { background: transparent; color: #f87171; border: 1px solid rgba(248, 113, 113, 0.5); }

    /* Timeline */
    .timeline { position: relative; padding-left: 24px; }
    .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border-default); }
    .timeline-item { position: relative; padding-bottom: 20px; }
    .timeline-item:last-child { padding-bottom: 0; }
    .timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: var(--accent-primary); border: 2px solid var(--bg-card); }
    .timeline-content { background: var(--bg-secondary); border-radius: 8px; padding: 12px; }
    .timeline-date { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
    .timeline-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .timeline-desc { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

    /* Notes */
    .note-card { background: var(--bg-secondary); border-radius: 8px; padding: 14px; margin-bottom: 10px; border-left: 3px solid var(--accent-light); }
    .note-meta { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: var(--text-secondary); }
    .note-text { font-size: 14px; color: var(--text-primary); line-height: 1.5; }
    .add-note-btn { width: 100%; padding: 14px; border-radius: 8px; background: transparent; border: 2px dashed var(--border-default); color: var(--text-secondary); font-size: 14px; cursor: pointer; margin-top: 12px; }
    .add-note-btn:hover { border-color: var(--accent-primary); color: var(--accent-light); }

    /* AI Insights */
    .ai-card { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card)); border-radius: 10px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--accent-primary); }
    .ai-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .ai-card-icon { font-size: 24px; }
    .ai-card-title { font-size: 14px; font-weight: 700; color: var(--accent-light); }
    .ai-card-content { font-size: 14px; color: var(--text-primary); line-height: 1.6; }
    .ai-signal { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-default); }
    .ai-signal:last-child { border-bottom: none; }
    .ai-signal-indicator { width: 8px; height: 8px; border-radius: 50%; }
    .ai-signal-indicator.high { background: #4ade80; }
    .ai-signal-indicator.medium { background: #facc15; }
    .ai-signal-indicator.low { background: #f87171; }
    .ai-signal-text { flex: 1; font-size: 13px; color: var(--text-primary); }
    .ai-signal-confidence { font-size: 11px; color: var(--text-secondary); }

    /* Empty States */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-state-text { font-size: 14px; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-default); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Cards Container */
    .cards-container {
      background: var(--bg-card, #1a2535);
      border-radius: 0 0 8px 8px;
      padding: 12px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      .mobile-action-buttons { display: block !important; }
      body { padding-bottom: 165px; }
      .content { padding: 12px; }
      .profile-header { margin: 0 0 12px; border-radius: 8px; }
      .profile-stats { grid-template-columns: repeat(2, 1fr); }
      .quick-actions { display: none; }
      .profile-avatar { width: 60px; height: 60px; font-size: 22px; }
      .profile-name { font-size: 18px; }
      
      /* Section headers visible on mobile */
      .section-header { display: flex !important; }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .mobile-action-buttons { display: none !important; }
      
      /* Section headers hidden on desktop */
      .section-header { display: none !important; }
      .section-content { max-height: none !important; margin-bottom: 16px; display: block !important; }
      .section-content.collapsed { max-height: none !important; display: block !important; }
      
      .cards-container { border-radius: 8px; }
      .content { max-width: 1200px; margin: 0 auto; }
    }
  </style>
</head>
<body>

<!-- Mobile Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-back-btn" onclick="history.back()">‚Üê Back</button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Customer Profile</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
  </div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div style="display:flex; align-items:center; gap:16px;">
      <button onclick="history.back()" style="background:color-mix(in srgb, var(--accent-primary) 10%, transparent); border:1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color:var(--accent-light); padding:8px 16px; border-radius:8px; cursor:pointer; font-size:14px;">‚Üê Back</button>
      <div>
        <h1 style="margin:0; font-size:32px; font-weight:600;">Customer Profile</h1>
        <div class="business-name" id="desktopBusinessName">Loading...</div>
      </div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
  </div>
  
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px; overflow-x:auto;">
      <a href="dashboard-business.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap;">Business</a>
      <a href="dashboard-customer-search.html" style="padding:12px 0; color:var(--accent-light); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid var(--accent-primary);">Customers</a>
      <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap;">Vehicles</a>
      <a href="dashboard-settings.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap;">Settings</a>
    </nav>
  </div>
  
  <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
    <div style="display:flex; gap:12px; justify-content:flex-end;">
      <button onclick="location.href='dashboard-service.html'" style="padding:8px 16px; background:color-mix(in srgb, var(--accent-primary) 10%, transparent); border:1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color:var(--accent-light); border-radius:8px; cursor:pointer; font-size:14px;">Service</button>
      <button onclick="location.href='dashboard-parts.html'" style="padding:8px 16px; background:color-mix(in srgb, var(--accent-primary) 10%, transparent); border:1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color:var(--accent-light); border-radius:8px; cursor:pointer; font-size:14px;">Parts</button>
      <button onclick="location.href='dashboard-sales.html'" style="padding:8px 16px; background:color-mix(in srgb, var(--accent-primary) 10%, transparent); border:1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color:var(--accent-light); border-radius:8px; cursor:pointer; font-size:14px;">Sales</button>
    </div>
    <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:12px;" id="desktopActions">
      <button onclick="editCustomer()" class="btn btn-primary" style="padding:10px 16px; font-size:13px;">Edit Customer</button>
      <button onclick="newWorkOrder()" class="btn btn-primary" style="padding:10px 16px; font-size:13px;">+ New Work Order</button>
      <button onclick="newDeal()" class="btn btn-primary" style="padding:10px 16px; font-size:13px;">+ New Deal</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="content">
    <!-- Profile Header -->
    <div class="profile-header" id="profileHeader">
      <div class="loading">
        <div class="loading-spinner"></div>
        Loading customer...
      </div>
    </div>

    <!-- Quick Actions (Desktop Only) -->
    <div class="quick-actions" id="quickActions" style="display:none;">
      <button class="quick-action-btn" onclick="makeCall()">
        <span class="icon">üìû</span>
        Call
      </button>
      <button class="quick-action-btn" onclick="sendText()">
        <span class="icon">üí¨</span>
        Text
      </button>
      <button class="quick-action-btn" onclick="sendEmail()">
        <span class="icon">‚úâÔ∏è</span>
        Email
      </button>
      <button class="quick-action-btn" onclick="addNote()">
        <span class="icon">üìù</span>
        Note
      </button>
    </div>

    <!-- Contact Section -->
    <div class="section-header collapsed" onclick="toggleSection('contact')" id="contactHeader">
      <div class="section-header-title">Contact Information</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="contactContent">
      <div class="kpi-container" id="contactInfo"></div>
    </div>

    <!-- Vehicles Section -->
    <div class="section-header collapsed" onclick="toggleSection('vehicles')" id="vehiclesHeader">
      <div class="section-header-title">Vehicles <span class="count-badge" id="vehicleCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="vehiclesContent">
      <div class="cards-container" id="vehiclesList"></div>
    </div>

    <!-- Service History Section -->
    <div class="section-header collapsed" onclick="toggleSection('service')" id="serviceHeader">
      <div class="section-header-title">Service History <span class="count-badge" id="woCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="serviceContent">
      <div class="cards-container" id="serviceList"></div>
    </div>

    <!-- Deals Section -->
    <div class="section-header collapsed" onclick="toggleSection('deals')" id="dealsHeader">
      <div class="section-header-title">Purchase History <span class="count-badge" id="dealCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="dealsContent">
      <div class="cards-container" id="dealsList"></div>
    </div>

    <!-- Communications Section -->
    <div class="section-header collapsed" onclick="toggleSection('comms')" id="commsHeader">
      <div class="section-header-title">Recent Activity</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="commsContent">
      <div class="cards-container" id="commsList"></div>
    </div>

    <!-- Notes Section -->
    <div class="section-header collapsed" onclick="toggleSection('notes')" id="notesHeader">
      <div class="section-header-title">Notes <span class="count-badge" id="noteCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="notesContent">
      <div class="cards-container" id="notesList"></div>
    </div>

    <!-- AI Insights Section -->
    <div class="section-header collapsed" onclick="toggleSection('ai')" id="aiHeader">
      <div class="section-header-title">ü§ñ AI Insights</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="aiContent">
      <div class="cards-container" id="aiInsights"></div>
    </div>
  </div>
</div>

<!-- Mobile Action Buttons -->
<div class="mobile-action-buttons">
  <div class="mobile-action-grid">
    <button class="mobile-action-btn" onclick="makeCall()">üìû Call</button>
    <button class="mobile-action-btn" onclick="sendText()">üí¨ Text</button>
    <button class="mobile-action-btn" onclick="sendEmail()">‚úâÔ∏è Email</button>
    <button class="mobile-action-btn" onclick="newWorkOrder()">+ WO</button>
  </div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-business.html" class="mobile-nav-btn related">Business</a>
    <a href="dashboard-search.html" class="mobile-nav-btn related">Search</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn related">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn related">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn related">Sales</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let customer = null;
let vehicles = [];
let workOrders = [];
let deals = [];
let notes = [];
let appointments = [];
let aiSummary = null;
let aiSignals = [];
let aiNextActions = [];

// Theme
function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

// Get customer ID from URL
function getCustomerId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

// Toggle section
function toggleSection(sectionId) {
  const content = document.getElementById(sectionId + 'Content');
  const header = document.getElementById(sectionId + 'Header');
  const wasCollapsed = content.classList.contains('collapsed');
  
  content.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
  content.style.maxHeight = content.classList.contains('collapsed') ? '0px' : content.scrollHeight + 'px';
  
  if (wasCollapsed) {
    setTimeout(() => {
      header.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 50);
  }
}

// Format helpers
function formatDate(dateStr) {
  if (!dateStr) return '--';
  return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function formatDateTime(dateStr) {
  if (!dateStr) return '--';
  return new Date(dateStr).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
}
function formatCurrency(amount) {
  if (amount === null || amount === undefined) return '--';
  return '$' + Number(amount).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
function formatPhone(phone) {
  if (!phone) return '--';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
  }
  return phone;
}
function getInitials(name) {
  if (!name) return '?';
  return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

// Auth
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refreshToken = localStorage.getItem('sb_refresh_token');
    if (token && refreshToken) {
      const { data, error } = await sb.auth.setSession({ access_token: token, refresh_token: refreshToken });
      if (error || !data.session) { window.location.href = 'login.html'; return null; }
      return data.session;
    }
    window.location.href = 'login.html';
    return null;
  }
  return session;
}

function logout() {
  localStorage.removeItem('sb_access_token');
  localStorage.removeItem('sb_refresh_token');
  Object.keys(localStorage).forEach(key => { if (key.startsWith('sb-')) localStorage.removeItem(key); });
  window.location.href = 'login.html?logout=1';
}

async function loadBusinessSettings() {
  const { data, error } = await sb.from('business_settings').select('*').single();
  if (data) {
    const name = data.business_name || data.company_name || 'My Business';
    document.getElementById('desktopBusinessName').textContent = name;
    document.getElementById('mobileBusinessName').textContent = name;
  }
}

// Load customer data
async function loadCustomer() {
  const customerId = getCustomerId();
  if (!customerId) {
    document.getElementById('profileHeader').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-text">No customer ID provided</div></div>';
    // Hide all sections when no customer
    document.querySelectorAll('.section-header').forEach(h => h.style.display = 'none');
    document.querySelectorAll('.section-content').forEach(c => c.style.display = 'none');
    return;
  }

  try {
    // Load customer
    const { data: customerData, error: customerError } = await sb
      .from('customers')
      .select('*')
      .eq('customer_id', customerId)
      .single();

    if (customerError || !customerData) {
      document.getElementById('profileHeader').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-text">Customer not found</div></div>';
      document.querySelectorAll('.section-header').forEach(h => h.style.display = 'none');
      document.querySelectorAll('.section-content').forEach(c => c.style.display = 'none');
      return;
    }
    customer = customerData;

    // Load related data in parallel
    const [vehiclesRes, workOrdersRes, dealsRes, notesRes, appointmentsRes, aiSummaryRes, aiSignalsRes, aiActionsRes] = await Promise.all([
      sb.from('vehicles').select('*').eq('customer_id', customerId).eq('deleted', false).order('created_at', { ascending: false }),
      sb.from('work_orders').select('*').eq('customer_id', customerId).eq('deleted', false).order('created_at', { ascending: false }),
      sb.from('deals').select('*').eq('customer_id', customerId).order('created_at', { ascending: false }),
      sb.from('customer_notes').select('*').eq('customer_id', customerId).order('created_at', { ascending: false }),
      sb.from('sales_appointments').select('*').eq('customer_id', customerId).order('appointment_date', { ascending: false }),
      sb.from('ai_customer_summaries').select('*').eq('customer_id', customerId).maybeSingle(),
      sb.from('ai_customer_signals').select('*').eq('customer_id', customerId).order('detected_at', { ascending: false }).limit(10),
      sb.from('ai_next_actions').select('*').eq('customer_id', customerId).order('created_at', { ascending: false }).limit(5)
    ]);

    vehicles = vehiclesRes.data || [];
    workOrders = workOrdersRes.data || [];
    deals = dealsRes.data || [];
    notes = notesRes.data || [];
    appointments = appointmentsRes.data || [];
    aiSummary = aiSummaryRes.data;
    aiSignals = aiSignalsRes.data || [];
    aiNextActions = aiActionsRes.data || [];

    // Render all sections
    renderProfileHeader();
    renderContactInfo();
    renderVehicles();
    renderDeals();
    renderServiceHistory();
    renderCommunications();
    renderNotes();
    renderAIInsights();

    // Show quick actions
    document.getElementById('quickActions').style.display = 'grid';

    // Update counts
    document.getElementById('vehicleCount').textContent = vehicles.length;
    document.getElementById('dealCount').textContent = deals.length;
    document.getElementById('woCount').textContent = workOrders.length;
    document.getElementById('noteCount').textContent = notes.length;

  } catch (err) {
    console.error('Error loading customer:', err);
    document.getElementById('profileHeader').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-text">Error loading customer</div></div>';
  }
}

function renderProfileHeader() {
  const totalServiceSpend = workOrders.reduce((sum, wo) => sum + (parseFloat(wo.grand_total) || 0), 0);
  const totalPurchaseValue = deals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
  
  let badges = '';
  if (customer.vip_flag) badges += '<span class="profile-badge vip">‚≠ê VIP</span>';
  if (customer.at_risk_flag) badges += '<span class="profile-badge at-risk">‚ö†Ô∏è At Risk</span>';
  if (customer.pre_approved) badges += '<span class="profile-badge pre-approved">‚úì Pre-Approved</span>';

  document.getElementById('profileHeader').innerHTML = `
    <div class="profile-header-top">
      <div class="profile-avatar">${getInitials(customer.full_name)}</div>
      <div class="profile-info">
        <div class="profile-name">${customer.full_name || 'Unknown'}</div>
        <div class="profile-type">${customer.customer_type || 'Customer'} ‚Ä¢ Since ${formatDate(customer.created_at)}</div>
        <div class="profile-contact">
          ${customer.phone ? `<a href="tel:${customer.phone}">${formatPhone(customer.phone)}</a>` : ''}
          ${customer.phone && customer.email ? ' ‚Ä¢ ' : ''}
          ${customer.email ? `<a href="mailto:${customer.email}">${customer.email}</a>` : ''}
        </div>
        ${badges ? `<div class="profile-badges">${badges}</div>` : ''}
      </div>
    </div>
    <div class="profile-stats">
      <div class="profile-stat">
        <div class="profile-stat-value">${vehicles.length}</div>
        <div class="profile-stat-label">Vehicles</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${workOrders.length}</div>
        <div class="profile-stat-label">Work Orders</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${formatCurrency(totalServiceSpend)}</div>
        <div class="profile-stat-label">Service Spend</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${formatCurrency(customer.lifetime_value || totalPurchaseValue + totalServiceSpend)}</div>
        <div class="profile-stat-label">Lifetime Value</div>
      </div>
    </div>
  `;
}

function renderContactInfo() {
  document.getElementById('contactInfo').innerHTML = `
    <div class="kpi-row">
      <span class="kpi-label">Phone</span>
      <span class="kpi-value"><a href="tel:${customer.phone}">${formatPhone(customer.phone)}</a></span>
    </div>
    <div class="kpi-row">
      <span class="kpi-label">Email</span>
      <span class="kpi-value"><a href="mailto:${customer.email}">${customer.email || '--'}</a></span>
    </div>
    <div class="kpi-row">
      <span class="kpi-label">Address</span>
      <span class="kpi-value">${customer.address ? `${customer.address}, ${customer.city || ''} ${customer.state || ''} ${customer.zip || ''}` : '--'}</span>
    </div>
    <div class="kpi-row">
      <span class="kpi-label">Preferred Contact</span>
      <span class="kpi-value">${customer.preferred_contact || '--'}</span>
    </div>
    <div class="kpi-row">
      <span class="kpi-label">Credit Score</span>
      <span class="kpi-value">${customer.credit_score_range || '--'}</span>
    </div>
    <div class="kpi-row">
      <span class="kpi-label">Pre-Approved</span>
      <span class="kpi-value">${customer.pre_approved ? 'Yes - ' + formatCurrency(customer.pre_approval_amount) : 'No'}</span>
    </div>
    <div class="kpi-row">
      <span class="kpi-label">Marketing Opt-In</span>
      <span class="kpi-value">${customer.marketing_opt_in ? 'Yes' : 'No'}</span>
    </div>
    <div class="kpi-row">
      <span class="kpi-label">Referral Source</span>
      <span class="kpi-value">${customer.referral_source || '--'}</span>
    </div>
  `;
}

function renderVehicles() {
  if (vehicles.length === 0) {
    document.getElementById('vehiclesList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöó</div><div class="empty-state-text">No vehicles on file</div></div>';
    return;
  }

  const vehicleCards = vehicles.map(v => `
    <div class="item-card" onclick="viewVehicle('${v.vehicle_id}')" style="border-left-color: #06b6d4;">
      <div class="item-card-header">
        <div>
          <div class="item-card-title">${v.year || ''} ${v.make || ''} ${v.model || ''}</div>
          <div class="item-card-subtitle">${v.vin_or_hin || 'No VIN'} ‚Ä¢ ${v.color || 'Unknown color'}</div>
        </div>
        <span class="badge ${v.is_fleet_vehicle ? 'badge-warning' : 'badge-info'}">${v.is_fleet_vehicle ? 'Fleet' : v.vehicle_type || 'Personal'}</span>
      </div>
      <div class="item-card-details">
        <div class="item-card-detail"><span class="item-card-detail-label">Mileage: </span><span class="item-card-detail-value">${v.mileage_hours ? v.mileage_hours.toLocaleString() : '--'}</span></div>
        <div class="item-card-detail"><span class="item-card-detail-label">Last Service: </span><span class="item-card-detail-value">${formatDate(v.last_service_date)}</span></div>
      </div>
    </div>
  `).join('');

  document.getElementById('vehiclesList').innerHTML = vehicleCards;
}

function renderDeals() {
  if (deals.length === 0) {
    document.getElementById('dealsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><div class="empty-state-text">No purchase history</div></div>';
    return;
  }

  const dealCards = deals.map(d => `
    <div class="item-card" onclick="viewDeal('${d.deal_id}')" style="border-left-color: ${d.status === 'won' ? '#4ade80' : d.status === 'lost' ? '#f87171' : '#8b5cf6'};">
      <div class="item-card-header">
        <div>
          <div class="item-card-title">${d.title || 'Untitled Deal'}</div>
          <div class="item-card-subtitle">${d.deal_type || 'Sale'} ‚Ä¢ ${formatDate(d.created_at)}</div>
        </div>
        <span class="badge badge-${d.status === 'won' ? 'success' : d.status === 'lost' ? 'danger' : 'info'}">${d.status || 'Open'}</span>
      </div>
      <div class="item-card-details">
        <div class="item-card-detail"><span class="item-card-detail-label">Value: </span><span class="item-card-detail-value">${formatCurrency(d.value)}</span></div>
        <div class="item-card-detail"><span class="item-card-detail-label">Down: </span><span class="item-card-detail-value">${formatCurrency(d.down_payment)}</span></div>
        <div class="item-card-detail"><span class="item-card-detail-label">Monthly: </span><span class="item-card-detail-value">${formatCurrency(d.monthly_payment)}</span></div>
        <div class="item-card-detail"><span class="item-card-detail-label">Profit: </span><span class="item-card-detail-value">${formatCurrency(d.total_profit)}</span></div>
      </div>
    </div>
  `).join('');

  document.getElementById('dealsList').innerHTML = dealCards;
}

function renderServiceHistory() {
  if (workOrders.length === 0) {
    document.getElementById('serviceList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><div class="empty-state-text">No service history</div></div>';
    return;
  }

  const woCards = workOrders.map(wo => {
    const statusColors = {
      'completed': '#4ade80', 'in_progress': 'var(--accent-primary)', 
      'scheduled': 'var(--text-secondary)', 'waiting_parts': '#facc15'
    };
    return `
      <div class="item-card" onclick="viewWorkOrder('${wo.work_order_id}')" style="border-left-color: ${statusColors[wo.status] || 'var(--accent-primary)'};">
        <div class="item-card-header">
          <div>
            <div class="item-card-title">WO #${wo.wo_number || wo.work_order_id.slice(0,8)}</div>
            <div class="item-card-subtitle">${wo.summary || 'No description'}</div>
          </div>
          <span class="badge badge-${wo.status === 'completed' ? 'success' : wo.status === 'in_progress' ? 'info' : 'warning'}">${wo.status || 'Open'}</span>
        </div>
        <div class="item-card-details">
          <div class="item-card-detail"><span class="item-card-detail-label">Date: </span><span class="item-card-detail-value">${formatDate(wo.scheduled_start || wo.created_at)}</span></div>
          <div class="item-card-detail"><span class="item-card-detail-label">Total: </span><span class="item-card-detail-value">${formatCurrency(wo.grand_total)}</span></div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('serviceList').innerHTML = woCards;
}

function renderCommunications() {
  const activities = [
    ...appointments.map(a => ({ type: 'appointment', date: a.appointment_date, data: a })),
    ...workOrders.slice(0, 5).map(wo => ({ type: 'work_order', date: wo.created_at, data: wo })),
    ...deals.slice(0, 3).map(d => ({ type: 'deal', date: d.created_at, data: d }))
  ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

  if (activities.length === 0) {
    document.getElementById('commsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì±</div><div class="empty-state-text">No recent activity</div></div>';
    return;
  }

  const timeline = activities.map(a => {
    let icon = 'üìã', title = '', desc = '';
    if (a.type === 'appointment') {
      icon = 'üìÖ'; title = a.data.appointment_type || 'Appointment'; desc = `${formatDate(a.data.appointment_date)} at ${a.data.appointment_time || '--'}`;
    } else if (a.type === 'work_order') {
      icon = 'üîß'; title = `WO #${a.data.wo_number || ''}`; desc = a.data.summary || '';
    } else if (a.type === 'deal') {
      icon = 'üí∞'; title = a.data.title || 'Deal'; desc = `Value: ${formatCurrency(a.data.value)}`;
    }
    return `
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-content">
          <div class="timeline-date">${formatDateTime(a.date)}</div>
          <div class="timeline-title">${icon} ${title}</div>
          <div class="timeline-desc">${desc}</div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('commsList').innerHTML = `<div class="timeline">${timeline}</div>`;
}

function renderNotes() {
  let notesHtml = '';
  
  if (notes.length === 0) {
    notesHtml = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No notes yet</div></div>';
  } else {
    notesHtml = notes.map(n => `
      <div class="note-card">
        <div class="note-meta">
          <span>${formatDateTime(n.created_at)}</span>
        </div>
        <div class="note-text">${n.note}</div>
      </div>
    `).join('');
  }

  notesHtml += '<button class="add-note-btn" onclick="addNote()">+ Add Note</button>';
  document.getElementById('notesList').innerHTML = notesHtml;
}

function renderAIInsights() {
  let html = '';

  if (aiSummary) {
    html += `
      <div class="ai-card">
        <div class="ai-card-header">
          <div class="ai-card-icon">üß†</div>
          <div class="ai-card-title">Customer Summary</div>
        </div>
        <div class="ai-card-content">${aiSummary.summary}</div>
      </div>
    `;
  }

  if (aiNextActions.length > 0) {
    html += `
      <div class="ai-card">
        <div class="ai-card-header">
          <div class="ai-card-icon">üéØ</div>
          <div class="ai-card-title">Recommended Actions</div>
        </div>
        <div class="ai-card-content">
          ${aiNextActions.map(a => `
            <div class="ai-signal">
              <div class="ai-signal-indicator ${a.priority === 'high' ? 'high' : a.priority === 'low' ? 'low' : 'medium'}"></div>
              <div class="ai-signal-text">${a.action}</div>
              <div class="ai-signal-confidence">${Math.round((a.confidence_score || 0) * 100)}%</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  if (aiSignals.length > 0) {
    html += `
      <div class="ai-card">
        <div class="ai-card-header">
          <div class="ai-card-icon">üìä</div>
          <div class="ai-card-title">Customer Signals</div>
        </div>
        <div class="ai-card-content">
          ${aiSignals.map(s => `
            <div class="ai-signal">
              <div class="ai-signal-indicator ${parseFloat(s.confidence_score) > 0.7 ? 'high' : parseFloat(s.confidence_score) > 0.4 ? 'medium' : 'low'}"></div>
              <div class="ai-signal-text"><strong>${s.signal_type}:</strong> ${s.signal_value}</div>
              <div class="ai-signal-confidence">${Math.round((s.confidence_score || 0) * 100)}%</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  if (!html) {
    html = '<div class="empty-state"><div class="empty-state-icon">ü§ñ</div><div class="empty-state-text">No AI insights available yet</div></div>';
  }

  document.getElementById('aiInsights').innerHTML = html;
}

// Actions
function makeCall() {
  if (customer?.phone) window.location.href = `tel:${customer.phone}`;
  else alert('No phone number on file');
}
function sendText() {
  if (customer?.phone) window.location.href = `sms:${customer.phone}`;
  else alert('No phone number on file');
}
function sendEmail() {
  if (customer?.email) window.location.href = `mailto:${customer.email}`;
  else alert('No email on file');
}
function addNote() {
  const note = prompt('Enter note:');
  if (note && customer) {
    sb.from('customer_notes').insert({
      tenant_id: customer.tenant_id,
      customer_id: customer.customer_id,
      note: note
    }).then(() => {
      loadCustomer();
    });
  }
}
function editCustomer() {
  window.location.href = `customer-edit.html?id=${customer?.customer_id}`;
}
function newWorkOrder() {
  window.location.href = `work-order-new.html?customer_id=${customer?.customer_id}`;
}
function newDeal() {
  window.location.href = `deal-new.html?customer_id=${customer?.customer_id}`;
}
function viewVehicle(id) {
  window.location.href = `vehicle-detail.html?id=${id}`;
}
function viewWorkOrder(id) {
  window.location.href = `work-order-detail.html?id=${id}`;
}
function viewDeal(id) {
  window.location.href = `deal-detail.html?id=${id}`;
}

// Initialize
async function init() {
  const session = await checkAuth();
  if (!session) return;
  await loadBusinessSettings();
  await loadCustomer();
}

init();
</script>

</body>
</html>
