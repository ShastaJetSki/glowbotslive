<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard</title>
  <link rel="stylesheet" href="themes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    /* Core themes */
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="blue-light"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }
    [data-theme="slate-dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="slate-light"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; }
    [data-theme="ocean-dark"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="ocean-light"] { --bg-primary: #f0fdfa; --bg-secondary: #e0f7f4; --bg-card: #ffffff; --bg-hover: #ccfbf1; --border-default: #99f6e4; --text-primary: #134e4a; --text-secondary: #2d6a66; --accent-primary: #0d9488; --accent-light: #14b8a6; }
    [data-theme="midnight-dark"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="lavender-light"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; }
    [data-theme="forest-dark"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="mint-light"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="crimson-dark"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; }
    [data-theme="coral-light"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; }
    [data-theme="amber-dark"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; }
    [data-theme="honey-light"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; }
    [data-theme="rose-dark"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; }
    [data-theme="sky-light"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="cyber-dark"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; }
    [data-theme="sand-light"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; }
    /* Backwards compatibility aliases */
    [data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="lavender"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; }
    [data-theme="forest"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="mint"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="crimson"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; }
    [data-theme="coral"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; }
    [data-theme="amber"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; }
    [data-theme="honey"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; }
    [data-theme="rose"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; }
    [data-theme="sky"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="cyber"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; }
    [data-theme="sand"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; }
    [data-theme="slate"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="ocean"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="light-blue"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    
    .theme-toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 1000; display: none; }
    .theme-toast.show { display: block; }
    
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); border-radius: 8px; cursor: pointer; }

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.action-btn { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 50%, transparent); color: var(--accent-light); font-size: 14px; }
    
    .content { flex: 1; padding: 20px; }
    
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .section-header:hover { background: var(--bg-hover); }
    .section-header-title { font-size: 18px; font-weight: 700; color: var(--accent-light); display: flex; align-items: center; gap: 8px; }
    .section-header-icon { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s; }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    .section-content { overflow: hidden; transition: max-height 0.3s ease; margin-bottom: 8px; }
    .section-content.collapsed { max-height: 0 !important; margin-bottom: 0; }
    
    .badge-count { background: var(--bg-hover); color: var(--text-primary); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; border: 1px solid var(--border-default); }
    
    .inbox-container, .tasks-container, .swag-container, .employees-container { background: var(--bg-secondary); border-radius: 8px; overflow: hidden; }
    .inbox-tabs, .tasks-tabs { display: flex; gap: 4px; padding: 12px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); overflow-x: auto; }
    .inbox-tab, .tasks-tab { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; white-space: nowrap; }
    .inbox-tab:hover, .tasks-tab:hover { background: var(--bg-hover); }
    .inbox-tab.active, .tasks-tab.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    .tasks-tab.overdue-alert { background: rgba(153, 27, 27, 0.6); border-color: #991b1b; color: #fff; }
    .form-label .required { color: #991b1b; margin-left: 2px; }
    .swag-item.out-of-stock { border-left: 3px solid #991b1b; }
    .btn-danger { padding: 14px 12px; border-radius: 12px; border: 1px solid #991b1b; background: transparent; color: #991b1b; font-size: 14px; font-weight: 500; cursor: pointer; }
    .priority-urgent { background: rgba(153, 27, 27, 0.25); color: #fca5a5; border-color: #991b1b; }
    .priority-high { background: rgba(180, 83, 9, 0.25); color: #fcd34d; border-color: #b45309; }
    .task-overdue { border-left: 3px solid #991b1b; }
    .text-danger { color: #991b1b; }
    
    @keyframes checkStrobe {
      0% { transform: scale(1); opacity: 0.4; }
      25% { transform: scale(1.3); opacity: 1; box-shadow: 0 0 20px currentColor; }
      50% { transform: scale(1); opacity: 0.4; }
      75% { transform: scale(1.3); opacity: 1; box-shadow: 0 0 20px currentColor; }
      100% { transform: scale(1); opacity: 1; background: #10b981; border-color: #10b981; }
    }
    @keyframes cardComplete {
      0% { opacity: 1; transform: translateX(0) scale(1); }
      20% { transform: translateX(-5px) scale(1.02); }
      40% { opacity: 1; transform: translateX(10px) scale(1.02); background: rgba(16, 185, 129, 0.15); box-shadow: 0 0 30px rgba(16, 185, 129, 0.3); }
      100% { opacity: 0; transform: translateX(100%) scale(0.8); }
    }
    @keyframes checkPop {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      50% { transform: scale(1.4) rotate(10deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes sparkle {
      0% { transform: translate(0,0) scale(1); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
    }
    .task-checkbox.animating { animation: checkStrobe 0.6s ease-out forwards; }
    .task-item.completing { animation: cardComplete 0.8s ease-out 0.5s forwards; pointer-events: none; }
    .task-checkbox.animating::after { content: '✓'; position: absolute; font-size: 14px; font-weight: bold; color: #fff; animation: checkPop 0.3s ease-out 0.5s forwards; opacity: 0; }
    .task-checkbox { position: relative; transition: all 0.2s ease; }
    .task-checkbox:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.2); }
    .task-checkbox:active { transform: scale(0.9); }
    .sparkle { position: fixed; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; animation: sparkle 0.6s ease-out forwards; z-index: 9999; }
    .inbox-list, .tasks-list, .swag-list { max-height: 400px; overflow-y: auto; }
    .inbox-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); cursor: pointer; }
    .inbox-item:hover { background: var(--bg-hover); }
    .inbox-item.unread { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent-primary); }
    .inbox-item-content { flex: 1; min-width: 0; }
    .inbox-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .inbox-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-item-time { font-size: 11px; color: var(--text-secondary); }
    .inbox-item-body { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-empty, .tasks-empty, .swag-empty, .employees-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .inbox-actions, .tasks-actions, .swag-actions { display: flex; gap: 8px; padding: 12px; background: var(--bg-card); border-top: 1px solid var(--border-default); }
    .inbox-action-btn, .tasks-action-btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; }
    .inbox-action-btn:hover, .tasks-action-btn:hover { background: var(--bg-hover); }
    .tasks-action-btn.primary { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    
    .task-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); align-items: flex-start; }
    .task-checkbox { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--border-default); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s ease; }
    .task-checkbox:hover { transform: scale(1.1); }
    .task-checkbox:active { transform: scale(0.95); }
    .task-checkbox.completed { background: #10b981; border-color: #10b981; color: #fff; }
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px; }
    .task-item.completed .task-title { text-decoration: line-through; color: var(--text-secondary); }
    .task-meta { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .task-priority { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-default); }
    .task-assignee { font-size: 11px; color: var(--text-secondary); }
    
    .swag-header, .employees-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); }
    .swag-summary, .employees-summary { display: flex; gap: 16px; flex-wrap: wrap; }
    .swag-stat { display: flex; flex-direction: column; gap: 2px; }
    .swag-stat-value { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    .swag-stat-label { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); }
    .swag-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); align-items: center; }
    .swag-item:hover { background: var(--bg-hover); }
    .swag-item-info { flex: 1; min-width: 0; }
    .swag-item-name { font-weight: 600; font-size: 14px; color: var(--text-primary); }
    .swag-item-category { font-size: 12px; color: var(--text-secondary); }
    .swag-item-qty { display: flex; flex-direction: column; align-items: flex-end; }
    .swag-qty-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .swag-qty-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    .swag-item.low-stock { border-left: 3px solid #b45309; }
    .swag-item.out-of-stock { border-left: 3px solid #991b1b; }
    
    .emp-stat { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); }
    .employees-list { max-height: 600px; overflow-y: auto; }
    .emp-strip { border-bottom: 1px solid var(--border-default); }
    .emp-strip-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; }
    .emp-strip-header:hover { background: var(--bg-hover); }
    .emp-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: #fff; }
    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .emp-role { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px; }
    .emp-contact { font-size: 12px; color: var(--text-secondary); display: flex; gap: 12px; flex-wrap: wrap; margin-top: 4px; }
    .emp-contact a { color: var(--accent-light); text-decoration: none; }
    .emp-contact a:hover { text-decoration: underline; }
    .emp-actions { display: flex; gap: 8px; }
    .emp-action-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; cursor: pointer; text-decoration: none; }
    .emp-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: flex-end; justify-content: center; padding: 0; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 0; line-height: 1; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
    .modal-close:active { background: var(--bg-hover); }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-label .required { color: #991b1b; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 16px; -webkit-appearance: none; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { padding: 16px 20px 24px; border-top: 1px solid var(--border-default); }
    .modal-footer-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .modal-footer-buttons button { flex: 1; min-width: 80px; }
    .btn-secondary { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-secondary:active { background: var(--bg-hover); }
    .btn-primary { padding: 14px 12px; border-radius: 12px; border: none; background: var(--accent-primary); color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary:active { opacity: 0.9; transform: scale(0.98); }
    
    .message-detail { padding: 16px; }
    .message-detail-header { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-default); }
    .message-detail-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .message-detail-meta { font-size: 12px; color: var(--text-secondary); }
    .message-detail-body { font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
    .message-reply-form { background: var(--bg-card); border-radius: 8px; padding: 12px; }
    .message-reply-input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; min-height: 80px; resize: vertical; margin-bottom: 12px; }
    .message-reply-btn { padding: 10px 20px; border-radius: 6px; border: none; background: var(--accent-primary); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      body { padding-bottom: 120px; }
      .content { padding: 12px; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .modal-overlay { align-items: center; padding: 20px; }
      .modal-content { border-radius: 12px; }
    }

    /* Voice Assistant Orb Styles */
    .voice-assistant-container {
      display: none;
      position: fixed;
      bottom: 118px;
      left: 10px;
      z-index: 500;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .voice-assistant-container.active { display: flex; }
    @media (min-width: 769px) {
      .voice-assistant-container { bottom: 20px; left: 10px; }
    }
    
    .voice-orb {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: 
        radial-gradient(circle at 30% 30%, 
          rgba(255,255,255,0.6) 0%,
          transparent 40%
        ),
        linear-gradient(135deg, 
          #5af2ff 0%, #2dd4e0 16.67%, 
          #a855f7 33.33%, #9333ea 50%, 
          #fbbf24 66.67%, #f59e0b 83.33%, 
          #5af2ff 100%
        );
      background-size: 100% 100%, 600% 600%;
      animation: orbColorShift 9s ease-in-out infinite;
      box-shadow: 
        0 4px 20px rgba(90, 242, 255, 0.5),
        0 6px 12px rgba(0, 0, 0, 0.4),
        inset 0 -8px 16px rgba(0, 0, 0, 0.4),
        inset 0 8px 16px rgba(255, 255, 255, 0.3),
        inset 0 0 0 2px rgba(255, 255, 255, 0.2);
      transition: transform 0.4s ease, opacity 0.4s ease;
      opacity: 0.81;
      overflow: hidden;
      position: relative;
    }
    
    /* Smooth color shifting through teal -> purple -> gold */
    @keyframes orbColorShift {
      0%, 100% { 
        background-position: 0% 0%, 0% 50%;
        box-shadow: 0 4px 20px rgba(90, 242, 255, 0.5), 0 6px 12px rgba(0,0,0,0.4), inset 0 -8px 16px rgba(0,0,0,0.4), inset 0 8px 16px rgba(255,255,255,0.3), inset 0 0 0 2px rgba(90, 242, 255, 0.3);
      }
      33% { 
        background-position: 0% 0%, 50% 50%;
        box-shadow: 0 4px 20px rgba(168, 85, 247, 0.5), 0 6px 12px rgba(0,0,0,0.4), inset 0 -8px 16px rgba(0,0,0,0.4), inset 0 8px 16px rgba(255,255,255,0.3), inset 0 0 0 2px rgba(168, 85, 247, 0.3);
      }
      66% { 
        background-position: 0% 0%, 100% 50%;
        box-shadow: 0 4px 20px rgba(251, 191, 36, 0.5), 0 6px 12px rgba(0,0,0,0.4), inset 0 -8px 16px rgba(0,0,0,0.4), inset 0 8px 16px rgba(255,255,255,0.3), inset 0 0 0 2px rgba(251, 191, 36, 0.3);
      }
    }
    
    /* Spinning vertical lines - globe effect */
    .voice-orb::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 300%;
      height: 100%;
      background: repeating-linear-gradient(
        90deg, 
        transparent, transparent 6px, 
        rgba(255,255,255,0.08) 6px, rgba(255,255,255,0.08) 7px
      );
      border-radius: 50%;
      animation: orbSpin 8s linear infinite;
      pointer-events: none;
      mask-image: radial-gradient(circle, black 35%, transparent 60%);
      -webkit-mask-image: radial-gradient(circle, black 35%, transparent 60%);
    }
    
    /* Swirling water effect layer 1 */
    .voice-orb::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(ellipse at 20% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(255, 255, 255, 0.2) 0%, transparent 40%),
        radial-gradient(ellipse at 40% 40%, rgba(255, 255, 255, 0.15) 0%, transparent 30%);
      border-radius: 50%;
      animation: swirlWater 4s ease-in-out infinite;
      pointer-events: none;
      mix-blend-mode: overlay;
    }
    
    .voice-orb:hover { transform: scale(1.1); opacity: 0.9; }
    
    /* Listening state - more intense */
    .voice-orb.listening {
      opacity: 1;
      animation: orbColorShift 9s ease-in-out infinite, orbBreathing 1.5s ease-in-out infinite;
    }
    .voice-orb.listening::before {
      animation: orbSpin 3s linear infinite;
    }
    .voice-orb.listening::after {
      animation: swirlWaterActive 1.5s ease-in-out infinite;
    }
    
    .voice-status {
      color: #5af2ff;
      font-size: 11px;
      font-weight: 600;
      text-shadow: 0 0 8px rgba(90, 242, 255, 0.5);
      text-align: center;
      white-space: nowrap;
    }
    
    /* Assistant Button Styles */
    .assistant-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #5af2ff;
      background: transparent;
      color: #5af2ff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.6;
    }
    .assistant-btn:hover { opacity: 0.8; }
    .assistant-btn.active {
      background: rgba(90, 242, 255, 0.2);
      box-shadow: 0 0 15px rgba(90, 242, 255, 0.4);
      opacity: 1;
    }
    .mobile-nav-btn.assistant-btn {
      border-color: #5af2ff;
      color: #5af2ff;
    }
    .mobile-nav-btn.assistant-btn.active {
      background: rgba(90, 242, 255, 0.3);
      border-color: #5af2ff;
      color: #5af2ff;
      box-shadow: 0 0 12px rgba(90, 242, 255, 0.4);
    }
    
    /* Animations */
    @keyframes orbSpin {
      0% { transform: translateX(0) rotate(0deg); }
      100% { transform: translateX(33.33%) rotate(360deg); }
    }
    
    @keyframes swirlWater {
      0%, 100% { 
        transform: rotate(0deg) scale(1);
        opacity: 0.6;
      }
      25% { 
        transform: rotate(90deg) scale(1.1);
        opacity: 0.8;
      }
      50% { 
        transform: rotate(180deg) scale(0.9);
        opacity: 0.5;
      }
      75% { 
        transform: rotate(270deg) scale(1.05);
        opacity: 0.7;
      }
    }
    
    @keyframes swirlWaterActive {
      0%, 100% { 
        transform: rotate(0deg) scale(1) translateX(0);
        opacity: 0.8;
      }
      20% { 
        transform: rotate(72deg) scale(1.2) translateX(2px);
        opacity: 1;
      }
      40% { 
        transform: rotate(144deg) scale(0.85) translateX(-2px);
        opacity: 0.7;
      }
      60% { 
        transform: rotate(216deg) scale(1.15) translateX(1px);
        opacity: 0.9;
      }
      80% { 
        transform: rotate(288deg) scale(0.95) translateX(-1px);
        opacity: 0.75;
      }
    }
    
    @keyframes orbBreathing {
      0%, 100% { 
        transform: scale(1);
      }
      50% { 
        transform: scale(1.08);
      }
    }
    
    /* Inner swirl elements - mysterious water/plasma effect */
    .orb-swirl {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120%;
      height: 120%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: 
        conic-gradient(from 0deg at 50% 50%, 
          transparent 0deg, 
          rgba(255, 255, 255, 0.25) 60deg, 
          transparent 120deg,
          rgba(255, 255, 255, 0.15) 180deg,
          transparent 240deg,
          rgba(255, 255, 255, 0.2) 300deg,
          transparent 360deg
        );
      animation: swirlRotate 6s linear infinite;
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .orb-swirl-2 {
      width: 90%;
      height: 90%;
      background: 
        conic-gradient(from 120deg at 40% 60%, 
          transparent 0deg, 
          rgba(255, 255, 255, 0.3) 45deg, 
          transparent 90deg,
          rgba(255, 255, 255, 0.2) 180deg,
          transparent 225deg,
          rgba(255, 255, 255, 0.25) 270deg,
          transparent 360deg
        );
      animation: swirlRotate 4s linear infinite reverse;
      opacity: 0.8;
    }
    .orb-swirl-3 {
      width: 60%;
      height: 60%;
      background: 
        radial-gradient(ellipse at 30% 70%, rgba(255, 255, 255, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 40%);
      animation: swirlFloat 3s ease-in-out infinite;
      opacity: 0.9;
    }
    
    /* Listening state - faster, more chaotic movement */
    .voice-orb.listening .orb-swirl {
      animation: swirlRotate 2s linear infinite, swirlPulse 0.8s ease-in-out infinite;
    }
    .voice-orb.listening .orb-swirl-2 {
      animation: swirlRotate 1.5s linear infinite reverse, swirlPulse 0.6s ease-in-out infinite alternate;
    }
    .voice-orb.listening .orb-swirl-3 {
      animation: swirlFloat 1s ease-in-out infinite, swirlPulse 0.5s ease-in-out infinite;
    }
    
    @keyframes swirlRotate {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    @keyframes swirlFloat {
      0%, 100% { 
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 0.7;
      }
      33% { 
        transform: translate(-45%, -55%) scale(1.1) rotate(120deg);
        opacity: 0.9;
      }
      66% { 
        transform: translate(-55%, -45%) scale(0.9) rotate(240deg);
        opacity: 0.6;
      }
    }
    
    @keyframes swirlPulse {
      0%, 100% { opacity: 0.6; filter: brightness(1); }
      50% { opacity: 1; filter: brightness(1.3); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/balacodeio/Vapi-Web-UMD@latest/dist/latest/vapi-web-bundle.min.js"></script>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">☰</button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Dashboard</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='sharklaw-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
      <button onclick="location.href='account.html'">Account</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:32px; font-weight:600;">Dashboard</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <div style="display:flex; align-items:center; gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px; align-items:center;">
      <a href="dashboard-sharklaw.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Contacts</a>
      <a href="sharklaw-swag.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Swag</a>
      <a href="sharklaw-settings.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Settings</a>
      <button id="desktopAssistantBtn" onclick="toggleVoiceAssistant()" class="assistant-btn">Assistant</button>
    </nav>
  </div>
</div>

<div class="main">
  <div class="content">
    
    <!-- Messages Section -->
    <div class="section-header collapsed" onclick="toggleSection('messages')">
      <div class="section-header-title">
        Messages
        <span class="badge-count" id="messagesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="messagesContent">
      <div class="inbox-container">
        <div class="inbox-tabs">
          <button class="inbox-tab active" onclick="switchInboxTab('all', this)">All</button>
          <button class="inbox-tab" onclick="switchInboxTab('unread', this)">Unread</button>
          <button class="inbox-tab" onclick="switchInboxTab('sent', this)">Sent</button>
        </div>
        <div class="inbox-list" id="inboxList"><div class="inbox-empty"><div>No messages yet</div></div></div>
        <div class="inbox-actions">
          <button class="inbox-action-btn" style="background:var(--accent-primary);border-color:var(--accent-primary);color:#fff;" onclick="openComposeModal()">+ New Message</button>
          <button class="inbox-action-btn" onclick="markAllNotificationsRead()">Mark All Read</button>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="section-header collapsed" onclick="toggleSection('tasks')">
      <div class="section-header-title">
        Tasks
        <span class="badge-count" id="tasksBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="tasksContent">
      <div class="tasks-container">
        <div class="tasks-tabs">
          <button class="tasks-tab active" onclick="switchTasksTab('pending', this)">Pending</button>
          <button class="tasks-tab" onclick="switchTasksTab('in_progress', this)">In Progress</button>
          <button class="tasks-tab" id="overdueTab" onclick="switchTasksTab('overdue', this)">Overdue</button>
          <button class="tasks-tab" onclick="switchTasksTab('completed', this)">Done</button>
        </div>
        <div class="tasks-list" id="tasksList"><div class="tasks-empty"><div>No tasks</div></div></div>
        <div class="tasks-actions"><button class="tasks-action-btn primary" onclick="openNewTaskModal()">+ New Task</button></div>
      </div>
    </div>

    <!-- Swag Section -->
    <div class="section-header collapsed" onclick="toggleSection('swag')">
      <div class="section-header-title">
        Swag Inventory
        <span class="badge-count" id="swagBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="swagContent">
      <div class="swag-container">
        <div class="swag-header">
          <div class="swag-summary">
            <div class="swag-stat"><span class="swag-stat-value" id="swagTotalItems">0</span><span class="swag-stat-label">Total Items</span></div>
            <div class="swag-stat"><span class="swag-stat-value" id="swagLowStock">0</span><span class="swag-stat-label">Low Stock</span></div>
          </div>
        </div>
        <div class="swag-list" id="swagList"><div class="swag-empty"><div>No swag items yet</div></div></div>
        <div class="swag-actions"><button class="tasks-action-btn primary" onclick="location.href='sharklaw-swag.html'">Manage Swag</button></div>
      </div>
    </div>

    <!-- Team Section -->
    <div class="section-header collapsed" onclick="toggleSection('employees')">
      <div class="section-header-title">
        Team
        <span class="badge-count" id="employeesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="employeesContent">
      <div class="employees-container">
        <div class="employees-list" id="employeesList"><div class="employees-empty"><div>Loading team...</div></div></div>
      </div>
    </div>

  </div>
</div>

<!-- New Task Modal -->
<div class="modal-overlay" id="newTaskModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Task</div><button class="modal-close" onclick="closeNewTaskModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Task Title <span class="required">*</span></label><input type="text" class="form-input" id="taskTitle" placeholder="Enter task title"></div>
      <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea></div>
      <div class="form-group"><label class="form-label">Assign To</label><select class="form-select" id="taskAssignee"><option value="">-- Unassigned --</option></select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="taskPriority"><option value="low">Low</option><option value="normal" selected>Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div>
        <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="taskDueDate"></div>
      </div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="saveNewTask()">Create Task</button><button class="btn-secondary" onclick="closeNewTaskModal()">Cancel</button></div></div>
  </div>
</div>

<!-- Task Detail Modal -->
<div class="modal-overlay" id="taskDetailModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">Task Details</div><button class="modal-close" onclick="closeTaskDetailModal()">&times;</button></div>
    <div class="modal-body" id="taskDetailBody"></div>
    <div class="modal-footer">
      <div class="modal-footer-buttons" id="taskDetailFooter"></div>
    </div>
  </div>
</div>

<!-- New Event Modal -->
<div class="modal-overlay" id="newEventModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Event</div><button class="modal-close" onclick="closeNewEventModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Event Title <span class="required">*</span></label><input type="text" class="form-input" id="eventTitle" placeholder="Event name"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="eventOrganization" placeholder="Hosting organization"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date <span class="required">*</span></label><input type="date" class="form-input" id="eventDate"></div>
        <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="eventTime" value="10:00"></div>
      </div>
      <div class="form-group"><label class="form-label">Event Type</label><select class="form-select" id="eventType"><option value="">-- Select --</option><option value="Open House">Open House</option><option value="Bike Night">Bike Night</option><option value="Run">Run</option><option value="Party">Party</option><option value="Fundraiser">Fundraiser</option><option value="Support">Support</option></select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ticket Price</label><input type="number" class="form-input" id="eventTicketPrice" placeholder="0.00" step="0.01" min="0"></div>
        <div class="form-group"><label class="form-label">Expected Attendance</label><input type="number" class="form-input" id="eventAttendance" placeholder="0" min="0"></div>
      </div>
      <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="eventLocation" placeholder="Event location"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="eventNotes" placeholder="Event details..."></textarea></div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="saveNewEvent()">Create Event</button><button class="btn-secondary" onclick="closeNewEventModal()">Cancel</button></div></div>
  </div>
</div>

<!-- New Contact Modal -->
<div class="modal-overlay" id="newContactModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Contact</div><button class="modal-close" onclick="closeNewContactModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="contactFirstName" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name <span class="required">*</span></label><input type="text" class="form-input" id="contactLastName" placeholder="Last name"></div>
      </div>
      <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="contactPhone" placeholder="(555) 123-4567"></div>
      <div class="form-group"><label class="form-label">Email <span class="required">*</span></label><input type="text" class="form-input" id="contactEmail" placeholder="email@example.com"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="contactOrganization" placeholder="Organization name"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Client Type</label><select class="form-select" id="contactClientType"><option value="">-- Select --</option><option value="RC">RC</option><option value="HOG">HOG</option><option value="Independent">Independent</option><option value="Other">Other</option></select></div>
        <div class="form-group"><label class="form-label">Funnel Stage</label><select class="form-select" id="contactStage"><option value="1">1st Contact</option><option value="2">Receive Artwork</option><option value="3">Opt-in Contact</option><option value="4">Deliver Pop Up</option><option value="5">Lead</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="contactNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="saveNewContact()">Add Contact</button><button class="btn-secondary" onclick="closeNewContactModal()">Cancel</button></div></div>
  </div>
</div>

<!-- Message Detail Modal -->
<div class="modal-overlay" id="messageDetailModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">Message</div><button class="modal-close" onclick="closeMessageDetailModal()">&times;</button></div>
    <div class="modal-body" id="messageDetailBody"></div>
  </div>
</div>

<!-- Compose Message Modal -->
<div class="modal-overlay" id="composeModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Message</div><button class="modal-close" onclick="closeComposeModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">To</label><select class="form-select" id="composeTo"><option value="">-- Select Recipient --</option></select></div>
      <div class="form-group"><label class="form-label">Subject <span class="required">*</span></label><input type="text" class="form-input" id="composeSubject" placeholder="Message subject"></div>
      <div class="form-group"><label class="form-label">Message <span class="required">*</span></label><textarea class="form-textarea" id="composeBody" placeholder="Type your message..." style="min-height:120px;"></textarea></div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="sendNewMessage()">Send Message</button><button class="btn-secondary" onclick="closeComposeModal()">Cancel</button></div></div>
  </div>
</div>

<!-- Voice Assistant Container -->
<div class="voice-assistant-container" id="voiceAssistant">
  <button class="voice-orb" id="voiceOrb">
    <span class="orb-swirl"></span>
    <span class="orb-swirl orb-swirl-2"></span>
    <span class="orb-swirl orb-swirl-3"></span>
  </button>
  <div class="voice-status" id="voiceStatus">Tap to speak</div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn active">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a>
  </div>
  <div class="mobile-nav-row three-col">
    <button id="mobileAssistantBtn" class="mobile-nav-btn assistant-btn" onclick="toggleVoiceAssistant()">Assistant</button>
    <a href="sharklaw-contacts.html" class="mobile-nav-btn">Contacts</a>
    <a href="sharklaw-swag.html" class="mobile-nav-btn">Swag</a>
  </div>
</div>

<script>
const SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let currentUserId=null,currentTenantId=null,userEmail=null;
let currentInboxTab='all',currentTasksTab='pending';
let allNotifications=[],allTasks=[],allEmployeesData=[],allSwagItems=[];

var THEME_NAMES={'dark-blue':'Dark Blue','blue-light':'Blue Light','slate-dark':'Slate Dark','slate-light':'Slate Light','ocean-dark':'Ocean Dark','ocean-light':'Ocean Light','midnight-dark':'Midnight','lavender-light':'Lavender','forest-dark':'Forest','mint-light':'Mint','crimson-dark':'Crimson','coral-light':'Coral','amber-dark':'Amber','honey-light':'Honey','rose-dark':'Rose','sky-light':'Sky','cyber-dark':'Cyber','sand-light':'Sand'};
var userThemeBank=['dark-blue'];
var themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';if(!userThemeBank.includes(t))t='dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=userThemeBank.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){if(userThemeBank.length<=1){showThemeToast('Unlock more themes in Settings!');return;}themeIndex=(themeIndex+1)%userThemeBank.length;var t=userThemeBank[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(THEME_NAMES[t]||t);}
async function loadUserThemeBank(){if(!currentUserId)return;try{var r=await sb.from('user_theme_bank').select('theme_key').eq('user_id',currentUserId);if(r.data&&r.data.length>0){userThemeBank=['dark-blue'].concat(r.data.map(function(t){return t.theme_key;}));userThemeBank=[...new Set(userThemeBank)];}loadTheme();}catch(e){console.error('Error loading theme bank:',e);}}
function showThemeToast(msg){var toast=document.getElementById('themeToast');if(!toast){toast=document.createElement('div');toast.id='themeToast';toast.className='theme-toast';document.body.appendChild(toast);}toast.textContent=msg;toast.classList.add('show');setTimeout(function(){toast.classList.remove('show');},2000);}
loadTheme();

function toggleMobileMenu(btn){document.getElementById('mobileHeaderContent').classList.toggle('expanded');}
async function logout(){await sb.auth.signOut();localStorage.clear();location.replace("login.html");}

function toggleSection(sectionId){var content=document.getElementById(sectionId+'Content');var header=event.currentTarget;content.classList.toggle('collapsed');header.classList.toggle('collapsed');if(content.classList.contains('collapsed')){content.style.maxHeight='0px';}else{content.style.maxHeight=content.scrollHeight+'px';}}
function updateSectionHeight(sectionId){var content=document.getElementById(sectionId+'Content');if(!content.classList.contains('collapsed')){content.style.maxHeight='none';}}

async function loadInboxData(){if(!currentTenantId)return;var r=await sb.from('notifications').select('*').eq('tenant_id',currentTenantId).order('created_at',{ascending:false}).limit(50);allNotifications=r.data||[];renderInbox();updateInboxBadge();updateSectionHeight('messages');}
function renderInbox(){var container=document.getElementById('inboxList');var filtered=allNotifications;if(currentInboxTab==='unread')filtered=allNotifications.filter(function(n){return!n.is_read;});else if(currentInboxTab==='sent')filtered=allNotifications.filter(function(n){return n.title&&n.title.indexOf('Sent:')==0;});if(filtered.length===0){container.innerHTML='<div class="inbox-empty"><div>No messages</div></div>';return;}container.innerHTML=filtered.map(function(item){return'<div class="inbox-item '+(item.is_read?'':'unread')+'" onclick="openMessageDetail(\''+item.notification_id+'\')"><div class="inbox-item-content"><div class="inbox-item-header"><div class="inbox-item-title">'+(item.title||'Notification')+'</div><div class="inbox-item-time">'+formatTimeAgo(item.created_at)+'</div></div><div class="inbox-item-body">'+(item.body||'')+'</div></div></div>';}).join('');}
function switchInboxTab(tab,btn){currentInboxTab=tab;document.querySelectorAll('.inbox-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');renderInbox();}
async function openMessageDetail(id){var msg=allNotifications.find(function(n){return n.notification_id===id;});if(!msg)return;await sb.from('notifications').update({is_read:true}).eq('notification_id',id);msg.is_read=true;renderInbox();updateInboxBadge();var quickReplies='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;"><button class="inbox-action-btn" onclick="quickReply(\'Got it, thanks!\')">Got it!</button><button class="inbox-action-btn" onclick="quickReply(\'On my way\')">On my way</button><button class="inbox-action-btn" onclick="quickReply(\'Will do\')">Will do</button><button class="inbox-action-btn" onclick="quickReply(\'Call me\')">Call me</button></div>';document.getElementById('messageDetailBody').innerHTML='<div class="message-detail"><div class="message-detail-header"><div class="message-detail-title">'+(msg.title||'Notification')+'</div><div class="message-detail-meta">'+new Date(msg.created_at).toLocaleString()+'</div></div><div class="message-detail-body" style="white-space:pre-wrap;">'+(msg.body||'No content')+'</div><div class="message-reply-form"><div style="font-weight:600;margin-bottom:8px;">Quick Reply:</div>'+quickReplies+'<textarea class="message-reply-input" id="messageReplyText" placeholder="Or type a custom reply..."></textarea><div style="display:flex;gap:8px;"><button class="message-reply-btn" onclick="sendCustomReply(\''+id+'\')">Send Reply</button><button class="inbox-action-btn danger" style="border-color:#991b1b;color:#991b1b;" onclick="deleteMessage(\''+id+'\')">Delete</button></div></div></div>';currentMessageId=id;document.getElementById('messageDetailModal').classList.add('active');}
var currentMessageId=null;
function closeMessageDetailModal(){document.getElementById('messageDetailModal').classList.remove('active');currentMessageId=null;}
async function quickReply(text){if(!currentMessageId)return;try{var r=await sb.from('notifications').insert({tenant_id:currentTenantId,recipient_id:currentUserId,notification_type:'message',title:'Sent: Reply',body:text,is_read:true,created_at:new Date().toISOString()});if(r.error)throw r.error;await incrementStat('messages_sent');closeMessageDetailModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to send'));}}
async function sendCustomReply(originalId){var replyText=document.getElementById('messageReplyText').value.trim();if(!replyText){alert('Enter a reply message');return;}try{var r=await sb.from('notifications').insert({tenant_id:currentTenantId,recipient_id:currentUserId,notification_type:'message',title:'Sent: Reply',body:replyText,is_read:true,created_at:new Date().toISOString()});if(r.error)throw r.error;await incrementStat('messages_sent');closeMessageDetailModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to send'));}}
async function deleteMessage(id){if(!confirm('Delete this message?'))return;try{var r=await sb.from('notifications').delete().eq('notification_id',id);if(r.error)throw r.error;closeMessageDetailModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to delete'));}}
function openComposeModal(){document.getElementById('composeSubject').value='';document.getElementById('composeBody').value='';populateRecipients();document.getElementById('composeModal').classList.add('active');}
function closeComposeModal(){document.getElementById('composeModal').classList.remove('active');}
function populateRecipients(){var sel=document.getElementById('composeTo');sel.innerHTML='<option value="">-- Select Recipient --</option><option value="all">All Team Members</option>';allEmployeesData.forEach(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||'Unknown';sel.innerHTML+='<option value="'+emp.employee_id+'">'+name+'</option>';});}
async function sendNewMessage(){var subject=document.getElementById('composeSubject').value.trim();var body=document.getElementById('composeBody').value.trim();if(!subject){alert('Enter a subject');return;}if(!body){alert('Enter a message');return;}try{var r=await sb.from('notifications').insert({tenant_id:currentTenantId,recipient_id:currentUserId,notification_type:'message',title:'Sent: '+subject,body:body,is_read:true,created_at:new Date().toISOString()});if(r.error)throw r.error;await incrementStat('messages_sent');closeComposeModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to send'));}}
async function markAllNotificationsRead(){await sb.from('notifications').update({is_read:true}).eq('tenant_id',currentTenantId).eq('is_read',false);loadInboxData();}
function updateInboxBadge(){var count=allNotifications.filter(function(n){return!n.is_read;}).length;var badge=document.getElementById('messagesBadge');badge.textContent=count;badge.style.display=count>0?'inline-block':'none';}

async function loadTasksData(){if(!currentTenantId)return;var r=await sb.from('tasks').select('*').eq('tenant_id',currentTenantId).order('due_at',{ascending:true});allTasks=r.data||[];renderTasks();updateTasksBadge();updateOverdueTab();updateSectionHeight('tasks');}
function getAssigneeFromDesc(desc){if(!desc)return'';var match=desc.match(/\[Assigned to: ([^\]]+)\]/);return match?match[1]:'';}
function getOverdueTasks(){var now=new Date();return allTasks.filter(function(t){return t.status!=='completed'&&t.due_at&&new Date(t.due_at)<now;});}
function updateOverdueTab(){var overdueCount=getOverdueTasks().length;var tab=document.getElementById('overdueTab');if(overdueCount>0){tab.classList.add('overdue-alert');tab.textContent='Overdue ('+overdueCount+')';}else{tab.classList.remove('overdue-alert');tab.textContent='Overdue';}}
function getDefaultEmployeeColor(name){var colors=['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#84cc16','#06b6d4'];var hash=0;for(var i=0;i<name.length;i++){hash=name.charCodeAt(i)+((hash<<5)-hash);}return colors[Math.abs(hash)%colors.length];}
var storedEmployeeColors=JSON.parse(localStorage.getItem('employeeColors')||'{}');
function getEmployeeColor(name){if(!name)return'var(--border-default)';var emp=allEmployeesData.find(function(e){var empName=((e.first_name||'')+' '+(e.last_name||'')).trim();return empName===name;});if(emp&&storedEmployeeColors[emp.employee_id])return storedEmployeeColors[emp.employee_id];return getDefaultEmployeeColor(name);}
function renderTasks(){var container=document.getElementById('tasksList');var now=new Date();var filtered=allTasks;if(currentTasksTab==='pending')filtered=allTasks.filter(function(t){return t.status==='pending'||t.status==='todo';});else if(currentTasksTab==='in_progress')filtered=allTasks.filter(function(t){return t.status==='in_progress';});else if(currentTasksTab==='overdue')filtered=getOverdueTasks();else if(currentTasksTab==='completed')filtered=allTasks.filter(function(t){return t.status==='completed';});if(filtered.length===0){container.innerHTML='<div class="tasks-empty"><div>No tasks</div></div>';return;}var roleOrder={'owner':1,'manager':2,'sales_manager':2,'admin':3,'staff':4,'technician':4,'sales_consultant':4};function getAssigneeRank(task){var assigneeName=getAssigneeFromDesc(task.description);if(!assigneeName)return 99;var emp=allEmployeesData.find(function(e){return((e.first_name||'')+' '+(e.last_name||'')).trim()===assigneeName;});if(!emp)return 99;return roleOrder[(emp.role||'staff').toLowerCase()]||5;}filtered=filtered.slice().sort(function(a,b){var rankA=getAssigneeRank(a);var rankB=getAssigneeRank(b);if(rankA!==rankB)return rankA-rankB;var dateA=a.due_at?new Date(a.due_at):new Date('9999-12-31');var dateB=b.due_at?new Date(b.due_at):new Date('9999-12-31');return dateA-dateB;});container.innerHTML=filtered.map(function(task){var isCompleted=task.status==='completed';var assigneeName=getAssigneeFromDesc(task.description);var isOverdue=!isCompleted&&task.due_at&&new Date(task.due_at)<now;var dueText=task.due_at?formatDate(task.due_at):'No due date';var priorityClass=task.priority==='urgent'?'priority-urgent':(task.priority==='high'?'priority-high':'');var empColor=getEmployeeColor(assigneeName);var checkboxStyle=isCompleted?'background:#10b981;border-color:#10b981;color:#fff;':'background:rgba('+hexToRgb(empColor)+',0.81);border-color:'+empColor+';color:#fff;';return'<div class="task-item '+(isCompleted?'completed':'')+'" id="task-'+task.task_id+'" style="cursor:pointer;'+(isOverdue?'border-left:3px solid #991b1b;':'')+'"><div class="task-checkbox '+(isCompleted?'completed':'')+'" style="'+checkboxStyle+'" onclick="event.stopPropagation();animateComplete(\''+task.task_id+'\','+!isCompleted+')">'+(isCompleted?'✓':'')+'</div><div class="task-content" onclick="openTaskDetail(\''+task.task_id+'\')"><div class="task-title">'+task.title+'</div><div class="task-meta"><span class="task-priority '+priorityClass+'">'+(task.priority||'normal')+'</span><span class="task-assignee" style="'+(isOverdue?'color:#991b1b;font-weight:600;':'')+'">'+(isOverdue?'OVERDUE • ':'')+'Due: '+dueText+'</span>'+(assigneeName?'<span class="task-assignee" style="color:'+empColor+';">→ '+assigneeName+'</span>':'')+'</div></div></div>';}).join('');}
function hexToRgb(hex){if(hex.startsWith('var'))return'34,52,68';var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?parseInt(result[1],16)+','+parseInt(result[2],16)+','+parseInt(result[3],16):'59,130,246';}
function animateComplete(taskId,markComplete){if(!markComplete){toggleTaskComplete(taskId,false);return;}var taskEl=document.getElementById('task-'+taskId);var checkbox=taskEl.querySelector('.task-checkbox');checkbox.classList.add('animating');createSparkles(checkbox);setTimeout(function(){taskEl.classList.add('completing');},600);setTimeout(function(){toggleTaskComplete(taskId,true);},1300);}
function createSparkles(element){var rect=element.getBoundingClientRect();var colors=['#10b981','#34d399','#6ee7b7','#fbbf24','#60a5fa'];for(var i=0;i<12;i++){var sparkle=document.createElement('div');sparkle.className='sparkle';sparkle.style.left=rect.left+rect.width/2+'px';sparkle.style.top=rect.top+rect.height/2+'px';sparkle.style.background=colors[Math.floor(Math.random()*colors.length)];sparkle.style.setProperty('--tx',(Math.random()-0.5)*80+'px');sparkle.style.setProperty('--ty',(Math.random()-0.5)*80+'px');document.body.appendChild(sparkle);setTimeout(function(){sparkle.remove();},600);}}
function formatDate(dateStr){var d=new Date(dateStr);return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function formatDateTime(dateStr){if(!dateStr)return'--';var d=new Date(dateStr);return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' at '+d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});}
var currentTaskId=null;
function openTaskDetail(taskId){var task=allTasks.find(function(t){return t.task_id===taskId;});if(!task)return;currentTaskId=taskId;var assigneeName=getAssigneeFromDesc(task.description);var now=new Date();var isOverdue=task.status!=='completed'&&task.due_at&&new Date(task.due_at)<now;var isCompleted=task.status==='completed';var descClean=(task.description||'').replace(/\[Assigned to: [^\]]+\]/g,'').trim();var statusText=isCompleted?'Completed':(isOverdue?'Overdue':(task.status==='in_progress'?'In Progress':'Pending'));var dueDate=task.due_at?task.due_at.split('T')[0]:'';var html='';html+='<div style="margin-bottom:24px;"><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Task</div><div style="font-size:22px;font-weight:700;line-height:1.3;">'+task.title+'</div></div>';if(descClean){html+='<div style="margin-bottom:24px;"><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Description</div><div style="font-size:15px;line-height:1.5;color:var(--text-primary);">'+descClean+'</div></div>';}html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">';html+='<div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Status</div><select class="form-select" id="editTaskStatus" style="padding:10px 12px;font-size:14px;"><option value="pending" '+(task.status==='pending'?'selected':'')+'>Pending</option><option value="in_progress" '+(task.status==='in_progress'?'selected':'')+'>In Progress</option><option value="completed" '+(task.status==='completed'?'selected':'')+'>Completed</option></select></div>';html+='<div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Priority</div><select class="form-select" id="editTaskPriority" style="padding:10px 12px;font-size:14px;"><option value="low" '+(task.priority==='low'?'selected':'')+'>Low</option><option value="normal" '+(task.priority==='normal'||!task.priority?'selected':'')+'>Normal</option><option value="high" '+(task.priority==='high'?'selected':'')+'>High</option><option value="urgent" '+(task.priority==='urgent'?'selected':'')+'>Urgent</option></select></div>';html+='</div>';html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">';html+='<div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Due Date</div><input type="date" class="form-input" id="editTaskDue" value="'+dueDate+'" style="padding:10px 12px;font-size:14px;"></div>';html+='<div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Assign To</div><select class="form-select" id="editTaskAssign" style="padding:10px 12px;font-size:14px;"><option value="">Unassigned</option>';allEmployeesData.forEach(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim();var selected=assigneeName===name?'selected':'';html+='<option value="'+emp.employee_id+'" '+selected+'>'+name+'</option>';});html+='</select></div>';html+='</div>';html+='<div style="background:var(--bg-card);border-radius:10px;padding:16px;border:1px solid var(--border-default);">';html+='<div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:12px;">Timeline</div>';html+='<div style="display:flex;flex-direction:column;gap:10px;font-size:14px;">';html+='<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text-secondary);">Created</span><span>'+formatDateTime(task.created_at)+'</span></div>';if(task.updated_at&&task.updated_at!==task.created_at){html+='<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:var(--text-secondary);">Updated</span><span>'+formatDateTime(task.updated_at)+'</span></div>';}if(isCompleted){html+='<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#10b981;">Completed</span><span>'+formatDateTime(task.completed_at||task.updated_at)+'</span></div>';}if(isOverdue){html+='<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#991b1b;font-weight:600;">⚠ Overdue</span><span style="color:#991b1b;">'+Math.floor((now-new Date(task.due_at))/(1000*60*60*24))+' days</span></div>';}html+='</div></div>';document.getElementById('taskDetailBody').innerHTML=html;var footerHtml='';if(!isCompleted){footerHtml+='<button class="btn-primary" style="background:#10b981;border-color:#10b981;" onclick="markTaskDoneFromDetail(\''+taskId+'\')">✓ Mark as Done</button>';}else{footerHtml+='<button class="btn-secondary" style="border-color:#10b981;color:#10b981;" onclick="reopenTask(\''+taskId+'\')">↩ Reopen Task</button>';}footerHtml+='<button class="btn-primary" onclick="saveTaskChanges()">Save Changes</button>';footerHtml+='<button class="btn-secondary" style="border-color:#991b1b;color:#991b1b;" onclick="deleteTask(\''+taskId+'\')">Delete</button>';document.getElementById('taskDetailFooter').innerHTML=footerHtml;document.getElementById('taskDetailModal').classList.add('active');}
function markTaskDoneFromDetail(taskId){closeTaskDetailModal();setTimeout(function(){var taskEl=document.getElementById('task-'+taskId);if(taskEl){var checkbox=taskEl.querySelector('.task-checkbox');checkbox.classList.add('animating');setTimeout(function(){taskEl.classList.add('completing');},600);setTimeout(function(){toggleTaskComplete(taskId,true);},1300);}else{toggleTaskComplete(taskId,true);}},100);}
function reopenTask(taskId){toggleTaskComplete(taskId,false);closeTaskDetailModal();}
function closeTaskDetailModal(){document.getElementById('taskDetailModal').classList.remove('active');currentTaskId=null;}
async function saveTaskChanges(){if(!currentTaskId)return;var task=allTasks.find(function(t){return t.task_id===currentTaskId;});if(!task)return;var newStatus=document.getElementById('editTaskStatus').value;var newPriority=document.getElementById('editTaskPriority').value;var newDue=document.getElementById('editTaskDue').value;var newAssignId=document.getElementById('editTaskAssign').value;var descClean=(task.description||'').replace(/\[Assigned to: [^\]]+\]/g,'').trim();var newAssigneeName='';if(newAssignId){var emp=allEmployeesData.find(function(e){return e.employee_id===newAssignId;});if(emp)newAssigneeName=((emp.first_name||'')+' '+(emp.last_name||'')).trim();}var newDesc=descClean;if(newAssigneeName){newDesc=(descClean?descClean+'\n':'')+'[Assigned to: '+newAssigneeName+']';}var updateData={status:newStatus,priority:newPriority,description:newDesc||null,due_at:newDue?new Date(newDue).toISOString():null,updated_at:new Date().toISOString()};if(newStatus==='completed'&&task.status!=='completed'){updateData.completed_at=new Date().toISOString();}else if(newStatus!=='completed'){updateData.completed_at=null;}try{var r=await sb.from('tasks').update(updateData).eq('task_id',currentTaskId);if(r.error)throw r.error;closeTaskDetailModal();loadTasksData();}catch(e){alert('Error: '+(e.message||'Failed to save'));}}
async function deleteTask(taskId){if(!confirm('Delete this task?'))return;try{var r=await sb.from('tasks').delete().eq('task_id',taskId);if(r.error)throw r.error;closeTaskDetailModal();loadTasksData();}catch(e){alert('Error: '+(e.message||'Failed to delete'));}}
function switchTasksTab(tab,btn){currentTasksTab=tab;document.querySelectorAll('.tasks-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');renderTasks();}
async function toggleTaskComplete(taskId,completed){var updateData={status:completed?'completed':'pending',updated_at:new Date().toISOString()};if(completed){updateData.completed_at=new Date().toISOString();}else{updateData.completed_at=null;}await sb.from('tasks').update(updateData).eq('task_id',taskId);if(completed)await incrementStat('tasks_completed');loadTasksData();}
function updateTasksBadge(){var count=allTasks.filter(function(t){return t.status!=='completed';}).length;var badge=document.getElementById('tasksBadge');badge.textContent=count;badge.style.display=count>0?'inline-block':'none';}

async function loadSwagData(){if(!currentTenantId)return;var r=await sb.from('parts_inventory').select('*').eq('tenant_id',currentTenantId).order('part_name',{ascending:true});allSwagItems=r.data||[];renderSwag();updateSwagBadge();}
function renderSwag(){var container=document.getElementById('swagList');var totalItems=allSwagItems.reduce(function(sum,item){return sum+(item.quantity_on_hand||0);},0);var lowStockCount=allSwagItems.filter(function(item){return(item.quantity_on_hand||0)<=5;}).length;document.getElementById('swagTotalItems').textContent=totalItems;document.getElementById('swagLowStock').textContent=lowStockCount;if(allSwagItems.length===0){container.innerHTML='<div class="swag-empty"><div>No swag items yet</div></div>';return;}container.innerHTML=allSwagItems.map(function(item){var qty=item.quantity_on_hand||0;var isLow=qty>0&&qty<=5;var isOut=qty===0;return'<div class="swag-item '+(isOut?'out-of-stock':(isLow?'low-stock':''))+'"><div class="swag-item-info"><div class="swag-item-name">'+(item.part_name||'Unknown')+'</div><div class="swag-item-category">'+(item.description||'--')+'</div></div><div class="swag-item-qty"><span class="swag-qty-value">'+qty+'</span><span class="swag-qty-label">'+(isOut?'Out':(isLow?'Low':'In Stock'))+'</span></div></div>';}).join('');}
function updateSwagBadge(){var count=allSwagItems.filter(function(item){return(item.quantity_on_hand||0)<=5;}).length;var badge=document.getElementById('swagBadge');badge.textContent=count;badge.style.display=count>0?'inline-block':'none';}

async function loadEmployeesData(){if(!currentTenantId)return;var r=await sb.from('employees').select('*').eq('tenant_id',currentTenantId).order('last_name',{ascending:true});allEmployeesData=r.data||[];var badge=document.getElementById('employeesBadge');badge.textContent=allEmployeesData.length;badge.style.display=allEmployeesData.length>0?'inline-block':'none';storedEmployeeColors=JSON.parse(localStorage.getItem('employeeColors')||'{}');renderEmployees();populateTaskAssignees();}
function renderEmployees(){var container=document.getElementById('employeesList');if(allEmployeesData.length===0){container.innerHTML='<div class="employees-empty"><div>No team members found</div></div>';return;}var roleOrder={'owner':1,'manager':2,'admin':3,'sales_manager':2,'staff':4,'technician':4,'sales_consultant':4};var sorted=allEmployeesData.slice().sort(function(a,b){var ra=roleOrder[(a.role||'staff').toLowerCase()]||5;var rb=roleOrder[(b.role||'staff').toLowerCase()]||5;if(ra!==rb)return ra-rb;return((a.last_name||'')+(a.first_name||'')).localeCompare((b.last_name||'')+(b.first_name||''));});container.innerHTML=sorted.map(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||'Unknown';var initials=((emp.first_name||'U')[0]+((emp.last_name||'')[0]||'')).toUpperCase();var color=storedEmployeeColors[emp.employee_id]||getDefaultEmployeeColor(name);var role=(emp.role||'staff').replace(/_/g,' ');role=role.charAt(0).toUpperCase()+role.slice(1);return'<div class="emp-strip"><div class="emp-strip-header"><div class="emp-avatar" style="background:rgba('+hexToRgb(color)+',0.81);">'+initials+'</div><div class="emp-info"><div class="emp-name">'+name+'</div><div class="emp-role">'+role+(emp.department?' • '+emp.department:'')+'</div></div><div class="emp-actions">'+(emp.phone?'<a href="tel:'+emp.phone+'" class="emp-action-btn">Call</a>':'')+(emp.email?'<a href="mailto:'+emp.email+'" class="emp-action-btn">Email</a>':'')+'</div></div></div>';}).join('');}
function populateTaskAssignees(){var sel=document.getElementById('taskAssignee');sel.innerHTML='<option value="">-- Unassigned --</option>';allEmployeesData.forEach(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||'Unknown';sel.innerHTML+='<option value="'+emp.employee_id+'">'+name+'</option>';});}

function openNewTaskModal(){document.getElementById('taskTitle').value='';document.getElementById('taskDescription').value='';document.getElementById('taskAssignee').value='';document.getElementById('taskPriority').value='normal';document.getElementById('taskDueDate').value=new Date(Date.now()+86400000).toISOString().split('T')[0];document.getElementById('newTaskModal').classList.add('active');}
function closeNewTaskModal(){document.getElementById('newTaskModal').classList.remove('active');}
async function saveNewTask(){var title=document.getElementById('taskTitle').value.trim();if(!title){alert('Enter a task title');return;}var assigneeId=document.getElementById('taskAssignee').value||null;var assigneeName=null;if(assigneeId){var emp=allEmployeesData.find(function(e){return e.employee_id===assigneeId;});if(emp)assigneeName=((emp.first_name||'')+' '+(emp.last_name||'')).trim();}var desc=document.getElementById('taskDescription').value.trim()||'';if(assigneeName){desc=(desc?desc+'\n':'')+'[Assigned to: '+assigneeName+']';}var r=await sb.from('tasks').insert({tenant_id:currentTenantId,title:title,description:desc||null,priority:document.getElementById('taskPriority').value,status:'pending',due_at:document.getElementById('taskDueDate').value?new Date(document.getElementById('taskDueDate').value).toISOString():null,created_by:currentUserId});if(r.error){alert('Error: '+r.error.message);return;}await incrementStat('tasks_created');closeNewTaskModal();loadTasksData();}

async function incrementStat(statName,amount){
  if(!currentUserId||!currentTenantId)return;
  amount=amount||1;
  // Get or create user_stats record
  var r=await sb.from('user_stats').select('*').eq('user_id',currentUserId).single();
  var stats=r.data;
  if(!stats){
    stats={user_id:currentUserId,tenant_id:currentTenantId};
    stats[statName]=amount;
    await sb.from('user_stats').insert(stats);
  }else{
    var update={};
    update[statName]=(stats[statName]||0)+amount;
    update.updated_at=new Date().toISOString();
    // Handle daily task tracking
    if(statName==='tasks_completed'){
      var today=new Date().toISOString().split('T')[0];
      if(stats.tasks_completed_today_date===today){
        update.tasks_completed_today=(stats.tasks_completed_today||0)+amount;
      }else{
        update.tasks_completed_today=amount;
        update.tasks_completed_today_date=today;
      }
    }
    // Handle login streak
    if(statName==='login'){
      var today=new Date().toISOString().split('T')[0];
      var lastLogin=stats.last_login_date;
      if(lastLogin){
        var yesterday=new Date(Date.now()-86400000).toISOString().split('T')[0];
        if(lastLogin===yesterday){
          update.current_login_streak=(stats.current_login_streak||0)+1;
          if((update.current_login_streak)>(stats.longest_login_streak||0)){
            update.longest_login_streak=update.current_login_streak;
          }
        }else if(lastLogin!==today){
          update.current_login_streak=1;
        }
      }else{
        update.current_login_streak=1;
      }
      update.last_login_date=today;
      // Early bird check (before 7am)
      var hour=new Date().getHours();
      if(hour<7){
        update.early_bird_count=(stats.early_bird_count||0)+1;
      }
      delete update.login;
    }
    await sb.from('user_stats').update(update).eq('user_id',currentUserId);
  }
}

function openNewEventModal(){document.getElementById('eventTitle').value='';document.getElementById('eventOrganization').value='';document.getElementById('eventType').value='';document.getElementById('eventTicketPrice').value='';document.getElementById('eventAttendance').value='';document.getElementById('eventLocation').value='';document.getElementById('eventNotes').value='';document.getElementById('eventDate').value=new Date().toISOString().split('T')[0];document.getElementById('eventTime').value='10:00';document.getElementById('newEventModal').classList.add('active');}
function closeNewEventModal(){document.getElementById('newEventModal').classList.remove('active');}
async function saveNewEvent(){var eventName=document.getElementById('eventTitle').value.trim();var org=document.getElementById('eventOrganization').value.trim();var date=document.getElementById('eventDate').value;var time=document.getElementById('eventTime').value;var eventType=document.getElementById('eventType').value;var ticketPrice=document.getElementById('eventTicketPrice').value;var attendance=document.getElementById('eventAttendance').value;var location=document.getElementById('eventLocation').value.trim();var notes=document.getElementById('eventNotes').value.trim();if(!eventName){alert('Enter event title');return;}if(!date){alert('Select a date');return;}try{var eventData={tenant_id:currentTenantId,event_name:eventName,description:org||null,event_date:date,event_time:time||null,event_type:eventType||null,estimated_cost:ticketPrice?parseFloat(ticketPrice):null,mileage:attendance?parseInt(attendance):null,location:location||null,notes:notes||null,created_at:new Date().toISOString()};var r=await sb.from('events').insert(eventData).select().single();if(r.error)throw r.error;closeNewEventModal();alert('Event created!');}catch(e){alert('Error: '+(e.message||'Failed to create event'));}}

function openNewContactModal(){document.getElementById('contactFirstName').value='';document.getElementById('contactLastName').value='';document.getElementById('contactPhone').value='';document.getElementById('contactEmail').value='';document.getElementById('contactOrganization').value='';document.getElementById('contactClientType').value='';document.getElementById('contactStage').value='1';document.getElementById('contactNotes').value='';document.getElementById('newContactModal').classList.add('active');}
function closeNewContactModal(){document.getElementById('newContactModal').classList.remove('active');}
async function saveNewContact(){var firstName=document.getElementById('contactFirstName').value.trim();var lastName=document.getElementById('contactLastName').value.trim();var phone=document.getElementById('contactPhone').value.trim();var email=document.getElementById('contactEmail').value.trim();var org=document.getElementById('contactOrganization').value.trim();var clientType=document.getElementById('contactClientType').value;var stage=document.getElementById('contactStage').value;var notes=document.getElementById('contactNotes').value.trim();if(!firstName||!lastName){alert('Enter first and last name');return;}if(!phone){alert('Enter phone number');return;}if(!email){alert('Enter email address');return;}try{var contactData={tenant_id:currentTenantId,first_name:firstName,last_name:lastName,full_name:firstName+' '+lastName,phone:phone,email:email,customer_type:clientType||'prospect',funnel_stage:parseInt(stage)||1,created_at:new Date().toISOString()};if(org)contactData.organization_name=org;if(notes)contactData.notes=notes;var r=await sb.from('customers').insert(contactData).select().single();if(r.error)throw r.error;closeNewContactModal();alert('Contact added!');}catch(e){alert('Error: '+(e.message||'Failed to add contact'));}}

function formatTimeAgo(dateStr){var diff=new Date()-new Date(dateStr);var mins=Math.floor(diff/60000);if(mins<60)return mins+'m ago';var hrs=Math.floor(diff/3600000);if(hrs<24)return hrs+'h ago';var days=Math.floor(diff/86400000);return days+'d ago';}

async function checkAuth(){var r=await sb.auth.getSession();var session=r.data.session;if(!session){var token=localStorage.getItem('sb_access_token'),refresh=localStorage.getItem('sb_refresh_token');if(token&&refresh){var sr=await sb.auth.setSession({access_token:token,refresh_token:refresh});session=sr.data?.session;}if(!session){window.location.href='login.html';return null;}}currentUserId=session.user.id;userEmail=session.user.email;return session;}

async function loadBusinessSettings(){var r=await sb.from('business_settings').select('*').limit(1).single();if(r.data){if(!currentTenantId&&r.data.tenant_id)currentTenantId=r.data.tenant_id;}}

function updateEmailDisplay(){if(userEmail){document.getElementById('desktopBusinessName').textContent=userEmail;document.getElementById('mobileBusinessName').textContent=userEmail;}}

/* ========================================
   VOICE ASSISTANT - VAPI Integration
   Matches GlowbotsLive working implementation
   ======================================== */
var vapi = null;
var voiceAssistantOpen = false;

function setAssistantButtonState(active) {
  var desktopBtn = document.getElementById('desktopAssistantBtn');
  var mobileBtn = document.getElementById('mobileAssistantBtn');
  if (desktopBtn) {
    if (active) desktopBtn.classList.add('active');
    else desktopBtn.classList.remove('active');
  }
  if (mobileBtn) {
    if (active) mobileBtn.classList.add('active');
    else mobileBtn.classList.remove('active');
  }
}

function toggleVoiceAssistant() {
  var container = document.getElementById('voiceAssistant');
  var orb = document.getElementById('voiceOrb');
  
  if (!vapi) {
    initVapi();
  }
  
  if (voiceAssistantOpen) {
    // Hang up
    if (vapi) vapi.stop();
    container.classList.remove('active');
    orb.classList.remove('listening');
    setAssistantButtonState(false);
    setVoiceStatus('Tap to speak');
    voiceAssistantOpen = false;
  } else {
    // Show orb and connect
    container.classList.add('active');
    setAssistantButtonState(true);
    voiceAssistantOpen = true;
    setVoiceStatus('Connecting...');
    // Use same assistant ID as GlowbotsLive
    vapi.start("78a7055c-03c4-4d29-8621-b2bf2b7333ad");
  }
}

function setVoiceStatus(text) {
  var el = document.getElementById('voiceStatus');
  if (el) el.textContent = text;
}

function initVapi() {
  if (!window.Vapi) {
    console.error('VAPI SDK not loaded');
    setVoiceStatus('Error: SDK not loaded');
    return;
  }
  
  // Use same API key as GlowbotsLive
  vapi = new window.Vapi("b66ad6e7-ec9d-421c-88b7-157068b27f6d");
  
  vapi.on("call-start", function() {
    document.getElementById('voiceOrb').classList.add('listening');
    setVoiceStatus('Connected');
    setAssistantButtonState(true);
  });
  
  vapi.on("call-end", function() {
    document.getElementById('voiceOrb').classList.remove('listening');
    document.getElementById('voiceAssistant').classList.remove('active');
    setAssistantButtonState(false);
    voiceAssistantOpen = false;
    setVoiceStatus('Call ended');
    setTimeout(function() { setVoiceStatus('Tap to speak'); }, 2000);
  });
  
  vapi.on("error", function(e) {
    console.error('VAPI error:', e);
    setVoiceStatus('Error occurred');
    document.getElementById('voiceOrb').classList.remove('listening');
    setAssistantButtonState(false);
  });
}

// Orb click also toggles
document.addEventListener('DOMContentLoaded', function() {
  var orb = document.getElementById('voiceOrb');
  if (orb) {
    orb.addEventListener('click', function() {
      toggleVoiceAssistant();
    });
  }
});

async function init(){var session=await checkAuth();if(!session)return;var email=session.user?.email;if(email){var r=await sb.from('users').select('*').eq('email',email).single();if(r.data?.tenant_id){currentTenantId=r.data.tenant_id;currentUserId=r.data.user_id;}}if(!currentTenantId){var r=await sb.from('business_settings').select('tenant_id').limit(1).single();if(r.data?.tenant_id)currentTenantId=r.data.tenant_id;}if(!currentTenantId){console.error('No tenant_id');return;}await loadBusinessSettings();updateEmailDisplay();await loadUserThemeBank();await loadEmployeesData();await Promise.all([loadInboxData(),loadTasksData(),loadSwagData()]);if(currentUserId)await incrementStat('login');}

init();
</script>
</body>
</html>
