<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="slate"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #6366f1; --accent-light: #818cf8; }
    [data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="ocean"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="light-blue"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #2563eb; --accent-light: #3b82f6; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    
    .theme-toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 1000; display: none; }
    .theme-toast.show { display: block; }
    
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); border-radius: 8px; cursor: pointer; }

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.action-btn { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 50%, transparent); color: var(--accent-light); font-size: 14px; }
    
    .content { flex: 1; padding: 20px; }
    
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .section-header:hover { background: var(--bg-hover); }
    .section-header-title { font-size: 18px; font-weight: 700; color: var(--accent-light); display: flex; align-items: center; gap: 8px; }
    .section-header-icon { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s; }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    .section-content { overflow: hidden; transition: max-height 0.3s ease; margin-bottom: 8px; }
    .section-content.collapsed { max-height: 0 !important; margin-bottom: 0; }
    
    .badge-count { background: var(--bg-hover); color: var(--text-primary); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; border: 1px solid var(--border-default); }
    
    .inbox-container, .tasks-container, .swag-container, .employees-container { background: var(--bg-secondary); border-radius: 8px; overflow: hidden; }
    .inbox-tabs, .tasks-tabs { display: flex; gap: 4px; padding: 12px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); overflow-x: auto; }
    .inbox-tab, .tasks-tab { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; white-space: nowrap; }
    .inbox-tab:hover, .tasks-tab:hover { background: var(--bg-hover); }
    .inbox-tab.active, .tasks-tab.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    .inbox-list, .tasks-list, .swag-list { max-height: 400px; overflow-y: auto; }
    .inbox-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); cursor: pointer; }
    .inbox-item:hover { background: var(--bg-hover); }
    .inbox-item.unread { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent-primary); }
    .inbox-item-content { flex: 1; min-width: 0; }
    .inbox-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .inbox-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-item-time { font-size: 11px; color: var(--text-secondary); }
    .inbox-item-body { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-empty, .tasks-empty, .swag-empty, .employees-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .inbox-actions, .tasks-actions, .swag-actions { display: flex; gap: 8px; padding: 12px; background: var(--bg-card); border-top: 1px solid var(--border-default); }
    .inbox-action-btn, .tasks-action-btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; }
    .inbox-action-btn:hover, .tasks-action-btn:hover { background: var(--bg-hover); }
    .tasks-action-btn.primary { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    
    .task-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); align-items: flex-start; }
    .task-checkbox { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--border-default); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .task-checkbox:hover { border-color: var(--accent-primary); background: rgba(59, 130, 246, 0.1); }
    .task-checkbox.completed { background: #10b981; border-color: #10b981; color: #fff; }
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px; }
    .task-item.completed .task-title { text-decoration: line-through; color: var(--text-secondary); }
    .task-meta { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .task-priority { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-default); }
    .task-assignee { font-size: 11px; color: var(--text-secondary); }
    
    .swag-header, .employees-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); }
    .swag-summary, .employees-summary { display: flex; gap: 16px; flex-wrap: wrap; }
    .swag-stat { display: flex; flex-direction: column; gap: 2px; }
    .swag-stat-value { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    .swag-stat-label { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); }
    .swag-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); align-items: center; }
    .swag-item:hover { background: var(--bg-hover); }
    .swag-item-info { flex: 1; min-width: 0; }
    .swag-item-name { font-weight: 600; font-size: 14px; color: var(--text-primary); }
    .swag-item-category { font-size: 12px; color: var(--text-secondary); }
    .swag-item-qty { display: flex; flex-direction: column; align-items: flex-end; }
    .swag-qty-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .swag-qty-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    .swag-item.low-stock { border-left: 3px solid #f59e0b; }
    .swag-item.out-of-stock { border-left: 3px solid #ef4444; }
    
    .emp-stat { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); }
    .employees-list { max-height: 600px; overflow-y: auto; }
    .emp-strip { border-bottom: 1px solid var(--border-default); }
    .emp-strip-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; }
    .emp-strip-header:hover { background: var(--bg-hover); }
    .emp-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: var(--accent-light); }
    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .emp-contact { font-size: 12px; color: var(--text-secondary); display: flex; gap: 12px; flex-wrap: wrap; margin-top: 4px; }
    .emp-contact a { color: var(--accent-light); text-decoration: none; }
    .emp-contact a:hover { text-decoration: underline; }
    .emp-actions { display: flex; gap: 8px; }
    .emp-action-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; cursor: pointer; text-decoration: none; }
    .emp-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: flex-end; justify-content: center; padding: 0; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 0; line-height: 1; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
    .modal-close:active { background: var(--bg-hover); }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-label .required { color: #ef4444; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 16px; -webkit-appearance: none; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { padding: 16px 20px 24px; border-top: 1px solid var(--border-default); }
    .modal-footer-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-secondary { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-secondary:active { background: var(--bg-hover); }
    .btn-primary { padding: 14px 12px; border-radius: 12px; border: none; background: var(--accent-primary); color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary:active { opacity: 0.9; transform: scale(0.98); }
    
    .message-detail { padding: 16px; }
    .message-detail-header { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-default); }
    .message-detail-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .message-detail-meta { font-size: 12px; color: var(--text-secondary); }
    .message-detail-body { font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
    .message-reply-form { background: var(--bg-card); border-radius: 8px; padding: 12px; }
    .message-reply-input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; min-height: 80px; resize: vertical; margin-bottom: 12px; }
    .message-reply-btn { padding: 10px 20px; border-radius: 6px; border: none; background: var(--accent-primary); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      body { padding-bottom: 120px; }
      .content { padding: 12px; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .modal-overlay { align-items: center; padding: 20px; }
      .modal-content { border-radius: 12px; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">☰</button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Dashboard</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='sharklaw-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
      <button onclick="location.href='account.html'">Account</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:32px; font-weight:600;">Dashboard</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <div style="display:flex; align-items:center; gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px;">
      <a href="dashboard-sharklaw.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Contacts</a>
      <a href="sharklaw-swag.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Swag</a>
    </nav>
  </div>
</div>

<div class="main">
  <div class="content">
    
    <!-- Messages Section -->
    <div class="section-header collapsed" onclick="toggleSection('messages')">
      <div class="section-header-title">
        Messages
        <span class="badge-count" id="messagesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="messagesContent">
      <div class="inbox-container">
        <div class="inbox-tabs">
          <button class="inbox-tab active" onclick="switchInboxTab('all', this)">All</button>
          <button class="inbox-tab" onclick="switchInboxTab('unread', this)">Unread</button>
          <button class="inbox-tab" onclick="switchInboxTab('sent', this)">Sent</button>
        </div>
        <div class="inbox-list" id="inboxList"><div class="inbox-empty"><div>No messages yet</div></div></div>
        <div class="inbox-actions">
          <button class="inbox-action-btn" style="background:var(--accent-primary);border-color:var(--accent-primary);color:#fff;" onclick="openComposeModal()">+ New Message</button>
          <button class="inbox-action-btn" onclick="markAllNotificationsRead()">Mark All Read</button>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="section-header collapsed" onclick="toggleSection('tasks')">
      <div class="section-header-title">
        Tasks
        <span class="badge-count" id="tasksBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="tasksContent">
      <div class="tasks-container">
        <div class="tasks-tabs">
          <button class="tasks-tab active" onclick="switchTasksTab('pending', this)">Pending</button>
          <button class="tasks-tab" onclick="switchTasksTab('in_progress', this)">In Progress</button>
          <button class="tasks-tab" onclick="switchTasksTab('overdue', this)">Overdue</button>
          <button class="tasks-tab" onclick="switchTasksTab('completed', this)">Done</button>
        </div>
        <div class="tasks-list" id="tasksList"><div class="tasks-empty"><div>No tasks</div></div></div>
        <div class="tasks-actions"><button class="tasks-action-btn primary" onclick="openNewTaskModal()">+ New Task</button></div>
      </div>
    </div>

    <!-- Swag Section -->
    <div class="section-header collapsed" onclick="toggleSection('swag')">
      <div class="section-header-title">
        Swag Inventory
        <span class="badge-count" id="swagBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="swagContent">
      <div class="swag-container">
        <div class="swag-header">
          <div class="swag-summary">
            <div class="swag-stat"><span class="swag-stat-value" id="swagTotalItems">0</span><span class="swag-stat-label">Total Items</span></div>
            <div class="swag-stat"><span class="swag-stat-value" id="swagLowStock">0</span><span class="swag-stat-label">Low Stock</span></div>
          </div>
        </div>
        <div class="swag-list" id="swagList"><div class="swag-empty"><div>No swag items yet</div></div></div>
        <div class="swag-actions"><button class="tasks-action-btn primary" onclick="location.href='sharklaw-swag.html'">Manage Swag</button></div>
      </div>
    </div>

    <!-- Team Section -->
    <div class="section-header collapsed" onclick="toggleSection('employees')">
      <div class="section-header-title">
        Team
        <span class="badge-count" id="employeesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="employeesContent">
      <div class="employees-container">
        <div class="employees-header">
          <div class="employees-summary">
            <span class="emp-stat"><span id="totalEmployeesCount">0</span> Team Members</span>
          </div>
        </div>
        <div class="employees-list" id="employeesList"><div class="employees-empty"><div>Loading team...</div></div></div>
      </div>
    </div>

  </div>
</div>

<!-- New Task Modal -->
<div class="modal-overlay" id="newTaskModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Task</div><button class="modal-close" onclick="closeNewTaskModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Task Title <span class="required">*</span></label><input type="text" class="form-input" id="taskTitle" placeholder="Enter task title"></div>
      <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea></div>
      <div class="form-group"><label class="form-label">Assign To</label><select class="form-select" id="taskAssignee"><option value="">-- Unassigned --</option></select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="taskPriority"><option value="low">Low</option><option value="normal" selected>Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div>
        <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="taskDueDate"></div>
      </div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="saveNewTask()">Create Task</button><button class="btn-secondary" onclick="closeNewTaskModal()">Cancel</button></div></div>
  </div>
</div>

<!-- New Event Modal -->
<div class="modal-overlay" id="newEventModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Event</div><button class="modal-close" onclick="closeNewEventModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Event Title <span class="required">*</span></label><input type="text" class="form-input" id="eventTitle" placeholder="Event name"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="eventOrganization" placeholder="Hosting organization"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date <span class="required">*</span></label><input type="date" class="form-input" id="eventDate"></div>
        <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="eventTime" value="10:00"></div>
      </div>
      <div class="form-group"><label class="form-label">Event Type</label><select class="form-select" id="eventType"><option value="">-- Select --</option><option value="Open House">Open House</option><option value="Bike Night">Bike Night</option><option value="Run">Run</option><option value="Party">Party</option><option value="Fundraiser">Fundraiser</option><option value="Support">Support</option></select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ticket Price</label><input type="number" class="form-input" id="eventTicketPrice" placeholder="0.00" step="0.01" min="0"></div>
        <div class="form-group"><label class="form-label">Expected Attendance</label><input type="number" class="form-input" id="eventAttendance" placeholder="0" min="0"></div>
      </div>
      <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="eventLocation" placeholder="Event location"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="eventNotes" placeholder="Event details..."></textarea></div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="saveNewEvent()">Create Event</button><button class="btn-secondary" onclick="closeNewEventModal()">Cancel</button></div></div>
  </div>
</div>

<!-- New Contact Modal -->
<div class="modal-overlay" id="newContactModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Contact</div><button class="modal-close" onclick="closeNewContactModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="contactFirstName" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name <span class="required">*</span></label><input type="text" class="form-input" id="contactLastName" placeholder="Last name"></div>
      </div>
      <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="contactPhone" placeholder="(555) 123-4567"></div>
      <div class="form-group"><label class="form-label">Email <span class="required">*</span></label><input type="text" class="form-input" id="contactEmail" placeholder="email@example.com"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="contactOrganization" placeholder="Organization name"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Client Type</label><select class="form-select" id="contactClientType"><option value="">-- Select --</option><option value="RC">RC</option><option value="HOG">HOG</option><option value="Independent">Independent</option><option value="Other">Other</option></select></div>
        <div class="form-group"><label class="form-label">Funnel Stage</label><select class="form-select" id="contactStage"><option value="1">1st Contact</option><option value="2">Receive Artwork</option><option value="3">Opt-in Contact</option><option value="4">Deliver Pop Up</option><option value="5">Lead</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="contactNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="saveNewContact()">Add Contact</button><button class="btn-secondary" onclick="closeNewContactModal()">Cancel</button></div></div>
  </div>
</div>

<!-- Message Detail Modal -->
<div class="modal-overlay" id="messageDetailModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">Message</div><button class="modal-close" onclick="closeMessageDetailModal()">&times;</button></div>
    <div class="modal-body" id="messageDetailBody"></div>
  </div>
</div>

<!-- Compose Message Modal -->
<div class="modal-overlay" id="composeModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Message</div><button class="modal-close" onclick="closeComposeModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">To</label><select class="form-select" id="composeTo"><option value="">-- Select Recipient --</option></select></div>
      <div class="form-group"><label class="form-label">Subject <span class="required">*</span></label><input type="text" class="form-input" id="composeSubject" placeholder="Message subject"></div>
      <div class="form-group"><label class="form-label">Message <span class="required">*</span></label><textarea class="form-textarea" id="composeBody" placeholder="Type your message..." style="min-height:120px;"></textarea></div>
    </div>
    <div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="sendNewMessage()">Send Message</button><button class="btn-secondary" onclick="closeComposeModal()">Cancel</button></div></div>
  </div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn active">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a>
  </div>
  <div class="mobile-nav-row three-col">
    <button class="mobile-nav-btn action-btn" onclick="openNewEventModal()">+ Event</button>
    <button class="mobile-nav-btn action-btn" onclick="openNewContactModal()">+ Contact</button>
    <a href="sharklaw-contacts.html" class="mobile-nav-btn">Contacts</a>
  </div>
</div>

<script>
const SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let currentUserId=null,currentTenantId=null,userEmail=null;
let currentInboxTab='all',currentTasksTab='pending';
let allNotifications=[],allTasks=[],allEmployeesData=[],allSwagItems=[];

var themes=['dark-blue','slate','midnight','ocean','light-blue'];
var themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=themes.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){themeIndex=(themeIndex+1)%themes.length;var t=themes[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast('Theme: '+t);}
function showThemeToast(msg){var toast=document.getElementById('themeToast');if(!toast){toast=document.createElement('div');toast.id='themeToast';toast.className='theme-toast';document.body.appendChild(toast);}toast.textContent=msg;toast.classList.add('show');setTimeout(function(){toast.classList.remove('show');},2000);}
loadTheme();

function toggleMobileMenu(btn){document.getElementById('mobileHeaderContent').classList.toggle('expanded');}
async function logout(){await sb.auth.signOut();localStorage.clear();location.replace("login.html");}

function toggleSection(sectionId){var content=document.getElementById(sectionId+'Content');var header=event.currentTarget;content.classList.toggle('collapsed');header.classList.toggle('collapsed');content.style.maxHeight=content.classList.contains('collapsed')?'0px':content.scrollHeight+'px';}

async function loadInboxData(){if(!currentTenantId)return;var r=await sb.from('notifications').select('*').eq('tenant_id',currentTenantId).order('created_at',{ascending:false}).limit(50);allNotifications=r.data||[];renderInbox();updateInboxBadge();}
function renderInbox(){var container=document.getElementById('inboxList');var filtered=allNotifications;if(currentInboxTab==='unread')filtered=allNotifications.filter(function(n){return!n.is_read;});else if(currentInboxTab==='sent')filtered=allNotifications.filter(function(n){return n.title&&n.title.indexOf('Sent:')==0;});if(filtered.length===0){container.innerHTML='<div class="inbox-empty"><div>No messages</div></div>';return;}container.innerHTML=filtered.map(function(item){return'<div class="inbox-item '+(item.is_read?'':'unread')+'" onclick="openMessageDetail(\''+item.notification_id+'\')"><div class="inbox-item-content"><div class="inbox-item-header"><div class="inbox-item-title">'+(item.title||'Notification')+'</div><div class="inbox-item-time">'+formatTimeAgo(item.created_at)+'</div></div><div class="inbox-item-body">'+(item.body||'')+'</div></div></div>';}).join('');}
function switchInboxTab(tab,btn){currentInboxTab=tab;document.querySelectorAll('.inbox-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');renderInbox();}
async function openMessageDetail(id){var msg=allNotifications.find(function(n){return n.notification_id===id;});if(!msg)return;await sb.from('notifications').update({is_read:true}).eq('notification_id',id);msg.is_read=true;renderInbox();updateInboxBadge();var quickReplies='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;"><button class="inbox-action-btn" onclick="quickReply(\'Got it, thanks!\')">Got it!</button><button class="inbox-action-btn" onclick="quickReply(\'On my way\')">On my way</button><button class="inbox-action-btn" onclick="quickReply(\'Will do\')">Will do</button><button class="inbox-action-btn" onclick="quickReply(\'Call me\')">Call me</button></div>';document.getElementById('messageDetailBody').innerHTML='<div class="message-detail"><div class="message-detail-header"><div class="message-detail-title">'+(msg.title||'Notification')+'</div><div class="message-detail-meta">'+new Date(msg.created_at).toLocaleString()+'</div></div><div class="message-detail-body" style="white-space:pre-wrap;">'+(msg.body||'No content')+'</div><div class="message-reply-form"><div style="font-weight:600;margin-bottom:8px;">Quick Reply:</div>'+quickReplies+'<textarea class="message-reply-input" id="messageReplyText" placeholder="Or type a custom reply..."></textarea><div style="display:flex;gap:8px;"><button class="message-reply-btn" onclick="sendCustomReply(\''+id+'\')">Send Reply</button><button class="inbox-action-btn danger" style="border-color:#ef4444;color:#ef4444;" onclick="deleteMessage(\''+id+'\')">Delete</button></div></div></div>';currentMessageId=id;document.getElementById('messageDetailModal').classList.add('active');}
var currentMessageId=null;
function closeMessageDetailModal(){document.getElementById('messageDetailModal').classList.remove('active');currentMessageId=null;}
async function quickReply(text){if(!currentMessageId)return;try{var r=await sb.from('notifications').insert({tenant_id:currentTenantId,recipient_id:currentUserId,notification_type:'message',title:'Sent: Reply',body:text,is_read:true,created_at:new Date().toISOString()});if(r.error)throw r.error;closeMessageDetailModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to send'));}}
async function sendCustomReply(originalId){var replyText=document.getElementById('messageReplyText').value.trim();if(!replyText){alert('Enter a reply message');return;}try{var r=await sb.from('notifications').insert({tenant_id:currentTenantId,recipient_id:currentUserId,notification_type:'message',title:'Sent: Reply',body:replyText,is_read:true,created_at:new Date().toISOString()});if(r.error)throw r.error;closeMessageDetailModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to send'));}}
async function deleteMessage(id){if(!confirm('Delete this message?'))return;try{var r=await sb.from('notifications').delete().eq('notification_id',id);if(r.error)throw r.error;closeMessageDetailModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to delete'));}}
function openComposeModal(){document.getElementById('composeSubject').value='';document.getElementById('composeBody').value='';populateRecipients();document.getElementById('composeModal').classList.add('active');}
function closeComposeModal(){document.getElementById('composeModal').classList.remove('active');}
function populateRecipients(){var sel=document.getElementById('composeTo');sel.innerHTML='<option value="">-- Select Recipient --</option><option value="all">All Team Members</option>';allEmployeesData.forEach(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||'Unknown';sel.innerHTML+='<option value="'+emp.employee_id+'">'+name+'</option>';});}
async function sendNewMessage(){var subject=document.getElementById('composeSubject').value.trim();var body=document.getElementById('composeBody').value.trim();if(!subject){alert('Enter a subject');return;}if(!body){alert('Enter a message');return;}try{var r=await sb.from('notifications').insert({tenant_id:currentTenantId,recipient_id:currentUserId,notification_type:'message',title:'Sent: '+subject,body:body,is_read:true,created_at:new Date().toISOString()});if(r.error)throw r.error;closeComposeModal();loadInboxData();}catch(e){alert('Error: '+(e.message||'Failed to send'));}}
async function markAllNotificationsRead(){await sb.from('notifications').update({is_read:true}).eq('tenant_id',currentTenantId).eq('is_read',false);loadInboxData();}
function updateInboxBadge(){var count=allNotifications.filter(function(n){return!n.is_read;}).length;var badge=document.getElementById('messagesBadge');badge.textContent=count;badge.style.display=count>0?'inline-block':'none';}

async function loadTasksData(){if(!currentTenantId)return;var r=await sb.from('tasks').select('*').eq('tenant_id',currentTenantId).order('due_at',{ascending:true});allTasks=r.data||[];renderTasks();updateTasksBadge();}
function getAssigneeFromDesc(desc){if(!desc)return'';var match=desc.match(/\[Assigned to: ([^\]]+)\]/);return match?match[1]:'';}
function renderTasks(){var container=document.getElementById('tasksList');var now=new Date();var filtered=allTasks;if(currentTasksTab==='pending')filtered=allTasks.filter(function(t){return t.status==='pending'||t.status==='todo';});else if(currentTasksTab==='in_progress')filtered=allTasks.filter(function(t){return t.status==='in_progress';});else if(currentTasksTab==='overdue')filtered=allTasks.filter(function(t){return t.status!=='completed'&&t.due_at&&new Date(t.due_at)<now;});else if(currentTasksTab==='completed')filtered=allTasks.filter(function(t){return t.status==='completed';});if(filtered.length===0){container.innerHTML='<div class="tasks-empty"><div>No tasks</div></div>';return;}container.innerHTML=filtered.map(function(task){var isCompleted=task.status==='completed';var assigneeName=getAssigneeFromDesc(task.description);return'<div class="task-item '+(isCompleted?'completed':'')+'"><div class="task-checkbox '+(isCompleted?'completed':'')+'" onclick="toggleTaskComplete(\''+task.task_id+'\','+!isCompleted+')">'+(isCompleted?'✓':'')+'</div><div class="task-content"><div class="task-title">'+task.title+'</div><div class="task-meta"><span class="task-priority">'+(task.priority||'normal')+'</span>'+(assigneeName?'<span class="task-assignee">Assigned: '+assigneeName+'</span>':'')+'</div></div></div>';}).join('');}
function switchTasksTab(tab,btn){currentTasksTab=tab;document.querySelectorAll('.tasks-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');renderTasks();}
async function toggleTaskComplete(taskId,completed){await sb.from('tasks').update({status:completed?'completed':'pending'}).eq('task_id',taskId);loadTasksData();}
function updateTasksBadge(){var count=allTasks.filter(function(t){return t.status!=='completed';}).length;var badge=document.getElementById('tasksBadge');badge.textContent=count;badge.style.display=count>0?'inline-block':'none';}

async function loadSwagData(){if(!currentTenantId)return;var r=await sb.from('parts_inventory').select('*').eq('tenant_id',currentTenantId).order('part_name',{ascending:true});allSwagItems=r.data||[];renderSwag();updateSwagBadge();}
function renderSwag(){var container=document.getElementById('swagList');var totalItems=allSwagItems.reduce(function(sum,item){return sum+(item.quantity_on_hand||0);},0);var lowStockCount=allSwagItems.filter(function(item){return(item.quantity_on_hand||0)<=5;}).length;document.getElementById('swagTotalItems').textContent=totalItems;document.getElementById('swagLowStock').textContent=lowStockCount;if(allSwagItems.length===0){container.innerHTML='<div class="swag-empty"><div>No swag items yet</div></div>';return;}container.innerHTML=allSwagItems.map(function(item){var qty=item.quantity_on_hand||0;var isLow=qty>0&&qty<=5;var isOut=qty===0;return'<div class="swag-item '+(isOut?'out-of-stock':(isLow?'low-stock':''))+'"><div class="swag-item-info"><div class="swag-item-name">'+(item.part_name||'Unknown')+'</div><div class="swag-item-category">'+(item.description||'--')+'</div></div><div class="swag-item-qty"><span class="swag-qty-value">'+qty+'</span><span class="swag-qty-label">'+(isOut?'Out':(isLow?'Low':'In Stock'))+'</span></div></div>';}).join('');}
function updateSwagBadge(){var count=allSwagItems.filter(function(item){return(item.quantity_on_hand||0)<=5;}).length;var badge=document.getElementById('swagBadge');badge.textContent=count;badge.style.display=count>0?'inline-block':'none';}

async function loadEmployeesData(){if(!currentTenantId)return;var r=await sb.from('employees').select('*').eq('tenant_id',currentTenantId).order('last_name',{ascending:true});allEmployeesData=r.data||[];document.getElementById('totalEmployeesCount').textContent=allEmployeesData.length;renderEmployees();populateTaskAssignees();}
function renderEmployees(){var container=document.getElementById('employeesList');if(allEmployeesData.length===0){container.innerHTML='<div class="employees-empty"><div>No team members found</div></div>';return;}container.innerHTML=allEmployeesData.map(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||'Unknown';var initials=((emp.first_name||'U')[0]+((emp.last_name||'')[0]||'')).toUpperCase();return'<div class="emp-strip"><div class="emp-strip-header"><div class="emp-avatar">'+initials+'</div><div class="emp-info"><div class="emp-name">'+name+'</div><div class="emp-contact">'+(emp.phone?'<a href="tel:'+emp.phone+'">'+emp.phone+'</a>':'')+(emp.email?'<a href="mailto:'+emp.email+'">'+emp.email+'</a>':'')+'</div></div><div class="emp-actions">'+(emp.phone?'<a href="tel:'+emp.phone+'" class="emp-action-btn">Call</a>':'')+(emp.email?'<a href="mailto:'+emp.email+'" class="emp-action-btn">Email</a>':'')+'</div></div></div>';}).join('');}
function populateTaskAssignees(){var sel=document.getElementById('taskAssignee');sel.innerHTML='<option value="">-- Unassigned --</option>';allEmployeesData.forEach(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||'Unknown';sel.innerHTML+='<option value="'+emp.employee_id+'">'+name+'</option>';});}

function openNewTaskModal(){document.getElementById('taskTitle').value='';document.getElementById('taskDescription').value='';document.getElementById('taskAssignee').value='';document.getElementById('taskPriority').value='normal';document.getElementById('taskDueDate').value=new Date(Date.now()+86400000).toISOString().split('T')[0];document.getElementById('newTaskModal').classList.add('active');}
function closeNewTaskModal(){document.getElementById('newTaskModal').classList.remove('active');}
async function saveNewTask(){var title=document.getElementById('taskTitle').value.trim();if(!title){alert('Enter a task title');return;}var assigneeId=document.getElementById('taskAssignee').value||null;var assigneeName=null;if(assigneeId){var emp=allEmployeesData.find(function(e){return e.employee_id===assigneeId;});if(emp)assigneeName=((emp.first_name||'')+' '+(emp.last_name||'')).trim();}var desc=document.getElementById('taskDescription').value.trim()||'';if(assigneeName){desc=(desc?desc+'\n':'')+'[Assigned to: '+assigneeName+']';}var r=await sb.from('tasks').insert({tenant_id:currentTenantId,title:title,description:desc||null,priority:document.getElementById('taskPriority').value,status:'pending',due_at:document.getElementById('taskDueDate').value?new Date(document.getElementById('taskDueDate').value).toISOString():null,created_by:currentUserId});if(r.error){alert('Error: '+r.error.message);return;}closeNewTaskModal();loadTasksData();}

function openNewEventModal(){document.getElementById('eventTitle').value='';document.getElementById('eventOrganization').value='';document.getElementById('eventType').value='';document.getElementById('eventTicketPrice').value='';document.getElementById('eventAttendance').value='';document.getElementById('eventLocation').value='';document.getElementById('eventNotes').value='';document.getElementById('eventDate').value=new Date().toISOString().split('T')[0];document.getElementById('eventTime').value='10:00';document.getElementById('newEventModal').classList.add('active');}
function closeNewEventModal(){document.getElementById('newEventModal').classList.remove('active');}
async function saveNewEvent(){var eventName=document.getElementById('eventTitle').value.trim();var org=document.getElementById('eventOrganization').value.trim();var date=document.getElementById('eventDate').value;var time=document.getElementById('eventTime').value;var eventType=document.getElementById('eventType').value;var ticketPrice=document.getElementById('eventTicketPrice').value;var attendance=document.getElementById('eventAttendance').value;var location=document.getElementById('eventLocation').value.trim();var notes=document.getElementById('eventNotes').value.trim();if(!eventName){alert('Enter event title');return;}if(!date){alert('Select a date');return;}try{var eventData={tenant_id:currentTenantId,event_name:eventName,description:org||null,event_date:date,event_time:time||null,event_type:eventType||null,estimated_cost:ticketPrice?parseFloat(ticketPrice):null,mileage:attendance?parseInt(attendance):null,location:location||null,notes:notes||null,created_at:new Date().toISOString()};var r=await sb.from('events').insert(eventData).select().single();if(r.error)throw r.error;closeNewEventModal();alert('Event created!');}catch(e){alert('Error: '+(e.message||'Failed to create event'));}}

function openNewContactModal(){document.getElementById('contactFirstName').value='';document.getElementById('contactLastName').value='';document.getElementById('contactPhone').value='';document.getElementById('contactEmail').value='';document.getElementById('contactOrganization').value='';document.getElementById('contactClientType').value='';document.getElementById('contactStage').value='1';document.getElementById('contactNotes').value='';document.getElementById('newContactModal').classList.add('active');}
function closeNewContactModal(){document.getElementById('newContactModal').classList.remove('active');}
async function saveNewContact(){var firstName=document.getElementById('contactFirstName').value.trim();var lastName=document.getElementById('contactLastName').value.trim();var phone=document.getElementById('contactPhone').value.trim();var email=document.getElementById('contactEmail').value.trim();var org=document.getElementById('contactOrganization').value.trim();var clientType=document.getElementById('contactClientType').value;var stage=document.getElementById('contactStage').value;var notes=document.getElementById('contactNotes').value.trim();if(!firstName||!lastName){alert('Enter first and last name');return;}if(!phone){alert('Enter phone number');return;}if(!email){alert('Enter email address');return;}try{var contactData={tenant_id:currentTenantId,first_name:firstName,last_name:lastName,full_name:firstName+' '+lastName,phone:phone,email:email,customer_type:clientType||'prospect',funnel_stage:parseInt(stage)||1,created_at:new Date().toISOString()};if(org)contactData.organization_name=org;if(notes)contactData.notes=notes;var r=await sb.from('customers').insert(contactData).select().single();if(r.error)throw r.error;closeNewContactModal();alert('Contact added!');}catch(e){alert('Error: '+(e.message||'Failed to add contact'));}}

function formatTimeAgo(dateStr){var diff=new Date()-new Date(dateStr);var mins=Math.floor(diff/60000);if(mins<60)return mins+'m ago';var hrs=Math.floor(diff/3600000);if(hrs<24)return hrs+'h ago';var days=Math.floor(diff/86400000);return days+'d ago';}

async function checkAuth(){var r=await sb.auth.getSession();var session=r.data.session;if(!session){var token=localStorage.getItem('sb_access_token'),refresh=localStorage.getItem('sb_refresh_token');if(token&&refresh){var sr=await sb.auth.setSession({access_token:token,refresh_token:refresh});session=sr.data?.session;}if(!session){window.location.href='login.html';return null;}}currentUserId=session.user.id;userEmail=session.user.email;return session;}

async function loadBusinessSettings(){var r=await sb.from('business_settings').select('*').limit(1).single();if(r.data){if(!currentTenantId&&r.data.tenant_id)currentTenantId=r.data.tenant_id;}}

function updateEmailDisplay(){if(userEmail){document.getElementById('desktopBusinessName').textContent=userEmail;document.getElementById('mobileBusinessName').textContent=userEmail;}}

async function init(){var session=await checkAuth();if(!session)return;var email=session.user?.email;if(email){var r=await sb.from('users').select('*').eq('email',email).single();if(r.data?.tenant_id){currentTenantId=r.data.tenant_id;currentUserId=r.data.user_id;}}if(!currentTenantId){var r=await sb.from('business_settings').select('tenant_id').limit(1).single();if(r.data?.tenant_id)currentTenantId=r.data.tenant_id;}if(!currentTenantId){console.error('No tenant_id');return;}await loadBusinessSettings();updateEmailDisplay();await loadEmployeesData();await Promise.all([loadInboxData(),loadTasksData(),loadSwagData()]);}

init();
</script>
</body>
</html>
