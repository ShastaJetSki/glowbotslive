<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard</title>
  <script>
    (function() {
      var theme = localStorage.getItem('app-theme') || 'dark-blue';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://api.vapi.ai">
  <link rel="dns-prefetch" href="https://api.vapi.ai">
  <link rel="stylesheet" href="themes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/gh/balacodeio/Vapi-Web-UMD@latest/dist/latest/vapi-web-bundle.min.js"></script>
  <style>
    :root { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="blue-light"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }
    [data-theme="slate-dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="slate-light"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; }
    [data-theme="ocean-dark"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="ocean-light"] { --bg-primary: #f0fdfa; --bg-secondary: #e0f7f4; --bg-card: #ffffff; --bg-hover: #ccfbf1; --border-default: #99f6e4; --text-primary: #134e4a; --text-secondary: #2d6a66; --accent-primary: #0d9488; --accent-light: #14b8a6; }
    [data-theme="midnight-dark"],[data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="lavender-light"],[data-theme="lavender"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; }
    [data-theme="forest-dark"],[data-theme="forest"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="mint-light"],[data-theme="mint"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="crimson-dark"],[data-theme="crimson"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; }
    [data-theme="coral-light"],[data-theme="coral"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; }
    [data-theme="amber-dark"],[data-theme="amber"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; }
    [data-theme="honey-light"],[data-theme="honey"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; }
    [data-theme="rose-dark"],[data-theme="rose"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; }
    [data-theme="sky-light"],[data-theme="sky"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="cyber-dark"],[data-theme="cyber"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; }
    [data-theme="sand-light"],[data-theme="sand"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; }
    [data-theme="slate"],[data-theme="ocean"],[data-theme="light-blue"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    .theme-toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 1000; display: none; }
    .theme-toast.show { display: block; }
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); border-radius: 8px; cursor: pointer; }
    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .content { flex: 1; padding: 20px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .section-header:hover { background: var(--bg-hover); }
    .section-header-title { font-size: 18px; font-weight: 700; color: var(--accent-light); display: flex; align-items: center; gap: 8px; }
    .section-header-icon { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s; }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    .section-content { overflow: hidden; transition: max-height 0.3s ease; margin-bottom: 8px; }
    .section-content.collapsed { max-height: 0 !important; margin-bottom: 0; }
    .badge-count { background: var(--bg-hover); color: var(--text-primary); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; border: 1px solid var(--border-default); }
    .inbox-container, .tasks-container, .swag-container, .employees-container { background: var(--bg-secondary); border-radius: 8px; overflow: hidden; }
    .inbox-tabs, .tasks-tabs { display: flex; gap: 4px; padding: 12px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); overflow-x: auto; }
    .inbox-tab, .tasks-tab { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; white-space: nowrap; }
    .inbox-tab:hover, .tasks-tab:hover { background: var(--bg-hover); }
    .inbox-tab.active, .tasks-tab.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    .tasks-tab.overdue-alert { background: rgba(153, 27, 27, 0.6); border-color: #991b1b; color: #fff; }
    .form-label .required { color: #991b1b; margin-left: 2px; }
    .priority-urgent { background: rgba(153, 27, 27, 0.25); color: #fca5a5; border-color: #991b1b; }
    .priority-high { background: rgba(180, 83, 9, 0.25); color: #fcd34d; border-color: #b45309; }
    .inbox-list, .tasks-list, .swag-list { max-height: 400px; overflow-y: auto; }
    .inbox-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); cursor: pointer; }
    .inbox-item:hover { background: var(--bg-hover); }
    .inbox-item.unread { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent-primary); }
    .inbox-item-content { flex: 1; min-width: 0; }
    .inbox-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .inbox-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-item-time { font-size: 11px; color: var(--text-secondary); }
    .inbox-item-body { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-empty, .tasks-empty, .swag-empty, .employees-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .inbox-actions, .tasks-actions, .swag-actions { display: flex; gap: 8px; padding: 12px; background: var(--bg-card); border-top: 1px solid var(--border-default); }
    .inbox-action-btn, .tasks-action-btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; }
    .inbox-action-btn:hover, .tasks-action-btn:hover { background: var(--bg-hover); }
    .tasks-action-btn.primary { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    .task-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); align-items: flex-start; }
    .task-checkbox { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--border-default); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s ease; position: relative; }
    .task-checkbox:hover { transform: scale(1.1); }
    .task-checkbox:active { transform: scale(0.95); }
    .task-checkbox.completed { background: #10b981; border-color: #10b981; color: #fff; }
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px; }
    .task-item.completed .task-title { text-decoration: line-through; color: var(--text-secondary); }
    .task-meta { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .task-priority { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border-default); }
    .task-assignee { font-size: 11px; color: var(--text-secondary); }
    .swag-header, .employees-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); }
    .swag-summary { display: flex; gap: 16px; flex-wrap: wrap; }
    .swag-stat { display: flex; flex-direction: column; gap: 2px; }
    .swag-stat-value { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    .swag-stat-label { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); }
    .swag-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); align-items: center; }
    .swag-item:hover { background: var(--bg-hover); }
    .swag-item-info { flex: 1; min-width: 0; }
    .swag-item-name { font-weight: 600; font-size: 14px; color: var(--text-primary); }
    .swag-item-category { font-size: 12px; color: var(--text-secondary); }
    .swag-item-qty { display: flex; flex-direction: column; align-items: flex-end; }
    .swag-qty-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .swag-qty-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    .swag-item.low-stock { border-left: 3px solid #b45309; }
    .swag-item.out-of-stock { border-left: 3px solid #991b1b; }
    .employees-list { max-height: 600px; overflow-y: auto; }
    .emp-strip { border-bottom: 1px solid var(--border-default); }
    .emp-strip-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; }
    .emp-strip-header:hover { background: var(--bg-hover); }
    .emp-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: #fff; }
    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .emp-role { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px; }
    .emp-actions { display: flex; gap: 8px; }
    .emp-action-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; cursor: pointer; text-decoration: none; }
    .emp-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: flex-end; justify-content: center; padding: 0; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 0; line-height: 1; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
    .modal-close:active { background: var(--bg-hover); }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 16px; -webkit-appearance: none; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { padding: 16px 20px 24px; border-top: 1px solid var(--border-default); }
    .modal-footer-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .modal-footer-buttons button { flex: 1; min-width: 80px; }
    .btn-secondary { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-primary { padding: 14px 12px; border-radius: 12px; border: none; background: var(--accent-primary); color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .message-detail { padding: 16px; }
    .message-detail-header { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-default); }
    .message-detail-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .message-detail-meta { font-size: 12px; color: var(--text-secondary); }
    .message-detail-body { font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
    .message-reply-form { background: var(--bg-card); border-radius: 8px; padding: 12px; }
    .message-reply-input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; min-height: 80px; resize: vertical; margin-bottom: 12px; }
    .message-reply-btn { padding: 10px 20px; border-radius: 6px; border: none; background: var(--accent-primary); color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; }
    @keyframes checkStrobe { 0% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(1); background: #10b981; border-color: #10b981; } }
    @keyframes cardComplete { 0% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(100%); } }
    @keyframes sparkle { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
    .task-checkbox.animating { animation: checkStrobe 0.6s ease-out forwards; }
    .task-item.completing { animation: cardComplete 0.8s ease-out 0.5s forwards; pointer-events: none; }
    .sparkle { position: fixed; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; animation: sparkle 0.6s ease-out forwards; z-index: 9999; }
    @media (max-width: 768px) { .desktop-header { display: none !important; } .mobile-top-header { display: block; } .mobile-bottom-nav { display: block !important; } body { padding-bottom: 120px; } .content { padding: 12px; } .form-row { grid-template-columns: 1fr; } }
    @media (min-width: 769px) { .mobile-top-header { display: none !important; } .mobile-bottom-nav { display: none !important; } .modal-overlay { align-items: center; padding: 20px; } .modal-content { border-radius: 12px; } }
    .voice-assistant-container { display: none; position: fixed; bottom: 138px; right: 30px; z-index: 500; flex-direction: column; align-items: center; gap: 4px; }
    .voice-assistant-container.active { display: flex; }
    @media (min-width: 769px) { .voice-assistant-container { bottom: 30px; right: 20px; } .voice-orb { width: 40px !important; height: 40px !important; } }
    .voice-agent-name { color: #5af2ff; font-size: 12px; font-weight: 600; text-shadow: 0 0 8px rgba(90, 242, 255, 0.5); text-align: center; }
    .voice-brand-name { color: var(--text-secondary); font-size: 10px; font-weight: 500; text-align: center; opacity: 0.7; }
    .voice-orb { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.6) 0%, transparent 40%), linear-gradient(135deg, #5af2ff 0%, #a855f7 50%, #fbbf24 100%); background-size: 100% 100%, 600% 600%; animation: orbColorShift 9s ease-in-out infinite; box-shadow: 0 4px 20px rgba(90, 242, 255, 0.5), 0 6px 12px rgba(0,0,0,0.4); transition: transform 0.4s ease, opacity 0.4s ease; opacity: 0.81; overflow: hidden; position: relative; }
    @keyframes orbColorShift { 0%,100% { background-position: 0% 0%, 0% 50%; } 33% { background-position: 0% 0%, 50% 50%; } 66% { background-position: 0% 0%, 100% 50%; } }
    .voice-orb:hover { transform: scale(1.1); opacity: 0.9; }
    .voice-orb.listening { opacity: 1; animation: orbColorShift 9s ease-in-out infinite, orbBreathing 1.5s ease-in-out infinite; }
    @keyframes orbBreathing { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }
    .assistant-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid #5af2ff; background: transparent; color: #5af2ff; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; opacity: 0.6; }
    .assistant-btn:hover { opacity: 0.8; }
    .assistant-btn.active { background: rgba(90, 242, 255, 0.2); box-shadow: 0 0 15px rgba(90, 242, 255, 0.4); opacity: 1; }
    .mobile-nav-btn.assistant-btn { border-color: #5af2ff; color: #5af2ff; }
    .mobile-nav-btn.assistant-btn.active { background: rgba(90, 242, 255, 0.3); }
    .orb-swirl { position: absolute; top: 50%; left: 50%; width: 120%; height: 120%; transform: translate(-50%, -50%); border-radius: 50%; background: conic-gradient(from 0deg, transparent 0deg, rgba(255,255,255,0.25) 60deg, transparent 120deg); animation: swirlRotate 6s linear infinite; pointer-events: none; mix-blend-mode: screen; }
    .orb-swirl-2 { width: 90%; height: 90%; animation: swirlRotate 4s linear infinite reverse; }
    .orb-swirl-3 { width: 60%; height: 60%; animation: swirlFloat 3s ease-in-out infinite; }
    @keyframes swirlRotate { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    @keyframes swirlFloat { 0%,100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-45%, -55%) scale(1.1); } }
  </style>
</head>
<body>
<div class="mobile-top-header"><div class="mobile-header-bar"><button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">☰</button><div class="mobile-header-center"><div class="mobile-header-title">Dashboard</div><div class="business-name" id="mobileBusinessName">Loading...</div></div><div class="mobile-header-right"><button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button><a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a></div></div><div class="mobile-header-content" id="mobileHeaderContent"><div class="mobile-header-actions"><button onclick="location.href='sharklaw-settings.html'">Settings</button><button onclick="location.href='support.html'">Support</button><button onclick="location.href='account.html'">Account</button></div></div></div>
<div class="desktop-header"><div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;"><div><h1 style="margin:0;font-size:32px;font-weight:600;">Dashboard</h1><div class="business-name" id="desktopBusinessName">Loading...</div></div><div style="display:flex;align-items:center;gap:16px;"><button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button><a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a></div></div><div style="padding:0 24px 12px;"><nav style="display:flex;gap:24px;align-items:center;"><a href="dashboard-sharklaw.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">Dashboard</a><a href="sharklaw-scheduler.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Scheduler</a><a href="sharklaw-contacts.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Contacts</a><a href="sharklaw-swag.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Swag</a><a href="sharklaw-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a><a href="support.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Support</a><button id="desktopAssistantBtn" onclick="toggleVoiceAssistant()" class="assistant-btn">Assistant</button></nav></div></div>
<div class="main"><div class="content">
<div class="section-header collapsed" onclick="toggleSection('messages')"><div class="section-header-title">Messages<span class="badge-count" id="messagesBadge" style="display:none;">0</span></div><div class="section-header-icon">▼</div></div>
<div class="section-content collapsed" id="messagesContent"><div class="inbox-container"><div class="inbox-tabs"><button class="inbox-tab active" onclick="switchInboxTab('all',this)">All</button><button class="inbox-tab" onclick="switchInboxTab('unread',this)">Unread</button><button class="inbox-tab" onclick="switchInboxTab('sent',this)">Sent</button></div><div class="inbox-list" id="inboxList"><div class="inbox-empty">No messages yet</div></div><div class="inbox-actions"><button class="inbox-action-btn" style="background:var(--accent-primary);border-color:var(--accent-primary);color:#fff;" onclick="openComposeModal()">+ New Message</button><button class="inbox-action-btn" onclick="markAllNotificationsRead()">Mark All Read</button></div></div></div>
<div class="section-header collapsed" onclick="toggleSection('tasks')"><div class="section-header-title">Tasks<span class="badge-count" id="tasksBadge" style="display:none;">0</span></div><div class="section-header-icon">▼</div></div>
<div class="section-content collapsed" id="tasksContent"><div class="tasks-container"><div class="tasks-tabs"><button class="tasks-tab active" onclick="switchTasksTab('pending',this)">Pending</button><button class="tasks-tab" onclick="switchTasksTab('in_progress',this)">In Progress</button><button class="tasks-tab" id="overdueTab" onclick="switchTasksTab('overdue',this)">Overdue</button><button class="tasks-tab" onclick="switchTasksTab('completed',this)">Done</button></div><div class="tasks-list" id="tasksList"><div class="tasks-empty">No tasks</div></div><div class="tasks-actions"><button class="tasks-action-btn primary" onclick="openNewTaskModal()">+ New Task</button></div></div></div>
<div class="section-header collapsed" onclick="toggleSection('swag')"><div class="section-header-title">Swag Inventory<span class="badge-count" id="swagBadge" style="display:none;">0</span></div><div class="section-header-icon">▼</div></div>
<div class="section-content collapsed" id="swagContent"><div class="swag-container"><div class="swag-header"><div class="swag-summary"><div class="swag-stat"><span class="swag-stat-value" id="swagTotalItems">0</span><span class="swag-stat-label">Total Items</span></div><div class="swag-stat"><span class="swag-stat-value" id="swagLowStock">0</span><span class="swag-stat-label">Low Stock</span></div></div></div><div class="swag-list" id="swagList"><div class="swag-empty">No swag items yet</div></div><div class="swag-actions"><button class="tasks-action-btn primary" onclick="location.href='sharklaw-swag.html'">Manage Swag</button></div></div></div>
<div class="section-header collapsed" onclick="toggleSection('employees')"><div class="section-header-title">Team<span class="badge-count" id="employeesBadge" style="display:none;">0</span></div><div class="section-header-icon">▼</div></div>
<div class="section-content collapsed" id="employeesContent"><div class="employees-container"><div class="employees-list" id="employeesList"><div class="employees-empty">Loading team...</div></div></div></div>
</div></div>
<div class="modal-overlay" id="newTaskModal"><div class="modal-content"><div class="modal-header"><div class="modal-title">New Task</div><button class="modal-close" onclick="closeNewTaskModal()">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Task Title <span class="required">*</span></label><input type="text" class="form-input" id="taskTitle" placeholder="Enter task title"></div><div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea></div><div class="form-group"><label class="form-label">Assign To</label><select class="form-select" id="taskAssignee"><option value="">-- Unassigned --</option></select></div><div class="form-row"><div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="taskPriority"><option value="low">Low</option><option value="normal" selected>Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="taskDueDate"></div></div></div><div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="saveNewTask()">Create Task</button><button class="btn-secondary" onclick="closeNewTaskModal()">Cancel</button></div></div></div></div>
<div class="modal-overlay" id="taskDetailModal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Task Details</div><button class="modal-close" onclick="closeTaskDetailModal()">&times;</button></div><div class="modal-body" id="taskDetailBody"></div><div class="modal-footer"><div class="modal-footer-buttons" id="taskDetailFooter"></div></div></div></div>
<div class="modal-overlay" id="messageDetailModal"><div class="modal-content"><div class="modal-header"><div class="modal-title">Message</div><button class="modal-close" onclick="closeMessageDetailModal()">&times;</button></div><div class="modal-body" id="messageDetailBody"></div></div></div>
<div class="modal-overlay" id="composeModal"><div class="modal-content"><div class="modal-header"><div class="modal-title">New Message</div><button class="modal-close" onclick="closeComposeModal()">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">To</label><select class="form-select" id="composeTo"><option value="">-- Select Recipient --</option></select></div><div class="form-group"><label class="form-label">Subject <span class="required">*</span></label><input type="text" class="form-input" id="composeSubject" placeholder="Message subject"></div><div class="form-group"><label class="form-label">Message <span class="required">*</span></label><textarea class="form-textarea" id="composeBody" placeholder="Type your message..." style="min-height:120px;"></textarea></div></div><div class="modal-footer"><div class="modal-footer-buttons"><button class="btn-primary" onclick="sendNewMessage()">Send Message</button><button class="btn-secondary" onclick="closeComposeModal()">Cancel</button></div></div></div></div>
<div class="voice-assistant-container" id="voiceAssistant"><div class="voice-agent-name">Jasmin</div><button class="voice-orb" id="voiceOrb"><span class="orb-swirl"></span><span class="orb-swirl orb-swirl-2"></span><span class="orb-swirl orb-swirl-3"></span></button><div class="voice-brand-name">Shark Law</div></div>
<div class="mobile-bottom-nav"><div class="mobile-nav-row"><a href="dashboard-sharklaw.html" class="mobile-nav-btn active">Dashboard</a><a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a></div><div class="mobile-nav-row three-col"><button id="mobileAssistantBtn" class="mobile-nav-btn assistant-btn" onclick="toggleVoiceAssistant()">Assistant</button><a href="sharklaw-contacts.html" class="mobile-nav-btn">Contacts</a><a href="sharklaw-swag.html" class="mobile-nav-btn">Swag</a></div></div>
<script>
const SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co',SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUserId=null,currentTenantId=null,userEmail=null,currentInboxTab='all',currentTasksTab='pending';
let allNotifications=[],allTasks=[],allEmployeesData=[],allSwagItems=[];
// ROLE-BASED ACCESS
let currentUserRole=null,currentUserName=null;
var THEME_NAMES={'dark-blue':'Dark Blue','blue-light':'Blue Light','slate-dark':'Slate Dark','slate-light':'Slate Light','ocean-dark':'Ocean Dark','ocean-light':'Ocean Light','midnight-dark':'Midnight','lavender-light':'Lavender','forest-dark':'Forest','mint-light':'Mint','crimson-dark':'Crimson','coral-light':'Coral','amber-dark':'Amber','honey-light':'Honey','rose-dark':'Rose','sky-light':'Sky','cyber-dark':'Cyber','sand-light':'Sand'};
var userThemeBank=['dark-blue'],themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';if(!userThemeBank.includes(t))t='dark-blue';themeIndex=userThemeBank.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){if(userThemeBank.length<=1){showThemeToast('Unlock more themes in Settings!');return;}themeIndex=(themeIndex+1)%userThemeBank.length;var t=userThemeBank[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(THEME_NAMES[t]||t);}
async function loadUserThemeBank(){if(!currentUserId)return;try{var r=await sb.from('user_theme_bank').select('theme_key').eq('user_id',currentUserId);if(r.data&&r.data.length>0){userThemeBank=['dark-blue'].concat(r.data.map(t=>t.theme_key));userThemeBank=[...new Set(userThemeBank)];}loadTheme();}catch(e){console.error('Error loading theme bank:',e);}}
function showThemeToast(msg){var toast=document.getElementById('themeToast');if(!toast){toast=document.createElement('div');toast.id='themeToast';toast.className='theme-toast';document.body.appendChild(toast);}toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000);}
loadTheme();
function toggleMobileMenu(){document.getElementById('mobileHeaderContent').classList.toggle('expanded');}
async function logout(){await sb.auth.signOut();localStorage.clear();location.replace("login.html");}
function toggleSection(id){var c=document.getElementById(id+'Content'),h=event.currentTarget;c.classList.toggle('collapsed');h.classList.toggle('collapsed');c.style.maxHeight=c.classList.contains('collapsed')?'0px':c.scrollHeight+'px';}

// ============================================================================
// MESSAGES — PRIVATE: only sender & recipient can see
// ============================================================================
async function loadInboxData(){
  if(!currentTenantId||!currentUserId)return;
  // Only fetch messages where current user is the recipient
  var r=await sb.from('notifications').select('*')
    .eq('tenant_id',currentTenantId)
    .eq('recipient_id',currentUserId)
    .order('created_at',{ascending:false}).limit(50);
  allNotifications=r.data||[];
  renderInbox();updateInboxBadge();
}
function renderInbox(){var c=document.getElementById('inboxList'),f=allNotifications;if(currentInboxTab==='unread')f=allNotifications.filter(n=>!n.is_read);else if(currentInboxTab==='sent')f=allNotifications.filter(n=>n.title&&n.title.indexOf('Sent:')==0);if(!f.length){c.innerHTML='<div class="inbox-empty">No messages</div>';return;}c.innerHTML=f.map(i=>'<div class="inbox-item '+(i.is_read?'':'unread')+'" onclick="openMessageDetail(\''+i.notification_id+'\')"><div class="inbox-item-content"><div class="inbox-item-header"><div class="inbox-item-title">'+(i.title||'Notification')+'</div><div class="inbox-item-time">'+formatTimeAgo(i.created_at)+'</div></div><div class="inbox-item-body">'+(i.body||'')+'</div></div></div>').join('');}
function switchInboxTab(t,b){currentInboxTab=t;document.querySelectorAll('.inbox-tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderInbox();}
var currentMessageId=null;
async function openMessageDetail(id){var m=allNotifications.find(n=>n.notification_id===id);if(!m)return;await sb.from('notifications').update({is_read:true}).eq('notification_id',id);m.is_read=true;renderInbox();updateInboxBadge();document.getElementById('messageDetailBody').innerHTML='<div class="message-detail"><div class="message-detail-header"><div class="message-detail-title">'+(m.title||'Notification')+'</div><div class="message-detail-meta">'+new Date(m.created_at).toLocaleString()+'</div></div><div class="message-detail-body" style="white-space:pre-wrap;">'+(m.body||'No content')+'</div></div>';currentMessageId=id;document.getElementById('messageDetailModal').classList.add('active');}
function closeMessageDetailModal(){document.getElementById('messageDetailModal').classList.remove('active');currentMessageId=null;}
function openComposeModal(){document.getElementById('composeSubject').value='';document.getElementById('composeBody').value='';populateRecipients();document.getElementById('composeModal').classList.add('active');}
function closeComposeModal(){document.getElementById('composeModal').classList.remove('active');}
function populateRecipients(){var s=document.getElementById('composeTo');s.innerHTML='<option value="">-- Select Recipient --</option><option value="all">All Team Members</option>';allEmployeesData.forEach(e=>{var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown';s.innerHTML+='<option value="'+e.employee_id+'">'+n+'</option>';});}
async function sendNewMessage(){
  var toVal=document.getElementById('composeTo').value,subj=document.getElementById('composeSubject').value.trim(),body=document.getElementById('composeBody').value.trim();
  if(!subj){alert('Enter a subject');return;}
  if(!body){alert('Enter a message');return;}
  if(!toVal){alert('Select a recipient');return;}
  var now=new Date().toISOString();
  try{
    if(toVal==='all'){
      // Send to each team member (they each get their own copy)
      var inserts=allEmployeesData.map(e=>({
        tenant_id:currentTenantId,
        recipient_id:e.employee_id,
        notification_type:'message',
        title:subj,
        body:'From: '+(currentUserName||userEmail)+'\n\n'+body,
        is_read:false,
        created_at:now
      }));
      // Also create sender's "Sent:" copy
      inserts.push({
        tenant_id:currentTenantId,
        recipient_id:currentUserId,
        notification_type:'message',
        title:'Sent: '+subj,
        body:'To: All Team Members\n\n'+body,
        is_read:true,
        created_at:now
      });
      await sb.from('notifications').insert(inserts);
    }else{
      // Send to specific person
      var recip=allEmployeesData.find(e=>e.employee_id===toVal);
      var recipName=recip?((recip.first_name||'')+' '+(recip.last_name||'')).trim():'Unknown';
      // Recipient gets the message
      await sb.from('notifications').insert({
        tenant_id:currentTenantId,
        recipient_id:toVal,
        notification_type:'message',
        title:subj,
        body:'From: '+(currentUserName||userEmail)+'\n\n'+body,
        is_read:false,
        created_at:now
      });
      // Sender gets a "Sent:" copy
      await sb.from('notifications').insert({
        tenant_id:currentTenantId,
        recipient_id:currentUserId,
        notification_type:'message',
        title:'Sent: '+subj,
        body:'To: '+recipName+'\n\n'+body,
        is_read:true,
        created_at:now
      });
    }
    closeComposeModal();loadInboxData();
  }catch(e){alert('Error: '+(e.message||'Failed to send'));}
}
async function markAllNotificationsRead(){
  await sb.from('notifications').update({is_read:true})
    .eq('tenant_id',currentTenantId)
    .eq('recipient_id',currentUserId)
    .eq('is_read',false);
  loadInboxData();
}
function updateInboxBadge(){var c=allNotifications.filter(n=>!n.is_read).length,b=document.getElementById('messagesBadge');b.textContent=c;b.style.display=c>0?'inline-block':'none';}

// ============================================================================
// TASKS — ROLE-BASED VISIBILITY
// owner/admin: ALL | manager: manager+staff tasks | staff: own only
// ============================================================================
async function loadTasksData(){if(!currentTenantId)return;var r=await sb.from('tasks').select('*').eq('tenant_id',currentTenantId).order('due_at',{ascending:true});allTasks=r.data||[];renderTasks();updateTasksBadge();updateOverdueTab();}
function getAssigneeFromDesc(d){if(!d)return'';var m=d.match(/\[Assigned to: ([^\]]+)\]/);return m?m[1]:'';}

function getVisibleTasks(){
  if(!currentUserRole)return allTasks;
  var role=currentUserRole.toLowerCase();
  // Owner and admin see everything
  if(role==='owner'||role==='admin')return allTasks;
  // Build name→role lookup
  var nameToRole={};
  allEmployeesData.forEach(function(e){
    var n=((e.first_name||'')+' '+(e.last_name||'')).trim();
    if(n)nameToRole[n]=(e.role||'staff').toLowerCase();
  });
  if(role==='manager'){
    // Managers see: own + other managers' + staff tasks + unassigned
    return allTasks.filter(function(t){
      var assignee=getAssigneeFromDesc(t.description);
      if(!assignee)return true;
      if(assignee===currentUserName)return true;
      var aRole=nameToRole[assignee]||'staff';
      return aRole==='manager'||aRole==='staff';
    });
  }
  // Staff: only own tasks + unassigned
  return allTasks.filter(function(t){
    var assignee=getAssigneeFromDesc(t.description);
    if(!assignee)return true;
    return assignee===currentUserName;
  });
}

function getOverdueTasks(){var now=new Date(),visible=getVisibleTasks();return visible.filter(t=>t.status!=='completed'&&t.due_at&&new Date(t.due_at)<now);}
function updateOverdueTab(){var c=getOverdueTasks().length,t=document.getElementById('overdueTab');if(c>0){t.classList.add('overdue-alert');t.textContent='Overdue ('+c+')';}else{t.classList.remove('overdue-alert');t.textContent='Overdue';}}
function getDefaultEmployeeColor(n){var colors=['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316','#6366f1','#84cc16','#06b6d4'],h=0;for(var i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return colors[Math.abs(h)%colors.length];}
var storedEmployeeColors=JSON.parse(localStorage.getItem('employeeColors')||'{}');
function getEmployeeColor(n){if(!n)return'var(--border-default)';var e=allEmployeesData.find(x=>((x.first_name||'')+' '+(x.last_name||'')).trim()===n);if(e&&storedEmployeeColors[e.employee_id])return storedEmployeeColors[e.employee_id];return getDefaultEmployeeColor(n);}
function renderTasks(){var c=document.getElementById('tasksList'),now=new Date(),visible=getVisibleTasks(),f=visible;if(currentTasksTab==='pending')f=visible.filter(t=>t.status==='pending'||t.status==='todo'||t.status==='open');else if(currentTasksTab==='in_progress')f=visible.filter(t=>t.status==='in_progress');else if(currentTasksTab==='overdue')f=getOverdueTasks();else if(currentTasksTab==='completed')f=visible.filter(t=>t.status==='completed');if(!f.length){c.innerHTML='<div class="tasks-empty">No tasks</div>';return;}c.innerHTML=f.map(t=>{var done=t.status==='completed',a=getAssigneeFromDesc(t.description),over=!done&&t.due_at&&new Date(t.due_at)<now,due=t.due_at?formatDate(t.due_at):'No due date',pc=t.priority==='urgent'?'priority-urgent':(t.priority==='high'?'priority-high':''),ec=getEmployeeColor(a),cs=done?'background:#10b981;border-color:#10b981;color:#fff;':'background:rgba('+hexToRgb(ec)+',0.81);border-color:'+ec+';color:#fff;';return'<div class="task-item '+(done?'completed':'')+'" id="task-'+t.task_id+'" style="cursor:pointer;'+(over?'border-left:3px solid #991b1b;':'')+'"><div class="task-checkbox '+(done?'completed':'')+'" style="'+cs+'" onclick="event.stopPropagation();animateComplete(\''+t.task_id+'\','+!done+')">'+(done?'✓':'')+'</div><div class="task-content" onclick="openTaskDetail(\''+t.task_id+'\')"><div class="task-title">'+t.title+'</div><div class="task-meta"><span class="task-priority '+pc+'">'+(t.priority||'normal')+'</span><span class="task-assignee" style="'+(over?'color:#991b1b;font-weight:600;':'')+'">'+(over?'OVERDUE • ':'')+'Due: '+due+'</span>'+(a?'<span class="task-assignee" style="color:'+ec+';">→ '+a+'</span>':'')+'</div></div></div>';}).join('');}
function hexToRgb(h){if(h.startsWith('var'))return'34,52,68';var r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?parseInt(r[1],16)+','+parseInt(r[2],16)+','+parseInt(r[3],16):'59,130,246';}
function animateComplete(id,mark){if(!mark){toggleTaskComplete(id,false);return;}var el=document.getElementById('task-'+id),cb=el.querySelector('.task-checkbox');cb.classList.add('animating');createSparkles(cb);setTimeout(()=>el.classList.add('completing'),600);setTimeout(()=>toggleTaskComplete(id,true),1300);}
function createSparkles(el){var r=el.getBoundingClientRect(),colors=['#10b981','#34d399','#6ee7b7','#fbbf24','#60a5fa'];for(var i=0;i<12;i++){var s=document.createElement('div');s.className='sparkle';s.style.left=r.left+r.width/2+'px';s.style.top=r.top+r.height/2+'px';s.style.background=colors[Math.floor(Math.random()*colors.length)];s.style.setProperty('--tx',(Math.random()-0.5)*80+'px');s.style.setProperty('--ty',(Math.random()-0.5)*80+'px');document.body.appendChild(s);setTimeout(()=>s.remove(),600);}}
function formatDate(d){return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function formatDateTime(d){if(!d)return'--';var x=new Date(d);return x.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' at '+x.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});}
var currentTaskId=null;
function openTaskDetail(id){var t=allTasks.find(x=>x.task_id===id);if(!t)return;currentTaskId=id;var a=getAssigneeFromDesc(t.description),now=new Date(),over=t.status!=='completed'&&t.due_at&&new Date(t.due_at)<now,done=t.status==='completed',dd=t.due_at?t.due_at.split('T')[0]:'';var html='<div style="margin-bottom:24px;"><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Task</div><div style="font-size:22px;font-weight:700;">'+t.title+'</div></div>';html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;"><div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Status</div><select class="form-select" id="editTaskStatus" style="padding:10px;font-size:14px;"><option value="pending" '+(t.status==='pending'?'selected':'')+'>Pending</option><option value="in_progress" '+(t.status==='in_progress'?'selected':'')+'>In Progress</option><option value="completed" '+(t.status==='completed'?'selected':'')+'>Completed</option></select></div><div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Priority</div><select class="form-select" id="editTaskPriority" style="padding:10px;font-size:14px;"><option value="low" '+(t.priority==='low'?'selected':'')+'>Low</option><option value="normal" '+(t.priority==='normal'||!t.priority?'selected':'')+'>Normal</option><option value="high" '+(t.priority==='high'?'selected':'')+'>High</option><option value="urgent" '+(t.priority==='urgent'?'selected':'')+'>Urgent</option></select></div></div>';html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;"><div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Due Date</div><input type="date" class="form-input" id="editTaskDue" value="'+dd+'" style="padding:10px;font-size:14px;"></div><div><div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">Assign To</div><select class="form-select" id="editTaskAssign" style="padding:10px;font-size:14px;"><option value="">Unassigned</option>';allEmployeesData.forEach(e=>{var n=((e.first_name||'')+' '+(e.last_name||'')).trim();html+='<option value="'+e.employee_id+'" '+(a===n?'selected':'')+'>'+n+'</option>';});html+='</select></div></div>';document.getElementById('taskDetailBody').innerHTML=html;var foot='';if(!done)foot+='<button class="btn-primary" style="background:#10b981;" onclick="markTaskDoneFromDetail(\''+id+'\')">✓ Mark Done</button>';else foot+='<button class="btn-secondary" style="border-color:#10b981;color:#10b981;" onclick="reopenTask(\''+id+'\')">↩ Reopen</button>';foot+='<button class="btn-primary" onclick="saveTaskChanges()">Save</button>';foot+='<button class="btn-secondary" style="border-color:#991b1b;color:#991b1b;" onclick="deleteTask(\''+id+'\')">Delete</button>';document.getElementById('taskDetailFooter').innerHTML=foot;document.getElementById('taskDetailModal').classList.add('active');}
function markTaskDoneFromDetail(id){closeTaskDetailModal();setTimeout(()=>{var el=document.getElementById('task-'+id);if(el){var cb=el.querySelector('.task-checkbox');cb.classList.add('animating');setTimeout(()=>el.classList.add('completing'),600);setTimeout(()=>toggleTaskComplete(id,true),1300);}else toggleTaskComplete(id,true);},100);}
function reopenTask(id){toggleTaskComplete(id,false);closeTaskDetailModal();}
function closeTaskDetailModal(){document.getElementById('taskDetailModal').classList.remove('active');currentTaskId=null;}
async function saveTaskChanges(){if(!currentTaskId)return;var t=allTasks.find(x=>x.task_id===currentTaskId);if(!t)return;var ns=document.getElementById('editTaskStatus').value,np=document.getElementById('editTaskPriority').value,nd=document.getElementById('editTaskDue').value,na=document.getElementById('editTaskAssign').value;var dc=(t.description||'').replace(/\[Assigned to: [^\]]+\]/g,'').trim(),an='';if(na){var e=allEmployeesData.find(x=>x.employee_id===na);if(e)an=((e.first_name||'')+' '+(e.last_name||'')).trim();}var desc=dc;if(an)desc=(dc?dc+'\n':'')+'[Assigned to: '+an+']';var upd={status:ns,priority:np,description:desc||null,due_at:nd?new Date(nd).toISOString():null,updated_at:new Date().toISOString()};if(ns==='completed'&&t.status!=='completed')upd.completed_at=new Date().toISOString();else if(ns!=='completed')upd.completed_at=null;try{await sb.from('tasks').update(upd).eq('task_id',currentTaskId);closeTaskDetailModal();loadTasksData();}catch(e){alert('Error: '+(e.message||'Failed to save'));}}
async function deleteTask(id){if(!confirm('Delete this task?'))return;try{await sb.from('tasks').delete().eq('task_id',id);closeTaskDetailModal();loadTasksData();}catch(e){alert('Error: '+(e.message||'Failed to delete'));}}
function switchTasksTab(t,b){currentTasksTab=t;document.querySelectorAll('.tasks-tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderTasks();}
async function toggleTaskComplete(id,done){var upd={status:done?'completed':'pending',updated_at:new Date().toISOString()};if(done)upd.completed_at=new Date().toISOString();else upd.completed_at=null;await sb.from('tasks').update(upd).eq('task_id',id);loadTasksData();}
function updateTasksBadge(){var visible=getVisibleTasks();var c=visible.filter(t=>t.status!=='completed').length,b=document.getElementById('tasksBadge');b.textContent=c;b.style.display=c>0?'inline-block':'none';}
async function loadSwagData(){if(!currentTenantId)return;var r=await sb.from('parts_inventory').select('*').eq('tenant_id',currentTenantId).order('part_name',{ascending:true});allSwagItems=r.data||[];renderSwag();updateSwagBadge();}
function renderSwag(){var c=document.getElementById('swagList'),tot=allSwagItems.reduce((s,i)=>s+(i.quantity_on_hand||0),0),low=allSwagItems.filter(i=>(i.quantity_on_hand||0)<=5).length;document.getElementById('swagTotalItems').textContent=tot;document.getElementById('swagLowStock').textContent=low;if(!allSwagItems.length){c.innerHTML='<div class="swag-empty">No swag items yet</div>';return;}c.innerHTML=allSwagItems.map(i=>{var q=i.quantity_on_hand||0,isLow=q>0&&q<=5,isOut=q===0;return'<div class="swag-item '+(isOut?'out-of-stock':(isLow?'low-stock':''))+'"><div class="swag-item-info"><div class="swag-item-name">'+(i.part_name||'Unknown')+'</div><div class="swag-item-category">'+(i.description||'--')+'</div></div><div class="swag-item-qty"><span class="swag-qty-value">'+q+'</span><span class="swag-qty-label">'+(isOut?'Out':(isLow?'Low':'In Stock'))+'</span></div></div>';}).join('');}
function updateSwagBadge(){var c=allSwagItems.filter(i=>(i.quantity_on_hand||0)<=5).length,b=document.getElementById('swagBadge');b.textContent=c;b.style.display=c>0?'inline-block':'none';}
async function loadEmployeesData(){
  if(!currentTenantId)return;
  var r=await sb.from('employees').select('*').eq('tenant_id',currentTenantId).order('last_name',{ascending:true});
  allEmployeesData=r.data||[];
  var b=document.getElementById('employeesBadge');b.textContent=allEmployeesData.length;b.style.display=allEmployeesData.length>0?'inline-block':'none';
  storedEmployeeColors=JSON.parse(localStorage.getItem('employeeColors')||'{}');
  // DETECT CURRENT USER ROLE from employee email match
  var me=allEmployeesData.find(e=>e.email&&e.email.toLowerCase()===(userEmail||'').toLowerCase());
  if(me){
    currentUserRole=(me.role||'staff').toLowerCase();
    currentUserName=((me.first_name||'')+' '+(me.last_name||'')).trim();
    console.log('[ROLE] Detected:',currentUserRole,'as',currentUserName);
  }else{
    // No employee match — default to owner (full access) for the account holder
    currentUserRole='owner';
    currentUserName='';
    console.log('[ROLE] No employee match for',userEmail,'— defaulting to owner');
  }
  renderEmployees();populateTaskAssignees();
}
function renderEmployees(){var c=document.getElementById('employeesList');if(!allEmployeesData.length){c.innerHTML='<div class="employees-empty">No team members found</div>';return;}var ro={'owner':1,'manager':2,'admin':3,'staff':4},sorted=allEmployeesData.slice().sort((a,b)=>{var ra=ro[(a.role||'staff').toLowerCase()]||5,rb=ro[(b.role||'staff').toLowerCase()]||5;if(ra!==rb)return ra-rb;return((a.last_name||'')+(a.first_name||'')).localeCompare((b.last_name||'')+(b.first_name||''));});c.innerHTML=sorted.map(e=>{var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown',in_=((e.first_name||'U')[0]+((e.last_name||'')[0]||'')).toUpperCase(),co=storedEmployeeColors[e.employee_id]||getDefaultEmployeeColor(n),rl=(e.role||'staff').replace(/_/g,' ');rl=rl.charAt(0).toUpperCase()+rl.slice(1);return'<div class="emp-strip"><div class="emp-strip-header"><div class="emp-avatar" style="background:rgba('+hexToRgb(co)+',0.81);">'+in_+'</div><div class="emp-info"><div class="emp-name">'+n+'</div><div class="emp-role">'+rl+(e.department?' • '+e.department:'')+'</div></div><div class="emp-actions">'+(e.phone?'<a href="tel:'+e.phone+'" class="emp-action-btn">Call</a>':'')+(e.email?'<a href="mailto:'+e.email+'" class="emp-action-btn">Email</a>':'')+'</div></div></div>';}).join('');}
function populateTaskAssignees(){var s=document.getElementById('taskAssignee');s.innerHTML='<option value="">-- Unassigned --</option>';allEmployeesData.forEach(e=>{var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown';s.innerHTML+='<option value="'+e.employee_id+'">'+n+'</option>';});}
function openNewTaskModal(){document.getElementById('taskTitle').value='';document.getElementById('taskDescription').value='';document.getElementById('taskAssignee').value='';document.getElementById('taskPriority').value='normal';document.getElementById('taskDueDate').value=new Date(Date.now()+86400000).toISOString().split('T')[0];document.getElementById('newTaskModal').classList.add('active');}
function closeNewTaskModal(){document.getElementById('newTaskModal').classList.remove('active');}
async function saveNewTask(){var title=document.getElementById('taskTitle').value.trim();if(!title){alert('Enter a task title');return;}var aid=document.getElementById('taskAssignee').value||null,an=null;if(aid){var e=allEmployeesData.find(x=>x.employee_id===aid);if(e)an=((e.first_name||'')+' '+(e.last_name||'')).trim();}var desc=document.getElementById('taskDescription').value.trim()||'';if(an)desc=(desc?desc+'\n':'')+'[Assigned to: '+an+']';var r=await sb.from('tasks').insert({tenant_id:currentTenantId,title:title,description:desc||null,priority:document.getElementById('taskPriority').value,status:'pending',due_at:document.getElementById('taskDueDate').value?new Date(document.getElementById('taskDueDate').value).toISOString():null,created_by:currentUserId});if(r.error){alert('Error: '+r.error.message);return;}closeNewTaskModal();loadTasksData();}
function formatTimeAgo(d){var diff=new Date()-new Date(d),mins=Math.floor(diff/60000);if(mins<60)return mins+'m ago';var hrs=Math.floor(diff/3600000);if(hrs<24)return hrs+'h ago';return Math.floor(diff/86400000)+'d ago';}
async function checkAuth(){var r=await sb.auth.getSession(),s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){window.location.href='login.html';return null;}}currentUserId=s.user.id;userEmail=s.user.email;return s;}
function updateEmailDisplay(){if(userEmail){document.getElementById('desktopBusinessName').textContent=userEmail;document.getElementById('mobileBusinessName').textContent=userEmail;}}

// ============================================================================
// VAPI VOICE ASSISTANT - LATENCY OPTIMIZED
// ============================================================================
var vapi=null,voiceAssistantOpen=false,vapiInitialized=false,vapiStartTime=null;
const VAPI_PUBLIC_KEY="b66ad6e7-ec9d-421c-88b7-157068b27f6d";
const VAPI_AGENT_ID="65bb531d-a9bf-4074-93d9-13b75a731265";
function warmVapiAgent(){fetch("https://api.vapi.ai/health").catch(()=>{});console.log('[VAPI] Agent warm-up ping sent');}
function initVapi(){
  if(vapiInitialized||!window.Vapi)return;
  try{
    vapi=new window.Vapi(VAPI_PUBLIC_KEY);
    var callStartTime=null,userSpeechEndTime=null,transcriptReadyTime=null,firstLLMTokenTime=null,ttsStartTime=null;
    vapi.on("call-start",()=>{callStartTime=performance.now();console.log('[VAPI] T0: Call started');document.getElementById('voiceOrb').classList.add('listening');setAssistantButtonState(true);});
    vapi.on("speech-end",()=>{if(!userSpeechEndTime&&callStartTime){userSpeechEndTime=performance.now();}});
    vapi.on("message",(msg)=>{var now=performance.now();if(msg.type==='transcript'&&msg.role==='user'&&msg.transcriptType==='final'){transcriptReadyTime=now;}if(msg.type==='transcript'&&msg.role==='assistant'&&!firstLLMTokenTime){firstLLMTokenTime=now;}});
    vapi.on("speech-start",()=>{var now=performance.now();if(vapiStartTime&&!ttsStartTime){ttsStartTime=now;console.log('[VAPI] Total (button→audio):',Math.round(now-vapiStartTime),'ms');vapiStartTime=null;}userSpeechEndTime=null;transcriptReadyTime=null;firstLLMTokenTime=null;ttsStartTime=null;});
    vapi.on("call-end",()=>{console.log('[VAPI] Call ended');document.getElementById('voiceOrb').classList.remove('listening');document.getElementById('voiceAssistant').classList.remove('active');setAssistantButtonState(false);voiceAssistantOpen=false;});
    vapi.on("error",(e)=>{console.error('[VAPI] Error:',e);document.getElementById('voiceOrb').classList.remove('listening');setAssistantButtonState(false);});
    vapiInitialized=true;console.log('[VAPI] Client pre-initialized');
  }catch(e){console.error('[VAPI] Failed to initialize:',e);}
}
function setAssistantButtonState(active){var d=document.getElementById('desktopAssistantBtn'),m=document.getElementById('mobileAssistantBtn');if(d)d.classList.toggle('active',active);if(m)m.classList.toggle('active',active);}
async function toggleVoiceAssistant(){
  var container=document.getElementById('voiceAssistant'),orb=document.getElementById('voiceOrb');
  if(!vapi)initVapi();if(!vapi){console.error('[VAPI] SDK not available');return;}
  if(voiceAssistantOpen){vapi.stop();container.classList.remove('active');orb.classList.remove('listening');setAssistantButtonState(false);voiceAssistantOpen=false;}
  else{
    container.classList.add('active');setAssistantButtonState(true);voiceAssistantOpen=true;vapiStartTime=performance.now();
    try{
      await navigator.mediaDevices.getUserMedia({audio:true});
      var me=allEmployeesData.find(e=>e.email&&e.email.toLowerCase()===(userEmail||'').toLowerCase());
      var userName=me?((me.first_name||'')+' '+(me.last_name||'')).trim():'';
      var userFirstName=me?(me.first_name||''):'';
      vapi.start(VAPI_AGENT_ID,{variableValues:{user_id:me?me.employee_id:currentUserId||'',user_name:userName||userFirstName||userEmail||'there',user_first_name:userFirstName||'there',user_type:me?'employee':'user',user_email:userEmail||'',user_department:me?(me.department||''):'',user_role:me?(me.role||''):'',tenant_id:currentTenantId||'55555555-5555-5555-5555-555555555555'}});
    }catch(e){console.error('[VAPI] Failed:',e);container.classList.remove('active');setAssistantButtonState(false);voiceAssistantOpen=false;if(e.name==='NotAllowedError')alert('Microphone access required.');}
  }
}
function waitForVapiAndInit(){if(window.Vapi){initVapi();setTimeout(warmVapiAgent,100);}else setTimeout(waitForVapiAndInit,100);}
waitForVapiAndInit();
document.addEventListener('DOMContentLoaded',()=>{var orb=document.getElementById('voiceOrb');if(orb)orb.addEventListener('click',()=>toggleVoiceAssistant());});
window.addEventListener("load",()=>{setTimeout(warmVapiAgent,800);});

// ============================================================================
// MAIN INITIALIZATION
// ============================================================================
async function init(){
  var s=await checkAuth();if(!s)return;
  var email=s.user?.email;
  if(email){var r=await sb.from('users').select('*').eq('email',email).single();if(r.data?.tenant_id){currentTenantId=r.data.tenant_id;currentUserId=r.data.user_id;}}
  if(!currentTenantId){var r=await sb.from('business_settings').select('tenant_id').limit(1).single();if(r.data?.tenant_id)currentTenantId=r.data.tenant_id;}
  if(!currentTenantId){console.error('No tenant_id');return;}
  updateEmailDisplay();
  await loadUserThemeBank();
  await loadEmployeesData(); // Must load first to detect role before tasks/messages
  await Promise.all([loadInboxData(),loadTasksData(),loadSwagData()]);
}
init();
</script>
</body>
</html>
