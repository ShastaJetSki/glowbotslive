<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Documentation</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0b0f14;
      min-height: 100vh;
      padding: 20px;
      color: #e8eef6;
    }

    .container { max-width: 1600px; margin: 0 auto; }

    .header {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { color: #60a5fa; font-size: 28px; font-weight: 700; }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #2d3f56;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: white;
      background: #3b82f6;
      font-size: 14px;
    }

    .btn:hover { background: #2563eb; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #60a5fa;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .search-box {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .search-input {
      width: 100%;
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 12px 16px;
      color: #e8eef6;
      font-size: 14px;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .table-card {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .table-card:hover { border-color: #3b82f6; }

    .table-header {
      padding: 20px 24px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0f1621;
      transition: background 0.2s;
    }

    .table-header:hover { background: #1a2535; }

    .table-info {
      flex: 1;
    }

    .table-name {
      font-size: 20px;
      font-weight: 700;
      color: #60a5fa;
      margin-bottom: 6px;
    }

    .table-description {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 8px;
    }

    .table-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #64748b;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-primary { background: #1e3a8a; color: #93c5fd; }
    .badge-success { background: #065f46; color: #6ee7b7; }
    .badge-warning { background: #78350f; color: #fcd34d; }

    .expand-icon {
      font-size: 20px;
      color: #94a3b8;
      transition: transform 0.2s;
    }

    .table-card.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .table-content {
      display: none;
      border-top: 1px solid #2d3f56;
      background: #0a0e13;
    }

    .table-card.expanded .table-content {
      display: block;
    }

    .section {
      padding: 20px 24px;
      border-bottom: 1px solid #2d3f56;
    }

    .section:last-child { border-bottom: none; }

    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .screens-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .screen-tag {
      background: #1a2535;
      border: 1px solid #2d3f56;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: #e8eef6;
      font-weight: 500;
    }

    .fields-table {
      width: 100%;
      border-collapse: collapse;
    }

    .fields-table th {
      background: #1a2535;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #2d3f56;
    }

    .fields-table td {
      padding: 12px;
      border-bottom: 1px solid #2d3f56;
      font-size: 13px;
    }

    .fields-table tr:hover { background: #1a2535; }

    .field-name {
      font-weight: 600;
      color: #60a5fa;
      font-family: 'Courier New', monospace;
    }

    .field-type {
      font-family: 'Courier New', monospace;
      color: #fcd34d;
      font-size: 12px;
    }

    .field-constraint {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-right: 4px;
      background: #581c87;
      color: #d8b4fe;
    }

    .relationships {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .relationship {
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
    }

    .relationship-type {
      color: #10b981;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .relationship-detail {
      color: #94a3b8;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #94a3b8;
      font-size: 16px;
    }

    .usage-example {
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #6ee7b7;
      white-space: pre;
      overflow-x: auto;
    }

    @media (max-width: 768px) {
      .stats { grid-template-columns: 1fr; }
      .fields-table { font-size: 11px; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìö Database Documentation</h1>
    <a href="admin-dashboard-collapsible.html" class="btn">‚Üê Back to Dashboard</a>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalTables">-</div>
      <div class="stat-label">Total Tables</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalColumns">-</div>
      <div class="stat-label">Total Columns</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalRelationships">-</div>
      <div class="stat-label">Relationships</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalScreens">-</div>
      <div class="stat-label">Connected Screens</div>
    </div>
  </div>

  <div class="search-box">
    <input 
      type="text" 
      class="search-input" 
      placeholder="üîç Search tables, columns, or descriptions..."
      id="searchInput"
      oninput="filterTables(this.value)">
  </div>

  <div id="loading" class="loading">
    Loading database schema...
  </div>

  <div id="tablesContainer"></div>
</div>

<script>
  const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
  
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Table descriptions and screen mappings
  const tableMetadata = {
    tenants: {
      description: "Core table storing all SaaS customers (tenants). Each tenant represents a company/organization subscribing to your platform.",
      screens: ["Admin Dashboard", "Admin Settings", "Tenant Management"],
      purpose: "Multi-tenant foundation - tracks subscriptions, billing, and tenant metadata",
      examples: "Acme Corp ($999/mo Enterprise), TechStart Inc ($99/mo Professional)"
    },
    subscription_tiers: {
      description: "Defines pricing plans and feature sets offered to customers. Controls what features/limits each tenant gets.",
      screens: ["Admin Settings", "Pricing Page", "Signup Flow"],
      purpose: "Revenue model definition - determines pricing structure and feature access",
      examples: "Starter ($29/mo), Professional ($99/mo), Enterprise ($999/mo)"
    },
    tenant_users: {
      description: "Individual user accounts within each tenant organization. Tracks who can access each tenant's account.",
      screens: ["User Management", "Team Settings", "Admin Dashboard"],
      purpose: "Access control - manages users within each tenant organization",
      examples: "john@acme.com (admin), jane@acme.com (user)"
    },
    revenue_records: {
      description: "Payment transaction history from all tenants. Records every payment, refund, and billing event.",
      screens: ["Admin Dashboard", "Financial Reports", "Billing History"],
      purpose: "Financial tracking - complete audit trail of all revenue",
      examples: "Monthly subscription payments, one-time setup fees, upgrade charges"
    },
    cost_categories: {
      description: "Classification system for operational expenses. Groups costs by type for better analysis.",
      screens: ["Admin Settings", "Cost Analysis Dashboard"],
      purpose: "Expense organization - categorizes all platform operating costs",
      examples: "Infrastructure, Services, Payment Processing, Operations"
    },
    operational_costs: {
      description: "All expenses to run the platform. Tracks monthly/annual costs for services, infrastructure, and operations.",
      screens: ["Admin Settings", "Admin Dashboard", "Financial Reports"],
      purpose: "Expense tracking - monitors all platform costs for profitability analysis",
      examples: "AWS ($3,200/mo), Stripe fees ($1,810/mo), Support staff ($8,000/mo)"
    },
    support_tickets: {
      description: "Customer support request tracking system. Manages all support inquiries from all tenants with SLA tracking.",
      screens: ["Support Dashboard", "Ticket Management", "Admin Dashboard"],
      purpose: "Customer service - tracks support requests, response times, and resolution",
      examples: "Bug reports, feature requests, billing questions, technical support"
    },
    ticket_comments: {
      description: "Conversation history for support tickets. Stores all messages, notes, and updates for each ticket.",
      screens: ["Support Dashboard", "Ticket Detail View"],
      purpose: "Support communication - maintains complete conversation thread per ticket",
      examples: "Customer replies, agent responses, internal notes, status updates"
    },
    financial_metrics: {
      description: "Pre-calculated business metrics cached for performance. Stores MRR, churn, profit margins, etc.",
      screens: ["Admin Dashboard", "Analytics", "Financial Reports"],
      purpose: "Business intelligence - cached calculations for fast dashboard loading",
      examples: "Monthly MRR: $45,280, Churn rate: 3.2%, Profit margin: 72.5%"
    },
    activity_log: {
      description: "Audit trail of all platform actions. Records who did what and when across the entire system.",
      screens: ["Admin Dashboard", "Audit Log Viewer", "Security Monitor"],
      purpose: "Security & compliance - complete audit trail for all system actions",
      examples: "User logins, subscription changes, payment events, admin actions"
    },
    app_settings: {
      description: "Platform-wide configuration values. Stores global settings that control app behavior.",
      screens: ["Admin Settings", "Configuration Panel"],
      purpose: "System configuration - centralized settings management",
      examples: "Trial period (14 days), Currency (USD), Support email, Feature flags"
    },
    admin_users: {
      description: "Platform administrators who manage the entire SaaS. Only these users can access admin dashboard.",
      screens: ["Admin Dashboard", "Admin Settings", "All Admin Screens"],
      purpose: "Access control - defines who can manage the platform (you and your team)",
      examples: "admin@mysaas.com (super_admin), support@mysaas.com (support)"
    },
    customers: {
      description: "Work order customers (legacy CRM table). Separate from tenant subscriptions - tracks service/repair customers.",
      screens: ["Work Order Management", "Customer CRM"],
      purpose: "CRM - manages customers for work orders/services (not SaaS subscriptions)",
      examples: "Walk-in customers, one-time service clients, repair customers"
    }
  };

  let allTables = [];

  async function loadDatabaseSchema() {
    try {
      // Get all tables
      const { data: tables, error: tablesError } = await supabaseClient
        .rpc('get_tables_info');

      if (tablesError) {
        // Fallback: Query information_schema directly
        const { data: tableList } = await supabaseClient
          .from('information_schema.tables')
          .select('table_name')
          .eq('table_schema', 'public')
          .neq('table_name', 'pg_stat_statements')
          .order('table_name');

        if (tableList) {
          for (const table of tableList) {
            await loadTableDetails(table.table_name);
          }
        }
      }

      renderTables();
      updateStats();

    } catch (error) {
      console.error('Error loading schema:', error);
      document.getElementById('loading').innerHTML = 
        'Error loading database schema. See SETUP-DATABASE-DOCS.md for SQL function setup.';
    }
  }

  async function loadTableDetails(tableName) {
    try {
      // Get columns
      const { data: columns } = await supabaseClient
        .from('information_schema.columns')
        .select('*')
        .eq('table_schema', 'public')
        .eq('table_name', tableName)
        .order('ordinal_position');

      // Get foreign keys (simplified)
      const { data: constraints } = await supabaseClient
        .from('information_schema.table_constraints')
        .select('*')
        .eq('table_schema', 'public')
        .eq('table_name', tableName)
        .eq('constraint_type', 'FOREIGN KEY');

      const metadata = tableMetadata[tableName] || {
        description: "No description available",
        screens: ["Unknown"],
        purpose: "Not documented",
        examples: "N/A"
      };

      allTables.push({
        name: tableName,
        columns: columns || [],
        relationships: constraints || [],
        ...metadata
      });

    } catch (error) {
      console.error(`Error loading table ${tableName}:`, error);
    }
  }

  function renderTables() {
    const container = document.getElementById('tablesContainer');
    const loading = document.getElementById('loading');

    loading.style.display = 'none';

    container.innerHTML = allTables.map(table => `
      <div class="table-card" id="table-${table.name}">
        <div class="table-header" onclick="toggleTable('${table.name}')">
          <div class="table-info">
            <div class="table-name">${table.name}</div>
            <div class="table-description">${table.description}</div>
            <div class="table-meta">
              <span>${table.columns.length} columns</span>
              <span>${table.relationships.length} relationships</span>
              <span class="badge badge-primary">${table.screens.length} screens</span>
            </div>
          </div>
          <div class="expand-icon">‚ñº</div>
        </div>

        <div class="table-content">
          <!-- Purpose & Context -->
          <div class="section">
            <div class="section-title">üìã Purpose & Context</div>
            <p style="color: #94a3b8; margin-bottom: 12px;">${table.purpose}</p>
            <div style="background: #1a2535; padding: 12px; border-radius: 8px; border-left: 3px solid #10b981;">
              <strong style="color: #10b981;">Real-world examples:</strong><br>
              <span style="color: #94a3b8;">${table.examples}</span>
            </div>
          </div>

          <!-- Connected Screens -->
          <div class="section">
            <div class="section-title">üñ•Ô∏è Connected Screens</div>
            <div class="screens-list">
              ${table.screens.map(screen => `<div class="screen-tag">${screen}</div>`).join('')}
            </div>
          </div>

          <!-- Columns/Fields -->
          <div class="section">
            <div class="section-title">üìä Columns & Data Structure</div>
            <table class="fields-table">
              <thead>
                <tr>
                  <th>Column Name</th>
                  <th>Data Type</th>
                  <th>Constraints</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                ${table.columns.map(col => `
                  <tr>
                    <td class="field-name">${col.column_name}</td>
                    <td class="field-type">${col.data_type}${col.character_maximum_length ? `(${col.character_maximum_length})` : ''}</td>
                    <td>
                      ${col.is_nullable === 'NO' ? '<span class="field-constraint">NOT NULL</span>' : ''}
                      ${col.column_default ? '<span class="field-constraint">DEFAULT</span>' : ''}
                    </td>
                    <td style="color: #94a3b8;">${getColumnDescription(table.name, col.column_name)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <!-- Relationships -->
          ${table.relationships.length > 0 ? `
            <div class="section">
              <div class="section-title">üîó Relationships</div>
              <div class="relationships">
                ${table.relationships.map(rel => `
                  <div class="relationship">
                    <div class="relationship-type">Foreign Key</div>
                    <div class="relationship-detail">${rel.constraint_name}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Usage Example -->
          <div class="section">
            <div class="section-title">üíª Usage Example</div>
            <div class="usage-example">${getUsageExample(table.name)}</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function getColumnDescription(tableName, columnName) {
    const descriptions = {
      tenant_id: "Unique identifier for the tenant/customer",
      tier_id: "Links to subscription_tiers - defines pricing plan",
      status: "Account status: active, trial, inactive, suspended",
      monthly_recurring_revenue: "MRR from this tenant (can be custom pricing)",
      billing_cycle: "How often charged: monthly or annual",
      metadata: "JSON field for custom data (promo codes, notes, custom pricing)",
      created_at: "When this record was created",
      updated_at: "Last time this record was modified",
      is_active: "Whether this item is currently active/enabled",
      sort_order: "Display order (lower numbers first)",
      tier_name: "Internal key (starter, pro, enterprise)",
      tier_display_name: "User-facing name (Professional Plan)",
      monthly_price: "Price per month in dollars",
      annual_price: "Price per year in dollars (usually ~2 months free)",
      features: "JSON array of feature names",
      limits: "JSON object with usage limits (users, storage, API calls)",
      email: "User's email address",
      full_name: "User's full name",
      role: "User role: admin, user, manager, support, viewer",
      last_login_at: "When user last logged in",
      amount: "Payment amount in dollars",
      payment_status: "pending, completed, failed, refunded, cancelled",
      transaction_id: "Payment processor transaction ID (Stripe, etc)",
      category_name: "Cost category name",
      service_name: "Name of the service/subscription",
      provider_name: "Company providing the service (AWS, Stripe, etc)",
      monthly_cost: "Cost per month in dollars",
      ticket_number: "Auto-generated ticket ID (TKT-20250101-000001)",
      priority: "low, medium, high, urgent, critical",
      subject: "Ticket subject line",
      description: "Full ticket description",
      assigned_to: "Admin user ID who owns this ticket",
      sla_response_due_at: "When response is due (SLA)",
      sla_resolution_due_at: "When resolution is due (SLA)",
      satisfaction_rating: "1-5 stars customer rating",
      metric_period: "Date for this metrics snapshot",
      total_revenue: "Total revenue for period",
      total_costs: "Total costs for period",
      net_profit: "Revenue minus costs",
      profit_margin: "Net profit / revenue * 100",
      churn_rate: "Percentage of customers lost",
      arpu: "Average Revenue Per User",
      activity_type: "Type of action (login, payment, subscription_change)",
      entity_type: "Type of entity affected (tenant, user, payment)",
      ip_address: "IP address of user who performed action"
    };
    return descriptions[columnName] || "No description available";
  }

  function getUsageExample(tableName) {
    const examples = {
      tenants: `-- Get all active tenants with their tiers
SELECT t.company_name, t.monthly_recurring_revenue,
       st.tier_display_name
FROM tenants t
JOIN subscription_tiers st ON t.tier_id = st.tier_id
WHERE t.status = 'active'
ORDER BY t.monthly_recurring_revenue DESC;`,

      subscription_tiers: `-- Get all active tiers with pricing
SELECT tier_display_name, monthly_price, annual_price
FROM subscription_tiers
WHERE is_active = true
ORDER BY sort_order;`,

      revenue_records: `-- Calculate total revenue for current month
SELECT SUM(amount) as total_revenue
FROM revenue_records
WHERE payment_status = 'completed'
  AND billing_period_start >= date_trunc('month', now());`,

      operational_costs: `-- Get costs by category
SELECT cc.category_name, SUM(oc.monthly_cost) as total
FROM operational_costs oc
JOIN cost_categories cc ON oc.category_id = cc.category_id
WHERE oc.is_active = true
GROUP BY cc.category_name;`,

      support_tickets: `-- Get open tickets sorted by priority
SELECT ticket_number, subject, priority, created_at
FROM support_tickets
WHERE status IN ('open', 'in_progress')
ORDER BY 
  CASE priority
    WHEN 'critical' THEN 1
    WHEN 'urgent' THEN 2
    WHEN 'high' THEN 3
    ELSE 4
  END,
  created_at ASC;`
    };
    return examples[tableName] || `-- Query ${tableName}\nSELECT * FROM ${tableName} LIMIT 10;`;
  }

  function updateStats() {
    const totalColumns = allTables.reduce((sum, t) => sum + t.columns.length, 0);
    const totalRelationships = allTables.reduce((sum, t) => sum + t.relationships.length, 0);
    const allScreens = new Set(allTables.flatMap(t => t.screens));

    document.getElementById('totalTables').textContent = allTables.length;
    document.getElementById('totalColumns').textContent = totalColumns;
    document.getElementById('totalRelationships').textContent = totalRelationships;
    document.getElementById('totalScreens').textContent = allScreens.size;
  }

  function toggleTable(tableName) {
    const card = document.getElementById(`table-${tableName}`);
    card.classList.toggle('expanded');
  }

  function filterTables(searchTerm) {
    const term = searchTerm.toLowerCase();
    allTables.forEach(table => {
      const card = document.getElementById(`table-${table.name}`);
      const matchesName = table.name.toLowerCase().includes(term);
      const matchesDescription = table.description.toLowerCase().includes(term);
      const matchesColumn = table.columns.some(col => 
        col.column_name.toLowerCase().includes(term)
      );
      
      if (matchesName || matchesDescription || matchesColumn) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }

  // Initialize
  loadDatabaseSchema();
</script>

</body>
</html>
