-- Seed "Redding Rock" event for HAMCRedding with all departments & tasks
DO $$
DECLARE
  v_tenant UUID := 'f9971a64-7743-4a9f-9d2b-22f1b6fc200e';
  v_project UUID;
  v_dept_name TEXT;
  v_dept_id UUID;
  v_sort INT := 0;
  dept_rec RECORD;
  task_rec RECORD;
BEGIN
  -- 1. Create the event project
  INSERT INTO event_projects (tenant_id, event_name, status, notes)
  VALUES (v_tenant, 'Redding Rock', 'planning', 'Main event for HAMCRedding')
  RETURNING event_project_id INTO v_project;

  -- 2. Loop through unique departments from templates
  FOR dept_rec IN 
    SELECT DISTINCT department_name 
    FROM event_task_templates 
    WHERE tenant_id IS NULL OR tenant_id = v_tenant
    ORDER BY department_name
  LOOP
    v_sort := v_sort + 1;
    
    -- Insert department
    INSERT INTO event_departments (tenant_id, event_project_id, department_name, sort_order)
    VALUES (v_tenant, v_project, dept_rec.department_name, v_sort)
    RETURNING event_department_id INTO v_dept_id;

    -- Insert all tasks for this department
    INSERT INTO event_tasks (tenant_id, event_project_id, event_department_id, task_title, sort_order)
    SELECT v_tenant, v_project, v_dept_id, t.task_title, t.sort_order
    FROM event_task_templates t
    WHERE t.department_name = dept_rec.department_name
    AND (t.tenant_id IS NULL OR t.tenant_id = v_tenant)
    ORDER BY t.sort_order;
  END LOOP;

  RAISE NOTICE 'Created Redding Rock with % departments', v_sort;
END $$;

-- Also seed the 10 default members if not already present
INSERT INTO event_members (tenant_id, first_name, role_level)
SELECT 'f9971a64-7743-4a9f-9d2b-22f1b6fc200e', name, level
FROM (VALUES 
  ('Kevin','admin'),
  ('Allen','manager'),
  ('Matt','manager'),
  ('Brian','team'),
  ('Dave','team'),
  ('Hunter','team'),
  ('Joe','team'),
  ('James','team'),
  ('Jimmy','team'),
  ('Dan','team')
) AS v(name, level)
WHERE NOT EXISTS (
  SELECT 1 FROM event_members WHERE tenant_id = 'f9971a64-7743-4a9f-9d2b-22f1b6fc200e' LIMIT 1
);
