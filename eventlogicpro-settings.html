<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Settings – Event Logic Pro</title>
  <link rel="icon" href="favicon-eventlogic.ico">
  <link rel="icon" type="image/png" href="favicon-eventlogic-32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="favicon-eventlogic-192.png">
  <meta name="apple-mobile-web-app-title" content="Event Logic Pro">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg-primary:#f4f5f7;--bg-secondary:#ebedf1;--bg-card:#ffffff;--bg-hover:#f0f0f3;
  --border:#e2e4e8;--text-primary:#1a1a1a;--text-secondary:#6b7280;
  --accent:#DC2626;--accent-hover:#B91C1C;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.10);--accent-glow2:rgba(220,38,38,.06);
  --shadow:0 2px 12px rgba(0,0,0,.06);--input-bg:#fafafa;--modal-overlay:rgba(0,0,0,.45);
}
body.dark{
  --bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#222;--bg-hover:#2a2a2a;
  --border:#333;--text-primary:#f0f0f0;--text-secondary:#999;
  --accent:#DC2626;--accent-hover:#EF4444;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.15);--accent-glow2:rgba(220,38,38,.08);
  --shadow:0 2px 12px rgba(0,0,0,.3);--input-bg:#1a1a1a;--modal-overlay:rgba(0,0,0,.75);
}
html{background:var(--bg-primary);scrollbar-gutter:stable;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;padding-bottom:120px;}

/* ===== HEADER ===== */
.desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border);}
.header-top{padding:10px 24px;display:flex;justify-content:space-between;align-items:center;}
.header-left{display:flex;align-items:center;gap:20px;}
.header-logo{height:72px;object-fit:contain;}
.header-titles h1{font-size:28px;font-weight:700;letter-spacing:-.3px;}
.header-titles .sub{font-size:12px;color:var(--accent);font-weight:600;letter-spacing:.3px;}
.header-right{display:flex;align-items:center;}
.header-right-col{display:flex;flex-direction:column;align-items:center;gap:4px;}
.header-right-links{display:flex;align-items:center;gap:10px;}
.dark-toggle{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.dark-toggle:hover{border-color:var(--accent);color:var(--accent);}
.dark-toggle svg{width:14px;height:14px;fill:currentColor;}
.logout-link{color:var(--text-secondary);cursor:pointer;font-size:12px;text-decoration:none;transition:color .2s;font-weight:500;}
.logout-link:hover{color:var(--accent);}
.settings-link{color:var(--text-secondary);cursor:pointer;font-size:12px;text-decoration:none;transition:color .2s;font-weight:500;}
.settings-link:hover{color:var(--accent);}
.nav-bar{display:flex;justify-content:space-between;align-items:center;padding:0 24px;margin-top:-4px;}
.nav-left{display:flex;gap:2px;}
.nav-right-controls{display:flex;align-items:center;gap:12px;}
.nav-btn{padding:8px 18px;font-size:13px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;}
.nav-btn:hover{color:var(--accent);}
.nav-btn.active{color:var(--accent);border-bottom-color:var(--accent);}

/* ===== MOBILE ===== */
.mobile-header{display:none;padding:12px 16px;background:var(--bg-primary);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
.mobile-header-row{display:flex;justify-content:space-between;align-items:center;}
.mobile-logo{height:28px;}
.mobile-right{display:flex;gap:8px;align-items:center;}
.mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);padding:8px 8px calc(8px + env(safe-area-inset-bottom));z-index:200;}
.m-nav-top{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;}
.m-nav-bot{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:4px;}
.m-nav-btn{text-align:center;padding:8px 4px;font-size:11px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-radius:8px;background:var(--bg-hover);transition:all .2s;}
.m-nav-btn:hover,.m-nav-btn.active{background:var(--accent);color:#fff;}

/* ===== SETTINGS LAYOUT ===== */
.settings-wrap{max-width:960px;margin:0 auto;padding:32px 24px 24px;display:flex;gap:24px;}
.settings-nav{width:200px;flex-shrink:0;position:sticky;top:120px;align-self:flex-start;}
.settings-nav-item{display:block;padding:10px 14px;font-size:13px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-radius:8px;cursor:pointer;transition:all .2s;margin-bottom:2px;}
.settings-nav-item:hover{background:var(--bg-hover);color:var(--text-primary);}
.settings-nav-item.active{background:var(--accent-glow);color:var(--accent);border-left:3px solid var(--accent);}
.settings-body{flex:1;min-width:0;}

/* ===== SETTINGS SECTIONS ===== */
.settings-section{display:none;animation:fadeIn .2s;}
.settings-section.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.section-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:20px;box-shadow:var(--shadow);}
body.dark .section-card{border-color:#2a2a2a;box-shadow:none;}
body.dark .template-item{border-color:#2a2a2a;}
.section-card-title{font-size:16px;font-weight:700;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.section-card-desc{font-size:13px;color:var(--text-secondary);margin-bottom:16px;}

/* ===== FORMS ===== */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;}
.form-input,.form-textarea,.form-select{width:100%;padding:10px 14px;font-size:14px;border:1px solid var(--border);border-radius:8px;background:var(--input-bg);color:var(--text-primary);font-family:inherit;transition:border-color .2s;}
.form-input:focus,.form-textarea:focus,.form-select:focus{outline:none;border-color:var(--accent);}
.form-textarea{resize:vertical;min-height:80px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-hint{font-size:11px;color:var(--text-secondary);margin-top:4px;}
.btn-primary{background:var(--accent);color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary:hover{background:var(--accent-hover);}
.btn-secondary{background:var(--bg-hover);color:var(--text-primary);border:1px solid var(--border);padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:#DC2626;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-danger:hover{background:#B91C1C;}
.btn-sm{padding:6px 14px;font-size:12px;}
.btn-row{display:flex;gap:10px;margin-top:16px;}

/* ===== TEAM TABLE ===== */
.team-table{width:100%;border-collapse:collapse;font-size:13px;}
.team-table th{text-align:left;font-weight:600;color:var(--text-secondary);font-size:11px;text-transform:uppercase;letter-spacing:.5px;padding:8px 12px;border-bottom:2px solid var(--border);}
.team-table td{padding:10px 12px;border-bottom:1px solid var(--border);}
.team-table tr:last-child td{border-bottom:none;}
.team-table tr:hover td{background:var(--bg-hover);}
.role-badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;text-transform:capitalize;}
.role-badge.owner{background:rgba(220,38,38,.1);color:#DC2626;}
.role-badge.admin{background:rgba(59,130,246,.1);color:#3B82F6;}
.role-badge.member{background:rgba(107,114,128,.1);color:#6B7280;}

/* ===== TEMPLATE BUILDER ===== */
.template-list{display:flex;flex-direction:column;gap:8px;}
.template-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg-hover);border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:all .2s;}
.template-item:hover{border-color:var(--accent);}
.template-item-info{flex:1;}
.template-item-name{font-weight:700;font-size:14px;}
.template-item-meta{font-size:12px;color:var(--text-secondary);margin-top:2px;}
.template-item-actions{display:flex;gap:6px;}
.template-empty{text-align:center;padding:40px;color:var(--text-secondary);font-size:14px;}

/* Template Editor */
.tpl-editor{display:none;}
.tpl-editor.active{display:block;}
.tpl-back{display:inline-flex;align-items:center;gap:6px;font-size:13px;font-weight:600;color:var(--text-secondary);cursor:pointer;margin-bottom:16px;transition:color .2s;}
.tpl-back:hover{color:var(--accent);}
.tpl-dept-list{margin-top:16px;}
.tpl-dept{background:var(--bg-hover);border:1px solid var(--border);border-radius:10px;margin-bottom:12px;overflow:hidden;}
.tpl-dept-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;font-weight:700;font-size:14px;}
.tpl-dept-header:hover{background:var(--bg-secondary);}
.tpl-dept-toggle{font-size:12px;color:var(--text-secondary);transition:transform .2s;}
.tpl-dept.open .tpl-dept-toggle{transform:rotate(90deg);}
.tpl-dept-body{display:none;padding:0 16px 12px;border-top:1px solid var(--border);}
.tpl-dept.open .tpl-dept-body{display:block;}
.tpl-task-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid color-mix(in srgb,var(--border) 50%,transparent);}
.tpl-task-row:last-child{border-bottom:none;}
.tpl-task-title{flex:1;font-size:13px;}
.tpl-task-cost{font-size:12px;color:var(--text-secondary);width:70px;text-align:right;}
.tpl-task-del{width:24px;height:24px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;border-radius:4px;font-size:14px;display:flex;align-items:center;justify-content:center;}
.tpl-task-del:hover{background:rgba(220,38,38,.1);color:#DC2626;}
.tpl-add-row{display:flex;gap:8px;margin-top:8px;}
.tpl-add-row input{flex:1;padding:6px 10px;font-size:13px;border:1px solid var(--border);border-radius:6px;background:var(--input-bg);color:var(--text-primary);}
.tpl-add-row input:focus{outline:none;border-color:var(--accent);}
.tpl-add-row button{padding:6px 12px;border-radius:6px;border:none;background:var(--accent);color:#fff;font-size:12px;font-weight:600;cursor:pointer;}
.tpl-dept-count{font-size:12px;color:var(--text-secondary);font-weight:400;margin-left:8px;}

/* ===== TOGGLE SWITCH ===== */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);}
.toggle-row:last-child{border-bottom:none;}
.toggle-label{font-size:14px;font-weight:500;}
.toggle-desc{font-size:12px;color:var(--text-secondary);margin-top:2px;}
.toggle-switch{position:relative;width:44px;height:24px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:12px;cursor:pointer;transition:all .2s;}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:3px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
.toggle-switch input:checked+.toggle-slider{background:var(--accent);}
.toggle-switch input:checked+.toggle-slider::before{transform:translateX(20px);}

/* ===== PLAN CARD ===== */
.plan-card{display:flex;align-items:center;justify-content:space-between;padding:20px;background:var(--accent-glow);border:1px solid var(--accent);border-radius:12px;}
.plan-info .plan-name{font-size:18px;font-weight:700;color:var(--accent);}
.plan-info .plan-detail{font-size:13px;color:var(--text-secondary);margin-top:4px;}

/* ===== MODAL ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:var(--modal-overlay);z-index:500;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-content{background:var(--bg-card);border-radius:14px;width:90%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border);}
.modal-title{font-size:18px;font-weight:700;}
.modal-close{background:none;border:none;font-size:24px;color:var(--text-secondary);cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all .2s;}
.modal-close:hover{background:var(--bg-hover);color:var(--accent);}
.modal-body{padding:24px;}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--text-primary);color:var(--bg-card);padding:10px 24px;border-radius:8px;font-size:13px;font-weight:600;opacity:0;transition:all .3s;z-index:9999;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ===== FOOTER ===== */
.footer-bar{padding:20px 24px;text-align:center;border-top:1px solid var(--border);margin-top:40px;}
.footer-powered{display:flex;align-items:center;justify-content:center;gap:6px;font-size:12px;color:var(--text-secondary);margin-bottom:4px;}
.footer-powered img{height:16px;}
.footer-powered a{color:var(--accent);text-decoration:none;}
.footer-copy{font-size:11px;color:var(--text-secondary);}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .desktop-header{display:none;}
  .mobile-header{display:block;}
  .mobile-bottom-nav{display:block;}
  .settings-wrap{flex-direction:column;padding:16px;}
  .settings-nav{width:100%;position:static;display:flex;overflow-x:auto;gap:4px;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:16px;}
  .settings-nav-item{white-space:nowrap;margin-bottom:0;border-left:none!important;padding:8px 12px;}
  .settings-nav-item.active{border-left:none!important;border-bottom:3px solid var(--accent);}
  .form-row{grid-template-columns:1fr;}
  .team-table{font-size:12px;}
  .team-table th,.team-table td{padding:8px 8px;}
  body{padding-bottom:140px;}
}
  </style>
</head>
<body>

<!-- DESKTOP HEADER -->
<div class="desktop-header">
  <div class="header-top">
    <div class="header-left">
      <div class="header-titles">
        <h1>Settings</h1>
        <div class="sub" id="headerEmail"></div>
      </div>
    </div>
    <img src="eventlogicpro-logo.png" alt="Event Logic Pro" class="header-logo" id="headerLogo">
  </div>
  <div class="nav-bar">
    <div class="nav-left">
      <a href="eventlogicpro-dashboard.html" class="nav-btn">Dashboard</a>
      <a href="eventlogicpro-calendar.html" class="nav-btn">Calendar</a>
      <a href="eventlogicpro.html" class="nav-btn">Tasks</a>
      <a href="eventlogicpro-budget.html" class="nav-btn">Budget</a>
      <a href="eventlogicpro-sponsors.html" class="nav-btn">Packages</a>
      <a href="eventlogicpro-contacts.html" class="nav-btn">Contacts</a>
      <a href="eventlogicpro-sitemap.html" class="nav-btn">Site Maps</a>
    </div>
    <div class="nav-right-controls">
      <button class="dark-toggle" onclick="toggleDark()" title="Toggle dark mode">
        <svg id="dMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>
        <svg id="dSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </button>
      <a href="eventlogicpro-settings.html" class="settings-link" style="color:var(--accent);">Settings</a>
      <a class="logout-link" onclick="doLogout()">Logout</a>
    </div>
  </div>
</div>

<!-- MOBILE HEADER -->
<div class="mobile-header">
  <div class="mobile-header-row">
    <img src="eventlogicpro-logo.png" alt="Event Logic Pro" class="mobile-logo" id="mHeaderLogo">
    <div class="mobile-right">
      <button class="dark-toggle" onclick="toggleDark()">
        <svg id="mMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>
        <svg id="mSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </button>
      <a class="logout-link" onclick="doLogout()">Logout</a>
    </div>
  </div>
</div>

<!-- SETTINGS LAYOUT -->
<div class="settings-wrap">
  <nav class="settings-nav">
    <a class="settings-nav-item active" onclick="showSection('profile')">Profile</a>
    <a class="settings-nav-item" onclick="showSection('team')">Team</a>
    <a class="settings-nav-item" onclick="showSection('templates')">Templates</a>
    <a class="settings-nav-item" onclick="showSection('preferences')">Preferences</a>
    <a class="settings-nav-item" onclick="showSection('billing')">Billing</a>
  </nav>

  <div class="settings-body">

    <!-- PROFILE -->
    <div class="settings-section active" id="sec-profile">
      <div class="section-card">
        <div class="section-card-title">Profile Information</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">First Name</label>
            <input type="text" class="form-input" id="profFirst">
          </div>
          <div class="form-group">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-input" id="profLast">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="profEmail" disabled style="opacity:.6;">
          <div class="form-hint">Email cannot be changed here. Contact support.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="tel" class="form-input" id="profPhone" placeholder="(555) 555-5555">
        </div>
        <div class="form-group">
          <label class="form-label">Title / Role</label>
          <input type="text" class="form-input" id="profTitle" placeholder="e.g. Technical Director">
        </div>
        <div class="btn-row">
          <button class="btn-primary" onclick="saveProfile()">Save Changes</button>
        </div>
      </div>
      <div class="section-card">
        <div class="section-card-title">Change Password</div>
        <div class="form-group">
          <label class="form-label">New Password</label>
          <input type="password" class="form-input" id="profNewPw" placeholder="Minimum 8 characters">
        </div>
        <div class="form-group">
          <label class="form-label">Confirm Password</label>
          <input type="password" class="form-input" id="profConfPw" placeholder="Re-enter new password">
        </div>
        <div class="btn-row">
          <button class="btn-secondary" onclick="changePassword()">Update Password</button>
        </div>
      </div>
    </div>

    <!-- TEAM -->
    <div class="settings-section" id="sec-team">
      <div class="section-card">
        <div class="section-card-title" style="display:flex;justify-content:space-between;align-items:center;">
          Team Members
          <button class="btn-primary btn-sm" onclick="openInviteModal()">+ Invite</button>
        </div>
        <div id="teamTableWrap">
          <table class="team-table">
            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th></tr></thead>
            <tbody id="teamTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TEMPLATES -->
    <div class="settings-section" id="sec-templates">
      <div id="templateListView">
        <div class="section-card">
          <div class="section-card-title" style="display:flex;justify-content:space-between;align-items:center;">
            Event Templates
            <button class="btn-primary btn-sm" onclick="openNewTemplateModal()">+ New Template</button>
          </div>
          <div class="section-card-desc">Templates pre-load departments and tasks when creating new events. Build templates for different event types.</div>
          <div class="template-list" id="templateList"></div>
        </div>
      </div>
      <div class="tpl-editor" id="tplEditor">
        <div class="tpl-back" onclick="closeTemplateEditor()">&#9664; Back to Templates</div>
        <div class="section-card">
          <div class="section-card-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span id="tplEditorTitle">Edit Template</span>
            <div style="display:flex;gap:8px;">
              <button class="btn-secondary btn-sm" onclick="openAddDeptModal()">+ Department</button>
              <button class="btn-danger btn-sm" onclick="deleteTemplate()">Delete Template</button>
            </div>
          </div>
          <div class="form-row" style="margin-bottom:16px;">
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label">Template Name</label>
              <input type="text" class="form-input" id="tplNameEdit">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label">Description</label>
              <input type="text" class="form-input" id="tplDescEdit">
            </div>
          </div>
          <button class="btn-primary btn-sm" onclick="saveTemplateMeta()" style="margin-bottom:20px;">Save Details</button>
          <div class="tpl-dept-list" id="tplDeptList"></div>
        </div>
      </div>
    </div>

    <!-- PREFERENCES -->
    <div class="settings-section" id="sec-preferences">
      <div class="section-card">
        <div class="section-card-title">Display</div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label">Dark Mode</div>
            <div class="toggle-desc">Use dark theme across all pages</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="prefDark" onchange="toggleDarkPref()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label">Default Landing Page</div>
            <div class="toggle-desc">Where to go after login</div>
          </div>
          <select class="form-select" id="prefLanding" style="width:180px;" onchange="savePrefLanding()">
            <option value="dashboard">Dashboard</option>
            <option value="tasks">Tasks</option>
            <option value="calendar">Calendar</option>
          </select>
        </div>
      </div>
      <div class="section-card">
        <div class="section-card-title">Notifications</div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label">Email Notifications</div>
            <div class="toggle-desc">Receive email alerts for task assignments and deadlines</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="prefEmailNotif" onchange="savePref('email_notifications',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label">Team Activity</div>
            <div class="toggle-desc">Get notified when team members update tasks or budgets</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="prefTeamNotif" onchange="savePref('team_notifications',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <div>
            <div class="toggle-label">Budget Alerts</div>
            <div class="toggle-desc">Alert when event spending approaches budget limit</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="prefBudgetAlert" onchange="savePref('budget_alerts',this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- BILLING -->
    <div class="settings-section" id="sec-billing">
      <div class="section-card">
        <div class="section-card-title">Current Plan</div>
        <div class="plan-card">
          <div class="plan-info">
            <div class="plan-name" id="planName">Free Plan</div>
            <div class="plan-detail" id="planDetail">2 seats included (owner + 1 member)</div>
          </div>
          <button class="btn-primary" onclick="toast('Stripe billing coming soon')">Upgrade</button>
        </div>
      </div>
      <div class="section-card">
        <div class="section-card-title">Usage</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;text-align:center;">
          <div>
            <div style="font-size:24px;font-weight:800;" id="billSeats">-</div>
            <div style="font-size:12px;color:var(--text-secondary);">Team Seats</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:800;" id="billEvents">-</div>
            <div style="font-size:12px;color:var(--text-secondary);">Active Events</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:800;" id="billTemplates">-</div>
            <div style="font-size:12px;color:var(--text-secondary);">Templates</div>
          </div>
        </div>
      </div>
      <div class="section-card">
        <div class="section-card-title">Billing Details</div>
        <div class="section-card-desc">Stripe integration coming in Phase 6. $5/seat/month for additional team members beyond the free tier.</div>
      </div>
    </div>

  </div>
</div>

<!-- FOOTER -->
<div class="footer-bar">
  <div class="footer-powered">
    <span>Powered by</span>
    <img src="glowbot.png" alt="GlowBot">
    <a href="https://glowbotslive.com" target="_blank">GlowBotsLive.com</a>
  </div>
  <div class="footer-copy">&copy; 2026 Event Logic Pro. All rights reserved.</div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-bottom-nav">
  <div class="m-nav-top">
    <a href="eventlogicpro-dashboard.html" class="m-nav-btn">Dashboard</a>
    <a href="eventlogicpro-calendar.html" class="m-nav-btn">Calendar</a>
    <a href="eventlogicpro.html" class="m-nav-btn">Tasks</a>
    <a href="eventlogicpro-budget.html" class="m-nav-btn">Budget</a>
  </div>
  <div class="m-nav-bot">
    <a href="eventlogicpro-sponsors.html" class="m-nav-btn">Packages</a>
    <a href="eventlogicpro-contacts.html" class="m-nav-btn">Contacts</a>
    <a href="eventlogicpro-sitemap.html" class="m-nav-btn">Site Maps</a>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="modal-overlay" id="inviteModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">Invite Team Member</div><button class="modal-close" onclick="closeInviteModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Email *</label><input type="email" class="form-input" id="invEmail" placeholder="name@example.com"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name</label><input type="text" class="form-input" id="invFirst"></div>
        <div class="form-group"><label class="form-label">Last Name</label><input type="text" class="form-input" id="invLast"></div>
      </div>
      <div class="form-group"><label class="form-label">Role</label><select class="form-select" id="invRole"><option value="member">Member</option><option value="admin">Admin</option></select></div>
    </div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeInviteModal()">Cancel</button><button class="btn-primary" onclick="sendInvite()">Send Invite</button></div>
  </div>
</div>

<!-- NEW TEMPLATE MODAL -->
<div class="modal-overlay" id="newTplModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Template</div><button class="modal-close" onclick="closeNewTplModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Template Name *</label><input type="text" class="form-input" id="newTplName" placeholder="e.g. Music Festival, Corporate Gala, 5K Run"></div>
      <div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="newTplDesc" placeholder="Brief description"></div>
      <div class="form-group"><label class="form-label">Copy From</label><select class="form-select" id="newTplCopy"><option value="">-- Start blank --</option></select><div class="form-hint">Copy departments and tasks from an existing event or template</div></div>
    </div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeNewTplModal()">Cancel</button><button class="btn-primary" onclick="createTemplate()">Create</button></div>
  </div>
</div>

<!-- ADD DEPT MODAL -->
<div class="modal-overlay" id="addDeptModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">Add Department</div><button class="modal-close" onclick="closeAddDeptModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Department Name *</label><input type="text" class="form-input" id="addDeptName" placeholder="e.g. Stage, Sound, Security"></div>
    </div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeAddDeptModal()">Cancel</button><button class="btn-primary" onclick="addDeptToTemplate()">Add</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== DARK MODE ===== */
var isDark=localStorage.getItem('elp_dark_mode')==='true';
if(isDark)document.body.classList.add('dark');
function applyDarkIcons(){
  var d=document.body.classList.contains('dark');
  ['d','m'].forEach(function(p){var moon=document.getElementById(p+'Moon'),sun=document.getElementById(p+'Sun');if(moon)moon.style.display=d?'none':'block';if(sun)sun.style.display=d?'block':'none';});
  var logo=document.getElementById('headerLogo');if(logo)logo.src=d?'eventlogicpro-logo-dark.png':'eventlogicpro-logo.png';
  var mLogo=document.getElementById('mHeaderLogo');if(mLogo)mLogo.src=d?'eventlogicpro-logo-dark.png':'eventlogicpro-logo.png';
  var cb=document.getElementById('prefDark');if(cb)cb.checked=d;
}
applyDarkIcons();
function toggleDark(){document.body.classList.toggle('dark');isDark=document.body.classList.contains('dark');localStorage.setItem('elp_dark_mode',isDark);applyDarkIcons();}
function toggleDarkPref(){toggleDark();}

/* ===== SUPABASE ===== */
var SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
var tenantId=null,userId=null,userEmail=null;
var allTeamMembers=[],allTemplates=[],allProjects=[];
var editingTemplateId=null,tplDepts=[],tplTasks={};

function toast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2500);}
async function doLogout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');location.replace('/');}
async function checkAuth(){var r=await sb.auth.getSession();var s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){location.replace('/');return null;}}return s;}

/* ===== SECTION NAV ===== */
function showSection(id){
  document.querySelectorAll('.settings-section').forEach(function(s){s.classList.remove('active');});
  document.querySelectorAll('.settings-nav-item').forEach(function(n){n.classList.remove('active');});
  var sec=document.getElementById('sec-'+id);if(sec)sec.classList.add('active');
  event.target.classList.add('active');
}

/* ===== INIT ===== */
async function init(){
  var session=await checkAuth();if(!session)return;
  userId=session.user.id;userEmail=session.user.email;
  document.getElementById('headerEmail').textContent=userEmail;
  document.getElementById('profEmail').value=userEmail;

  var ur=await sb.from('users').select('tenant_id').eq('email',userEmail).single();
  tenantId=ur.data?.tenant_id;
  if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();tenantId=bs.data?.tenant_id;}
  if(!tenantId){toast('Cannot determine tenant');return;}

  await Promise.all([loadProfile(),loadTeam(),loadTemplates(),loadProjects()]);
  renderTeam();renderTemplateList();renderBilling();
  document.getElementById('prefDark').checked=isDark;
  document.getElementById('prefLanding').value=localStorage.getItem('elp_landing')||'dashboard';
}

/* ===== PROFILE ===== */
async function loadProfile(){
  var r=await sb.from('event_members').select('*').eq('tenant_id',tenantId).eq('email',userEmail).single();
  if(r.data){
    document.getElementById('profFirst').value=r.data.first_name||'';
    document.getElementById('profLast').value=r.data.last_name||'';
    document.getElementById('profPhone').value=r.data.phone||'';
    document.getElementById('profTitle').value=r.data.title||'';
  }
}
async function saveProfile(){
  var data={first_name:document.getElementById('profFirst').value.trim(),last_name:document.getElementById('profLast').value.trim(),phone:document.getElementById('profPhone').value.trim(),title:document.getElementById('profTitle').value.trim()};
  await sb.from('event_members').update(data).eq('tenant_id',tenantId).eq('email',userEmail);
  toast('Profile saved');
}
async function changePassword(){
  var pw=document.getElementById('profNewPw').value,cpw=document.getElementById('profConfPw').value;
  if(!pw||pw.length<8){toast('Password must be at least 8 characters');return;}
  if(pw!==cpw){toast('Passwords do not match');return;}
  var r=await sb.auth.updateUser({password:pw});
  if(r.error){toast('Error: '+r.error.message);return;}
  document.getElementById('profNewPw').value='';document.getElementById('profConfPw').value='';
  toast('Password updated');
}

/* ===== TEAM ===== */
async function loadTeam(){
  var r=await sb.from('event_team_members').select('*, users!event_team_members_user_id_fkey(email)').eq('team_id',(await getTeamId()));
  allTeamMembers=r.data||[];
  // Fallback: load from event_members
  if(!allTeamMembers.length){
    var r2=await sb.from('event_members').select('*').eq('tenant_id',tenantId).order('first_name');
    allTeamMembers=r2.data||[];
  }
}
async function getTeamId(){
  var r=await sb.from('event_team_members').select('team_id').eq('user_id',userId).limit(1).single();
  return r.data?.team_id||null;
}
function renderTeam(){
  var tb=document.getElementById('teamTableBody');
  // Try event_members format
  var r=allTeamMembers;if(!r.length){tb.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);padding:20px;">No team members</td></tr>';return;}
  tb.innerHTML='';
  r.forEach(function(m){
    var name=((m.first_name||'')+(m.last_name?' '+m.last_name:'')).trim()||m.email||'—';
    var email=m.email||m.users?.email||'—';
    var role=m.role||m.role_level||'member';
    var active=m.is_active!==false;
    tb.innerHTML+='<tr><td><strong>'+esc(name)+'</strong></td><td>'+esc(email)+'</td><td><span class="role-badge '+role+'">'+role+'</span></td><td>'+(active?'Active':'Inactive')+'</td></tr>';
  });
}
function openInviteModal(){document.getElementById('invEmail').value='';document.getElementById('invFirst').value='';document.getElementById('invLast').value='';document.getElementById('invRole').value='member';document.getElementById('inviteModal').classList.add('show');}
function closeInviteModal(){document.getElementById('inviteModal').classList.remove('show');}
async function sendInvite(){
  var email=document.getElementById('invEmail').value.trim();if(!email){toast('Email required');return;}
  var data={tenant_id:tenantId,email:email,first_name:document.getElementById('invFirst').value.trim()||null,last_name:document.getElementById('invLast').value.trim()||null,role_level:document.getElementById('invRole').value,is_active:true};
  var r=await sb.from('event_members').insert(data);
  if(r.error){toast('Error: '+r.error.message);return;}
  closeInviteModal();toast('Member added');await loadTeam();renderTeam();
}

/* ===== TEMPLATES ===== */
async function loadTemplates(){
  var r=await sb.from('event_template_groups').select('*').eq('tenant_id',tenantId).order('template_name');
  allTemplates=r.data||[];
}
async function loadProjects(){
  var r=await sb.from('event_projects').select('event_project_id,event_name').eq('tenant_id',tenantId).order('event_name');
  allProjects=r.data||[];
}
function renderTemplateList(){
  var el=document.getElementById('templateList');
  if(!allTemplates.length){el.innerHTML='<div class="template-empty">No templates yet. Create one to get started.</div>';return;}
  var h='';
  allTemplates.forEach(function(t){
    h+='<div class="template-item" onclick="openTemplateEditor(\''+t.template_group_id+'\')">';
    h+='<div class="template-item-info"><div class="template-item-name">'+esc(t.template_name)+'</div>';
    h+='<div class="template-item-meta">'+(t.description||'No description')+'</div></div>';
    h+='<div class="template-item-actions"><button class="btn-secondary btn-sm" onclick="event.stopPropagation();openTemplateEditor(\''+t.template_group_id+'\')">Edit</button></div>';
    h+='</div>';
  });
  el.innerHTML=h;
  document.getElementById('billTemplates').textContent=allTemplates.length;
}

function openNewTemplateModal(){
  document.getElementById('newTplName').value='';document.getElementById('newTplDesc').value='';
  var sel=document.getElementById('newTplCopy');
  sel.innerHTML='<option value="">-- Start blank --</option>';
  allTemplates.forEach(function(t){sel.innerHTML+='<option value="tpl:'+t.template_group_id+'">Template: '+t.template_name+'</option>';});
  allProjects.forEach(function(p){sel.innerHTML+='<option value="evt:'+p.event_project_id+'">Event: '+p.event_name+'</option>';});
  document.getElementById('newTplModal').classList.add('show');
}
function closeNewTplModal(){document.getElementById('newTplModal').classList.remove('show');}

async function createTemplate(){
  var name=document.getElementById('newTplName').value.trim();if(!name){toast('Name required');return;}
  var desc=document.getElementById('newTplDesc').value.trim();
  var copyVal=document.getElementById('newTplCopy').value;

  var r=await sb.from('event_template_groups').insert({tenant_id:tenantId,template_name:name,description:desc||null,created_by:userId}).select().single();
  if(r.error){toast('Error: '+r.error.message);return;}
  var newId=r.data.template_group_id;

  if(copyVal){
    var parts=copyVal.split(':');var type=parts[0],srcId=parts[1];
    if(type==='tpl')await copyFromTemplate(newId,srcId);
    else if(type==='evt')await copyFromEvent(newId,srcId);
  }

  closeNewTplModal();toast('Template created');await loadTemplates();renderTemplateList();
  openTemplateEditor(newId);
}

async function copyFromTemplate(newGroupId,srcGroupId){
  var dr=await sb.from('event_template_departments').select('*').eq('template_group_id',srcGroupId).order('sort_order');
  for(var i=0;i<(dr.data||[]).length;i++){
    var d=dr.data[i];
    var nd=await sb.from('event_template_departments').insert({template_group_id:newGroupId,department_name:d.department_name,sort_order:d.sort_order,budget:d.budget}).select().single();
    if(!nd.data)continue;
    var tr=await sb.from('event_template_tasks').select('*').eq('template_dept_id',d.template_dept_id).order('sort_order');
    var tasks=(tr.data||[]).map(function(t){return{template_dept_id:nd.data.template_dept_id,template_group_id:newGroupId,task_title:t.task_title,cost:t.cost,timing:t.timing,notes:t.notes,sort_order:t.sort_order};});
    if(tasks.length)await sb.from('event_template_tasks').insert(tasks);
  }
}
async function copyFromEvent(newGroupId,eventId){
  var dr=await sb.from('event_departments').select('*').eq('event_project_id',eventId).order('sort_order');
  for(var i=0;i<(dr.data||[]).length;i++){
    var d=dr.data[i];
    var nd=await sb.from('event_template_departments').insert({template_group_id:newGroupId,department_name:d.department_name,sort_order:d.sort_order,budget:d.budget}).select().single();
    if(!nd.data)continue;
    var tr=await sb.from('event_tasks').select('*').eq('event_department_id',d.event_department_id).order('sort_order');
    var tasks=(tr.data||[]).map(function(t){return{template_dept_id:nd.data.template_dept_id,template_group_id:newGroupId,task_title:t.task_title,cost:t.cost,timing:t.timing,notes:t.notes,sort_order:t.sort_order};});
    if(tasks.length)await sb.from('event_template_tasks').insert(tasks);
  }
}

/* ===== TEMPLATE EDITOR ===== */
async function openTemplateEditor(id){
  editingTemplateId=id;
  var tpl=allTemplates.find(function(t){return t.template_group_id===id;});
  if(!tpl)return;
  document.getElementById('tplEditorTitle').textContent=tpl.template_name;
  document.getElementById('tplNameEdit').value=tpl.template_name;
  document.getElementById('tplDescEdit').value=tpl.description||'';
  document.getElementById('templateListView').style.display='none';
  document.getElementById('tplEditor').classList.add('active');
  await loadTemplateDepts();renderTemplateDepts();
}
function closeTemplateEditor(){
  document.getElementById('tplEditor').classList.remove('active');
  document.getElementById('templateListView').style.display='block';
  editingTemplateId=null;
}
async function saveTemplateMeta(){
  var name=document.getElementById('tplNameEdit').value.trim();if(!name){toast('Name required');return;}
  await sb.from('event_template_groups').update({template_name:name,description:document.getElementById('tplDescEdit').value.trim()||null}).eq('template_group_id',editingTemplateId);
  toast('Saved');await loadTemplates();
  document.getElementById('tplEditorTitle').textContent=name;
}
async function deleteTemplate(){
  if(!confirm('Delete this template and all its departments/tasks?'))return;
  await sb.from('event_template_tasks').delete().eq('template_group_id',editingTemplateId);
  await sb.from('event_template_departments').delete().eq('template_group_id',editingTemplateId);
  await sb.from('event_template_groups').delete().eq('template_group_id',editingTemplateId);
  closeTemplateEditor();toast('Template deleted');await loadTemplates();renderTemplateList();
}

async function loadTemplateDepts(){
  var r=await sb.from('event_template_departments').select('*').eq('template_group_id',editingTemplateId).order('sort_order');
  tplDepts=r.data||[];tplTasks={};
  for(var i=0;i<tplDepts.length;i++){
    var d=tplDepts[i];
    var tr=await sb.from('event_template_tasks').select('*').eq('template_dept_id',d.template_dept_id).order('sort_order');
    tplTasks[d.template_dept_id]=tr.data||[];
  }
}
function renderTemplateDepts(){
  var el=document.getElementById('tplDeptList');
  if(!tplDepts.length){el.innerHTML='<div class="template-empty">No departments yet. Click "+ Department" to add one.</div>';return;}
  var h='';
  tplDepts.forEach(function(d){
    var tasks=tplTasks[d.template_dept_id]||[];
    h+='<div class="tpl-dept" id="dept-'+d.template_dept_id+'">';
    h+='<div class="tpl-dept-header" onclick="toggleDept(\''+d.template_dept_id+'\')">';
    h+='<span>'+esc(d.department_name)+'<span class="tpl-dept-count">('+tasks.length+' tasks)</span></span>';
    h+='<div style="display:flex;align-items:center;gap:8px;"><button class="btn-danger btn-sm" onclick="event.stopPropagation();deleteDept(\''+d.template_dept_id+'\')">Delete</button><span class="tpl-dept-toggle">&#9654;</span></div>';
    h+='</div><div class="tpl-dept-body">';
    tasks.forEach(function(t){
      h+='<div class="tpl-task-row"><div class="tpl-task-title">'+esc(t.task_title)+'</div>';
      h+='<div class="tpl-task-cost">'+(t.cost?'$'+parseFloat(t.cost).toFixed(0):'')+'</div>';
      h+='<button class="tpl-task-del" onclick="deleteTask(\''+t.template_task_id+'\',\''+d.template_dept_id+'\')">&times;</button></div>';
    });
    h+='<div class="tpl-add-row"><input type="text" placeholder="New task title" id="newTask-'+d.template_dept_id+'"><input type="number" placeholder="Cost" style="width:80px;flex:none;" id="newTaskCost-'+d.template_dept_id+'"><button onclick="addTask(\''+d.template_dept_id+'\')">Add</button></div>';
    h+='</div></div>';
  });
  el.innerHTML=h;
}
function toggleDept(id){document.getElementById('dept-'+id).classList.toggle('open');}

function openAddDeptModal(){document.getElementById('addDeptName').value='';document.getElementById('addDeptModal').classList.add('show');}
function closeAddDeptModal(){document.getElementById('addDeptModal').classList.remove('show');}
async function addDeptToTemplate(){
  var name=document.getElementById('addDeptName').value.trim();if(!name){toast('Name required');return;}
  var maxSort=0;tplDepts.forEach(function(d){if(d.sort_order>maxSort)maxSort=d.sort_order;});
  await sb.from('event_template_departments').insert({template_group_id:editingTemplateId,department_name:name,sort_order:maxSort+1});
  closeAddDeptModal();toast('Department added');await loadTemplateDepts();renderTemplateDepts();
}
async function deleteDept(id){
  if(!confirm('Delete this department and its tasks?'))return;
  await sb.from('event_template_tasks').delete().eq('template_dept_id',id);
  await sb.from('event_template_departments').delete().eq('template_dept_id',id);
  toast('Deleted');await loadTemplateDepts();renderTemplateDepts();
}
async function addTask(deptId){
  var inp=document.getElementById('newTask-'+deptId);var cinp=document.getElementById('newTaskCost-'+deptId);
  var title=inp.value.trim();if(!title){toast('Task title required');return;}
  var tasks=tplTasks[deptId]||[];var maxSort=0;tasks.forEach(function(t){if(t.sort_order>maxSort)maxSort=t.sort_order;});
  await sb.from('event_template_tasks').insert({template_dept_id:deptId,template_group_id:editingTemplateId,task_title:title,cost:parseFloat(cinp.value)||0,sort_order:maxSort+1});
  inp.value='';cinp.value='';toast('Task added');
  var tr=await sb.from('event_template_tasks').select('*').eq('template_dept_id',deptId).order('sort_order');
  tplTasks[deptId]=tr.data||[];renderTemplateDepts();
  // Re-open the dept
  var el=document.getElementById('dept-'+deptId);if(el)el.classList.add('open');
}
async function deleteTask(taskId,deptId){
  await sb.from('event_template_tasks').delete().eq('template_task_id',taskId);
  var tr=await sb.from('event_template_tasks').select('*').eq('template_dept_id',deptId).order('sort_order');
  tplTasks[deptId]=tr.data||[];renderTemplateDepts();
  var el=document.getElementById('dept-'+deptId);if(el)el.classList.add('open');
}

/* ===== PREFERENCES ===== */
function savePrefLanding(){localStorage.setItem('elp_landing',document.getElementById('prefLanding').value);toast('Saved');}
function savePref(key,val){localStorage.setItem('elp_'+key,val);toast('Saved');}

/* ===== BILLING ===== */
function renderBilling(){
  document.getElementById('billSeats').textContent=allTeamMembers.length;
  document.getElementById('billEvents').textContent=allProjects.length;
  document.getElementById('billTemplates').textContent=allTemplates.length;
  if(allTeamMembers.length<=2){document.getElementById('planName').textContent='Free Plan';document.getElementById('planDetail').textContent=allTeamMembers.length+' of 2 free seats used';}
  else{document.getElementById('planName').textContent='Team Plan';document.getElementById('planDetail').textContent=allTeamMembers.length+' seats · $'+(Math.max(0,allTeamMembers.length-2)*5)+'/mo';}
}

/* ===== UTILS ===== */
function esc(s){if(!s)return '';var d=document.createElement('div');d.textContent=s;return d.innerHTML;}

/* ===== START ===== */
init();
</script>
</body>
</html>
