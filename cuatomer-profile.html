<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Customer Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="theme-system.css">
  <style>
    /* ===== INLINE THEME DEFINITIONS (26 themes) ===== */
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="grey"] { --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e; --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3; --accent-primary: #525252; --accent-light: #737373; }
    [data-theme="slate"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #6366f1; --accent-light: #818cf8; }
    [data-theme="charcoal"] { --bg-primary: #121214; --bg-secondary: #18181b; --bg-card: #27272a; --bg-hover: #3f3f46; --border-default: #3f3f46; --text-primary: #fafafa; --text-secondary: #a1a1aa; --accent-primary: #a1a1aa; --accent-light: #d4d4d8; }
    [data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="navy"] { --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45; --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd; --accent-primary: #4a7cc9; --accent-light: #6b9ae0; }
    [data-theme="graphite"] { --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929; --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999; --accent-primary: #4a9eff; --accent-light: #6bb3ff; }
    [data-theme="ocean"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="forest"] { --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24; --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="obsidian"] { --bg-primary: #050505; --bg-secondary: #0a0a0a; --bg-card: #141414; --bg-hover: #1c1c1c; --border-default: #252525; --text-primary: #e0e0e0; --text-secondary: #888888; --accent-primary: #0ea5e9; --accent-light: #38bdf8; }
    [data-theme="steel"] { --bg-primary: #0c0f13; --bg-secondary: #12161c; --bg-card: #1a2028; --bg-hover: #242c38; --border-default: #2c3644; --text-primary: #e4e8ed; --text-secondary: #8b95a5; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="espresso"] { --bg-primary: #0f0c0a; --bg-secondary: #161210; --bg-card: #211c18; --bg-hover: #2c2520; --border-default: #382f28; --text-primary: #f0ebe5; --text-secondary: #a89e94; --accent-primary: #a78b6e; --accent-light: #c4a88a; }
    [data-theme="onyx"] { --bg-primary: #000000; --bg-secondary: #080808; --bg-card: #121212; --bg-hover: #1a1a1a; --border-default: #222222; --text-primary: #f5f5f5; --text-secondary: #8c8c8c; --accent-primary: #06b6d4; --accent-light: #22d3ee; }
    [data-theme="light-blue"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #2563eb; --accent-light: #3b82f6; }
    [data-theme="light-grey"] { --bg-primary: #fafafa; --bg-secondary: #f5f5f5; --bg-card: #ffffff; --bg-hover: #e5e5e5; --border-default: #d4d4d4; --text-primary: #171717; --text-secondary: #525252; --accent-primary: #404040; --accent-light: #525252; }
    [data-theme="light-slate"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #4f46e5; --accent-light: #6366f1; }
    [data-theme="light-ocean"] { --bg-primary: #f0fdfa; --bg-secondary: #ccfbf1; --bg-card: #ffffff; --bg-hover: #99f6e4; --border-default: #5eead4; --text-primary: #134e4a; --text-secondary: #0f766e; --accent-primary: #0d9488; --accent-light: #14b8a6; }
    [data-theme="light-forest"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #166534; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="light-midnight"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #e9d5ff; --border-default: #d8b4fe; --text-primary: #1e1b4b; --text-secondary: #5b21b6; --accent-primary: #7c3aed; --accent-light: #8b5cf6; }
    [data-theme="light-obsidian"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #0369a1; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="light-espresso"] { --bg-primary: #fefcfb; --bg-secondary: #fdf4ef; --bg-card: #ffffff; --bg-hover: #f5e6db; --border-default: #ddc9b8; --text-primary: #3d2c1e; --text-secondary: #6b5344; --accent-primary: #8b6f4e; --accent-light: #a78b6e; }
    [data-theme="light-graphite"] { --bg-primary: #fafafa; --bg-secondary: #f5f5f5; --bg-card: #ffffff; --bg-hover: #ebebeb; --border-default: #d1d1d1; --text-primary: #1a1a1a; --text-secondary: #4a4a4a; --accent-primary: #2196f3; --accent-light: #42a5f5; }
    [data-theme="light-onyx"] { --bg-primary: #ecfeff; --bg-secondary: #cffafe; --bg-card: #ffffff; --bg-hover: #a5f3fc; --border-default: #67e8f9; --text-primary: #164e63; --text-secondary: #0e7490; --accent-primary: #0891b2; --accent-light: #06b6d4; }
    [data-theme="light-steel"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #1e293b; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; }
    [data-theme="light-navy"] { --bg-primary: #f0f4ff; --bg-secondary: #e0e7ff; --bg-card: #ffffff; --bg-hover: #c7d2fe; --border-default: #a5b4fc; --text-primary: #1e1b4b; --text-secondary: #3730a3; --accent-primary: #3949ab; --accent-light: #5c6bc0; }
    [data-theme="light-charcoal"] { --bg-primary: #fafafa; --bg-secondary: #f4f4f5; --bg-card: #ffffff; --bg-hover: #e4e4e7; --border-default: #d4d4d8; --text-primary: #18181b; --text-secondary: #52525b; --accent-primary: #71717a; --accent-light: #a1a1aa; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

    /* Mobile Header */
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; }
    .mobile-back-btn { background: transparent; border: none; color: var(--accent-light); font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 8px 0; }
    .mobile-header-center { flex: 1; text-align: center; }
    .mobile-header-title { font-size: 16px; font-weight: 600; }
    .mobile-header-actions-btn { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 8px; }

    /* Desktop Header */
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }

    /* Profile Header Card */
    .profile-header { background: var(--bg-card); padding: 20px; margin-bottom: 12px; }
    .profile-header-top { display: flex; gap: 16px; align-items: flex-start; }
    .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--bg-hover); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; color: var(--accent-light); flex-shrink: 0; overflow: hidden; border: 3px solid var(--accent-primary); }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .profile-info { flex: 1; min-width: 0; }
    .profile-name { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
    .profile-type { font-size: 12px; color: var(--accent-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .profile-contact { font-size: 14px; color: var(--text-secondary); }
    .profile-contact a { color: var(--accent-light); text-decoration: none; }
    .profile-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .profile-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .profile-badge.vip { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .profile-badge.at-risk { background: #dc2626; color: white; }
    .profile-badge.pre-approved { background: #16a34a; color: white; }
    .profile-badge.service { background: var(--accent-primary); color: white; }
    .profile-badge.sales { background: #8b5cf6; color: white; }

    /* Quick Stats Row */
    .profile-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-default); }
    .profile-stat { text-align: center; }
    .profile-stat-value { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .profile-stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

    /* Quick Actions */
    .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: var(--bg-secondary); margin-bottom: 12px; }
    .quick-action-btn { padding: 12px 8px; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); font-size: 11px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .quick-action-btn:hover { background: var(--bg-hover); border-color: var(--accent-primary); }
    .quick-action-btn svg { width: 20px; height: 20px; fill: var(--accent-light); }

    /* Tabs (Desktop) */
    .tab-nav { display: flex; gap: 4px; padding: 0 12px; background: var(--bg-secondary); overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .tab-btn { padding: 12px 16px; background: transparent; border: none; color: var(--text-secondary); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; }
    .tab-btn.active { color: var(--accent-light); border-bottom-color: var(--accent-primary); }
    .tab-btn:hover:not(.active) { color: var(--text-primary); }

    /* Section Headers (Mobile Accordions) */
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .section-header:hover { background: var(--bg-hover); }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    .section-header-title { font-size: 16px; font-weight: 700; color: var(--accent-light); display: flex; align-items: center; gap: 8px; }
    .section-header-count { background: var(--bg-hover); color: var(--text-secondary); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
    .section-header-icon { font-size: 18px; color: var(--text-secondary); transition: transform 0.2s; }
    .section-content { overflow: hidden; transition: max-height 0.3s ease; margin-bottom: 8px; }
    .section-content.collapsed { max-height: 0 !important; margin-bottom: 0; }
    .section-inner { background: var(--bg-card); border-radius: 8px; padding: 16px; }

    /* Tab Panels */
    .tab-panel { display: none; padding: 12px; }
    .tab-panel.active { display: block; }

    /* Info Rows */
    .info-group { margin-bottom: 20px; }
    .info-group-title { font-size: 13px; font-weight: 700; color: var(--accent-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-default); }
    .info-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid var(--border-default); }
    .info-row:last-child { border-bottom: none; }
    .info-label { font-size: 13px; color: var(--text-secondary); flex-shrink: 0; }
    .info-value { font-size: 14px; color: var(--text-primary); text-align: right; word-break: break-word; }
    .info-value a { color: var(--accent-light); text-decoration: none; }
    .info-value.positive { color: #4ade80; }
    .info-value.negative { color: #f87171; }

    /* Cards */
    .item-card { background: var(--bg-secondary); border-radius: 10px; padding: 14px; margin-bottom: 10px; border-left: 4px solid var(--accent-primary); cursor: pointer; transition: background 0.2s; }
    .item-card:hover { background: var(--bg-hover); }
    .item-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .item-card-title { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .item-card-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .item-card-badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .item-card-badge.active { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .item-card-badge.pending { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .item-card-badge.completed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
    .item-card-stats { display: flex; gap: 16px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-default); }
    .item-card-stat { font-size: 12px; }
    .item-card-stat-label { color: var(--text-secondary); }
    .item-card-stat-value { color: var(--text-primary); font-weight: 600; }

    /* Timeline */
    .timeline { position: relative; padding-left: 24px; }
    .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border-default); }
    .timeline-item { position: relative; padding-bottom: 20px; }
    .timeline-item:last-child { padding-bottom: 0; }
    .timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: var(--accent-primary); border: 2px solid var(--bg-card); }
    .timeline-content { background: var(--bg-secondary); border-radius: 8px; padding: 12px; }
    .timeline-date { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
    .timeline-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .timeline-desc { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

    /* Notes */
    .note-card { background: var(--bg-secondary); border-radius: 8px; padding: 14px; margin-bottom: 10px; border-left: 3px solid var(--accent-light); }
    .note-meta { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: var(--text-secondary); }
    .note-text { font-size: 14px; color: var(--text-primary); line-height: 1.5; }
    .add-note-btn { width: 100%; padding: 14px; border-radius: 8px; background: transparent; border: 2px dashed var(--border-default); color: var(--text-secondary); font-size: 14px; cursor: pointer; margin-top: 12px; }
    .add-note-btn:hover { border-color: var(--accent-primary); color: var(--accent-light); }

    /* AI Insights */
    .ai-card { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card)); border-radius: 10px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--accent-primary); }
    .ai-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .ai-card-icon { font-size: 24px; }
    .ai-card-title { font-size: 14px; font-weight: 700; color: var(--accent-light); }
    .ai-card-content { font-size: 14px; color: var(--text-primary); line-height: 1.6; }
    .ai-signal { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-default); }
    .ai-signal:last-child { border-bottom: none; }
    .ai-signal-indicator { width: 8px; height: 8px; border-radius: 50%; }
    .ai-signal-indicator.high { background: #4ade80; }
    .ai-signal-indicator.medium { background: #facc15; }
    .ai-signal-indicator.low { background: #f87171; }
    .ai-signal-text { flex: 1; font-size: 13px; color: var(--text-primary); }
    .ai-signal-confidence { font-size: 11px; color: var(--text-secondary); }

    /* Empty States */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-state-text { font-size: 14px; }

    /* Mobile Bottom Nav */
    .mobile-action-buttons { display: none; position: fixed; bottom: 102px; left: 0; right: 0; background: var(--bg-secondary); padding: 8px 8px 0 8px; z-index: 101; }
    .mobile-action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 6px; }
    .mobile-action-btn { padding: 10px 8px; border-radius: 8px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); font-size: 11px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-action-btn:hover { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); }

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; }
    .mobile-nav-top { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 6px; }
    .mobile-nav-secondary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.related { background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--text-primary); }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: var(--text-secondary); }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-default); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      .mobile-action-buttons { display: block !important; }
      .tab-nav { display: none !important; }
      .tab-panel { display: block !important; padding: 12px; }
      .tab-panel .section-header { display: flex !important; }
      .tab-panel .section-content { display: block !important; }
      body { padding-bottom: 165px; }
      .profile-header { margin: 0 0 12px; border-radius: 0; }
      .profile-stats { grid-template-columns: repeat(2, 1fr); }
      .quick-actions { grid-template-columns: repeat(4, 1fr); }
      .profile-avatar { width: 64px; height: 64px; font-size: 24px; }
      .profile-name { font-size: 20px; }
    }
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .mobile-action-buttons { display: none !important; }
      .section-header { display: none !important; }
      .section-content { max-height: none !important; display: block !important; }
      .section-content.collapsed { max-height: none !important; display: block !important; }
      .content { max-width: 1200px; margin: 0 auto; padding: 20px; }
      .profile-header { border-radius: 12px; }
    }
  </style>
</head>
<body>

<!-- Mobile Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-back-btn" onclick="history.back()">‚Üê Back</button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Customer Profile</div>
    </div>
    <button class="mobile-header-actions-btn" onclick="showActionsMenu()">‚ãÆ</button>
  </div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:16px 24px; display:flex; justify-content:space-between; align-items:center;">
    <div style="display:flex; align-items:center; gap:16px;">
      <button onclick="history.back()" style="background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); padding:8px 16px; border-radius:8px; cursor:pointer; font-size:14px;">‚Üê Back</button>
      <h1 style="margin:0; font-size:24px; font-weight:600;">Customer Profile</h1>
    </div>
    <div style="display:flex; gap:12px;">
      <button onclick="editCustomer()" style="padding:10px 20px; background:var(--bg-card); border:1px solid var(--border-default); color:var(--text-primary); border-radius:8px; cursor:pointer; font-size:14px;">Edit Customer</button>
      <button onclick="newWorkOrder()" style="padding:10px 20px; background:var(--accent-primary); border:1px solid var(--accent-primary); color:white; border-radius:8px; cursor:pointer; font-size:14px;">+ New Work Order</button>
    </div>
  </div>
</div>

<div class="content">
  <!-- Profile Header -->
  <div class="profile-header" id="profileHeader">
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading customer...
    </div>
  </div>

  <!-- Quick Actions (Mobile) -->
  <div class="quick-actions" id="quickActions" style="display:none;">
    <button class="quick-action-btn" onclick="makeCall()">
      <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
      Call
    </button>
    <button class="quick-action-btn" onclick="sendText()">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
      Text
    </button>
    <button class="quick-action-btn" onclick="sendEmail()">
      <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
      Email
    </button>
    <button class="quick-action-btn" onclick="addNote()">
      <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
      Note
    </button>
  </div>

  <!-- Desktop Tabs -->
  <div class="tab-nav" id="tabNav">
    <button class="tab-btn active" onclick="showTab('overview')">Overview</button>
    <button class="tab-btn" onclick="showTab('contact')">Contact</button>
    <button class="tab-btn" onclick="showTab('vehicles')">Vehicles</button>
    <button class="tab-btn" onclick="showTab('deals')">Deals</button>
    <button class="tab-btn" onclick="showTab('service')">Service History</button>
    <button class="tab-btn" onclick="showTab('communications')">Communications</button>
    <button class="tab-btn" onclick="showTab('notes')">Notes</button>
    <button class="tab-btn" onclick="showTab('ai')">AI Insights</button>
  </div>

  <!-- Tab Panels -->
  <div id="overview" class="tab-panel active">
    <!-- Contact Section -->
    <div class="section-header" onclick="toggleSection('contactSection')">
      <div class="section-header-title">Contact Information</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="contactSectionContent">
      <div class="section-inner" id="contactInfo">Loading...</div>
    </div>

    <!-- Vehicles Section -->
    <div class="section-header" onclick="toggleSection('vehiclesSection')">
      <div class="section-header-title">Vehicles <span class="section-header-count" id="vehicleCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="vehiclesSectionContent">
      <div class="section-inner" id="vehiclesList">Loading...</div>
    </div>

    <!-- Recent Activity Section -->
    <div class="section-header" onclick="toggleSection('activitySection')">
      <div class="section-header-title">Recent Activity</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="activitySectionContent">
      <div class="section-inner" id="recentActivity">Loading...</div>
    </div>
  </div>

  <div id="contact" class="tab-panel">
    <div class="section-header" onclick="toggleSection('contactDetailSection')">
      <div class="section-header-title">Contact Details</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="contactDetailSectionContent">
      <div class="section-inner" id="contactDetails">Loading...</div>
    </div>
  </div>

  <div id="vehicles" class="tab-panel">
    <div class="section-header" onclick="toggleSection('allVehiclesSection')">
      <div class="section-header-title">All Vehicles <span class="section-header-count" id="allVehicleCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="allVehiclesSectionContent">
      <div class="section-inner" id="allVehiclesList">Loading...</div>
    </div>
  </div>

  <div id="deals" class="tab-panel">
    <div class="section-header" onclick="toggleSection('dealsSection')">
      <div class="section-header-title">Purchase History <span class="section-header-count" id="dealCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="dealsSectionContent">
      <div class="section-inner" id="dealsList">Loading...</div>
    </div>
  </div>

  <div id="service" class="tab-panel">
    <div class="section-header" onclick="toggleSection('serviceSection')">
      <div class="section-header-title">Service History <span class="section-header-count" id="woCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="serviceSectionContent">
      <div class="section-inner" id="serviceList">Loading...</div>
    </div>
  </div>

  <div id="communications" class="tab-panel">
    <div class="section-header" onclick="toggleSection('commsSection')">
      <div class="section-header-title">Communication History</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="commsSectionContent">
      <div class="section-inner" id="commsList">Loading...</div>
    </div>
  </div>

  <div id="notes" class="tab-panel">
    <div class="section-header" onclick="toggleSection('notesSection')">
      <div class="section-header-title">Notes <span class="section-header-count" id="noteCount">0</span></div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="notesSectionContent">
      <div class="section-inner" id="notesList">Loading...</div>
    </div>
  </div>

  <div id="ai" class="tab-panel">
    <div class="section-header" onclick="toggleSection('aiSection')">
      <div class="section-header-title">ü§ñ AI Insights</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="aiSectionContent">
      <div class="section-inner" id="aiInsights">Loading...</div>
    </div>
  </div>
</div>

<!-- Mobile Action Buttons -->
<div class="mobile-action-buttons">
  <div class="mobile-action-grid">
    <button class="mobile-action-btn" onclick="makeCall()">üìû Call</button>
    <button class="mobile-action-btn" onclick="sendText()">üí¨ Text</button>
    <button class="mobile-action-btn" onclick="sendEmail()">‚úâÔ∏è Email</button>
    <button class="mobile-action-btn" onclick="newWorkOrder()">+ WO</button>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
    <a href="dashboard-search.html" class="mobile-nav-btn related">Search</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let customer = null;
let vehicles = [];
let workOrders = [];
let deals = [];
let notes = [];
let appointments = [];
let aiSummary = null;
let aiSignals = [];
let aiNextActions = [];

// Theme
function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

// Get customer ID from URL
function getCustomerId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

// Tab navigation
function showTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
  document.querySelector(`[onclick="showTab('${tabId}')"]`)?.classList.add('active');
  document.getElementById(tabId)?.classList.add('active');
}

// Section toggle (mobile)
function toggleSection(sectionId) {
  const content = document.getElementById(sectionId + 'Content');
  const header = event.currentTarget;
  content.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
  if (!content.classList.contains('collapsed')) {
    content.style.maxHeight = content.scrollHeight + 'px';
  } else {
    content.style.maxHeight = '0px';
  }
}

// Format helpers
function formatDate(dateStr) {
  if (!dateStr) return '--';
  return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function formatDateTime(dateStr) {
  if (!dateStr) return '--';
  return new Date(dateStr).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
}
function formatCurrency(amount) {
  if (amount === null || amount === undefined) return '--';
  return '$' + Number(amount).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
function formatPhone(phone) {
  if (!phone) return '--';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 10) {
    return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
  }
  return phone;
}
function getInitials(name) {
  if (!name) return '?';
  return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

// Load customer data
async function loadCustomer() {
  const customerId = getCustomerId();
  if (!customerId) {
    document.getElementById('profileHeader').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-text">No customer ID provided</div></div>';
    return;
  }

  try {
    // Load customer
    const { data: customerData, error: customerError } = await sb
      .from('customers')
      .select('*')
      .eq('customer_id', customerId)
      .single();

    if (customerError || !customerData) {
      document.getElementById('profileHeader').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-text">Customer not found</div></div>';
      return;
    }
    customer = customerData;

    // Load related data in parallel
    const [vehiclesRes, workOrdersRes, dealsRes, notesRes, appointmentsRes, aiSummaryRes, aiSignalsRes, aiActionsRes] = await Promise.all([
      sb.from('vehicles').select('*').eq('customer_id', customerId).eq('deleted', false).order('created_at', { ascending: false }),
      sb.from('work_orders').select('*').eq('customer_id', customerId).eq('deleted', false).order('created_at', { ascending: false }),
      sb.from('deals').select('*').eq('customer_id', customerId).order('created_at', { ascending: false }),
      sb.from('customer_notes').select('*').eq('customer_id', customerId).order('created_at', { ascending: false }),
      sb.from('sales_appointments').select('*').eq('customer_id', customerId).order('appointment_date', { ascending: false }),
      sb.from('ai_customer_summaries').select('*').eq('customer_id', customerId).maybeSingle(),
      sb.from('ai_customer_signals').select('*').eq('customer_id', customerId).order('detected_at', { ascending: false }).limit(10),
      sb.from('ai_next_actions').select('*').eq('customer_id', customerId).order('created_at', { ascending: false }).limit(5)
    ]);

    vehicles = vehiclesRes.data || [];
    workOrders = workOrdersRes.data || [];
    deals = dealsRes.data || [];
    notes = notesRes.data || [];
    appointments = appointmentsRes.data || [];
    aiSummary = aiSummaryRes.data;
    aiSignals = aiSignalsRes.data || [];
    aiNextActions = aiActionsRes.data || [];

    // Render all sections
    renderProfileHeader();
    renderContactInfo();
    renderContactDetails();
    renderVehicles();
    renderDeals();
    renderServiceHistory();
    renderCommunications();
    renderNotes();
    renderAIInsights();
    renderRecentActivity();

    // Show quick actions
    document.getElementById('quickActions').style.display = 'grid';

    // Update counts
    document.getElementById('vehicleCount').textContent = vehicles.length;
    document.getElementById('allVehicleCount').textContent = vehicles.length;
    document.getElementById('dealCount').textContent = deals.length;
    document.getElementById('woCount').textContent = workOrders.length;
    document.getElementById('noteCount').textContent = notes.length;

  } catch (err) {
    console.error('Error loading customer:', err);
    document.getElementById('profileHeader').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-text">Error loading customer</div></div>';
  }
}

function renderProfileHeader() {
  const totalServiceSpend = workOrders.reduce((sum, wo) => sum + (parseFloat(wo.grand_total) || 0), 0);
  const totalPurchaseValue = deals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
  
  let badges = '';
  if (customer.vip_flag) badges += '<span class="profile-badge vip">‚≠ê VIP</span>';
  if (customer.at_risk_flag) badges += '<span class="profile-badge at-risk">‚ö†Ô∏è At Risk</span>';
  if (customer.pre_approved) badges += '<span class="profile-badge pre-approved">‚úì Pre-Approved</span>';
  if (customer.customer_type === 'service') badges += '<span class="profile-badge service">Service</span>';
  if (customer.customer_type === 'sales') badges += '<span class="profile-badge sales">Sales</span>';

  document.getElementById('profileHeader').innerHTML = `
    <div class="profile-header-top">
      <div class="profile-avatar">${getInitials(customer.full_name)}</div>
      <div class="profile-info">
        <div class="profile-name">${customer.full_name || 'Unknown'}</div>
        <div class="profile-type">${customer.customer_type || 'Customer'} ‚Ä¢ Since ${formatDate(customer.created_at)}</div>
        <div class="profile-contact">
          ${customer.phone ? `<a href="tel:${customer.phone}">${formatPhone(customer.phone)}</a>` : ''}
          ${customer.phone && customer.email ? ' ‚Ä¢ ' : ''}
          ${customer.email ? `<a href="mailto:${customer.email}">${customer.email}</a>` : ''}
        </div>
        ${badges ? `<div class="profile-badges">${badges}</div>` : ''}
      </div>
    </div>
    <div class="profile-stats">
      <div class="profile-stat">
        <div class="profile-stat-value">${vehicles.length}</div>
        <div class="profile-stat-label">Vehicles</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${workOrders.length}</div>
        <div class="profile-stat-label">Work Orders</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${formatCurrency(totalServiceSpend)}</div>
        <div class="profile-stat-label">Service Spend</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${formatCurrency(customer.lifetime_value || totalPurchaseValue + totalServiceSpend)}</div>
        <div class="profile-stat-label">Lifetime Value</div>
      </div>
    </div>
  `;
}

function renderContactInfo() {
  document.getElementById('contactInfo').innerHTML = `
    <div class="info-group">
      <div class="info-row">
        <span class="info-label">Phone</span>
        <span class="info-value"><a href="tel:${customer.phone}">${formatPhone(customer.phone)}</a></span>
      </div>
      <div class="info-row">
        <span class="info-label">Email</span>
        <span class="info-value"><a href="mailto:${customer.email}">${customer.email || '--'}</a></span>
      </div>
      <div class="info-row">
        <span class="info-label">Address</span>
        <span class="info-value">${customer.address ? `${customer.address}<br>${customer.city || ''}, ${customer.state || ''} ${customer.zip || ''}` : '--'}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Preferred Contact</span>
        <span class="info-value">${customer.preferred_contact || '--'}</span>
      </div>
    </div>
  `;
}

function renderContactDetails() {
  document.getElementById('contactDetails').innerHTML = `
    <div class="info-group">
      <div class="info-group-title">Primary Contact</div>
      <div class="info-row"><span class="info-label">Full Name</span><span class="info-value">${customer.full_name || '--'}</span></div>
      <div class="info-row"><span class="info-label">Phone</span><span class="info-value"><a href="tel:${customer.phone}">${formatPhone(customer.phone)}</a></span></div>
      <div class="info-row"><span class="info-label">Email</span><span class="info-value"><a href="mailto:${customer.email}">${customer.email || '--'}</a></span></div>
      <div class="info-row"><span class="info-label">Preferred Contact</span><span class="info-value">${customer.preferred_contact || '--'}</span></div>
    </div>
    <div class="info-group">
      <div class="info-group-title">Address</div>
      <div class="info-row"><span class="info-label">Street</span><span class="info-value">${customer.address || '--'}</span></div>
      <div class="info-row"><span class="info-label">City</span><span class="info-value">${customer.city || '--'}</span></div>
      <div class="info-row"><span class="info-label">State</span><span class="info-value">${customer.state || '--'}</span></div>
      <div class="info-row"><span class="info-label">ZIP</span><span class="info-value">${customer.zip || '--'}</span></div>
    </div>
    <div class="info-group">
      <div class="info-group-title">Identity</div>
      <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value">${formatDate(customer.date_of_birth)}</span></div>
      <div class="info-row"><span class="info-label">Driver's License</span><span class="info-value">${customer.drivers_license || '--'}</span></div>
    </div>
    <div class="info-group">
      <div class="info-group-title">Credit & Finance</div>
      <div class="info-row"><span class="info-label">Credit Score Range</span><span class="info-value">${customer.credit_score_range || '--'}</span></div>
      <div class="info-row"><span class="info-label">Pre-Approved</span><span class="info-value">${customer.pre_approved ? 'Yes' : 'No'}</span></div>
      <div class="info-row"><span class="info-label">Pre-Approval Amount</span><span class="info-value">${formatCurrency(customer.pre_approval_amount)}</span></div>
    </div>
    <div class="info-group">
      <div class="info-group-title">Marketing</div>
      <div class="info-row"><span class="info-label">Marketing Opt-In</span><span class="info-value">${customer.marketing_opt_in ? 'Yes' : 'No'}</span></div>
      <div class="info-row"><span class="info-label">Referral Source</span><span class="info-value">${customer.referral_source || '--'}</span></div>
    </div>
  `;
}

function renderVehicles() {
  if (vehicles.length === 0) {
    document.getElementById('vehiclesList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöó</div><div class="empty-state-text">No vehicles on file</div></div>';
    document.getElementById('allVehiclesList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöó</div><div class="empty-state-text">No vehicles on file</div></div>';
    return;
  }

  const vehicleCards = vehicles.map(v => `
    <div class="item-card" onclick="viewVehicle('${v.vehicle_id}')">
      <div class="item-card-header">
        <div>
          <div class="item-card-title">${v.year || ''} ${v.make || ''} ${v.model || ''}</div>
          <div class="item-card-subtitle">${v.vin_or_hin || 'No VIN'} ‚Ä¢ ${v.color || 'Unknown color'}</div>
        </div>
        <span class="item-card-badge ${v.is_fleet_vehicle ? 'active' : ''}">${v.is_fleet_vehicle ? 'Fleet' : v.vehicle_type || 'Personal'}</span>
      </div>
      <div class="item-card-stats">
        <div class="item-card-stat"><span class="item-card-stat-label">Mileage: </span><span class="item-card-stat-value">${v.mileage_hours ? v.mileage_hours.toLocaleString() : '--'}</span></div>
        <div class="item-card-stat"><span class="item-card-stat-label">Last Service: </span><span class="item-card-stat-value">${formatDate(v.last_service_date)}</span></div>
      </div>
    </div>
  `).join('');

  document.getElementById('vehiclesList').innerHTML = vehicleCards;
  document.getElementById('allVehiclesList').innerHTML = vehicleCards;
}

function renderDeals() {
  if (deals.length === 0) {
    document.getElementById('dealsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><div class="empty-state-text">No purchase history</div></div>';
    return;
  }

  const dealCards = deals.map(d => `
    <div class="item-card" onclick="viewDeal('${d.deal_id}')" style="border-left-color: ${d.status === 'won' ? '#4ade80' : d.status === 'lost' ? '#f87171' : 'var(--accent-primary)'};">
      <div class="item-card-header">
        <div>
          <div class="item-card-title">${d.title || 'Untitled Deal'}</div>
          <div class="item-card-subtitle">${d.deal_type || 'Sale'} ‚Ä¢ ${formatDate(d.created_at)}</div>
        </div>
        <span class="item-card-badge ${d.status === 'won' ? 'active' : d.status === 'lost' ? 'completed' : 'pending'}">${d.status || 'Open'}</span>
      </div>
      <div class="item-card-stats">
        <div class="item-card-stat"><span class="item-card-stat-label">Value: </span><span class="item-card-stat-value">${formatCurrency(d.value)}</span></div>
        <div class="item-card-stat"><span class="item-card-stat-label">Down: </span><span class="item-card-stat-value">${formatCurrency(d.down_payment)}</span></div>
        <div class="item-card-stat"><span class="item-card-stat-label">Monthly: </span><span class="item-card-stat-value">${formatCurrency(d.monthly_payment)}</span></div>
      </div>
    </div>
  `).join('');

  document.getElementById('dealsList').innerHTML = dealCards;
}

function renderServiceHistory() {
  if (workOrders.length === 0) {
    document.getElementById('serviceList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><div class="empty-state-text">No service history</div></div>';
    return;
  }

  const woCards = workOrders.map(wo => {
    const statusColors = {
      'completed': '#4ade80', 'in_progress': 'var(--accent-primary)', 
      'scheduled': 'var(--text-secondary)', 'waiting_parts': '#facc15'
    };
    return `
      <div class="item-card" onclick="viewWorkOrder('${wo.work_order_id}')" style="border-left-color: ${statusColors[wo.status] || 'var(--accent-primary)'};">
        <div class="item-card-header">
          <div>
            <div class="item-card-title">WO #${wo.wo_number || wo.work_order_id.slice(0,8)}</div>
            <div class="item-card-subtitle">${wo.summary || 'No description'}</div>
          </div>
          <span class="item-card-badge ${wo.status === 'completed' ? 'active' : wo.status === 'in_progress' ? 'pending' : 'completed'}">${wo.status || 'Open'}</span>
        </div>
        <div class="item-card-stats">
          <div class="item-card-stat"><span class="item-card-stat-label">Date: </span><span class="item-card-stat-value">${formatDate(wo.scheduled_start || wo.created_at)}</span></div>
          <div class="item-card-stat"><span class="item-card-stat-label">Total: </span><span class="item-card-stat-value">${formatCurrency(wo.grand_total)}</span></div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('serviceList').innerHTML = woCards;
}

function renderCommunications() {
  // Combine appointments and messages into timeline
  const activities = [
    ...appointments.map(a => ({ type: 'appointment', date: a.appointment_date, data: a })),
    ...workOrders.slice(0, 5).map(wo => ({ type: 'work_order', date: wo.created_at, data: wo }))
  ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

  if (activities.length === 0) {
    document.getElementById('commsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì±</div><div class="empty-state-text">No communication history</div></div>';
    return;
  }

  const timeline = activities.map(a => {
    if (a.type === 'appointment') {
      return `
        <div class="timeline-item">
          <div class="timeline-dot" style="background: #8b5cf6;"></div>
          <div class="timeline-content">
            <div class="timeline-date">${formatDate(a.data.appointment_date)} at ${a.data.appointment_time || '--'}</div>
            <div class="timeline-title">üìÖ ${a.data.appointment_type || 'Appointment'}</div>
            <div class="timeline-desc">${a.data.notes || 'No notes'}</div>
          </div>
        </div>
      `;
    } else {
      return `
        <div class="timeline-item">
          <div class="timeline-dot" style="background: var(--accent-primary);"></div>
          <div class="timeline-content">
            <div class="timeline-date">${formatDateTime(a.data.created_at)}</div>
            <div class="timeline-title">üîß Work Order Created</div>
            <div class="timeline-desc">${a.data.summary || 'No description'}</div>
          </div>
        </div>
      `;
    }
  }).join('');

  document.getElementById('commsList').innerHTML = `<div class="timeline">${timeline}</div>`;
}

function renderNotes() {
  let notesHtml = '';
  
  if (notes.length === 0) {
    notesHtml = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-text">No notes yet</div></div>';
  } else {
    notesHtml = notes.map(n => `
      <div class="note-card">
        <div class="note-meta">
          <span>${formatDateTime(n.created_at)}</span>
        </div>
        <div class="note-text">${n.note}</div>
      </div>
    `).join('');
  }

  notesHtml += '<button class="add-note-btn" onclick="addNote()">+ Add Note</button>';
  document.getElementById('notesList').innerHTML = notesHtml;
}

function renderAIInsights() {
  let html = '';

  // AI Summary
  if (aiSummary) {
    html += `
      <div class="ai-card">
        <div class="ai-card-header">
          <div class="ai-card-icon">üß†</div>
          <div class="ai-card-title">Customer Summary</div>
        </div>
        <div class="ai-card-content">${aiSummary.summary}</div>
      </div>
    `;
  }

  // Next Actions
  if (aiNextActions.length > 0) {
    html += `
      <div class="ai-card">
        <div class="ai-card-header">
          <div class="ai-card-icon">üéØ</div>
          <div class="ai-card-title">Recommended Actions</div>
        </div>
        <div class="ai-card-content">
          ${aiNextActions.map(a => `
            <div class="ai-signal">
              <div class="ai-signal-indicator ${a.priority === 'high' ? 'high' : a.priority === 'low' ? 'low' : 'medium'}"></div>
              <div class="ai-signal-text">${a.action}</div>
              <div class="ai-signal-confidence">${Math.round((a.confidence_score || 0) * 100)}%</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Signals
  if (aiSignals.length > 0) {
    html += `
      <div class="ai-card">
        <div class="ai-card-header">
          <div class="ai-card-icon">üìä</div>
          <div class="ai-card-title">Customer Signals</div>
        </div>
        <div class="ai-card-content">
          ${aiSignals.map(s => `
            <div class="ai-signal">
              <div class="ai-signal-indicator ${parseFloat(s.confidence_score) > 0.7 ? 'high' : parseFloat(s.confidence_score) > 0.4 ? 'medium' : 'low'}"></div>
              <div class="ai-signal-text"><strong>${s.signal_type}:</strong> ${s.signal_value}</div>
              <div class="ai-signal-confidence">${Math.round((s.confidence_score || 0) * 100)}%</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  if (!html) {
    html = '<div class="empty-state"><div class="empty-state-icon">ü§ñ</div><div class="empty-state-text">No AI insights available yet</div></div>';
  }

  document.getElementById('aiInsights').innerHTML = html;
}

function renderRecentActivity() {
  const activities = [
    ...workOrders.slice(0, 3).map(wo => ({ type: 'wo', date: wo.created_at, data: wo })),
    ...appointments.slice(0, 3).map(a => ({ type: 'apt', date: a.created_at, data: a })),
    ...deals.slice(0, 2).map(d => ({ type: 'deal', date: d.created_at, data: d }))
  ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

  if (activities.length === 0) {
    document.getElementById('recentActivity').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No recent activity</div></div>';
    return;
  }

  const timeline = activities.map(a => {
    let icon = 'üìã', title = '', desc = '';
    if (a.type === 'wo') {
      icon = 'üîß'; title = `Work Order #${a.data.wo_number || ''}`; desc = a.data.summary || '';
    } else if (a.type === 'apt') {
      icon = 'üìÖ'; title = a.data.appointment_type || 'Appointment'; desc = a.data.notes || '';
    } else if (a.type === 'deal') {
      icon = 'üí∞'; title = a.data.title || 'Deal'; desc = `Value: ${formatCurrency(a.data.value)}`;
    }
    return `
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-content">
          <div class="timeline-date">${formatDateTime(a.date)}</div>
          <div class="timeline-title">${icon} ${title}</div>
          <div class="timeline-desc">${desc}</div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('recentActivity').innerHTML = `<div class="timeline">${timeline}</div>`;
}

// Actions
function makeCall() {
  if (customer?.phone) window.location.href = `tel:${customer.phone}`;
  else alert('No phone number on file');
}
function sendText() {
  if (customer?.phone) window.location.href = `sms:${customer.phone}`;
  else alert('No phone number on file');
}
function sendEmail() {
  if (customer?.email) window.location.href = `mailto:${customer.email}`;
  else alert('No email on file');
}
function addNote() {
  const note = prompt('Enter note:');
  if (note && customer) {
    sb.from('customer_notes').insert({
      tenant_id: customer.tenant_id,
      customer_id: customer.customer_id,
      note: note
    }).then(() => {
      loadCustomer();
    });
  }
}
function editCustomer() {
  window.location.href = `customer-edit.html?id=${customer?.customer_id}`;
}
function newWorkOrder() {
  window.location.href = `work-order-new.html?customer_id=${customer?.customer_id}`;
}
function viewVehicle(id) {
  window.location.href = `vehicle-detail.html?id=${id}`;
}
function viewWorkOrder(id) {
  window.location.href = `work-order-detail.html?id=${id}`;
}
function viewDeal(id) {
  window.location.href = `deal-detail.html?id=${id}`;
}
function showActionsMenu() {
  // Mobile actions menu - could be a modal
  alert('Actions: Edit Customer, New Work Order, New Deal');
}

// Initialize
loadCustomer();
</script>
</body>
</html>
