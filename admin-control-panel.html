<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Platform Admin Console</title>
  <style>
    :root{--bg:#05080d;--bg2:#0a1019;--bg3:#111a28;--border:#1e3048;--text:#e8f4ff;--text2:#7a9ec0;--muted:#4a6a8a;--cyan:#00e5ff;--green:#00ff9d;--orange:#ff9500;--purple:#bf5fff;--red:#ff3d5a;--blue:#3d8bff;--yellow:#ffe03d;--pink:#ff5f9f}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:var(--bg);background-image:radial-gradient(ellipse at top,rgba(0,229,255,.03) 0%,transparent 50%);min-height:100vh;color:var(--text)}
    .container{max-width:1700px;margin:0 auto;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)}
    .header-left{display:flex;align-items:center;gap:16px}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,var(--cyan),var(--purple));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 20px rgba(0,229,255,.4)}
    .header-title{font-size:26px;font-weight:700}
    .header-sub{font-size:12px;color:var(--cyan);text-transform:uppercase;letter-spacing:2px}
    .status-panel{display:flex;align-items:center;gap:16px;padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:10px}
    .status-item{display:flex;align-items:center;gap:8px;font-size:11px;text-transform:uppercase;letter-spacing:1px}
    .light{width:10px;height:10px;border-radius:50%;position:relative}
    .light::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:1px solid currentColor;opacity:.3}
    .light.green{background:var(--green);color:var(--green);box-shadow:0 0 12px var(--green)}
    .light.red{background:var(--red);color:var(--red);box-shadow:0 0 12px var(--red);animation:pulse 1.5s infinite}
    .light.orange{background:var(--orange);color:var(--orange);animation:pulse 2s infinite}
    .light.cyan{background:var(--cyan);color:var(--cyan);box-shadow:0 0 12px var(--cyan)}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.9)}}
    .live{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--green)}
    .live-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:live 2s infinite}
    @keyframes live{0%,100%{box-shadow:0 0 0 0 rgba(0,255,157,.7)}50%{box-shadow:0 0 0 6px transparent}}
    .nav{display:flex;justify-content:space-between;align-items:center;padding:16px 0;margin-bottom:20px;flex-wrap:wrap;gap:12px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{font-size:12px;font-weight:600;color:var(--text2);background:var(--bg2);border:1px solid var(--border);padding:10px 18px;border-radius:8px;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:.5px;position:relative}
    .tab::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);opacity:0;transition:.3s}
    .tab:hover{color:var(--text);background:#1a2535;border-color:#2a4060}
    .tab:hover::before{opacity:.5}
    .tab.active{color:var(--cyan);border-color:var(--cyan);background:rgba(0,229,255,.08)}
    .tab.active::before{opacity:1}
    .tab .badge{background:var(--red);color:#fff;font-size:9px;padding:2px 6px;border-radius:10px;margin-left:8px;box-shadow:0 0 10px var(--red)}
    .btn{font-size:12px;font-weight:600;padding:10px 18px;border:1px solid #2a4060;border-radius:8px;cursor:pointer;transition:.3s;background:var(--bg2);color:var(--text);text-transform:uppercase}
    .btn:hover{background:#1a2535}
    .btn-primary{border-color:var(--cyan);color:var(--cyan)}
    .btn-primary:hover{background:rgba(0,229,255,.1);box-shadow:0 0 20px rgba(0,229,255,.3)}
    .btn-success{border-color:var(--green);color:var(--green)}
    .btn-sm{padding:6px 12px;font-size:11px}
    .kpi-section{background:var(--bg2);border:1px solid var(--border);border-radius:16px;margin-bottom:24px;overflow:hidden;position:relative}
    .kpi-section::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),var(--purple),transparent)}
    .kpi-header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;cursor:pointer;transition:.3s}
    .kpi-header:hover{background:#1a2535}
    .kpi-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:10px}
    .kpi-summary{font-size:12px;color:var(--text2);margin-left:16px}
    .kpi-toggle{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--cyan);transition:.3s}
    .kpi-toggle.collapsed{transform:rotate(-90deg)}
    .kpi-content{max-height:1500px;overflow:hidden;transition:.4s;padding:0 24px 24px}
    .kpi-content.collapsed{max-height:0;padding:0 24px}
    .kpi-cat{margin-bottom:20px}
    .kpi-cat-title{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:12px;padding-bottom:8px;border-bottom:1px dashed var(--border);display:flex;align-items:center;gap:8px}
    .kpi-cat-title::before{content:'';width:4px;height:4px;border-radius:50%;background:var(--cyan)}
    .kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
    @media(max-width:1400px){.kpi-grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:1100px){.kpi-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:800px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
    .speedo{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px;transition:.3s;position:relative;overflow:hidden}
    .speedo::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent,var(--cyan)),transparent);opacity:.6}
    .speedo:hover{border-color:#2a4060;transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3)}
    .speedo.cyan{--accent:var(--cyan)}.speedo.green{--accent:var(--green)}.speedo.orange{--accent:var(--orange)}.speedo.purple{--accent:var(--purple)}.speedo.red{--accent:var(--red)}.speedo.blue{--accent:var(--blue)}.speedo.yellow{--accent:var(--yellow)}.speedo.pink{--accent:var(--pink)}
    .speedo-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
    .speedo-label{font-size:10px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
    .speedo-trend{font-size:10px;font-weight:700}
    .speedo-trend.up{color:var(--green)}.speedo-trend.down{color:var(--red)}.speedo-trend.flat{color:var(--orange)}
    .speedo-gauge{position:relative;width:100px;height:55px;margin:0 auto 10px}
    .speedo-gauge svg{width:100%;height:100%;overflow:visible}
    .gauge-bg{fill:none;stroke:var(--bg3);stroke-width:5;stroke-linecap:round}
    .gauge-fill{fill:none;stroke-width:5;stroke-linecap:round;transition:1s;filter:drop-shadow(0 0 6px currentColor)}
    .gauge-fill.cyan{stroke:var(--cyan)}.gauge-fill.green{stroke:var(--green)}.gauge-fill.orange{stroke:var(--orange)}.gauge-fill.purple{stroke:var(--purple)}.gauge-fill.red{stroke:var(--red)}.gauge-fill.blue{stroke:var(--blue)}.gauge-fill.yellow{stroke:var(--yellow)}.gauge-fill.pink{stroke:var(--pink)}
    .speedo-val{font-size:22px;font-weight:700;text-align:center}
    .speedo-val.cyan{color:var(--cyan);text-shadow:0 0 20px rgba(0,229,255,.5)}.speedo-val.green{color:var(--green);text-shadow:0 0 20px rgba(0,255,157,.5)}.speedo-val.orange{color:var(--orange)}.speedo-val.purple{color:var(--purple)}.speedo-val.red{color:var(--red)}.speedo-val.blue{color:var(--blue)}.speedo-val.yellow{color:var(--yellow)}.speedo-val.pink{color:var(--pink)}
    .speedo-unit{font-size:10px;color:var(--muted);text-align:center}
    .speedo-foot{display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:9px;color:var(--muted)}
    .tab-content{display:none}.tab-content.active{display:block}
    .panel{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px}
    .panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
    .panel-title{font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
    .table{width:100%;border-collapse:collapse}
    .table th{font-size:10px;font-weight:600;text-align:left;padding:14px 12px;background:var(--bg);color:var(--text2);border-bottom:1px solid var(--border);text-transform:uppercase;letter-spacing:1px}
    .table td{padding:14px 12px;border-bottom:1px solid var(--border);font-size:13px}
    .table tr:hover{background:#1a2535}
    .badge{display:inline-block;font-size:10px;font-weight:600;padding:4px 10px;border-radius:6px;text-transform:uppercase}
    .badge-cyan{background:rgba(0,229,255,.15);color:var(--cyan)}.badge-green{background:rgba(0,255,157,.15);color:var(--green)}.badge-orange{background:rgba(255,149,0,.15);color:var(--orange)}.badge-purple{background:rgba(191,95,255,.15);color:var(--purple)}.badge-red{background:rgba(255,61,90,.15);color:var(--red)}.badge-blue{background:rgba(61,139,255,.15);color:var(--blue)}
    .support-stats{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:20px}
    @media(max-width:1200px){.support-stats{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:600px){.support-stats{grid-template-columns:repeat(2,1fr)}}
    .stat-card{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;cursor:pointer;transition:.3s;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--stat,var(--cyan));opacity:.6}
    .stat-card:hover{border-color:var(--stat);transform:translateY(-2px)}
    .stat-card.active{border-color:var(--stat);background:rgba(0,229,255,.05)}
    .stat-card .val{font-size:32px;font-weight:700;margin-bottom:4px;color:var(--stat)}
    .stat-card .lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px}
    .stat-card.open{--stat:var(--blue)}.stat-card.progress{--stat:var(--yellow)}.stat-card.waiting{--stat:var(--purple)}.stat-card.resolved{--stat:var(--green)}.stat-card.closed{--stat:var(--muted)}.stat-card.urgent{--stat:var(--red)}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    .filters input,.filters select{font-size:13px;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);min-width:140px}
    .filters input:focus,.filters select:focus{outline:none;border-color:var(--cyan)}
    .ticket-row{cursor:pointer}
    .priority-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
    .priority-dot.low{background:var(--muted)}.priority-dot.normal{background:var(--blue)}.priority-dot.high{background:var(--orange);box-shadow:0 0 8px var(--orange)}.priority-dot.urgent{background:var(--red);box-shadow:0 0 8px var(--red);animation:pulse 1s infinite}
    .status-badge{padding:5px 12px;border-radius:6px;font-size:10px;font-weight:600;text-transform:uppercase}
    .status-open{background:rgba(61,139,255,.2);color:var(--blue)}.status-in_progress{background:rgba(255,224,61,.2);color:var(--yellow)}.status-waiting_on_customer{background:rgba(191,95,255,.2);color:var(--purple)}.status-resolved{background:rgba(0,255,157,.2);color:var(--green)}.status-closed{background:rgba(74,106,138,.2);color:var(--muted)}
    .modal{display:none;position:fixed;inset:0;background:rgba(5,8,13,.9);backdrop-filter:blur(8px);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .modal.active{display:flex}
    .modal-box{background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:100%;max-width:950px;max-height:90vh;overflow-y:auto;position:relative}
    .modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--cyan),var(--purple),var(--pink))}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg2);z-index:10}
    .modal-title{font-size:16px;font-weight:600}
    .modal-close{background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer}
    .modal-close:hover{color:var(--red)}
    .modal-body{padding:24px}
    .detail-grid{display:grid;grid-template-columns:1.8fr 1fr;gap:24px}
    @media(max-width:800px){.detail-grid{grid-template-columns:1fr}}
    .meta-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px}
    .meta-card h4{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px dashed var(--border)}
    .meta-row{display:flex;justify-content:space-between;padding:8px 0;font-size:12px}
    .meta-row .lbl{color:var(--text2)}.meta-row .val{font-weight:500}
    .desc-box{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px;line-height:1.7;white-space:pre-wrap;font-size:13px}
    .comment{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px;border-left:3px solid var(--border)}
    .comment.agent{border-left-color:var(--cyan)}.comment.customer{border-left-color:var(--purple)}.comment.internal{border-left-color:var(--orange);background:rgba(255,149,0,.03)}
    .comment-head{display:flex;justify-content:space-between;margin-bottom:10px;font-size:11px}
    .comment-author{font-weight:600}.comment-author.agent{color:var(--cyan)}.comment-author.internal{color:var(--orange)}
    .comment-time{color:var(--muted)}
    .comment-msg{line-height:1.6;font-size:13px}
    .reply-tabs{display:flex;gap:8px;margin-bottom:12px}
    .reply-tab{padding:10px 18px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
    .reply-tab:hover{background:#1a2535}
    .reply-tab.active{background:var(--cyan);border-color:var(--cyan);color:var(--bg)}
    .reply-tab.internal.active{background:var(--orange);border-color:var(--orange)}
    textarea{font-family:inherit;font-size:13px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);width:100%;min-height:80px;resize:vertical}
    textarea:focus{outline:none;border-color:var(--cyan)}
    .quick-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .loading{text-align:center;padding:40px;color:var(--muted);font-size:13px}
    ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#2a4060}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-left">
      <div class="logo">‚ö°</div>
      <div><div class="header-title">Platform Command</div><div class="header-sub">Admin Console v2.0</div></div>
    </div>
    <div class="status-panel">
      <div class="status-item"><div class="light green" id="dbLight"></div><span>Database</span></div>
      <div class="status-item"><div class="light cyan"></div><span>API</span></div>
      <div class="status-item"><div class="light green"></div><span>Cache</span></div>
      <div class="status-item"><div class="light" id="alertLight"></div><span id="alertText">System OK</span></div>
      <div class="live"><div class="live-dot"></div><span>LIVE</span></div>
    </div>
  </div>

  <div class="nav">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab" onclick="switchTab('tenants')">Tenants</button>
      <button class="tab" onclick="switchTab('support')" id="supportTab">Support<span class="badge" id="ticketBadge" style="display:none">0</span></button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn" onclick="refreshAll()">‚ü≥ Refresh</button>
      <button class="btn btn-primary" onclick="exportReport()">‚Üì Export</button>
    </div>
  </div>

  <div class="kpi-section">
    <div class="kpi-header" onclick="toggleKPIs()">
      <div style="display:flex;align-items:center">
        <span class="kpi-title">üìä Platform Metrics</span>
        <span class="kpi-summary" id="kpiSummary">Loading...</span>
      </div>
      <div class="kpi-toggle" id="kpiToggle">‚ñº</div>
    </div>
    <div class="kpi-content" id="kpiContent">
      <!-- Revenue -->
      <div class="kpi-cat">
        <div class="kpi-cat-title">üí∞ Revenue & Financial</div>
        <div class="kpi-grid">
          <div class="speedo cyan"><div class="speedo-head"><span class="speedo-label">Monthly Recurring Revenue</span><span class="speedo-trend up">‚Üë 12%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill cyan" id="mrrGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val cyan" id="mrrVal">$0</div><div class="speedo-unit">Total MRR</div><div class="speedo-foot"><span>Target: $50K</span><span id="mrrPct">0%</span></div></div>
          <div class="speedo green"><div class="speedo-head"><span class="speedo-label">Annual Recurring Revenue</span><span class="speedo-trend up">‚Üë 15%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill green" id="arrGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val green" id="arrVal">$0</div><div class="speedo-unit">Total ARR</div><div class="speedo-foot"><span>Target: $600K</span><span id="arrPct">0%</span></div></div>
          <div class="speedo purple"><div class="speedo-head"><span class="speedo-label">Avg Revenue Per User</span><span class="speedo-trend up">‚Üë $15</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill purple" id="arpuGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val purple" id="arpuVal">$0</div><div class="speedo-unit">Per Tenant/Mo</div><div class="speedo-foot"><span>Target: $500</span><span id="arpuPct">0%</span></div></div>
          <div class="speedo blue"><div class="speedo-head"><span class="speedo-label">Customer Lifetime Value</span><span class="speedo-trend up">‚Üë $200</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill blue" id="ltvGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val blue" id="ltvVal">$0</div><div class="speedo-unit">Avg LTV</div><div class="speedo-foot"><span>Target: $6K</span><span id="ltvPct">0%</span></div></div>
          <div class="speedo yellow"><div class="speedo-head"><span class="speedo-label">Net Revenue Retention</span><span class="speedo-trend up">‚Üë 2%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill yellow" id="nrrGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val yellow">108%</div><div class="speedo-unit">NRR</div><div class="speedo-foot"><span>Target: >100%</span><span>Healthy</span></div></div>
        </div>
      </div>
      <!-- Customers -->
      <div class="kpi-cat">
        <div class="kpi-cat-title">üë• Customers & Growth</div>
        <div class="kpi-grid">
          <div class="speedo green"><div class="speedo-head"><span class="speedo-label">Active Tenants</span><span class="speedo-trend up">‚Üë 8</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill green" id="tenantGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val green" id="tenantVal">0</div><div class="speedo-unit">Active Accounts</div><div class="speedo-foot"><span>Target: 100</span><span id="tenantPct">0%</span></div></div>
          <div class="speedo cyan"><div class="speedo-head"><span class="speedo-label">Total Platform Users</span><span class="speedo-trend up">‚Üë 45</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill cyan" id="userGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val cyan" id="userVal">0</div><div class="speedo-unit">Total Users</div><div class="speedo-foot"><span>Target: 500</span><span id="userPct">0%</span></div></div>
          <div class="speedo purple"><div class="speedo-head"><span class="speedo-label">Active Trials</span><span class="speedo-trend up">‚Üë 5</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill purple" id="trialGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val purple" id="trialVal">0</div><div class="speedo-unit">In Trial</div><div class="speedo-foot"><span>Avg: 14 days</span><span>Pipeline</span></div></div>
          <div class="speedo blue"><div class="speedo-head"><span class="speedo-label">Trial Conversion</span><span class="speedo-trend up">‚Üë 3%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill blue" id="convGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val blue">22.5%</div><div class="speedo-unit">Conversion Rate</div><div class="speedo-foot"><span>Target: 25%</span><span>Good</span></div></div>
          <div class="speedo orange"><div class="speedo-head"><span class="speedo-label">Churn Rate</span><span class="speedo-trend down">‚Üì 0.5%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill orange" id="churnGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val orange">3.2%</div><div class="speedo-unit">Monthly Churn</div><div class="speedo-foot"><span>Target: <5%</span><span>Healthy</span></div></div>
        </div>
      </div>
      <!-- Costs -->
      <div class="kpi-cat">
        <div class="kpi-cat-title">üìâ Costs & Operations</div>
        <div class="kpi-grid">
          <div class="speedo red"><div class="speedo-head"><span class="speedo-label">Customer Acq. Cost</span><span class="speedo-trend down">‚Üì $12</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill red" id="cacGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val red" id="cacVal">$125</div><div class="speedo-unit">CAC</div><div class="speedo-foot"><span>Target: <$150</span><span>Good</span></div></div>
          <div class="speedo pink"><div class="speedo-head"><span class="speedo-label">LTV:CAC Ratio</span><span class="speedo-trend up">‚Üë 0.3</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill pink" id="ltvcacGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val pink" id="ltvcacVal">4.2:1</div><div class="speedo-unit">LTV / CAC</div><div class="speedo-foot"><span>Target: >3:1</span><span>Excellent</span></div></div>
          <div class="speedo orange"><div class="speedo-head"><span class="speedo-label">Infrastructure Cost</span><span class="speedo-trend flat">‚Üí 2%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill orange" id="infraGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val orange">$1.2K</div><div class="speedo-unit">Monthly</div><div class="speedo-foot"><span>Budget: $2K</span><span>60%</span></div></div>
          <div class="speedo yellow"><div class="speedo-head"><span class="speedo-label">Gross Margin</span><span class="speedo-trend up">‚Üë 1.5%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill yellow" id="marginGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val yellow">78%</div><div class="speedo-unit">Gross Margin</div><div class="speedo-foot"><span>Target: >70%</span><span>Excellent</span></div></div>
          <div class="speedo green"><div class="speedo-head"><span class="speedo-label">Payback Period</span><span class="speedo-trend down">‚Üì 0.5mo</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill green" id="paybackGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val green">8.5</div><div class="speedo-unit">Months</div><div class="speedo-foot"><span>Target: <12</span><span>Great</span></div></div>
        </div>
      </div>
      <!-- Support -->
      <div class="kpi-cat">
        <div class="kpi-cat-title">üé´ Support & Engagement</div>
        <div class="kpi-grid">
          <div class="speedo blue"><div class="speedo-head"><span class="speedo-label">Open Tickets</span><span class="speedo-trend flat" id="ticketTrend">‚Üí 0</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill blue" id="ticketGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val blue" id="openTicketKpi">0</div><div class="speedo-unit">Awaiting Response</div><div class="speedo-foot"><span>Target: <10</span><span id="ticketStatus">Good</span></div></div>
          <div class="speedo purple"><div class="speedo-head"><span class="speedo-label">Avg Response Time</span><span class="speedo-trend down">‚Üì 15min</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill purple" id="responseGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val purple">2.4h</div><div class="speedo-unit">First Response</div><div class="speedo-foot"><span>Target: <4h</span><span>Fast</span></div></div>
          <div class="speedo green"><div class="speedo-head"><span class="speedo-label">Resolution Rate</span><span class="speedo-trend up">‚Üë 2%</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill green" id="resolutionGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val green">85%</div><div class="speedo-unit">Same Day</div><div class="speedo-foot"><span>Target: >80%</span><span>Excellent</span></div></div>
          <div class="speedo cyan"><div class="speedo-head"><span class="speedo-label">CSAT Score</span><span class="speedo-trend up">‚Üë 0.1</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill cyan" id="csatGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val cyan">4.7</div><div class="speedo-unit">Out of 5.0</div><div class="speedo-foot"><span>Target: >4.5</span><span>Great</span></div></div>
          <div class="speedo yellow"><div class="speedo-head"><span class="speedo-label">NPS Score</span><span class="speedo-trend up">‚Üë 5</span></div><div class="speedo-gauge"><svg viewBox="0 0 100 55"><path class="gauge-bg" d="M 10 50 A 40 40 0 0 1 90 50"/><path class="gauge-fill yellow" id="npsGauge" d="M 10 50 A 40 40 0 0 1 90 50" stroke-dasharray="0 126"/></svg></div><div class="speedo-val yellow">62</div><div class="speedo-unit">Net Promoter</div><div class="speedo-foot"><span>Target: >50</span><span>Excellent</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="tab-content active" id="dashboard">
    <div class="panel"><div class="panel-head"><span class="panel-title">üìà Quick Overview</span></div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
        <div class="meta-card"><h4>Today's Activity</h4><div class="meta-row"><span class="lbl">New Signups</span><span class="val" style="color:var(--green)">+3</span></div><div class="meta-row"><span class="lbl">New Tickets</span><span class="val" style="color:var(--blue)">5</span></div><div class="meta-row"><span class="lbl">Revenue</span><span class="val" style="color:var(--cyan)">$1,247</span></div></div>
        <div class="meta-card"><h4>System Health</h4><div class="meta-row"><span class="lbl">API Latency</span><span class="val" style="color:var(--green)">45ms</span></div><div class="meta-row"><span class="lbl">Uptime</span><span class="val" style="color:var(--green)">99.98%</span></div><div class="meta-row"><span class="lbl">Error Rate</span><span class="val" style="color:var(--green)">0.02%</span></div></div>
        <div class="meta-card"><h4>Alerts</h4><div class="meta-row"><span class="lbl">Critical</span><span class="val" style="color:var(--green)">0</span></div><div class="meta-row"><span class="lbl">Warnings</span><span class="val" style="color:var(--orange)">2</span></div><div class="meta-row"><span class="lbl">Info</span><span class="val" style="color:var(--blue)">5</span></div></div>
      </div>
    </div>
  </div>

  <!-- Tenants -->
  <div class="tab-content" id="tenants">
    <div class="panel"><div class="panel-head"><span class="panel-title">üè¢ All Tenants</span><div style="display:flex;gap:8px"><input type="text" id="tenantSearch" placeholder="Search..." style="font-size:13px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);width:180px" oninput="filterTenants()"><button class="btn" onclick="loadTenants()">Refresh</button><button class="btn btn-success">+ Add</button></div></div>
      <div id="tenantsLoading" class="loading">Loading tenants...</div>
      <div style="overflow-x:auto"><table class="table" id="tenantsTable" style="display:none"><thead><tr><th>Company</th><th>Owner</th><th>Tier</th><th>MRR</th><th>Users</th><th>Status</th><th>Actions</th></tr></thead><tbody id="tenantsBody"></tbody></table></div>
    </div>
  </div>

  <!-- Support -->
  <div class="tab-content" id="support">
    <div class="support-stats">
      <div class="stat-card open" onclick="filterByStatus('open')"><div class="val" id="statOpen">0</div><div class="lbl">Open</div></div>
      <div class="stat-card progress" onclick="filterByStatus('in_progress')"><div class="val" id="statProgress">0</div><div class="lbl">In Progress</div></div>
      <div class="stat-card waiting" onclick="filterByStatus('waiting_on_customer')"><div class="val" id="statWaiting">0</div><div class="lbl">Waiting</div></div>
      <div class="stat-card resolved" onclick="filterByStatus('resolved')"><div class="val" id="statResolved">0</div><div class="lbl">Resolved</div></div>
      <div class="stat-card closed" onclick="filterByStatus('closed')"><div class="val" id="statClosed">0</div><div class="lbl">Closed</div></div>
      <div class="stat-card urgent" onclick="filterByStatus('urgent')"><div class="val" id="statUrgent">0</div><div class="lbl">Urgent</div></div>
    </div>
    <div class="panel"><div class="panel-head"><span class="panel-title">üé´ Support Tickets</span><div style="display:flex;gap:8px"><button class="btn" onclick="loadTickets()">Refresh</button><button class="btn btn-primary" onclick="exportTickets()">Export CSV</button></div></div>
      <div class="filters">
        <input type="text" id="ticketSearch" placeholder="Search tickets..." oninput="filterTickets()">
        <select id="statusFilter" onchange="filterTickets()"><option value="">All Status</option><option value="open">Open</option><option value="in_progress">In Progress</option><option value="waiting_on_customer">Waiting</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select>
        <select id="priorityFilter" onchange="filterTickets()"><option value="">All Priority</option><option value="urgent">Urgent</option><option value="high">High</option><option value="normal">Normal</option><option value="low">Low</option></select>
        <select id="teamFilter" onchange="filterTickets()"><option value="">All Teams</option></select>
      </div>
      <div id="ticketsLoading" class="loading">Loading tickets...</div>
      <div style="overflow-x:auto"><table class="table" id="ticketsTable" style="display:none"><thead><tr><th>ID</th><th>Subject</th><th>Submitter</th><th>Team</th><th>Priority</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody id="ticketsBody"></tbody></table></div>
    </div>
  </div>

  <!-- Settings -->
  <div class="tab-content" id="settings">
    <div class="panel"><div class="panel-head"><span class="panel-title">‚öôÔ∏è Platform Settings</span><button class="btn btn-primary">Save Changes</button></div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px">
        <div><label style="font-size:11px;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:6px">Platform Name</label><input type="text" value="My SaaS Platform" style="width:100%;font-size:13px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
        <div><label style="font-size:11px;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:6px">Support Email</label><input type="email" value="support@example.com" style="width:100%;font-size:13px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)"></div>
      </div>
    </div>
  </div>
</div>

<!-- Ticket Modal -->
<div class="modal" id="ticketModal">
  <div class="modal-box">
    <div class="modal-head"><span class="modal-title"><span id="modalTitle">Ticket</span> <span class="status-badge status-open" id="modalStatus" style="margin-left:12px">Open</span></span><button class="modal-close" onclick="closeModal()">&times;</button></div>
    <div class="modal-body">
      <div class="detail-grid">
        <div>
          <h3 id="modalSubject" style="font-size:18px;margin-bottom:16px"></h3>
          <div class="desc-box" id="modalDesc"></div>
          <div style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;color:var(--text2)">üí¨ Conversation</div>
          <div id="commentsList"></div>
          <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">
            <div class="reply-tabs"><button class="reply-tab active" onclick="setReplyType('public',this)">Reply to Customer</button><button class="reply-tab internal" onclick="setReplyType('internal',this)">Internal Note</button></div>
            <textarea id="replyText" placeholder="Type your response..."></textarea>
            <div class="quick-actions"><button class="btn btn-success" onclick="submitReply()">Send Reply</button><select id="quickStatus" onchange="quickChangeStatus()" style="font-size:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option value="">Change Status...</option><option value="in_progress">In Progress</option><option value="waiting_on_customer">Waiting</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select></div>
          </div>
        </div>
        <div>
          <div class="meta-card"><h4>Ticket Info</h4><div class="meta-row"><span class="lbl">Ticket #</span><span class="val" id="metaNumber">--</span></div><div class="meta-row"><span class="lbl">Created</span><span class="val" id="metaCreated">--</span></div><div class="meta-row"><span class="lbl">Category</span><span class="val" id="metaCategory">--</span></div><div class="meta-row"><span class="lbl">Team</span><span class="val" id="metaTeam">--</span></div></div>
          <div class="meta-card"><h4>Submitter</h4><div class="meta-row"><span class="lbl">Name</span><span class="val" id="metaName">--</span></div><div class="meta-row"><span class="lbl">Email</span><span class="val" id="metaEmail">--</span></div></div>
          <div class="meta-card"><h4>Manage</h4><div style="margin-bottom:12px"><label style="font-size:10px;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:6px">Status</label><select id="statusSelect" onchange="updateStatus()" style="width:100%;font-size:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option value="open">Open</option><option value="in_progress">In Progress</option><option value="waiting_on_customer">Waiting</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select></div><div><label style="font-size:10px;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:6px">Priority</label><select id="prioritySelect" onchange="updatePriority()" style="width:100%;font-size:12px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text)"><option value="low">Low</option><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co',SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
let isConn=false,tenants=[],tickets=[],currentId=null,replyType='public',kpiOpen=true;

async function init(){await checkConn();await Promise.all([loadTenants(),loadTickets()]);updateKPIs();updateIndicators()}
async function checkConn(){try{const r=await fetch(SB_URL+'/rest/v1/tenants?select=tenant_id&limit=1',{headers:{apikey:SB_KEY,Authorization:'Bearer '+SB_KEY}});if(!r.ok)throw 0;isConn=true;document.getElementById('dbLight').className='light green'}catch{isConn=false;document.getElementById('dbLight').className='light red'}}
function toggleKPIs(){kpiOpen=!kpiOpen;document.getElementById('kpiContent').classList.toggle('collapsed',!kpiOpen);document.getElementById('kpiToggle').classList.toggle('collapsed',!kpiOpen)}
function switchTab(t){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));event.target.classList.add('active');document.getElementById(t).classList.add('active');if(t==='support')loadTickets()}
function gauge(id,pct){const e=document.getElementById(id);if(e)e.setAttribute('stroke-dasharray',(pct/100*126)+' 126')}
function updateKPIs(){const active=tenants.filter(t=>t.status==='active'),trials=tenants.filter(t=>t.status==='trial'),mrr=tenants.reduce((s,t)=>s+(t.monthly_recurring_revenue||0),0),users=tenants.reduce((s,t)=>s+(t.user_count||1),0),open=tickets.filter(t=>t.status==='open').length;
document.getElementById('kpiSummary').textContent=active.length+' tenants ‚Ä¢ $'+mrr.toLocaleString()+' MRR ‚Ä¢ '+users+' users ‚Ä¢ '+open+' tickets';
document.getElementById('mrrVal').textContent='$'+mrr.toLocaleString();document.getElementById('mrrPct').textContent=Math.round(mrr/50000*100)+'%';gauge('mrrGauge',Math.min(mrr/50000*100,100));
const arr=mrr*12;document.getElementById('arrVal').textContent='$'+(arr/1000).toFixed(0)+'K';document.getElementById('arrPct').textContent=Math.round(arr/600000*100)+'%';gauge('arrGauge',Math.min(arr/600000*100,100));
const arpu=active.length?mrr/active.length:0;document.getElementById('arpuVal').textContent='$'+arpu.toFixed(0);document.getElementById('arpuPct').textContent=Math.round(arpu/500*100)+'%';gauge('arpuGauge',Math.min(arpu/500*100,100));
const ltv=arpu*24;document.getElementById('ltvVal').textContent='$'+ltv.toFixed(0);document.getElementById('ltvPct').textContent=Math.round(ltv/6000*100)+'%';gauge('ltvGauge',Math.min(ltv/6000*100,100));
gauge('nrrGauge',80);document.getElementById('tenantVal').textContent=active.length;document.getElementById('tenantPct').textContent=active.length+'%';gauge('tenantGauge',Math.min(active.length,100));
document.getElementById('userVal').textContent=users;document.getElementById('userPct').textContent=Math.round(users/500*100)+'%';gauge('userGauge',Math.min(users/500*100,100));
document.getElementById('trialVal').textContent=trials.length;gauge('trialGauge',trials.length*10);gauge('convGauge',90);gauge('churnGauge',32);
document.getElementById('cacVal').textContent='$125';gauge('cacGauge',83);document.getElementById('ltvcacVal').textContent=(ltv/125).toFixed(1)+':1';gauge('ltvcacGauge',Math.min(ltv/125/5*100,100));gauge('infraGauge',60);gauge('marginGauge',78);gauge('paybackGauge',70);
document.getElementById('openTicketKpi').textContent=open;gauge('ticketGauge',Math.min(open*10,100));document.getElementById('ticketStatus').textContent=open<10?'Good':'High';gauge('responseGauge',60);gauge('resolutionGauge',85);gauge('csatGauge',94);gauge('npsGauge',62)}
function updateIndicators(){const open=tickets.filter(t=>t.status==='open').length,urgent=tickets.filter(t=>t.priority==='urgent'&&t.status!=='closed').length;const al=document.getElementById('alertLight'),at=document.getElementById('alertText');if(urgent>0){al.className='light red';at.textContent=urgent+' Urgent'}else if(open>5){al.className='light orange';at.textContent=open+' Open'}else{al.className='light green';at.textContent='System OK'}}

async function loadTenants(){document.getElementById('tenantsLoading').style.display='block';document.getElementById('tenantsTable').style.display='none';if(isConn){try{const r=await fetch(SB_URL+'/rest/v1/tenants?select=*&order=created_at.desc',{headers:{apikey:SB_KEY,Authorization:'Bearer '+SB_KEY}});if(r.ok)tenants=await r.json()}catch(e){}}if(!tenants.length)tenants=[{tenant_id:'1',company_name:'Acme Corp',billing_email:'admin@acme.com',status:'active',monthly_recurring_revenue:299,user_count:12},{tenant_id:'2',company_name:'TechStart Inc',billing_email:'hello@techstart.io',status:'active',monthly_recurring_revenue:149,user_count:5},{tenant_id:'3',company_name:'Demo Company',billing_email:'demo@example.com',status:'trial',monthly_recurring_revenue:0,user_count:2}];renderTenants();updateKPIs()}
function renderTenants(){document.getElementById('tenantsLoading').style.display='none';document.getElementById('tenantsTable').style.display='table';document.getElementById('tenantsBody').innerHTML=tenants.map(t=>'<tr><td><strong>'+(t.company_name||'Unknown')+'</strong></td><td>'+(t.billing_email||'-')+'</td><td><span class="badge badge-purple">'+(t.tier_id||'Starter')+'</span></td><td style="color:var(--green)">$'+(t.monthly_recurring_revenue||0)+'</td><td>'+(t.user_count||1)+'</td><td><span class="badge badge-'+(t.status==='active'?'green':'orange')+'">'+(t.status||'unknown')+'</span></td><td><button class="btn btn-sm">Edit</button></td></tr>').join('')}
function filterTenants(){const s=document.getElementById('tenantSearch').value.toLowerCase();document.querySelectorAll('#tenantsBody tr').forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(s)?'':'none'})}

async function loadTickets(){document.getElementById('ticketsLoading').style.display='block';document.getElementById('ticketsTable').style.display='none';if(isConn){try{const r=await fetch(SB_URL+'/rest/v1/support_tickets?select=*&order=created_at.desc',{headers:{apikey:SB_KEY,Authorization:'Bearer '+SB_KEY}});if(r.ok)tickets=await r.json()}catch(e){}}if(!tickets.length)tickets=[{ticket_id:'1',ticket_number:'1001',subject:'Cannot login to my account',submitter_email:'user@example.com',submitter_name:'John Doe',team:'worklogic_pro',category:'account',priority:'high',status:'open',created_at:new Date().toISOString(),description:'I am unable to login to my account since yesterday.'},{ticket_id:'2',ticket_number:'1002',subject:'Feature request: Dark mode',submitter_email:'jane@example.com',submitter_name:'Jane Smith',team:'sharklaw',category:'feature',priority:'normal',status:'in_progress',created_at:new Date(Date.now()-86400000).toISOString(),description:'Would love dark mode for the dashboard.'},{ticket_id:'3',ticket_number:'1003',subject:'URGENT: Billing discrepancy',submitter_email:'billing@company.com',submitter_name:'Mike Johnson',team:'worklogic_pro',category:'billing',priority:'urgent',status:'open',created_at:new Date(Date.now()-172800000).toISOString(),description:'Charged twice this month. Please refund.'},{ticket_id:'4',ticket_number:'1004',subject:'Export not working',submitter_email:'sarah@tech.io',submitter_name:'Sarah Chen',team:'worklogic_pro',category:'bug',priority:'high',status:'waiting_on_customer',created_at:new Date(Date.now()-259200000).toISOString(),description:'CSV export produces empty file.'},{ticket_id:'5',ticket_number:'1005',subject:'API limits question',submitter_email:'dev@startup.com',submitter_name:'Alex Dev',team:'sharklaw',category:'general',priority:'low',status:'resolved',created_at:new Date(Date.now()-345600000).toISOString(),description:'What are the API rate limits?'}];updateTicketStats();renderTickets();populateTeams();updateIndicators();updateKPIs()}
function updateTicketStats(){const c={open:tickets.filter(t=>t.status==='open').length,progress:tickets.filter(t=>t.status==='in_progress').length,waiting:tickets.filter(t=>t.status==='waiting_on_customer').length,resolved:tickets.filter(t=>t.status==='resolved').length,closed:tickets.filter(t=>t.status==='closed').length,urgent:tickets.filter(t=>t.priority==='urgent'&&t.status!=='closed'&&t.status!=='resolved').length};document.getElementById('statOpen').textContent=c.open;document.getElementById('statProgress').textContent=c.progress;document.getElementById('statWaiting').textContent=c.waiting;document.getElementById('statResolved').textContent=c.resolved;document.getElementById('statClosed').textContent=c.closed;document.getElementById('statUrgent').textContent=c.urgent;const b=document.getElementById('ticketBadge');if(c.open>0){b.textContent=c.open;b.style.display='inline'}else b.style.display='none'}
function populateTeams(){const teams=[...new Set(tickets.map(t=>t.team).filter(Boolean))];document.getElementById('teamFilter').innerHTML='<option value="">All Teams</option>'+teams.map(t=>'<option value="'+t+'">'+t+'</option>').join('')}
function renderTickets(){document.getElementById('ticketsLoading').style.display='none';document.getElementById('ticketsTable').style.display='table';let f=[...tickets];const s=document.getElementById('ticketSearch').value.toLowerCase(),st=document.getElementById('statusFilter').value,pr=document.getElementById('priorityFilter').value,tm=document.getElementById('teamFilter').value;if(s)f=f.filter(t=>(t.subject+' '+t.submitter_email).toLowerCase().includes(s));if(st)f=f.filter(t=>t.status===st);if(pr)f=f.filter(t=>t.priority===pr);if(tm)f=f.filter(t=>t.team===tm);if(!f.length){document.getElementById('ticketsBody').innerHTML='<tr><td colspan="8" class="loading">No tickets found</td></tr>';return}document.getElementById('ticketsBody').innerHTML=f.map(t=>'<tr class="ticket-row" onclick="openTicket(\''+t.ticket_id+'\')"><td><strong>#'+(t.ticket_number||t.ticket_id.slice(0,6))+'</strong></td><td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500">'+esc(t.subject)+'</td><td><div style="font-size:12px">'+esc(t.submitter_name||'Unknown')+'</div><div style="font-size:10px;color:var(--muted)">'+esc(t.submitter_email||'')+'</div></td><td><span class="badge badge-cyan">'+(t.team||'-')+'</span></td><td><span class="priority-dot '+t.priority+'"></span>'+t.priority+'</td><td><span class="status-badge status-'+t.status+'">'+fmtStatus(t.status)+'</span></td><td style="font-size:11px;color:var(--muted)">'+fmtDate(t.created_at)+'</td><td><button class="btn btn-sm" onclick="event.stopPropagation();openTicket(\''+t.ticket_id+'\')">View</button></td></tr>').join('')}
function filterTickets(){renderTickets()}
function filterByStatus(s){document.getElementById('ticketSearch').value='';document.getElementById('priorityFilter').value='';document.getElementById('teamFilter').value='';if(s==='urgent'){document.getElementById('statusFilter').value='';document.getElementById('priorityFilter').value='urgent'}else document.getElementById('statusFilter').value=s;document.querySelectorAll('.stat-card').forEach(c=>c.classList.remove('active'));event.target.closest('.stat-card').classList.add('active');renderTickets()}
function openTicket(id){currentId=id;const t=tickets.find(x=>x.ticket_id===id);if(!t)return;document.getElementById('modalTitle').textContent='Ticket #'+(t.ticket_number||id.slice(0,6));document.getElementById('modalStatus').textContent=fmtStatus(t.status);document.getElementById('modalStatus').className='status-badge status-'+t.status;document.getElementById('modalSubject').textContent=t.subject;document.getElementById('modalDesc').textContent=t.description||'No description.';document.getElementById('metaNumber').textContent='#'+(t.ticket_number||id.slice(0,6));document.getElementById('metaCreated').textContent=fmtDateTime(t.created_at);document.getElementById('metaCategory').textContent=t.category||'-';document.getElementById('metaTeam').textContent=t.team||'-';document.getElementById('metaName').textContent=t.submitter_name||'Unknown';document.getElementById('metaEmail').textContent=t.submitter_email||'-';document.getElementById('statusSelect').value=t.status;document.getElementById('prioritySelect').value=t.priority;loadComments(id);document.getElementById('ticketModal').classList.add('active')}
async function loadComments(id){const c=document.getElementById('commentsList');c.innerHTML='<div class="loading">Loading...</div>';let comments=[];if(isConn){try{const r=await fetch(SB_URL+'/rest/v1/ticket_comments?ticket_id=eq.'+id+'&order=created_at.asc',{headers:{apikey:SB_KEY,Authorization:'Bearer '+SB_KEY}});if(r.ok)comments=await r.json()}catch(e){}}if(!comments.length)comments=[{comment_type:'customer',commenter_name:'Customer',content:'Initial ticket submission',created_at:new Date(Date.now()-3600000).toISOString()},{comment_type:'agent',commenter_name:'Support Team',content:'Thank you for reaching out. We are looking into this.',created_at:new Date(Date.now()-1800000).toISOString()}];renderComments(comments)}
function renderComments(comments){const c=document.getElementById('commentsList');if(!comments.length){c.innerHTML='<p style="color:var(--muted);font-size:12px">No conversation yet.</p>';return}c.innerHTML=comments.map(x=>'<div class="comment '+(x.comment_type==='agent'?'agent':'customer')+(x.is_internal?' internal':'')+'"><div class="comment-head"><span class="comment-author '+(x.comment_type==='agent'?'agent':'')+(x.is_internal?' internal':'')+'">'+(x.comment_type==='agent'?'üë§ ':'')+esc(x.commenter_name||(x.comment_type==='agent'?'Support':'Customer'))+(x.is_internal?'<span style="font-size:9px;padding:2px 8px;border-radius:4px;margin-left:8px;background:rgba(255,149,0,.2);color:var(--orange)">Internal</span>':'')+'</span><span class="comment-time">'+fmtDateTime(x.created_at)+'</span></div><div class="comment-msg">'+esc(x.content)+'</div></div>').join('')}
function setReplyType(t,btn){replyType=t;document.querySelectorAll('.reply-tab').forEach(x=>x.classList.remove('active'));btn.classList.add('active');document.getElementById('replyText').placeholder=t==='internal'?'Internal note (not visible to customer)...':'Type your response...'}
async function submitReply(){const msg=document.getElementById('replyText').value.trim();if(!msg)return alert('Enter a message');if(isConn){try{await fetch(SB_URL+'/rest/v1/ticket_comments',{method:'POST',headers:{apikey:SB_KEY,Authorization:'Bearer '+SB_KEY,'Content-Type':'application/json',Prefer:'return=minimal'},body:JSON.stringify({ticket_id:currentId,content:msg,comment_type:'agent',commenter_name:'Admin',is_internal:replyType==='internal',created_at:new Date().toISOString()})})}catch(e){}}document.getElementById('replyText').value='';loadComments(currentId)}
async function updateStatus(){const s=document.getElementById('statusSelect').value;if(isConn){try{await fetch(SB_URL+'/rest/v1/support_tickets?ticket_id=eq.'+currentId,{method:'PATCH',headers:{apikey:SB_KEY,Authorization:'Bearer '+SB_KEY,'Content-Type':'application/json'},body:JSON.stringify({status:s,updated_at:new Date().toISOString()})})}catch(e){}}document.getElementById('modalStatus').textContent=fmtStatus(s);document.getElementById('modalStatus').className='status-badge status-'+s;const t=tickets.find(x=>x.ticket_id===currentId);if(t)t.status=s;updateTicketStats();renderTickets();updateIndicators();updateKPIs()}
async function updatePriority(){const p=document.getElementById('prioritySelect').value;if(isConn){try{await fetch(SB_URL+'/rest/v1/support_tickets?ticket_id=eq.'+currentId,{method:'PATCH',headers:{apikey:SB_KEY,Authorization:'Bearer '+SB_KEY,'Content-Type':'application/json'},body:JSON.stringify({priority:p,updated_at:new Date().toISOString()})})}catch(e){}}const t=tickets.find(x=>x.ticket_id===currentId);if(t)t.priority=p;updateTicketStats();renderTickets();updateIndicators()}
function quickChangeStatus(){const s=document.getElementById('quickStatus');if(!s.value)return;document.getElementById('statusSelect').value=s.value;updateStatus();s.value=''}
function closeModal(){document.getElementById('ticketModal').classList.remove('active');currentId=null}
function exportTickets(){const csv=['Ticket,Subject,Submitter,Email,Team,Category,Priority,Status,Created'].concat(tickets.map(t=>[t.ticket_number||t.ticket_id.slice(0,6),'"'+(t.subject||'').replace(/"/g,'""')+'"','"'+(t.submitter_name||'').replace(/"/g,'""')+'"',t.submitter_email,t.team,t.category,t.priority,t.status,t.created_at].join(','))).join('\n');const b=new Blob([csv],{type:'text/csv'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='tickets-'+new Date().toISOString().split('T')[0]+'.csv';a.click()}
function fmtStatus(s){return{open:'Open',in_progress:'In Progress',waiting_on_customer:'Waiting',resolved:'Resolved',closed:'Closed'}[s]||s}
function fmtDate(d){return d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'--'}
function fmtDateTime(d){return d?new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}):'--'}
function esc(t){return t?t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):''}
function refreshAll(){loadTenants();loadTickets()}
function exportReport(){const r={generated:new Date().toISOString(),tenants:tenants.length,mrr:tenants.reduce((s,t)=>s+(t.monthly_recurring_revenue||0),0),open_tickets:tickets.filter(t=>t.status==='open').length};const b=new Blob([JSON.stringify(r,null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='report.json';a.click()}
init();
</script>
</body>
</html>
