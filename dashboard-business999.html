<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="stylesheet" href="theme-system.css">
  <style>
    /* ===== INLINE THEME DEFINITIONS ===== */
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8;
    }
    [data-theme="charcoal"] {
      --bg-primary: #121214; --bg-secondary: #18181b; --bg-card: #27272a; --bg-hover: #3f3f46;
      --border-default: #3f3f46; --text-primary: #fafafa; --text-secondary: #a1a1aa;
      --accent-primary: #a1a1aa; --accent-light: #d4d4d8;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80;
    }
    [data-theme="obsidian"] {
      --bg-primary: #050505; --bg-secondary: #0a0a0a; --bg-card: #141414; --bg-hover: #1c1c1c;
      --border-default: #252525; --text-primary: #e0e0e0; --text-secondary: #888888;
      --accent-primary: #0ea5e9; --accent-light: #38bdf8;
    }
    [data-theme="steel"] {
      --bg-primary: #0c0f13; --bg-secondary: #12161c; --bg-card: #1a2028; --bg-hover: #242c38;
      --border-default: #2c3644; --text-primary: #e4e8ed; --text-secondary: #8b95a5;
      --accent-primary: #64748b; --accent-light: #94a3b8;
    }
    [data-theme="espresso"] {
      --bg-primary: #0f0c0a; --bg-secondary: #161210; --bg-card: #211c18; --bg-hover: #2c2520;
      --border-default: #382f28; --text-primary: #f0ebe5; --text-secondary: #a89e94;
      --accent-primary: #a78b6e; --accent-light: #c4a88a;
    }
    [data-theme="onyx"] {
      --bg-primary: #000000; --bg-secondary: #080808; --bg-card: #121212; --bg-hover: #1a1a1a;
      --border-default: #222222; --text-primary: #f5f5f5; --text-secondary: #8c8c8c;
      --accent-primary: #06b6d4; --accent-light: #22d3ee;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: #0b0f14; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); }
    
    .desktop-header {
      position: sticky; top: 0; z-index: 100;
      background: var(--bg-primary); border-bottom: 1px solid var(--border-default);
    }
    
    .mobile-top-header {
      display: none; position: sticky; top: 0; z-index: 100;
      background: var(--bg-secondary); border-bottom: 1px solid var(--border-default);
    }

    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; }
    .mobile-menu-toggle {
      background: transparent; border: 1px solid transparent; border-radius: 6px;
      color: var(--text-secondary); font-size: 20px; padding: 0; width: 36px; height: 36px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .mobile-header-center { flex: 1; margin-left: 12px; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
      padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default);
    }
    .mobile-header-actions button {
      padding: 10px; font-size: 13px;
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--accent-light); border-radius: 8px; cursor: pointer;
    }
    .accordion-icon-header { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s ease; }
    .mobile-menu-toggle.active .accordion-icon-header { transform: rotate(180deg); }

    /* ========== MOBILE BOTTOM NAV - THEMED ========== */
    .mobile-bottom-nav {
      display: none; position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--bg-secondary); padding: 8px; z-index: 100;
    }
    .mobile-nav-top { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 6px; }
    .mobile-nav-secondary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .mobile-nav-btn {
      padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card);
      color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer;
      text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px;
      transition: all 0.2s;
    }
    .mobile-nav-btn:active { transform: scale(0.95); }
    /* Active button - 60% opacity accent color */
    .mobile-nav-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: var(--text-primary);
    }
    /* Related buttons - 10% opacity accent using color-mix */
    .mobile-nav-btn.related {
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--text-primary);
    }
    /* Fallback for browsers without color-mix */
    @supports not (background: color-mix(in srgb, red 50%, blue)) {
      .mobile-nav-btn.active { background: var(--accent-primary); opacity: 0.6; }
      .mobile-nav-btn.related { background: var(--bg-hover); border-color: var(--accent-primary); opacity: 0.5; }
    }
    
    .content { flex: 1; padding: 20px; }
    
    /* Fixed filter bar above mobile nav */
    .filter-bar-fixed {
      display: none; position: fixed; bottom: 102px; left: 0; right: 0;
      background: var(--bg-card); border-top: 1px solid var(--border-default);
      padding: 10px 12px; z-index: 99;
      transform: translateY(100%); opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .filter-bar-fixed.visible { transform: translateY(0); opacity: 1; }
    .filter-bar-row { display: flex; gap: 8px; align-items: center; }
    .filter-bar-fixed .range-select {
      flex: 1; padding: 10px 12px; font-size: 13px; min-width: 0;
      background: var(--bg-secondary); border: 1px solid var(--border-default);
      border-radius: 8px; color: var(--text-primary);
    }
    .filter-bar-fixed .direction-btn {
      padding: 10px 16px; font-size: 13px; min-width: auto;
      background: var(--bg-secondary); border: 1px solid var(--border-default);
      border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
    }
    .filter-bar-fixed .direction-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: var(--text-primary);
    }
    .filter-bar-fixed .date-display {
      width: 100%; text-align: center; font-size: 11px;
      color: var(--accent-light); margin-top: 6px;
    }
    
    .top-bar { 
      background: var(--bg-card); border-bottom: 1px solid var(--border-default); 
      padding: 16px 20px; margin-bottom: 20px; 
    }
    
    .date-range-container {
      display: flex; gap: 12px; align-items: center;
      justify-content: center; margin-bottom: 12px; flex-wrap: wrap;
    }
    
    .range-select {
      padding: 12px 16px; border-radius: 8px;
      border: 2px solid var(--border-default); background: var(--bg-secondary);
      color: var(--text-primary); font-size: 14px; font-weight: 600;
      cursor: pointer; min-width: 180px;
    }
    
    .direction-toggle { display: flex; gap: 8px; }
    
    .direction-btn {
      padding: 12px 24px; border-radius: 8px;
      border: 2px solid var(--border-default); background: var(--bg-secondary);
      color: var(--text-secondary); cursor: pointer; font-size: 14px;
      font-weight: 600; min-width: 100px;
    }
    .direction-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: var(--text-primary);
    }
    
    /* ========== SECTION HEADERS ========== */
    .section-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px; background: var(--bg-card); border-radius: 8px;
      margin-bottom: 8px; cursor: pointer; scroll-margin-top: 70px;
    }
    .section-header:hover { background: var(--bg-hover); }
    .section-header.collapsed { border-radius: 8px; }
    
    .section-header-title {
      font-size: 18px; font-weight: 700; color: var(--accent-light);
      display: flex; align-items: center; gap: 8px;
    }
    
    .section-header-icon {
      font-size: 20px; color: var(--text-secondary); transition: transform 0.2s;
    }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    
    .section-content {
      overflow: hidden; transition: max-height 0.3s ease; margin-bottom: 8px;
    }
    .section-content.collapsed { max-height: 0 !important; margin-bottom: 0; }
    
    /* Badge count - monochrome */
    .badge-count {
      background: var(--bg-hover); color: var(--text-primary);
      padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;
      min-width: 20px; text-align: center; border: 1px solid var(--border-default);
    }
    .badge-count.warning { background: var(--bg-hover); color: var(--text-primary); }
    
    /* KPI Container */
    .kpi-container {
      background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 12px;
    }
    .kpi-container:last-child { margin-bottom: 0; }
    
    .kpi-section-title {
      font-size: 14px; font-weight: 600; color: var(--accent-light);
      margin-bottom: 12px; padding-bottom: 8px;
      border-bottom: 1px solid var(--border-default);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    
    .kpi-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border-default);
    }
    .kpi-row:last-child { border-bottom: none; }
    .kpi-label { font-size: 13px; color: var(--text-secondary); }
    .kpi-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    
    /* ========== DEPARTMENT CARDS ========== */
    .dept-cards-container {
      display: flex; flex-direction: column; gap: 12px;
      background: var(--bg-secondary); padding: 16px; border-radius: 0 0 8px 8px;
    }
    
    .dept-card {
      background: var(--bg-card); border-radius: 12px; padding: 16px;
      border-left: 4px solid var(--accent-primary); cursor: pointer;
      transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .dept-card:hover { border-left-color: var(--accent-light); background: var(--bg-hover); }
    .dept-card.service { border-left-color: #3b82f6; }
    .dept-card.parts { border-left-color: #8b5cf6; }
    .dept-card.sales { border-left-color: #10b981; }
    
    .dept-card-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
    }
    .dept-card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .dept-card-expand {
      font-size: 18px; color: var(--text-secondary); transition: transform 0.2s;
      padding: 4px 8px; cursor: pointer;
    }
    .dept-card.collapsed .dept-card-expand { transform: rotate(-90deg); }
    
    /* Collapsed state - 3 key metrics in a row */
    .dept-card-summary {
      display: flex; gap: 16px; flex-wrap: wrap;
    }
    .dept-card-metric {
      display: flex; flex-direction: column; gap: 2px; min-width: 80px;
    }
    .dept-card-metric-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
    .dept-card-metric-value { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    
    /* Expanded state - full details */
    .dept-card-details {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
      margin-top: 0;
    }
    .dept-card:not(.collapsed) .dept-card-details {
      max-height: 500px; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid var(--border-default);
    }
    .dept-card.collapsed .dept-card-details { max-height: 0; margin-top: 0; }
    
    .dept-detail-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid var(--border-default);
    }
    .dept-detail-row:last-child { border-bottom: none; }
    .dept-detail-label { font-size: 13px; color: var(--text-secondary); }
    .dept-detail-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    
    /* Business Totals Card */
    .totals-card {
      background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 12px;
      border: 1px solid var(--accent-primary);
    }
    .totals-card-title {
      font-size: 14px; font-weight: 600; color: var(--accent-light);
      margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .totals-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .totals-item { display: flex; flex-direction: column; gap: 2px; min-width: 100px; flex: 1; }
    .totals-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
    .totals-value { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    
    .chart-container {
      background: var(--bg-card); padding: 20px; border-radius: 8px; margin-top: 12px;
    }
    .chart-title {
      font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 16px;
    }
    canvas { max-height: 250px; }
    
    /* Inbox/Messages Styles */
    .inbox-container {
      background: var(--bg-secondary); border-radius: 8px; overflow: hidden;
    }
    .inbox-tabs {
      display: flex; gap: 4px; padding: 12px;
      background: var(--bg-card); border-bottom: 1px solid var(--border-default);
      overflow-x: auto;
    }
    .inbox-tab {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default); background: transparent;
      color: var(--text-secondary); font-size: 13px; font-weight: 500;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    .inbox-tab:hover { background: var(--bg-hover); }
    .inbox-tab.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: #fff;
    }
    .inbox-list { max-height: 400px; overflow-y: auto; }
    .inbox-item {
      display: flex; gap: 12px; padding: 12px 16px;
      border-bottom: 1px solid var(--border-default);
      cursor: pointer; transition: background 0.2s;
    }
    .inbox-item:hover { background: var(--bg-hover); }
    .inbox-item.unread {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid var(--accent-primary);
    }
    .inbox-item-content { flex: 1; min-width: 0; }
    .inbox-item-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;
    }
    .inbox-item-title {
      font-weight: 600; font-size: 14px; color: var(--text-primary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .inbox-item-time { font-size: 11px; color: var(--text-secondary); white-space: nowrap; }
    .inbox-item-body {
      font-size: 13px; color: var(--text-secondary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .inbox-item-tag {
      display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px;
      background: var(--bg-hover); color: var(--text-primary); margin-top: 6px;
      border: 1px solid var(--border-default);
    }
    .inbox-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .inbox-empty-icon { font-size: 48px; margin-bottom: 12px; }
    .inbox-actions {
      display: flex; gap: 8px; padding: 12px;
      background: var(--bg-card); border-top: 1px solid var(--border-default);
    }
    .inbox-action-btn {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default); background: transparent;
      color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .inbox-action-btn:hover { background: var(--bg-hover); }
    .inbox-action-btn.primary {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: #fff;
    }
    
    /* Tasks Styles */
    .tasks-container {
      background: var(--bg-secondary); border-radius: 8px; overflow: hidden;
    }
    .tasks-tabs {
      display: flex; gap: 4px; padding: 12px;
      background: var(--bg-card); border-bottom: 1px solid var(--border-default);
      overflow-x: auto;
    }
    .tasks-tab {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default); background: transparent;
      color: var(--text-secondary); font-size: 13px; font-weight: 500;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    .tasks-tab:hover { background: var(--bg-hover); }
    .tasks-tab.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: #fff;
    }
    .tasks-list { max-height: 400px; overflow-y: auto; }
    .task-item {
      display: flex; gap: 12px; padding: 12px 16px;
      border-bottom: 1px solid var(--border-default); align-items: flex-start;
    }
    .task-checkbox {
      width: 22px; height: 22px; border-radius: 50%;
      border: 2px solid var(--border-default); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; margin-top: 2px; transition: all 0.2s;
    }
    .task-checkbox:hover {
      border-color: var(--accent-primary);
      background: rgba(59, 130, 246, 0.1);
    }
    .task-checkbox.completed { background: #10b981; border-color: #10b981; color: #fff; }
    .task-content { flex: 1; min-width: 0; }
    .task-title {
      font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px;
    }
    .task-item.completed .task-title {
      text-decoration: line-through; color: var(--text-secondary);
    }
    .task-description { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
    .task-meta { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .task-meta-item {
      display: flex; align-items: center; gap: 4px;
      font-size: 11px; color: var(--text-secondary);
    }
    .task-meta-item.overdue { color: var(--text-primary); font-weight: 600; }
    .task-priority {
      padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;
      text-transform: uppercase; background: var(--bg-hover); color: var(--text-primary);
      border: 1px solid var(--border-default);
    }
    .tasks-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .tasks-empty-icon { font-size: 48px; margin-bottom: 12px; }
    .tasks-actions {
      display: flex; gap: 8px; padding: 12px;
      background: var(--bg-card); border-top: 1px solid var(--border-default);
    }
    .tasks-action-btn {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default); background: transparent;
      color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .tasks-action-btn:hover { background: var(--bg-hover); }
    .tasks-action-btn.primary {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: #fff;
    }
    
    /* Employees Section Styles */
    .employees-container {
      background: var(--bg-secondary); border-radius: 8px; overflow: hidden;
    }
    .employees-header {
      padding: 12px 16px; background: var(--bg-card);
      border-bottom: 1px solid var(--border-default);
    }
    .employees-summary { display: flex; gap: 16px; flex-wrap: wrap; }
    .emp-stat {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; color: var(--text-secondary);
    }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.green { background: #10b981; }
    .status-dot.yellow { background: #f59e0b; }
    .status-dot.red { background: #ef4444; }
    .status-dot.gray { background: #6b7280; }
    .employees-list { max-height: 600px; overflow-y: auto; }
    .employees-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .employees-empty-icon { font-size: 48px; margin-bottom: 12px; color: var(--text-secondary); }
    .employees-actions {
      display: flex; gap: 8px; padding: 12px;
      background: var(--bg-card); border-top: 1px solid var(--border-default);
    }
    .dept-group { border-bottom: 1px solid var(--border-default); }
    .dept-group:last-child { border-bottom: none; }
    .dept-header {
      padding: 10px 16px; background: var(--bg-hover);
      font-size: 12px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--accent-light);
    }
    .emp-strip { border-bottom: 1px solid var(--border-default); transition: background 0.2s; }
    .emp-strip:last-child { border-bottom: none; }
    .emp-strip.no-show { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; }
    .emp-strip-header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; cursor: pointer;
    }
    .emp-strip-header:hover { background: var(--bg-hover); }
    .emp-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--bg-card); display: flex;
      align-items: center; justify-content: center;
      font-size: 16px; font-weight: 600; color: var(--accent-light);
      flex-shrink: 0; overflow: hidden;
    }
    .emp-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 15px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .emp-phone { font-size: 13px; color: var(--text-secondary); }
    .emp-status {
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      padding: 4px 8px; border-radius: 4px;
      background: var(--bg-hover); color: var(--text-secondary);
      border: 1px solid var(--border-default);
    }
    .emp-status.clocked-in { color: #10b981; border-color: #10b981; }
    .emp-status.scheduled { color: #f59e0b; border-color: #f59e0b; }
    .emp-status.no-show { color: #ef4444; border-color: #ef4444; }
    
    /* Modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: var(--bg-secondary); border-radius: 12px;
      width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      border: 1px solid var(--border-default);
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; border-bottom: 1px solid var(--border-default);
    }
    .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .modal-close {
      background: transparent; border: none; color: var(--text-secondary);
      font-size: 24px; cursor: pointer; padding: 0; line-height: 1;
    }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block; font-size: 13px; font-weight: 500;
      color: var(--text-secondary); margin-bottom: 6px;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 10px 12px; border-radius: 6px;
      border: 1px solid var(--border-default); background: var(--bg-card);
      color: var(--text-primary); font-size: 14px;
    }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer {
      display: flex; gap: 12px; justify-content: flex-end;
      padding: 16px 20px; border-top: 1px solid var(--border-default);
    }
    .btn-secondary {
      padding: 10px 20px; border-radius: 6px;
      border: 1px solid var(--border-default); background: transparent;
      color: var(--text-secondary); font-size: 14px; cursor: pointer;
    }
    .btn-primary {
      padding: 10px 20px; border-radius: 6px; border: none;
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      color: #fff; font-size: 14px; font-weight: 500; cursor: pointer;
    }
    
    /* Icons */
    .icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 18px; height: 18px; flex-shrink: 0;
    }
    .icon svg { width: 100%; height: 100%; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .icon-lg { width: 24px; height: 24px; }
    .icon-xl { width: 32px; height: 32px; }
    .inbox-item-icon {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--bg-card); display: flex;
      align-items: center; justify-content: center; flex-shrink: 0;
      color: var(--text-secondary);
    }
    .inbox-item-icon .icon { width: 20px; height: 20px; }
    .inbox-item.unread .inbox-item-icon { color: var(--accent-light); }
    .section-header-icon-svg { color: var(--accent-light); margin-right: 4px; }
    
    /* Desktop header buttons - themed */
    .desktop-dept-btn {
      padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px;
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--accent-light); transition: all 0.2s;
    }
    .desktop-dept-btn:hover {
      background: color-mix(in srgb, var(--accent-primary) 20%, transparent);
    }
    .desktop-dept-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary); color: var(--text-primary);
    }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      .filter-bar-fixed { display: block; }
      .top-bar { display: none; }
      body { padding-bottom: 102px; }
      body.filter-bar-open { padding-bottom: 160px; }
      .content { padding: 12px; }
      .form-row { grid-template-columns: 1fr; }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .filter-bar-fixed { display: none !important; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span class="accordion-icon-header">☰</span></button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Business Dashboard</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='dashboard-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:32px; font-weight:600;">Business Dashboard</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px;">
      <a href="dashboard-business.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Dashboard</a>
      <a href="dashboard-customer-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Customers</a>
      <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Vehicles</a>
      <a href="dashboard-settings.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Settings</a>
    </nav>
  </div>
  <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
    <div style="display:flex; gap:12px; justify-content:flex-end;">
      <button onclick="location.href='dashboard-service.html'" class="desktop-dept-btn">Service</button>
      <button onclick="location.href='dashboard-parts.html'" class="desktop-dept-btn">Parts</button>
      <button onclick="location.href='dashboard-sales.html'" class="desktop-dept-btn">Sales</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="top-bar">
    <div class="date-range-container">
      <select id="rangeSelect" class="range-select" onchange="rangeChanged()">
        <option value="today">Today</option>
        <option value="week">1 Week</option>
        <option value="30days" selected>30 Days</option>
        <option value="60days">60 Days</option>
        <option value="90days">90 Days</option>
        <option value="ytd">Year to Date</option>
      </select>
      <div class="direction-toggle">
        <button class="direction-btn active" id="pastBtn" onclick="setDirection('past')">Past</button>
        <button class="direction-btn" id="futureBtn" onclick="setDirection('future')">Future</button>
      </div>
    </div>
    <div style="text-align:center; color:var(--text-secondary); font-size:13px; margin-top:8px;">
      <span id="dateRangeDisplay" style="color:var(--accent-light); font-weight:600;">30 Days (Past)</span>
    </div>
  </div>

  <div class="content">
    
    <!-- Messages & Notifications Section -->
    <div class="section-header collapsed" onclick="toggleSection('messages')">
      <div class="section-header-title">
        <span class="icon section-header-icon-svg"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
        Messages & Notifications
        <span class="badge-count" id="messagesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="messagesContent">
      <div class="inbox-container">
        <div class="inbox-tabs">
          <button class="inbox-tab active" data-tab="all" onclick="switchInboxTab('all', this)">All</button>
          <button class="inbox-tab" data-tab="unread" onclick="switchInboxTab('unread', this)">Unread</button>
          <button class="inbox-tab" data-tab="wo_notes" onclick="switchInboxTab('wo_notes', this)">WO Notes</button>
        </div>
        <div class="inbox-list" id="inboxList">
          <div class="inbox-empty">
            <div class="inbox-empty-icon"><span class="icon icon-xl"><svg viewBox="0 0 24 24"><path d="M22 12h-6l-2 3h-4l-2-3H2"></path><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg></span></div>
            <div>No messages yet</div>
          </div>
        </div>
        <div class="inbox-actions">
          <button class="inbox-action-btn" onclick="markAllNotificationsRead()">Mark All Read</button>
          <button class="inbox-action-btn" onclick="loadInboxData()">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="section-header collapsed" onclick="toggleSection('tasks')">
      <div class="section-header-title">
        <span class="icon section-header-icon-svg"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></span>
        Tasks
        <span class="badge-count warning" id="tasksBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="tasksContent">
      <div class="tasks-container">
        <div class="tasks-tabs">
          <button class="tasks-tab active" data-tab="pending" onclick="switchTasksTab('pending', this)">Pending</button>
          <button class="tasks-tab" data-tab="in_progress" onclick="switchTasksTab('in_progress', this)">In Progress</button>
          <button class="tasks-tab" data-tab="overdue" onclick="switchTasksTab('overdue', this)">Overdue</button>
          <button class="tasks-tab" data-tab="completed" onclick="switchTasksTab('completed', this)">Done</button>
        </div>
        <div class="tasks-list" id="tasksList">
          <div class="tasks-empty">
            <div class="tasks-empty-icon"><span class="icon icon-xl"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></span></div>
            <div>No tasks</div>
          </div>
        </div>
        <div class="tasks-actions">
          <button class="tasks-action-btn primary" onclick="openNewTaskModal()">+ New Task</button>
        </div>
      </div>
    </div>

    <!-- Employees Section -->
    <div class="section-header collapsed" onclick="toggleSection('employees')">
      <div class="section-header-title">
        <span class="icon section-header-icon-svg"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
        Employees
        <span class="badge-count" id="employeesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="employeesContent">
      <div class="employees-container">
        <div class="employees-header">
          <div class="employees-summary">
            <span class="emp-stat"><span class="status-dot green"></span> <span id="clockedInCount">0</span> Clocked In</span>
            <span class="emp-stat"><span class="status-dot yellow"></span> <span id="scheduledLaterCount">0</span> Later</span>
            <span class="emp-stat"><span class="status-dot red"></span> <span id="noShowCount">0</span> No Show</span>
          </div>
        </div>
        <div class="employees-list" id="employeesList">
          <div class="employees-empty">
            <div class="employees-empty-icon"><span class="icon icon-xl"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg></span></div>
            <div>Loading employees...</div>
          </div>
        </div>
        <div class="employees-actions" id="employeesActions" style="display:none;">
          <button class="tasks-action-btn primary" onclick="openNewEmployeeModal()">+ Add Employee</button>
        </div>
      </div>
    </div>

    <!-- COMBINED: Overall Business Summary -->
    <div class="section-header collapsed" onclick="toggleSummarySection(event)" id="summaryHeader">
      <div class="section-header-title">Overall Business Summary</div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="summaryContent">
      <div class="dept-cards-container">
        
        <!-- Business Totals -->
        <div class="totals-card">
          <div class="totals-card-title">Business Totals</div>
          <div class="totals-row">
            <div class="totals-item">
              <span class="totals-label">Total Revenue</span>
              <span class="totals-value" id="totalRevenue">$0</span>
            </div>
            <div class="totals-item">
              <span class="totals-label">Customers</span>
              <span class="totals-value" id="totalCustomers">0</span>
            </div>
            <div class="totals-item">
              <span class="totals-label">Vehicles</span>
              <span class="totals-value" id="totalVehicles">0</span>
            </div>
          </div>
        </div>
        
        <!-- Service Department Card -->
        <div class="dept-card service collapsed" onclick="toggleDeptCard(event, 'service')">
          <div class="dept-card-header">
            <div class="dept-card-title">Service Department</div>
            <div class="dept-card-expand">▼</div>
          </div>
          <div class="dept-card-summary">
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Revenue</span>
              <span class="dept-card-metric-value" id="serviceRevenueSummary">$0</span>
            </div>
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Completed</span>
              <span class="dept-card-metric-value" id="serviceOrdersSummary">0</span>
            </div>
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">In Progress</span>
              <span class="dept-card-metric-value" id="serviceInProgressSummary">0</span>
            </div>
          </div>
          <div class="dept-card-details">
            <div class="dept-detail-row">
              <span class="dept-detail-label">Service Revenue</span>
              <span class="dept-detail-value" id="serviceRevenue">$0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Work Orders Completed</span>
              <span class="dept-detail-value" id="serviceOrders">0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Avg Ticket</span>
              <span class="dept-detail-value" id="serviceAvgTicket">$0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">In Progress</span>
              <span class="dept-detail-value" id="serviceInProgress">0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Scheduled</span>
              <span class="dept-detail-value" id="serviceScheduled">0</span>
            </div>
          </div>
        </div>
        
        <!-- Parts Department Card -->
        <div class="dept-card parts collapsed" onclick="toggleDeptCard(event, 'parts')">
          <div class="dept-card-header">
            <div class="dept-card-title">Parts Department</div>
            <div class="dept-card-expand">▼</div>
          </div>
          <div class="dept-card-summary">
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Inventory</span>
              <span class="dept-card-metric-value" id="partsInventorySummary">$0</span>
            </div>
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Items</span>
              <span class="dept-card-metric-value" id="partsTotalSummary">0</span>
            </div>
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Low Stock</span>
              <span class="dept-card-metric-value" id="partsLowStockSummary">0</span>
            </div>
          </div>
          <div class="dept-card-details">
            <div class="dept-detail-row">
              <span class="dept-detail-label">Inventory Value</span>
              <span class="dept-detail-value" id="partsInventoryValue">$0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Total Items</span>
              <span class="dept-detail-value" id="partsTotalItems">0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Low Stock Items</span>
              <span class="dept-detail-value" id="partsLowStock">0</span>
            </div>
          </div>
        </div>
        
        <!-- Sales Department Card -->
        <div class="dept-card sales collapsed" onclick="toggleDeptCard(event, 'sales')">
          <div class="dept-card-header">
            <div class="dept-card-title">Sales Department</div>
            <div class="dept-card-expand">▼</div>
          </div>
          <div class="dept-card-summary">
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Revenue</span>
              <span class="dept-card-metric-value" id="salesRevenueSummary">$0</span>
            </div>
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Deals</span>
              <span class="dept-card-metric-value" id="salesDealsSummary">0</span>
            </div>
            <div class="dept-card-metric">
              <span class="dept-card-metric-label">Win Rate</span>
              <span class="dept-card-metric-value" id="salesWinRateSummary">0%</span>
            </div>
          </div>
          <div class="dept-card-details">
            <div class="dept-detail-row">
              <span class="dept-detail-label">Sales Revenue</span>
              <span class="dept-detail-value" id="salesRevenue">$0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Deals Closed</span>
              <span class="dept-detail-value" id="salesDeals">0</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Win Rate</span>
              <span class="dept-detail-value" id="salesWinRate">0%</span>
            </div>
            <div class="dept-detail-row">
              <span class="dept-detail-label">Pipeline Value</span>
              <span class="dept-detail-value" id="salesPipeline">$0</span>
            </div>
          </div>
        </div>
        
        <!-- Charts -->
        <div class="chart-container">
          <div class="chart-title">Revenue by Department</div>
          <canvas id="summaryRevenueChart"></canvas>
        </div>
        
        <div class="chart-container">
          <div class="chart-title">Work Orders by Status</div>
          <canvas id="serviceStatusChart"></canvas>
        </div>
        
        <div class="chart-container">
          <div class="chart-title">Sales Pipeline by Stage</div>
          <canvas id="salesPipelineChart"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- New Task Modal -->
<div class="modal-overlay" id="newTaskModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">New Task</div>
      <button class="modal-close" onclick="closeNewTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Task Title *</label>
        <input type="text" class="form-input" id="taskTitle" placeholder="Enter task title">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-select" id="taskPriority">
            <option value="low">Low</option>
            <option value="normal" selected>Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" class="form-input" id="taskDueDate">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Assign To</label>
        <select class="form-select" id="taskAssignee"><option value="">-- Select Employee --</option></select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewTaskModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- Employee View Modal -->
<div class="modal-overlay" id="employeeViewModal">
  <div class="modal-content" style="max-width: 550px;">
    <div class="modal-header">
      <div class="modal-title" id="empViewModalTitle">Employee Details</div>
      <button class="modal-close" onclick="closeEmployeeViewModal()">&times;</button>
    </div>
    <div class="modal-body" id="empViewModalBody" style="max-height: 75vh; overflow-y: auto;"></div>
  </div>
</div>

<!-- New Employee Modal -->
<div class="modal-overlay" id="newEmployeeModal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <div class="modal-title">Add New Employee</div>
      <button class="modal-close" onclick="closeNewEmployeeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">First Name *</label>
          <input type="text" class="form-input" id="newEmpFirstName" placeholder="First name">
        </div>
        <div class="form-group">
          <label class="form-label">Last Name *</label>
          <input type="text" class="form-input" id="newEmpLastName" placeholder="Last name">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="newEmpEmail" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Phone *</label>
          <input type="tel" class="form-input" id="newEmpPhone" placeholder="(555) 123-4567">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Department</label>
          <select class="form-select" id="newEmpDepartment">
            <option value="">-- Select --</option>
            <option value="service">Service</option>
            <option value="parts">Parts</option>
            <option value="sales">Sales</option>
            <option value="admin">Admin</option>
            <option value="management">Management</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" id="newEmpRole">
            <option value="">-- Select --</option>
            <option value="technician">Technician</option>
            <option value="service_advisor">Service Advisor</option>
            <option value="parts_counter">Parts Counter</option>
            <option value="sales_consultant">Sales Consultant</option>
            <option value="manager">Manager</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Hire Date</label>
        <input type="date" class="form-input" id="newEmpHireDate">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewEmployeeModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewEmployee()">Add Employee</button>
    </div>
  </div>
</div>

<!-- Fixed Filter Bar (Mobile) - Shows only when Summary is expanded -->
<div class="filter-bar-fixed" id="filterBarFixed">
  <div class="filter-bar-row">
    <select id="rangeSelectMobile" class="range-select" onchange="rangeChangedMobile()">
      <option value="today">Today</option>
      <option value="week">1 Week</option>
      <option value="30days" selected>30 Days</option>
      <option value="60days">60 Days</option>
      <option value="90days">90 Days</option>
      <option value="ytd">Year to Date</option>
    </select>
    <button class="direction-btn active" id="pastBtnMobile" onclick="setDirectionMobile('past')">Past</button>
    <button class="direction-btn" id="futureBtnMobile" onclick="setDirectionMobile('future')">Future</button>
  </div>
  <div class="date-display" id="dateRangeDisplayMobile">30 Days (Past)</div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-business.html" class="mobile-nav-btn active">Business</a>
    <a href="dashboard-search.html" class="mobile-nav-btn">Search</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn related">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn related">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn related">Sales</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentRange = '30days', currentDirection = 'past';
let startDate = new Date(), endDate = new Date();
let charts = {}, currentUserId = null, currentTenantId = null;
let currentInboxTab = 'all', currentTasksTab = 'pending';
let allNotifications = [], allTasks = [], allEmployees = [];
let allEmployeesData = [], timeClockData = [], scheduleData = [];
let currentUserRole = null, isOwner = false;

function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

function toggleMobileMenu(button) {
  document.getElementById('mobileHeaderContent').classList.toggle('expanded');
  button.classList.toggle('active');
}

async function logout() {
  await sb.auth.signOut();
  localStorage.removeItem("sb_access_token"); localStorage.removeItem("sb_refresh_token");
  Object.keys(localStorage).forEach(key => { if (key.startsWith('sb-')) localStorage.removeItem(key); });
  location.replace("login.html?logout=1");
}

function toggleSection(sectionId) {
  const content = document.getElementById(sectionId + 'Content');
  const header = event.currentTarget;
  const wasCollapsed = content.classList.contains('collapsed');
  
  content.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
  content.style.maxHeight = content.classList.contains('collapsed') ? '0px' : content.scrollHeight + 'px';
  
  if (wasCollapsed) {
    setTimeout(() => { header.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
  }
}

// Special toggle for Summary section - controls filter bar visibility
function toggleSummarySection(event) {
  const content = document.getElementById('summaryContent');
  const header = document.getElementById('summaryHeader');
  const filterBar = document.getElementById('filterBarFixed');
  const wasCollapsed = content.classList.contains('collapsed');
  
  content.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
  content.style.maxHeight = content.classList.contains('collapsed') ? '0px' : content.scrollHeight + 'px';
  
  // Show/hide filter bar based on section state
  if (wasCollapsed) {
    filterBar.classList.add('visible');
    document.body.classList.add('filter-bar-open');
    setTimeout(() => { header.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
  } else {
    filterBar.classList.remove('visible');
    document.body.classList.remove('filter-bar-open');
  }
}

// Toggle individual department cards
function toggleDeptCard(event, deptId) {
  event.stopPropagation();
  const card = event.currentTarget;
  card.classList.toggle('collapsed');
  
  // Update parent container height
  const content = document.getElementById('summaryContent');
  setTimeout(() => { content.style.maxHeight = content.scrollHeight + 'px'; }, 50);
}

// ========== INBOX / MESSAGES ==========
async function loadInboxData() {
  try {
    if (!currentTenantId) return;
    const { data: notifications } = await sb.from('notifications').select('*').eq('tenant_id', currentTenantId).order('created_at', { ascending: false }).limit(50);
    allNotifications = notifications || [];
    const { data: woNotes } = await sb.from('work_order_notes').select('*').eq('tenant_id', currentTenantId).eq('requires_manager_review', true).order('created_at', { ascending: false }).limit(20);
    if (woNotes && woNotes.length > 0) {
      const noteItems = woNotes.map(note => ({ notification_id: 'note_' + note.note_id, notification_type: 'wo_note', title: 'WO Note - Review Required', body: note.content, priority: 'high', is_read: false, created_at: note.created_at, source_type: 'work_order_note', source_id: note.work_order_id }));
      allNotifications = [...noteItems, ...allNotifications];
    }
    renderInbox(); updateInboxBadge();
  } catch (error) { console.error('Error loading inbox:', error); }
}

function renderInbox() {
  const container = document.getElementById('inboxList');
  let filtered = allNotifications;
  if (currentInboxTab === 'unread') filtered = allNotifications.filter(n => !n.is_read);
  else if (currentInboxTab === 'wo_notes') filtered = allNotifications.filter(n => n.notification_type === 'wo_note');
  if (filtered.length === 0) {
    container.innerHTML = `<div class="inbox-empty"><div class="inbox-empty-icon"><span class="icon icon-xl"><svg viewBox="0 0 24 24"><path d="M22 12h-6l-2 3h-4l-2-3H2"></path><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg></span></div><div>No ${currentInboxTab === 'unread' ? 'unread ' : ''}messages</div></div>`;
    return;
  }
  const iconSvgs = { 'message': '<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>', 'wo_note': '<svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>', 'system': '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>' };
  container.innerHTML = filtered.map(item => {
    const iconSvg = iconSvgs[item.notification_type] || iconSvgs['system'];
    const timeAgo = formatTimeAgo(item.created_at);
    const priorityTag = (item.priority === 'urgent' || item.priority === 'high') ? `<span class="inbox-item-tag ${item.priority}">${item.priority}</span>` : '';
    return `<div class="inbox-item ${item.is_read ? '' : 'unread'}" onclick="handleInboxClick('${item.notification_id}', '${item.source_type || ''}', '${item.source_id || ''}')"><div class="inbox-item-icon"><span class="icon">${iconSvg}</span></div><div class="inbox-item-content"><div class="inbox-item-header"><div class="inbox-item-title">${item.title || 'Notification'}</div><div class="inbox-item-time">${timeAgo}</div></div><div class="inbox-item-body">${item.body || ''}</div>${priorityTag}</div></div>`;
  }).join('');
}

function switchInboxTab(tab, btn) { currentInboxTab = tab; document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); renderInbox(); }
async function handleInboxClick(id, sourceType, sourceId) { if (!id.startsWith('note_')) await sb.from('notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('notification_id', id); if (sourceType === 'work_order_note' || sourceType === 'work_order') window.location.href = `work-order-edit.html?id=${sourceId}`; loadInboxData(); }
async function markAllNotificationsRead() { await sb.from('notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('is_read', false); loadInboxData(); }
function updateInboxBadge() { const unreadCount = allNotifications.filter(n => !n.is_read).length; const badge = document.getElementById('messagesBadge'); if (unreadCount > 0) { badge.textContent = unreadCount > 99 ? '99+' : unreadCount; badge.style.display = 'inline-block'; } else { badge.style.display = 'none'; } }

// ========== TASKS ==========
async function loadTasksData() { try { if (!currentTenantId) return; const { data: tasks } = await sb.from('tasks').select('*').eq('tenant_id', currentTenantId).order('due_at', { ascending: true }); allTasks = tasks || []; renderTasks(); updateTasksBadge(); } catch (error) { console.error('Error loading tasks:', error); } }
function renderTasks() {
  const container = document.getElementById('tasksList');
  const now = new Date();
  let filtered = allTasks;
  if (currentTasksTab === 'pending') filtered = allTasks.filter(t => t.status === 'pending' || t.status === 'todo');
  else if (currentTasksTab === 'in_progress') filtered = allTasks.filter(t => t.status === 'in_progress');
  else if (currentTasksTab === 'overdue') filtered = allTasks.filter(t => t.status !== 'completed' && t.due_at && new Date(t.due_at) < now);
  else if (currentTasksTab === 'completed') filtered = allTasks.filter(t => t.status === 'completed');
  if (filtered.length === 0) { const msgs = { 'pending': 'No pending tasks', 'in_progress': 'No tasks in progress', 'overdue': 'No overdue tasks', 'completed': 'No completed tasks yet' }; container.innerHTML = `<div class="tasks-empty"><div class="tasks-empty-icon"><span class="icon icon-xl"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></span></div><div>${msgs[currentTasksTab]}</div></div>`; return; }
  container.innerHTML = filtered.map(task => { const isCompleted = task.status === 'completed'; const isOverdue = task.due_at && new Date(task.due_at) < now && !isCompleted; const dueText = task.due_at ? formatDueDate(task.due_at) : ''; const priorityClass = task.priority || 'normal'; return `<div class="task-item ${isCompleted ? 'completed' : ''}"><div class="task-checkbox ${isCompleted ? 'completed' : ''}" onclick="toggleTaskComplete('${task.task_id}', ${!isCompleted})">${isCompleted ? '✓' : ''}</div><div class="task-content"><div class="task-title">${task.title}</div>${task.description ? `<div class="task-description">${task.description}</div>` : ''}<div class="task-meta"><span class="task-priority ${priorityClass}">${priorityClass}</span>${dueText ? `<span class="task-meta-item ${isOverdue ? 'overdue' : ''}">${dueText}</span>` : ''}</div></div></div>`; }).join('');
}
function switchTasksTab(tab, btn) { currentTasksTab = tab; document.querySelectorAll('.tasks-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); renderTasks(); }
async function toggleTaskComplete(taskId, completed) { await sb.from('tasks').update({ status: completed ? 'completed' : 'pending', completed_at: completed ? new Date().toISOString() : null }).eq('task_id', taskId); loadTasksData(); }
function updateTasksBadge() { const pendingCount = allTasks.filter(t => t.status !== 'completed').length; const badge = document.getElementById('tasksBadge'); if (pendingCount > 0) { badge.textContent = pendingCount > 99 ? '99+' : pendingCount; badge.style.display = 'inline-block'; } else { badge.style.display = 'none'; } }
function formatDueDate(dateStr) { const date = new Date(dateStr), now = new Date(); const days = Math.ceil((date - now) / (1000 * 60 * 60 * 24)); if (days < 0) return `${Math.abs(days)} days overdue`; if (days === 0) return 'Due today'; if (days === 1) return 'Due tomorrow'; if (days <= 7) return `Due in ${days} days`; return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }

// ========== EMPLOYEES ==========
async function loadEmployeesData() { try { if (!currentTenantId) return; const { data: employees } = await sb.from('employees').select('*').eq('tenant_id', currentTenantId).order('department', { ascending: true }).order('last_name', { ascending: true }); allEmployeesData = employees || []; const today = new Date(); const todayStr = today.toISOString().split('T')[0]; const { data: timeClock } = await sb.from('time_clock').select('*').eq('tenant_id', currentTenantId).gte('clock_in', todayStr + 'T00:00:00').lte('clock_in', todayStr + 'T23:59:59'); timeClockData = timeClock || []; const { data: schedules } = await sb.from('employee_schedules').select('*').eq('tenant_id', currentTenantId).eq('schedule_date', todayStr); scheduleData = schedules || []; const userEmail = (await sb.auth.getUser()).data?.user?.email; const currentEmp = allEmployeesData.find(e => e.user_id === currentUserId || e.email === userEmail); currentUserRole = currentEmp?.role || null; isOwner = currentUserRole === 'owner'; renderEmployees(); updateEmployeesBadge(); if (isOwner) document.getElementById('employeesActions').style.display = 'flex'; } catch (error) { console.error('Error loading employees:', error); } }
function getEmployeeStatus(employee) { const now = new Date(); const currentHour = now.getHours(); const clockEntry = timeClockData.find(tc => tc.employee_id === employee.employee_id && !tc.clock_out); if (clockEntry) return { status: 'clocked-in', label: 'Clocked In', dot: 'green' }; const schedule = scheduleData.find(s => s.employee_id === employee.employee_id); if (schedule) { const startTime = schedule.start_time ? parseInt(schedule.start_time.split(':')[0]) : null; const endTime = schedule.end_time ? parseInt(schedule.end_time.split(':')[0]) : null; if (startTime !== null && currentHour >= startTime && (endTime === null || currentHour < endTime)) { return { status: 'no-show', label: 'No Show', dot: 'red', isNoShow: true }; } if (startTime !== null && currentHour < startTime) { return { status: 'scheduled', label: `Scheduled ${formatScheduleTime(schedule.start_time)}`, dot: 'yellow' }; } const completedClock = timeClockData.find(tc => tc.employee_id === employee.employee_id && tc.clock_out); if (completedClock) return { status: 'off', label: 'Shift Complete', dot: 'gray' }; } return { status: 'off', label: 'Off Today', dot: 'gray' }; }
function formatScheduleTime(timeStr) { if (!timeStr) return ''; const [hours, mins] = timeStr.split(':'); const h = parseInt(hours); const ampm = h >= 12 ? 'PM' : 'AM'; const h12 = h % 12 || 12; return `${h12}:${mins} ${ampm}`; }
function renderEmployees() { const container = document.getElementById('employeesList'); if (allEmployeesData.length === 0) { container.innerHTML = `<div class="employees-empty"><div class="employees-empty-icon"><span class="icon icon-xl"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg></span></div><div>No employees found</div></div>`; return; } const employeesWithStatus = allEmployeesData.map(emp => ({ ...emp, statusInfo: getEmployeeStatus(emp) })); employeesWithStatus.sort((a, b) => { if (a.statusInfo.isNoShow && !b.statusInfo.isNoShow) return -1; if (!a.statusInfo.isNoShow && b.statusInfo.isNoShow) return 1; return (a.department || 'zzz').localeCompare(b.department || 'zzz'); }); const clockedIn = employeesWithStatus.filter(e => e.statusInfo.status === 'clocked-in').length; const scheduledLater = employeesWithStatus.filter(e => e.statusInfo.status === 'scheduled').length; const noShow = employeesWithStatus.filter(e => e.statusInfo.isNoShow).length; document.getElementById('clockedInCount').textContent = clockedIn; document.getElementById('scheduledLaterCount').textContent = scheduledLater; document.getElementById('noShowCount').textContent = noShow; const noShows = employeesWithStatus.filter(e => e.statusInfo.isNoShow); const others = employeesWithStatus.filter(e => !e.statusInfo.isNoShow); const departments = {}; others.forEach(emp => { const dept = emp.department || 'Unassigned'; if (!departments[dept]) departments[dept] = []; departments[dept].push(emp); }); let html = ''; if (noShows.length > 0) { html += `<div class="dept-group"><div class="dept-header" style="background:rgba(239,68,68,0.2); color:#f87171;">⚠️ No Shows</div>${noShows.map(emp => renderEmployeeStrip(emp)).join('')}</div>`; } const deptOrder = ['management', 'service', 'parts', 'sales', 'admin', 'Unassigned']; deptOrder.forEach(dept => { if (departments[dept] && departments[dept].length > 0) { const deptLabel = dept.charAt(0).toUpperCase() + dept.slice(1); html += `<div class="dept-group"><div class="dept-header">${deptLabel} (${departments[dept].length})</div>${departments[dept].map(emp => renderEmployeeStrip(emp)).join('')}</div>`; } }); container.innerHTML = html; }
function renderEmployeeStrip(emp) { const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown'; const initials = `${(emp.first_name || 'U')[0]}${(emp.last_name || '')[0] || ''}`.toUpperCase(); const phone = emp.phone || emp.phone_number || '--'; const statusInfo = emp.statusInfo; const avatarContent = emp.avatar_url ? `<img src="${emp.avatar_url}" alt="${name}">` : initials; return `<div class="emp-strip ${statusInfo.isNoShow ? 'no-show' : ''}" onclick="openEmployeeViewModal('${emp.employee_id}')"><div class="emp-strip-header"><div class="emp-avatar">${avatarContent}</div><div class="emp-info"><div class="emp-name">${name}</div><div class="emp-phone">${phone}</div></div><div class="emp-status ${statusInfo.status}"><span class="status-dot ${statusInfo.dot}"></span>${statusInfo.label}</div></div></div>`; }
function openEmployeeViewModal(empId) { const emp = allEmployeesData.find(e => e.employee_id === empId); if (!emp) return; const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown'; const phone = emp.phone || emp.phone_number || '--'; const statusInfo = getEmployeeStatus(emp); const modalContent = `<div style="text-align:center; margin-bottom:20px;"><div style="width:60px;height:60px;border-radius:50%;background:var(--bg-card);display:inline-flex;align-items:center;justify-content:center;font-size:24px;font-weight:600;color:var(--accent-light);margin-bottom:12px;">${emp.avatar_url ? `<img src="${emp.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : `${(emp.first_name || 'U')[0]}${(emp.last_name || '')[0] || ''}`}</div><div style="font-size:18px;font-weight:600;color:var(--text-primary);">${name}</div><div style="font-size:14px;color:var(--text-secondary);">${(emp.role || '--').replace(/_/g, ' ')} • ${(emp.department || '--').replace(/_/g, ' ')}</div><div class="emp-status ${statusInfo.status}" style="margin-top:8px;display:inline-flex;"><span class="status-dot ${statusInfo.dot}"></span>${statusInfo.label}</div></div><div class="kpi-container"><div class="kpi-row"><span class="kpi-label">Phone</span><span class="kpi-value"><a href="tel:${phone}" style="color:var(--accent-light);text-decoration:none;">${phone}</a></span></div><div class="kpi-row"><span class="kpi-label">Email</span><span class="kpi-value">${emp.email ? `<a href="mailto:${emp.email}" style="color:var(--accent-light);text-decoration:none;">${emp.email}</a>` : '--'}</span></div><div class="kpi-row"><span class="kpi-label">Hire Date</span><span class="kpi-value">${emp.hire_date ? new Date(emp.hire_date).toLocaleDateString() : '--'}</span></div></div>`; document.getElementById('empViewModalBody').innerHTML = modalContent; document.getElementById('empViewModalTitle').textContent = name; document.getElementById('employeeViewModal').classList.add('active'); }
function closeEmployeeViewModal() { document.getElementById('employeeViewModal').classList.remove('active'); }
function updateEmployeesBadge() { const noShowCount = allEmployeesData.filter(emp => getEmployeeStatus(emp).isNoShow).length; const badge = document.getElementById('employeesBadge'); if (noShowCount > 0) { badge.textContent = noShowCount; badge.style.display = 'inline-block'; badge.classList.add('warning'); } else { badge.style.display = 'none'; } }
function openNewEmployeeModal() { if (!isOwner) { alert('Only owners can add employees.'); return; } document.getElementById('newEmpFirstName').value = ''; document.getElementById('newEmpLastName').value = ''; document.getElementById('newEmpEmail').value = ''; document.getElementById('newEmpPhone').value = ''; document.getElementById('newEmpDepartment').value = ''; document.getElementById('newEmpRole').value = ''; document.getElementById('newEmpHireDate').value = new Date().toISOString().split('T')[0]; document.getElementById('newEmployeeModal').classList.add('active'); }
function closeNewEmployeeModal() { document.getElementById('newEmployeeModal').classList.remove('active'); }
async function saveNewEmployee() { if (!isOwner) { alert('Only owners can add employees.'); return; } const firstName = document.getElementById('newEmpFirstName').value.trim(); const lastName = document.getElementById('newEmpLastName').value.trim(); const phone = document.getElementById('newEmpPhone').value.trim(); if (!firstName || !lastName || !phone) { alert('First name, last name, and phone are required.'); return; } const newEmp = { tenant_id: currentTenantId, first_name: firstName, last_name: lastName, email: document.getElementById('newEmpEmail').value.trim() || null, phone: phone, department: document.getElementById('newEmpDepartment').value || null, role: document.getElementById('newEmpRole').value || null, hire_date: document.getElementById('newEmpHireDate').value || null, is_active: true }; const { error } = await sb.from('employees').insert(newEmp); if (error) { alert('Error adding employee: ' + error.message); return; } closeNewEmployeeModal(); await loadEmployeesData(); }

// ========== NEW TASK MODAL ==========
async function openNewTaskModal() { try { const { data: employees } = await sb.from('employees').select('employee_id, user_id, first_name, last_name').eq('tenant_id', currentTenantId).eq('is_active', true); allEmployees = employees || []; const select = document.getElementById('taskAssignee'); select.innerHTML = '<option value="">-- Select Employee --</option>' + allEmployees.map(e => `<option value="${e.employee_id}">${e.first_name} ${e.last_name}</option>`).join(''); } catch (e) { console.error('Error loading employees:', e); } const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); document.getElementById('taskDueDate').value = tomorrow.toISOString().split('T')[0]; document.getElementById('newTaskModal').classList.add('active'); }
function closeNewTaskModal() { document.getElementById('newTaskModal').classList.remove('active'); document.getElementById('taskTitle').value = ''; document.getElementById('taskDescription').value = ''; document.getElementById('taskPriority').value = 'normal'; }
async function saveNewTask() { const title = document.getElementById('taskTitle').value.trim(); if (!title) { alert('Please enter a task title'); return; } if (!currentTenantId) { alert('Error: No tenant_id available.'); return; } const selectedEmpId = document.getElementById('taskAssignee').value; let assignedUserId = null; if (selectedEmpId) { const { data: emp } = await sb.from('employees').select('user_id').eq('employee_id', selectedEmpId).single(); assignedUserId = emp?.user_id; } const newTask = { tenant_id: currentTenantId, title, description: document.getElementById('taskDescription').value.trim() || null, priority: document.getElementById('taskPriority').value, status: 'pending', due_at: document.getElementById('taskDueDate').value ? new Date(document.getElementById('taskDueDate').value).toISOString() : null, assigned_to: assignedUserId, created_by: currentUserId }; const { error } = await sb.from('tasks').insert(newTask).select(); if (error) { alert('Error creating task: ' + error.message); return; } closeNewTaskModal(); loadTasksData(); }

// ========== UTILITY ==========
function formatTimeAgo(dateStr) { const diff = new Date() - new Date(dateStr); const mins = Math.floor(diff / 60000), hrs = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000); if (mins < 1) return 'Just now'; if (mins < 60) return `${mins}m ago`; if (hrs < 24) return `${hrs}h ago`; if (days < 7) return `${days}d ago`; return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }

// ========== DATE RANGE FUNCTIONS ==========
function formatDateDisplay(date) { return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
function rangeChanged() { currentRange = document.getElementById('rangeSelect').value; const mobileSelect = document.getElementById('rangeSelectMobile'); if (mobileSelect) mobileSelect.value = currentRange; calculateDateRange(); updateDisplay(); loadDashboardData(); }
function rangeChangedMobile() { currentRange = document.getElementById('rangeSelectMobile').value; document.getElementById('rangeSelect').value = currentRange; calculateDateRange(); updateDisplay(); loadDashboardData(); }
function setDirection(direction) { currentDirection = direction; document.getElementById('pastBtn').classList.remove('active'); document.getElementById('futureBtn').classList.remove('active'); document.getElementById(direction + 'Btn').classList.add('active'); document.getElementById('pastBtnMobile')?.classList.remove('active'); document.getElementById('futureBtnMobile')?.classList.remove('active'); document.getElementById(direction + 'BtnMobile')?.classList.add('active'); calculateDateRange(); updateDisplay(); loadDashboardData(); }
function setDirectionMobile(direction) { currentDirection = direction; document.getElementById('pastBtnMobile').classList.remove('active'); document.getElementById('futureBtnMobile').classList.remove('active'); document.getElementById(direction + 'BtnMobile').classList.add('active'); document.getElementById('pastBtn').classList.remove('active'); document.getElementById('futureBtn').classList.remove('active'); document.getElementById(direction + 'Btn').classList.add('active'); calculateDateRange(); updateDisplay(); loadDashboardData(); }
function calculateDateRange() { const today = new Date(); today.setHours(0, 0, 0, 0); if (currentDirection === 'future') { startDate = new Date(today); endDate = new Date(today); switch(currentRange) { case 'today': endDate.setHours(23, 59, 59, 999); break; case 'week': endDate.setDate(today.getDate() + 6); break; case '30days': endDate.setDate(today.getDate() + 29); break; case '60days': endDate.setDate(today.getDate() + 59); break; case '90days': endDate.setDate(today.getDate() + 89); break; case 'ytd': endDate = new Date(today.getFullYear(), 11, 31); break; } endDate.setHours(23, 59, 59, 999); } else { endDate = new Date(today); endDate.setHours(23, 59, 59, 999); startDate = new Date(today); switch(currentRange) { case 'today': startDate.setHours(0, 0, 0, 0); break; case 'week': startDate.setDate(today.getDate() - 6); break; case '30days': startDate.setDate(today.getDate() - 29); break; case '60days': startDate.setDate(today.getDate() - 59); break; case '90days': startDate.setDate(today.getDate() - 89); break; case 'ytd': startDate = new Date(today.getFullYear(), 0, 1); break; } } }
function updateDisplay() { const rangeText = { 'today': 'Today', 'week': '1 Week', '30days': '30 Days', '60days': '60 Days', '90days': '90 Days', 'ytd': 'Year to Date' }; const displayText = `${rangeText[currentRange]} (${currentDirection === 'future' ? 'Future' : 'Past'})`; document.getElementById('dateRangeDisplay').textContent = displayText; const mobileDisplay = document.getElementById('dateRangeDisplayMobile'); if (mobileDisplay) mobileDisplay.textContent = displayText; }

// ========== DASHBOARD DATA ==========
async function checkAuth() { let { data: { session } } = await sb.auth.getSession(); if (!session) { const token = localStorage.getItem('sb_access_token'), refreshToken = localStorage.getItem('sb_refresh_token'); if (token && refreshToken) { const { data, error } = await sb.auth.setSession({ access_token: token, refresh_token: refreshToken }); if (error || !data.session) { window.location.href = 'login.html'; return null; } session = data.session; } else { window.location.href = 'login.html'; return null; } } currentUserId = session.user.id; return session; }

async function loadBusinessSettings() { const { data } = await sb.from('business_settings').select('*').limit(1).single(); if (data) { const name = data.business_name || data.company_name || ''; document.getElementById('desktopBusinessName').textContent = name; document.getElementById('mobileBusinessName').textContent = name; if (!currentTenantId && data.tenant_id) currentTenantId = data.tenant_id; } }

async function loadDashboardData() { await Promise.all([loadServiceData(), loadPartsData(), loadSalesData(), loadSummaryData()]); }

async function loadServiceData() { try { const { data: allOrders } = await sb.from('work_orders').select('*'); const orders = allOrders || []; const filteredOrders = orders.filter(wo => { if (currentDirection === 'future') { const d = wo.scheduled_start ? new Date(wo.scheduled_start) : null; return d && d >= startDate && d <= endDate; } else { return new Date(wo.created_at) >= startDate && new Date(wo.created_at) <= endDate; } }); const completedOrders = filteredOrders.filter(wo => wo.status === 'completed' || wo.status === 'closed'); const inProgressOrders = filteredOrders.filter(wo => wo.status === 'in_progress'); const scheduledOrders = filteredOrders.filter(wo => wo.status === 'scheduled'); const totalRevenue = completedOrders.reduce((sum, wo) => sum + (parseFloat(wo.total_amount) || 0), 0); const avgTicket = completedOrders.length > 0 ? totalRevenue / completedOrders.length : 0; 
  // Update summary cards
  document.getElementById('serviceRevenueSummary').textContent = '$' + Math.round(totalRevenue).toLocaleString();
  document.getElementById('serviceOrdersSummary').textContent = completedOrders.length;
  document.getElementById('serviceInProgressSummary').textContent = inProgressOrders.length;
  // Update detail rows
  document.getElementById('serviceRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString(); document.getElementById('serviceOrders').textContent = completedOrders.length; document.getElementById('serviceAvgTicket').textContent = '$' + Math.round(avgTicket).toLocaleString(); document.getElementById('serviceInProgress').textContent = inProgressOrders.length; document.getElementById('serviceScheduled').textContent = scheduledOrders.length; createServiceChart(completedOrders.length, inProgressOrders.length, scheduledOrders.length); } catch (error) { console.error('Error loading service data:', error); } }

function createServiceChart(completed, inProgress, scheduled) { if (charts.serviceStatus) charts.serviceStatus.destroy(); const ctx = document.getElementById('serviceStatusChart'); charts.serviceStatus = new Chart(ctx, { type: 'doughnut', data: { labels: ['Completed', 'In Progress', 'Scheduled'], datasets: [{ data: [completed, inProgress, scheduled], backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } } } }); }

async function loadPartsData() { try { const { data: inventory } = await sb.from('parts_inventory').select('*'); const parts = inventory || []; const inventoryValue = parts.reduce((sum, p) => sum + ((parseFloat(p.quantity_on_hand) || 0) * (parseFloat(p.unit_cost) || 0)), 0); const lowStock = parts.filter(p => (p.quantity_on_hand || 0) <= (p.reorder_point || 5)).length; 
  // Update summary cards
  document.getElementById('partsInventorySummary').textContent = '$' + Math.round(inventoryValue).toLocaleString();
  document.getElementById('partsTotalSummary').textContent = parts.length;
  document.getElementById('partsLowStockSummary').textContent = lowStock;
  // Update detail rows
  document.getElementById('partsInventoryValue').textContent = '$' + Math.round(inventoryValue).toLocaleString(); document.getElementById('partsTotalItems').textContent = parts.length; document.getElementById('partsLowStock').textContent = lowStock; } catch (error) { console.error('Error loading parts data:', error); } }

async function loadSalesData() { try { const { data: allDeals } = await sb.from('deals').select('*'); const deals = allDeals || []; const filteredDeals = deals.filter(d => new Date(d.created_at) >= startDate && new Date(d.created_at) <= endDate); const wonDeals = filteredDeals.filter(d => d.status === 'won' || d.status === 'closed_won'); const lostDeals = filteredDeals.filter(d => d.status === 'lost' || d.status === 'closed_lost'); const activeDeals = filteredDeals.filter(d => d.status !== 'won' && d.status !== 'lost' && d.status !== 'closed_won' && d.status !== 'closed_lost'); const totalRevenue = wonDeals.reduce((sum, d) => sum + (parseFloat(d.deal_value) || parseFloat(d.amount) || 0), 0); const pipelineValue = activeDeals.reduce((sum, d) => sum + (parseFloat(d.deal_value) || parseFloat(d.amount) || 0), 0); const totalClosed = wonDeals.length + lostDeals.length; const winRate = totalClosed > 0 ? Math.round((wonDeals.length / totalClosed) * 100) : 0; 
  // Update summary cards
  document.getElementById('salesRevenueSummary').textContent = '$' + Math.round(totalRevenue).toLocaleString();
  document.getElementById('salesDealsSummary').textContent = wonDeals.length;
  document.getElementById('salesWinRateSummary').textContent = winRate + '%';
  // Update detail rows
  document.getElementById('salesRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString(); document.getElementById('salesDeals').textContent = wonDeals.length; document.getElementById('salesWinRate').textContent = winRate + '%'; document.getElementById('salesPipeline').textContent = '$' + Math.round(pipelineValue).toLocaleString(); const stageCounts = {}; activeDeals.forEach(d => { const stage = d.stage || d.status || 'Unknown'; stageCounts[stage] = (stageCounts[stage] || 0) + 1; }); createSalesPipelineChart(stageCounts); } catch (error) { console.error('Error loading sales data:', error); } }

function createSalesPipelineChart(stageCounts) { if (charts.salesPipeline) charts.salesPipeline.destroy(); const labels = Object.keys(stageCounts).length > 0 ? Object.keys(stageCounts) : ['No Active Deals']; const values = Object.keys(stageCounts).length > 0 ? Object.values(stageCounts) : [0]; const ctx = document.getElementById('salesPipelineChart'); charts.salesPipeline = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Deals', data: values, backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }, x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } } } } }); }

async function loadSummaryData() { try { const { data: customers } = await sb.from('customers').select('customer_id'); const { data: vehicles } = await sb.from('vehicles').select('vehicle_id'); document.getElementById('totalCustomers').textContent = (customers || []).length; document.getElementById('totalVehicles').textContent = (vehicles || []).length; setTimeout(() => { const serviceRev = parseFloat(document.getElementById('serviceRevenue').textContent.replace(/[$,]/g, '')) || 0; const salesRev = parseFloat(document.getElementById('salesRevenue').textContent.replace(/[$,]/g, '')) || 0; document.getElementById('totalRevenue').textContent = '$' + Math.round(serviceRev + salesRev).toLocaleString(); createSummaryChart(serviceRev, salesRev); }, 500); } catch (error) { console.error('Error loading summary data:', error); } }

function createSummaryChart(serviceRev, salesRev) { if (charts.summaryRevenue) charts.summaryRevenue.destroy(); const ctx = document.getElementById('summaryRevenueChart'); charts.summaryRevenue = new Chart(ctx, { type: 'doughnut', data: { labels: ['Service', 'Sales'], datasets: [{ data: [serviceRev || 0, salesRev || 0], backgroundColor: ['#3b82f6', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } } } }); }

async function init() { const session = await checkAuth(); if (!session) return; const authEmail = session.user?.email; if (authEmail) { const { data: userByEmail } = await sb.from('users').select('*').eq('email', authEmail).single(); if (userByEmail?.tenant_id) { currentTenantId = userByEmail.tenant_id; currentUserId = userByEmail.user_id; } } if (!currentTenantId) { const { data: userData } = await sb.from('users').select('*').eq('user_id', currentUserId).single(); if (userData?.tenant_id) currentTenantId = userData.tenant_id; } if (!currentTenantId && authEmail) { const { data: empByEmail } = await sb.from('employees').select('tenant_id, user_id, email').eq('email', authEmail).single(); if (empByEmail?.tenant_id) { currentTenantId = empByEmail.tenant_id; if (empByEmail.user_id) currentUserId = empByEmail.user_id; } } if (!currentTenantId) { const { data: bsData } = await sb.from('business_settings').select('tenant_id, business_name').limit(1).single(); if (bsData?.tenant_id) currentTenantId = bsData.tenant_id; } if (!currentTenantId) { console.error('Could not determine tenant_id'); return; } await loadBusinessSettings(); calculateDateRange(); updateDisplay(); await Promise.all([loadDashboardData(), loadInboxData(), loadTasksData(), loadEmployeesData()]); }

init();
</script>
</body>
</html>
