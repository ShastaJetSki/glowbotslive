<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Customer Lookup</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<meta name="supabase-anon-key"
content="REPLACE_WITH_YOUR_ANON_KEY"/>

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
.appName{position:fixed;top:10px;right:24px;font-size:12px;color:#9fb0c3}
h1{margin:0;font-size:40px}
.sub-nav{display:flex;gap:16px;margin:8px 0 20px;padding-bottom:10px;border-bottom:1px solid #1f2937}
.sub-nav a{font-size:14px;color:#9ca3af;text-decoration:none}
.sub-nav a.active{color:#38bdf8;font-weight:500}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{background:#0f1621;border:1px solid #223044;border-radius:14px;padding:14px 16px;cursor:pointer}
input{width:100%;padding:10px;border-radius:10px;border:1px solid #223044;background:#0f1621;color:#fff}
.stat{min-width:220px}
.label{font-size:12px;color:#9fb0c3}
.value{font-size:22px;font-weight:700}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);align-items:center;justify-content:center}
.modal.active{display:flex}
.modalBox{background:#0f1621;border-radius:14px;border:1px solid #223044;padding:20px;max-width:600px;width:100%}
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<h1>Customer Lookup</h1>

<div class="sub-nav">
  <a href="dashboard-business.html">Dashboard</a>
  <a class="active">Customers</a>
  <a href="dashboard-vehicle-search.html">Vehicles</a>
</div>

<input id="search" placeholder="Search name, phone, email"/>

<div class="row" id="stats"></div>
<div class="row" id="results"></div>

<div class="modal" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modalBox" id="modalBox"></div>
</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API=`https://${PROJECT_REF}.supabase.co/rest/v1`;
const ANON=document.querySelector('meta[name="supabase-anon-key"]').content;

const token=localStorage.getItem("sb_access_token");
if(!token) location.replace("login.html");

const headers={
  apikey:ANON,
  Authorization:`Bearer ${token}`,
  "Content-Type":"application/json"
};

let customers=[],vehicles=[],workOrders=[];
let activeFilter=null;

async function fetchTable(t){
  const r=await fetch(`${API}/${t}?select=*`,{headers});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function renderStats(){
  document.getElementById("stats").innerHTML=`
    <div class="card stat" onclick="setFilter(null)">
      <div class="label">Total Customers</div>
      <div class="value">${customers.length}</div>
    </div>
    <div class="card stat" onclick="setFilter('vehicles')">
      <div class="label">Customers w/ Vehicles</div>
      <div class="value">${new Set(vehicles.map(v=>v.customer_id)).size}</div>
    </div>
    <div class="card stat" onclick="setFilter('work')">
      <div class="label">Customers w/ Work Orders</div>
      <div class="value">${new Set(workOrders.map(w=>w.customer_id)).size}</div>
    </div>
  `;
}

function setFilter(f){activeFilter=f;renderResults()}

function renderResults(){
  const q=document.getElementById("search").value.toLowerCase();
  let list=customers.filter(c=>{
    if(activeFilter==="vehicles" && !vehicles.some(v=>v.customer_id===c.customer_id)) return false;
    if(activeFilter==="work" && !workOrders.some(w=>w.customer_id===c.customer_id)) return false;
    return `${c.first_name} ${c.last_name} ${c.phone} ${c.email}`.toLowerCase().includes(q);
  });

  document.getElementById("results").innerHTML=list.map(c=>`
    <div class="card" onclick="openCustomer('${c.customer_id}')">
      <strong>${c.first_name} ${c.last_name}</strong><br/>
      ${c.phone||""}<br/>
      ${c.email||""}
    </div>
  `).join("");
}

function openCustomer(id){
  const c=customers.find(x=>x.customer_id===id);
  const v=vehicles.filter(v=>v.customer_id===id);
  const w=workOrders.filter(w=>w.customer_id===id);

  document.getElementById("modalBox").innerHTML=`
    <h3>${c.first_name} ${c.last_name}</h3>
    <p>${c.phone||""}<br/>${c.email||""}</p>
    <h4>Vehicles</h4>
    ${v.map(v=>`${v.year||""} ${v.make||""} ${v.model||""} (${v.license_plate||""})`).join("<br/>")||"None"}
    <h4>Work Orders</h4>
    ${w.map(w=>w.summary).join("<br/>")||"None"}
    <br/><br/>
    <button onclick="closeModal()">Close</button>
  `;
  document.getElementById("modal").classList.add("active");
}
function closeModal(){document.getElementById("modal").classList.remove("active")}

document.getElementById("search").oninput=renderResults;

(async()=>{
  customers=await fetchTable("customers");
  vehicles=await fetchTable("vehicles");
  workOrders=await fetchTable("work_orders");
  renderStats();
  renderResults();
})();
</script>
</body>
</html>
