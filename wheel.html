<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gone ‚Äì Family Wheel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --primary: #0ea5e9;
    --primary-hover: #0284c7;
    --accent: #2dd4bf;
    --accent-hover: #14b8a6;
    --bg: #0a0a0a;
    --card-bg: #111111;
    --border: #1a1a1a;
    --text: #ffffff;
    --text-muted: #888888;
    --size: 480px;
    --glow-primary: rgba(14, 165, 233, 0.4);
    --glow-accent: rgba(45, 212, 191, 0.4);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    min-height: 100vh;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  /* Header */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    padding: 12px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(10, 10, 10, 0.95);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(10px);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
  }

  .logo-box {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 22px;
    color: #fff;
    font-family: Georgia, serif;
    font-style: italic;
    box-shadow: 0 4px 15px var(--glow-primary);
  }

  .logo-text {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    letter-spacing: -1px;
  }

  .back-link {
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    border-radius: 8px;
    border: 1px solid #333;
    background: transparent;
    color: #888;
    text-decoration: none;
    transition: all 0.2s;
  }

  .back-link:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  /* Main Layout */
  .main {
    padding-top: 80px;
    min-height: 100vh;
  }

  .content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  .page-title {
    text-align: center;
    margin-bottom: 24px;
  }

  .page-title h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-title p {
    color: var(--text-muted);
    font-size: 14px;
    margin-top: 8px;
  }

  /* Grid Layout */
  .wheel-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
  }

  /* Card */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .card-body {
    padding: 20px;
  }

  /* Wheel Stage */
  .wheel-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px;
    background: radial-gradient(ellipse at 50% 30%, rgba(14, 165, 233, 0.08) 0%, transparent 60%);
  }

  .wheel-shell {
    width: var(--size);
    height: var(--size);
    position: relative;
    display: grid;
    place-items: center;
    user-select: none;
    touch-action: none;
    cursor: grab;
  }

  .wheel-shell:active {
    cursor: grabbing;
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: 50%;
    filter: drop-shadow(0 0 40px var(--glow-primary));
  }

  /* Futuristic Pointer */
  .pointer {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    pointer-events: none;
  }

  .pointer-shape {
    width: 0;
    height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-bottom: 42px solid var(--primary);
    filter: drop-shadow(0 0 12px var(--glow-primary));
  }

  .pointer-glow {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
    50% { opacity: 0.6; transform: translateX(-50%) scale(1.3); }
  }

  /* Center Selected Avatar */
  .center-avatar {
    position: absolute;
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(45, 212, 191, 0.2));
    border: 2px solid rgba(14, 165, 233, 0.3);
    box-shadow: 
      0 0 60px rgba(14, 165, 233, 0.3),
      inset 0 0 30px rgba(0, 0, 0, 0.5);
    display: grid;
    place-items: center;
    z-index: 20;
    pointer-events: auto;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
  }

  .center-avatar:hover {
    transform: scale(1.05);
    border-color: var(--accent);
    box-shadow: 
      0 0 80px rgba(45, 212, 191, 0.5),
      inset 0 0 30px rgba(0, 0, 0, 0.5);
  }

  .center-avatar:active {
    transform: scale(0.98);
  }

  .center-avatar img {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    object-position: 50% 30%;
    border: 2px solid rgba(45, 212, 191, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    background: rgba(0, 0, 0, 0.3);
  }

  .center-avatar img.hidden {
    display: none;
  }

  .center-initials {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  }

  .center-initials.visible {
    display: flex;
  }

  .center-avatar .label {
    position: absolute;
    bottom: -24px;
    padding: 8px 18px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.5px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    white-space: nowrap;
    box-shadow: 0 4px 20px var(--glow-primary);
  }

  .center-avatar .tap-hint {
    position: absolute;
    top: -20px;
    font-size: 10px;
    font-weight: 600;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.8;
    animation: tap-pulse 2s ease-in-out infinite;
  }

  @keyframes tap-pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  /* Wheel Controls */
  .wheel-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 30px;
    flex-wrap: wrap;
  }

  .ctrl-btn {
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ctrl-btn:hover {
    border-color: var(--primary);
    background: rgba(14, 165, 233, 0.1);
    box-shadow: 0 0 20px var(--glow-primary);
  }

  .ctrl-btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border: none;
  }

  .ctrl-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px var(--glow-primary);
  }

  .wheel-hint {
    margin-top: 20px;
    text-align: center;
    color: var(--text-muted);
    font-size: 12px;
    line-height: 1.5;
  }

  /* Side Panel */
  .side-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Family Strips */
  .family-strips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    max-height: 280px;
    overflow-y: auto;
  }

  .family-strip {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 25px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.2);
    transition: all 0.2s;
    cursor: pointer;
  }

  .family-strip:hover {
    background: rgba(14, 165, 233, 0.15);
    border-color: var(--primary);
    transform: translateY(-2px);
  }

  .family-strip.selected {
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(45, 212, 191, 0.25));
    border-color: var(--accent);
    box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
  }

  .strip-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border);
  }

  .family-strip.selected .strip-avatar {
    border-color: var(--accent);
  }

  .strip-name {
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
  }

  .strip-remove {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 68, 68, 0.2);
    color: #ff4444;
    font-size: 12px;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: -4px;
  }

  .family-strip:hover .strip-remove {
    opacity: 1;
  }

  .strip-remove:hover {
    background: rgba(255, 68, 68, 0.4);
    transform: scale(1.1);
  }

  /* Add Member Form */
  .add-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .form-input {
    width: 100%;
    padding: 12px 14px;
    font-size: 13px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    transition: all 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--glow-primary);
  }

  .form-input::placeholder {
    color: #555;
  }

  .file-upload {
    position: relative;
    padding: 20px;
    border: 2px dashed var(--border);
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload:hover {
    border-color: var(--primary);
    background: rgba(14, 165, 233, 0.05);
  }

  .file-upload input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .file-upload-text {
    color: var(--text-muted);
    font-size: 13px;
  }

  .file-upload-text span {
    color: var(--primary);
    font-weight: 600;
  }

  .add-btn {
    padding: 14px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px var(--glow-primary);
  }

  .add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Mobile Bottom Bar */
  .mobile-controls {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 16px;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
    background: rgba(10, 10, 10, 0.95);
    border-top: 1px solid var(--border);
    backdrop-filter: blur(10px);
    z-index: 100;
    gap: 10px;
    justify-content: center;
  }

  .mobile-controls .ctrl-btn {
    flex: 1;
    max-width: 100px;
    padding: 14px 12px;
    font-size: 12px;
  }

  .mobile-controls .ctrl-btn.primary {
    max-width: 120px;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .wheel-grid {
      grid-template-columns: 1fr;
    }
    :root {
      --size: min(420px, 85vw);
    }
    .center-avatar {
      width: 150px;
      height: 150px;
    }
    .center-avatar img {
      width: 120px;
      height: 120px;
    }
    .center-initials {
      width: 120px;
      height: 120px;
      font-size: 40px;
    }
    
    /* Hide on mobile */
    .page-title {
      display: none;
    }
    .wheel-controls {
      display: none;
    }
    .wheel-hint {
      display: none;
    }
    
    /* Show mobile bottom bar */
    .mobile-controls {
      display: flex;
    }
    
    /* Add padding to main content for bottom bar */
    .main {
      padding-bottom: 80px;
    }
  }

  /* Message Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: none;
    place-items: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal-overlay.active {
    display: grid;
  }

  .modal {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 100px rgba(14, 165, 233, 0.15);
  }

  .modal-header {
    padding: 24px 24px 16px;
    text-align: center;
    border-bottom: 1px solid var(--border);
  }

  .modal-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--accent);
    box-shadow: 0 8px 32px rgba(45, 212, 191, 0.3);
    margin-bottom: 12px;
  }

  .modal-name {
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
  }

  .modal-relation {
    font-size: 14px;
    color: var(--text-muted);
  }

  .modal-body {
    padding: 24px;
  }

  .modal-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
  }

  .modal-tab {
    flex: 1;
    padding: 12px 16px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .modal-tab:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  .modal-tab.active {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-color: transparent;
    color: #fff;
  }

  .modal-panel {
    display: none;
  }

  .modal-panel.active {
    display: block;
  }

  .modal-textarea {
    width: 100%;
    min-height: 150px;
    padding: 16px;
    font-size: 14px;
    line-height: 1.6;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    resize: vertical;
    font-family: inherit;
    transition: all 0.2s;
  }

  .modal-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
  }

  .modal-textarea::placeholder {
    color: #555;
  }

  .modal-input-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }

  .modal-input {
    width: 100%;
    padding: 12px 14px;
    font-size: 13px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    transition: all 0.2s;
  }

  .modal-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
  }

  .modal-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .modal-btn {
    flex: 1;
    padding: 14px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .modal-btn.secondary {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-muted);
    border: 1px solid var(--border);
  }

  .modal-btn.secondary:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
  }

  .modal-btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
  }

  .modal-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
  }

  .modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-muted);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    background: rgba(255, 68, 68, 0.2);
    color: #ff4444;
  }

  .record-btn {
    width: 100%;
    padding: 20px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 12px;
    border: 2px dashed var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .record-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(45, 212, 191, 0.1);
  }

  .record-btn.recording {
    border-color: #ff4444;
    color: #ff4444;
    background: rgba(255, 68, 68, 0.1);
    animation: recording-pulse 1.5s ease-in-out infinite;
  }

  @keyframes recording-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .record-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: currentColor;
  }
</style>
</head>

<body>

<!-- Header -->
<header class="header">
  <a href="gone-dashboard.html" class="logo">
    <div class="logo-box">G</div>
    <span class="logo-text">Gone</span>
  </a>
  <a href="gone-recipients.html" class="back-link">‚Üê Back to Recipients</a>
</header>

<!-- Main -->
<div class="main">
  <div class="content">
    <div class="page-title">
      <h1>When I am Gone...</h1>
    </div>

    <div class="wheel-grid">
      <!-- Wheel Card -->
      <div class="card">
        <div class="wheel-stage">
          <div class="wheel-shell" id="shell">
            <div class="pointer">
              <div class="pointer-shape"></div>
              <div class="pointer-glow"></div>
            </div>
            <canvas id="wheelCanvas"></canvas>
            <div class="center-avatar" id="centerAvatar" onclick="openMessageModal()">
              <div class="tap-hint">Tap to Select</div>
              <img id="centerImg" alt="Selected family member" />
              <div class="center-initials" id="centerInitials"></div>
              <div class="label" id="centerLabel">‚Äî</div>
            </div>
          </div>

          <div class="wheel-controls">
            <button class="ctrl-btn" id="backBtn" title="Spin backward (‚Üê)">‚Üê Back</button>
            <button class="ctrl-btn primary" id="spinBtn" title="Random spin">üé≤ Spin!</button>
            <button class="ctrl-btn" id="fwdBtn" title="Spin forward (‚Üí)">Forward ‚Üí</button>
            <button class="ctrl-btn" id="stopBtn" title="Stop quickly">‚èπ Stop</button>
          </div>

          <div class="wheel-hint">
            <span id="wheelHint">Click the center photo to send a message or record a memory</span>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="side-panel">
        <!-- Add Member -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Add to Wheel</div>
          </div>
          <div class="card-body">
            <div class="add-form">
              <div class="form-row">
                <input type="text" class="form-input" id="memberName" placeholder="Name" />
                <input type="text" class="form-input" id="memberRelation" placeholder="Relationship" />
              </div>
              <div class="file-upload" id="photoUpload">
                <input type="file" accept="image/*" id="photoInput" />
                <div class="file-upload-text">
                  <span>Click to upload</span> or drag photo
                </div>
              </div>
              <div id="photoPreview" style="display: none; text-align: center;">
                <img id="previewImg" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent);" />
              </div>
              <button class="add-btn" id="addMemberBtn">+ Add Family Member</button>
            </div>
          </div>
        </div>

        <!-- Family Members -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Family</div>
            <span style="color: var(--text-muted); font-size: 12px;" id="memberCount">0 members</span>
          </div>
          <div class="card-body" style="padding: 12px;">
            <div class="family-strips" id="familyList">
              <div class="empty-state">
                <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                <p>Add family members to spin the wheel</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Bottom Controls -->
<div class="mobile-controls">
  <button class="ctrl-btn" id="mobileBackBtn" title="Spin backward">‚Üê Back</button>
  <button class="ctrl-btn primary" id="mobileSpinBtn" title="Random spin">üé≤ Spin!</button>
  <button class="ctrl-btn" id="mobileFwdBtn" title="Spin forward">Forward ‚Üí</button>
</div>

<!-- Script -->

<script>
(() => {
  // ============================================================
  // CONFIGURATION
  // ============================================================
  const SUPABASE_URL = 'YOUR_SUPABASE_URL';
  const SUPABASE_KEY = 'YOUR_SUPABASE_KEY';
  const DEMO_MODE = true;

  const DEMO_MEMBERS = [
    { id: 1, name: "Sarah", relationship: "Daughter", photo_url: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop&crop=face" },
    { id: 2, name: "Michael", relationship: "Son", photo_url: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop&crop=face" },
    { id: 3, name: "Emma", relationship: "Wife", photo_url: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=200&h=200&fit=crop&crop=face" },
    { id: 4, name: "David", relationship: "Father", photo_url: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=200&h=200&fit=crop&crop=face" },
    { id: 5, name: "Linda", relationship: "Mother", photo_url: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=200&h=200&fit=crop&crop=face" },
    { id: 6, name: "James", relationship: "Brother", photo_url: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200&h=200&fit=crop&crop=face" },
    { id: 7, name: "Sophie", relationship: "Sister", photo_url: "https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=200&h=200&fit=crop&crop=face" },
    { id: 8, name: "Robert", relationship: "Uncle", photo_url: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=200&h=200&fit=crop&crop=face" },
    { id: 9, name: "Maria", relationship: "Aunt", photo_url: "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=200&h=200&fit=crop&crop=face" },
    { id: 10, name: "Thomas", relationship: "Grandfather", photo_url: "https://images.unsplash.com/photo-1552058544-f2b08422138a?w=200&h=200&fit=crop&crop=face" },
    { id: 11, name: "Eleanor", relationship: "Grandmother", photo_url: "https://images.unsplash.com/photo-1566616213894-2d4e1baee5d8?w=200&h=200&fit=crop&crop=face" },
    { id: 12, name: "Kevin", relationship: "Cousin", photo_url: "https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=200&h=200&fit=crop&crop=face" },
    { id: 13, name: "Jessica", relationship: "Cousin", photo_url: "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=200&h=200&fit=crop&crop=face" },
    { id: 14, name: "William", relationship: "Nephew", photo_url: "https://images.unsplash.com/photo-1539571696357-5a69c17a67c6?w=200&h=200&fit=crop&crop=face" },
    { id: 15, name: "Olivia", relationship: "Niece", photo_url: "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=200&h=200&fit=crop&crop=face" },
  ];

  // ---- DOM Elements
  const canvas = document.getElementById("wheelCanvas");
  const shell = document.getElementById("shell");
  const centerImg = document.getElementById("centerImg");
  const centerInitials = document.getElementById("centerInitials");
  const centerLabel = document.getElementById("centerLabel");
  const backBtn = document.getElementById("backBtn");
  const fwdBtn = document.getElementById("fwdBtn");
  const spinBtn = document.getElementById("spinBtn");
  const stopBtn = document.getElementById("stopBtn");
  const familyList = document.getElementById("familyList");
  const memberCount = document.getElementById("memberCount");
  const memberName = document.getElementById("memberName");
  const memberRelation = document.getElementById("memberRelation");
  const photoInput = document.getElementById("photoInput");
  const photoPreview = document.getElementById("photoPreview");
  const previewImg = document.getElementById("previewImg");
  const addMemberBtn = document.getElementById("addMemberBtn");

  // ---- Constants
  const TAU = Math.PI * 2;
  const ctx = canvas.getContext("2d");

  const sliceColors = [
    "#0ea5e9", "#2dd4bf", "#8b5cf6", "#f59e0b", "#ec4899",
    "#06b6d4", "#10b981", "#6366f1", "#f97316", "#d946ef"
  ];

  // Physics
  const friction = 0.988;
  const maxVel = 0.45;
  const detentStrength = 0.018;
  const detentDamping = 0.12;
  const clickLoss = 0.88;

  // ---- State
  let angle = 0;
  let vel = 0;
  let dragging = false;
  let lastAngle = 0;
  let lastTime = 0;
  let lastPointerIdx = -1;
  let MEMBERS = [];
  let N = 0;  // Total family members
  let audioCtx = null;
  let pendingPhotoData = null;

  // === MAGIC WHEEL CONFIG ===
  const VISIBLE_SLOTS = 6;  // Always appears to have 6 slices
  const slice = TAU / VISIBLE_SLOTS;  // Each slice is 60 degrees
  
  // Track which member is in each visual slot
  let slotMembers = [0, 1, 2, 3, 4, 5];  // Member indices for slots 0-5
  let nextMemberIdx = 0;  // Next member to load when slot goes under cover
  let prevSlotAngles = [];  // Track previous angles to detect crossing

  // ---- Audio click
  function tickSound(intensity = 1) {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(600 + 400 * intensity, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.08 * intensity, t + 0.006);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.05);
      o.connect(g).connect(audioCtx.destination);
      o.start(t);
      o.stop(t + 0.06);
    } catch (e) {}
  }

  // ---- Canvas setup
  function resize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const r = shell.getBoundingClientRect();
    canvas.width = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  // Normalize angle to 0..TAU
  function normAngle(a) {
    a = a % TAU;
    return a < 0 ? a + TAU : a;
  }

  // Get which visual SLOT is under the pointer (0-5)
  function pointerSlot() {
    const a = normAngle(-angle);
    return Math.floor((a + slice / 2) / slice) % VISIBLE_SLOTS;
  }

  // Get the actual MEMBER index under the pointer
  function pointerMemberIndex() {
    if (N === 0) return -1;
    const slot = pointerSlot();
    return slotMembers[slot] % N;
  }

  // Target angle to center current slot under pointer
  function nearestDetent() {
    const slot = pointerSlot();
    return -slot * slice;
  }

  // Angle difference handling wrap-around
  function angleDiff(a, b) {
    let d = (a - b) % TAU;
    if (d > Math.PI) d -= TAU;
    if (d < -Math.PI) d += TAU;
    return d;
  }

  // Initialize slot assignments
  function initSlots() {
    slotMembers = [];
    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      slotMembers[i] = i % Math.max(1, N);
    }
    nextMemberIdx = VISIBLE_SLOTS % Math.max(1, N);
    prevSlotAngles = [];
    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      prevSlotAngles[i] = getSlotAngle(i);
    }
  }

  // Get the current angle of a slot's center (relative to top = -PI/2)
  function getSlotAngle(slotIdx) {
    const slotCenter = -Math.PI / 2 + angle + slotIdx * slice;
    return normAngle(slotCenter);
  }

  // Check if angle is in the hidden zone (matches the cover: bottom half from ~3 o'clock to ~9 o'clock)
  function isInHiddenZone(ang) {
    const a = normAngle(ang);
    // Cover is from 0.12*PI to 0.88*PI (bottom half of wheel)
    return a > Math.PI * 0.12 && a < Math.PI * 0.88;
  }

  // Update magic slots - repopulate when crossing into OR out of hidden zone (either direction)
  function updateMagicSlots() {
    if (N <= VISIBLE_SLOTS) return;  // No magic needed if 6 or fewer members

    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      const currentAng = getSlotAngle(i);
      const prevAng = prevSlotAngles[i];
      
      const wasHidden = isInHiddenZone(prevAng);
      const isHidden = isInHiddenZone(currentAng);
      
      // Repopulate when slot ENTERS the hidden zone (from either direction)
      if (!wasHidden && isHidden) {
        slotMembers[i] = nextMemberIdx;
        nextMemberIdx = (nextMemberIdx + 1) % N;
      }
      
      prevSlotAngles[i] = currentAng;
    }
  }

  // ---- Draw wedge image (head toward rim, chest toward center, 60% opacity)
  function drawWedgeImage(img, cx, cy, innerR, outerR, startAngle, endAngle) {
    ctx.save();
    ctx.translate(cx, cy);

    // Clip to wedge
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, outerR, startAngle, endAngle);
    ctx.closePath();
    ctx.clip();

    // Rotate canvas so wedge center points up
    const midAngle = (startAngle + endAngle) / 2;
    ctx.rotate(midAngle + Math.PI / 2);

    // Image placement: head at top (toward rim), chest at bottom (toward center)
    const span = outerR - innerR;
    const imgH = span * 0.95;
    const imgW = imgH * 0.8;
    
    // Position: center in slice, pushed toward outer edge
    const dist = innerR + span * 0.55;
    const x = -imgW / 2;
    const y = -dist - imgH * 0.45;

    // Scale to cover
    const scaleX = imgW / img.naturalWidth;
    const scaleY = imgH / img.naturalHeight;
    const sc = Math.max(scaleX, scaleY) * 1.2;
    const dw = img.naturalWidth * sc;
    const dh = img.naturalHeight * sc;
    const dx = x + (imgW - dw) / 2;
    const dy = y + (imgH - dh) / 2;

    // 60% opacity
    ctx.globalAlpha = 0.6;
    ctx.drawImage(img, dx, dy, dw, dh);

    ctx.restore();
  }

  // ---- Draw wheel
  function drawWheel() {
    const w = shell.clientWidth;
    const h = shell.clientHeight;
    const cx = w / 2, cy = h / 2;
    const outerR = Math.min(w, h) / 2 - 8;
    const innerR = outerR * 0.35;
    const rimR = outerR - 4;

    ctx.clearRect(0, 0, w, h);

    if (N === 0) {
      // Empty state
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.arc(0, 0, outerR, 0, TAU);
      ctx.fillStyle = "rgba(14, 165, 233, 0.1)";
      ctx.fill();
      ctx.strokeStyle = "rgba(14, 165, 233, 0.3)";
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,0.5)";
      ctx.font = "16px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Add family members", 0, -10);
      ctx.fillText("to spin the wheel", 0, 15);
      ctx.restore();
      drawCover(cx, cy, outerR, innerR);
      return;
    }

    // Outer glow
    ctx.save();
    ctx.translate(cx, cy);
    const glow = ctx.createRadialGradient(0, 0, outerR * 0.8, 0, 0, outerR + 25);
    glow.addColorStop(0, "transparent");
    glow.addColorStop(1, "rgba(14, 165, 233, 0.12)");
    ctx.beginPath();
    ctx.arc(0, 0, outerR + 25, 0, TAU);
    ctx.fillStyle = glow;
    ctx.fill();
    ctx.restore();

    // Draw all 6 visible slots
    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      // Slot i center position
      const slotCenter = -Math.PI / 2 + angle + i * slice;
      const start = slotCenter - slice / 2;
      const end = slotCenter + slice / 2;

      // Get the member assigned to this slot
      const memberIdx = slotMembers[i] % N;
      const member = MEMBERS[memberIdx];

      // Background color
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, rimR, start, end);
      ctx.closePath();
      ctx.fillStyle = sliceColors[memberIdx % sliceColors.length];
      ctx.globalAlpha = 0.75;
      ctx.fill();
      ctx.restore();

      // Photo (60% opacity)
      if (member && member.img) {
        drawWedgeImage(member.img, cx, cy, innerR, rimR, start, end);
      }

      // Separator line
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(Math.cos(start) * rimR, Math.sin(start) * rimR);
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }

    // Inner ring
    ctx.save();
    ctx.translate(cx, cy);
    ctx.beginPath();
    ctx.arc(0, 0, innerR + 6, 0, TAU);
    ctx.strokeStyle = "rgba(45, 212, 191, 0.5)";
    ctx.lineWidth = 3;
    ctx.stroke();
    ctx.restore();

    // Outer rim
    ctx.save();
    ctx.translate(cx, cy);
    ctx.beginPath();
    ctx.arc(0, 0, outerR, 0, TAU);
    ctx.strokeStyle = "rgba(14, 165, 233, 0.5)";
    ctx.lineWidth = 6;
    ctx.stroke();
    ctx.restore();

    // Draw the magic cover over bottom half
    drawCover(cx, cy, outerR, innerR);
  }

  // Draw the futuristic cover over bottom half (3 o'clock to 9 o'clock)
  function drawCover(cx, cy, outerR, innerR) {
    ctx.save();
    ctx.translate(cx, cy);

    // Cover arc from 3 o'clock (0) to 9 o'clock (PI), going through bottom (PI/2)
    const coverStart = Math.PI * 0.12;  // Just past 3 o'clock
    const coverEnd = Math.PI * 0.88;    // Just before 9 o'clock
    
    // SOLID OPAQUE COVER - completely hides the wheel underneath
    // Layer 1: Base solid black
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, outerR + 20, coverStart, coverEnd);
    ctx.closePath();
    ctx.fillStyle = "#0a0a0a";  // Solid black, matches background
    ctx.fill();

    // Layer 2: Slightly lighter panel on top
    ctx.beginPath();
    ctx.moveTo(Math.cos(coverStart) * (innerR - 8), Math.sin(coverStart) * (innerR - 8));
    ctx.arc(0, 0, innerR - 8, coverStart, coverEnd);
    ctx.arc(0, 0, outerR + 15, coverEnd, coverStart, true);
    ctx.closePath();
    ctx.fillStyle = "#0d0d10";  // Solid dark panel
    ctx.fill();

    // Layer 3: Inner darker section
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, innerR - 8, coverStart, coverEnd);
    ctx.closePath();
    ctx.fillStyle = "#080808";  // Solid very dark
    ctx.fill();

    // Futuristic edge glow on outer rim
    ctx.beginPath();
    ctx.arc(0, 0, outerR + 12, coverStart, coverEnd);
    ctx.strokeStyle = "#0ea5e9";
    ctx.lineWidth = 2;
    ctx.shadowColor = "#0ea5e9";
    ctx.shadowBlur = 15;
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Inner edge glow
    ctx.beginPath();
    ctx.arc(0, 0, innerR - 5, coverStart, coverEnd);
    ctx.strokeStyle = "#2dd4bf";
    ctx.lineWidth = 2;
    ctx.shadowColor = "#2dd4bf";
    ctx.shadowBlur = 10;
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Side lines of cover
    ctx.strokeStyle = "#0ea5e9";
    ctx.lineWidth = 2;
    ctx.shadowColor = "#0ea5e9";
    ctx.shadowBlur = 8;
    
    ctx.beginPath();
    ctx.moveTo(Math.cos(coverStart) * (innerR - 8), Math.sin(coverStart) * (innerR - 8));
    ctx.lineTo(Math.cos(coverStart) * (outerR + 15), Math.sin(coverStart) * (outerR + 15));
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(Math.cos(coverEnd) * (innerR - 8), Math.sin(coverEnd) * (innerR - 8));
    ctx.lineTo(Math.cos(coverEnd) * (outerR + 15), Math.sin(coverEnd) * (outerR + 15));
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Decorative circuit-like lines on cover
    for (let i = 0; i < 4; i++) {
      const r = innerR + (outerR - innerR) * (0.2 + i * 0.22);
      ctx.beginPath();
      ctx.arc(0, 0, r, coverStart + 0.15, coverEnd - 0.15);
      ctx.strokeStyle = `rgba(14, 165, 233, ${0.25 - i * 0.05})`;
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // Horizontal accent lines
    const midR = (innerR + outerR) / 2;
    ctx.strokeStyle = "rgba(45, 212, 191, 0.2)";
    ctx.lineWidth = 1;
    for (let a = coverStart + 0.3; a < coverEnd - 0.3; a += 0.25) {
      ctx.beginPath();
      ctx.moveTo(Math.cos(a) * (midR - 20), Math.sin(a) * (midR - 20));
      ctx.lineTo(Math.cos(a) * (midR + 20), Math.sin(a) * (midR + 20));
      ctx.stroke();
    }

    // Center text/indicator
    ctx.fillStyle = "#2dd4bf";
    ctx.font = "bold 10px system-ui";
    ctx.textAlign = "center";
    ctx.shadowColor = "#2dd4bf";
    ctx.shadowBlur = 8;
    ctx.fillText("‚óÜ ‚óÜ ‚óÜ", 0, outerR * 0.55);
    ctx.fillStyle = "rgba(255,255,255,0.4)";
    ctx.shadowBlur = 0;
    ctx.font = "9px system-ui";
    ctx.fillText("LOADING", 0, outerR * 0.70);

    ctx.restore();
  }

  // ---- Update center display
  function updateCenter(idx) {
    if (idx < 0 || idx >= MEMBERS.length) return;
    const m = MEMBERS[idx];
    const photoUrl = m.photo_url || m.src;
    const initials = m.name.charAt(0).toUpperCase();

    centerLabel.textContent = m.name;
    centerInitials.textContent = initials;

    if (photoUrl) {
      centerImg.onload = () => {
        centerImg.classList.remove('hidden');
        centerInitials.classList.remove('visible');
      };
      centerImg.onerror = () => {
        centerImg.classList.add('hidden');
        centerInitials.classList.add('visible');
      };
      centerImg.src = photoUrl;
    } else {
      centerImg.classList.add('hidden');
      centerInitials.classList.add('visible');
    }
  }

  function render() {
    drawWheel();
  }

  // ---- Physics
  function applyPhysics() {
    if (dragging || N === 0) return;

    vel *= friction;

    // Spring to nearest detent
    const target = nearestDetent();
    const err = angleDiff(target, angle);
    const slowFactor = Math.max(0, 1 - Math.abs(vel) / 0.15);
    vel += err * detentStrength * (0.4 + 0.6 * slowFactor);
    vel -= vel * detentDamping * slowFactor;

    vel = Math.max(-maxVel, Math.min(maxVel, vel));
    angle += vel;

    // Update magic slots (repopulate when crossing into hidden zone)
    updateMagicSlots();

    // Check for slot change under pointer and update center
    checkSelectionChange();
    
    // Apply click loss when slot changes
    const slot = pointerSlot();
    if (slot !== lastPointerIdx) {
      vel *= clickLoss;
    }
  }

  // ---- Pointer/Touch handling
  function getAngle(clientX, clientY) {
    const r = shell.getBoundingClientRect();
    const cx = r.left + r.width / 2;
    const cy = r.top + r.height / 2;
    return Math.atan2(clientY - cy, clientX - cx);
  }

  function onPointerDown(e) {
    // Don't start drag if clicking on center avatar
    if (e.target.closest('.center-avatar')) {
      return; // Let the click pass through to the center avatar
    }
    
    e.preventDefault();
    dragging = true;
    vel = 0;
    lastAngle = getAngle(e.clientX, e.clientY);
    lastTime = performance.now();
    shell.setPointerCapture(e.pointerId);
  }

  function onPointerMove(e) {
    if (!dragging) return;
    e.preventDefault();
    
    const now = performance.now();
    const newAngle = getAngle(e.clientX, e.clientY);
    let delta = newAngle - lastAngle;
    
    // Handle wrap-around
    if (delta > Math.PI) delta -= TAU;
    if (delta < -Math.PI) delta += TAU;
    
    angle += delta;
    
    // Update magic slots during drag too!
    updateMagicSlots();
    
    // Check if selection changed - update center immediately
    checkSelectionChange();
    
    // Calculate velocity for momentum
    const dt = now - lastTime;
    if (dt > 0) {
      vel = delta / (dt / 16.67) * 0.8; // Scale to ~60fps
    }
    
    lastAngle = newAngle;
    lastTime = now;
    render();
  }

  // Check if the slot under pointer changed and update center
  function checkSelectionChange() {
    const slot = pointerSlot();
    const memberIdx = pointerMemberIndex();
    
    if (slot !== lastPointerIdx && memberIdx >= 0) {
      lastPointerIdx = slot;
      updateCenter(memberIdx);
      tickSound(Math.min(1, 0.4 + Math.abs(vel) * 1.5));
      
      // Highlight in strips list
      document.querySelectorAll('.family-strip').forEach((el, i) => {
        el.classList.toggle('selected', i === memberIdx);
      });
    }
  }

  function onPointerUp(e) {
    if (!dragging) return;
    dragging = false;
    shell.releasePointerCapture(e.pointerId);
    
    // Clamp velocity
    vel = Math.max(-maxVel, Math.min(maxVel, vel));
  }

  // Attach pointer events
  shell.addEventListener("pointerdown", onPointerDown);
  shell.addEventListener("pointermove", onPointerMove);
  shell.addEventListener("pointerup", onPointerUp);
  shell.addEventListener("pointercancel", onPointerUp);
  shell.addEventListener("pointerleave", onPointerUp);

  // Prevent default touch behavior but allow center avatar clicks
  shell.addEventListener("touchstart", e => {
    if (!e.target.closest('.center-avatar')) {
      e.preventDefault();
    }
  }, { passive: false });
  shell.addEventListener("touchmove", e => {
    if (!e.target.closest('.center-avatar')) {
      e.preventDefault();
    }
  }, { passive: false });

  // ---- Button controls
  function nudge(dir) {
    vel += dir * 0.1;
    vel = Math.max(-maxVel, Math.min(maxVel, vel));
  }
  
  function spinRandom() {
    const dir = Math.random() < 0.5 ? -1 : 1;
    vel = dir * (0.2 + Math.random() * 0.2);
  }

  // Desktop buttons
  backBtn.addEventListener("click", () => nudge(-1));
  fwdBtn.addEventListener("click", () => nudge(1));
  spinBtn.addEventListener("click", spinRandom);
  stopBtn.addEventListener("click", () => {
    vel *= 0.15;
    if (Math.abs(vel) < 0.01) vel = 0;
  });

  // Mobile buttons
  const mobileBackBtn = document.getElementById("mobileBackBtn");
  const mobileFwdBtn = document.getElementById("mobileFwdBtn");
  const mobileSpinBtn = document.getElementById("mobileSpinBtn");
  
  if (mobileBackBtn) mobileBackBtn.addEventListener("click", () => nudge(-1));
  if (mobileFwdBtn) mobileFwdBtn.addEventListener("click", () => nudge(1));
  if (mobileSpinBtn) mobileSpinBtn.addEventListener("click", spinRandom);

  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") nudge(-1);
    if (e.key === "ArrowRight") nudge(1);
  });

  // ---- Family List
  function renderFamilyList() {
    memberCount.textContent = `${MEMBERS.length} member${MEMBERS.length !== 1 ? 's' : ''}`;

    if (MEMBERS.length === 0) {
      familyList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <p>Add family members to spin the wheel</p>
        </div>
      `;
      return;
    }

    const currentMemberIdx = pointerMemberIndex();
    
    familyList.innerHTML = MEMBERS.map((m, i) => `
      <div class="family-strip ${i === currentMemberIdx ? 'selected' : ''}" data-index="${i}" onclick="selectMember(${i})">
        <img class="strip-avatar" src="${m.photo_url || m.src}" alt="${m.name}" onerror="this.style.display='none'" />
        <span class="strip-name">${m.name}</span>
        <button class="strip-remove" onclick="event.stopPropagation(); removeMember(${i})" title="Remove">√ó</button>
      </div>
    `).join('');
  }

  // Select a specific member - rotate wheel to show them
  window.selectMember = function(memberIdx) {
    if (memberIdx < 0 || memberIdx >= N) return;
    
    // Find which slot currently has this member, or assign it to slot 0
    let targetSlot = slotMembers.indexOf(memberIdx);
    
    if (targetSlot === -1) {
      // Member not currently visible - put them in slot 0
      slotMembers[0] = memberIdx;
      targetSlot = 0;
    }
    
    // Calculate target angle to put this slot at top
    const targetAngle = -targetSlot * slice;
    
    // Animate to target
    const startAngle = angle;
    const diff = angleDiff(targetAngle, startAngle);
    const duration = 500;
    const startTime = performance.now();
    
    function animateToMember(now) {
      const elapsed = now - startTime;
      const progress = Math.min(1, elapsed / duration);
      const eased = 1 - Math.pow(1 - progress, 3); // ease out cubic
      
      angle = startAngle + diff * eased;
      updateMagicSlots();
      render();
      
      if (progress < 1) {
        requestAnimationFrame(animateToMember);
      } else {
        // Final update
        angle = targetAngle;
        lastPointerIdx = targetSlot;
        updateCenter(memberIdx);
        renderFamilyList();
      }
    }
    
    vel = 0;
    requestAnimationFrame(animateToMember);
  };

  // ---- Add Member
  photoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      pendingPhotoData = ev.target.result;
      previewImg.src = pendingPhotoData;
      photoPreview.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  addMemberBtn.addEventListener("click", () => {
    const name = memberName.value.trim();
    const relation = memberRelation.value.trim();

    if (!name) {
      alert("Please enter a name");
      return;
    }

    if (!pendingPhotoData) {
      alert("Please upload a photo");
      return;
    }

    const newMember = {
      id: Date.now(),
      name: name,
      relationship: relation,
      photo_url: pendingPhotoData,
      img: null
    };

    const img = new Image();
    img.onload = () => {
      newMember.img = img;
      MEMBERS.push(newMember);
      N = MEMBERS.length;
      initSlots();  // Reinitialize magic slots
      renderFamilyList();
      render();
      
      const memberIdx = pointerMemberIndex();
      if (memberIdx >= 0) {
        lastPointerIdx = pointerSlot();
        updateCenter(memberIdx);
      }

      memberName.value = "";
      memberRelation.value = "";
      photoInput.value = "";
      photoPreview.style.display = "none";
      pendingPhotoData = null;
    };
    img.src = pendingPhotoData;
  });

  window.removeMember = function(index) {
    MEMBERS.splice(index, 1);
    N = MEMBERS.length;
    lastPointerIdx = -1;
    initSlots();  // Reinitialize magic slots
    renderFamilyList();
    render();
    
    if (N > 0) {
      const memberIdx = pointerMemberIndex();
      lastPointerIdx = pointerSlot();
      updateCenter(memberIdx);
    } else {
      centerImg.src = "";
      centerImg.classList.add('hidden');
      centerInitials.classList.remove('visible');
      centerLabel.textContent = "‚Äî";
    }
  };

  // ---- Image Loading
  function loadImages(members) {
    return Promise.all(members.map(m => new Promise((resolve) => {
      const im = new Image();
      im.crossOrigin = "anonymous";
      im.onload = () => resolve({ ...m, img: im, ok: true });
      im.onerror = () => {
        // Retry without crossOrigin
        const im2 = new Image();
        im2.onload = () => resolve({ ...m, img: im2, ok: true });
        im2.onerror = () => resolve({ ...m, img: null, ok: false });
        im2.src = m.photo_url || m.src;
      };
      im.src = m.photo_url || m.src;
    })));
  }

  // ---- Initialize
  async function init() {
    resize();

    let membersData = DEMO_MODE ? DEMO_MEMBERS : [];

    const loaded = await loadImages(membersData);
    MEMBERS = loaded.filter(x => x.ok && x.img);
    N = MEMBERS.length;
    
    // Initialize magic wheel slots
    initSlots();

    // Start with random family member
    if (N > 0) {
      const randomMemberIdx = Math.floor(Math.random() * N);
      // Put random member in slot 0 and set angle to show slot 0 at top
      slotMembers[0] = randomMemberIdx;
      angle = 0; // Slot 0 at top
      
      // Shuffle remaining slots with other members
      let otherMembers = [];
      for (let i = 0; i < N; i++) {
        if (i !== randomMemberIdx) otherMembers.push(i);
      }
      // Shuffle
      for (let i = otherMembers.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [otherMembers[i], otherMembers[j]] = [otherMembers[j], otherMembers[i]];
      }
      // Assign to remaining visible slots
      for (let s = 1; s < VISIBLE_SLOTS && s - 1 < otherMembers.length; s++) {
        slotMembers[s] = otherMembers[s - 1];
      }
      
      // Update tracking
      lastPointerIdx = 0;
      nextMemberIdx = (randomMemberIdx + VISIBLE_SLOTS) % N;
      
      // Update prev angles for magic slot tracking
      for (let i = 0; i < VISIBLE_SLOTS; i++) {
        prevSlotAngles[i] = getSlotAngle(i);
      }
    }

    renderFamilyList();

    if (N > 0) {
      const memberIdx = pointerMemberIndex();
      if (memberIdx >= 0) {
        updateCenter(memberIdx);
      }
      
      document.querySelectorAll('.family-strip').forEach((el, i) => {
        el.classList.toggle('selected', i === memberIdx);
      });
    }

    render();

    // Animation loop
    (function loop() {
      applyPhysics();
      render();
      requestAnimationFrame(loop);
    })();
  }

  window.addEventListener("resize", () => { resize(); render(); });
  init();

  // ---- Modal Functions ----
  let currentSelectedMember = null;

  window.openMessageModal = function() {
    const memberIdx = pointerMemberIndex();
    if (memberIdx < 0 || memberIdx >= MEMBERS.length) return;
    
    currentSelectedMember = MEMBERS[memberIdx];
    const modal = document.getElementById('messageModal');
    const modalAvatar = document.getElementById('modalAvatar');
    const modalName = document.getElementById('modalName');
    const modalRelation = document.getElementById('modalRelation');
    
    modalAvatar.src = currentSelectedMember.photo_url || currentSelectedMember.src;
    modalName.textContent = currentSelectedMember.name;
    modalRelation.textContent = currentSelectedMember.relationship || '';
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  };

  window.closeMessageModal = function() {
    const modal = document.getElementById('messageModal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
    currentSelectedMember = null;
  };

  window.switchModalTab = function(tab) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.modal-panel').forEach(p => p.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    document.getElementById(`${tab}Panel`).classList.add('active');
  };

  window.sendMessage = function() {
    const message = document.getElementById('messageText').value.trim();
    const deliveryDate = document.getElementById('deliveryDate').value;
    
    if (!message) {
      alert('Please write a message');
      return;
    }
    
    // TODO: Save to Supabase
    alert(`Message scheduled for ${currentSelectedMember.name}!`);
    document.getElementById('messageText').value = '';
    closeMessageModal();
  };

  window.saveMemory = function() {
    const memory = document.getElementById('memoryText').value.trim();
    const memoryYear = document.getElementById('memoryYear').value;
    
    if (!memory) {
      alert('Please write a memory');
      return;
    }
    
    // TODO: Save to Supabase
    alert(`Memory with ${currentSelectedMember.name} saved!`);
    document.getElementById('memoryText').value = '';
    closeMessageModal();
  };

  let isRecording = false;
  window.toggleRecording = function() {
    const btn = document.getElementById('recordBtn');
    isRecording = !isRecording;
    
    if (isRecording) {
      btn.classList.add('recording');
      btn.innerHTML = '<div class="record-icon"></div> Recording... Click to Stop';
      // TODO: Start actual recording
    } else {
      btn.classList.remove('recording');
      btn.innerHTML = '<div class="record-icon"></div> Record Voice Memory';
      // TODO: Stop and save recording
    }
  };

  // Close modal on overlay click
  document.getElementById('messageModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeMessageModal();
  });

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeMessageModal();
  });

  // Populate year dropdown
  const yearSelect = document.getElementById('memoryYear');
  if (yearSelect) {
    const currentYear = new Date().getFullYear();
    for (let y = currentYear; y >= 1920; y--) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    }
  }
})();
</script>

<!-- Message Modal -->
<div class="modal-overlay" id="messageModal">
  <div class="modal" style="position: relative;">
    <button class="modal-close" onclick="closeMessageModal()">√ó</button>
    
    <div class="modal-header">
      <img class="modal-avatar" id="modalAvatar" alt="" />
      <div class="modal-name" id="modalName">Name</div>
      <div class="modal-relation" id="modalRelation">Relationship</div>
    </div>
    
    <div class="modal-body">
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="message" onclick="switchModalTab('message')">
          üíå Send Message
        </button>
        <button class="modal-tab" data-tab="memory" onclick="switchModalTab('memory')">
          üß† Record Memory
        </button>
      </div>
      
      <!-- Message Panel -->
      <div class="modal-panel active" id="messagePanel">
        <div class="modal-input-row">
          <div>
            <label class="modal-label">Deliver On</label>
            <input type="date" class="modal-input" id="deliveryDate" />
          </div>
          <div>
            <label class="modal-label">Occasion</label>
            <select class="modal-input" id="messageOccasion">
              <option value="">Select...</option>
              <option value="birthday">Birthday</option>
              <option value="anniversary">Anniversary</option>
              <option value="graduation">Graduation</option>
              <option value="holiday">Holiday</option>
              <option value="after">After I'm Gone</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        
        <textarea 
          class="modal-textarea" 
          id="messageText" 
          placeholder="Write your message here... This will be delivered to them on the date you choose."
        ></textarea>
        
        <div class="modal-actions">
          <button class="modal-btn secondary" onclick="closeMessageModal()">Cancel</button>
          <button class="modal-btn primary" onclick="sendMessage()">Schedule Message</button>
        </div>
      </div>
      
      <!-- Memory Panel -->
      <div class="modal-panel" id="memoryPanel">
        <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
          <div class="record-icon"></div>
          Record Voice Memory
        </button>
        
        <div class="modal-input-row">
          <div>
            <label class="modal-label">Year</label>
            <select class="modal-input" id="memoryYear">
              <option value="">Select year...</option>
            </select>
          </div>
          <div>
            <label class="modal-label">Category</label>
            <select class="modal-input" id="memoryCategory">
              <option value="">Select...</option>
              <option value="childhood">Childhood</option>
              <option value="family">Family Moments</option>
              <option value="love">Love & Relationships</option>
              <option value="career">Career & Work</option>
              <option value="lessons">Life Lessons</option>
              <option value="funny">Funny Stories</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        
        <textarea 
          class="modal-textarea" 
          id="memoryText" 
          placeholder="Write about a special memory you shared with this person..."
        ></textarea>
        
        <div class="modal-actions">
          <button class="modal-btn secondary" onclick="closeMessageModal()">Cancel</button>
          <button class="modal-btn primary" onclick="saveMemory()">Save Memory</button>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
