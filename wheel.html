<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gone ‚Äì Family Wheel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --primary: #0ea5e9;
    --primary-hover: #0284c7;
    --accent: #2dd4bf;
    --accent-hover: #14b8a6;
    --bg: #0a0a0a;
    --card-bg: #111111;
    --border: #1a1a1a;
    --text: #ffffff;
    --text-muted: #888888;
    --size: 480px;
    --glow-primary: rgba(14, 165, 233, 0.4);
    --glow-accent: rgba(45, 212, 191, 0.4);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    min-height: 100vh;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  /* Header */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    padding: 12px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(10, 10, 10, 0.95);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(10px);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
  }

  .logo-box {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 22px;
    color: #fff;
    font-family: Georgia, serif;
    font-style: italic;
    box-shadow: 0 4px 15px var(--glow-primary);
  }

  .logo-text {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    letter-spacing: -1px;
  }

  .back-link {
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    border-radius: 8px;
    border: 1px solid #333;
    background: transparent;
    color: #888;
    text-decoration: none;
    transition: all 0.2s;
  }

  .back-link:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  /* Main Layout */
  .main {
    padding-top: 80px;
    min-height: 100vh;
  }

  .content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  .page-title {
    text-align: center;
    margin-bottom: 24px;
  }

  .page-title h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-title p {
    color: var(--text-muted);
    font-size: 14px;
    margin-top: 8px;
  }

  /* Grid Layout */
  .wheel-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
  }

  /* Card */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .card-body {
    padding: 20px;
  }

  /* Wheel Stage */
  .wheel-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px;
    background: radial-gradient(ellipse at 50% 30%, rgba(14, 165, 233, 0.08) 0%, transparent 60%);
  }

  .wheel-shell {
    width: var(--size);
    height: var(--size);
    position: relative;
    display: grid;
    place-items: center;
    user-select: none;
    touch-action: none;
    cursor: grab;
  }

  .wheel-shell:active {
    cursor: grabbing;
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: 50%;
    filter: drop-shadow(0 0 40px var(--glow-primary));
  }

  /* Futuristic Pointer */
  .pointer {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    pointer-events: none;
  }

  .pointer-shape {
    width: 0;
    height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-bottom: 42px solid var(--primary);
    filter: drop-shadow(0 0 12px var(--glow-primary));
  }

  .pointer-glow {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
    50% { opacity: 0.6; transform: translateX(-50%) scale(1.3); }
  }

  /* Center Selected Avatar */
  .center-avatar {
    position: absolute;
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(45, 212, 191, 0.2));
    border: 2px solid rgba(14, 165, 233, 0.3);
    box-shadow: 
      0 0 60px rgba(14, 165, 233, 0.3),
      inset 0 0 30px rgba(0, 0, 0, 0.5);
    display: grid;
    place-items: center;
    z-index: 11;
    pointer-events: none;
  }

  .center-avatar img {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    object-position: 50% 30%;
    border: 2px solid rgba(45, 212, 191, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    background: rgba(0, 0, 0, 0.3);
  }

  .center-avatar img.hidden {
    display: none;
  }

  .center-initials {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  }

  .center-initials.visible {
    display: flex;
  }

  .center-avatar .label {
    position: absolute;
    bottom: -24px;
    padding: 8px 18px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.5px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    white-space: nowrap;
    box-shadow: 0 4px 20px var(--glow-primary);
  }

  /* Wheel Controls */
  .wheel-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 30px;
    flex-wrap: wrap;
  }

  .ctrl-btn {
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ctrl-btn:hover {
    border-color: var(--primary);
    background: rgba(14, 165, 233, 0.1);
    box-shadow: 0 0 20px var(--glow-primary);
  }

  .ctrl-btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border: none;
  }

  .ctrl-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px var(--glow-primary);
  }

  .wheel-hint {
    margin-top: 20px;
    text-align: center;
    color: var(--text-muted);
    font-size: 12px;
    line-height: 1.5;
  }

  /* Side Panel */
  .side-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Stats */
  .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    border: 1px solid var(--border);
    font-size: 13px;
  }

  .stat-row span {
    color: var(--text-muted);
  }

  .stat-row b {
    color: var(--accent);
    font-weight: 600;
  }

  /* Family List */
  .family-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .family-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
  }

  .family-item:hover {
    background: rgba(14, 165, 233, 0.1);
    border-color: var(--border);
  }

  .family-item.selected {
    background: rgba(14, 165, 233, 0.15);
    border-color: var(--primary);
  }

  .family-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border);
  }

  .family-avatar.placeholder {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
  }

  .family-info {
    flex: 1;
  }

  .family-name {
    font-weight: 600;
    font-size: 14px;
  }

  .family-relation {
    font-size: 12px;
    color: var(--text-muted);
  }

  .family-remove {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: rgba(255, 68, 68, 0.1);
    color: #ff4444;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s;
  }

  .family-item:hover .family-remove {
    opacity: 1;
  }

  .family-remove:hover {
    background: rgba(255, 68, 68, 0.2);
  }

  /* Add Member Form */
  .add-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .form-input {
    width: 100%;
    padding: 12px 14px;
    font-size: 13px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    transition: all 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--glow-primary);
  }

  .form-input::placeholder {
    color: #555;
  }

  .file-upload {
    position: relative;
    padding: 20px;
    border: 2px dashed var(--border);
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload:hover {
    border-color: var(--primary);
    background: rgba(14, 165, 233, 0.05);
  }

  .file-upload input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .file-upload-text {
    color: var(--text-muted);
    font-size: 13px;
  }

  .file-upload-text span {
    color: var(--primary);
    font-weight: 600;
  }

  .add-btn {
    padding: 14px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px var(--glow-primary);
  }

  .add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Download Section */
  .download-section {
    margin-top: 16px;
    padding: 16px;
    background: rgba(45, 212, 191, 0.1);
    border: 1px solid rgba(45, 212, 191, 0.2);
    border-radius: 12px;
  }

  .download-section h4 {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .download-btn {
    width: 100%;
    padding: 12px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    border: 1px solid var(--accent);
    background: transparent;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .download-btn:hover {
    background: var(--accent);
    color: #000;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .wheel-grid {
      grid-template-columns: 1fr;
    }
    :root {
      --size: min(420px, 85vw);
    }
    .center-avatar {
      width: 150px;
      height: 150px;
    }
    .center-avatar img {
      width: 120px;
      height: 120px;
    }
  }
</style>
</head>

<body>

<!-- Header -->
<header class="header">
  <a href="gone-dashboard.html" class="logo">
    <div class="logo-box">G</div>
    <span class="logo-text">Gone</span>
  </a>
  <a href="gone-recipients.html" class="back-link">‚Üê Back to Recipients</a>
</header>

<!-- Main -->
<div class="main">
  <div class="content">
    <div class="page-title">
      <h1>Family Wheel</h1>
      <p>Spin the wheel to randomly select a family member for your next message</p>
    </div>

    <div class="wheel-grid">
      <!-- Wheel Card -->
      <div class="card">
        <div class="wheel-stage">
          <div class="wheel-shell" id="shell">
            <div class="pointer">
              <div class="pointer-shape"></div>
              <div class="pointer-glow"></div>
            </div>
            <canvas id="wheelCanvas"></canvas>
            <div class="center-avatar" id="centerAvatar">
              <img id="centerImg" alt="Selected family member" />
              <div class="center-initials" id="centerInitials"></div>
              <div class="label" id="centerLabel">‚Äî</div>
            </div>
          </div>

          <div class="wheel-controls">
            <button class="ctrl-btn" id="backBtn" title="Spin backward (‚Üê)">‚Üê Back</button>
            <button class="ctrl-btn primary" id="spinBtn" title="Random spin">üé≤ Spin!</button>
            <button class="ctrl-btn" id="fwdBtn" title="Spin forward (‚Üí)">Forward ‚Üí</button>
            <button class="ctrl-btn" id="stopBtn" title="Stop quickly">‚èπ Stop</button>
          </div>

          <div class="wheel-hint">
            <span id="wheelHint">Grab and spin the wheel, or use the buttons below</span>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="side-panel">
        <!-- Stats -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Wheel Stats</div>
          </div>
          <div class="card-body">
            <div class="stat-row">
              <span>Rotation</span>
              <b id="rotOut">0¬∞</b>
            </div>
            <div class="stat-row">
              <span>Velocity</span>
              <b id="velOut">0</b>
            </div>
            <div class="stat-row">
              <span>Selected</span>
              <b id="selOut">‚Äî</b>
            </div>
          </div>
        </div>

        <!-- Family Members -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Family Members</div>
            <span style="color: var(--text-muted); font-size: 12px;" id="memberCount">0 members</span>
          </div>
          <div class="card-body">
            <div class="family-list" id="familyList">
              <div class="empty-state">
                <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                <p>Add family members to spin the wheel</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Member -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Add Family Member</div>
          </div>
          <div class="card-body">
            <div class="add-form">
              <div class="form-row">
                <input type="text" class="form-input" id="memberName" placeholder="Name" />
                <input type="text" class="form-input" id="memberRelation" placeholder="Relationship" />
              </div>
              <div class="file-upload" id="photoUpload">
                <input type="file" accept="image/*" id="photoInput" />
                <div class="file-upload-text">
                  <span>Click to upload</span> or drag photo here
                </div>
              </div>
              <div id="photoPreview" style="display: none; text-align: center;">
                <img id="previewImg" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent);" />
              </div>
              <button class="add-btn" id="addMemberBtn">Add to Wheel</button>
            </div>

            <!-- Download Section -->
            <div class="download-section">
              <h4>üì• Export Family Photos</h4>
              <button class="download-btn" id="downloadBtn">
                <span>‚¨á</span> Download All Photos (ZIP)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JSZip for download functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
(() => {
  // ============================================================
  // CONFIGURATION
  // ============================================================
  const SUPABASE_URL = 'YOUR_SUPABASE_URL';
  const SUPABASE_KEY = 'YOUR_SUPABASE_KEY';
  const DEMO_MODE = true;

  const DEMO_MEMBERS = [
    { id: 1, name: "Sarah", relationship: "Daughter", photo_url: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop&crop=face" },
    { id: 2, name: "Michael", relationship: "Son", photo_url: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop&crop=face" },
    { id: 3, name: "Emma", relationship: "Wife", photo_url: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=200&h=200&fit=crop&crop=face" },
    { id: 4, name: "David", relationship: "Father", photo_url: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=200&h=200&fit=crop&crop=face" },
    { id: 5, name: "Linda", relationship: "Mother", photo_url: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=200&h=200&fit=crop&crop=face" },
    { id: 6, name: "James", relationship: "Brother", photo_url: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200&h=200&fit=crop&crop=face" },
  ];

  // ---- DOM Elements
  const canvas = document.getElementById("wheelCanvas");
  const shell = document.getElementById("shell");
  const centerImg = document.getElementById("centerImg");
  const centerInitials = document.getElementById("centerInitials");
  const centerLabel = document.getElementById("centerLabel");
  const rotOut = document.getElementById("rotOut");
  const velOut = document.getElementById("velOut");
  const selOut = document.getElementById("selOut");
  const backBtn = document.getElementById("backBtn");
  const fwdBtn = document.getElementById("fwdBtn");
  const spinBtn = document.getElementById("spinBtn");
  const stopBtn = document.getElementById("stopBtn");
  const familyList = document.getElementById("familyList");
  const memberCount = document.getElementById("memberCount");
  const memberName = document.getElementById("memberName");
  const memberRelation = document.getElementById("memberRelation");
  const photoInput = document.getElementById("photoInput");
  const photoPreview = document.getElementById("photoPreview");
  const previewImg = document.getElementById("previewImg");
  const addMemberBtn = document.getElementById("addMemberBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  // ---- Constants
  const TAU = Math.PI * 2;
  const ctx = canvas.getContext("2d");

  const sliceColors = [
    "#0ea5e9", "#2dd4bf", "#8b5cf6", "#f59e0b", "#ec4899",
    "#06b6d4", "#10b981", "#6366f1", "#f97316", "#d946ef"
  ];

  // Physics
  const friction = 0.988;
  const maxVel = 0.45;
  const detentStrength = 0.018;
  const detentDamping = 0.12;
  const clickLoss = 0.88;

  // ---- State
  let angle = 0;
  let vel = 0;
  let dragging = false;
  let lastAngle = 0;
  let lastTime = 0;
  let lastPointerIdx = -1;
  let MEMBERS = [];
  let N = 0;  // Total family members
  let audioCtx = null;
  let pendingPhotoData = null;

  // === MAGIC WHEEL CONFIG ===
  const VISIBLE_SLOTS = 6;  // Always appears to have 6 slices
  const slice = TAU / VISIBLE_SLOTS;  // Each slice is 60 degrees
  
  // Track which member is in each visual slot
  let slotMembers = [0, 1, 2, 3, 4, 5];  // Member indices for slots 0-5
  let nextMemberIdx = 0;  // Next member to load when slot goes under cover
  let prevSlotAngles = [];  // Track previous angles to detect crossing

  // ---- Audio click
  function tickSound(intensity = 1) {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(600 + 400 * intensity, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.08 * intensity, t + 0.006);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.05);
      o.connect(g).connect(audioCtx.destination);
      o.start(t);
      o.stop(t + 0.06);
    } catch (e) {}
  }

  // ---- Canvas setup
  function resize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const r = shell.getBoundingClientRect();
    canvas.width = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  // Normalize angle to 0..TAU
  function normAngle(a) {
    a = a % TAU;
    return a < 0 ? a + TAU : a;
  }

  // Get which visual SLOT is under the pointer (0-5)
  function pointerSlot() {
    const a = normAngle(-angle);
    return Math.floor((a + slice / 2) / slice) % VISIBLE_SLOTS;
  }

  // Get the actual MEMBER index under the pointer
  function pointerMemberIndex() {
    if (N === 0) return -1;
    const slot = pointerSlot();
    return slotMembers[slot] % N;
  }

  // Target angle to center current slot under pointer
  function nearestDetent() {
    const slot = pointerSlot();
    return -slot * slice;
  }

  // Angle difference handling wrap-around
  function angleDiff(a, b) {
    let d = (a - b) % TAU;
    if (d > Math.PI) d -= TAU;
    if (d < -Math.PI) d += TAU;
    return d;
  }

  // Initialize slot assignments
  function initSlots() {
    slotMembers = [];
    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      slotMembers[i] = i % Math.max(1, N);
    }
    nextMemberIdx = VISIBLE_SLOTS % Math.max(1, N);
    prevSlotAngles = [];
    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      prevSlotAngles[i] = getSlotAngle(i);
    }
  }

  // Get the current angle of a slot's center (relative to top = -PI/2)
  function getSlotAngle(slotIdx) {
    const slotCenter = -Math.PI / 2 + angle + slotIdx * slice;
    return normAngle(slotCenter);
  }

  // Check if angle is in the hidden zone (bottom half: PI/2 to 3*PI/2, i.e., 3 o'clock to 9 o'clock going down)
  function isInHiddenZone(ang) {
    const a = normAngle(ang);
    return a > Math.PI * 0.4 && a < Math.PI * 1.6;  // Roughly 3 o'clock to 9 o'clock
  }

  // Update magic slots - repopulate when crossing into hidden zone
  function updateMagicSlots() {
    if (N <= VISIBLE_SLOTS) return;  // No magic needed if 6 or fewer members

    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      const currentAng = getSlotAngle(i);
      const prevAng = prevSlotAngles[i];
      
      // Check if slot just entered hidden zone
      const wasHidden = isInHiddenZone(prevAng);
      const isHidden = isInHiddenZone(currentAng);
      
      if (!wasHidden && isHidden) {
        // Slot just went under the cover - assign next member
        slotMembers[i] = nextMemberIdx;
        nextMemberIdx = (nextMemberIdx + 1) % N;
      }
      
      prevSlotAngles[i] = currentAng;
    }
  }

  // ---- Draw wedge image (head toward rim, chest toward center, 60% opacity)
  function drawWedgeImage(img, cx, cy, innerR, outerR, startAngle, endAngle) {
    ctx.save();
    ctx.translate(cx, cy);

    // Clip to wedge
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, outerR, startAngle, endAngle);
    ctx.closePath();
    ctx.clip();

    // Rotate canvas so wedge center points up
    const midAngle = (startAngle + endAngle) / 2;
    ctx.rotate(midAngle + Math.PI / 2);

    // Image placement: head at top (toward rim), chest at bottom (toward center)
    const span = outerR - innerR;
    const imgH = span * 0.95;
    const imgW = imgH * 0.8;
    
    // Position: center in slice, pushed toward outer edge
    const dist = innerR + span * 0.55;
    const x = -imgW / 2;
    const y = -dist - imgH * 0.45;

    // Scale to cover
    const scaleX = imgW / img.naturalWidth;
    const scaleY = imgH / img.naturalHeight;
    const sc = Math.max(scaleX, scaleY) * 1.2;
    const dw = img.naturalWidth * sc;
    const dh = img.naturalHeight * sc;
    const dx = x + (imgW - dw) / 2;
    const dy = y + (imgH - dh) / 2;

    // 60% opacity
    ctx.globalAlpha = 0.6;
    ctx.drawImage(img, dx, dy, dw, dh);

    ctx.restore();
  }

  // ---- Draw wheel
  function drawWheel() {
    const w = shell.clientWidth;
    const h = shell.clientHeight;
    const cx = w / 2, cy = h / 2;
    const outerR = Math.min(w, h) / 2 - 8;
    const innerR = outerR * 0.35;
    const rimR = outerR - 4;

    ctx.clearRect(0, 0, w, h);

    if (N === 0) {
      // Empty state
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.arc(0, 0, outerR, 0, TAU);
      ctx.fillStyle = "rgba(14, 165, 233, 0.1)";
      ctx.fill();
      ctx.strokeStyle = "rgba(14, 165, 233, 0.3)";
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,0.5)";
      ctx.font = "16px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Add family members", 0, -10);
      ctx.fillText("to spin the wheel", 0, 15);
      ctx.restore();
      drawCover(cx, cy, outerR, innerR);
      return;
    }

    // Outer glow
    ctx.save();
    ctx.translate(cx, cy);
    const glow = ctx.createRadialGradient(0, 0, outerR * 0.8, 0, 0, outerR + 25);
    glow.addColorStop(0, "transparent");
    glow.addColorStop(1, "rgba(14, 165, 233, 0.12)");
    ctx.beginPath();
    ctx.arc(0, 0, outerR + 25, 0, TAU);
    ctx.fillStyle = glow;
    ctx.fill();
    ctx.restore();

    // Draw all 6 visible slots
    for (let i = 0; i < VISIBLE_SLOTS; i++) {
      // Slot i center position
      const slotCenter = -Math.PI / 2 + angle + i * slice;
      const start = slotCenter - slice / 2;
      const end = slotCenter + slice / 2;

      // Get the member assigned to this slot
      const memberIdx = slotMembers[i] % N;
      const member = MEMBERS[memberIdx];

      // Background color
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, rimR, start, end);
      ctx.closePath();
      ctx.fillStyle = sliceColors[memberIdx % sliceColors.length];
      ctx.globalAlpha = 0.75;
      ctx.fill();
      ctx.restore();

      // Photo (60% opacity)
      if (member && member.img) {
        drawWedgeImage(member.img, cx, cy, innerR, rimR, start, end);
      }

      // Separator line
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(Math.cos(start) * rimR, Math.sin(start) * rimR);
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }

    // Inner ring
    ctx.save();
    ctx.translate(cx, cy);
    ctx.beginPath();
    ctx.arc(0, 0, innerR + 6, 0, TAU);
    ctx.strokeStyle = "rgba(45, 212, 191, 0.5)";
    ctx.lineWidth = 3;
    ctx.stroke();
    ctx.restore();

    // Outer rim
    ctx.save();
    ctx.translate(cx, cy);
    ctx.beginPath();
    ctx.arc(0, 0, outerR, 0, TAU);
    ctx.strokeStyle = "rgba(14, 165, 233, 0.5)";
    ctx.lineWidth = 6;
    ctx.stroke();
    ctx.restore();

    // Draw the magic cover over bottom half
    drawCover(cx, cy, outerR, innerR);
  }

  // Draw the futuristic cover over bottom half (3 o'clock to 9 o'clock)
  function drawCover(cx, cy, outerR, innerR) {
    ctx.save();
    ctx.translate(cx, cy);

    // Cover arc from 3 o'clock (0) to 9 o'clock (PI), going through bottom (PI/2)
    const coverStart = Math.PI * 0.15;  // Just past 3 o'clock
    const coverEnd = Math.PI * 0.85;    // Just before 9 o'clock
    
    // Main cover - dark with gradient
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, outerR + 15, coverStart, coverEnd);
    ctx.closePath();
    
    const coverGrad = ctx.createLinearGradient(0, 0, 0, outerR);
    coverGrad.addColorStop(0, "rgba(10, 10, 10, 0.95)");
    coverGrad.addColorStop(0.5, "rgba(15, 15, 20, 0.98)");
    coverGrad.addColorStop(1, "rgba(10, 10, 10, 0.95)");
    ctx.fillStyle = coverGrad;
    ctx.fill();

    // Futuristic edge glow on cover
    ctx.beginPath();
    ctx.arc(0, 0, outerR + 12, coverStart, coverEnd);
    ctx.strokeStyle = "rgba(14, 165, 233, 0.4)";
    ctx.lineWidth = 3;
    ctx.stroke();

    // Inner edge of cover
    ctx.beginPath();
    ctx.arc(0, 0, innerR - 5, coverStart, coverEnd);
    ctx.strokeStyle = "rgba(45, 212, 191, 0.3)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Side lines of cover
    ctx.beginPath();
    ctx.moveTo(Math.cos(coverStart) * (innerR - 5), Math.sin(coverStart) * (innerR - 5));
    ctx.lineTo(Math.cos(coverStart) * (outerR + 12), Math.sin(coverStart) * (outerR + 12));
    ctx.strokeStyle = "rgba(14, 165, 233, 0.5)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(Math.cos(coverEnd) * (innerR - 5), Math.sin(coverEnd) * (innerR - 5));
    ctx.lineTo(Math.cos(coverEnd) * (outerR + 12), Math.sin(coverEnd) * (outerR + 12));
    ctx.stroke();

    // Decorative circuit-like lines on cover
    const midAngle = Math.PI / 2;
    for (let i = 0; i < 3; i++) {
      const r = innerR + (outerR - innerR) * (0.3 + i * 0.25);
      ctx.beginPath();
      ctx.arc(0, 0, r, coverStart + 0.1, coverEnd - 0.1);
      ctx.strokeStyle = `rgba(14, 165, 233, ${0.15 - i * 0.04})`;
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // "LOADING" dots animation hint
    ctx.fillStyle = "rgba(45, 212, 191, 0.6)";
    ctx.font = "bold 11px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("‚óè ‚óè ‚óè", 0, outerR * 0.65);

    ctx.restore();
  }

  // ---- Update center display
  function updateCenter(idx) {
    if (idx < 0 || idx >= MEMBERS.length) return;
    const m = MEMBERS[idx];
    const photoUrl = m.photo_url || m.src;
    const initials = m.name.charAt(0).toUpperCase();

    centerLabel.textContent = m.name;
    selOut.textContent = m.name;
    centerInitials.textContent = initials;

    if (photoUrl) {
      centerImg.onload = () => {
        centerImg.classList.remove('hidden');
        centerInitials.classList.remove('visible');
      };
      centerImg.onerror = () => {
        centerImg.classList.add('hidden');
        centerInitials.classList.add('visible');
      };
      centerImg.src = photoUrl;
    } else {
      centerImg.classList.add('hidden');
      centerInitials.classList.add('visible');
    }
  }

  function updateDebug() {
    rotOut.textContent = `${(normAngle(angle) * 180 / Math.PI).toFixed(1)}¬∞`;
    velOut.textContent = vel.toFixed(3);
  }

  function render() {
    drawWheel();
    updateDebug();
  }

  // ---- Physics
  function applyPhysics() {
    if (dragging || N === 0) return;

    vel *= friction;

    // Spring to nearest detent
    const target = nearestDetent();
    const err = angleDiff(target, angle);
    const slowFactor = Math.max(0, 1 - Math.abs(vel) / 0.15);
    vel += err * detentStrength * (0.4 + 0.6 * slowFactor);
    vel -= vel * detentDamping * slowFactor;

    vel = Math.max(-maxVel, Math.min(maxVel, vel));
    angle += vel;

    // Update magic slots (repopulate when crossing into hidden zone)
    updateMagicSlots();

    // Check for slot change under pointer
    const slot = pointerSlot();
    const memberIdx = pointerMemberIndex();
    
    if (slot !== lastPointerIdx && memberIdx >= 0) {
      lastPointerIdx = slot;
      updateCenter(memberIdx);
      tickSound(Math.min(1, 0.3 + Math.abs(vel) * 2));
      vel *= clickLoss;

      // Highlight in list
      document.querySelectorAll('.family-item').forEach((el, i) => {
        el.classList.toggle('selected', i === memberIdx);
      });
    }
  }

  // ---- Pointer/Touch handling
  function getAngle(clientX, clientY) {
    const r = shell.getBoundingClientRect();
    const cx = r.left + r.width / 2;
    const cy = r.top + r.height / 2;
    return Math.atan2(clientY - cy, clientX - cx);
  }

  function onPointerDown(e) {
    e.preventDefault();
    dragging = true;
    vel = 0;
    lastAngle = getAngle(e.clientX, e.clientY);
    lastTime = performance.now();
    shell.setPointerCapture(e.pointerId);
  }

  function onPointerMove(e) {
    if (!dragging) return;
    e.preventDefault();
    
    const now = performance.now();
    const newAngle = getAngle(e.clientX, e.clientY);
    let delta = newAngle - lastAngle;
    
    // Handle wrap-around
    if (delta > Math.PI) delta -= TAU;
    if (delta < -Math.PI) delta += TAU;
    
    angle += delta;
    
    // Calculate velocity for momentum
    const dt = now - lastTime;
    if (dt > 0) {
      vel = delta / (dt / 16.67) * 0.8; // Scale to ~60fps
    }
    
    lastAngle = newAngle;
    lastTime = now;
    render();
  }

  function onPointerUp(e) {
    if (!dragging) return;
    dragging = false;
    shell.releasePointerCapture(e.pointerId);
    
    // Clamp velocity
    vel = Math.max(-maxVel, Math.min(maxVel, vel));
  }

  // Attach pointer events
  shell.addEventListener("pointerdown", onPointerDown);
  shell.addEventListener("pointermove", onPointerMove);
  shell.addEventListener("pointerup", onPointerUp);
  shell.addEventListener("pointercancel", onPointerUp);
  shell.addEventListener("pointerleave", onPointerUp);

  // Prevent default touch behavior
  shell.addEventListener("touchstart", e => e.preventDefault(), { passive: false });
  shell.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

  // ---- Button controls
  function nudge(dir) {
    vel += dir * 0.1;
    vel = Math.max(-maxVel, Math.min(maxVel, vel));
  }

  backBtn.addEventListener("click", () => nudge(-1));
  fwdBtn.addEventListener("click", () => nudge(1));
  spinBtn.addEventListener("click", () => {
    const dir = Math.random() < 0.5 ? -1 : 1;
    vel = dir * (0.2 + Math.random() * 0.2);
  });
  stopBtn.addEventListener("click", () => {
    vel *= 0.15;
    if (Math.abs(vel) < 0.01) vel = 0;
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") nudge(-1);
    if (e.key === "ArrowRight") nudge(1);
  });

  // ---- Family List
  function renderFamilyList() {
    memberCount.textContent = `${MEMBERS.length} member${MEMBERS.length !== 1 ? 's' : ''}`;

    if (MEMBERS.length === 0) {
      familyList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <p>Add family members to spin the wheel</p>
        </div>
      `;
      return;
    }

    familyList.innerHTML = MEMBERS.map((m, i) => `
      <div class="family-item ${i === lastPointerIdx ? 'selected' : ''}" data-index="${i}">
        <img class="family-avatar" src="${m.photo_url || m.src}" alt="${m.name}" onerror="this.style.display='none'" />
        <div class="family-info">
          <div class="family-name">${m.name}</div>
          <div class="family-relation">${m.relationship || ''}</div>
        </div>
        <button class="family-remove" onclick="removeMember(${i})" title="Remove">√ó</button>
      </div>
    `).join('');
  }

  // ---- Add Member
  photoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      pendingPhotoData = ev.target.result;
      previewImg.src = pendingPhotoData;
      photoPreview.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  addMemberBtn.addEventListener("click", () => {
    const name = memberName.value.trim();
    const relation = memberRelation.value.trim();

    if (!name) {
      alert("Please enter a name");
      return;
    }

    if (!pendingPhotoData) {
      alert("Please upload a photo");
      return;
    }

    const newMember = {
      id: Date.now(),
      name: name,
      relationship: relation,
      photo_url: pendingPhotoData,
      img: null
    };

    const img = new Image();
    img.onload = () => {
      newMember.img = img;
      MEMBERS.push(newMember);
      N = MEMBERS.length;
      initSlots();  // Reinitialize magic slots
      renderFamilyList();
      render();
      
      const memberIdx = pointerMemberIndex();
      if (memberIdx >= 0) {
        lastPointerIdx = pointerSlot();
        updateCenter(memberIdx);
      }

      memberName.value = "";
      memberRelation.value = "";
      photoInput.value = "";
      photoPreview.style.display = "none";
      pendingPhotoData = null;
    };
    img.src = pendingPhotoData;
  });

  window.removeMember = function(index) {
    MEMBERS.splice(index, 1);
    N = MEMBERS.length;
    lastPointerIdx = -1;
    initSlots();  // Reinitialize magic slots
    renderFamilyList();
    render();
    
    if (N > 0) {
      const memberIdx = pointerMemberIndex();
      lastPointerIdx = pointerSlot();
      updateCenter(memberIdx);
    } else {
      centerImg.src = "";
      centerImg.classList.add('hidden');
      centerInitials.classList.remove('visible');
      centerLabel.textContent = "‚Äî";
      selOut.textContent = "‚Äî";
    }
  };

  // ---- Download
  downloadBtn.addEventListener("click", async () => {
    if (MEMBERS.length === 0) {
      alert("No family members to download");
      return;
    }

    downloadBtn.disabled = true;
    downloadBtn.textContent = "‚è≥ Creating ZIP...";

    try {
      const zip = new JSZip();
      const folder = zip.folder("family-photos");

      for (let i = 0; i < MEMBERS.length; i++) {
        const m = MEMBERS[i];
        const url = m.photo_url || m.src;
        
        if (url.startsWith("data:")) {
          const base64 = url.split(",")[1];
          const ext = url.includes("png") ? "png" : "jpg";
          folder.file(`${m.name.replace(/[^a-z0-9]/gi, '_')}_${i + 1}.${ext}`, base64, { base64: true });
        } else {
          try {
            const response = await fetch(url);
            const blob = await response.blob();
            folder.file(`${m.name.replace(/[^a-z0-9]/gi, '_')}_${i + 1}.jpg`, blob);
          } catch (e) {
            console.warn(`Could not fetch ${m.name}'s photo`);
          }
        }
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "gone-family-photos.zip");
    } catch (e) {
      console.error(e);
      alert("Error creating ZIP file");
    }

    downloadBtn.disabled = false;
    downloadBtn.innerHTML = "<span>‚¨á</span> Download All Photos (ZIP)";
  });

  // ---- Image Loading
  function loadImages(members) {
    return Promise.all(members.map(m => new Promise((resolve) => {
      const im = new Image();
      im.crossOrigin = "anonymous";
      im.onload = () => resolve({ ...m, img: im, ok: true });
      im.onerror = () => {
        // Retry without crossOrigin
        const im2 = new Image();
        im2.onload = () => resolve({ ...m, img: im2, ok: true });
        im2.onerror = () => resolve({ ...m, img: null, ok: false });
        im2.src = m.photo_url || m.src;
      };
      im.src = m.photo_url || m.src;
    })));
  }

  // ---- Initialize
  async function init() {
    resize();

    let membersData = DEMO_MODE ? DEMO_MEMBERS : [];

    const loaded = await loadImages(membersData);
    MEMBERS = loaded.filter(x => x.ok && x.img);
    N = MEMBERS.length;
    
    // Initialize magic wheel slots
    initSlots();

    renderFamilyList();

    if (N > 0) {
      lastPointerIdx = pointerSlot();
      const memberIdx = pointerMemberIndex();
      if (memberIdx >= 0) {
        updateCenter(memberIdx);
      }
      
      document.querySelectorAll('.family-item').forEach((el, i) => {
        el.classList.toggle('selected', i === memberIdx);
      });
    }

    render();

    // Animation loop
    (function loop() {
      applyPhysics();
      render();
      requestAnimationFrame(loop);
    })();
  }

  window.addEventListener("resize", () => { resize(); render(); });
  init();
})();
</script>

</body>
</html>
