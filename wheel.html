<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gone ‚Äì Family Wheel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --primary: #0ea5e9;
    --primary-hover: #0284c7;
    --accent: #2dd4bf;
    --accent-hover: #14b8a6;
    --bg: #0a0a0a;
    --card-bg: #111111;
    --border: #1a1a1a;
    --text: #ffffff;
    --text-muted: #888888;
    --size: 480px;
    --glow-primary: rgba(14, 165, 233, 0.4);
    --glow-accent: rgba(45, 212, 191, 0.4);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    min-height: 100vh;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  /* Header */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    padding: 12px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(10, 10, 10, 0.95);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(10px);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
  }

  .logo-box {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 22px;
    color: #fff;
    font-family: Georgia, serif;
    font-style: italic;
    box-shadow: 0 4px 15px var(--glow-primary);
  }

  .logo-text {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    letter-spacing: -1px;
  }

  .back-link {
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    border-radius: 8px;
    border: 1px solid #333;
    background: transparent;
    color: #888;
    text-decoration: none;
    transition: all 0.2s;
  }

  .back-link:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  /* Main Layout */
  .main {
    padding-top: 80px;
    min-height: 100vh;
  }

  .content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  .page-title {
    text-align: center;
    margin-bottom: 24px;
  }

  .page-title h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-title p {
    color: var(--text-muted);
    font-size: 14px;
    margin-top: 8px;
  }

  /* Grid Layout */
  .wheel-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
  }

  /* Card */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .card-body {
    padding: 20px;
  }

  /* Wheel Stage */
  .wheel-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px;
    background: radial-gradient(ellipse at 50% 30%, rgba(14, 165, 233, 0.08) 0%, transparent 60%);
  }

  .wheel-shell {
    width: var(--size);
    height: var(--size);
    position: relative;
    display: grid;
    place-items: center;
    user-select: none;
    touch-action: none;
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: 50%;
    filter: drop-shadow(0 0 40px var(--glow-primary));
  }

  /* Futuristic Pointer */
  .pointer {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    pointer-events: none;
  }

  .pointer-shape {
    width: 0;
    height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-bottom: 42px solid var(--primary);
    filter: drop-shadow(0 0 12px var(--glow-primary));
  }

  .pointer-glow {
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent);
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
    50% { opacity: 0.6; transform: translateX(-50%) scale(1.3); }
  }

  /* Center Selected Avatar */
  .center-avatar {
    position: absolute;
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(45, 212, 191, 0.2));
    border: 2px solid rgba(14, 165, 233, 0.3);
    box-shadow: 
      0 0 60px rgba(14, 165, 233, 0.3),
      inset 0 0 30px rgba(0, 0, 0, 0.5);
    display: grid;
    place-items: center;
    z-index: 11;
    pointer-events: none;
  }

  .center-avatar img {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    object-position: 50% 30%;
    border: 2px solid rgba(45, 212, 191, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    background: rgba(0, 0, 0, 0.3);
  }

  .center-avatar img.hidden {
    display: none;
  }

  .center-initials {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  }

  .center-initials.visible {
    display: flex;
  }

  .center-avatar .label {
    position: absolute;
    bottom: -24px;
    padding: 8px 18px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.5px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    white-space: nowrap;
    box-shadow: 0 4px 20px var(--glow-primary);
  }

  /* Wheel Controls */
  .wheel-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 30px;
    flex-wrap: wrap;
  }

  .ctrl-btn {
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ctrl-btn:hover {
    border-color: var(--primary);
    background: rgba(14, 165, 233, 0.1);
    box-shadow: 0 0 20px var(--glow-primary);
  }

  .ctrl-btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border: none;
  }

  .ctrl-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px var(--glow-primary);
  }

  .wheel-hint {
    margin-top: 20px;
    text-align: center;
    color: var(--text-muted);
    font-size: 12px;
    line-height: 1.5;
  }

  /* Side Panel */
  .side-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Stats */
  .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    border: 1px solid var(--border);
    font-size: 13px;
  }

  .stat-row span {
    color: var(--text-muted);
  }

  .stat-row b {
    color: var(--accent);
    font-weight: 600;
  }

  /* Family List */
  .family-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .family-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
  }

  .family-item:hover {
    background: rgba(14, 165, 233, 0.1);
    border-color: var(--border);
  }

  .family-item.selected {
    background: rgba(14, 165, 233, 0.15);
    border-color: var(--primary);
  }

  .family-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border);
  }

  .family-avatar.placeholder {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
  }

  .family-info {
    flex: 1;
  }

  .family-name {
    font-weight: 600;
    font-size: 14px;
  }

  .family-relation {
    font-size: 12px;
    color: var(--text-muted);
  }

  .family-remove {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: rgba(255, 68, 68, 0.1);
    color: #ff4444;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s;
  }

  .family-item:hover .family-remove {
    opacity: 1;
  }

  .family-remove:hover {
    background: rgba(255, 68, 68, 0.2);
  }

  /* Add Member Form */
  .add-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .form-input {
    width: 100%;
    padding: 12px 14px;
    font-size: 13px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    transition: all 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--glow-primary);
  }

  .form-input::placeholder {
    color: #555;
  }

  .file-upload {
    position: relative;
    padding: 20px;
    border: 2px dashed var(--border);
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload:hover {
    border-color: var(--primary);
    background: rgba(14, 165, 233, 0.05);
  }

  .file-upload input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .file-upload-text {
    color: var(--text-muted);
    font-size: 13px;
  }

  .file-upload-text span {
    color: var(--primary);
    font-weight: 600;
  }

  .add-btn {
    padding: 14px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px var(--glow-primary);
  }

  .add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Download Section */
  .download-section {
    margin-top: 16px;
    padding: 16px;
    background: rgba(45, 212, 191, 0.1);
    border: 1px solid rgba(45, 212, 191, 0.2);
    border-radius: 12px;
  }

  .download-section h4 {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .download-btn {
    width: 100%;
    padding: 12px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    border: 1px solid var(--accent);
    background: transparent;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .download-btn:hover {
    background: var(--accent);
    color: #000;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .wheel-grid {
      grid-template-columns: 1fr;
    }
    :root {
      --size: min(420px, 85vw);
    }
    .center-avatar {
      width: 150px;
      height: 150px;
    }
    .center-avatar img {
      width: 120px;
      height: 120px;
    }
  }
</style>
</head>

<body>

<!-- Header -->
<header class="header">
  <a href="gone-dashboard.html" class="logo">
    <div class="logo-box">G</div>
    <span class="logo-text">Gone</span>
  </a>
  <a href="gone-recipients.html" class="back-link">‚Üê Back to Recipients</a>
</header>

<!-- Main -->
<div class="main">
  <div class="content">
    <div class="page-title">
      <h1>Family Wheel</h1>
      <p>Spin the wheel to randomly select a family member for your next message</p>
    </div>

    <div class="wheel-grid">
      <!-- Wheel Card -->
      <div class="card">
        <div class="wheel-stage">
          <div class="wheel-shell" id="shell">
            <div class="pointer">
              <div class="pointer-shape"></div>
              <div class="pointer-glow"></div>
            </div>
            <canvas id="wheelCanvas"></canvas>
            <div class="center-avatar" id="centerAvatar">
              <img id="centerImg" alt="Selected family member" />
              <div class="center-initials" id="centerInitials"></div>
              <div class="label" id="centerLabel">‚Äî</div>
            </div>
          </div>

          <div class="wheel-controls">
            <button class="ctrl-btn" id="backBtn" title="Spin backward (‚Üê)">‚Üê Back</button>
            <button class="ctrl-btn primary" id="spinBtn" title="Random spin">üé≤ Spin!</button>
            <button class="ctrl-btn" id="fwdBtn" title="Spin forward (‚Üí)">Forward ‚Üí</button>
            <button class="ctrl-btn" id="stopBtn" title="Stop quickly">‚èπ Stop</button>
          </div>

          <div class="wheel-hint">
            Drag the wheel to spin manually, or use the buttons.<br/>
            The wheel has realistic tension and clicky detents.
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="side-panel">
        <!-- Stats -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Wheel Stats</div>
          </div>
          <div class="card-body">
            <div class="stat-row">
              <span>Rotation</span>
              <b id="rotOut">0¬∞</b>
            </div>
            <div class="stat-row">
              <span>Velocity</span>
              <b id="velOut">0</b>
            </div>
            <div class="stat-row">
              <span>Selected</span>
              <b id="selOut">‚Äî</b>
            </div>
          </div>
        </div>

        <!-- Family Members -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Family Members</div>
            <span style="color: var(--text-muted); font-size: 12px;" id="memberCount">0 members</span>
          </div>
          <div class="card-body">
            <div class="family-list" id="familyList">
              <div class="empty-state">
                <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                <p>Add family members to spin the wheel</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Member -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Add Family Member</div>
          </div>
          <div class="card-body">
            <div class="add-form">
              <div class="form-row">
                <input type="text" class="form-input" id="memberName" placeholder="Name" />
                <input type="text" class="form-input" id="memberRelation" placeholder="Relationship" />
              </div>
              <div class="file-upload" id="photoUpload">
                <input type="file" accept="image/*" id="photoInput" />
                <div class="file-upload-text">
                  <span>Click to upload</span> or drag photo here
                </div>
              </div>
              <div id="photoPreview" style="display: none; text-align: center;">
                <img id="previewImg" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent);" />
              </div>
              <button class="add-btn" id="addMemberBtn">Add to Wheel</button>
            </div>

            <!-- Download Section -->
            <div class="download-section">
              <h4>üì• Export Family Photos</h4>
              <button class="download-btn" id="downloadBtn">
                <span>‚¨á</span> Download All Photos (ZIP)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JSZip for download functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
(() => {
  // ============================================================
  // CONFIGURATION
  // ============================================================
  const SUPABASE_URL = 'YOUR_SUPABASE_URL';
  const SUPABASE_KEY = 'YOUR_SUPABASE_KEY';
  
  // Demo mode - set to false when using real Supabase
  const DEMO_MODE = true;

  // Demo family members
  const DEMO_MEMBERS = [
    { id: 1, name: "Sarah", relationship: "Daughter", photo_url: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop&crop=face" },
    { id: 2, name: "Michael", relationship: "Son", photo_url: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop&crop=face" },
    { id: 3, name: "Emma", relationship: "Wife", photo_url: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=200&h=200&fit=crop&crop=face" },
    { id: 4, name: "David", relationship: "Father", photo_url: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=200&h=200&fit=crop&crop=face" },
    { id: 5, name: "Linda", relationship: "Mother", photo_url: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=200&h=200&fit=crop&crop=face" },
    { id: 6, name: "James", relationship: "Brother", photo_url: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200&h=200&fit=crop&crop=face" },
  ];

  // ---- DOM Elements
  const canvas = document.getElementById("wheelCanvas");
  const shell = document.getElementById("shell");
  const centerImg = document.getElementById("centerImg");
  const centerInitials = document.getElementById("centerInitials");
  const centerLabel = document.getElementById("centerLabel");
  const rotOut = document.getElementById("rotOut");
  const velOut = document.getElementById("velOut");
  const selOut = document.getElementById("selOut");
  const backBtn = document.getElementById("backBtn");
  const fwdBtn = document.getElementById("fwdBtn");
  const spinBtn = document.getElementById("spinBtn");
  const stopBtn = document.getElementById("stopBtn");
  const familyList = document.getElementById("familyList");
  const memberCount = document.getElementById("memberCount");
  const memberName = document.getElementById("memberName");
  const memberRelation = document.getElementById("memberRelation");
  const photoInput = document.getElementById("photoInput");
  const photoPreview = document.getElementById("photoPreview");
  const previewImg = document.getElementById("previewImg");
  const addMemberBtn = document.getElementById("addMemberBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  // ---- Constants
  const TAU = Math.PI * 2;
  const ctx = canvas.getContext("2d");

  // Futuristic color palette
  const sliceColors = [
    "#0ea5e9", "#2dd4bf", "#8b5cf6", "#f59e0b", "#ec4899",
    "#06b6d4", "#10b981", "#6366f1", "#f97316", "#d946ef"
  ];

  // Physics settings
  const friction = 0.985;
  const maxVel = 0.40;
  const detentStrength = 0.020;
  const detentDamping = 0.11;
  const clickLossBase = 0.86;
  const coverCropBias = 0.58;
  const imgScale = 1.18;

  // ---- State
  let angle = 0;
  let vel = 0;
  let dragging = false;
  let dragStartAngle = 0;
  let dragStartRot = 0;
  let lastPointerIdx = -1;
  let MEMBERS = [];
  let N = 0;
  let slice = 0;
  let audioCtx = null;
  let pendingPhotoData = null;

  // ---- Audio
  function tickSound(intensity = 1) {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(600 + 400 * intensity, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.06 * intensity, t + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.04);
      o.connect(g).connect(audioCtx.destination);
      o.start(t);
      o.stop(t + 0.05);
    } catch (e) {}
  }

  // ---- Canvas
  function resize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const r = shell.getBoundingClientRect();
    canvas.width = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  function normRad(a) {
    a = a % TAU;
    if (a < 0) a += TAU;
    return a;
  }

  function pointerIndex() {
    if (N === 0) return -1;
    const a = normRad(-angle);
    return Math.floor((a + slice / 2) / slice) % N;
  }

  function nearestDetentTarget() {
    const a = normRad(angle);
    const k = Math.round(a / slice);
    return k * slice;
  }

  function angDiff(a, b) {
    let d = (a - b) % TAU;
    if (d > Math.PI) d -= TAU;
    if (d < -Math.PI) d += TAU;
    return d;
  }

  function drawWedgeImage(img, cx, cy, innerR, outerR, start, end) {
    ctx.save();
    ctx.translate(cx, cy);

    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, outerR, start, end);
    ctx.closePath();
    ctx.clip();

    const mid = (start + end) / 2;
    ctx.rotate(mid);

    const span = outerR - innerR;
    const rectH = span * 1.08;
    const rectW = rectH * 0.78;
    const yOut = -(innerR + span * coverCropBias);
    const rectY = yOut - rectH * 0.50;
    const rectX = -rectW / 2;

    const sW = img.naturalWidth;
    const sH = img.naturalHeight;
    const tW = rectW * imgScale;
    const tH = rectH * imgScale;
    const scale = Math.max(tW / sW, tH / sH);
    const dW = sW * scale;
    const dH = sH * scale;
    const dx = rectX + (rectW - dW) / 2;
    const dy = rectY + (rectH - dH) / 2;

    ctx.globalAlpha = 0.95;
    ctx.drawImage(img, dx, dy, dW, dH);

    // Vignette
    const grad = ctx.createRadialGradient(0, yOut, innerR * 0.2, 0, yOut, outerR * 0.95);
    grad.addColorStop(0, "rgba(0,0,0,0.00)");
    grad.addColorStop(1, "rgba(0,0,0,0.25)");
    ctx.fillStyle = grad;
    ctx.fillRect(-outerR, -outerR, outerR * 2, outerR * 2);

    ctx.restore();
  }

  function drawWheel() {
    const w = shell.clientWidth;
    const h = shell.clientHeight;
    const cx = w / 2, cy = h / 2;
    const outerR = Math.min(w, h) / 2 - 8;
    const innerR = outerR * 0.34;
    const rimR = outerR - 4;

    ctx.clearRect(0, 0, w, h);

    if (N === 0) {
      // Empty state
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.arc(0, 0, outerR, 0, TAU);
      ctx.fillStyle = "rgba(14, 165, 233, 0.1)";
      ctx.fill();
      ctx.strokeStyle = "rgba(14, 165, 233, 0.3)";
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,0.5)";
      ctx.font = "16px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Add family members", 0, -10);
      ctx.fillText("to spin the wheel", 0, 15);
      ctx.restore();
      return;
    }

    // Background glow
    ctx.save();
    ctx.translate(cx, cy);
    ctx.beginPath();
    ctx.arc(0, 0, outerR + 20, 0, TAU);
    const glowGrad = ctx.createRadialGradient(0, 0, outerR * 0.8, 0, 0, outerR + 30);
    glowGrad.addColorStop(0, "transparent");
    glowGrad.addColorStop(1, "rgba(14, 165, 233, 0.15)");
    ctx.fillStyle = glowGrad;
    ctx.fill();
    ctx.restore();

    for (let i = 0; i < N; i++) {
      const start = angle + i * slice - slice / 2;
      const end = start + slice;

      // Slice color
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, rimR, start, end);
      ctx.closePath();
      ctx.fillStyle = sliceColors[i % sliceColors.length];
      ctx.globalAlpha = 0.7;
      ctx.fill();
      ctx.restore();

      // Photo
      const img = MEMBERS[i].img;
      if (img) drawWedgeImage(img, cx, cy, innerR, rimR, start, end);

      // Separator
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(Math.cos(start) * rimR, Math.sin(start) * rimR);
      ctx.strokeStyle = "rgba(255,255,255,0.25)";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }

    // Inner ring glow
    ctx.save();
    ctx.translate(cx, cy);
    ctx.beginPath();
    ctx.arc(0, 0, innerR + 8, 0, TAU);
    ctx.strokeStyle = "rgba(45, 212, 191, 0.4)";
    ctx.lineWidth = 3;
    ctx.stroke();
    ctx.restore();

    // Outer rim
    ctx.save();
    ctx.translate(cx, cy);
    ctx.beginPath();
    ctx.arc(0, 0, outerR, 0, TAU);
    ctx.strokeStyle = "rgba(14, 165, 233, 0.5)";
    ctx.lineWidth = 8;
    ctx.stroke();
    ctx.restore();
  }

  function updateCenter(idx) {
    if (idx < 0 || idx >= MEMBERS.length) return;
    const m = MEMBERS[idx];
    const photoUrl = m.photo_url || m.src;
    const initials = m.name.charAt(0).toUpperCase();
    
    // Update label
    centerLabel.textContent = m.name;
    selOut.textContent = m.name;
    
    // Set initials as backup
    centerInitials.textContent = initials;
    
    // Try to load image
    if (photoUrl) {
      centerImg.onload = function() {
        centerImg.classList.remove('hidden');
        centerInitials.classList.remove('visible');
      };
      centerImg.onerror = function() {
        centerImg.classList.add('hidden');
        centerInitials.classList.add('visible');
      };
      centerImg.src = photoUrl;
    } else {
      centerImg.classList.add('hidden');
      centerInitials.classList.add('visible');
    }
  }

  function updateDebug() {
    rotOut.textContent = `${(normRad(angle) * 180 / Math.PI).toFixed(1)}¬∞`;
    velOut.textContent = `${vel.toFixed(3)}`;
  }

  function render() {
    drawWheel();
    updateDebug();
  }

  function applyPhysics() {
    if (dragging || N === 0) return;

    vel *= friction;

    const target = nearestDetentTarget();
    const err = angDiff(angle, target);
    const spring = (-err) * detentStrength;
    const damp = -vel * detentDamping;
    const slowFactor = Math.max(0, 1 - (Math.abs(vel) / 0.20));
    vel += (spring + damp) * (0.35 + 0.65 * slowFactor);
    vel = Math.max(-maxVel, Math.min(maxVel, vel));
    angle += vel;

    const idx = pointerIndex();
    if (idx !== lastPointerIdx && idx >= 0) {
      lastPointerIdx = idx;
      updateCenter(idx);
      const intensity = Math.min(1, 0.3 + Math.abs(vel) * 2.5);
      tickSound(intensity);
      vel *= (clickLossBase - 0.10 * Math.min(1, Math.abs(vel) * 3));

      // Highlight selected in list
      document.querySelectorAll('.family-item').forEach((el, i) => {
        el.classList.toggle('selected', i === idx);
      });
    }
  }

  // ---- Controls
  function nudge(dir) {
    vel += dir * 0.085;
    vel = Math.max(-maxVel, Math.min(maxVel, vel));
  }

  backBtn.addEventListener("click", () => nudge(-1));
  fwdBtn.addEventListener("click", () => nudge(1));
  spinBtn.addEventListener("click", () => {
    const dir = Math.random() < 0.5 ? -1 : 1;
    vel = dir * (0.18 + Math.random() * 0.20);
  });
  stopBtn.addEventListener("click", () => {
    vel *= 0.20;
    if (Math.abs(vel) < 0.01) vel = 0;
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") nudge(-1);
    if (e.key === "ArrowRight") nudge(1);
  });

  // ---- Drag
  function getAngleFromCenter(clientX, clientY) {
    const r = shell.getBoundingClientRect();
    const cx = r.left + r.width / 2;
    const cy = r.top + r.height / 2;
    return Math.atan2(clientY - cy, clientX - cx) + Math.PI / 2;
  }

  shell.addEventListener("pointerdown", (e) => {
    if (e.pointerType === "mouse" && e.button !== 0) return;
    shell.setPointerCapture?.(e.pointerId);
    dragging = true;
    vel = 0;
    dragStartRot = angle;
    dragStartAngle = getAngleFromCenter(e.clientX, e.clientY);
  });

  window.addEventListener("pointermove", (e) => {
    if (!dragging) return;
    const a = getAngleFromCenter(e.clientX, e.clientY);
    angle = dragStartRot + (a - dragStartAngle);
    render();
  });

  window.addEventListener("pointerup", () => { dragging = false; });
  window.addEventListener("pointercancel", () => { dragging = false; });

  // ---- Family List
  function renderFamilyList() {
    memberCount.textContent = `${MEMBERS.length} member${MEMBERS.length !== 1 ? 's' : ''}`;

    if (MEMBERS.length === 0) {
      familyList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <p>Add family members to spin the wheel</p>
        </div>
      `;
      return;
    }

    familyList.innerHTML = MEMBERS.map((m, i) => `
      <div class="family-item ${i === lastPointerIdx ? 'selected' : ''}" data-index="${i}">
        <img class="family-avatar" src="${m.photo_url || m.src}" alt="${m.name}" onerror="this.style.display='none'" />
        <div class="family-info">
          <div class="family-name">${m.name}</div>
          <div class="family-relation">${m.relationship || ''}</div>
        </div>
        <button class="family-remove" onclick="removeMember(${i})" title="Remove">√ó</button>
      </div>
    `).join('');
  }

  // ---- Add Member
  photoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      pendingPhotoData = ev.target.result;
      previewImg.src = pendingPhotoData;
      photoPreview.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  addMemberBtn.addEventListener("click", () => {
    const name = memberName.value.trim();
    const relation = memberRelation.value.trim();

    if (!name) {
      alert("Please enter a name");
      return;
    }

    if (!pendingPhotoData) {
      alert("Please upload a photo");
      return;
    }

    // Create new member
    const newMember = {
      id: Date.now(),
      name: name,
      relationship: relation,
      photo_url: pendingPhotoData,
      img: null
    };

    // Load image
    const img = new Image();
    img.onload = () => {
      newMember.img = img;
      MEMBERS.push(newMember);
      N = MEMBERS.length;
      slice = TAU / N;
      renderFamilyList();
      render();
      
      // Update center with current selection
      const idx = pointerIndex();
      if (idx >= 0) {
        lastPointerIdx = idx;
        updateCenter(idx);
      }

      // Reset form
      memberName.value = "";
      memberRelation.value = "";
      photoInput.value = "";
      photoPreview.style.display = "none";
      pendingPhotoData = null;
    };
    img.src = pendingPhotoData;
  });

  window.removeMember = function(index) {
    MEMBERS.splice(index, 1);
    N = MEMBERS.length;
    slice = N > 0 ? TAU / N : 0;
    lastPointerIdx = -1;
    renderFamilyList();
    render();
    
    if (N > 0) {
      const idx = pointerIndex();
      lastPointerIdx = idx;
      updateCenter(idx);
    } else {
      centerImg.src = "";
      centerImg.classList.add('hidden');
      centerInitials.classList.remove('visible');
      centerLabel.textContent = "‚Äî";
      selOut.textContent = "‚Äî";
    }
  };

  // ---- Download Photos
  downloadBtn.addEventListener("click", async () => {
    if (MEMBERS.length === 0) {
      alert("No family members to download");
      return;
    }

    downloadBtn.disabled = true;
    downloadBtn.textContent = "‚è≥ Creating ZIP...";

    try {
      const zip = new JSZip();
      const folder = zip.folder("family-photos");

      for (let i = 0; i < MEMBERS.length; i++) {
        const m = MEMBERS[i];
        const url = m.photo_url || m.src;
        
        // For data URLs, extract the base64
        if (url.startsWith("data:")) {
          const base64 = url.split(",")[1];
          const ext = url.includes("png") ? "png" : "jpg";
          folder.file(`${m.name.replace(/[^a-z0-9]/gi, '_')}_${i + 1}.${ext}`, base64, { base64: true });
        } else {
          // For external URLs, fetch them
          try {
            const response = await fetch(url);
            const blob = await response.blob();
            folder.file(`${m.name.replace(/[^a-z0-9]/gi, '_')}_${i + 1}.jpg`, blob);
          } catch (e) {
            console.warn(`Could not fetch ${m.name}'s photo`);
          }
        }
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "gone-family-photos.zip");
    } catch (e) {
      console.error(e);
      alert("Error creating ZIP file");
    }

    downloadBtn.disabled = false;
    downloadBtn.innerHTML = "<span>‚¨á</span> Download All Photos (ZIP)";
  });

  // ---- Image Loading
  function loadImages(members) {
    return Promise.all(members.map(m => new Promise((resolve) => {
      const im = new Image();
      // Only set crossOrigin for data URLs or same-origin
      const photoUrl = m.photo_url || m.src;
      if (photoUrl && !photoUrl.startsWith('data:')) {
        // Try without crossOrigin first for external images
        im.crossOrigin = "anonymous";
      }
      im.onload = () => resolve({ ...m, img: im, ok: true });
      im.onerror = () => {
        // Retry without crossOrigin if it failed
        const im2 = new Image();
        im2.onload = () => resolve({ ...m, img: im2, ok: true });
        im2.onerror = () => resolve({ ...m, img: null, ok: false });
        im2.src = photoUrl;
      };
      im.src = photoUrl;
    })));
  }

  // ---- Initialize
  async function init() {
    resize();

    // Load members (demo or from Supabase)
    let membersData = DEMO_MODE ? DEMO_MEMBERS : [];

    if (!DEMO_MODE) {
      // TODO: Load from Supabase
      // const { data, error } = await supabase
      //   .from('gone_family_members')
      //   .select('*')
      //   .eq('is_active', true)
      //   .order('display_order');
      // if (data) membersData = data;
    }

    const loaded = await loadImages(membersData);
    MEMBERS = loaded.filter(x => x.ok && x.img);
    N = MEMBERS.length;
    slice = N > 0 ? TAU / N : 0;

    renderFamilyList();

    if (N > 0) {
      lastPointerIdx = pointerIndex();
      if (lastPointerIdx < 0) lastPointerIdx = 0;
      updateCenter(lastPointerIdx);
      
      // Highlight initial selection in list
      document.querySelectorAll('.family-item').forEach((el, i) => {
        el.classList.toggle('selected', i === lastPointerIdx);
      });
    }

    render();

    // Animation loop
    (function loop() {
      applyPhysics();
      render();
      requestAnimationFrame(loop);
    })();
  }

  window.addEventListener("resize", () => { resize(); render(); });
  init();
})();
</script>

</body>
</html>
