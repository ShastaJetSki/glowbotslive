<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Scheduler</title>
  <style>
    /* ===== THEME SYSTEM ===== */
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8;
    }
    [data-theme="charcoal"] {
      --bg-primary: #121214; --bg-secondary: #18181b; --bg-card: #27272a; --bg-hover: #3f3f46;
      --border-default: #3f3f46; --text-primary: #fafafa; --text-secondary: #a1a1aa;
      --accent-primary: #a1a1aa; --accent-light: #d4d4d8;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80;
    }
    [data-theme="obsidian"] {
      --bg-primary: #050505; --bg-secondary: #0a0a0a; --bg-card: #141414; --bg-hover: #1c1c1c;
      --border-default: #252525; --text-primary: #e0e0e0; --text-secondary: #888888;
      --accent-primary: #0ea5e9; --accent-light: #38bdf8;
    }
    [data-theme="steel"] {
      --bg-primary: #0c0f13; --bg-secondary: #12161c; --bg-card: #1a2028; --bg-hover: #242c38;
      --border-default: #2c3644; --text-primary: #e4e8ed; --text-secondary: #8b95a5;
      --accent-primary: #64748b; --accent-light: #94a3b8;
    }
    [data-theme="espresso"] {
      --bg-primary: #0f0c0a; --bg-secondary: #161210; --bg-card: #211c18; --bg-hover: #2c2520;
      --border-default: #382f28; --text-primary: #f0ebe5; --text-secondary: #a89e94;
      --accent-primary: #a78b6e; --accent-light: #c4a88a;
    }
    [data-theme="onyx"] {
      --bg-primary: #000000; --bg-secondary: #080808; --bg-card: #121212; --bg-hover: #1a1a1a;
      --border-default: #222222; --text-primary: #f5f5f5; --text-secondary: #8c8c8c;
      --accent-primary: #06b6d4; --accent-light: #22d3ee;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    body { padding-bottom: 165px; }

    /* ===== HEADER ===== */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-btn, .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .menu-btn:active, .icon-btn:active { background: var(--bg-hover); }

    .header-title {
      font-size: 20px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    /* ===== MAIN TABS ===== */
    .main-tabs {
      display: flex;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-default);
    }

    .main-tab {
      flex: 1;
      padding: 14px 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .main-tab.active {
      color: var(--accent-light);
      border-bottom-color: var(--accent-primary);
    }

    .main-tab:active { background: var(--bg-hover); }

    /* Fleet Toggle */
    .fleet-toggle {
      display: none;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-default);
    }

    .fleet-toggle.show {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .fleet-toggle label {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .fleet-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-primary);
    }

    /* Date Nav */
    .date-nav-bar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      background: var(--bg-secondary);
    }
    .date-nav-bar::-webkit-scrollbar { display: none; }

    .date-chip {
      flex-shrink: 0;
      padding: 10px 14px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 56px;
      transition: all 0.2s;
    }

    .date-chip:active { transform: scale(0.95); }

    .date-chip.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }

    .date-chip .day-name {
      font-size: 10px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .date-chip .day-num {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px;
    }

    .date-chip .job-count {
      font-size: 9px;
      margin-top: 2px;
      opacity: 0.8;
    }

    /* Controls Row */
    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
      border-bottom: 1px solid var(--border-default);
      background: var(--bg-secondary);
    }

    .view-toggle {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 10px;
    }

    .view-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .view-btn:active { transform: scale(0.95); }

    .view-btn.active {
      background: var(--accent-primary);
      color: white;
    }

    .filter-pills {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      flex: 1;
    }
    .filter-pills::-webkit-scrollbar { display: none; }

    .filter-pill {
      flex-shrink: 0;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .filter-pill:active { transform: scale(0.95); }

    .filter-pill.active {
      background: color-mix(in srgb, var(--accent-primary) 20%, transparent);
      border-color: var(--accent-primary);
      color: var(--accent-light);
    }

    .filter-pill .count {
      background: var(--bg-hover);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    /* ===== CONTENT ===== */
    .content-area { min-height: calc(100vh - 350px); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ===== TECH LANES ===== */
    .lanes-container { padding: 16px 0; }
    .tech-lane { margin-bottom: 20px; }

    .lane-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      margin-bottom: 12px;
    }

    .lane-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tech-avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
      color: white;
    }
    .tech-avatar.green { background: #22c55e; }
    .tech-avatar.orange { background: #f97316; }
    .tech-avatar.purple { background: #8b5cf6; }
    .tech-avatar.teal { background: #14b8a6; }

    .tech-details h3 { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
    .tech-details span { font-size: 13px; color: var(--text-secondary); }

    .lane-stats { display: flex; gap: 16px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 18px; font-weight: 700; }
    .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }

    .lane-cards {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 0 16px 8px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .lane-cards::-webkit-scrollbar { display: none; }

    /* ===== WORK ORDER CARD (3 Lines) ===== */
    .wo-card {
      flex-shrink: 0;
      width: 220px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-default);
      padding: 12px 14px;
      scroll-snap-align: start;
      cursor: pointer;
      position: relative;
      border-left: 4px solid var(--accent-primary);
      transition: transform 0.2s;
    }

    .wo-card:active { transform: scale(0.98); }
    .wo-card.dragging { opacity: 0.5; }

    .wo-card.status-in_progress { border-left-color: var(--accent-primary); }
    .wo-card.status-waiting { border-left-color: #eab308; }
    .wo-card.status-completed { border-left-color: #22c55e; }
    .wo-card.status-urgent { border-left-color: #ef4444; }
    .wo-card.status-confirmed { border-left-color: #8b5cf6; }
    .wo-card.status-scheduled { border-left-color: var(--text-secondary); }

    .wo-card.fleet::after {
      content: 'FLEET';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 8px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      background: #14b8a6;
      color: white;
    }

    .card-time { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .card-customer {
      font-size: 15px; font-weight: 600; margin-bottom: 6px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      padding-right: 40px;
    }

    .card-info-row { display: flex; align-items: center; gap: 6px; }
    .card-vehicle {
      font-size: 12px; color: var(--text-secondary);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px;
    }
    .card-dot { width: 3px; height: 3px; border-radius: 50%; background: var(--text-secondary); }

    .card-status {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      padding: 2px 6px; border-radius: 4px;
    }
    .card-status.in_progress { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); color: var(--accent-light); }
    .card-status.waiting { background: rgba(234,179,8,0.15); color: #eab308; }
    .card-status.completed { background: rgba(34,197,94,0.15); color: #22c55e; }
    .card-status.urgent { background: rgba(239,68,68,0.15); color: #ef4444; }
    .card-status.confirmed { background: rgba(139,92,246,0.15); color: #a78bfa; }
    .card-status.scheduled { background: var(--bg-hover); color: var(--text-secondary); }

    .card-amount { font-size: 13px; font-weight: 700; margin-left: auto; }

    /* Add Card */
    .add-card {
      flex-shrink: 0;
      width: 80px;
      min-height: 70px;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 2px dashed var(--border-default);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
    }
    .add-card:active { background: var(--bg-hover); border-color: var(--accent-primary); }
    .add-card-icon {
      width: 24px; height: 24px; border-radius: 6px;
      background: var(--bg-hover);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: var(--text-secondary);
    }
    .add-card span { font-size: 10px; color: var(--text-secondary); }

    .lane-cards.drop-active {
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border-radius: 12px;
    }

    /* ===== SALES LIST ===== */
    .sales-list { padding: 16px; }

    .sales-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      border-left: 4px solid #8b5cf6;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .sales-card:active { transform: scale(0.99); }
    .sales-time { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .sales-customer { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .sales-info { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); flex-wrap: wrap; }
    .sales-type {
      padding: 2px 6px; border-radius: 4px;
      background: rgba(139,92,246,0.15); color: #a78bfa;
      font-size: 10px; font-weight: 600;
    }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-text { font-size: 16px; }

    /* ===== MOBILE ACTION BUTTONS ===== */
    .mobile-action-buttons {
      position: fixed;
      bottom: 102px;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-default);
      padding: 8px 8px 0 8px;
      z-index: 101;
    }

    .mobile-action-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .mobile-action-btn {
      padding: 10px 8px;
      border-radius: 8px;
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--accent-light);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .mobile-action-btn:active { transform: scale(0.95); }
    .mobile-action-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    /* ===== MOBILE BOTTOM NAV ===== */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-default);
      padding: 8px;
      z-index: 100;
    }

    .mobile-nav-top {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .mobile-nav-secondary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .mobile-nav-btn {
      padding: 10px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }

    .mobile-nav-btn.active {
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent);
      border-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .mobile-nav-btn.related {
      background: color-mix(in srgb, var(--accent-primary) 10%, transparent);
      border-color: color-mix(in srgb, var(--accent-primary) 30%, transparent);
      color: var(--text-primary);
    }

    @supports not (background: color-mix(in srgb, red 50%, blue)) {
      .mobile-nav-btn.active, .mobile-action-btn.active { background: var(--accent-primary); opacity: 0.6; }
      .mobile-nav-btn.related, .mobile-action-btn { background: var(--bg-hover); border-color: var(--accent-primary); }
      .filter-pill.active, .card-status.in_progress { background: var(--bg-hover); }
      .lane-cards.drop-active { background: var(--bg-hover); }
    }

    .toast {
      position: fixed;
      bottom: 200px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      color: var(--text-primary);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      display: none;
      max-width: 90%;
      text-align: center;
    }
    .toast.show { display: block; animation: toastIn 0.3s ease; }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-top">
    <div class="header-left">
      <button class="menu-btn" onclick="location.href='dashboard-service.html'">‚Üê</button>
      <h1 class="header-title">Scheduler</h1>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="location.href='dashboard-search.html'">üîç</button>
      <button class="icon-btn" onclick="cycleTheme()">üé®</button>
    </div>
  </div>
</header>

<!-- Main Tabs: Service / Sales / Fleet -->
<div class="main-tabs">
  <button class="main-tab active" data-tab="service">Service</button>
  <button class="main-tab" data-tab="sales">Sales</button>
  <button class="main-tab" data-tab="fleet">Fleet</button>
</div>

<!-- Fleet Toggle (shows in Service tab) -->
<div class="fleet-toggle show" id="fleetToggle">
  <label>
    <input type="checkbox" id="includeFleet">
    Include Fleet Jobs
  </label>
</div>

<!-- Date Nav -->
<div class="date-nav-bar" id="dateNav"></div>

<!-- Controls -->
<div class="controls-row">
  <div class="view-toggle">
    <button class="view-btn active" data-view="day">Day</button>
    <button class="view-btn" data-view="week">Week</button>
    <button class="view-btn" data-view="30d">30D</button>
  </div>
  <div class="filter-pills" id="filterPills"></div>
</div>

<!-- Content -->
<div class="content-area">
  <div class="tab-content active" id="content-service">
    <div class="lanes-container" id="serviceLanes"></div>
  </div>
  <div class="tab-content" id="content-sales">
    <div class="sales-list" id="salesList"></div>
  </div>
  <div class="tab-content" id="content-fleet">
    <div class="lanes-container" id="fleetLanes"></div>
  </div>
</div>

<!-- Mobile Action Buttons -->
<div class="mobile-action-buttons">
  <div class="mobile-action-grid">
    <button class="mobile-action-btn" onclick="location.href='work-order-new.html'">+ Work Order</button>
    <button class="mobile-action-btn active">Scheduler</button>
    <button class="mobile-action-btn" onclick="location.href='appointment-new.html'">+ Appointment</button>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<nav class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-business.html" class="mobile-nav-btn related">Business</a>
    <a href="dashboard-search.html" class="mobile-nav-btn">Search</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn related">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn related">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn related">Sales</a>
  </div>
</nav>

<div class="toast" id="toast"></div>

<script>
// ===== DATA =====
const technicians = [
  { id: 'mike', name: 'Mike Rodriguez', role: 'Master Tech', bay: 'Bay 1', initials: 'MR', color: '' },
  { id: 'tom', name: 'Tom Jackson', role: 'Senior Tech', bay: 'Bay 2', initials: 'TJ', color: 'green' },
  { id: 'alex', name: 'Alex Lee', role: 'Technician', bay: 'Bay 3', initials: 'AL', color: 'orange' },
  { id: 'unassigned', name: 'Unassigned', role: 'Drag to assign', bay: '', initials: '?', color: 'purple' }
];

const serviceJobs = [
  { id: 'WO-2847', customer: 'James Wilson', vehicle: 'Ford F-150', time: '8:00 AM', status: 'in_progress', tech: 'mike', amount: '$485', date: 0, fleet: false },
  { id: 'WO-2851', customer: 'Sarah Chen', vehicle: 'Tesla Model Y', time: '10:30 AM', status: 'waiting', tech: 'mike', amount: '$890', date: 0, fleet: false },
  { id: 'WO-2856', customer: 'Robert Martinez', vehicle: 'Chevy Silverado', time: '1:00 PM', status: 'scheduled', tech: 'mike', amount: '$245', date: 0, fleet: false },
  { id: 'WO-2860', customer: 'Emily Thompson', vehicle: 'Honda CR-V', time: '3:30 PM', status: 'scheduled', tech: 'mike', amount: '$320', date: 0, fleet: false },
  { id: 'WO-2845', customer: 'David Kim', vehicle: 'BMW X5', time: '8:00 AM', status: 'completed', tech: 'tom', amount: '$125', date: 0, fleet: false },
  { id: 'WO-2849', customer: 'Maria Garcia', vehicle: 'Toyota Camry', time: '9:30 AM', status: 'in_progress', tech: 'tom', amount: '$1,250', date: 0, fleet: false },
  { id: 'WO-2862', customer: 'Kevin O\'Brien', vehicle: 'Jeep Wrangler', time: '2:00 PM', status: 'urgent', tech: 'tom', amount: 'TBD', date: 0, fleet: false },
  { id: 'WO-2844', customer: 'Lisa Brown', vehicle: 'Mazda CX-5', time: '8:30 AM', status: 'completed', tech: 'alex', amount: '$185', date: 0, fleet: false },
  { id: 'WO-2853', customer: 'Chris Taylor', vehicle: 'Audi Q7', time: '11:00 AM', status: 'in_progress', tech: 'alex', amount: '$395', date: 0, fleet: false },
  { id: 'WO-2858', customer: 'Amanda White', vehicle: 'Hyundai Tucson', time: '2:30 PM', status: 'scheduled', tech: 'alex', amount: '$0', date: 0, fleet: false },
  { id: 'WO-2864', customer: 'Michael Chang', vehicle: 'Kia Telluride', time: 'TBD', status: 'scheduled', tech: 'unassigned', amount: '$220', date: 0, fleet: false },
  { id: 'WO-2865', customer: 'Jennifer Lopez', vehicle: 'Lexus RX', time: 'TBD', status: 'waiting', tech: 'unassigned', amount: '$400', date: 0, fleet: false },
  { id: 'WO-2870', customer: 'Tom Hanks', vehicle: 'Mercedes GLE', time: '9:00 AM', status: 'scheduled', tech: 'mike', amount: '$550', date: 1, fleet: false },
  { id: 'WO-2871', customer: 'Jane Doe', vehicle: 'Volvo XC90', time: '10:00 AM', status: 'scheduled', tech: 'tom', amount: '$320', date: 1, fleet: false },
  { id: 'WO-2875', customer: 'Bob Smith', vehicle: 'Porsche Cayenne', time: '8:00 AM', status: 'scheduled', tech: 'alex', amount: '$780', date: 2, fleet: false }
];

const fleetJobs = [
  { id: 'FL-1001', customer: 'ABC Trucking', vehicle: 'Freightliner #101', time: '7:00 AM', status: 'in_progress', tech: 'mike', amount: '$1,200', date: 0, fleet: true },
  { id: 'FL-1002', customer: 'ABC Trucking', vehicle: 'Freightliner #102', time: '8:00 AM', status: 'scheduled', tech: 'tom', amount: '$850', date: 0, fleet: true },
  { id: 'FL-1003', customer: 'City Transit', vehicle: 'Bus #45', time: '9:00 AM', status: 'waiting', tech: 'alex', amount: '$2,100', date: 0, fleet: true },
  { id: 'FL-1004', customer: 'ABC Trucking', vehicle: 'Freightliner #103', time: '1:00 PM', status: 'scheduled', tech: 'unassigned', amount: '$950', date: 0, fleet: true },
  { id: 'FL-1010', customer: 'City Transit', vehicle: 'Bus #46', time: '8:00 AM', status: 'scheduled', tech: 'mike', amount: '$1,800', date: 1, fleet: true },
  { id: 'FL-1011', customer: 'XYZ Logistics', vehicle: 'Van #22', time: '10:00 AM', status: 'scheduled', tech: 'tom', amount: '$450', date: 1, fleet: true }
];

const salesAppointments = [
  { id: 'SA-501', customer: 'Mark Johnson', time: '9:00 AM', type: 'Test Drive', vehicle: '2024 Honda Accord', salesperson: 'John Smith', status: 'confirmed', date: 0 },
  { id: 'SA-502', customer: 'Linda Williams', time: '10:30 AM', type: 'New Purchase', vehicle: '2024 Toyota RAV4', salesperson: 'Sarah Davis', status: 'confirmed', date: 0 },
  { id: 'SA-503', customer: 'Steve Rogers', time: '1:00 PM', type: 'Trade-In', vehicle: '2024 Ford Bronco', salesperson: 'John Smith', status: 'scheduled', date: 0 },
  { id: 'SA-504', customer: 'Nancy Drew', time: '3:00 PM', type: 'Financing', vehicle: '2024 Chevy Equinox', salesperson: 'Sarah Davis', status: 'scheduled', date: 0 },
  { id: 'SA-510', customer: 'Peter Parker', time: '11:00 AM', type: 'Test Drive', vehicle: '2024 Tesla Model 3', salesperson: 'John Smith', status: 'confirmed', date: 1 },
  { id: 'SA-511', customer: 'Mary Jane', time: '2:00 PM', type: 'New Purchase', vehicle: '2024 BMW X3', salesperson: 'Sarah Davis', status: 'scheduled', date: 1 },
  { id: 'SA-520', customer: 'Bruce Wayne', time: '10:00 AM', type: 'Trade-In', vehicle: '2024 Audi Q8', salesperson: 'John Smith', status: 'scheduled', date: 2 }
];

// ===== STATE =====
let currentTab = 'service';
let currentView = 'day';
let selectedDate = 0;
let currentFilter = 'all';

// ===== THEME =====
const themes = ['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx'];
let themeIndex = 0;

function loadTheme() {
  const t = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', t);
  themeIndex = themes.indexOf(t);
  if (themeIndex < 0) themeIndex = 0;
}

function cycleTheme() {
  themeIndex = (themeIndex + 1) % themes.length;
  document.documentElement.setAttribute('data-theme', themes[themeIndex]);
  localStorage.setItem('app-theme', themes[themeIndex]);
  showToast('Theme: ' + themes[themeIndex]);
}

loadTheme();

// ===== URL PARAMS =====
function getUrlParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

// Set initial tab from URL
const urlTab = getUrlParam('tab');
if (urlTab && ['service', 'sales', 'fleet'].includes(urlTab)) {
  currentTab = urlTab;
}

// ===== DATE NAV =====
function generateDateNav() {
  const nav = document.getElementById('dateNav');
  const today = new Date();
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  
  let html = '';
  for (let i = -2; i < 14; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    
    let jobCount = 0;
    if (currentTab === 'service') {
      const includeFleet = document.getElementById('includeFleet')?.checked || false;
      jobCount = serviceJobs.filter(j => j.date === i).length;
      if (includeFleet) jobCount += fleetJobs.filter(j => j.date === i).length;
    } else if (currentTab === 'sales') {
      jobCount = salesAppointments.filter(a => a.date === i).length;
    } else if (currentTab === 'fleet') {
      jobCount = fleetJobs.filter(j => j.date === i).length;
    }
    
    html += `
      <div class="date-chip ${i === selectedDate ? 'active' : ''}" data-date="${i}">
        <span class="day-name">${days[d.getDay()]}</span>
        <span class="day-num">${d.getDate()}</span>
        ${jobCount > 0 ? `<span class="job-count">${jobCount} jobs</span>` : ''}
      </div>
    `;
  }
  nav.innerHTML = html;
  
  // Attach click handlers
  nav.querySelectorAll('.date-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      selectedDate = parseInt(this.dataset.date);
      generateDateNav();
      renderCurrentView();
      
      const today = new Date();
      const d = new Date(today);
      d.setDate(d.getDate() + selectedDate);
      const dateStr = selectedDate === 0 ? 'Today' : selectedDate === 1 ? 'Tomorrow' : selectedDate === -1 ? 'Yesterday' : d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      showToast(dateStr);
    });
  });
}

// ===== MAIN TABS =====
function setupMainTabs() {
  document.querySelectorAll('.main-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      currentTab = this.dataset.tab;
      
      // Update active state
      document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`content-${currentTab}`).classList.add('active');
      
      // Show/hide fleet toggle
      document.getElementById('fleetToggle').classList.toggle('show', currentTab === 'service');
      
      // Reset filter
      currentFilter = 'all';
      
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('tab', currentTab);
      window.history.replaceState({}, '', url);
      
      // Regenerate
      generateDateNav();
      updateFilters();
      renderCurrentView();
    });
  });
  
  // Set initial active tab
  document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.main-tab[data-tab="${currentTab}"]`).classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(`content-${currentTab}`).classList.add('active');
  document.getElementById('fleetToggle').classList.toggle('show', currentTab === 'service');
}

// ===== VIEW TOGGLE =====
function setupViewToggle() {
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      currentView = this.dataset.view;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      showToast(currentView.toUpperCase() + ' view');
      renderCurrentView();
    });
  });
}

// ===== FLEET CHECKBOX =====
function setupFleetCheckbox() {
  document.getElementById('includeFleet').addEventListener('change', function() {
    generateDateNav();
    updateFilters();
    renderCurrentView();
  });
}

// ===== FILTERS =====
function updateFilters() {
  const container = document.getElementById('filterPills');
  let html = '';
  
  if (currentTab === 'service' || currentTab === 'fleet') {
    const jobs = currentTab === 'service' ? getServiceJobsForDate() : getFleetJobsForDate();
    const counts = {
      all: jobs.length,
      in_progress: jobs.filter(j => j.status === 'in_progress').length,
      waiting: jobs.filter(j => j.status === 'waiting').length,
      completed: jobs.filter(j => j.status === 'completed').length,
      urgent: jobs.filter(j => j.status === 'urgent').length
    };
    
    html = `
      <button class="filter-pill ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All <span class="count">${counts.all}</span></button>
      <button class="filter-pill ${currentFilter === 'in_progress' ? 'active' : ''}" data-filter="in_progress">Active <span class="count">${counts.in_progress}</span></button>
      <button class="filter-pill ${currentFilter === 'waiting' ? 'active' : ''}" data-filter="waiting">Waiting <span class="count">${counts.waiting}</span></button>
      <button class="filter-pill ${currentFilter === 'completed' ? 'active' : ''}" data-filter="completed">Done <span class="count">${counts.completed}</span></button>
    `;
  } else if (currentTab === 'sales') {
    const appts = getSalesAppointmentsForDate();
    const counts = {
      all: appts.length,
      confirmed: appts.filter(a => a.status === 'confirmed').length,
      scheduled: appts.filter(a => a.status === 'scheduled').length
    };
    
    html = `
      <button class="filter-pill ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All <span class="count">${counts.all}</span></button>
      <button class="filter-pill ${currentFilter === 'confirmed' ? 'active' : ''}" data-filter="confirmed">Confirmed <span class="count">${counts.confirmed}</span></button>
      <button class="filter-pill ${currentFilter === 'scheduled' ? 'active' : ''}" data-filter="scheduled">Pending <span class="count">${counts.scheduled}</span></button>
    `;
  }
  
  container.innerHTML = html;
  
  // Attach click handlers
  container.querySelectorAll('.filter-pill').forEach(pill => {
    pill.addEventListener('click', function() {
      currentFilter = this.dataset.filter;
      updateFilters();
      renderCurrentView();
    });
  });
}

// ===== DATA HELPERS =====
function getServiceJobsForDate() {
  let jobs = serviceJobs.filter(j => j.date === selectedDate);
  const includeFleet = document.getElementById('includeFleet')?.checked || false;
  if (includeFleet) {
    jobs = jobs.concat(fleetJobs.filter(j => j.date === selectedDate));
  }
  return jobs;
}

function getFleetJobsForDate() {
  return fleetJobs.filter(j => j.date === selectedDate);
}

function getSalesAppointmentsForDate() {
  return salesAppointments.filter(a => a.date === selectedDate);
}

// ===== RENDER =====
function renderCurrentView() {
  if (currentTab === 'service') {
    renderServiceLanes();
  } else if (currentTab === 'sales') {
    renderSalesList();
  } else if (currentTab === 'fleet') {
    renderFleetLanes();
  }
}

function renderServiceLanes() {
  const container = document.getElementById('serviceLanes');
  let jobs = getServiceJobsForDate();
  
  if (currentFilter !== 'all') {
    jobs = jobs.filter(j => j.status === currentFilter);
  }
  
  let html = '';
  
  technicians.forEach(tech => {
    const techJobs = jobs.filter(j => j.tech === tech.id);
    const hours = (techJobs.length * 1.5).toFixed(1);
    
    html += `
      <div class="tech-lane">
        <div class="lane-header">
          <div class="lane-info">
            <div class="tech-avatar ${tech.color}">${tech.initials}</div>
            <div class="tech-details">
              <h3>${tech.name}</h3>
              <span>${tech.role}${tech.bay ? ' ‚Ä¢ ' + tech.bay : ''}</span>
            </div>
          </div>
          <div class="lane-stats">
            <div class="stat-item"><div class="stat-value">${techJobs.length}</div><div class="stat-label">Jobs</div></div>
            <div class="stat-item"><div class="stat-value">${hours}h</div><div class="stat-label">Booked</div></div>
          </div>
        </div>
        <div class="lane-cards" data-tech="${tech.id}">
          ${techJobs.map(j => renderJobCard(j)).join('')}
          <div class="add-card" onclick="location.href='work-order-new.html'"><div class="add-card-icon">+</div><span>Add</span></div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">üîß</div><div class="empty-state-text">No jobs for this date</div></div>';
  setupDragDrop();
}

function renderFleetLanes() {
  const container = document.getElementById('fleetLanes');
  let jobs = getFleetJobsForDate();
  
  if (currentFilter !== 'all') {
    jobs = jobs.filter(j => j.status === currentFilter);
  }
  
  let html = '';
  
  technicians.forEach(tech => {
    const techJobs = jobs.filter(j => j.tech === tech.id);
    if (techJobs.length === 0 && tech.id !== 'unassigned') return;
    
    const hours = (techJobs.length * 2).toFixed(1);
    
    html += `
      <div class="tech-lane">
        <div class="lane-header">
          <div class="lane-info">
            <div class="tech-avatar ${tech.color}">${tech.initials}</div>
            <div class="tech-details">
              <h3>${tech.name}</h3>
              <span>${tech.role}${tech.bay ? ' ‚Ä¢ ' + tech.bay : ''}</span>
            </div>
          </div>
          <div class="lane-stats">
            <div class="stat-item"><div class="stat-value">${techJobs.length}</div><div class="stat-label">Jobs</div></div>
            <div class="stat-item"><div class="stat-value">${hours}h</div><div class="stat-label">Booked</div></div>
          </div>
        </div>
        <div class="lane-cards" data-tech="${tech.id}">
          ${techJobs.map(j => renderJobCard(j)).join('')}
          <div class="add-card" onclick="location.href='work-order-new.html?fleet=1'"><div class="add-card-icon">+</div><span>Add</span></div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">üöõ</div><div class="empty-state-text">No fleet jobs for this date</div></div>';
  setupDragDrop();
}

function renderJobCard(job) {
  const statusLabel = {
    'in_progress': 'Active',
    'waiting': 'Parts',
    'completed': 'Done',
    'urgent': 'Urgent',
    'scheduled': 'Scheduled',
    'confirmed': 'Confirmed'
  };
  
  return `
    <div class="wo-card status-${job.status} ${job.fleet ? 'fleet' : ''}" draggable="true" data-id="${job.id}" onclick="location.href='work-order-edit.html?id=${job.id}'">
      <div class="card-time">${job.time}</div>
      <div class="card-customer">${job.customer}</div>
      <div class="card-info-row">
        <span class="card-vehicle">${job.vehicle}</span>
        <span class="card-dot"></span>
        <span class="card-status ${job.status}">${statusLabel[job.status] || job.status}</span>
        <span class="card-amount">${job.amount}</span>
      </div>
    </div>
  `;
}

function renderSalesList() {
  const container = document.getElementById('salesList');
  let appts = getSalesAppointmentsForDate();
  
  if (currentFilter !== 'all') {
    appts = appts.filter(a => a.status === currentFilter);
  }
  
  if (appts.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><div class="empty-state-text">No appointments for this date</div></div>';
    return;
  }
  
  let html = '';
  appts.forEach(a => {
    html += `
      <div class="sales-card" onclick="location.href='appointment-edit.html?id=${a.id}'">
        <div class="sales-time">${a.time}</div>
        <div class="sales-customer">${a.customer}</div>
        <div class="sales-info">
          <span class="sales-type">${a.type}</span>
          <span>${a.vehicle}</span>
          <span>‚Ä¢</span>
          <span>${a.salesperson}</span>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// ===== DRAG & DROP =====
function setupDragDrop() {
  let dragged = null;
  
  document.querySelectorAll('.wo-card').forEach(card => {
    card.addEventListener('dragstart', function(e) {
      dragged = this;
      this.classList.add('dragging');
      e.stopPropagation();
    });
    
    card.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      document.querySelectorAll('.lane-cards').forEach(l => l.classList.remove('drop-active'));
      dragged = null;
    });
  });
  
  document.querySelectorAll('.lane-cards').forEach(lane => {
    lane.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('drop-active');
    });
    
    lane.addEventListener('dragleave', function() {
      this.classList.remove('drop-active');
    });
    
    lane.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('drop-active');
      if (dragged) {
        const addCard = this.querySelector('.add-card');
        if (addCard) {
          this.insertBefore(dragged, addCard);
        } else {
          this.appendChild(dragged);
        }
        const techName = technicians.find(t => t.id === this.dataset.tech)?.name || this.dataset.tech;
        showToast('Moved to ' + techName);
      }
    });
  });
  
  // Touch drag
  document.querySelectorAll('.wo-card').forEach(card => {
    let longPressTimer, isDragging = false, ghost = null, startPos = {x:0, y:0};
    
    card.addEventListener('touchstart', function(e) {
      startPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      
      longPressTimer = setTimeout(() => {
        isDragging = true;
        this.classList.add('dragging');
        if (navigator.vibrate) navigator.vibrate(50);
        
        ghost = this.cloneNode(true);
        ghost.style.cssText = `position:fixed;pointer-events:none;z-index:1000;width:${this.offsetWidth}px;opacity:0.9;transform:rotate(2deg);box-shadow:0 8px 32px rgba(0,0,0,0.3);`;
        document.body.appendChild(ghost);
      }, 400);
    });
    
    card.addEventListener('touchmove', function(e) {
      if (!isDragging) {
        if (Math.abs(e.touches[0].clientY - startPos.y) > 10 || Math.abs(e.touches[0].clientX - startPos.x) > 10) {
          clearTimeout(longPressTimer);
        }
        return;
      }
      
      e.preventDefault();
      const touch = e.touches[0];
      
      if (ghost) {
        ghost.style.left = (touch.clientX - 110) + 'px';
        ghost.style.top = (touch.clientY - 35) + 'px';
      }
      
      document.querySelectorAll('.lane-cards').forEach(lane => {
        const rect = lane.getBoundingClientRect();
        lane.classList.toggle('drop-active', touch.clientY >= rect.top && touch.clientY <= rect.bottom);
      });
    });
    
    card.addEventListener('touchend', function() {
      clearTimeout(longPressTimer);
      
      if (isDragging) {
        const activeLane = document.querySelector('.lane-cards.drop-active');
        if (activeLane) {
          const addCard = activeLane.querySelector('.add-card');
          if (addCard) {
            activeLane.insertBefore(this, addCard);
          } else {
            activeLane.appendChild(this);
          }
          const techName = technicians.find(t => t.id === activeLane.dataset.tech)?.name || activeLane.dataset.tech;
          showToast('Moved to ' + techName);
        }
        
        this.classList.remove('dragging');
        if (ghost) ghost.remove();
        ghost = null;
        isDragging = false;
      }
      
      document.querySelectorAll('.lane-cards').forEach(l => l.classList.remove('drop-active'));
    });
  });
}

// ===== TOAST =====
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ===== INIT =====
function init() {
  setupMainTabs();
  setupViewToggle();
  setupFleetCheckbox();
  generateDateNav();
  updateFilters();
  renderCurrentView();
}

init();
</script>
</body>
</html>
