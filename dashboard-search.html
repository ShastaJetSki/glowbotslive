<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Search</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="theme-system.css">
  <style>
    /* ===== INLINE THEME DEFINITIONS ===== */
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8;
    }
    [data-theme="charcoal"] {
      --bg-primary: #121214; --bg-secondary: #18181b; --bg-card: #27272a; --bg-hover: #3f3f46;
      --border-default: #3f3f46; --text-primary: #fafafa; --text-secondary: #a1a1aa;
      --accent-primary: #a1a1aa; --accent-light: #d4d4d8;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80;
    }
    [data-theme="obsidian"] {
      --bg-primary: #050505; --bg-secondary: #0a0a0a; --bg-card: #141414; --bg-hover: #1c1c1c;
      --border-default: #252525; --text-primary: #e0e0e0; --text-secondary: #888888;
      --accent-primary: #0ea5e9; --accent-light: #38bdf8;
    }
    [data-theme="steel"] {
      --bg-primary: #0c0f13; --bg-secondary: #12161c; --bg-card: #1a2028; --bg-hover: #242c38;
      --border-default: #2c3644; --text-primary: #e4e8ed; --text-secondary: #8b95a5;
      --accent-primary: #64748b; --accent-light: #94a3b8;
    }
    [data-theme="espresso"] {
      --bg-primary: #0f0c0a; --bg-secondary: #161210; --bg-card: #211c18; --bg-hover: #2c2520;
      --border-default: #382f28; --text-primary: #f0ebe5; --text-secondary: #a89e94;
      --accent-primary: #a78b6e; --accent-light: #c4a88a;
    }
    [data-theme="onyx"] {
      --bg-primary: #000000; --bg-secondary: #080808; --bg-card: #121212; --bg-hover: #1a1a1a;
      --border-default: #222222; --text-primary: #f5f5f5; --text-secondary: #8c8c8c;
      --accent-primary: #06b6d4; --accent-light: #22d3ee;
    }
    /* ===== END THEME DEFINITIONS ===== */

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); }

    /* ===== MOBILE TOP HEADER ===== */
    .mobile-top-header {
      display: none; position: sticky; top: 0; z-index: 100;
      background: var(--bg-secondary); border-bottom: 1px solid var(--border-default);
    }
    .mobile-header-bar {
      display: flex; justify-content: space-between; align-items: center; padding: 12px;
    }
    .mobile-menu-toggle {
      background: transparent; border: none; color: var(--text-secondary);
      font-size: 20px; width: 36px; height: 36px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .mobile-header-center { flex: 1; margin-left: 12px; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-primary); }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px 12px 12px;
      background: var(--bg-primary); border-top: 1px solid var(--border-default);
    }
    .mobile-header-actions button {
      padding: 10px; font-size: 13px; background: var(--bg-card);
      border: 1px solid var(--accent-primary); color: var(--text-primary);
      border-radius: 8px; cursor: pointer;
    }
    .accordion-icon-header { transition: transform 0.2s ease; }
    .mobile-menu-toggle.active .accordion-icon-header { transform: rotate(180deg); }

    /* ===== DESKTOP HEADER ===== */
    .desktop-header {
      position: sticky; top: 0; z-index: 100;
      background: var(--bg-primary); border-bottom: 1px solid var(--border-default);
    }

    /* ===== MOBILE BOTTOM NAV ===== */
    .mobile-bottom-nav {
      display: none; position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--bg-secondary); padding: 8px; z-index: 100;
    }
    .mobile-nav-top {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 6px;
    }
    .mobile-nav-secondary {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
    }
    .mobile-nav-btn {
      padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default);
      background: var(--bg-card); color: var(--text-secondary); font-size: 12px;
      font-weight: 600; cursor: pointer; text-decoration: none;
      display: flex; align-items: center; justify-content: center; min-height: 44px;
    }
    .mobile-nav-top .mobile-nav-btn { background: var(--bg-hover); }
    .mobile-nav-btn.active {
      background: var(--accent-primary); border-color: var(--accent-primary); color: white;
    }

    /* ===== MAIN CONTENT ===== */
    .main { display: flex; flex-direction: column; min-height: 100vh; }
    .content { flex: 1; padding: 20px; max-width: 1400px; margin: 0 auto; width: 100%; }

    /* ===== SEARCH BAR ===== */
    .search-section { margin-bottom: 24px; }
    .search-bar-container {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    }
    .search-input-wrapper {
      flex: 1; min-width: 280px; position: relative;
    }
    .search-input {
      width: 100%; padding: 14px 16px 14px 48px; font-size: 16px;
      background: var(--bg-card); border: 2px solid var(--border-default);
      border-radius: 12px; color: var(--text-primary); transition: border-color 0.2s;
    }
    .search-input:focus {
      outline: none; border-color: var(--accent-primary);
    }
    .search-input::placeholder { color: var(--text-secondary); }
    .search-icon {
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      color: var(--text-secondary); pointer-events: none;
    }
    .search-btn {
      padding: 14px 28px; background: var(--accent-primary); color: white;
      border: none; border-radius: 12px; font-size: 15px; font-weight: 600;
      cursor: pointer; transition: opacity 0.2s;
    }
    .search-btn:hover { opacity: 0.9; }

    /* ===== DEPARTMENT TABS ===== */
    .dept-tabs {
      display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto;
      padding-bottom: 4px;
    }
    .dept-tab {
      padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border-default);
      border-radius: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 600;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    .dept-tab:hover { background: var(--bg-hover); }
    .dept-tab.active {
      background: var(--accent-primary); border-color: var(--accent-primary); color: white;
    }

    /* ===== CATEGORY CARDS ===== */
    .categories-section { margin-bottom: 32px; }
    .section-title {
      font-size: 18px; font-weight: 600; color: var(--accent-light);
      margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
    }
    .category-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;
    }
    .category-card {
      background: var(--bg-card); border: 1px solid var(--border-default);
      border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s;
      display: flex; flex-direction: column; align-items: center; text-align: center;
    }
    .category-card:hover {
      background: var(--bg-hover); border-color: var(--accent-primary); transform: translateY(-2px);
    }
    .category-card.active {
      background: var(--bg-hover); border-color: var(--accent-primary);
    }
    .category-icon {
      width: 48px; height: 48px; border-radius: 12px; background: var(--bg-secondary);
      display: flex; align-items: center; justify-content: center; margin-bottom: 12px;
      color: var(--accent-light);
    }
    .category-icon svg { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
    .category-name { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
    .category-desc { font-size: 11px; color: var(--text-secondary); }

    /* ===== RESULTS SECTION ===== */
    .results-section { display: none; }
    .results-section.active { display: block; }
    .results-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px; flex-wrap: wrap; gap: 12px;
    }
    .results-count { font-size: 14px; color: var(--text-secondary); }
    .results-filters {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .filter-select {
      padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-default);
      border-radius: 6px; color: var(--text-primary); font-size: 13px;
    }

    /* ===== RESULT CARDS ===== */
    .results-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;
    }
    .result-card {
      background: var(--bg-card); border-radius: 12px; padding: 16px;
      border-left: 4px solid var(--accent-primary); cursor: pointer; transition: all 0.2s;
    }
    .result-card:hover { background: var(--bg-hover); }
    .result-card.type-customer { border-left-color: #3b82f6; }
    .result-card.type-vehicle { border-left-color: #8b5cf6; }
    .result-card.type-workorder { border-left-color: #10b981; }
    .result-card.type-parts { border-left-color: #f59e0b; }
    .result-card.type-sales { border-left-color: #ec4899; }
    .result-card.type-invoice { border-left-color: #06b6d4; }

    .result-card-header {
      display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
    }
    .result-card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .result-card-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .result-card-badge {
      padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
      text-transform: uppercase; background: var(--bg-secondary); color: var(--text-secondary);
    }
    .result-card-badge.customer { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .result-card-badge.vehicle { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .result-card-badge.workorder { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .result-card-badge.parts { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .result-card-badge.sales { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
    .result-card-badge.invoice { background: rgba(6, 182, 212, 0.2); color: #22d3ee; }

    .result-card-details {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
    }
    .result-detail { font-size: 13px; }
    .result-detail-label { color: var(--text-secondary); }
    .result-detail-value { color: var(--text-primary); font-weight: 500; }

    .result-card-actions {
      display: flex; gap: 8px; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid var(--border-default);
    }
    .result-action-btn {
      flex: 1; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; text-align: center; text-decoration: none;
    }
    .result-action-btn.primary {
      background: var(--accent-primary); color: white; border: none;
    }
    .result-action-btn.secondary {
      background: transparent; color: var(--text-secondary);
      border: 1px solid var(--border-default);
    }
    .result-action-btn:hover { opacity: 0.85; }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-secondary);
    }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
    .empty-state-desc { font-size: 14px; }

    /* ===== RECENT SEARCHES ===== */
    .recent-section { margin-top: 32px; }
    .recent-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .recent-item {
      padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border-default);
      border-radius: 20px; font-size: 13px; color: var(--text-secondary); cursor: pointer;
      transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .recent-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .recent-item svg { width: 14px; height: 14px; }

    /* ===== LOADING ===== */
    .loading-spinner {
      display: none; justify-content: center; padding: 40px;
    }
    .loading-spinner.active { display: flex; }
    .spinner {
      width: 40px; height: 40px; border: 3px solid var(--border-default);
      border-top-color: var(--accent-primary); border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      body { padding-bottom: 120px; }
      .content { padding: 12px; }
      .search-bar-container { flex-direction: column; }
      .search-input-wrapper { min-width: 100%; }
      .search-btn { width: 100%; }
      .category-grid { grid-template-columns: repeat(2, 1fr); }
      .results-grid { grid-template-columns: 1fr; }
      .result-card-details { grid-template-columns: 1fr; }
    }

    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
    }
  </style>
</head>
<body>

<!-- Mobile Top Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">
      <span class="accordion-icon-header">‚ò∞</span>
    </button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Search</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='dashboard-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
    </div>
  </div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:32px; font-weight:600;">Search</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px;">
      <a href="dashboard-business.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Business</a>
      <a href="dashboard-search.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Search</a>
      <a href="dashboard-settings.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Settings</a>
    </nav>
  </div>
  <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
    <div style="display:flex; gap:12px; justify-content:flex-end;">
      <button onclick="location.href='dashboard-service.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer; font-size:14px;">Service</button>
      <button onclick="location.href='dashboard-parts.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer; font-size:14px;">Parts</button>
      <button onclick="location.href='dashboard-sales.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer; font-size:14px;">Sales</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="content">
    
    <!-- Search Bar -->
    <div class="search-section">
      <div class="search-bar-container">
        <div class="search-input-wrapper">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" class="search-input" id="mainSearchInput" placeholder="Search customers, vehicles, work orders, inventory..." oninput="handleSearchInput()" onkeypress="if(event.key==='Enter')performSearch()">
        </div>
        <button class="search-btn" onclick="performSearch()">Search</button>
      </div>
    </div>

    <!-- Department Tabs -->
    <div class="dept-tabs">
      <button class="dept-tab active" data-dept="all" onclick="setDepartment('all', this)">All Departments</button>
      <button class="dept-tab" data-dept="service" onclick="setDepartment('service', this)">Service</button>
      <button class="dept-tab" data-dept="parts" onclick="setDepartment('parts', this)">Parts</button>
      <button class="dept-tab" data-dept="sales" onclick="setDepartment('sales', this)">Sales</button>
    </div>

    <!-- Categories Section -->
    <div class="categories-section" id="categoriesSection">
      <div class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Search Categories
      </div>
      
      <div class="category-grid" id="categoryGrid">
        <!-- Customers -->
        <div class="category-card" data-category="customers" onclick="selectCategory('customers')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          </div>
          <div class="category-name">Customers</div>
          <div class="category-desc">Search by name, phone, email</div>
        </div>

        <!-- Vehicles -->
        <div class="category-card" data-category="vehicles" onclick="selectCategory('vehicles')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10l-3-5H9L6 10l-2.5 1.1C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2"></path><circle cx="7" cy="17" r="2"></circle><circle cx="17" cy="17" r="2"></circle></svg>
          </div>
          <div class="category-name">Vehicles</div>
          <div class="category-desc">VIN, plate, year/make/model</div>
        </div>

        <!-- Work Orders -->
        <div class="category-card" data-category="workorders" data-dept="service" onclick="selectCategory('workorders')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
          </div>
          <div class="category-name">Work Orders</div>
          <div class="category-desc">Service history & repairs</div>
        </div>

        <!-- Parts Inventory -->
        <div class="category-card" data-category="parts" data-dept="parts" onclick="selectCategory('parts')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
          </div>
          <div class="category-name">Parts Inventory</div>
          <div class="category-desc">Part numbers & stock</div>
        </div>

        <!-- Sales Inventory -->
        <div class="category-card" data-category="salesinventory" data-dept="sales" onclick="selectCategory('salesinventory')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
          </div>
          <div class="category-name">Sales Inventory</div>
          <div class="category-desc">Vehicles for sale</div>
        </div>

        <!-- Sales Deals -->
        <div class="category-card" data-category="deals" data-dept="sales" onclick="selectCategory('deals')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          </div>
          <div class="category-name">Sales Deals</div>
          <div class="category-desc">Contracts & transactions</div>
        </div>

        <!-- Sales Appointments -->
        <div class="category-card" data-category="salesappts" data-dept="sales" onclick="selectCategory('salesappts')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          </div>
          <div class="category-name">Sales Appointments</div>
          <div class="category-desc">Test drives & meetings</div>
        </div>

        <!-- Service Appointments -->
        <div class="category-card" data-category="serviceappts" data-dept="service" onclick="selectCategory('serviceappts')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          </div>
          <div class="category-name">Service Appointments</div>
          <div class="category-desc">Scheduled services</div>
        </div>

        <!-- Invoices -->
        <div class="category-card" data-category="invoices" onclick="selectCategory('invoices')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
          </div>
          <div class="category-name">Invoices</div>
          <div class="category-desc">Billing & payments</div>
        </div>

        <!-- Estimates -->
        <div class="category-card" data-category="estimates" data-dept="service" onclick="selectCategory('estimates')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
          </div>
          <div class="category-name">Estimates</div>
          <div class="category-desc">Quotes & proposals</div>
        </div>

        <!-- Vendors -->
        <div class="category-card" data-category="vendors" data-dept="parts" onclick="selectCategory('vendors')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          </div>
          <div class="category-name">Vendors</div>
          <div class="category-desc">Suppliers & contacts</div>
        </div>

        <!-- Fleets -->
        <div class="category-card" data-category="fleets" data-dept="service" onclick="selectCategory('fleets')">
          <div class="category-icon">
            <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
          </div>
          <div class="category-name">Fleets</div>
          <div class="category-desc">Fleet accounts</div>
        </div>
      </div>
    </div>

    <!-- Recent Searches -->
    <div class="recent-section" id="recentSection">
      <div class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Recent Searches
      </div>
      <div class="recent-list" id="recentList">
        <!-- Populated dynamically -->
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner"></div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <div class="results-count" id="resultsCount">0 results found</div>
        <div class="results-filters">
          <select class="filter-select" id="sortFilter" onchange="sortResults()">
            <option value="relevance">Most Relevant</option>
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="name">Name A-Z</option>
          </select>
        </div>
      </div>
      <div class="results-grid" id="resultsGrid">
        <!-- Results populated dynamically -->
      </div>
      <div class="empty-state" id="emptyState" style="display:none;">
        <div class="empty-state-icon">üîç</div>
        <div class="empty-state-title">No results found</div>
        <div class="empty-state-desc">Try adjusting your search terms or filters</div>
      </div>
    </div>

  </div>
</div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
    <a href="dashboard-search.html" class="mobile-nav-btn active">Search</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentDepartment = 'all';
let currentCategory = null;
let searchResults = [];
let tenantId = null;

// Theme support
function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

function toggleMobileMenu(button) {
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
  button.classList.toggle('active');
}

function logout() {
  localStorage.removeItem('sb_access_token');
  localStorage.removeItem('sb_refresh_token');
  Object.keys(localStorage).forEach(key => { if (key.startsWith('sb-')) localStorage.removeItem(key); });
  window.location.href = 'login.html?logout=1';
}

async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refreshToken = localStorage.getItem('sb_refresh_token');
    if (token && refreshToken) {
      const { data, error } = await sb.auth.setSession({ access_token: token, refresh_token: refreshToken });
      if (error || !data.session) { window.location.href = 'login.html'; return null; }
      return data.session;
    }
    window.location.href = 'login.html';
    return null;
  }
  return session;
}

async function loadBusinessSettings() {
  const { data } = await sb.from('business_settings').select('*').single();
  if (data) {
    tenantId = data.tenant_id;
    const name = data.business_name || data.company_name || 'My Business';
    document.getElementById('desktopBusinessName').textContent = name;
    document.getElementById('mobileBusinessName').textContent = name;
  }
}

// Department filtering
function setDepartment(dept, btn) {
  currentDepartment = dept;
  document.querySelectorAll('.dept-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  filterCategories();
}

function filterCategories() {
  const cards = document.querySelectorAll('.category-card');
  cards.forEach(card => {
    const cardDept = card.dataset.dept;
    if (currentDepartment === 'all' || !cardDept || cardDept === currentDepartment) {
      card.style.display = 'flex';
    } else {
      card.style.display = 'none';
    }
  });
}

// Category selection
function selectCategory(category) {
  currentCategory = category;
  document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
  document.querySelector(`[data-category="${category}"]`)?.classList.add('active');
  
  // Update placeholder based on category
  const placeholders = {
    customers: 'Search by name, phone, or email...',
    vehicles: 'Search by VIN, plate, or year/make/model...',
    workorders: 'Search by WO#, customer, or vehicle...',
    parts: 'Search by part number, name, or description...',
    salesinventory: 'Search by stock#, VIN, or year/make/model...',
    deals: 'Search by deal#, customer, or vehicle...',
    salesappts: 'Search by customer or date...',
    serviceappts: 'Search by customer, vehicle, or date...',
    invoices: 'Search by invoice#, customer, or amount...',
    estimates: 'Search by estimate#, customer, or vehicle...',
    vendors: 'Search by vendor name or contact...',
    fleets: 'Search by fleet name or account...'
  };
  document.getElementById('mainSearchInput').placeholder = placeholders[category] || 'Search...';
  document.getElementById('mainSearchInput').focus();
}

// Search handling
function handleSearchInput() {
  const query = document.getElementById('mainSearchInput').value;
  if (query.length === 0) {
    document.getElementById('resultsSection').classList.remove('active');
    document.getElementById('categoriesSection').style.display = 'block';
    document.getElementById('recentSection').style.display = 'block';
  }
}

async function performSearch() {
  const query = document.getElementById('mainSearchInput').value.trim();
  if (!query) return;

  // Save to recent searches
  saveRecentSearch(query);

  // Show loading
  document.getElementById('loadingSpinner').classList.add('active');
  document.getElementById('categoriesSection').style.display = 'none';
  document.getElementById('recentSection').style.display = 'none';
  document.getElementById('resultsSection').classList.remove('active');

  searchResults = [];

  try {
    // Search based on category or all
    if (!currentCategory || currentCategory === 'all') {
      await Promise.all([
        searchCustomers(query),
        searchVehicles(query),
        searchWorkOrders(query),
        searchParts(query),
        searchSalesInventory(query),
        searchDeals(query),
        searchInvoices(query),
        searchFleets(query)
      ]);
    } else {
      switch (currentCategory) {
        case 'customers': await searchCustomers(query); break;
        case 'vehicles': await searchVehicles(query); break;
        case 'workorders': await searchWorkOrders(query); break;
        case 'parts': await searchParts(query); break;
        case 'salesinventory': await searchSalesInventory(query); break;
        case 'deals': await searchDeals(query); break;
        case 'salesappts': await searchSalesAppointments(query); break;
        case 'serviceappts': await searchServiceAppointments(query); break;
        case 'invoices': await searchInvoices(query); break;
        case 'estimates': await searchEstimates(query); break;
        case 'vendors': await searchVendors(query); break;
        case 'fleets': await searchFleets(query); break;
      }
    }
  } catch (error) {
    console.error('Search error:', error);
  }

  // Hide loading, show results
  document.getElementById('loadingSpinner').classList.remove('active');
  document.getElementById('resultsSection').classList.add('active');
  renderResults();
}

// Search functions
async function searchCustomers(query) {
  const { data } = await sb.from('customers').select('*')
    .or(`first_name.ilike.%${query}%,last_name.ilike.%${query}%,email.ilike.%${query}%,phone.ilike.%${query}%,company_name.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(c => ({
      type: 'customer',
      id: c.customer_id,
      title: `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.company_name || 'Unknown',
      subtitle: c.email || c.phone || '',
      details: { Phone: c.phone || '-', Email: c.email || '-', Company: c.company_name || '-' },
      link: `customer-detail.html?id=${c.customer_id}`,
      created: c.created_at
    })));
  }
}

async function searchVehicles(query) {
  const { data } = await sb.from('vehicles').select('*, customers(first_name, last_name)')
    .or(`vin.ilike.%${query}%,license_plate.ilike.%${query}%,make.ilike.%${query}%,model.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(v => ({
      type: 'vehicle',
      id: v.vehicle_id,
      title: `${v.year || ''} ${v.make || ''} ${v.model || ''}`.trim(),
      subtitle: v.vin || v.license_plate || '',
      details: { VIN: v.vin || '-', Plate: v.license_plate || '-', Owner: v.customers ? `${v.customers.first_name} ${v.customers.last_name}` : '-' },
      link: `vehicle-detail.html?id=${v.vehicle_id}`,
      created: v.created_at
    })));
  }
}

async function searchWorkOrders(query) {
  const { data } = await sb.from('work_orders').select('*, customers(first_name, last_name), vehicles(year, make, model)')
    .or(`work_order_number.ilike.%${query}%,description.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(wo => ({
      type: 'workorder',
      id: wo.work_order_id,
      title: `WO# ${wo.work_order_number || wo.work_order_id?.slice(0,8)}`,
      subtitle: wo.customers ? `${wo.customers.first_name} ${wo.customers.last_name}` : 'No customer',
      details: { 
        Status: wo.status || '-', 
        Vehicle: wo.vehicles ? `${wo.vehicles.year} ${wo.vehicles.make} ${wo.vehicles.model}` : '-',
        Total: wo.total_amount ? `$${parseFloat(wo.total_amount).toLocaleString()}` : '-'
      },
      link: `work-order-edit.html?id=${wo.work_order_id}`,
      created: wo.created_at
    })));
  }
}

async function searchParts(query) {
  const { data } = await sb.from('parts_inventory').select('*')
    .or(`part_number.ilike.%${query}%,part_name.ilike.%${query}%,description.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(p => ({
      type: 'parts',
      id: p.part_id,
      title: p.part_name || p.part_number,
      subtitle: `Part# ${p.part_number || '-'}`,
      details: { 'In Stock': p.quantity_on_hand || 0, Cost: p.unit_cost ? `$${parseFloat(p.unit_cost).toFixed(2)}` : '-', Location: p.bin_location || '-' },
      link: `parts-detail.html?id=${p.part_id}`,
      created: p.created_at
    })));
  }
}

async function searchSalesInventory(query) {
  const { data } = await sb.from('sales_inventory').select('*')
    .or(`stock_number.ilike.%${query}%,vin.ilike.%${query}%,make.ilike.%${query}%,model.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(i => ({
      type: 'sales',
      id: i.inventory_id,
      title: `${i.year || ''} ${i.make || ''} ${i.model || ''}`.trim(),
      subtitle: `Stock# ${i.stock_number || '-'}`,
      details: { Price: i.asking_price ? `$${parseFloat(i.asking_price).toLocaleString()}` : '-', Status: i.status || '-', Miles: i.mileage?.toLocaleString() || '-' },
      link: `sales-inventory-detail.html?id=${i.inventory_id}`,
      created: i.created_at
    })));
  }
}

async function searchDeals(query) {
  const { data } = await sb.from('deals').select('*, customers(first_name, last_name)')
    .or(`deal_number.ilike.%${query}%,description.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(d => ({
      type: 'sales',
      id: d.deal_id,
      title: `Deal# ${d.deal_number || d.deal_id?.slice(0,8)}`,
      subtitle: d.customers ? `${d.customers.first_name} ${d.customers.last_name}` : 'No customer',
      details: { Status: d.status || '-', Value: d.deal_value ? `$${parseFloat(d.deal_value).toLocaleString()}` : '-', Stage: d.stage || '-' },
      link: `deal-detail.html?id=${d.deal_id}`,
      created: d.created_at
    })));
  }
}

async function searchSalesAppointments(query) {
  const { data } = await sb.from('sales_appointments').select('*')
    .or(`customer_name.ilike.%${query}%,customer_phone.ilike.%${query}%,vehicle_interest.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(a => ({
      type: 'sales',
      id: a.appointment_id,
      title: a.customer_name || 'Unknown',
      subtitle: a.appointment_type || 'Appointment',
      details: { Date: a.appointment_date || '-', Time: a.appointment_time || '-', Status: a.status || '-' },
      link: `sales-appointment-detail.html?id=${a.appointment_id}`,
      created: a.created_at
    })));
  }
}

async function searchServiceAppointments(query) {
  const { data } = await sb.from('appointments').select('*, customers(first_name, last_name)')
    .or(`notes.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(a => ({
      type: 'workorder',
      id: a.appointment_id,
      title: a.customers ? `${a.customers.first_name} ${a.customers.last_name}` : 'Unknown',
      subtitle: a.appointment_type || 'Service Appointment',
      details: { Date: a.appointment_date || '-', Time: a.start_time || '-', Status: a.status || '-' },
      link: `appointment-detail.html?id=${a.appointment_id}`,
      created: a.created_at
    })));
  }
}

async function searchInvoices(query) {
  const { data } = await sb.from('invoices').select('*, customers(first_name, last_name)')
    .or(`invoice_number.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(i => ({
      type: 'invoice',
      id: i.invoice_id,
      title: `Invoice# ${i.invoice_number || i.invoice_id?.slice(0,8)}`,
      subtitle: i.customers ? `${i.customers.first_name} ${i.customers.last_name}` : 'No customer',
      details: { Amount: i.total_amount ? `$${parseFloat(i.total_amount).toLocaleString()}` : '-', Status: i.status || '-', Date: i.invoice_date || '-' },
      link: `invoice-detail.html?id=${i.invoice_id}`,
      created: i.created_at
    })));
  }
}

async function searchEstimates(query) {
  const { data } = await sb.from('estimates').select('*, customers(first_name, last_name)')
    .or(`estimate_number.ilike.%${query}%,description.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(e => ({
      type: 'workorder',
      id: e.estimate_id,
      title: `Estimate# ${e.estimate_number || e.estimate_id?.slice(0,8)}`,
      subtitle: e.customers ? `${e.customers.first_name} ${e.customers.last_name}` : 'No customer',
      details: { Amount: e.total_amount ? `$${parseFloat(e.total_amount).toLocaleString()}` : '-', Status: e.status || '-' },
      link: `estimate-detail.html?id=${e.estimate_id}`,
      created: e.created_at
    })));
  }
}

async function searchVendors(query) {
  const { data } = await sb.from('vendors').select('*')
    .or(`vendor_name.ilike.%${query}%,contact_name.ilike.%${query}%,email.ilike.%${query}%`)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(v => ({
      type: 'parts',
      id: v.vendor_id,
      title: v.vendor_name || 'Unknown Vendor',
      subtitle: v.contact_name || '',
      details: { Phone: v.phone || '-', Email: v.email || '-' },
      link: `vendor-detail.html?id=${v.vendor_id}`,
      created: v.created_at
    })));
  }
}

async function searchFleets(query) {
  const { data } = await sb.from('fleets').select('*')
    .or(`fleet_name.ilike.%${query}%,description.ilike.%${query}%`)
    .eq('deleted', false)
    .limit(20);
  if (data) {
    searchResults.push(...data.map(f => ({
      type: 'customer',
      id: f.fleet_id,
      title: f.fleet_name || 'Unknown Fleet',
      subtitle: f.description || 'Fleet Account',
      details: { Vehicles: f.vehicle_count || 0 },
      link: `fleet-account-details.html?id=${f.fleet_id}`,
      created: f.created_at
    })));
  }
}

// Render results
function renderResults() {
  const grid = document.getElementById('resultsGrid');
  const countEl = document.getElementById('resultsCount');
  const emptyEl = document.getElementById('emptyState');

  countEl.textContent = `${searchResults.length} result${searchResults.length !== 1 ? 's' : ''} found`;

  if (searchResults.length === 0) {
    grid.innerHTML = '';
    emptyEl.style.display = 'block';
    return;
  }

  emptyEl.style.display = 'none';
  grid.innerHTML = searchResults.map(r => `
    <div class="result-card type-${r.type}" onclick="window.location.href='${r.link}'">
      <div class="result-card-header">
        <div>
          <div class="result-card-title">${r.title}</div>
          <div class="result-card-subtitle">${r.subtitle}</div>
        </div>
        <span class="result-card-badge ${r.type}">${r.type}</span>
      </div>
      <div class="result-card-details">
        ${Object.entries(r.details).map(([k, v]) => `
          <div class="result-detail">
            <span class="result-detail-label">${k}: </span>
            <span class="result-detail-value">${v}</span>
          </div>
        `).join('')}
      </div>
      <div class="result-card-actions">
        <a href="${r.link}" class="result-action-btn primary">View Details</a>
      </div>
    </div>
  `).join('');
}

// Sort results
function sortResults() {
  const sortBy = document.getElementById('sortFilter').value;
  switch (sortBy) {
    case 'newest':
      searchResults.sort((a, b) => new Date(b.created) - new Date(a.created));
      break;
    case 'oldest':
      searchResults.sort((a, b) => new Date(a.created) - new Date(b.created));
      break;
    case 'name':
      searchResults.sort((a, b) => a.title.localeCompare(b.title));
      break;
  }
  renderResults();
}

// Recent searches
function saveRecentSearch(query) {
  let recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
  recent = recent.filter(s => s !== query);
  recent.unshift(query);
  recent = recent.slice(0, 10);
  localStorage.setItem('recentSearches', JSON.stringify(recent));
  renderRecentSearches();
}

function renderRecentSearches() {
  const container = document.getElementById('recentList');
  const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
  
  if (recent.length === 0) {
    container.innerHTML = '<div style="color:var(--text-secondary); font-size:13px;">No recent searches</div>';
    return;
  }
  
  container.innerHTML = recent.map(s => `
    <div class="recent-item" onclick="document.getElementById('mainSearchInput').value='${s}'; performSearch();">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      ${s}
    </div>
  `).join('');
}

// Initialize
async function init() {
  const session = await checkAuth();
  if (!session) return;
  
  await loadBusinessSettings();
  renderRecentSearches();
  
  // Check for URL params
  const params = new URLSearchParams(window.location.search);
  const q = params.get('q');
  const cat = params.get('category');
  
  if (cat) {
    selectCategory(cat);
  }
  
  if (q) {
    document.getElementById('mainSearchInput').value = q;
    performSearch();
  }
}

init();
</script>
</body>
</html>
