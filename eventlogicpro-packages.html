<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Packages — Event Logic Pro</title>
  <link rel="icon" href="favicon-eventlogic.ico">
  <link rel="icon" type="image/png" href="favicon-eventlogic-32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="favicon-eventlogic-192.png">
  <meta name="apple-mobile-web-app-title" content="Event Logic Pro">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg-primary:#f4f5f7;--bg-secondary:#ebedf1;--bg-card:#ffffff;--bg-hover:#f0f0f3;
  --border:#e2e4e8;--text-primary:#1a1a1a;--text-secondary:#6b7280;
  --accent:#DC2626;--accent-hover:#B91C1C;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.10);--accent-glow2:rgba(220,38,38,.06);
  --shadow:0 2px 12px rgba(0,0,0,.06);--input-bg:#fafafa;--modal-overlay:rgba(0,0,0,.45);
}
body.dark{
  --bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#222;--bg-hover:#2a2a2a;
  --border:#333;--text-primary:#f0f0f0;--text-secondary:#999;
  --accent:#DC2626;--accent-hover:#EF4444;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.15);--accent-glow2:rgba(220,38,38,.08);
  --shadow:0 2px 12px rgba(0,0,0,.3);--input-bg:#1a1a1a;--modal-overlay:rgba(0,0,0,.75);
}
html{scrollbar-gutter:stable;background:var(--bg-primary);}
html.dark{background:#111;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden;}

/* ===== HEADER (canonical layout) ===== */
.desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border);}
.header-top{padding:10px 24px;display:flex;justify-content:space-between;align-items:center;}
.header-left{display:flex;align-items:center;gap:20px;}
.header-titles h1{font-size:28px;font-weight:700;letter-spacing:-.3px;}
.header-titles .sub{font-size:12px;color:var(--accent);font-weight:600;letter-spacing:.3px;}
.header-logo{height:72px;object-fit:contain;}
.nav-bar{display:flex;justify-content:space-between;align-items:center;padding:0 24px;margin-top:-4px;}
.nav-left{display:flex;gap:2px;}
.nav-right-controls{display:flex;align-items:center;gap:12px;margin-right:58px;}
.nav-right-controls .settings-link,.nav-right-controls .logout-link{font-size:13px;font-weight:600;}
.nav-btn{padding:8px 18px;font-size:13px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;}
.nav-btn:hover{color:var(--accent);}
.nav-btn.active{color:var(--accent);border-bottom-color:var(--accent);}
.dark-toggle{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.dark-toggle:hover{border-color:var(--accent);color:var(--accent);}
.dark-toggle svg{width:14px;height:14px;fill:currentColor;}
.logout-link{color:var(--text-secondary);cursor:pointer;font-size:12px;text-decoration:none;transition:color .2s;font-weight:500;}.logout-link:hover{color:var(--accent);}
.settings-link{color:var(--text-secondary);cursor:pointer;font-size:12px;text-decoration:none;transition:color .2s;font-weight:500;}.settings-link:hover{color:var(--accent);}

/* ===== MOBILE HEADER (matches contacts) ===== */
.mobile-top-header{display:none;position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border);}
.m-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;}
.m-menu-btn{background:transparent;border:none;color:var(--text-secondary);font-size:20px;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.m-center{flex:1;}.m-title{font-size:18px;font-weight:600;}.m-biz{font-size:12px;color:var(--accent);font-weight:600;}
.m-right{display:flex;align-items:center;gap:10px;}
.m-menu{max-height:0;overflow:hidden;transition:max-height .3s;background:var(--bg-primary);border-top:1px solid var(--border);}
.m-menu.expanded{max-height:200px;}
.m-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:8px 12px 12px;}
.m-actions button{padding:10px;font-size:13px;background:var(--accent-glow);border:1px solid rgba(220,38,38,.25);color:var(--accent);border-radius:8px;cursor:pointer;}
.mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);padding:8px 8px calc(8px + env(safe-area-inset-bottom));z-index:200;}
.m-nav-top,.m-nav-bot{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;}
.m-nav-bot{grid-template-columns:repeat(3,1fr);margin-top:4px;}
.m-nav-btn{text-align:center;padding:8px 4px;font-size:11px;font-weight:600;color:var(--text-secondary);text-decoration:none;border-radius:8px;background:var(--bg-hover);transition:all .2s;display:flex;align-items:center;justify-content:center;min-height:40px;}
.m-nav-btn:hover,.m-nav-btn.active{background:var(--accent);color:#fff;}
@media(max-width:768px){.desktop-header{display:none!important;}.mobile-top-header{display:block;}.mobile-bottom-nav{display:block!important;}body{padding-bottom:120px;}}
@media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}}

/* ===== FOOTER (matches contacts) ===== */
.footer-bar{text-align:center;padding:20px 16px 12px;border-top:1px solid var(--border);margin-top:8px;}
.footer-powered{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;}
.footer-powered span{color:var(--text-secondary);font-size:11px;}
.footer-powered img{height:28px;}
.footer-powered a{color:var(--accent);text-decoration:none;font-weight:600;font-size:11px;}
.footer-copy{color:var(--text-secondary);font-size:10px;opacity:.6;}

/* ===== CONTENT ===== */
.content{max-width:900px;margin:0 auto;padding:16px;}

/* ===== SPONSOR HEADER BAR ===== */
.hdr-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;padding:0;}
.hdr-sel{flex:1;min-width:200px;padding:9px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:13px;}
.hdr-btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s;}
.hdr-btn:hover{color:var(--text-primary);border-color:var(--text-secondary);}
.hdr-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}.hdr-btn.primary:hover{background:var(--accent-hover);}
.hdr-btn.danger{color:#ef4444;border-color:rgba(239,68,68,.3);}.hdr-btn.danger:hover{border-color:#ef4444;background:rgba(239,68,68,.08);}
.hdr-btn.success{color:#22c55e;border-color:rgba(34,197,94,.3);}.hdr-btn.success:hover{border-color:#22c55e;background:rgba(34,197,94,.08);}
.hdr-btn.publish{background:rgba(34,197,94,.1);color:#22c55e;border-color:rgba(34,197,94,.3);font-weight:600;}.hdr-btn.publish:hover{background:rgba(34,197,94,.2);border-color:#22c55e;}

/* ===== META ROW ===== */
.meta-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.meta-input{padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text-primary);font-size:13px;width:100%;font-family:inherit;}
.meta-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
.meta-input::placeholder{color:var(--text-secondary);font-size:12px;}

/* ===== KPI CARDS ===== */
.kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:8px;}
.kpi-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px 10px;text-align:center;transition:border-color .2s;}
.kpi-card:hover{border-color:var(--accent);}
.kpi-val{font-size:20px;font-weight:700;line-height:1.2;letter-spacing:-.5px;}
.kpi-lbl{font-size:9px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.8px;margin-top:4px;font-weight:500;}
.dept-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;}
.dept-card{background:var(--accent-glow2);border:1px solid var(--border);border-radius:10px;padding:10px 8px;text-align:center;}
.dept-val{font-size:14px;font-weight:700;color:var(--text-secondary);}
.dept-lbl{font-size:9px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.8px;margin-top:2px;font-weight:500;}

/* ===== SECTION TITLES ===== */
.section-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin-bottom:10px;display:flex;align-items:center;cursor:pointer;user-select:none;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;transition:all .2s;}
.section-title:hover{color:var(--text-primary);border-color:var(--accent);}
.section-title-left{flex:1;display:flex;align-items:center;gap:8px;}
.section-chv{font-size:18px;margin-left:auto;transition:transform .3s;display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;background:var(--bg-hover);color:var(--text-secondary);flex-shrink:0;}
.section-title:hover .section-chv{color:var(--text-primary);}
.section-wrap{overflow:hidden;transition:max-height .35s ease,opacity .25s ease;max-height:0;opacity:0;}
.section-wrap.open{max-height:none;opacity:1;}
.section-add-btn{padding:4px 12px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--accent);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;}
.section-add-btn:hover{background:var(--accent);color:#fff;}

/* ===== LEVEL CARDS ===== */
.level-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden;transition:border-color .2s;}
.level-card:hover{border-color:var(--accent);}
.level-drag{cursor:grab;color:var(--text-secondary);padding:8px 6px;user-select:none;touch-action:none;opacity:.3;transition:opacity .2s;display:grid;grid-template-columns:repeat(2,4px);gap:3px;}
.level-drag:hover{opacity:.7;}.level-drag:active{cursor:grabbing;opacity:1;}
.level-drag i{display:block;width:4px;height:4px;border-radius:50%;background:currentColor;}
.level-card.dragging{opacity:.3;border-color:var(--accent);}
.level-card.drag-over{border-top:3px solid var(--accent);}
.level-hdr{display:flex;align-items:center;padding:16px;gap:12px;cursor:pointer;user-select:none;}
.level-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
.level-info{flex:1;min-width:0;}
.level-name{font-size:16px;font-weight:700;}
.level-sub{font-size:12px;color:var(--text-secondary);margin-top:2px;}
.level-price{font-size:18px;font-weight:700;margin-right:8px;}
.level-del{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
.level-del:hover{color:#ef4444;border-color:#ef4444;}
.level-chv{font-size:12px;color:var(--text-secondary);transition:transform .2s;}
.level-card.expanded .level-chv{transform:rotate(180deg);}
.level-body{max-height:0;overflow:hidden;transition:max-height .35s ease;}
.level-card.expanded .level-body{max-height:5000px;}
.level-inner{padding:0 16px 16px;}
.level-meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;}
.lm-label{font-size:11px;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;}
.lm-input{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text-primary);font-size:14px;width:100%;font-family:inherit;}
.lm-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
.lm-color{width:100%;height:36px;border-radius:8px;border:1px solid var(--border);cursor:pointer;background:none;padding:2px;}

/* ===== PERKS ===== */
.perks-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.perk-row{display:grid;grid-template-columns:50px 1fr 80px 80px 32px;gap:8px;align-items:center;margin-bottom:6px;}
.perk-qty{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text-primary);font-size:14px;text-align:center;width:100%;font-family:inherit;}
.perk-name{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text-primary);font-size:14px;width:100%;font-family:inherit;}
.perk-del{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
.perk-del:hover{color:#ef4444;border-color:#ef4444;}
.perk-cost{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:#22c55e;font-size:13px;text-align:right;width:100%;font-family:inherit;}
.perk-value{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--accent);font-size:13px;text-align:right;width:100%;font-family:inherit;}
.perk-qty:focus,.perk-name:focus,.perk-cost:focus,.perk-value:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
.add-perk-btn{display:block;width:100%;padding:8px;border-radius:8px;border:1px dashed var(--border);background:transparent;color:var(--text-secondary);font-size:13px;cursor:pointer;text-align:center;margin-top:6px;font-family:inherit;}
.add-perk-btn:hover{background:var(--bg-hover);color:var(--accent);border-color:var(--accent);}
.add-level-btn{display:block;width:100%;padding:14px;border-radius:12px;border:2px dashed var(--border);background:transparent;color:var(--text-secondary);font-size:15px;font-weight:600;cursor:pointer;text-align:center;margin-top:8px;}
.add-level-btn:hover{background:var(--bg-hover);color:var(--accent);border-color:var(--accent);}

/* ===== SUMMARY BAR ===== */
.summary-bar{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;display:grid;grid-template-columns:repeat(5,1fr);gap:12px;text-align:center;}
.sb-val{font-size:22px;font-weight:700;}
.sb-lbl{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}

/* ===== VIEW TABS ===== */
.view-tabs{display:flex;gap:0;padding:0 24px 0;background:var(--bg-primary);border-bottom:1px solid var(--border);}
.view-tab{padding:10px 16px;border:none;border-bottom:2px solid transparent;background:none;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s;text-transform:uppercase;letter-spacing:.5px;}
.view-tab:hover{color:var(--text-primary);}
.view-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.view-tab .tab-badge{display:inline-block;background:var(--accent-glow);border-radius:10px;padding:1px 6px;font-size:10px;margin-left:4px;font-weight:700;}
.view-tab.active .tab-badge{background:var(--accent-glow);color:var(--accent);}

/* ===== REVIEW PANEL ===== */
.review-panel{display:none;padding:16px;}.review-panel.show{display:block;}
.review-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:border-color .2s;}
.review-card:hover{border-color:var(--accent);}
.review-card.published{border-color:#22c55e;border-width:2px;}
.review-vote{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:44px;}
.vote-btn{width:32px;height:24px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.vote-btn:hover{border-color:var(--accent);color:var(--accent);}
.vote-btn.voted-up{background:#22c55e;color:#fff;border-color:#22c55e;}
.vote-btn.voted-down{background:#ef4444;color:#fff;border-color:#ef4444;}
.vote-score{font-size:16px;font-weight:700;color:var(--text-primary);line-height:1;}
.review-info{flex:1;min-width:0;}
.review-name{font-size:14px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.review-meta{font-size:11px;color:var(--text-secondary);margin-top:2px;}
.review-actions{display:flex;gap:6px;flex-shrink:0;}
.status-badge{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border-radius:10px;}
.status-draft{background:var(--bg-hover);color:var(--text-secondary);}
.status-submitted{background:rgba(220,38,38,.1);color:var(--accent);}
.status-published{background:rgba(34,197,94,.15);color:#22c55e;}

/* ===== OFFICIAL BANNER ===== */
.official-banner{background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.02));border:1px solid rgba(34,197,94,.2);border-radius:10px;padding:14px 18px;margin-bottom:12px;}
.official-banner-text{font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:2px;}
.official-banner-sub{font-size:12px;color:var(--text-secondary);}
.readonly-overlay{pointer-events:none;opacity:.85;}

/* ===== PUBLISH LOG ===== */
.publish-log{margin-top:16px;border-top:1px solid var(--border);padding-top:12px;}
.publish-log-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-secondary);margin-bottom:8px;}
.publish-log-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;}.publish-log-row:last-child{border-bottom:none;}
.publish-log-dot{width:6px;height:6px;border-radius:50%;background:#22c55e;flex-shrink:0;}
.publish-log-name{color:var(--text-primary);font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.publish-log-by{color:var(--text-secondary);}
.publish-log-date{color:var(--text-secondary);flex-shrink:0;font-size:11px;}

/* ===== REVENUE ESTIMATOR ===== */
.rev-dashboard{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;}
.rev-section{border:1px solid var(--border);border-radius:8px;margin-bottom:8px;overflow:hidden;transition:border-color .2s;}
.rev-section.drag-over{border-color:var(--accent);}
.rev-section.dragging{opacity:.4;}
.rev-section-hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg-hover);cursor:default;}
.rev-section-drag{cursor:grab;display:grid;grid-template-columns:repeat(2,4px);gap:3px;padding:4px 2px;opacity:.4;transition:opacity .2s;}
.rev-section-drag:hover{opacity:1;}
.rev-section-drag i{width:4px;height:4px;border-radius:1px;background:var(--text-secondary);display:block;}
.rev-section-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);flex:1;}
.rev-section-stats{font-size:11px;color:var(--text-secondary);white-space:nowrap;}
.rev-total-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;text-align:center;}
.rev-total-card{background:var(--bg-hover);border-radius:10px;padding:14px 8px;}
.rev-total-val{font-size:24px;font-weight:800;}
.rev-total-lbl{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
.rev-slider-row{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border);}
.rev-slider-row:last-child{border-bottom:none;}
.rev-slider-left{min-width:0;flex-shrink:0;width:140px;}
.rev-slider-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rev-slider-price{font-size:12px;color:var(--text-secondary);}
.rev-slider-mid{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0;}
.rev-range-wrap{position:relative;height:28px;display:flex;align-items:center;}
.rev-actual-marker{position:absolute;top:50%;width:3px;height:20px;border-radius:2px;background:var(--accent);transform:translate(-50%,-50%);pointer-events:none;z-index:2;opacity:.85;box-shadow:0 0 6px var(--accent-glow);}
.rev-actual-label{position:absolute;top:-13px;transform:translateX(-50%);font-size:8px;font-weight:700;color:var(--accent);pointer-events:none;white-space:nowrap;opacity:.85;}
.rev-range{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:3px;background:var(--border);outline:none;cursor:pointer;}
.rev-range::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid var(--bg-card);cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,.3);}
.rev-range::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid var(--bg-card);cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,.3);}
.rev-ticks{display:flex;justify-content:space-between;padding:0 2px;}
.rev-tick{font-size:9px;color:var(--text-secondary);}
.rev-slider-right{text-align:right;flex-shrink:0;width:120px;}
.rev-qty-row{display:flex;align-items:flex-start;gap:6px;justify-content:flex-end;}
.rev-qty-input{width:48px;padding:5px 2px;border-radius:6px;border:1px solid var(--border);background:var(--input-bg);color:var(--text-primary);font-size:14px;font-weight:700;text-align:center;}
.rev-actual-input{width:48px;padding:5px 2px;border-radius:6px;border:1px solid var(--accent);background:var(--accent-glow);color:var(--text-primary);font-size:14px;font-weight:700;text-align:center;}
.rev-input-col{display:flex;flex-direction:column;align-items:center;}
.rev-input-lbl{font-size:8px;text-transform:uppercase;letter-spacing:.3px;color:var(--text-secondary);margin-top:2px;}
.rev-subtotal{font-size:16px;font-weight:700;color:#22c55e;margin-top:2px;}
.rev-bar{height:4px;border-radius:2px;background:var(--border);margin-top:2px;overflow:hidden;}
.rev-bar-fill{height:100%;border-radius:2px;transition:width .15s ease;}

/* ===== TOAST & SAVE ===== */
.toast{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;z-index:2000;display:none;box-shadow:var(--shadow);}.toast.show{display:block;}
.save-indicator{position:fixed;top:12px;right:12px;z-index:9999;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;opacity:0;transition:opacity .3s;pointer-events:none;}
.save-indicator.saving{opacity:1;background:var(--accent);color:#fff;}
.save-indicator.saved{opacity:1;background:#22c55e;color:#fff;}
.save-indicator.fade{opacity:0;}

/* ===== MOBILE SPONSOR CONTROLS ===== */
.mob-controls{padding:0 16px 0;background:var(--bg-primary);}
.mob-sel{width:100%;font-size:14px;padding:10px 12px;border-radius:8px;margin-bottom:8px;font-weight:600;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);}
.mob-btn-row{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
.mob-btn{flex:1;font-size:12px!important;padding:10px 8px!important;min-height:40px;border-radius:8px!important;font-weight:600!important;min-width:60px;}
.mob-view-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--bg-primary);}
.mob-view-tabs .view-tab{flex:1;text-align:center;font-size:12px;padding:10px 6px;letter-spacing:.5px;font-weight:700;}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .content{padding:12px;}
  .meta-row{grid-template-columns:1fr 1fr;gap:8px;}
  .meta-row input[style*="span 2"]{grid-column:span 2;}
  .kpi-grid{grid-template-columns:repeat(3,1fr);gap:6px;}
  .kpi-card{padding:10px 8px;border-radius:8px;}
  .kpi-val{font-size:18px;}.kpi-lbl{font-size:8px;}
  .dept-grid{grid-template-columns:repeat(4,1fr);gap:6px;}
  .summary-bar{grid-template-columns:repeat(3,1fr);gap:8px;padding:12px;}
  .sb-val{font-size:18px;}
  .level-meta{grid-template-columns:1fr 1fr;gap:10px;}
  .perk-row{grid-template-columns:56px 1fr 36px!important;grid-template-rows:auto auto;gap:6px 8px!important;margin-bottom:10px!important;padding-bottom:10px;border-bottom:1px solid var(--border);}
  .perk-qty{grid-column:1;grid-row:1;}.perk-name{grid-column:2;grid-row:1;}.perk-del{grid-column:3;grid-row:1;}
  .perk-value{grid-column:1/2;grid-row:2;text-align:center;width:auto!important;}.perk-cost{grid-column:2/4;grid-row:2;text-align:left;width:auto!important;}
  .rev-total-row{grid-template-columns:repeat(2,1fr);gap:8px;}
  .rev-slider-row{flex-direction:column;gap:8px;padding:12px 0;}
  .rev-slider-left{width:100%;display:flex;justify-content:space-between;align-items:center;}
  .rev-slider-mid{width:100%;}
  .rev-slider-right{width:100%;display:flex;align-items:center;gap:8px;}
  .rev-qty-row{flex-direction:row;gap:8px;align-items:center;}
  .rev-input-col{flex-direction:row;align-items:center;gap:4px;}
  .rev-input-lbl{margin-top:0;font-size:10px;}
  .rev-subtotal{flex:1;text-align:right;margin-top:0;}
  .rev-bar{display:none;}
  .review-card{flex-wrap:wrap;gap:10px;}
  .review-actions{width:100%;justify-content:flex-end;}
}
@media(max-width:400px){
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
  .dept-grid{grid-template-columns:repeat(2,1fr);}
  .meta-row{grid-template-columns:1fr;}
}

/* ===== PRINT ===== */
.print-header{display:none;}
@media print{
  body{background:#fff!important;color:#000!important;padding:0!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  .desktop-header,.mobile-top-header,.mobile-bottom-nav,.toast,.save-indicator,.hdr-bar,.level-drag,.level-del,.perk-del,.add-perk-btn,.add-level-btn,.section-add-btn,.rev-section-drag,.view-tabs,.review-panel,.official-banner,.readonly-overlay,.footer-bar,.mob-controls{display:none!important;}
  .content{max-width:100%!important;padding:8px!important;}
  .section-wrap{max-height:none!important;opacity:1!important;overflow:visible!important;}
  .level-body{max-height:none!important;overflow:visible!important;}
  .level-card{break-inside:avoid;border:1px solid #ccc!important;margin-bottom:8px!important;background:#fff!important;}
  .level-card.expanded .level-body,.level-body{max-height:none!important;}
  .level-chv{display:none!important;}
  .summary-bar,.rev-dashboard{background:#f9f9f9!important;border:1px solid #ccc!important;}
  .kpi-card,.dept-card{background:#f9f9f9!important;border:1px solid #ccc!important;}
  .kpi-val,.dept-val,.sb-val,.level-name,.level-price,.rev-total-val,.rev-subtotal{color:#000!important;}
  .kpi-lbl,.dept-lbl,.sb-lbl,.level-sub,.rev-total-lbl,.perks-title,.section-title,.lm-label{color:#555!important;}
  .print-header{display:block!important;text-align:center;padding:16px 0;border-bottom:2px solid #000;margin-bottom:16px;}
  .print-header h1{font-size:24px;margin:0;}.print-header p{font-size:14px;color:#555;margin:4px 0 0;}
  input[type="color"],.lm-color{display:none!important;}
  .level-meta{grid-template-columns:1fr 1fr!important;}
}
  </style>
</head>
<body>
<div class="print-header"><h1 id="printTitle">Sponsor Sheet</h1><p id="printSub"></p></div>

<!-- MOBILE TOP HEADER -->
<div class="mobile-top-header">
  <div class="m-bar">
    <button class="m-menu-btn" onclick="document.getElementById('mMenu').classList.toggle('expanded')">&#9776;</button>
    <div class="m-center"><div class="m-title">Packages</div><div class="m-biz" id="mBiz">Event Logic Pro</div></div>
    <div class="m-right"><button class="dark-toggle" onclick="toggleDark()"><svg id="mMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><svg id="mSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div>
  </div>
  <div class="m-menu" id="mMenu"><div class="m-actions"><button onclick="location.href='eventlogicpro-settings.html'">Settings</button><button onclick="location.href='support.html'">Support</button><button onclick="logout()">Logout</button></div></div>
  <div class="mob-controls">
    <select class="mob-sel hdr-sel" id="mobSheetSel" onchange="syncSel(this.value)"></select>
    <div class="mob-btn-row">
      <button class="hdr-btn primary mob-btn" onclick="createSheet()">+ New</button>
      <button class="hdr-btn mob-btn" onclick="saveToDb()">Save</button>
      <button class="hdr-btn mob-btn" onclick="printSheet()">Print</button>
      <button class="hdr-btn success mob-btn" id="mobSubmitBtn" onclick="submitForReview()" style="display:none;">Submit</button>
      <button class="hdr-btn publish mob-btn" id="mobPublishBtn" onclick="publishSheet()" style="display:none;">Publish</button>
      <button class="hdr-btn danger mob-btn" id="mobDelBtn" onclick="deleteSheet()" style="display:none;">Del</button>
    </div>
    <div class="mob-view-tabs">
      <div class="view-tab active" onclick="setViewMode('editor')">My Sheets</div>
      <div class="view-tab" onclick="setViewMode('review')">Review <span class="tab-badge" id="mobReviewCount">0</span></div>
      <div class="view-tab" onclick="setViewMode('official')">Official</div>
    </div>
  </div>
</div>

<!-- DESKTOP HEADER -->
<div class="desktop-header">
  <div class="header-top">
    <div class="header-left">
      <div class="header-titles"><h1>Packages</h1><div class="sub" id="dBiz">Event Logic Pro</div></div>
    </div>
    <img id="headerLogo" class="header-logo" src="eventlogicpro-logo.png" alt="Event Logic Pro">
  </div>
  <div class="nav-bar">
    <div class="nav-left">
      <a href="eventlogicpro-dashboard.html" class="nav-btn">Dashboard</a>
      <a href="eventlogicpro-calendar.html" class="nav-btn">Calendar</a>
      <a href="eventlogicpro.html" class="nav-btn">Tasks</a>
      <a href="eventlogicpro-budget.html" class="nav-btn">Budget</a>
      <a href="eventlogicpro-sponsors.html" class="nav-btn active">Packages</a>
      <a href="eventlogicpro-contacts.html" class="nav-btn">Contacts</a>
      <a href="eventlogicpro-sitemap.html" class="nav-btn">Site Maps</a>
    </div>
    <div class="nav-right-controls">
      <button class="dark-toggle" onclick="toggleDark()" title="Toggle dark mode">
        <svg id="dMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/></svg>
        <svg id="dSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      </button>
      <a href="eventlogicpro-settings.html" class="settings-link">Settings</a>
      <a class="logout-link" onclick="logout()">Logout</a>
    </div>
  </div>
  <div class="hdr-bar" style="padding:8px 24px;">
    <select class="hdr-sel" id="deskSheetSel" onchange="syncSel(this.value)"></select>
    <button class="hdr-btn primary" onclick="createSheet()">+ New Sheet</button>
    <button class="hdr-btn" onclick="saveToDb()">Save</button>
    <button class="hdr-btn" onclick="printSheet()">Print</button>
    <button class="hdr-btn success" id="deskSubmitBtn" onclick="submitForReview()" style="display:none;">Submit for Review</button>
    <button class="hdr-btn publish" id="deskPublishBtn" onclick="publishSheet()" style="display:none;">Publish as Official</button>
    <button class="hdr-btn danger" id="deskDelBtn" onclick="deleteSheet()" style="display:none;">Delete</button>
  </div>
  <div class="view-tabs" id="deskViewTabs">
    <div class="view-tab active" onclick="setViewMode('editor')">My Sheets</div>
    <div class="view-tab" onclick="setViewMode('review')">Review Board <span class="tab-badge" id="deskReviewCount">0</span></div>
    <div class="view-tab" onclick="setViewMode('official')">Official</div>
  </div>
</div>

<!-- CONTENT -->
<div class="content">
  <!-- Review Board Panel -->
  <div class="review-panel" id="reviewPanel">
    <div style="font-size:18px;font-weight:700;margin-bottom:4px;">Review Board</div>
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">Vote on submitted budget proposals. Admins can publish the winning version.</div>
    <div id="reviewCards"></div>
    <div id="reviewEmpty" style="text-align:center;padding:40px 20px;color:var(--text-secondary);font-size:13px;">No sheets submitted for review yet.<br>Create a sheet and click "Submit for Review" to start.</div>
  </div>

  <!-- Official View -->
  <div id="officialView" style="display:none;">
    <div class="official-banner" id="officialBanner">
      <div class="official-banner-text">Official Budget</div>
      <div class="official-banner-sub" id="officialMeta">No official budget published yet</div>
    </div>
    <div class="publish-log" id="publishLogArea">
      <div class="publish-log-title">Publish History</div>
      <div id="publishLogRows"></div>
    </div>
  </div>

  <!-- Editor -->
  <div id="editorView">
  <div class="meta-row">
    <input class="meta-input" id="sheetName" placeholder="Sheet name" oninput="dirty=true;scheduleAutoSave();" style="grid-column:span 2;">
    <input class="meta-input" id="sheetEvent" type="date" placeholder="Event date" oninput="dirty=true;scheduleAutoSave();" title="Event Date">
    <input class="meta-input" id="sheetVenue" placeholder="Venue / Location" oninput="dirty=true;scheduleAutoSave();">
  </div>
  <div class="kpi-grid">
    <div class="kpi-card"><div class="kpi-val" id="kpiGoalRev" style="color:#22c55e;">$0</div><div class="kpi-lbl">Goal Revenue</div></div>
    <div class="kpi-card"><div class="kpi-val" id="kpiActualRev">$0</div><div class="kpi-lbl">Actual Revenue</div></div>
    <div class="kpi-card"><div class="kpi-val" id="kpiTotalCost" style="color:#f59e0b;">$0</div><div class="kpi-lbl">Total Cost</div></div>
    <div class="kpi-card"><div class="kpi-val" id="kpiProfit">$0</div><div class="kpi-lbl">Net Profit</div></div>
    <div class="kpi-card"><div class="kpi-val" id="kpiSold" style="color:var(--accent);">0</div><div class="kpi-lbl">Actual Sold</div></div>
  </div>
  <div class="dept-grid">
    <div class="dept-card"><div class="dept-val" id="kpiSponsor">$0</div><div class="dept-lbl">Sponsors</div></div>
    <div class="dept-card"><div class="dept-val" id="kpiTicket">$0</div><div class="dept-lbl">Tickets</div></div>
    <div class="dept-card"><div class="dept-val" id="kpiVendor">$0</div><div class="dept-lbl">Vendors</div></div>
    <div class="dept-card"><div class="dept-val" id="kpiCamping">$0</div><div class="dept-lbl">Camping</div></div>
  </div>

  <div class="section-title" onclick="toggleSection('sponsorSec',this)"><span class="section-title-left">SPONSOR LEVELS</span><button class="section-add-btn" onclick="event.stopPropagation();addLevel()">+ Add Level</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="sponsorSec"><div id="levelsArea"></div></div>

  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('ticketSec',this)"><span class="section-title-left">TICKET PACKAGES</span><button class="section-add-btn" onclick="event.stopPropagation();addTickPkg()">+ Add Package</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="ticketSec">
    <div class="summary-bar" id="tickSummary">
      <div><div class="sb-val" id="tbPkgs">0</div><div class="sb-lbl">Packages</div></div>
      <div><div class="sb-val" id="tbItems">0</div><div class="sb-lbl">Total Items</div></div>
      <div><div class="sb-val" id="tbValue" style="color:var(--accent);">$0</div><div class="sb-lbl">Total Value</div></div>
      <div><div class="sb-val" id="tbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
      <div><div class="sb-val" id="tbOffset">$0</div><div class="sb-lbl">Offset</div></div>
    </div>
    <div id="tickArea"></div>
  </div>

  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('vendorSec',this)"><span class="section-title-left">VENDOR PACKAGES</span><button class="section-add-btn" onclick="event.stopPropagation();addVendorPkg()">+ Add Package</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="vendorSec">
    <div class="summary-bar" id="vendorSummary">
      <div><div class="sb-val" id="vbPkgs">0</div><div class="sb-lbl">Packages</div></div>
      <div><div class="sb-val" id="vbItems">0</div><div class="sb-lbl">Total Items</div></div>
      <div><div class="sb-val" id="vbValue" style="color:var(--accent);">$0</div><div class="sb-lbl">Total Value</div></div>
      <div><div class="sb-val" id="vbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
      <div><div class="sb-val" id="vbOffset">$0</div><div class="sb-lbl">Offset</div></div>
    </div>
    <div id="vendorArea"></div>
  </div>

  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('campingSec',this)"><span class="section-title-left">CAMPING PACKAGES</span><button class="section-add-btn" onclick="event.stopPropagation();addCampingPkg()">+ Add Package</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="campingSec">
    <div class="summary-bar" id="campingSummary">
      <div><div class="sb-val" id="cbPkgs">0</div><div class="sb-lbl">Packages</div></div>
      <div><div class="sb-val" id="cbItems">0</div><div class="sb-lbl">Total Items</div></div>
      <div><div class="sb-val" id="cbValue" style="color:var(--accent);">$0</div><div class="sb-lbl">Total Value</div></div>
      <div><div class="sb-val" id="cbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
      <div><div class="sb-val" id="cbOffset">$0</div><div class="sb-lbl">Offset</div></div>
    </div>
    <div id="campingArea"></div>
  </div>

  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('revSec',this)"><span class="section-title-left">REVENUE ESTIMATOR</span><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="revSec">
    <div class="rev-dashboard" id="revDash">
      <div class="rev-total-row">
        <div class="rev-total-card"><div class="rev-total-val" id="revGoalQty" style="color:var(--accent);">0</div><div class="rev-total-lbl">Goal Sold</div></div>
        <div class="rev-total-card"><div class="rev-total-val" id="revActualQty" style="color:#22c55e;">0</div><div class="rev-total-lbl">Actual Sold</div></div>
        <div class="rev-total-card"><div class="rev-total-val" id="revPctSold">0%</div><div class="rev-total-lbl">% of Goal</div></div>
        <div class="rev-total-card"><div class="rev-total-val" id="revRemaining" style="color:#f59e0b;">0</div><div class="rev-total-lbl">Remaining</div></div>
      </div>
      <div class="rev-total-row" style="margin-top:-8px;">
        <div class="rev-total-card"><div class="rev-total-val" style="font-size:16px;" id="revSponsorQty">0 / 0</div><div class="rev-total-lbl">Sponsors</div></div>
        <div class="rev-total-card"><div class="rev-total-val" style="font-size:16px;" id="revTicketQty">0 / 0</div><div class="rev-total-lbl">Tickets</div></div>
        <div class="rev-total-card"><div class="rev-total-val" style="font-size:16px;" id="revVendorQty">0 / 0</div><div class="rev-total-lbl">Vendors</div></div>
        <div class="rev-total-card"><div class="rev-total-val" style="font-size:16px;" id="revCampingQty">0 / 0</div><div class="rev-total-lbl">Camping</div></div>
      </div>
      <div id="revSliders"></div>
    </div>
  </div>
  </div><!-- close editorView -->
</div>

<!-- FOOTER -->
<div class="footer-bar">
  <div class="footer-powered"><span>Powered by</span><img src="glowbot.png" alt="GlowBot"><a href="https://glowbotslive.com" target="_blank">GlowBotsLive.com</a></div>
  <div class="footer-copy">&copy; 2026 Event Logic Pro. All rights reserved.</div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-bottom-nav">
  <div class="m-nav-top">
    <a href="eventlogicpro-dashboard.html" class="m-nav-btn">Dashboard</a>
    <a href="eventlogicpro-calendar.html" class="m-nav-btn">Calendar</a>
    <a href="eventlogicpro.html" class="m-nav-btn">Tasks</a>
    <a href="eventlogicpro-budget.html" class="m-nav-btn">Budget</a>
  </div>
  <div class="m-nav-bot" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:4px;">
    <a href="eventlogicpro-sponsors.html" class="m-nav-btn active">Packages</a>
    <a href="eventlogicpro-contacts.html" class="m-nav-btn">Contacts</a>
    <a href="eventlogicpro-sitemap.html" class="m-nav-btn">Site Maps</a>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="saveInd" class="save-indicator"></div>

<script>
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);
var tenantId=null,userId=null,dirty=false;
var allSheets=[],currentSheetId=null,levels=[],tickPkgs=[],vendorPkgs=[],campingPkgs=[];
var autoSaveTimer=null,saving=false;

/* ===== DARK MODE (matches contacts) ===== */
var isDark=localStorage.getItem('elp_dark_mode')==='true';
if(isDark){document.body.classList.add('dark');document.documentElement.classList.add('dark');}
function applyDarkIcons(){
  var d=document.body.classList.contains('dark');
  document.documentElement.classList.toggle('dark',d);
  ['d','m'].forEach(function(p){var moon=document.getElementById(p+'Moon'),sun=document.getElementById(p+'Sun');if(moon)moon.style.display=d?'none':'block';if(sun)sun.style.display=d?'block':'none';});
  var logo=document.getElementById('headerLogo');if(logo)logo.src=d?'eventlogicpro-logo-dark.png':'eventlogicpro-logo.png';
}
applyDarkIcons();
function toggleDark(){document.body.classList.toggle('dark');isDark=document.body.classList.contains('dark');localStorage.setItem('elp_dark_mode',isDark);applyDarkIcons();}

/* ===== HELPERS ===== */
function scheduleAutoSave(){if(autoSaveTimer)clearTimeout(autoSaveTimer);autoSaveTimer=setTimeout(function(){autoSave();},3000);}
function showSaveStatus(status){var el=document.getElementById('saveInd');el.className='save-indicator '+status;el.textContent=status==='saving'?'Saving...':'Saved ✓';if(status==='saved')setTimeout(function(){el.classList.add('fade');},1500);}
async function autoSave(){if(!dirty||saving||!currentSheetId||!tenantId)return;saving=true;showSaveStatus('saving');try{await saveToDb(true);}catch(e){console.error('Auto-save error:',e);}saving=false;}
function toast(msg){var el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2200);}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function fmt(n){return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});}

/* ===== AUTH (matches contacts) ===== */
async function logout(){await sb.auth.signOut();localStorage.clear();location.replace('/');}
async function checkAuth(){
  var r=await sb.auth.getSession(),s=r.data.session;
  if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');
    if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}
    if(!s){location.replace('/');return null;}}
  return s;
}

// Default perk templates
var DEFAULT_PERKS=[{name:'Event Tickets',qty:0,value:0,cost:0},{name:'VIP Passes',qty:0,value:0,cost:0},{name:'T-Shirts',qty:0,value:0,cost:0},{name:'Banner Placement',qty:0,value:0,cost:0},{name:'Stage Mention',qty:0,value:0,cost:0},{name:'Screen Ad Rotation',qty:0,value:0,cost:0},{name:'Social Media Shoutout',qty:0,value:0,cost:0},{name:'Booth Space',qty:0,value:0,cost:0},{name:'Logo on Flyer/Poster',qty:0,value:0,cost:0},{name:'Website Logo/Link',qty:0,value:0,cost:0},{name:'MC Announcement',qty:0,value:0,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:0,cost:0}];
function makeDefaults(){return[{name:'Platinum',color:'#a78bfa',price:3500,perks:[{name:'Event Tickets',qty:20,value:25,cost:10},{name:'VIP Passes',qty:10,value:75,cost:25},{name:'T-Shirts',qty:10,value:25,cost:12},{name:'Banner Placement',qty:2,value:150,cost:50},{name:'Stage Mention',qty:4,value:50,cost:0},{name:'Screen Ad Rotation',qty:1,value:100,cost:25},{name:'Social Media Shoutout',qty:5,value:30,cost:0},{name:'Booth Space',qty:1,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},{name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:3,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:1,value:100,cost:0}]},{name:'Gold',color:'#fbbf24',price:2000,perks:[{name:'Event Tickets',qty:10,value:25,cost:10},{name:'VIP Passes',qty:4,value:75,cost:25},{name:'T-Shirts',qty:6,value:25,cost:12},{name:'Banner Placement',qty:1,value:150,cost:50},{name:'Stage Mention',qty:2,value:50,cost:0},{name:'Screen Ad Rotation',qty:1,value:100,cost:25},{name:'Social Media Shoutout',qty:3,value:30,cost:0},{name:'Booth Space',qty:1,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},{name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:1,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:100,cost:0}]},{name:'Silver',color:'#94a3b8',price:1500,perks:[{name:'Event Tickets',qty:6,value:25,cost:10},{name:'VIP Passes',qty:2,value:75,cost:25},{name:'T-Shirts',qty:4,value:25,cost:12},{name:'Banner Placement',qty:1,value:150,cost:50},{name:'Stage Mention',qty:1,value:50,cost:0},{name:'Screen Ad Rotation',qty:0,value:100,cost:25},{name:'Social Media Shoutout',qty:2,value:30,cost:0},{name:'Booth Space',qty:0,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},{name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:0,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:100,cost:0}]}];}
function makeDefaultTicks(){return[{name:'VIP Bundle',color:'#a78bfa',price:85,items:[{name:'VIP Admission',qty:1,value:40,cost:15},{name:'Drink Ticket',qty:3,value:8,cost:3},{name:'T-Shirt',qty:1,value:25,cost:12},{name:'Food Voucher',qty:2,value:10,cost:5},{name:'Parking Pass',qty:1,value:10,cost:2},{name:'Meet & Greet Access',qty:1,value:20,cost:0}]},{name:'Party Pack',color:'#22c55e',price:55,items:[{name:'General Admission',qty:1,value:25,cost:8},{name:'Drink Ticket',qty:2,value:8,cost:3},{name:'T-Shirt',qty:1,value:25,cost:12},{name:'Food Voucher',qty:1,value:10,cost:5}]},{name:'General Admission',color:'#3b82f6',price:25,items:[{name:'General Admission Ticket',qty:1,value:20,cost:8},{name:'Drink Ticket',qty:1,value:8,cost:3}]}];}
function makeDefaultVendors(){return[{name:'Premium Vendor',color:'#f59e0b',price:500,items:[{name:'10x10 Booth Space',qty:1,value:300,cost:50},{name:'Table & Chairs',qty:1,value:50,cost:20},{name:'Power Hookup',qty:1,value:40,cost:15},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Vendor Parking Pass',qty:2,value:10,cost:2},{name:'Logo on Event Map',qty:1,value:50,cost:10}]},{name:'Standard Vendor',color:'#06b6d4',price:300,items:[{name:'10x10 Booth Space',qty:1,value:200,cost:50},{name:'Table & Chairs',qty:1,value:50,cost:20},{name:'Event Tickets',qty:2,value:25,cost:10},{name:'Vendor Parking Pass',qty:1,value:10,cost:2}]},{name:'Food Vendor',color:'#ef4444',price:400,items:[{name:'10x10 Booth Space',qty:1,value:250,cost:50},{name:'Table & Chairs',qty:2,value:50,cost:20},{name:'Power Hookup',qty:1,value:40,cost:15},{name:'Water Access',qty:1,value:30,cost:10},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Vendor Parking Pass',qty:2,value:10,cost:2}]}];}
function makeDefaultCamping(){return[{name:'Premium Campsite',color:'#22c55e',price:150,items:[{name:'Premium Campsite Spot',qty:1,value:100,cost:15},{name:'Parking Pass',qty:2,value:10,cost:2},{name:'Shower Access',qty:1,value:20,cost:5},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Firewood Bundle',qty:2,value:10,cost:4},{name:'Early Check-in',qty:1,value:15,cost:0}]},{name:'Standard Campsite',color:'#3b82f6',price:75,items:[{name:'Standard Campsite Spot',qty:1,value:50,cost:10},{name:'Parking Pass',qty:1,value:10,cost:2},{name:'Shower Access',qty:1,value:20,cost:5},{name:'Event Tickets',qty:2,value:25,cost:10}]},{name:'RV Hookup',color:'#f59e0b',price:200,items:[{name:'RV Spot w/ Hookup',qty:1,value:150,cost:30},{name:'Power Hookup',qty:1,value:30,cost:10},{name:'Water Hookup',qty:1,value:20,cost:5},{name:'Parking Pass',qty:1,value:10,cost:2},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Shower Access',qty:1,value:20,cost:5}]}];}
var DEFAULT_VENDOR_ITEMS=[{name:'Booth Space',qty:0,value:0,cost:0},{name:'Table & Chairs',qty:0,value:0,cost:0},{name:'Power Hookup',qty:0,value:0,cost:0},{name:'Event Tickets',qty:0,value:0,cost:0},{name:'Vendor Parking Pass',qty:0,value:0,cost:0}];
var DEFAULT_TICK_ITEMS=[{name:'General Admission Ticket',qty:1,value:0,cost:0},{name:'Drink Ticket',qty:0,value:0,cost:0},{name:'T-Shirt',qty:0,value:0,cost:0},{name:'Food Voucher',qty:0,value:0,cost:0},{name:'Parking Pass',qty:0,value:0,cost:0}];
var DEFAULT_CAMPING_ITEMS=[{name:'Campsite Spot',qty:0,value:0,cost:0},{name:'Parking Pass',qty:0,value:0,cost:0},{name:'Shower Access',qty:0,value:0,cost:0},{name:'Event Tickets',qty:0,value:0,cost:0},{name:'Firewood Bundle',qty:0,value:0,cost:0}];
async function loadSheets(){var r=await sb.from('sponsor_sheets').select('*').eq('tenant_id',tenantId).order('created_at',{ascending:false});if(r.error){console.error('Load sheets error:',r.error);allSheets=[];return;}allSheets=r.data||[];}
function buildOptions(){var h='<option value="">-- Select Sponsor Sheet --</option>';if(currentSheetId==='preloaded'&&!allSheets.find(function(s){return s.sheet_id==='preloaded';})){h+='<option value="preloaded" selected>Redding Rock 2026 (preloaded)</option>';}allSheets.forEach(function(s){var st=s.status||'draft';var badge=st==='published'?' ★ OFFICIAL':st==='submitted'?' [submitted]':'';h+='<option value="'+s.sheet_id+'"'+(s.sheet_id===currentSheetId?' selected':'')+'>'+esc(s.sheet_name||'Untitled')+badge+'</option>';});return h;}
function renderSelects(){var h=buildOptions();document.getElementById('deskSheetSel').innerHTML=h;document.getElementById('mobSheetSel').innerHTML=h;}
function syncSel(id){if(!id){currentSheetId=null;clearForm();return;}document.getElementById('deskSheetSel').value=id;document.getElementById('mobSheetSel').value=id;if(id==='preloaded'){loadPreloaded();return;}currentSheetId=id;localStorage.setItem('elp-last-sponsor',id);loadSheetData(id);}
async function loadSheetData(id){var s=allSheets.find(function(e){return e.sheet_id===id;});if(!s)return;document.getElementById('sheetName').value=s.sheet_name||'';document.getElementById('sheetEvent').value=s.event_name||'';document.getElementById('sheetVenue').value=s.venue_name||'';var lr=await sb.from('sponsor_levels').select('*').eq('sheet_id',id).order('sort_order');var lvls=lr.data||[];levels=[];for(var i=0;i<lvls.length;i++){var l=lvls[i];var pr=await sb.from('sponsor_perks').select('*').eq('level_id',l.level_id).order('sort_order');levels.push({name:l.level_name,color:l.color,price:parseFloat(l.price)||0,perks:(pr.data||[]).map(function(p){return{name:p.perk_name,qty:parseInt(p.quantity)||0,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0};})});}if(!levels.length)levels=makeDefaults();var tr=await sb.from('ticket_packages').select('*').eq('sheet_id',id).order('sort_order');var tpkgs=tr.data||[];tickPkgs=[];for(var j=0;j<tpkgs.length;j++){var tp=tpkgs[j];var tir=await sb.from('ticket_package_items').select('*').eq('package_id',tp.package_id).order('sort_order');tickPkgs.push({name:tp.package_name,color:tp.color,price:parseFloat(tp.price)||0,items:(tir.data||[]).map(function(ti){return{name:ti.item_name,qty:parseInt(ti.quantity)||0,value:parseFloat(ti.value)||0,cost:parseFloat(ti.cost)||0};})});}if(!tickPkgs.length)tickPkgs=makeDefaultTicks();var vr=await sb.from('vendor_packages').select('*').eq('sheet_id',id).order('sort_order');var vpkgs=vr.data||[];vendorPkgs=[];for(var k=0;k<vpkgs.length;k++){var vp=vpkgs[k];var vir=await sb.from('vendor_package_items').select('*').eq('package_id',vp.package_id).order('sort_order');vendorPkgs.push({name:vp.package_name,color:vp.color,price:parseFloat(vp.price)||0,items:(vir.data||[]).map(function(vi){return{name:vi.item_name,qty:parseInt(vi.quantity)||0,value:parseFloat(vi.value)||0,cost:parseFloat(vi.cost)||0};})});}if(!vendorPkgs.length)vendorPkgs=makeDefaultVendors();var cr=await sb.from('camping_packages').select('*').eq('sheet_id',id).order('sort_order');var cpkgs=cr.data||[];campingPkgs=[];for(var m=0;m<cpkgs.length;m++){var cp=cpkgs[m];var cir=await sb.from('camping_package_items').select('*').eq('package_id',cp.package_id).order('sort_order');campingPkgs.push({name:cp.package_name,color:cp.color,price:parseFloat(cp.price)||0,items:(cir.data||[]).map(function(ci){return{name:ci.item_name,qty:parseInt(ci.quantity)||0,value:parseFloat(ci.value)||0,cost:parseFloat(ci.cost)||0};})});}if(!campingPkgs.length)campingPkgs=makeDefaultCamping();try{var rd=s.rev_data?JSON.parse(s.rev_data):{};revData={sponsor:rd.sponsor||[],ticket:rd.ticket||[],vendor:rd.vendor||[],camping:rd.camping||[],sponsorActual:rd.sponsorActual||[],ticketActual:rd.ticketActual||[],vendorActual:rd.vendorActual||[],campingActual:rd.campingActual||[]};if(rd.sectionOrder&&rd.sectionOrder.length)revSectionOrder=rd.sectionOrder;}catch(e){revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};}updateButtons(s);render();}
function loadPreloaded(){currentSheetId='preloaded';localStorage.setItem('elp-last-sponsor','preloaded');document.getElementById('sheetName').value='Redding Rock 2026';document.getElementById('sheetEvent').value='2026-06-20';document.getElementById('sheetVenue').value='Redding, CA';levels=makeDefaults();tickPkgs=makeDefaultTicks();vendorPkgs=makeDefaultVendors();campingPkgs=makeDefaultCamping();revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};updateButtons(null);render();}
function clearForm(){currentSheetId=null;document.getElementById('sheetName').value='';document.getElementById('sheetEvent').value='';document.getElementById('sheetVenue').value='';levels=[];tickPkgs=[];vendorPkgs=[];campingPkgs=[];revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};updateButtons(null);render();}
function updateButtons(s){updateActionButtons();}
async function createSheet(){if(!tenantId){toast('Not authenticated');return;}var name=prompt('Sheet name (e.g., Summer Bash 2026):');if(!name||!name.trim())return;var ins=await sb.from('sponsor_sheets').insert({tenant_id:tenantId,sheet_name:name.trim(),created_by:userId}).select().single();if(ins.error){toast('Error: '+ins.error.message);return;}var sheetId=ins.data.sheet_id;var defs=makeDefaults();for(var i=0;i<defs.length;i++){var lv=defs[i];var li=await sb.from('sponsor_levels').insert({sheet_id:sheetId,tenant_id:tenantId,level_name:lv.name,color:lv.color,price:lv.price,sort_order:i}).select().single();if(li.error)continue;if(li.data){var pRows=lv.perks.map(function(p,pi){return{level_id:li.data.level_id,sheet_id:sheetId,tenant_id:tenantId,perk_name:p.name,quantity:p.qty,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0,sort_order:pi};});if(pRows.length)await sb.from('sponsor_perks').insert(pRows);}}var defTicks=makeDefaultTicks();for(var j=0;j<defTicks.length;j++){var tp=defTicks[j];var tpi=await sb.from('ticket_packages').insert({sheet_id:sheetId,tenant_id:tenantId,package_name:tp.name,color:tp.color,price:tp.price,sort_order:j}).select().single();if(tpi.data){var tRows=tp.items.map(function(it,ii){return{package_id:tpi.data.package_id,sheet_id:sheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});if(tRows.length)await sb.from('ticket_package_items').insert(tRows);}}var defVendors=makeDefaultVendors();for(var v=0;v<defVendors.length;v++){var vp=defVendors[v];var vpi=await sb.from('vendor_packages').insert({sheet_id:sheetId,tenant_id:tenantId,package_name:vp.name,color:vp.color,price:vp.price,sort_order:v}).select().single();if(vpi.data){var vRows=vp.items.map(function(it,ii){return{package_id:vpi.data.package_id,sheet_id:sheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});if(vRows.length)await sb.from('vendor_package_items').insert(vRows);}}var defCamping=makeDefaultCamping();for(var c=0;c<defCamping.length;c++){var cp=defCamping[c];var cpi=await sb.from('camping_packages').insert({sheet_id:sheetId,tenant_id:tenantId,package_name:cp.name,color:cp.color,price:cp.price,sort_order:c}).select().single();if(cpi.data){var cRows=cp.items.map(function(it,ii){return{package_id:cpi.data.package_id,sheet_id:sheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});if(cRows.length)await sb.from('camping_package_items').insert(cRows);}}currentSheetId=sheetId;localStorage.setItem('elp-last-sponsor',sheetId);await loadSheets();renderSelects();syncSel(sheetId);toast('"'+name.trim()+'" created');}
async function ensureTables(){try{var t=await sb.from('sponsor_sheets').select('sheet_id').limit(1);if(t.error&&t.error.code==='42P01'){await sb.rpc('exec_sql',{sql:"CREATE TABLE IF NOT EXISTS sponsor_sheets (sheet_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, tenant_id uuid, sheet_name text, event_name text, venue_name text, rev_data text, created_by uuid, created_at timestamptz DEFAULT now(), status text DEFAULT 'draft', submitted_at timestamptz, submitted_by_name text, published_by uuid, published_at timestamptz); CREATE TABLE IF NOT EXISTS sponsor_levels (level_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, level_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS sponsor_perks (perk_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, level_id uuid REFERENCES sponsor_levels(level_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, perk_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS ticket_packages (package_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, package_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS ticket_package_items (item_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, package_id uuid REFERENCES ticket_packages(package_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, item_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS vendor_packages (package_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, package_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS vendor_package_items (item_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, package_id uuid REFERENCES vendor_packages(package_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, item_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS camping_packages (package_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, package_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS camping_package_items (item_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, package_id uuid REFERENCES camping_packages(package_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, item_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0);"});toast('Tables created');}}catch(e){}}
async function ensureValueColumns(){try{await sb.rpc('exec_sql',{sql:"ALTER TABLE ticket_package_items ADD COLUMN IF NOT EXISTS value numeric DEFAULT 0; ALTER TABLE vendor_package_items ADD COLUMN IF NOT EXISTS value numeric DEFAULT 0; ALTER TABLE sponsor_sheets ADD COLUMN IF NOT EXISTS venue_name text DEFAULT '';"});}catch(e){}}
async function saveToDb(silent){if(!tenantId){if(!silent)toast('Not authenticated');return;}if(!currentSheetId){if(!silent)toast('Select or create a sheet first');return;}var sheetName=document.getElementById('sheetName').value||'Untitled';var eventName=document.getElementById('sheetEvent').value||'';var venueName=document.getElementById('sheetVenue').value||'';if(currentSheetId==='preloaded'){var ins=await sb.from('sponsor_sheets').insert({tenant_id:tenantId,sheet_name:sheetName,event_name:eventName,venue_name:venueName,created_by:userId}).select().single();if(ins.error){toast('Save error: '+ins.error.message);return;}currentSheetId=ins.data.sheet_id;localStorage.setItem('elp-last-sponsor',currentSheetId);}else{var upd=await sb.from('sponsor_sheets').update({sheet_name:sheetName,event_name:eventName,venue_name:venueName}).eq('sheet_id',currentSheetId);if(upd.error){toast('Update error: '+upd.error.message);return;}}await sb.from('sponsor_perks').delete().eq('sheet_id',currentSheetId);await sb.from('sponsor_levels').delete().eq('sheet_id',currentSheetId);for(var i=0;i<levels.length;i++){var lv=levels[i];var li=await sb.from('sponsor_levels').insert({sheet_id:currentSheetId,tenant_id:tenantId,level_name:lv.name,color:lv.color,price:lv.price,sort_order:i}).select().single();if(li.error)continue;if(li.data&&lv.perks.length){var pRows=lv.perks.map(function(p,pi){return{level_id:li.data.level_id,sheet_id:currentSheetId,tenant_id:tenantId,perk_name:p.name,quantity:p.qty,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0,sort_order:pi};});await sb.from('sponsor_perks').insert(pRows);}}await sb.from('ticket_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('ticket_packages').delete().eq('sheet_id',currentSheetId);for(var j=0;j<tickPkgs.length;j++){var tp=tickPkgs[j];var tpi=await sb.from('ticket_packages').insert({sheet_id:currentSheetId,tenant_id:tenantId,package_name:tp.name,color:tp.color,price:tp.price,sort_order:j}).select().single();if(tpi.error)continue;if(tpi.data&&tp.items.length){var tRows=tp.items.map(function(it,ii){return{package_id:tpi.data.package_id,sheet_id:currentSheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});await sb.from('ticket_package_items').insert(tRows);}}await sb.from('vendor_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('vendor_packages').delete().eq('sheet_id',currentSheetId);for(var v=0;v<vendorPkgs.length;v++){var vp=vendorPkgs[v];var vpi=await sb.from('vendor_packages').insert({sheet_id:currentSheetId,tenant_id:tenantId,package_name:vp.name,color:vp.color,price:vp.price,sort_order:v}).select().single();if(vpi.error)continue;if(vpi.data&&vp.items.length){var vRows=vp.items.map(function(it,ii){return{package_id:vpi.data.package_id,sheet_id:currentSheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});await sb.from('vendor_package_items').insert(vRows);}}await sb.from('camping_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('camping_packages').delete().eq('sheet_id',currentSheetId);for(var c=0;c<campingPkgs.length;c++){var cp=campingPkgs[c];var cpi=await sb.from('camping_packages').insert({sheet_id:currentSheetId,tenant_id:tenantId,package_name:cp.name,color:cp.color,price:cp.price,sort_order:c}).select().single();if(cpi.error)continue;if(cpi.data&&cp.items.length){var cRows=cp.items.map(function(it,ii){return{package_id:cpi.data.package_id,sheet_id:currentSheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});await sb.from('camping_package_items').insert(cRows);}}await sb.from('sponsor_sheets').update({rev_data:JSON.stringify(Object.assign({},revData,{sectionOrder:revSectionOrder}))}).eq('sheet_id',currentSheetId);dirty=false;await loadSheets();renderSelects();document.getElementById('deskSheetSel').value=currentSheetId;document.getElementById('mobSheetSel').value=currentSheetId;if(silent){showSaveStatus('saved');}else{toast('Saved!');}}
async function deleteSheet(){if(!currentSheetId||currentSheetId==='preloaded')return;var s=allSheets.find(function(e){return e.sheet_id===currentSheetId;});if(!s||s.created_by!==userId){toast('Cannot delete');return;}if(!confirm('Delete "'+s.sheet_name+'"?'))return;await sb.from('camping_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('camping_packages').delete().eq('sheet_id',currentSheetId);await sb.from('vendor_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('vendor_packages').delete().eq('sheet_id',currentSheetId);await sb.from('ticket_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('ticket_packages').delete().eq('sheet_id',currentSheetId);await sb.from('sponsor_perks').delete().eq('sheet_id',currentSheetId);await sb.from('sponsor_levels').delete().eq('sheet_id',currentSheetId);await sb.from('sponsor_sheets').delete().eq('sheet_id',currentSheetId);currentSheetId=null;localStorage.removeItem('elp-last-sponsor');await loadSheets();renderSelects();clearForm();toast('Deleted');}
function render(){var area=document.getElementById('levelsArea');var h='';levels.forEach(function(lv,i){var totalPerks=lv.perks.filter(function(p){return p.qty>0;}).length;var lvCost=0,lvValue=0;lv.perks.forEach(function(p){var q=parseInt(p.qty)||0;lvCost+=q*(parseFloat(p.cost)||0);lvValue+=q*(parseFloat(p.value)||0);});h+='<div class="level-card" id="lvl-'+i+'"><div class="level-hdr" onclick="toggleLevel('+i+')"><div class="level-drag" onmousedown="handleGrab(event,'+i+')" ontouchstart="handleGrab(event,'+i+')" title="Drag to reorder"><i></i><i></i><i></i><i></i><i></i><i></i></div><div class="level-dot" style="background:'+lv.color+';"></div><div class="level-info"><div class="level-name" style="color:'+lv.color+';">'+esc(lv.name)+'</div><div class="level-sub">'+totalPerks+' perks · Value $'+fmt(lvValue)+' · Cost $'+fmt(lvCost)+'</div></div><div class="level-price" style="color:'+lv.color+';">$'+fmt(lv.price)+'</div><button class="level-del" onclick="event.stopPropagation();removeLevel('+i+')" title="Delete level">&times;</button><span class="level-chv">&#9660;</span></div>';h+='<div class="level-body"><div class="level-inner"><div class="level-meta"><div><div class="lm-label">Level Name</div><input class="lm-input" value="'+esc(lv.name)+'" onchange="updLevel('+i+',\'name\',this.value)"></div><div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(lv.price||'')+'" step="0.01" oninput="updLevel('+i+',\'price\',this.value)"></div><div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+lv.color+'" oninput="updLevel('+i+',\'color\',this.value)"></div></div>';h+='<div class="perks-title"><span>PERKS & INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Perk | Value | Cost</span></div>';lv.perks.forEach(function(p,pi){h+='<div class="perk-row"><input type="number" class="perk-qty" value="'+(p.qty||0)+'" min="0" oninput="updPerk('+i+','+pi+',\'qty\',this.value)"><input type="text" class="perk-name" value="'+esc(p.name)+'" onchange="updPerk('+i+','+pi+',\'name\',this.value)" placeholder="Perk name"><input type="number" class="perk-value" value="'+(p.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updPerk('+i+','+pi+',\'value\',this.value)"><input type="number" class="perk-cost" value="'+(p.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updPerk('+i+','+pi+',\'cost\',this.value)"><button class="perk-del" onclick="removePerk('+i+','+pi+')" title="Remove">&times;</button></div>';});h+='<button class="add-perk-btn" onclick="addPerk('+i+')">+ Add Perk</button></div></div></div>';});area.innerHTML=h;calcSummary();renderTickPkgs();renderVendorPkgs();renderCampingPkgs();}
function toggleLevel(i){var card=document.getElementById('lvl-'+i);if(card){var w=card.classList.contains('expanded');card.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function toggleSection(id,titleEl){var wrap=document.getElementById(id);if(!wrap)return;var isOpen=wrap.classList.contains('open');if(isOpen&&dirty)autoSave();wrap.classList.toggle('open');var chv=titleEl.querySelector('.section-chv');if(chv)chv.textContent=isOpen?'▸':'▾';}
function updLevel(i,key,val){if(key==='price')levels[i].price=parseFloat(val)||0;else if(key==='color')levels[i].color=val;else levels[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#lvl-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(levels[i].price);calcSummary();}else{render();var card=document.getElementById('lvl-'+i);if(card)card.classList.add('expanded');}}
function updPerk(li,pi,key,val){if(key==='qty')levels[li].perks[pi].qty=parseInt(val)||0;else if(key==='cost')levels[li].perks[pi].cost=parseFloat(val)||0;else if(key==='value')levels[li].perks[pi].value=parseFloat(val)||0;else levels[li].perks[pi][key]=val;dirty=true;scheduleAutoSave();calcSummary();}
function addPerk(li){levels[li].perks.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();render();var card=document.getElementById('lvl-'+li);if(card)card.classList.add('expanded');}
function removePerk(li,pi){levels[li].perks.splice(pi,1);dirty=true;scheduleAutoSave();render();var card=document.getElementById('lvl-'+li);if(card)card.classList.add('expanded');}
function addLevel(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[levels.length%colors.length];var name=prompt('Level name (e.g., Media, Standard):');if(!name||!name.trim())return;levels.push({name:name.trim(),color:c,price:0,perks:DEFAULT_PERKS.map(function(p){return{name:p.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();render();}
function removeLevel(i){if(!confirm('Delete "'+levels[i].name+'" level?'))return;levels.splice(i,1);dirty=true;scheduleAutoSave();render();}
var dragIdx=null,dragGhost=null;function handleGrab(e,i){e.preventDefault();e.stopPropagation();dragIdx=i;var card=document.getElementById('lvl-'+i);card.classList.add('dragging');dragGhost=card.cloneNode(true);dragGhost.classList.remove('dragging');dragGhost.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(dragGhost);document.addEventListener('mousemove',handleMove);document.addEventListener('mouseup',handleRelease);document.addEventListener('touchmove',handleMove,{passive:false});document.addEventListener('touchend',handleRelease);}function handleMove(e){if(dragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(dragGhost)dragGhost.style.top=(t.clientY-30)+'px';document.querySelectorAll('.level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id!=='lvl-'+dragIdx&&card.id.startsWith('lvl-'))card.classList.add('drag-over');}}function handleRelease(e){document.removeEventListener('mousemove',handleMove);document.removeEventListener('mouseup',handleRelease);document.removeEventListener('touchmove',handleMove);document.removeEventListener('touchend',handleRelease);if(dragGhost){document.body.removeChild(dragGhost);dragGhost=null;}if(dragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var ti=-1;if(tc){var m=tc.id.match(/lvl-(\d+)/);if(m)ti=parseInt(m[1]);}document.querySelectorAll('.level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(ti>=0&&ti!==dragIdx){var item=levels.splice(dragIdx,1)[0];levels.splice(ti,0,item);dirty=true;scheduleAutoSave();render();}dragIdx=null;}
function calcSummary(){levels.forEach(function(lv,i){var lvPerks=0,lvCost=0,lvValue=0;lv.perks.forEach(function(p){var q=parseInt(p.qty)||0;if(q>0)lvPerks++;lvCost+=q*(parseFloat(p.cost)||0);lvValue+=q*(parseFloat(p.value)||0);});var sub=document.querySelector('#lvl-'+i+' .level-sub');if(sub)sub.textContent=lvPerks+' perks · Value $'+fmt(lvValue)+' · Cost $'+fmt(lvCost);});calcTickSummary();calcVendorSummary();calcCampingSummary();updateMasterKPI();}
function updateMasterKPI(){var goalRev=0,actualRev=0,totalCost=0,totalSold=0;var deptActual={sponsor:0,ticket:0,vendor:0,camping:0};levels.forEach(function(lv,i){var g=revData.sponsor[i]||0;var a=revData.sponsorActual[i]||0;var lvCost=0;lv.perks.forEach(function(p){lvCost+=(parseInt(p.qty)||0)*(parseFloat(p.cost)||0);});deptActual.sponsor+=a*lv.price;goalRev+=g*lv.price;actualRev+=a*lv.price;totalCost+=g*lvCost;totalSold+=a;});tickPkgs.forEach(function(pk,i){var g=revData.ticket[i]||0;var a=revData.ticketActual[i]||0;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});deptActual.ticket+=a*pk.price;goalRev+=g*pk.price;actualRev+=a*pk.price;totalCost+=g*pkCost;totalSold+=a;});vendorPkgs.forEach(function(pk,i){var g=revData.vendor[i]||0;var a=revData.vendorActual[i]||0;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});deptActual.vendor+=a*pk.price;goalRev+=g*pk.price;actualRev+=a*pk.price;totalCost+=g*pkCost;totalSold+=a;});campingPkgs.forEach(function(pk,i){var g=revData.camping[i]||0;var a=revData.campingActual[i]||0;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});deptActual.camping+=a*pk.price;goalRev+=g*pk.price;actualRev+=a*pk.price;totalCost+=g*pkCost;totalSold+=a;});var profit=actualRev-totalCost;document.getElementById('kpiGoalRev').textContent='$'+fmt(goalRev);document.getElementById('kpiActualRev').textContent='$'+fmt(actualRev);document.getElementById('kpiTotalCost').textContent='$'+fmt(totalCost);var pEl=document.getElementById('kpiProfit');pEl.textContent=(profit>=0?'+$':'-$')+fmt(Math.abs(profit));pEl.style.color=profit>=0?'#22c55e':'#ef4444';document.getElementById('kpiSold').textContent=fmt(totalSold);document.getElementById('kpiSponsor').textContent='$'+fmt(deptActual.sponsor);document.getElementById('kpiSponsor').style.color=deptActual.sponsor>0?'#22c55e':'var(--text-secondary)';document.getElementById('kpiTicket').textContent='$'+fmt(deptActual.ticket);document.getElementById('kpiTicket').style.color=deptActual.ticket>0?'#22c55e':'var(--text-secondary)';document.getElementById('kpiVendor').textContent='$'+fmt(deptActual.vendor);document.getElementById('kpiVendor').style.color=deptActual.vendor>0?'#22c55e':'var(--text-secondary)';document.getElementById('kpiCamping').textContent='$'+fmt(deptActual.camping);document.getElementById('kpiCamping').style.color=deptActual.camping>0?'#22c55e':'var(--text-secondary)';}
function renderTickPkgs(){var area=document.getElementById('tickArea');var h='';tickPkgs.forEach(function(pk,i){var itemCnt=pk.items.filter(function(it){return it.qty>0;}).length;var pkCost=0,pkValue=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});h+='<div class="level-card" id="tpk-'+i+'"><div class="level-hdr" onclick="toggleTick('+i+')"><div class="level-drag" onmousedown="tickGrab(event,'+i+')" ontouchstart="tickGrab(event,'+i+')"><i></i><i></i><i></i><i></i><i></i><i></i></div><div class="level-dot" style="background:'+pk.color+';"></div><div class="level-info"><div class="level-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div><div class="level-sub">'+itemCnt+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost)+'</div></div><div class="level-price" style="color:'+pk.color+';">$'+fmt(pk.price)+'</div><button class="level-del" onclick="event.stopPropagation();removeTickPkg('+i+')" title="Delete">&times;</button><span class="level-chv">&#9660;</span></div>';h+='<div class="level-body"><div class="level-inner"><div class="level-meta"><div><div class="lm-label">Package Name</div><input class="lm-input" value="'+esc(pk.name)+'" onchange="updTick('+i+',\'name\',this.value)"></div><div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(pk.price||'')+'" step="0.01" oninput="updTick('+i+',\'price\',this.value)"></div><div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+pk.color+'" oninput="updTick('+i+',\'color\',this.value)"></div></div>';h+='<div class="perks-title"><span>INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Item | Value | Cost</span></div>';pk.items.forEach(function(it,ii){h+='<div class="perk-row"><input type="number" class="perk-qty" value="'+(it.qty||0)+'" min="0" oninput="updTickItem('+i+','+ii+',\'qty\',this.value)"><input type="text" class="perk-name" value="'+esc(it.name)+'" onchange="updTickItem('+i+','+ii+',\'name\',this.value)" placeholder="Item name"><input type="number" class="perk-value" value="'+(it.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updTickItem('+i+','+ii+',\'value\',this.value)"><input type="number" class="perk-cost" value="'+(it.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updTickItem('+i+','+ii+',\'cost\',this.value)"><button class="perk-del" onclick="removeTickItem('+i+','+ii+')">&times;</button></div>';});h+='<button class="add-perk-btn" onclick="addTickItem('+i+')">+ Add Item</button></div></div></div>';});area.innerHTML=h;calcTickSummary();renderRevSliders();}
function toggleTick(i){var c=document.getElementById('tpk-'+i);if(c){var w=c.classList.contains('expanded');c.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function updTick(i,key,val){if(key==='price')tickPkgs[i].price=parseFloat(val)||0;else if(key==='color')tickPkgs[i].color=val;else tickPkgs[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#tpk-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(tickPkgs[i].price);calcTickSummary();renderRevSliders();}else{renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}}
function updTickItem(i,ii,key,val){if(key==='qty')tickPkgs[i].items[ii].qty=parseInt(val)||0;else if(key==='cost')tickPkgs[i].items[ii].cost=parseFloat(val)||0;else if(key==='value')tickPkgs[i].items[ii].value=parseFloat(val)||0;else tickPkgs[i].items[ii][key]=val;dirty=true;scheduleAutoSave();calcTickSummary();renderRevSliders();}
function addTickItem(i){tickPkgs[i].items.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}
function removeTickItem(i,ii){tickPkgs[i].items.splice(ii,1);dirty=true;scheduleAutoSave();renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}
function addTickPkg(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[tickPkgs.length%colors.length];var name=prompt('Package name (e.g., Family 4-Pack):');if(!name||!name.trim())return;tickPkgs.push({name:name.trim(),color:c,price:0,items:DEFAULT_TICK_ITEMS.map(function(it){return{name:it.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();renderTickPkgs();}
function removeTickPkg(i){if(!confirm('Delete "'+tickPkgs[i].name+'" package?'))return;tickPkgs.splice(i,1);dirty=true;scheduleAutoSave();renderTickPkgs();}
function calcTickSummary(){var tCost=0,tValue=0,tItems=0;tickPkgs.forEach(function(pk,i){var pkCost=0,pkValue=0,pkItems=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;if(q>0)pkItems++;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});tCost+=pkCost;tValue+=pkValue;tItems+=pkItems;var sub=document.querySelector('#tpk-'+i+' .level-sub');if(sub)sub.textContent=pkItems+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost);});var tpTotal=tickPkgs.reduce(function(s,p){return s+p.price;},0);var tpOff=tpTotal-tCost;document.getElementById('tbPkgs').textContent=tickPkgs.length;document.getElementById('tbItems').textContent=tItems;document.getElementById('tbValue').textContent='$'+fmt(tValue);document.getElementById('tbCost').textContent='$'+fmt(tCost);var oEl=document.getElementById('tbOffset');oEl.textContent=(tpOff>=0?'+$':'-$')+fmt(Math.abs(tpOff));oEl.style.color=tpOff>=0?'#22c55e':'#ef4444';updateMasterKPI();}
var tickDragIdx=null,tickGhost=null;function tickGrab(e,i){e.preventDefault();e.stopPropagation();tickDragIdx=i;var card=document.getElementById('tpk-'+i);card.classList.add('dragging');tickGhost=card.cloneNode(true);tickGhost.classList.remove('dragging');tickGhost.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(tickGhost);document.addEventListener('mousemove',tickMove);document.addEventListener('mouseup',tickRelease);document.addEventListener('touchmove',tickMove,{passive:false});document.addEventListener('touchend',tickRelease);}function tickMove(e){if(tickDragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(tickGhost)tickGhost.style.top=(t.clientY-30)+'px';document.querySelectorAll('#tickArea .level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id.startsWith('tpk-')&&card.id!=='tpk-'+tickDragIdx)card.classList.add('drag-over');}}function tickRelease(e){document.removeEventListener('mousemove',tickMove);document.removeEventListener('mouseup',tickRelease);document.removeEventListener('touchmove',tickMove);document.removeEventListener('touchend',tickRelease);if(tickGhost){document.body.removeChild(tickGhost);tickGhost=null;}if(tickDragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var idx=-1;if(tc){var m=tc.id.match(/tpk-(\d+)/);if(m)idx=parseInt(m[1]);}document.querySelectorAll('#tickArea .level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(idx>=0&&idx!==tickDragIdx){var item=tickPkgs.splice(tickDragIdx,1)[0];tickPkgs.splice(idx,0,item);dirty=true;scheduleAutoSave();renderTickPkgs();}tickDragIdx=null;}
function renderVendorPkgs(){var area=document.getElementById('vendorArea');var h='';vendorPkgs.forEach(function(pk,i){var itemCnt=pk.items.filter(function(it){return it.qty>0;}).length;var pkCost=0,pkValue=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});h+='<div class="level-card" id="vpk-'+i+'"><div class="level-hdr" onclick="toggleVendor('+i+')"><div class="level-drag" onmousedown="vendorGrab(event,'+i+')" ontouchstart="vendorGrab(event,'+i+')"><i></i><i></i><i></i><i></i><i></i><i></i></div><div class="level-dot" style="background:'+pk.color+';"></div><div class="level-info"><div class="level-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div><div class="level-sub">'+itemCnt+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost)+'</div></div><div class="level-price" style="color:'+pk.color+';">$'+fmt(pk.price)+'</div><button class="level-del" onclick="event.stopPropagation();removeVendorPkg('+i+')" title="Delete">&times;</button><span class="level-chv">&#9660;</span></div>';h+='<div class="level-body"><div class="level-inner"><div class="level-meta"><div><div class="lm-label">Package Name</div><input class="lm-input" value="'+esc(pk.name)+'" onchange="updVendor('+i+',\'name\',this.value)"></div><div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(pk.price||'')+'" step="0.01" oninput="updVendor('+i+',\'price\',this.value)"></div><div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+pk.color+'" oninput="updVendor('+i+',\'color\',this.value)"></div></div>';h+='<div class="perks-title"><span>INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Item | Value | Cost</span></div>';pk.items.forEach(function(it,ii){h+='<div class="perk-row"><input type="number" class="perk-qty" value="'+(it.qty||0)+'" min="0" oninput="updVendorItem('+i+','+ii+',\'qty\',this.value)"><input type="text" class="perk-name" value="'+esc(it.name)+'" onchange="updVendorItem('+i+','+ii+',\'name\',this.value)" placeholder="Item name"><input type="number" class="perk-value" value="'+(it.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updVendorItem('+i+','+ii+',\'value\',this.value)"><input type="number" class="perk-cost" value="'+(it.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updVendorItem('+i+','+ii+',\'cost\',this.value)"><button class="perk-del" onclick="removeVendorItem('+i+','+ii+')">&times;</button></div>';});h+='<button class="add-perk-btn" onclick="addVendorItem('+i+')">+ Add Item</button></div></div></div>';});area.innerHTML=h;calcVendorSummary();renderRevSliders();}
function toggleVendor(i){var c=document.getElementById('vpk-'+i);if(c){var w=c.classList.contains('expanded');c.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function updVendor(i,key,val){if(key==='price')vendorPkgs[i].price=parseFloat(val)||0;else if(key==='color')vendorPkgs[i].color=val;else vendorPkgs[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#vpk-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(vendorPkgs[i].price);calcVendorSummary();renderRevSliders();}else{renderVendorPkgs();var c=document.getElementById('vpk-'+i);if(c)c.classList.add('expanded');}}
function updVendorItem(i,ii,key,val){if(key==='qty')vendorPkgs[i].items[ii].qty=parseInt(val)||0;else if(key==='cost')vendorPkgs[i].items[ii].cost=parseFloat(val)||0;else if(key==='value')vendorPkgs[i].items[ii].value=parseFloat(val)||0;else vendorPkgs[i].items[ii][key]=val;dirty=true;scheduleAutoSave();calcVendorSummary();renderRevSliders();}
function addVendorItem(i){vendorPkgs[i].items.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();renderVendorPkgs();var c=document.getElementById('vpk-'+i);if(c)c.classList.add('expanded');}
function removeVendorItem(i,ii){vendorPkgs[i].items.splice(ii,1);dirty=true;scheduleAutoSave();renderVendorPkgs();var c=document.getElementById('vpk-'+i);if(c)c.classList.add('expanded');}
function addVendorPkg(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[vendorPkgs.length%colors.length];var name=prompt('Package name (e.g., Food Truck, Merch Vendor):');if(!name||!name.trim())return;vendorPkgs.push({name:name.trim(),color:c,price:0,items:DEFAULT_VENDOR_ITEMS.map(function(it){return{name:it.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();renderVendorPkgs();}
function removeVendorPkg(i){if(!confirm('Delete "'+vendorPkgs[i].name+'" package?'))return;vendorPkgs.splice(i,1);dirty=true;scheduleAutoSave();renderVendorPkgs();}
function calcVendorSummary(){var tCost=0,tValue=0,tItems=0;vendorPkgs.forEach(function(pk,i){var pkCost=0,pkValue=0,pkItems=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;if(q>0)pkItems++;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});tCost+=pkCost;tValue+=pkValue;tItems+=pkItems;var sub=document.querySelector('#vpk-'+i+' .level-sub');if(sub)sub.textContent=pkItems+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost);});var vpTotal=vendorPkgs.reduce(function(s,p){return s+p.price;},0);var vpOff=vpTotal-tCost;document.getElementById('vbPkgs').textContent=vendorPkgs.length;document.getElementById('vbItems').textContent=tItems;document.getElementById('vbValue').textContent='$'+fmt(tValue);document.getElementById('vbCost').textContent='$'+fmt(tCost);var oEl=document.getElementById('vbOffset');oEl.textContent=(vpOff>=0?'+$':'-$')+fmt(Math.abs(vpOff));oEl.style.color=vpOff>=0?'#22c55e':'#ef4444';updateMasterKPI();}
var vendorDragIdx=null,vendorGhostEl=null;function vendorGrab(e,i){e.preventDefault();e.stopPropagation();vendorDragIdx=i;var card=document.getElementById('vpk-'+i);card.classList.add('dragging');vendorGhostEl=card.cloneNode(true);vendorGhostEl.classList.remove('dragging');vendorGhostEl.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(vendorGhostEl);document.addEventListener('mousemove',vendorMove);document.addEventListener('mouseup',vendorRelease);document.addEventListener('touchmove',vendorMove,{passive:false});document.addEventListener('touchend',vendorRelease);}function vendorMove(e){if(vendorDragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(vendorGhostEl)vendorGhostEl.style.top=(t.clientY-30)+'px';document.querySelectorAll('#vendorArea .level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id.startsWith('vpk-')&&card.id!=='vpk-'+vendorDragIdx)card.classList.add('drag-over');}}function vendorRelease(e){document.removeEventListener('mousemove',vendorMove);document.removeEventListener('mouseup',vendorRelease);document.removeEventListener('touchmove',vendorMove);document.removeEventListener('touchend',vendorRelease);if(vendorGhostEl){document.body.removeChild(vendorGhostEl);vendorGhostEl=null;}if(vendorDragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var idx=-1;if(tc){var m=tc.id.match(/vpk-(\d+)/);if(m)idx=parseInt(m[1]);}document.querySelectorAll('#vendorArea .level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(idx>=0&&idx!==vendorDragIdx){var item=vendorPkgs.splice(vendorDragIdx,1)[0];vendorPkgs.splice(idx,0,item);dirty=true;scheduleAutoSave();renderVendorPkgs();}vendorDragIdx=null;}
function renderCampingPkgs(){var area=document.getElementById('campingArea');var h='';campingPkgs.forEach(function(pk,i){var itemCnt=pk.items.filter(function(it){return it.qty>0;}).length;var pkCost=0,pkValue=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});h+='<div class="level-card" id="cpk-'+i+'"><div class="level-hdr" onclick="toggleCamping('+i+')"><div class="level-drag" onmousedown="campingGrab(event,'+i+')" ontouchstart="campingGrab(event,'+i+')"><i></i><i></i><i></i><i></i><i></i><i></i></div><div class="level-dot" style="background:'+pk.color+';"></div><div class="level-info"><div class="level-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div><div class="level-sub">'+itemCnt+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost)+'</div></div><div class="level-price" style="color:'+pk.color+';">$'+fmt(pk.price)+'</div><button class="level-del" onclick="event.stopPropagation();removeCampingPkg('+i+')" title="Delete">&times;</button><span class="level-chv">&#9660;</span></div>';h+='<div class="level-body"><div class="level-inner"><div class="level-meta"><div><div class="lm-label">Package Name</div><input class="lm-input" value="'+esc(pk.name)+'" onchange="updCamping('+i+',\'name\',this.value)"></div><div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(pk.price||'')+'" step="0.01" oninput="updCamping('+i+',\'price\',this.value)"></div><div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+pk.color+'" oninput="updCamping('+i+',\'color\',this.value)"></div></div>';h+='<div class="perks-title"><span>INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Item | Value | Cost</span></div>';pk.items.forEach(function(it,ii){h+='<div class="perk-row"><input type="number" class="perk-qty" value="'+(it.qty||0)+'" min="0" oninput="updCampingItem('+i+','+ii+',\'qty\',this.value)"><input type="text" class="perk-name" value="'+esc(it.name)+'" onchange="updCampingItem('+i+','+ii+',\'name\',this.value)" placeholder="Item name"><input type="number" class="perk-value" value="'+(it.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updCampingItem('+i+','+ii+',\'value\',this.value)"><input type="number" class="perk-cost" value="'+(it.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updCampingItem('+i+','+ii+',\'cost\',this.value)"><button class="perk-del" onclick="removeCampingItem('+i+','+ii+')">&times;</button></div>';});h+='<button class="add-perk-btn" onclick="addCampingItem('+i+')">+ Add Item</button></div></div></div>';});area.innerHTML=h;calcCampingSummary();renderRevSliders();}
function toggleCamping(i){var c=document.getElementById('cpk-'+i);if(c){var w=c.classList.contains('expanded');c.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function updCamping(i,key,val){if(key==='price')campingPkgs[i].price=parseFloat(val)||0;else if(key==='color')campingPkgs[i].color=val;else campingPkgs[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#cpk-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(campingPkgs[i].price);calcCampingSummary();renderRevSliders();}else{renderCampingPkgs();var c=document.getElementById('cpk-'+i);if(c)c.classList.add('expanded');}}
function updCampingItem(i,ii,key,val){if(key==='qty')campingPkgs[i].items[ii].qty=parseInt(val)||0;else if(key==='cost')campingPkgs[i].items[ii].cost=parseFloat(val)||0;else if(key==='value')campingPkgs[i].items[ii].value=parseFloat(val)||0;else campingPkgs[i].items[ii][key]=val;dirty=true;scheduleAutoSave();calcCampingSummary();renderRevSliders();}
function addCampingItem(i){campingPkgs[i].items.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();renderCampingPkgs();var c=document.getElementById('cpk-'+i);if(c)c.classList.add('expanded');}
function removeCampingItem(i,ii){campingPkgs[i].items.splice(ii,1);dirty=true;scheduleAutoSave();renderCampingPkgs();var c=document.getElementById('cpk-'+i);if(c)c.classList.add('expanded');}
function addCampingPkg(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[campingPkgs.length%colors.length];var name=prompt('Package name (e.g., Tent Only, Glamping):');if(!name||!name.trim())return;campingPkgs.push({name:name.trim(),color:c,price:0,items:DEFAULT_CAMPING_ITEMS.map(function(it){return{name:it.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();renderCampingPkgs();}
function removeCampingPkg(i){if(!confirm('Delete "'+campingPkgs[i].name+'" package?'))return;campingPkgs.splice(i,1);dirty=true;scheduleAutoSave();renderCampingPkgs();}
function calcCampingSummary(){var tCost=0,tValue=0,tItems=0;campingPkgs.forEach(function(pk,i){var pkCost=0,pkValue=0,pkItems=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;if(q>0)pkItems++;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});tCost+=pkCost;tValue+=pkValue;tItems+=pkItems;var sub=document.querySelector('#cpk-'+i+' .level-sub');if(sub)sub.textContent=pkItems+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost);});var cpTotal=campingPkgs.reduce(function(s,p){return s+p.price;},0);var cpOff=cpTotal-tCost;document.getElementById('cbPkgs').textContent=campingPkgs.length;document.getElementById('cbItems').textContent=tItems;document.getElementById('cbValue').textContent='$'+fmt(tValue);document.getElementById('cbCost').textContent='$'+fmt(tCost);var oEl=document.getElementById('cbOffset');oEl.textContent=(cpOff>=0?'+$':'-$')+fmt(Math.abs(cpOff));oEl.style.color=cpOff>=0?'#22c55e':'#ef4444';updateMasterKPI();}
var campingDragIdx=null,campingGhostEl=null;function campingGrab(e,i){e.preventDefault();e.stopPropagation();campingDragIdx=i;var card=document.getElementById('cpk-'+i);card.classList.add('dragging');campingGhostEl=card.cloneNode(true);campingGhostEl.classList.remove('dragging');campingGhostEl.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(campingGhostEl);document.addEventListener('mousemove',campingMove);document.addEventListener('mouseup',campingRelease);document.addEventListener('touchmove',campingMove,{passive:false});document.addEventListener('touchend',campingRelease);}function campingMove(e){if(campingDragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(campingGhostEl)campingGhostEl.style.top=(t.clientY-30)+'px';document.querySelectorAll('#campingArea .level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id.startsWith('cpk-')&&card.id!=='cpk-'+campingDragIdx)card.classList.add('drag-over');}}function campingRelease(e){document.removeEventListener('mousemove',campingMove);document.removeEventListener('mouseup',campingRelease);document.removeEventListener('touchmove',campingMove);document.removeEventListener('touchend',campingRelease);if(campingGhostEl){document.body.removeChild(campingGhostEl);campingGhostEl=null;}if(campingDragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var idx=-1;if(tc){var m=tc.id.match(/cpk-(\d+)/);if(m)idx=parseInt(m[1]);}document.querySelectorAll('#campingArea .level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(idx>=0&&idx!==campingDragIdx){var item=campingPkgs.splice(campingDragIdx,1)[0];campingPkgs.splice(idx,0,item);dirty=true;scheduleAutoSave();renderCampingPkgs();}campingDragIdx=null;}
var revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};var revSectionOrder=['sponsor','ticket','vendor','camping'];
function renderRevSliders(){var area=document.getElementById('revSliders');var h='';while(revData.sponsor.length<levels.length)revData.sponsor.push(0);if(revData.sponsor.length>levels.length)revData.sponsor.length=levels.length;while(revData.ticket.length<tickPkgs.length)revData.ticket.push(0);if(revData.ticket.length>tickPkgs.length)revData.ticket.length=tickPkgs.length;while(revData.vendor.length<vendorPkgs.length)revData.vendor.push(0);if(revData.vendor.length>vendorPkgs.length)revData.vendor.length=vendorPkgs.length;while(revData.camping.length<campingPkgs.length)revData.camping.push(0);if(revData.camping.length>campingPkgs.length)revData.camping.length=campingPkgs.length;while(revData.sponsorActual.length<levels.length)revData.sponsorActual.push(0);if(revData.sponsorActual.length>levels.length)revData.sponsorActual.length=levels.length;while(revData.ticketActual.length<tickPkgs.length)revData.ticketActual.push(0);if(revData.ticketActual.length>tickPkgs.length)revData.ticketActual.length=tickPkgs.length;while(revData.vendorActual.length<vendorPkgs.length)revData.vendorActual.push(0);if(revData.vendorActual.length>vendorPkgs.length)revData.vendorActual.length=vendorPkgs.length;while(revData.campingActual.length<campingPkgs.length)revData.campingActual.push(0);if(revData.campingActual.length>campingPkgs.length)revData.campingActual.length=campingPkgs.length;if(!levels.length&&!tickPkgs.length&&!vendorPkgs.length&&!campingPkgs.length){area.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-secondary);font-size:13px;">Add packages above to estimate revenue</div>';calcRev();return;}var secDefs={ticket:{label:'Ticket Packages',items:tickPkgs,data:'ticket',maxQ:500,ticks:['0','125','250','375','500']},vendor:{label:'Vendor Packages',items:vendorPkgs,data:'vendor',maxQ:50,ticks:['0','12','25','37','50']},camping:{label:'Camping Packages',items:campingPkgs,data:'camping',maxQ:200,ticks:['0','50','100','150','200']},sponsor:{label:'Sponsor Levels',items:levels,data:'sponsor',maxQ:3,ticks:['0','1','2','3']}};revSectionOrder.forEach(function(secKey){var sec=secDefs[secKey];if(!sec||!sec.items.length)return;var secGoal=0,secActual=0;sec.items.forEach(function(p,i){secGoal+=(revData[sec.data][i]||0);secActual+=(revData[sec.data+'Actual'][i]||0);});h+='<div class="rev-section" data-rev-sec="'+secKey+'" id="revSec-'+secKey+'"><div class="rev-section-hdr"><div class="rev-section-drag" onmousedown="revSecGrab(event,\''+secKey+'\')" ontouchstart="revSecGrab(event,\''+secKey+'\')"><i></i><i></i><i></i><i></i><i></i><i></i></div><div class="rev-section-label">'+sec.label+'</div><div class="rev-section-stats">'+secActual+' / '+secGoal+' sold</div></div>';sec.items.forEach(function(pk,i){var qty=revData[sec.data][i]||0;var act=revData[sec.data+'Actual'][i]||0;var pkCost=0;var itemsArr=secKey==='sponsor'?pk.perks:pk.items;if(itemsArr)itemsArr.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});var mQ=secKey==='sponsor'?((pk.name.toLowerCase().indexOf('foundation')>=0)?100:sec.maxQ):sec.maxQ;var tks=secKey==='sponsor'?((pk.name.toLowerCase().indexOf('foundation')>=0)?['0','25','50','75','100']:sec.ticks):sec.ticks;var pct=Math.min(100,Math.round(qty/mQ*100));var actPct=Math.min(100,Math.round(act/mQ*100));h+='<div class="rev-slider-row" data-type="'+sec.data+'" data-idx="'+i+'" style="padding:8px 12px;"><div class="rev-slider-left"><div class="rev-slider-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div><div class="rev-slider-price">$'+fmt(pk.price)+' ea · $'+fmt(pkCost)+' cost</div></div>';h+='<div class="rev-slider-mid"><div class="rev-range-wrap"><input type="range" class="rev-range" min="0" max="'+mQ+'" value="'+qty+'" oninput="setRevQty(\''+sec.data+'\','+i+',this.value)" style="background:linear-gradient(to right,'+pk.color+' '+pct+'%,var(--border) '+pct+'%);">';if(act>0){h+='<div class="rev-actual-marker" style="left:'+actPct+'%;"></div><div class="rev-actual-label" style="left:'+actPct+'%;">'+act+'</div>';}h+='</div><div class="rev-ticks">';tks.forEach(function(t){h+='<span class="rev-tick">'+t+'</span>';});h+='</div></div>';h+='<div class="rev-slider-right"><div class="rev-qty-row"><div class="rev-input-col"><input type="number" class="rev-qty-input" value="'+qty+'" min="0" oninput="setRevQty(\''+sec.data+'\','+i+',this.value)" style="border-color:'+pk.color+';"><div class="rev-input-lbl">Goal</div></div>';h+='<div class="rev-input-col"><input type="number" class="rev-actual-input" value="'+(act||'')+'" min="0" oninput="setRevActual(\''+sec.data+'\','+i+',this.value)" placeholder="0"><div class="rev-input-lbl">Actual</div></div></div>';h+='<div class="rev-subtotal">'+act+' / '+qty+'</div>';h+='<div class="rev-bar"><div class="rev-bar-fill" style="width:'+pct+'%;background:'+pk.color+';"></div></div>';if(qty>0){var aP=Math.min(100,Math.round(act/qty*100));h+='<div class="rev-bar" style="margin-top:2px;"><div class="rev-bar-fill" style="width:'+aP+'%;background:var(--accent);opacity:.5;"></div></div>';}h+='</div></div>';});h+='</div>';});area.innerHTML=h;calcRev();}
var revSecDragKey=null,revSecGhostEl=null;function revSecGrab(e,key){e.preventDefault();e.stopPropagation();revSecDragKey=key;var el=document.getElementById('revSec-'+key);el.classList.add('dragging');revSecGhostEl=el.cloneNode(true);revSecGhostEl.classList.remove('dragging');revSecGhostEl.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent);border-radius:8px;top:'+(el.getBoundingClientRect().top)+'px;';document.body.appendChild(revSecGhostEl);document.addEventListener('mousemove',revSecMove);document.addEventListener('mouseup',revSecRelease);document.addEventListener('touchmove',revSecMove,{passive:false});document.addEventListener('touchend',revSecRelease);}function revSecMove(e){if(!revSecDragKey)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(revSecGhostEl)revSecGhostEl.style.top=(t.clientY-30)+'px';document.querySelectorAll('.rev-section').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var sec=el.closest('.rev-section');if(sec&&sec.dataset.revSec!==revSecDragKey)sec.classList.add('drag-over');}}function revSecRelease(e){document.removeEventListener('mousemove',revSecMove);document.removeEventListener('mouseup',revSecRelease);document.removeEventListener('touchmove',revSecMove);document.removeEventListener('touchend',revSecRelease);if(revSecGhostEl){document.body.removeChild(revSecGhostEl);revSecGhostEl=null;}if(!revSecDragKey)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tgt=el?el.closest('.rev-section'):null;document.querySelectorAll('.rev-section').forEach(function(c){c.classList.remove('dragging','drag-over');});if(tgt&&tgt.dataset.revSec!==revSecDragKey){var fromIdx=revSectionOrder.indexOf(revSecDragKey);var toIdx=revSectionOrder.indexOf(tgt.dataset.revSec);if(fromIdx>=0&&toIdx>=0){revSectionOrder.splice(fromIdx,1);revSectionOrder.splice(toIdx,0,revSecDragKey);dirty=true;scheduleAutoSave();renderRevSliders();}}revSecDragKey=null;}
function setRevQty(type,i,val){var v=parseInt(val)||0;if(v<0)v=0;revData[type][i]=v;var items=type==='sponsor'?levels:(type==='ticket'?tickPkgs:(type==='vendor'?vendorPkgs:campingPkgs));var item=items[i];var color=item.color;var maxQ;if(type==='ticket')maxQ=500;else if(type==='vendor')maxQ=50;else if(type==='camping')maxQ=200;else maxQ=(item.name.toLowerCase().indexOf('foundation')>=0)?100:3;var pct=Math.min(100,Math.round(v/maxQ*100));var rows=document.querySelectorAll('.rev-slider-row[data-type="'+type+'"][data-idx="'+i+'"]');if(rows.length){var row=rows[0];var range=row.querySelector('.rev-range');var input=row.querySelector('.rev-qty-input');var subEl=row.querySelector('.rev-subtotal');var fill=row.querySelector('.rev-bar-fill');if(range){range.style.background='linear-gradient(to right,'+color+' '+pct+'%,var(--border) '+pct+'%)';if(range!==document.activeElement)range.value=v;}if(input&&input!==document.activeElement)input.value=v;if(subEl)subEl.textContent=v+' / '+v;if(fill){fill.style.width=pct+'%';fill.style.background=color;}}dirty=true;scheduleAutoSave();calcRev();}
function setRevActual(type,i,val){var v=parseInt(val)||0;if(v<0)v=0;revData[type+'Actual'][i]=v;dirty=true;scheduleAutoSave();renderRevSliders();}
function calcRev(){var goalQty=0,actualQty=0;var deptGoal={sponsor:0,ticket:0,vendor:0,camping:0};var deptActual={sponsor:0,ticket:0,vendor:0,camping:0};levels.forEach(function(lv,i){var g=revData.sponsor[i]||0;var a=revData.sponsorActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.sponsor+=g;deptActual.sponsor+=a;});tickPkgs.forEach(function(pk,i){var g=revData.ticket[i]||0;var a=revData.ticketActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.ticket+=g;deptActual.ticket+=a;});vendorPkgs.forEach(function(pk,i){var g=revData.vendor[i]||0;var a=revData.vendorActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.vendor+=g;deptActual.vendor+=a;});campingPkgs.forEach(function(pk,i){var g=revData.camping[i]||0;var a=revData.campingActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.camping+=g;deptActual.camping+=a;});var pctSold=goalQty>0?Math.round(actualQty/goalQty*100):0;var remaining=Math.max(0,goalQty-actualQty);document.getElementById('revGoalQty').textContent=fmt(goalQty);document.getElementById('revActualQty').textContent=fmt(actualQty);document.getElementById('revPctSold').textContent=pctSold+'%';document.getElementById('revPctSold').style.color=pctSold>=100?'#22c55e':pctSold>=50?'#f59e0b':'var(--text-primary)';document.getElementById('revRemaining').textContent=fmt(remaining);document.getElementById('revRemaining').style.color=remaining===0?'#22c55e':'#f59e0b';document.getElementById('revSponsorQty').textContent=deptActual.sponsor+' / '+deptGoal.sponsor;document.getElementById('revSponsorQty').style.color=deptActual.sponsor>=deptGoal.sponsor&&deptGoal.sponsor>0?'#22c55e':'var(--text-primary)';document.getElementById('revTicketQty').textContent=deptActual.ticket+' / '+deptGoal.ticket;document.getElementById('revTicketQty').style.color=deptActual.ticket>=deptGoal.ticket&&deptGoal.ticket>0?'#22c55e':'var(--text-primary)';document.getElementById('revVendorQty').textContent=deptActual.vendor+' / '+deptGoal.vendor;document.getElementById('revVendorQty').style.color=deptActual.vendor>=deptGoal.vendor&&deptGoal.vendor>0?'#22c55e':'var(--text-primary)';document.getElementById('revCampingQty').textContent=deptActual.camping+' / '+deptGoal.camping;document.getElementById('revCampingQty').style.color=deptActual.camping>=deptGoal.camping&&deptGoal.camping>0?'#22c55e':'var(--text-primary)';updateMasterKPI();}
var userRole='manager',viewMode='editor';async function detectRole(){try{var r=await sb.from('event_members').select('role_level').eq('tenant_id',tenantId).eq('email',(await sb.auth.getSession()).data.session.user.email).single();if(r.data)userRole=r.data.role_level||'manager';}catch(e){}}
function setViewMode(mode){viewMode=mode;document.querySelectorAll('.view-tab').forEach(function(t){t.classList.remove('active');var txt=t.textContent.toLowerCase();if((mode==='editor'&&txt.indexOf('my')>=0)||(mode==='review'&&txt.indexOf('review')>=0)||(mode==='official'&&txt.indexOf('official')>=0))t.classList.add('active');});document.getElementById('reviewPanel').classList.toggle('show',mode==='review');document.getElementById('officialView').style.display=mode==='official'?'':'none';if(mode==='editor'){document.getElementById('editorView').style.display='';exitReadOnly();}else if(mode==='official'){loadOfficialSheet();}else{document.getElementById('editorView').style.display='none';}if(mode==='review')renderReviewBoard();updateActionButtons();}
function updateActionButtons(){var s=currentSheetId&&currentSheetId!=='preloaded'?allSheets.find(function(e){return e.sheet_id===currentSheetId;}):null;var isMine=s&&s.created_by===userId;var isAdm=userRole==='admin';var status=s?s.status||'draft':'draft';document.getElementById('deskDelBtn').style.display=isMine?'':'none';document.getElementById('mobDelBtn').style.display=isMine?'':'none';var canSubmit=isMine&&status==='draft';document.getElementById('deskSubmitBtn').style.display=canSubmit?'':'none';document.getElementById('mobSubmitBtn').style.display=canSubmit?'':'none';var canPublish=isAdm&&s;document.getElementById('deskPublishBtn').style.display=canPublish?'':'none';document.getElementById('mobPublishBtn').style.display=canPublish?'':'none';}
async function submitForReview(){if(!currentSheetId||currentSheetId==='preloaded')return;await saveToDb(true);var uName=(await sb.auth.getSession()).data.session.user.email||'Unknown';var r=await sb.from('sponsor_sheets').update({status:'submitted',submitted_at:new Date().toISOString(),submitted_by_name:uName}).eq('sheet_id',currentSheetId);if(r.error){toast('Error submitting');return;}var s=allSheets.find(function(e){return e.sheet_id===currentSheetId;});if(s){s.status='submitted';s.submitted_by_name=uName;}toast('Submitted for review!');updateActionButtons();updateReviewCounts();}
async function publishSheet(sheetId){var id=sheetId||currentSheetId;if(!id||id==='preloaded')return;if(!confirm('Publish this sheet as the Official Budget?'))return;await sb.from('sponsor_sheets').update({status:'draft'}).eq('tenant_id',tenantId).eq('status','published');var uName=(await sb.auth.getSession()).data.session.user.email||'Unknown';var now=new Date().toISOString();var sheet=allSheets.find(function(s){return s.sheet_id===id;});var sheetName=sheet?sheet.sheet_name:'Untitled';await sb.from('sponsor_sheets').update({status:'published',published_by:userId,published_at:now,submitted_by_name:uName}).eq('sheet_id',id);await sb.from('publish_history').insert({tenant_id:tenantId,sheet_id:id,sheet_name:sheetName,published_by:userId,published_by_name:uName,published_at:now,page_type:'sponsors'});await loadSheets();renderSelects();updateActionButtons();updateReviewCounts();toast('Published as Official!');if(viewMode==='review')renderReviewBoard();}
async function renderPublishLog(){var area=document.getElementById('publishLogRows');var r=await sb.from('publish_history').select('*').eq('tenant_id',tenantId).eq('page_type','sponsors').order('published_at',{ascending:false}).limit(20);var rows=r.data||[];if(!rows.length){area.innerHTML='<div style="font-size:12px;color:var(--text-secondary);padding:8px 0;">No publish history yet.</div>';return;}area.innerHTML=rows.map(function(row){var d=new Date(row.published_at);return '<div class="publish-log-row"><div class="publish-log-dot"></div><div class="publish-log-name">'+esc(row.sheet_name||'Untitled')+'</div><div class="publish-log-by">'+esc(row.published_by_name||'Unknown')+'</div><div class="publish-log-date">'+d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+'</div></div>';}).join('');}
async function unpublishSheet(sheetId){if(!confirm('Unpublish this sheet?'))return;await sb.from('sponsor_sheets').update({status:'submitted'}).eq('sheet_id',sheetId);await loadSheets();renderSelects();updateActionButtons();updateReviewCounts();toast('Unpublished');if(viewMode==='review')renderReviewBoard();}
async function voteOnSheet(sheetId,vote){var existing=await sb.from('sheet_votes').select('*').eq('sheet_id',sheetId).eq('user_id',userId).single();if(existing.data){if(existing.data.vote===vote)await sb.from('sheet_votes').delete().eq('vote_id',existing.data.vote_id);else await sb.from('sheet_votes').update({vote:vote}).eq('vote_id',existing.data.vote_id);}else{await sb.from('sheet_votes').insert({sheet_id:sheetId,tenant_id:tenantId,user_id:userId,vote:vote});}renderReviewBoard();}
async function renderReviewBoard(){var submitted=allSheets.filter(function(s){return s.status==='submitted'||s.status==='published';});var area=document.getElementById('reviewCards');var empty=document.getElementById('reviewEmpty');if(!submitted.length){area.innerHTML='';empty.style.display='';updateReviewCounts();return;}empty.style.display='none';var ids=submitted.map(function(s){return s.sheet_id;});var vr=await sb.from('sheet_votes').select('*').in('sheet_id',ids);var votes=vr.data||[];var myVotes={};votes.forEach(function(v){if(v.user_id===userId)myVotes[v.sheet_id]=v.vote;});var scores={};ids.forEach(function(id){scores[id]=0;});votes.forEach(function(v){scores[v.sheet_id]=(scores[v.sheet_id]||0)+v.vote;});submitted.sort(function(a,b){if(a.status==='published'&&b.status!=='published')return -1;if(b.status==='published'&&a.status!=='published')return 1;return(scores[b.sheet_id]||0)-(scores[a.sheet_id]||0);});var isAdm=userRole==='admin';area.innerHTML=submitted.map(function(s){var score=scores[s.sheet_id]||0;var myVote=myVotes[s.sheet_id]||0;var isPub=s.status==='published';var when=s.submitted_at?new Date(s.submitted_at).toLocaleDateString():'';return '<div class="review-card'+(isPub?' published':'')+'"><div class="review-vote"><button class="vote-btn'+(myVote===1?' voted-up':'')+'" onclick="voteOnSheet(\''+s.sheet_id+'\',1)">▲</button><div class="vote-score"'+(score>0?' style="color:#22c55e"':score<0?' style="color:#ef4444"':'')+'>'+score+'</div><button class="vote-btn'+(myVote===-1?' voted-down':'')+'" onclick="voteOnSheet(\''+s.sheet_id+'\',-1)">▼</button></div><div class="review-info"><div class="review-name">'+esc(s.sheet_name||'Untitled')+' <span class="status-badge status-'+(s.status||'draft')+'">'+(isPub?'★ OFFICIAL':s.status||'draft')+'</span></div><div class="review-meta">by '+esc(s.submitted_by_name||'Unknown')+' · '+when+'</div></div><div class="review-actions"><button class="hdr-btn" onclick="syncSel(\''+s.sheet_id+'\');setViewMode(\'editor\')" style="font-size:11px;padding:5px 10px;">View</button>'+(isAdm&&!isPub?'<button class="hdr-btn publish" onclick="publishSheet(\''+s.sheet_id+'\')" style="font-size:11px;padding:5px 10px;">Publish</button>':'')+(isAdm&&isPub?'<button class="hdr-btn danger" onclick="unpublishSheet(\''+s.sheet_id+'\')" style="font-size:11px;padding:5px 10px;">Unpublish</button>':'')+'</div></div>';}).join('');updateReviewCounts();}
function updateReviewCounts(){var count=allSheets.filter(function(s){return s.status==='submitted';}).length;var el1=document.getElementById('deskReviewCount');var el2=document.getElementById('mobReviewCount');if(el1)el1.textContent=count;if(el2)el2.textContent=count;}
async function loadOfficialSheet(){var pub=allSheets.find(function(s){return s.status==='published';});var editor=document.getElementById('editorView');renderPublishLog();if(!pub){document.getElementById('officialMeta').textContent='No official budget published yet. Submit your sheet for review!';editor.style.display='none';return;}syncSel(pub.sheet_id);var when=pub.published_at?new Date(pub.published_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';document.getElementById('officialMeta').textContent='Published by '+(pub.submitted_by_name||'Admin')+' on '+when;editor.style.display='';editor.classList.add('readonly-overlay');setTimeout(function(){editor.querySelectorAll('input,select,button,textarea').forEach(function(el){el.disabled=true;});},100);}
function exitReadOnly(){document.getElementById('editorView').classList.remove('readonly-overlay');document.getElementById('editorView').querySelectorAll('input,select,button,textarea').forEach(function(el){el.disabled=false;});}
function printSheet(){var sheetName=document.getElementById('sheetName').value||'Sponsor Sheet';var eventDate=document.getElementById('sheetEvent').value||'';var venue=document.getElementById('sheetVenue').value||'';var sub=[];if(eventDate)sub.push(eventDate);if(venue)sub.push(venue);sub.push('Printed '+new Date().toLocaleDateString());document.getElementById('printTitle').textContent=sheetName;document.getElementById('printSub').textContent=sub.join(' · ');document.querySelectorAll('.section-wrap').forEach(function(w){w.classList.add('open');});document.querySelectorAll('.section-chv').forEach(function(c){c.textContent='▾';});document.querySelectorAll('.level-card').forEach(function(c){c.classList.add('expanded');});setTimeout(function(){window.print();},200);}
async function init(){var s=await checkAuth();if(!s)return;userId=s.user.id;var email=s.user.email||'';if(email){var ur=await sb.from('users').select('tenant_id,user_id').eq('email',email).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}}if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}if(!tenantId){toast('Could not determine tenant');return;}await ensureTables();await ensureValueColumns();await detectRole();await loadSheets();renderSelects();updateReviewCounts();updateActionButtons();var lastId=localStorage.getItem('elp-last-sponsor');if(lastId&&(lastId==='preloaded'||allSheets.find(function(s){return s.sheet_id===lastId;}))){syncSel(lastId);}else{loadPreloaded();}}
init();
window.addEventListener('beforeunload',function(){if(dirty&&currentSheetId&&currentSheetId!=='preloaded'){navigator.sendBeacon||autoSave();}});
document.addEventListener('visibilitychange',function(){if(document.hidden&&dirty)autoSave();});
</script>
</body>
</html>
