<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Admin - GlowBots</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0b0f14;
      color: #e8eef6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-bottom: 1px solid #223044;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo {
      font-size: 28px;
    }
    .header-title {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header-badge {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .admin-email {
      color: #9fb0c3;
      font-size: 14px;
    }
    .logout-btn {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid #ef4444;
      color: #ef4444;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .logout-btn:hover {
      background: #ef4444;
      color: #fff;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    /* Welcome Section */
    .welcome-section {
      background: linear-gradient(135deg, #1a2535 0%, #0f1621 100%);
      border: 1px solid #223044;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 32px;
      position: relative;
      overflow: hidden;
    }
    .welcome-section::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      clip-path: polygon(30% 0, 100% 0, 100% 100%, 0% 100%);
    }
    .welcome-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      position: relative;
    }
    .welcome-subtitle {
      color: #9fb0c3;
      font-size: 16px;
      position: relative;
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: #1a2535;
      border: 1px solid #223044;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }
    .stat-card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
    }
    .stat-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #3b82f6;
    }
    .stat-label {
      font-size: 13px;
      color: #9fb0c3;
      margin-top: 4px;
    }

    /* Section */
    .section {
      margin-bottom: 32px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #e8eef6;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title span {
      font-size: 20px;
    }

    /* Admin Tools Grid */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .tool-card {
      background: #1a2535;
      border: 1px solid #223044;
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .tool-card:hover {
      border-color: #3b82f6;
      transform: translateY(-4px);
      box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15);
    }
    .tool-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 16px;
    }
    .tool-icon.blue { background: rgba(59, 130, 246, 0.15); }
    .tool-icon.purple { background: rgba(139, 92, 246, 0.15); }
    .tool-icon.green { background: rgba(34, 197, 94, 0.15); }
    .tool-icon.orange { background: rgba(251, 146, 60, 0.15); }
    .tool-icon.red { background: rgba(239, 68, 68, 0.15); }
    .tool-icon.teal { background: rgba(20, 184, 166, 0.15); }
    .tool-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .tool-description {
      font-size: 14px;
      color: #9fb0c3;
      line-height: 1.5;
    }
    .tool-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 12px;
      text-transform: uppercase;
    }
    .tool-badge.new { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .tool-badge.important { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #223044;
    }
    .quick-btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid #223044;
      background: #0f1621;
      color: #e8eef6;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    .quick-btn:hover {
      background: #1a2535;
      border-color: #3b82f6;
    }
    .quick-btn.primary {
      background: #3b82f6;
      border-color: #3b82f6;
    }
    .quick-btn.primary:hover {
      background: #2563eb;
    }

    /* Recent Activity */
    .activity-list {
      background: #1a2535;
      border: 1px solid #223044;
      border-radius: 12px;
      overflow: hidden;
    }
    .activity-item {
      padding: 16px 20px;
      border-bottom: 1px solid #223044;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .activity-item:last-child {
      border-bottom: none;
    }
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: rgba(59, 130, 246, 0.1);
    }
    .activity-content {
      flex: 1;
    }
    .activity-text {
      font-size: 14px;
    }
    .activity-time {
      font-size: 12px;
      color: #9fb0c3;
      margin-top: 2px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      .welcome-title {
        font-size: 24px;
      }
      .tools-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <span class="header-logo">ü§ñ</span>
    <span class="header-title">GlowBots System Admin</span>
    <span class="header-badge">Super Admin</span>
  </div>
  <div class="header-right">
    <span class="admin-email" id="adminEmail">Loading...</span>
    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
  </div>
</div>

<div class="container">
  <!-- Welcome Section -->
  <div class="welcome-section">
    <div class="welcome-title">üëã Welcome, Super Admin</div>
    <div class="welcome-subtitle">Full system access to all tenants, support tickets, and database tools</div>
  </div>

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon">üè¢</div>
      <div class="stat-value" id="statTenants">-</div>
      <div class="stat-label">Total Tenants</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üë•</div>
      <div class="stat-value" id="statUsers">-</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üé´</div>
      <div class="stat-value" id="statTickets">-</div>
      <div class="stat-label">Open Tickets</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-value" id="statEvents">-</div>
      <div class="stat-label">Total Events</div>
    </div>
  </div>

  <!-- Admin Tools -->
  <div class="section">
    <div class="section-title"><span>üõ†Ô∏è</span> Admin Tools</div>
    <div class="tools-grid">
      
      <!-- Support Admin -->
      <a href="support-admin.html" class="tool-card">
        <div class="tool-icon red">üé´</div>
        <div class="tool-title">Support Tickets</div>
        <div class="tool-description">View and manage all support tickets across all tenants. Respond to customers and track issues.</div>
        <span class="tool-badge important">High Priority</span>
      </a>

      <!-- Database Map -->
      <a href="database-map.html" class="tool-card">
        <div class="tool-icon purple">üóÑÔ∏è</div>
        <div class="tool-title">Database Map</div>
        <div class="tool-description">Visual database schema viewer. Explore tables, columns, relationships, and data types.</div>
        <span class="tool-badge new">Developer Tool</span>
      </a>

      <!-- Tenant Management -->
      <a href="tenant-management.html" class="tool-card">
        <div class="tool-icon blue">üè¢</div>
        <div class="tool-title">Tenant Management</div>
        <div class="tool-description">Manage all tenant accounts, subscriptions, and billing. Add or deactivate tenants.</div>
      </a>

      <!-- User Management -->
      <a href="user-management.html" class="tool-card">
        <div class="tool-icon green">üë•</div>
        <div class="tool-title">User Management</div>
        <div class="tool-description">View all users across tenants. Reset passwords, update roles, and manage access.</div>
      </a>

      <!-- Analytics -->
      <a href="analytics.html" class="tool-card">
        <div class="tool-icon orange">üìä</div>
        <div class="tool-title">System Analytics</div>
        <div class="tool-description">Platform-wide analytics, usage metrics, and performance monitoring dashboards.</div>
      </a>

      <!-- API & Integrations -->
      <a href="integrations.html" class="tool-card">
        <div class="tool-icon teal">üîó</div>
        <div class="tool-title">API & Integrations</div>
        <div class="tool-description">Manage API keys, webhooks, VAPI assistants, and third-party integrations.</div>
      </a>

    </div>
  </div>

  <!-- Quick Access Section -->
  <div class="section">
    <div class="section-title"><span>‚ö°</span> Quick Access</div>
    <div class="quick-actions">
      <a href="support-admin.html" class="quick-btn primary">üé´ Open Tickets</a>
      <a href="database-map.html" class="quick-btn">üóÑÔ∏è Database</a>
      <a href="tenant-management.html" class="quick-btn">üè¢ Tenants</a>
      <a href="user-management.html" class="quick-btn">üë• Users</a>
      <a href="login.html" class="quick-btn">üîë Test Login</a>
    </div>
  </div>

  <!-- Tenant Quick Switch -->
  <div class="section">
    <div class="section-title"><span>üîÄ</span> Quick Switch to Tenant Dashboard</div>
    <div class="tools-grid" id="tenantList">
      <!-- Populated by JavaScript -->
      <div class="tool-card" style="opacity: 0.5;">
        <div class="tool-icon blue">‚è≥</div>
        <div class="tool-title">Loading tenants...</div>
        <div class="tool-description">Please wait</div>
      </div>
    </div>
  </div>

</div>

<script>
  const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let adminEmail = null;

  // Check auth and load data
  async function init() {
    const { data: { session } } = await sb.auth.getSession();
    
    if (!session) {
      // Try to restore session
      const token = localStorage.getItem('sb_access_token');
      const refresh = localStorage.getItem('sb_refresh_token');
      if (token && refresh) {
        const { data } = await sb.auth.setSession({ access_token: token, refresh_token: refresh });
        if (data?.session) {
          adminEmail = data.session.user.email;
        } else {
          window.location.href = 'login.html';
          return;
        }
      } else {
        window.location.href = 'login.html';
        return;
      }
    } else {
      adminEmail = session.user.email;
    }

    // Verify super admin
    const { data: user } = await sb.from('users')
      .select('role')
      .eq('email', adminEmail)
      .single();

    if (user?.role !== 'super_admin' && adminEmail !== 'glowbotsapp@gmail.com') {
      alert('Access denied. Super admin only.');
      window.location.href = 'login.html';
      return;
    }

    document.getElementById('adminEmail').textContent = adminEmail;

    // Load stats
    loadStats();
    loadTenants();
  }

  async function loadStats() {
    try {
      // Total tenants
      const { count: tenantCount } = await sb.from('tenants').select('*', { count: 'exact', head: true });
      document.getElementById('statTenants').textContent = tenantCount || 0;

      // Total users
      const { count: userCount } = await sb.from('users').select('*', { count: 'exact', head: true });
      document.getElementById('statUsers').textContent = userCount || 0;

      // Open tickets
      const { count: ticketCount } = await sb.from('support_tickets')
        .select('*', { count: 'exact', head: true })
        .in('status', ['open', 'in_progress']);
      document.getElementById('statTickets').textContent = ticketCount || 0;

      // Total events
      const { count: eventCount } = await sb.from('events').select('*', { count: 'exact', head: true });
      document.getElementById('statEvents').textContent = eventCount || 0;

    } catch (err) {
      console.error('Error loading stats:', err);
    }
  }

  async function loadTenants() {
    try {
      const { data: tenants, error } = await sb.from('tenants')
        .select('tenant_id, tenant_name, company_name, dashboard_url, status')
        .neq('tenant_id', '00000000-0000-0000-0000-000000000000') // Exclude system admin tenant
        .order('tenant_name');

      if (error) throw error;

      const container = document.getElementById('tenantList');
      
      if (!tenants || tenants.length === 0) {
        container.innerHTML = `
          <div class="tool-card" style="opacity: 0.5;">
            <div class="tool-icon blue">üì≠</div>
            <div class="tool-title">No tenants found</div>
            <div class="tool-description">Create your first tenant to get started</div>
          </div>
        `;
        return;
      }

      container.innerHTML = tenants.map(t => {
        const dashboardUrl = t.dashboard_url || 'dashboard-business.html';
        const icon = getTenantIcon(t.tenant_name);
        return `
          <a href="${dashboardUrl}" class="tool-card">
            <div class="tool-icon blue">${icon}</div>
            <div class="tool-title">${escapeHtml(t.tenant_name || t.company_name || 'Unknown')}</div>
            <div class="tool-description">${escapeHtml(t.company_name || '')} ‚Ä¢ ${t.status || 'active'}</div>
          </a>
        `;
      }).join('');

    } catch (err) {
      console.error('Error loading tenants:', err);
      document.getElementById('tenantList').innerHTML = `
        <div class="tool-card" style="border-color: #ef4444;">
          <div class="tool-icon red">‚ö†Ô∏è</div>
          <div class="tool-title">Error loading tenants</div>
          <div class="tool-description">${err.message}</div>
        </div>
      `;
    }
  }

  function getTenantIcon(name) {
    if (!name) return 'üè¢';
    const lower = name.toLowerCase();
    if (lower.includes('shark')) return 'ü¶à';
    if (lower.includes('wave')) return 'üåä';
    if (lower.includes('dirt')) return 'üèçÔ∏è';
    if (lower.includes('boxster')) return 'üöó';
    return 'üè¢';
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function logout() {
    localStorage.removeItem('sb_access_token');
    localStorage.removeItem('sb_refresh_token');
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('sb-')) localStorage.removeItem(key);
    });
    sb.auth.signOut();
    window.location.href = 'login.html?logout=1';
  }

  // Initialize
  init();
</script>

</body>
</html>
