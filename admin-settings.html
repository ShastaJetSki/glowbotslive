<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Settings - Live Data</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0b0f14;
      min-height: 100vh;
      padding: 20px;
      color: #e8eef6;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { color: #60a5fa; font-size: 28px; font-weight: 700; }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #2d3f56;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: white;
      background: #3b82f6;
      font-size: 14px;
    }

    .btn:hover { background: #2563eb; transform: translateY(-2px); }
    .btn.success { background: #10b981; }
    .btn.success:hover { background: #059669; }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: #0f1621;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #2d3f56;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid transparent;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .tab:hover { background: #1a2535; color: #e8eef6; }
    .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .panel {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #2d3f56;
      font-size: 18px;
      font-weight: 700;
      color: #60a5fa;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full-width { grid-column: 1 / -1; }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select, .form-textarea {
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 12px;
      color: #e8eef6;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea { resize: vertical; min-height: 80px; }

    .cost-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .cost-table th {
      background: #1a2535;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #2d3f56;
    }

    .cost-table td {
      padding: 12px;
      border-bottom: 1px solid #2d3f56;
    }

    .cost-table tr:hover { background: #1a2535; }

    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cat-infrastructure { background: #7f1d1d; color: #fca5a5; }
    .cat-services { background: #78350f; color: #fcd34d; }
    .cat-fees { background: #1e3a8a; color: #93c5fd; }
    .cat-operations { background: #581c87; color: #d8b4fe; }

    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 4px;
      transition: all 0.2s;
    }

    .action-btn:hover { background: #2563eb; }
    .action-btn.delete { background: #dc2626; }
    .action-btn.delete:hover { background: #b91c1c; }

    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Admin Settings</h1>
    <a href="admin-dashboard-collapsible.html" class="btn">‚Üê Back to Dashboard</a>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('users')">User Management</div>
    <div class="tab" onclick="switchTab('tiers')">Subscription Tiers</div>
  </div>

  <!-- User Management Tab -->
  <div class="tab-content active" id="users">
    <div class="panel">
      <div class="panel-title">
        <span>Add New User</span>
        <button class="btn success" onclick="addUser()">Add User</button>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="userName" placeholder="John Doe">
        </div>

        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="userEmail" placeholder="user@example.com">
        </div>

        <div class="form-group">
          <label class="form-label">Company Name</label>
          <input type="text" class="form-input" id="companyName" placeholder="Acme Corp">
        </div>

        <div class="form-group">
          <label class="form-label">Domain</label>
          <input type="text" class="form-input" id="userDomain" placeholder="acme.example.com">
        </div>

        <div class="form-group">
          <label class="form-label">Subscription Tier</label>
          <select class="form-select" id="userTier">
            <option value="">Loading tiers...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Account Status</label>
          <select class="form-select" id="userStatus">
            <option value="active">Active</option>
            <option value="trial">Trial</option>
            <option value="inactive">Inactive</option>
            <option value="suspended">Suspended</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Billing Cycle</label>
          <select class="form-select" id="billingCycle">
            <option value="monthly">Monthly</option>
            <option value="annual">Annual</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Custom Monthly Price ($)</label>
          <input type="number" class="form-input" id="customPrice" placeholder="0.00" step="0.01">
          <small style="color: #94a3b8; font-size: 11px;">Leave blank to use tier default</small>
        </div>

        <div class="form-group full-width">
          <label class="form-label">Notes (Internal)</label>
          <textarea class="form-textarea" id="userNotes" placeholder="Promo code: SAVE50, Early adopter pricing..."></textarea>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">
        <span>Current Tenants</span>
        <button class="btn" onclick="loadTenants()">üîÑ Refresh</button>
      </div>

      <div id="tenantsLoading" class="loading">Loading tenants...</div>

      <table class="cost-table" id="tenantsTable" style="display:none;">
        <thead>
          <tr>
            <th>Company</th>
            <th>Domain</th>
            <th>Tier</th>
            <th>MRR</th>
            <th>Status</th>
            <th>Users</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tenantsTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tiers Tab -->
  <div class="tab-content" id="tiers">
    <div class="panel">
      <div class="panel-title">Subscription Tiers</div>
      
      <div id="tiersLoading" class="loading">Loading tiers...</div>

      <table class="cost-table" id="tiersTable" style="display:none;">
        <thead>
          <tr>
            <th>Tier Name</th>
            <th>Monthly Price</th>
            <th>Annual Price</th>
            <th>Active</th>
          </tr>
        </thead>
        <tbody id="tiersTableBody">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // ============================================================================
  // SUPABASE CONFIGURATION
  // ============================================================================
  
  const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
  
  let supabaseClient;
  
  if (typeof window.supabase !== 'undefined') {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  } else {
    console.error('Supabase not loaded. Make sure the CDN script is included.');
  }

  let tiers = [];
  let tenants = [];

  // ============================================================================
  // INITIALIZATION
  // ============================================================================

  async function init() {
    await loadTiers();
    await loadTenants();
  }

  // ============================================================================
  // LOAD TIERS
  // ============================================================================

  async function loadTiers() {
    try {
      const { data, error } = await supabaseClient
        .from('subscription_tiers')
        .select('*')
        .order('sort_order');

      if (error) throw error;

      tiers = data || [];
      renderTiers();
      populateTierSelect();

    } catch (error) {
      console.error('Error loading tiers:', error);
      alert('Error loading subscription tiers: ' + error.message);
    }
  }

  function renderTiers() {
    const loading = document.getElementById('tiersLoading');
    const table = document.getElementById('tiersTable');
    const tbody = document.getElementById('tiersTableBody');

    loading.style.display = 'none';
    table.style.display = 'table';

    tbody.innerHTML = tiers.map(tier => `
      <tr>
        <td><strong>${tier.tier_display_name}</strong></td>
        <td>$${tier.monthly_price.toFixed(2)}</td>
        <td>$${tier.annual_price.toFixed(2)}</td>
        <td><span class="category-badge cat-${tier.is_active ? 'services' : 'operations'}">${tier.is_active ? 'Active' : 'Inactive'}</span></td>
      </tr>
    `).join('');
  }

  function populateTierSelect() {
    const select = document.getElementById('userTier');
    select.innerHTML = tiers.map(tier => 
      `<option value="${tier.tier_id}">${tier.tier_display_name} - $${tier.monthly_price}/mo</option>`
    ).join('');
  }

  // ============================================================================
  // LOAD TENANTS
  // ============================================================================

  async function loadTenants() {
    try {
      const { data, error } = await supabaseClient
        .from('tenants')
        .select(`
          *,
          subscription_tiers(tier_display_name, monthly_price)
        `)
        .order('created_at', { ascending: false });

      if (error) throw error;

      tenants = data || [];
      renderTenants();

    } catch (error) {
      console.error('Error loading tenants:', error);
      alert('Error loading tenants: ' + error.message);
    }
  }

  function renderTenants() {
    const loading = document.getElementById('tenantsLoading');
    const table = document.getElementById('tenantsTable');
    const tbody = document.getElementById('tenantsTableBody');

    loading.style.display = 'none';
    table.style.display = 'table';

    tbody.innerHTML = tenants.map(tenant => {
      const tierName = tenant.subscription_tiers?.tier_display_name || 'No tier';
      const mrr = tenant.monthly_recurring_revenue || 0;
      
      return `
        <tr>
          <td>
            <strong>${tenant.company_name || tenant.tenant_name}</strong>
          </td>
          <td>${tenant.domain || '-'}</td>
          <td>${tierName}</td>
          <td>
            $${mrr.toFixed(2)}
            ${tenant.metadata?.custom_price ? '<small style="color:#10b981"> (custom)</small>' : ''}
          </td>
          <td><span class="category-badge cat-${getStatusClass(tenant.status)}">${tenant.status}</span></td>
          <td>${tenant.total_users || 0}</td>
          <td>
            <button class="action-btn" onclick="editTenant('${tenant.tenant_id}')">Edit</button>
            <button class="action-btn delete" onclick="deleteTenant('${tenant.tenant_id}')">Delete</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function getStatusClass(status) {
    const map = {
      'active': 'services',
      'trial': 'fees',
      'inactive': 'operations',
      'suspended': 'infrastructure'
    };
    return map[status] || 'operations';
  }

  // ============================================================================
  // ADD TENANT
  // ============================================================================

  async function addUser() {
    const name = document.getElementById('userName').value;
    const email = document.getElementById('userEmail').value;
    const company = document.getElementById('companyName').value;
    const domain = document.getElementById('userDomain').value;
    const tierId = document.getElementById('userTier').value;
    const status = document.getElementById('userStatus').value;
    const cycle = document.getElementById('billingCycle').value;
    const customPrice = document.getElementById('customPrice').value;
    const notes = document.getElementById('userNotes').value;

    if (!company || !email) {
      alert('Please fill in company name and email');
      return;
    }

    try {
      // Get tier info for MRR
      const tier = tiers.find(t => t.tier_id === tierId);
      const mrr = customPrice ? parseFloat(customPrice) : (tier?.monthly_price || 0);

      const { data, error } = await supabaseClient
        .from('tenants')
        .insert([{
          tenant_name: name || company,
          company_name: company,
          domain: domain,
          tier_id: tierId,
          status: status,
          billing_cycle: cycle,
          billing_email: email,
          monthly_recurring_revenue: mrr,
          metadata: {
            custom_price: customPrice ? parseFloat(customPrice) : null,
            notes: notes
          }
        }])
        .select();

      if (error) throw error;

      alert('Tenant added successfully!');
      
      // Clear form
      document.getElementById('userName').value = '';
      document.getElementById('userEmail').value = '';
      document.getElementById('companyName').value = '';
      document.getElementById('userDomain').value = '';
      document.getElementById('customPrice').value = '';
      document.getElementById('userNotes').value = '';
      
      await loadTenants();

    } catch (error) {
      console.error('Error adding tenant:', error);
      alert('Error adding tenant: ' + error.message);
    }
  }

  // ============================================================================
  // EDIT TENANT
  // ============================================================================

  async function editTenant(tenantId) {
    const tenant = tenants.find(t => t.tenant_id === tenantId);
    if (!tenant) return;

    // Populate form
    document.getElementById('userName').value = tenant.tenant_name || '';
    document.getElementById('userEmail').value = tenant.billing_email || '';
    document.getElementById('companyName').value = tenant.company_name || '';
    document.getElementById('userDomain').value = tenant.domain || '';
    document.getElementById('userTier').value = tenant.tier_id || '';
    document.getElementById('userStatus').value = tenant.status || 'active';
    document.getElementById('billingCycle').value = tenant.billing_cycle || 'monthly';
    document.getElementById('customPrice').value = tenant.metadata?.custom_price || '';
    document.getElementById('userNotes').value = tenant.metadata?.notes || '';
    
    window.scrollTo(0, 0);
  }

  // ============================================================================
  // DELETE TENANT
  // ============================================================================

  async function deleteTenant(tenantId) {
    if (!confirm('Delete this tenant? This will remove all their data.')) return;

    try {
      const { error } = await supabaseClient
        .from('tenants')
        .delete()
        .eq('tenant_id', tenantId);

      if (error) throw error;

      alert('Tenant deleted successfully!');
      await loadTenants();

    } catch (error) {
      console.error('Error deleting tenant:', error);
      alert('Error deleting tenant: ' + error.message);
    }
  }

  // ============================================================================
  // TAB SWITCHING
  // ============================================================================

  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
  }

  // Initialize on load
  init();
</script>

</body>
</html>
