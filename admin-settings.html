<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Admin - GlowBots</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0b0f14; color: #e8eef6; min-height: 100vh; }

    .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-bottom: 1px solid #223044; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-title { font-size: 22px; font-weight: 700; color: #3b82f6; }
    .header-badge { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .admin-email { color: #9fb0c3; font-size: 14px; }
    .logout-btn { padding: 10px 20px; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .logout-btn:hover { background: #ef4444; color: #fff; }

    .container { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }
    .welcome-section { background: linear-gradient(135deg, #1a2535 0%, #0f1621 100%); border: 1px solid #223044; border-radius: 16px; padding: 32px; margin-bottom: 32px; }
    .welcome-title { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .welcome-subtitle { color: #9fb0c3; font-size: 16px; }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: #1a2535; border: 1px solid #223044; border-radius: 12px; padding: 20px; }
    .stat-value { font-size: 28px; font-weight: 700; color: #3b82f6; }
    .stat-label { font-size: 13px; color: #9fb0c3; margin-top: 4px; }

    .section { margin-bottom: 32px; }
    .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #e8eef6; }

    .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .tool-card { background: #1a2535; border: 1px solid #223044; border-radius: 16px; padding: 24px; cursor: pointer; transition: all 0.3s; text-decoration: none; color: inherit; display: block; }
    .tool-card:hover { border-color: #3b82f6; transform: translateY(-4px); box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15); }
    .tool-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .tool-description { font-size: 14px; color: #9fb0c3; line-height: 1.5; }

    .tenant-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .tenant-card { background: #1a2535; border: 1px solid #223044; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
    .tenant-card:hover { border-color: #3b82f6; background: #223044; }
    .tenant-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .tenant-info { font-size: 13px; color: #9fb0c3; }
    .tenant-status { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-top: 8px; background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .tenant-status.inactive { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    @media (max-width: 768px) { .header { flex-direction: column; gap: 16px; text-align: center; } .tools-grid, .tenant-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <span class="header-title">GlowBots System Admin</span>
    <span class="header-badge">Super Admin</span>
  </div>
  <div class="header-right">
    <span class="admin-email" id="adminEmail">Loading...</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">
  <div class="welcome-section">
    <div class="welcome-title">Welcome, Super Admin</div>
    <div class="welcome-subtitle">Full system access to all tenants, support tickets, and database tools</div>
  </div>

  <div class="stats-row">
    <div class="stat-card"><div class="stat-value" id="statTenants">-</div><div class="stat-label">Total Tenants</div></div>
    <div class="stat-card"><div class="stat-value" id="statUsers">-</div><div class="stat-label">Total Users</div></div>
    <div class="stat-card"><div class="stat-value" id="statTickets">-</div><div class="stat-label">Open Tickets</div></div>
    <div class="stat-card"><div class="stat-value" id="statEmployees">-</div><div class="stat-label">Total Employees</div></div>
    <div class="stat-card"><div class="stat-value" id="statEvents">-</div><div class="stat-label">Total Events</div></div>
    <div class="stat-card"><div class="stat-value" id="statCustomers">-</div><div class="stat-label">Total Customers</div></div>
  </div>

  <div class="section">
    <div class="section-title">Admin Tools</div>
    <div class="tools-grid">
      <a href="support-admin.html" class="tool-card"><div class="tool-title">Support Tickets</div><div class="tool-description">View and manage all support tickets across all tenants. Respond to customers and track issues.</div></a>
      <a href="database-map.html" class="tool-card"><div class="tool-title">Database Map</div><div class="tool-description">Visual database schema viewer. Explore tables, columns, relationships, and data types.</div></a>
      <a href="tenant-management.html" class="tool-card"><div class="tool-title">Tenant Management</div><div class="tool-description">Manage all tenant accounts, subscriptions, and billing. Add or deactivate tenants.</div></a>
      <a href="user-management.html" class="tool-card"><div class="tool-title">User Management</div><div class="tool-description">View all users across tenants. Reset passwords, update roles, and manage access.</div></a>
      <a href="analytics.html" class="tool-card"><div class="tool-title">System Analytics</div><div class="tool-description">Platform-wide analytics, usage metrics, revenue tracking, and performance dashboards.</div></a>
      <a href="integrations.html" class="tool-card"><div class="tool-title">API and Integrations</div><div class="tool-description">Manage API keys, webhooks, VAPI assistants, and third-party integrations.</div></a>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Switch to Tenant Dashboard</div>
    <div class="tenant-grid" id="tenantList">
      <div class="tenant-card" style="opacity: 0.5;"><div class="tenant-name">Loading tenants...</div><div class="tenant-info">Please wait</div></div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  let adminEmail = null;

  async function init() {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
      const token = localStorage.getItem('sb_access_token');
      const refresh = localStorage.getItem('sb_refresh_token');
      if (token && refresh) {
        const { data } = await sb.auth.setSession({ access_token: token, refresh_token: refresh });
        if (data?.session) { adminEmail = data.session.user.email; }
        else { window.location.href = 'login.html'; return; }
      } else { window.location.href = 'login.html'; return; }
    } else { adminEmail = session.user.email; }

    const { data: user } = await sb.from('users').select('role').eq('email', adminEmail).single();
    if (user?.role !== 'super_admin' && adminEmail !== 'glowbotsapp@gmail.com') {
      alert('Access denied. Super admin only.');
      window.location.href = 'login.html';
      return;
    }
    document.getElementById('adminEmail').textContent = adminEmail;
    loadStats();
    loadTenants();
  }

  async function loadStats() {
    try {
      const { count: tenantCount } = await sb.from('tenants').select('*', { count: 'exact', head: true });
      document.getElementById('statTenants').textContent = tenantCount || 0;
      const { count: userCount } = await sb.from('users').select('*', { count: 'exact', head: true });
      document.getElementById('statUsers').textContent = userCount || 0;
      const { count: ticketCount } = await sb.from('support_tickets').select('*', { count: 'exact', head: true }).in('status', ['open', 'in_progress']);
      document.getElementById('statTickets').textContent = ticketCount || 0;
      const { count: employeeCount } = await sb.from('employees').select('*', { count: 'exact', head: true });
      document.getElementById('statEmployees').textContent = employeeCount || 0;
      const { count: eventCount } = await sb.from('events').select('*', { count: 'exact', head: true });
      document.getElementById('statEvents').textContent = eventCount || 0;
      const { count: customerCount } = await sb.from('customers').select('*', { count: 'exact', head: true });
      document.getElementById('statCustomers').textContent = customerCount || 0;
    } catch (err) { console.error('Error loading stats:', err); }
  }

  async function loadTenants() {
    try {
      const { data: tenants, error } = await sb.from('tenants').select('tenant_id, tenant_name, company_name, dashboard_url, status').neq('tenant_id', '00000000-0000-0000-0000-000000000000').order('tenant_name');
      if (error) throw error;
      const container = document.getElementById('tenantList');
      if (!tenants || tenants.length === 0) {
        container.innerHTML = '<div class="tenant-card" style="opacity:0.5;"><div class="tenant-name">No tenants found</div><div class="tenant-info">Create your first tenant to get started</div></div>';
        return;
      }
      container.innerHTML = tenants.map(t => {
        const dashUrl = t.dashboard_url || 'dashboard-business.html';
        const statusClass = t.status === 'active' ? '' : 'inactive';
        return `<div class="tenant-card" onclick="switchToTenant('${t.tenant_id}', '${dashUrl}')">
          <div class="tenant-name">${escapeHtml(t.tenant_name || 'Unknown')}</div>
          <div class="tenant-info">${escapeHtml(t.company_name || '')}</div>
          <div class="tenant-info" style="font-family:monospace;font-size:11px;margin-top:4px;">${t.tenant_id.substring(0, 8)}...</div>
          <span class="tenant-status ${statusClass}">${t.status || 'active'}</span>
        </div>`;
      }).join('');
    } catch (err) {
      console.error('Error loading tenants:', err);
      document.getElementById('tenantList').innerHTML = '<div class="tenant-card" style="border-color:#ef4444;"><div class="tenant-name">Error</div><div class="tenant-info">' + err.message + '</div></div>';
    }
  }

  function switchToTenant(tenantId, dashboardUrl) {
    localStorage.setItem('super_admin_viewing_tenant', tenantId);
    window.location.href = dashboardUrl + '?tenant=' + tenantId;
  }

  function escapeHtml(text) { if (!text) return ''; return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

  function logout() {
    localStorage.removeItem('sb_access_token');
    localStorage.removeItem('sb_refresh_token');
    localStorage.removeItem('super_admin_viewing_tenant');
    Object.keys(localStorage).forEach(key => { if (key.startsWith('sb-')) localStorage.removeItem(key); });
    sb.auth.signOut();
    window.location.href = 'login.html?logout=1';
  }
  init();
</script>
</body>
</html>
