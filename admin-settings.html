<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Settings - Live Data</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0b0f14;
      min-height: 100vh;
      padding: 20px;
      color: #e8eef6;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { color: #60a5fa; font-size: 28px; font-weight: 700; }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #2d3f56;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: white;
      background: #3b82f6;
      font-size: 14px;
    }

    .btn:hover { background: #2563eb; transform: translateY(-2px); }
    .btn.success { background: #10b981; }
    .btn.success:hover { background: #059669; }
    .btn.secondary { background: #374151; border-color: #4b5563; }
    .btn.secondary:hover { background: #4b5563; }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: #0f1621;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #2d3f56;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid transparent;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .tab:hover { background: #1a2535; color: #e8eef6; }
    .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .panel {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #2d3f56;
      font-size: 18px;
      font-weight: 700;
      color: #60a5fa;
      flex-wrap: wrap;
      gap: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full-width { grid-column: 1 / -1; }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select, .form-textarea {
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 12px;
      color: #e8eef6;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea { resize: vertical; min-height: 80px; }

    .cost-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .cost-table th {
      background: #1a2535;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #2d3f56;
    }

    .cost-table td {
      padding: 12px;
      border-bottom: 1px solid #2d3f56;
      vertical-align: top;
    }

    .cost-table tr:hover { background: #1a2535; }

    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cat-infrastructure { background: #7f1d1d; color: #fca5a5; }
    .cat-services { background: #78350f; color: #fcd34d; }
    .cat-fees { background: #1e3a8a; color: #93c5fd; }
    .cat-operations { background: #581c87; color: #d8b4fe; }

    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 4px;
      transition: all 0.2s;
    }

    .action-btn:hover { background: #2563eb; }
    .action-btn.delete { background: #dc2626; }
    .action-btn.delete:hover { background: #b91c1c; }

    .loading { text-align: center; padding: 40px; color: #94a3b8; }
    
    .info-box {
      background: #1e3a5f;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #93c5fd;
    }
    
    .button-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: #0b0f14;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .preview-btn {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #2d3f56;
      background: #1a2535;
      color: #e8eef6;
    }
    
    .preview-btn.primary { background: #3b82f6; border-color: #3b82f6; }
    
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1a2535;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .checkbox-item:hover { background: #243448; }
    .checkbox-item input { width: 16px; height: 16px; cursor: pointer; }
    .checkbox-item label { font-size: 13px; cursor: pointer; flex: 1; }
    
    .button-label-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
    }
    
    .button-label-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1a2535;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .button-label-item:hover { background: #243448; }
    .button-label-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; flex-shrink: 0; }
    .button-label-item .btn-id { font-size: 11px; color: #94a3b8; width: 70px; flex-shrink: 0; }
    .button-label-item input[type="text"] {
      flex: 1;
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 4px;
      padding: 4px 8px;
      color: #e8eef6;
      font-size: 13px;
      min-width: 80px;
    }
    .button-label-item input[type="text"]:focus { border-color: #3b82f6; outline: none; }
    .button-label-item input[type="text"]:disabled { opacity: 0.4; background: #1a2535; }
    
    .role-section {
      background: #1a2535;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .role-header {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 12px;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.75);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal-content {
      background: #0f1621;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #2d3f56;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #2d3f56;
      position: sticky;
      top: 0;
      background: #0f1621;
      z-index: 10;
    }
    
    .modal-title { font-size: 18px; font-weight: 700; color: #60a5fa; }
    .modal-close { background: transparent; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #2d3f56; display: flex; gap: 10px; justify-content: flex-end; }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .tabs { flex-direction: column; }
      .tab { text-align: center; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Admin Settings</h1>
    <a href="dashboard-business.html" class="btn">‚Üê Back to Dashboard</a>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('tenants')">Tenants</div>
    <div class="tab" onclick="switchTab('tiers')">Subscription Tiers</div>
    <div class="tab" onclick="switchTab('presets')">UI Presets</div>
    <div class="tab" onclick="switchTab('roles')">Role Permissions</div>
  </div>

  <!-- ========== TENANTS TAB ========== -->
  <div class="tab-content active" id="tenants">
    <div class="panel">
      <div class="panel-title">
        <span>Add New Tenant & Owner</span>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;">Cancel</button>
          <button class="btn success" onclick="addTenantAndUser()">Add Tenant</button>
        </div>
      </div>
      
      <div class="info-box">
        Creates a new tenant (company), owner user account, and assigns a UI preset. The owner can then add employees from their Settings page.
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Owner Full Name *</label>
          <input type="text" class="form-input" id="userName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label class="form-label">Owner Email *</label>
          <input type="email" class="form-input" id="userEmail" placeholder="owner@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Company Name *</label>
          <input type="text" class="form-input" id="companyName" placeholder="Acme Corp">
        </div>
        <div class="form-group">
          <label class="form-label">Domain</label>
          <input type="text" class="form-input" id="userDomain" placeholder="acme.example.com">
        </div>
        <div class="form-group">
          <label class="form-label">UI Preset *</label>
          <select class="form-select" id="uiPreset"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Subscription Tier</label>
          <select class="form-select" id="userTier"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Account Status</label>
          <select class="form-select" id="userStatus">
            <option value="active">Active</option>
            <option value="trial">Trial</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Billing Cycle</label>
          <select class="form-select" id="billingCycle">
            <option value="monthly">Monthly</option>
            <option value="annual">Annual</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="userNotes" placeholder="Internal notes..."></textarea>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">
        <span>Current Tenants</span>
        <button class="btn" onclick="loadTenants()">Refresh</button>
      </div>
      <div id="tenantsLoading" class="loading">Loading...</div>
      <table class="cost-table" id="tenantsTable" style="display:none;">
        <thead>
          <tr>
            <th>Company</th>
            <th>Owner</th>
            <th>UI Preset</th>
            <th>Tier</th>
            <th>MRR</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tenantsTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ========== TIERS TAB ========== -->
  <div class="tab-content" id="tiers">
    <div class="panel">
      <div class="panel-title">
        <span>Subscription Tiers</span>
        <button class="btn success" onclick="openTierModal()">+ Add Tier</button>
      </div>
      <div class="info-box">Define pricing tiers. If using Stripe, add Price IDs from your Stripe Dashboard.</div>
      <div id="tiersLoading" class="loading">Loading...</div>
      <table class="cost-table" id="tiersTable" style="display:none;">
        <thead>
          <tr><th>Tier Name</th><th>Monthly</th><th>Annual</th><th>Limits</th><th>Active</th><th>Actions</th></tr>
        </thead>
        <tbody id="tiersTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ========== UI PRESETS TAB ========== -->
  <div class="tab-content" id="presets">
    <div class="panel">
      <div class="panel-title">
        <span>UI Presets (Industry Layouts)</span>
        <button class="btn success" onclick="openPresetModal()">+ Add Preset</button>
      </div>
      <div class="info-box">UI Presets define which buttons/features are available for different industries.</div>
      <div id="presetsLoading" class="loading">Loading...</div>
      <table class="cost-table" id="presetsTable" style="display:none;">
        <thead>
          <tr><th>Preset Name</th><th>Industry</th><th>Buttons</th><th>Active</th><th>Actions</th></tr>
        </thead>
        <tbody id="presetsTableBody"></tbody>
      </table>
    </div>
    
    <div class="panel">
      <div class="panel-title">Built-in Preset Templates</div>
      <div style="display:grid; gap:16px;">
        <div class="role-section">
          <div class="role-header">Car Dealership</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Vehicles</span>
            <span class="preview-btn">Service</span>
            <span class="preview-btn">Parts</span>
            <span class="preview-btn">Sales</span>
            <span class="preview-btn">Fleet</span>
            <span class="preview-btn">Scheduler</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Traveling Salesman</div>
          <div class="button-preview">
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Appointments</span>
            <span class="preview-btn">Routes</span>
            <span class="preview-btn">Calendar</span>
            <span class="preview-btn">Leads</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Law Firm</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Clients</span>
            <span class="preview-btn primary">Cases</span>
            <span class="preview-btn">Tasks</span>
            <span class="preview-btn">Calendar</span>
            <span class="preview-btn">Billing</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Powersports / Marine</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Units</span>
            <span class="preview-btn">Service</span>
            <span class="preview-btn">Parts</span>
            <span class="preview-btn">Rentals</span>
            <span class="preview-btn">Storage</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ROLE PERMISSIONS TAB ========== -->
  <div class="tab-content" id="roles">
    <div class="panel">
      <div class="panel-title">
        <span>Role-Based Button Visibility</span>
        <button class="btn" onclick="saveRolePermissions()">Save Permissions</button>
      </div>
      <div class="info-box">Configure which buttons each role can see. Owners always see everything.</div>
      
      <div class="role-section">
        <div class="role-header">Owner - Full Access (cannot be restricted)</div>
      </div>
      
      <div class="role-section">
        <div class="role-header">Manager</div>
        <div class="checkbox-grid" id="managerButtons"></div>
      </div>
      
      <div class="role-section">
        <div class="role-header">Technician</div>
        <div class="checkbox-grid" id="technicianButtons"></div>
      </div>
      
      <div class="role-section">
        <div class="role-header">Admin</div>
        <div class="checkbox-grid" id="adminButtons"></div>
      </div>
      
      <div id="rolesSaveMessage" style="margin-top:16px;"></div>
    </div>
  </div>
</div>

<!-- TIER MODAL -->
<div class="modal-overlay" id="tierModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="tierModalTitle">Add Tier</h3>
      <button class="modal-close" onclick="closeTierModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editTierId" />
      <div class="form-group">
        <label class="form-label">Tier Name *</label>
        <input type="text" class="form-input" id="tierName" style="width:100%;">
      </div>
      <div class="form-group">
        <label class="form-label">Display Name</label>
        <input type="text" class="form-input" id="tierDisplayName" style="width:100%;">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Monthly Price ($) *</label>
          <input type="number" class="form-input" id="tierMonthlyPrice" step="0.01" style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Annual Price ($)</label>
          <input type="number" class="form-input" id="tierAnnualPrice" step="0.01" style="width:100%;">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Max Users</label>
          <input type="number" class="form-input" id="tierMaxUsers" style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Max Vehicles</label>
          <input type="number" class="form-input" id="tierMaxVehicles" style="width:100%;">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Stripe Monthly ID</label>
          <input type="text" class="form-input" id="tierStripeMonthly" placeholder="price_..." style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Sort Order</label>
          <input type="number" class="form-input" id="tierSortOrder" style="width:100%;">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Features (one per line)</label>
        <textarea class="form-textarea" id="tierFeatures" style="width:100%;"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="tierIsActive" style="width:100%;">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeTierModal()">Cancel</button>
      <button class="btn success" onclick="saveTier()">Save</button>
    </div>
  </div>
</div>

<!-- PRESET MODAL -->
<div class="modal-overlay" id="presetModal">
  <div class="modal-content" style="max-width:800px;">
    <div class="modal-header">
      <h3 class="modal-title" id="presetModalTitle">Add UI Preset</h3>
      <button class="modal-close" onclick="closePresetModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editPresetId" />
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Preset Name *</label>
          <input type="text" class="form-input" id="presetName" style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Industry</label>
          <select class="form-select" id="presetIndustry" style="width:100%;">
            <option value="automotive">Automotive</option>
            <option value="powersports">Powersports</option>
            <option value="marine">Marine</option>
            <option value="field_sales">Field Sales</option>
            <option value="legal">Legal</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" class="form-input" id="presetDescription" style="width:100%;">
      </div>
      
      <div class="form-group">
        <label class="form-label">Navigation Buttons <span style="font-weight:normal; color:#94a3b8;">(check to enable, edit label to rename)</span></label>
        <div class="button-label-grid" id="presetNavButtons"></div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Action Buttons</label>
        <div class="button-label-grid" id="presetActionButtons"></div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="presetIsActive" style="width:100%;">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Preview</label>
        <div class="button-preview" id="presetPreview"><span style="color:#94a3b8;">Select buttons...</span></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closePresetModal()">Cancel</button>
      <button class="btn success" onclick="savePreset()">Save</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ALL_NAV_BUTTONS = ['Business', 'Customers', 'Vehicles', 'Clients', 'Cases', 'Units', 'Boats', 'Settings'];
const ALL_ACTION_BUTTONS = ['Service', 'Parts', 'Sales', 'Fleet', 'Rentals', 'Scheduler', 'Calendar', 'Routes', 'Leads', 'Tasks', 'Documents', 'Billing', 'Storage', 'Inbox'];

let tiers = [], tenants = [], presets = [], rolePermissions = {};

async function init() {
  await Promise.all([loadTiers(), loadTenants(), loadPresets(), loadRolePermissions()]);
  populatePresetModal();
  populateRolePermissions();
}

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tabName).classList.add('active');
}

// ===== TIERS =====
async function loadTiers() {
  try {
    const { data, error } = await supabaseClient.from('subscription_tiers').select('*').order('sort_order');
    if (error) throw error;
    tiers = data || [];
    renderTiers();
    populateTierSelect();
  } catch (e) { console.error(e); }
}

function renderTiers() {
  document.getElementById('tiersLoading').style.display = 'none';
  document.getElementById('tiersTable').style.display = 'table';
  const tbody = document.getElementById('tiersTableBody');
  if (tiers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No tiers</td></tr>';
    return;
  }
  tbody.innerHTML = tiers.map(t => {
    const limits = [];
    if (t.max_users) limits.push(t.max_users + ' users');
    if (t.max_vehicles) limits.push(t.max_vehicles + ' vehicles');
    return `<tr>
      <td><strong>${t.tier_display_name || t.tier_name}</strong></td>
      <td>$${(t.monthly_price||0).toFixed(2)}</td>
      <td>$${(t.annual_price||0).toFixed(2)}</td>
      <td style="font-size:11px;color:#94a3b8;">${limits.join(', ')||'Unlimited'}</td>
      <td><span class="category-badge cat-${t.is_active?'services':'operations'}">${t.is_active?'Active':'Inactive'}</span></td>
      <td>
        <button class="action-btn" onclick="editTier('${t.tier_id}')">Edit</button>
        <button class="action-btn delete" onclick="deleteTier('${t.tier_id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function populateTierSelect() {
  document.getElementById('userTier').innerHTML = '<option value="">-- Select --</option>' + 
    tiers.filter(t=>t.is_active).map(t => `<option value="${t.tier_id}">${t.tier_display_name||t.tier_name} - $${t.monthly_price}/mo</option>`).join('');
}

function openTierModal() {
  document.getElementById('editTierId').value = '';
  document.getElementById('tierName').value = '';
  document.getElementById('tierDisplayName').value = '';
  document.getElementById('tierMonthlyPrice').value = '';
  document.getElementById('tierAnnualPrice').value = '';
  document.getElementById('tierMaxUsers').value = '';
  document.getElementById('tierMaxVehicles').value = '';
  document.getElementById('tierStripeMonthly').value = '';
  document.getElementById('tierSortOrder').value = tiers.length;
  document.getElementById('tierFeatures').value = '';
  document.getElementById('tierIsActive').value = 'true';
  document.getElementById('tierModalTitle').textContent = 'Add Tier';
  document.getElementById('tierModal').classList.add('active');
}

function closeTierModal() { document.getElementById('tierModal').classList.remove('active'); }

function editTier(id) {
  const t = tiers.find(x => x.tier_id === id);
  if (!t) return;
  document.getElementById('editTierId').value = t.tier_id;
  document.getElementById('tierName').value = t.tier_name || '';
  document.getElementById('tierDisplayName').value = t.tier_display_name || '';
  document.getElementById('tierMonthlyPrice').value = t.monthly_price || '';
  document.getElementById('tierAnnualPrice').value = t.annual_price || '';
  document.getElementById('tierMaxUsers').value = t.max_users || '';
  document.getElementById('tierMaxVehicles').value = t.max_vehicles || '';
  document.getElementById('tierStripeMonthly').value = t.stripe_price_id_monthly || '';
  document.getElementById('tierSortOrder').value = t.sort_order || 0;
  document.getElementById('tierFeatures').value = (t.features || []).join('\n');
  document.getElementById('tierIsActive').value = t.is_active ? 'true' : 'false';
  document.getElementById('tierModalTitle').textContent = 'Edit Tier';
  document.getElementById('tierModal').classList.add('active');
}

async function saveTier() {
  const id = document.getElementById('editTierId').value;
  const name = document.getElementById('tierName').value.trim();
  const monthly = parseFloat(document.getElementById('tierMonthlyPrice').value) || 0;
  if (!name || monthly <= 0) { alert('Name and price required'); return; }
  
  const data = {
    tier_name: name,
    tier_display_name: document.getElementById('tierDisplayName').value.trim() || name,
    monthly_price: monthly,
    annual_price: parseFloat(document.getElementById('tierAnnualPrice').value) || (monthly * 10),
    max_users: parseInt(document.getElementById('tierMaxUsers').value) || null,
    max_vehicles: parseInt(document.getElementById('tierMaxVehicles').value) || null,
    stripe_price_id_monthly: document.getElementById('tierStripeMonthly').value.trim() || null,
    sort_order: parseInt(document.getElementById('tierSortOrder').value) || 0,
    features: document.getElementById('tierFeatures').value.trim().split('\n').filter(f => f.trim()),
    is_active: document.getElementById('tierIsActive').value === 'true',
    updated_at: new Date().toISOString()
  };
  
  try {
    if (id) {
      await supabaseClient.from('subscription_tiers').update(data).eq('tier_id', id);
    } else {
      data.created_at = new Date().toISOString();
      await supabaseClient.from('subscription_tiers').insert([data]);
    }
    alert('Saved!'); closeTierModal(); await loadTiers();
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteTier(id) {
  if (!confirm('Delete this tier?')) return;
  try {
    await supabaseClient.from('subscription_tiers').delete().eq('tier_id', id);
    await loadTiers();
  } catch (e) { alert('Error: ' + e.message); }
}

// ===== PRESETS =====
async function loadPresets() {
  try {
    const { data, error } = await supabaseClient.from('ui_presets').select('*').order('name');
    if (error) throw error;
    presets = data || [];
    if (presets.length === 0) presets = getDefaultPresets();
  } catch (e) {
    presets = getDefaultPresets();
  }
  renderPresets();
  populatePresetSelect();
}

function getDefaultPresets() {
  return [
    { id: 'car_dealership', name: 'Car Dealership', industry: 'automotive', nav_buttons: ['Business','Customers','Vehicles','Settings'], action_buttons: ['Service','Parts','Sales','Fleet','Scheduler'], is_active: true },
    { id: 'traveling_salesman', name: 'Traveling Salesman', industry: 'field_sales', nav_buttons: ['Customers','Settings'], action_buttons: ['Calendar','Routes','Leads','Tasks'], is_active: true },
    { id: 'law_firm', name: 'Law Firm', industry: 'legal', nav_buttons: ['Business','Clients','Cases','Settings'], action_buttons: ['Tasks','Calendar','Documents','Billing'], is_active: true },
    { id: 'powersports', name: 'Powersports', industry: 'powersports', nav_buttons: ['Business','Customers','Units','Settings'], action_buttons: ['Service','Parts','Sales','Rentals','Scheduler'], is_active: true },
    { id: 'marine', name: 'Marine', industry: 'marine', nav_buttons: ['Business','Customers','Boats','Settings'], action_buttons: ['Service','Parts','Rentals','Storage','Scheduler'], is_active: true }
  ];
}

function renderPresets() {
  document.getElementById('presetsLoading').style.display = 'none';
  document.getElementById('presetsTable').style.display = 'table';
  document.getElementById('presetsTableBody').innerHTML = presets.map(p => `<tr>
    <td><strong>${p.name}</strong><br><small style="color:#94a3b8;">${p.description||''}</small></td>
    <td><span class="category-badge cat-fees">${p.industry||'other'}</span></td>
    <td style="font-size:11px;">${[...(p.nav_buttons||[]),...(p.action_buttons||[])].slice(0,5).join(', ')}...</td>
    <td><span class="category-badge cat-${p.is_active?'services':'operations'}">${p.is_active?'Active':'Inactive'}</span></td>
    <td>
      <button class="action-btn" onclick="editPreset('${p.id}')">Edit</button>
      <button class="action-btn delete" onclick="deletePreset('${p.id}')">Delete</button>
    </td>
  </tr>`).join('');
}

function populatePresetSelect() {
  document.getElementById('uiPreset').innerHTML = presets.filter(p=>p.is_active).map(p => 
    `<option value="${p.id}">${p.name} (${p.industry})</option>`
  ).join('');
}

function populatePresetModal() {
  // Nav buttons with label inputs
  document.getElementById('presetNavButtons').innerHTML = ALL_NAV_BUTTONS.map(b => `
    <div class="button-label-item">
      <input type="checkbox" value="${b}" onchange="toggleButtonLabel(this); updatePresetPreview()">
      <span class="btn-id">${b}</span>
      <input type="text" id="label_${b}" placeholder="${b}" value="${b}" disabled onkeyup="updatePresetPreview()">
    </div>
  `).join('');
  
  // Action buttons with label inputs
  document.getElementById('presetActionButtons').innerHTML = ALL_ACTION_BUTTONS.map(b => `
    <div class="button-label-item">
      <input type="checkbox" value="${b}" onchange="toggleButtonLabel(this); updatePresetPreview()">
      <span class="btn-id">${b}</span>
      <input type="text" id="label_${b}" placeholder="${b}" value="${b}" disabled onkeyup="updatePresetPreview()">
    </div>
  `).join('');
}

function toggleButtonLabel(checkbox) {
  const labelInput = document.getElementById('label_' + checkbox.value);
  if (labelInput) {
    labelInput.disabled = !checkbox.checked;
    if (checkbox.checked && !labelInput.value) {
      labelInput.value = checkbox.value;
    }
  }
}

function updatePresetPreview() {
  const nav = [...document.querySelectorAll('#presetNavButtons input[type="checkbox"]:checked')].map(c => {
    const label = document.getElementById('label_' + c.value)?.value || c.value;
    return `<span class="preview-btn primary">${label}</span>`;
  });
  const action = [...document.querySelectorAll('#presetActionButtons input[type="checkbox"]:checked')].map(c => {
    const label = document.getElementById('label_' + c.value)?.value || c.value;
    return `<span class="preview-btn">${label}</span>`;
  });
  document.getElementById('presetPreview').innerHTML = 
    nav.join('') + action.join('') || '<span style="color:#94a3b8;">Select buttons...</span>';
}

function getButtonLabels() {
  const labels = {};
  [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS].forEach(btn => {
    const checkbox = document.querySelector(`#presetNavButtons input[value="${btn}"], #presetActionButtons input[value="${btn}"]`);
    const labelInput = document.getElementById('label_' + btn);
    if (checkbox?.checked && labelInput?.value && labelInput.value !== btn) {
      labels[btn] = labelInput.value;
    }
  });
  return labels;
}

function setButtonLabels(labels) {
  Object.entries(labels || {}).forEach(([btn, label]) => {
    const labelInput = document.getElementById('label_' + btn);
    if (labelInput) {
      labelInput.value = label;
    }
  });
}

function openPresetModal() {
  populatePresetModal(); // Refresh the modal
  document.getElementById('editPresetId').value = '';
  document.getElementById('presetName').value = '';
  document.getElementById('presetIndustry').value = 'automotive';
  document.getElementById('presetDescription').value = '';
  document.getElementById('presetIsActive').value = 'true';
  document.querySelectorAll('#presetNavButtons input[type="checkbox"], #presetActionButtons input[type="checkbox"]').forEach(c => {
    c.checked = false;
    toggleButtonLabel(c);
  });
  document.getElementById('presetPreview').innerHTML = '<span style="color:#94a3b8;">Select buttons...</span>';
  document.getElementById('presetModalTitle').textContent = 'Add UI Preset';
  document.getElementById('presetModal').classList.add('active');
}

function closePresetModal() { document.getElementById('presetModal').classList.remove('active'); }

function editPreset(id) {
  populatePresetModal(); // Refresh the modal first
  const p = presets.find(x => x.id === id);
  if (!p) return;
  document.getElementById('editPresetId').value = p.id;
  document.getElementById('presetName').value = p.name || '';
  document.getElementById('presetIndustry').value = p.industry || 'other';
  document.getElementById('presetDescription').value = p.description || '';
  document.getElementById('presetIsActive').value = p.is_active ? 'true' : 'false';
  
  // Set checked buttons and enable their label inputs
  document.querySelectorAll('#presetNavButtons input[type="checkbox"]').forEach(c => {
    c.checked = (p.nav_buttons||[]).includes(c.value);
    toggleButtonLabel(c);
  });
  document.querySelectorAll('#presetActionButtons input[type="checkbox"]').forEach(c => {
    c.checked = (p.action_buttons||[]).includes(c.value);
    toggleButtonLabel(c);
  });
  
  // Set custom labels
  setButtonLabels(p.button_labels);
  
  updatePresetPreview();
  document.getElementById('presetModalTitle').textContent = 'Edit UI Preset';
  document.getElementById('presetModal').classList.add('active');
}

async function savePreset() {
  const id = document.getElementById('editPresetId').value;
  const name = document.getElementById('presetName').value.trim();
  if (!name) { alert('Name required'); return; }
  
  const data = {
    name: name,
    industry: document.getElementById('presetIndustry').value,
    description: document.getElementById('presetDescription').value.trim(),
    nav_buttons: [...document.querySelectorAll('#presetNavButtons input[type="checkbox"]:checked')].map(c=>c.value),
    action_buttons: [...document.querySelectorAll('#presetActionButtons input[type="checkbox"]:checked')].map(c=>c.value),
    button_labels: getButtonLabels(),
    is_active: document.getElementById('presetIsActive').value === 'true',
    updated_at: new Date().toISOString()
  };
  
  try {
    if (id) {
      await supabaseClient.from('ui_presets').update(data).eq('id', id);
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      data.created_at = new Date().toISOString();
      await supabaseClient.from('ui_presets').insert([data]);
    }
    alert('Saved!'); closePresetModal(); await loadPresets();
  } catch (e) {
    // Save locally if table doesn't exist
    if (id) {
      const idx = presets.findIndex(x => x.id === id);
      if (idx >= 0) presets[idx] = {...presets[idx], ...data};
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      presets.push(data);
    }
    alert('Saved locally!'); closePresetModal(); renderPresets(); populatePresetSelect();
  }
}

async function deletePreset(id) {
  if (!confirm('Delete?')) return;
  try { await supabaseClient.from('ui_presets').delete().eq('id', id); } catch(e) {}
  presets = presets.filter(p => p.id !== id);
  renderPresets(); populatePresetSelect();
}

// ===== ROLE PERMISSIONS =====
async function loadRolePermissions() {
  rolePermissions = {
    owner: [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS],
    manager: ['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Inbox','Tasks'],
    technician: ['Customers','Vehicles','Service','Parts','Scheduler','Tasks'],
    admin: ['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Inbox','Tasks','Billing']
  };
  try {
    const { data } = await supabaseClient.from('role_permissions').select('*');
    if (data) data.forEach(r => rolePermissions[r.role] = r.allowed_buttons || []);
  } catch(e) {}
}

function populateRolePermissions() {
  const all = [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS];
  ['manager','technician','admin'].forEach(role => {
    const c = document.getElementById(role + 'Buttons');
    if (!c) return;
    c.innerHTML = all.map(b => {
      const chk = (rolePermissions[role]||[]).includes(b) ? 'checked' : '';
      return `<label class="checkbox-item"><input type="checkbox" value="${b}" data-role="${role}" ${chk}><span>${b}</span></label>`;
    }).join('');
  });
}

async function saveRolePermissions() {
  ['manager','technician','admin'].forEach(async role => {
    const btns = [...document.querySelectorAll(`#${role}Buttons input:checked`)].map(c=>c.value);
    rolePermissions[role] = btns;
    try { await supabaseClient.from('role_permissions').upsert({role, allowed_buttons: btns, updated_at: new Date().toISOString()}, {onConflict:'role'}); } catch(e) {}
  });
  document.getElementById('rolesSaveMessage').innerHTML = '<span style="color:#4ade80;">Saved!</span>';
  setTimeout(() => document.getElementById('rolesSaveMessage').innerHTML = '', 3000);
}

// ===== TENANTS =====
async function loadTenants() {
  try {
    const { data } = await supabaseClient.from('tenants').select('*, subscription_tiers(tier_display_name)').order('created_at', {ascending:false});
    tenants = data || [];
    for (let t of tenants) {
      const { data: owner } = await supabaseClient.from('users').select('email').eq('tenant_id', t.tenant_id).eq('role', 'owner').limit(1).single();
      t.owner = owner;
    }
    renderTenants();
  } catch(e) { console.error(e); }
}

function renderTenants() {
  document.getElementById('tenantsLoading').style.display = 'none';
  document.getElementById('tenantsTable').style.display = 'table';
  document.getElementById('tenantsTableBody').innerHTML = tenants.map(t => {
    const preset = presets.find(p => p.id === t.ui_preset_id)?.name || t.ui_preset_id || 'Default';
    return `<tr>
      <td><strong>${t.company_name||t.tenant_name}</strong></td>
      <td>${t.owner?.email||t.billing_email||'-'}</td>
      <td><span class="category-badge cat-fees">${preset}</span></td>
      <td>${t.subscription_tiers?.tier_display_name||'None'}</td>
      <td>$${(t.monthly_recurring_revenue||0).toFixed(2)}</td>
      <td><span class="category-badge cat-${t.status==='active'?'services':'operations'}">${t.status}</span></td>
      <td>
        <button class="action-btn" onclick="editTenant('${t.tenant_id}')">Edit</button>
        <button class="action-btn delete" onclick="deleteTenant('${t.tenant_id}')">Delete</button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="7" style="text-align:center;color:#94a3b8;">No tenants</td></tr>';
}

async function addTenantAndUser() {
  const name = document.getElementById('userName').value.trim();
  const email = document.getElementById('userEmail').value.trim();
  const company = document.getElementById('companyName').value.trim();
  if (!name || !email || !company) { alert('Name, email, and company required'); return; }
  
  const now = new Date().toISOString();
  const tier = tiers.find(t => t.tier_id === document.getElementById('userTier').value);
  
  try {
    // UPDATE existing tenant
    if (editingTenantId) {
      await supabaseClient.from('tenants').update({
        tenant_name: company, 
        company_name: company,
        domain: document.getElementById('userDomain').value.trim() || null,
        ui_preset_id: document.getElementById('uiPreset').value || null,
        tier_id: document.getElementById('userTier').value || null,
        status: document.getElementById('userStatus').value,
        billing_cycle: document.getElementById('billingCycle').value,
        billing_email: email,
        monthly_recurring_revenue: tier?.monthly_price || 0,
        metadata: { notes: document.getElementById('userNotes').value },
        updated_at: now
      }).eq('tenant_id', editingTenantId);
      
      alert(`Updated!\nCompany: ${company}\nPreset: ${presets.find(p=>p.id===document.getElementById('uiPreset').value)?.name||'Default'}`);
      cancelEdit();
      await loadTenants();
      return;
    }
    
    // CREATE new tenant
    const tenantId = crypto.randomUUID();
    const userId = crypto.randomUUID();
    
    await supabaseClient.from('tenants').insert([{
      tenant_id: tenantId, tenant_name: company, company_name: company,
      domain: document.getElementById('userDomain').value.trim() || null,
      ui_preset_id: document.getElementById('uiPreset').value || null,
      tier_id: document.getElementById('userTier').value || null,
      status: document.getElementById('userStatus').value,
      billing_cycle: document.getElementById('billingCycle').value,
      billing_email: email,
      monthly_recurring_revenue: tier?.monthly_price || 0,
      metadata: { notes: document.getElementById('userNotes').value },
      created_at: now, updated_at: now
    }]);
    
    await supabaseClient.from('users').insert([{
      user_id: userId, tenant_id: tenantId, email, role: 'owner', is_active: true, created_at: now, updated_at: now
    }]);
    
    const nameParts = name.split(' ');
    await supabaseClient.from('employees').insert([{
      employee_id: crypto.randomUUID(), tenant_id: tenantId, user_id: userId,
      first_name: nameParts[0], last_name: nameParts.slice(1).join(' ') || '',
      email, role: 'owner', is_active: true, created_at: now
    }]);
    
    await supabaseClient.from('business_settings').insert([{
      tenant_id: tenantId, business_name: company, created_at: now, updated_at: now
    }]);
    
    alert(`Created!\nCompany: ${company}\nOwner: ${name}\nPreset: ${presets.find(p=>p.id===document.getElementById('uiPreset').value)?.name||'Default'}`);
    document.getElementById('userName').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('companyName').value = '';
    document.getElementById('userDomain').value = '';
    document.getElementById('userNotes').value = '';
    await loadTenants();
  } catch(e) { alert('Error: ' + e.message); }
}

let editingTenantId = null;

function editTenant(id) {
  const t = tenants.find(x => x.tenant_id === id);
  if (!t) return;
  editingTenantId = id;
  document.getElementById('userName').value = t.tenant_name || '';
  document.getElementById('userEmail').value = t.owner?.email || t.billing_email || '';
  document.getElementById('companyName').value = t.company_name || '';
  document.getElementById('userDomain').value = t.domain || '';
  document.getElementById('uiPreset').value = t.ui_preset_id || '';
  document.getElementById('userTier').value = t.tier_id || '';
  document.getElementById('userStatus').value = t.status || 'active';
  document.getElementById('billingCycle').value = t.billing_cycle || 'monthly';
  document.getElementById('userNotes').value = t.metadata?.notes || '';
  
  // Update button text and show cancel
  const btn = document.querySelector('.panel-title .btn.success');
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (btn) btn.textContent = 'Update Tenant';
  if (cancelBtn) cancelBtn.style.display = 'inline-block';
  
  window.scrollTo(0, 0);
}

function cancelEdit() {
  editingTenantId = null;
  document.getElementById('userName').value = '';
  document.getElementById('userEmail').value = '';
  document.getElementById('companyName').value = '';
  document.getElementById('userDomain').value = '';
  document.getElementById('userNotes').value = '';
  
  const btn = document.querySelector('.panel-title .btn.success');
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (btn) btn.textContent = 'Add Tenant';
  if (cancelBtn) cancelBtn.style.display = 'none';
}

async function deleteTenant(id) {
  if (!confirm('Delete tenant and all data?')) return;
  try {
    await supabaseClient.from('employees').delete().eq('tenant_id', id);
    await supabaseClient.from('users').delete().eq('tenant_id', id);
    await supabaseClient.from('business_settings').delete().eq('tenant_id', id);
    await supabaseClient.from('tenants').delete().eq('tenant_id', id);
    await loadTenants();
  } catch(e) { alert('Error: ' + e.message); }
}

init();
</script>
</body>
</html>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Settings - Live Data</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0b0f14;
      min-height: 100vh;
      padding: 20px;
      color: #e8eef6;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { color: #60a5fa; font-size: 28px; font-weight: 700; }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #2d3f56;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: white;
      background: #3b82f6;
      font-size: 14px;
    }

    .btn:hover { background: #2563eb; transform: translateY(-2px); }
    .btn.success { background: #10b981; }
    .btn.success:hover { background: #059669; }
    .btn.secondary { background: #374151; border-color: #4b5563; }
    .btn.secondary:hover { background: #4b5563; }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: #0f1621;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #2d3f56;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid transparent;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
    }

    .tab:hover { background: #1a2535; color: #e8eef6; }
    .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .panel {
      background: #0f1621;
      border: 1px solid #2d3f56;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .panel-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #2d3f56;
      font-size: 18px;
      font-weight: 700;
      color: #60a5fa;
      flex-wrap: wrap;
      gap: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full-width { grid-column: 1 / -1; }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select, .form-textarea {
      background: #1a2535;
      border: 1px solid #2d3f56;
      border-radius: 8px;
      padding: 12px;
      color: #e8eef6;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea { resize: vertical; min-height: 80px; }

    .cost-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .cost-table th {
      background: #1a2535;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #2d3f56;
    }

    .cost-table td {
      padding: 12px;
      border-bottom: 1px solid #2d3f56;
      vertical-align: top;
    }

    .cost-table tr:hover { background: #1a2535; }

    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cat-infrastructure { background: #7f1d1d; color: #fca5a5; }
    .cat-services { background: #78350f; color: #fcd34d; }
    .cat-fees { background: #1e3a8a; color: #93c5fd; }
    .cat-operations { background: #581c87; color: #d8b4fe; }

    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 4px;
      transition: all 0.2s;
    }

    .action-btn:hover { background: #2563eb; }
    .action-btn.delete { background: #dc2626; }
    .action-btn.delete:hover { background: #b91c1c; }

    .loading { text-align: center; padding: 40px; color: #94a3b8; }
    
    .info-box {
      background: #1e3a5f;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #93c5fd;
    }
    
    .button-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      background: #0b0f14;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .preview-btn {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #2d3f56;
      background: #1a2535;
      color: #e8eef6;
    }
    
    .preview-btn.primary { background: #3b82f6; border-color: #3b82f6; }
    
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1a2535;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .checkbox-item:hover { background: #243448; }
    .checkbox-item input { width: 16px; height: 16px; cursor: pointer; }
    .checkbox-item label { font-size: 13px; cursor: pointer; flex: 1; }
    
    .role-section {
      background: #1a2535;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .role-header {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 12px;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.75);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-overlay.active { display: flex; }
    
    .modal-content {
      background: #0f1621;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #2d3f56;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #2d3f56;
      position: sticky;
      top: 0;
      background: #0f1621;
      z-index: 10;
    }
    
    .modal-title { font-size: 18px; font-weight: 700; color: #60a5fa; }
    .modal-close { background: transparent; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #2d3f56; display: flex; gap: 10px; justify-content: flex-end; }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .tabs { flex-direction: column; }
      .tab { text-align: center; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Admin Settings</h1>
    <a href="dashboard-business.html" class="btn">‚Üê Back to Dashboard</a>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('tenants')">Tenants</div>
    <div class="tab" onclick="switchTab('tiers')">Subscription Tiers</div>
    <div class="tab" onclick="switchTab('presets')">UI Presets</div>
    <div class="tab" onclick="switchTab('roles')">Role Permissions</div>
  </div>

  <!-- ========== TENANTS TAB ========== -->
  <div class="tab-content active" id="tenants">
    <div class="panel">
      <div class="panel-title">
        <span>Add New Tenant & Owner</span>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;">Cancel</button>
          <button class="btn success" onclick="addTenantAndUser()">Add Tenant</button>
        </div>
      </div>
      
      <div class="info-box">
        Creates a new tenant (company), owner user account, and assigns a UI preset. The owner can then add employees from their Settings page.
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Owner Full Name *</label>
          <input type="text" class="form-input" id="userName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label class="form-label">Owner Email *</label>
          <input type="email" class="form-input" id="userEmail" placeholder="owner@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Company Name *</label>
          <input type="text" class="form-input" id="companyName" placeholder="Acme Corp">
        </div>
        <div class="form-group">
          <label class="form-label">Domain</label>
          <input type="text" class="form-input" id="userDomain" placeholder="acme.example.com">
        </div>
        <div class="form-group">
          <label class="form-label">UI Preset *</label>
          <select class="form-select" id="uiPreset"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Subscription Tier</label>
          <select class="form-select" id="userTier"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Account Status</label>
          <select class="form-select" id="userStatus">
            <option value="active">Active</option>
            <option value="trial">Trial</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Billing Cycle</label>
          <select class="form-select" id="billingCycle">
            <option value="monthly">Monthly</option>
            <option value="annual">Annual</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="userNotes" placeholder="Internal notes..."></textarea>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">
        <span>Current Tenants</span>
        <button class="btn" onclick="loadTenants()">Refresh</button>
      </div>
      <div id="tenantsLoading" class="loading">Loading...</div>
      <table class="cost-table" id="tenantsTable" style="display:none;">
        <thead>
          <tr>
            <th>Company</th>
            <th>Owner</th>
            <th>UI Preset</th>
            <th>Tier</th>
            <th>MRR</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tenantsTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ========== TIERS TAB ========== -->
  <div class="tab-content" id="tiers">
    <div class="panel">
      <div class="panel-title">
        <span>Subscription Tiers</span>
        <button class="btn success" onclick="openTierModal()">+ Add Tier</button>
      </div>
      <div class="info-box">Define pricing tiers. If using Stripe, add Price IDs from your Stripe Dashboard.</div>
      <div id="tiersLoading" class="loading">Loading...</div>
      <table class="cost-table" id="tiersTable" style="display:none;">
        <thead>
          <tr><th>Tier Name</th><th>Monthly</th><th>Annual</th><th>Limits</th><th>Active</th><th>Actions</th></tr>
        </thead>
        <tbody id="tiersTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ========== UI PRESETS TAB ========== -->
  <div class="tab-content" id="presets">
    <div class="panel">
      <div class="panel-title">
        <span>UI Presets (Industry Layouts)</span>
        <button class="btn success" onclick="openPresetModal()">+ Add Preset</button>
      </div>
      <div class="info-box">UI Presets define which buttons/features are available for different industries.</div>
      <div id="presetsLoading" class="loading">Loading...</div>
      <table class="cost-table" id="presetsTable" style="display:none;">
        <thead>
          <tr><th>Preset Name</th><th>Industry</th><th>Buttons</th><th>Active</th><th>Actions</th></tr>
        </thead>
        <tbody id="presetsTableBody"></tbody>
      </table>
    </div>
    
    <div class="panel">
      <div class="panel-title">Built-in Preset Templates</div>
      <div style="display:grid; gap:16px;">
        <div class="role-section">
          <div class="role-header">Car Dealership</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Vehicles</span>
            <span class="preview-btn">Service</span>
            <span class="preview-btn">Parts</span>
            <span class="preview-btn">Sales</span>
            <span class="preview-btn">Fleet</span>
            <span class="preview-btn">Scheduler</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Traveling Salesman</div>
          <div class="button-preview">
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Appointments</span>
            <span class="preview-btn">Routes</span>
            <span class="preview-btn">Calendar</span>
            <span class="preview-btn">Leads</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Law Firm</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Clients</span>
            <span class="preview-btn primary">Cases</span>
            <span class="preview-btn">Tasks</span>
            <span class="preview-btn">Calendar</span>
            <span class="preview-btn">Billing</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Powersports / Marine</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Units</span>
            <span class="preview-btn">Service</span>
            <span class="preview-btn">Parts</span>
            <span class="preview-btn">Rentals</span>
            <span class="preview-btn">Storage</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ROLE PERMISSIONS TAB ========== -->
  <div class="tab-content" id="roles">
    <div class="panel">
      <div class="panel-title">
        <span>Role-Based Button Visibility</span>
        <button class="btn" onclick="saveRolePermissions()">Save Permissions</button>
      </div>
      <div class="info-box">Configure which buttons each role can see. Owners always see everything.</div>
      
      <div class="role-section">
        <div class="role-header">Owner - Full Access (cannot be restricted)</div>
      </div>
      
      <div class="role-section">
        <div class="role-header">Manager</div>
        <div class="checkbox-grid" id="managerButtons"></div>
      </div>
      
      <div class="role-section">
        <div class="role-header">Technician</div>
        <div class="checkbox-grid" id="technicianButtons"></div>
      </div>
      
      <div class="role-section">
        <div class="role-header">Admin</div>
        <div class="checkbox-grid" id="adminButtons"></div>
      </div>
      
      <div id="rolesSaveMessage" style="margin-top:16px;"></div>
    </div>
  </div>
</div>

<!-- TIER MODAL -->
<div class="modal-overlay" id="tierModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="tierModalTitle">Add Tier</h3>
      <button class="modal-close" onclick="closeTierModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editTierId" />
      <div class="form-group">
        <label class="form-label">Tier Name *</label>
        <input type="text" class="form-input" id="tierName" style="width:100%;">
      </div>
      <div class="form-group">
        <label class="form-label">Display Name</label>
        <input type="text" class="form-input" id="tierDisplayName" style="width:100%;">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Monthly Price ($) *</label>
          <input type="number" class="form-input" id="tierMonthlyPrice" step="0.01" style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Annual Price ($)</label>
          <input type="number" class="form-input" id="tierAnnualPrice" step="0.01" style="width:100%;">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Max Users</label>
          <input type="number" class="form-input" id="tierMaxUsers" style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Max Vehicles</label>
          <input type="number" class="form-input" id="tierMaxVehicles" style="width:100%;">
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Stripe Monthly ID</label>
          <input type="text" class="form-input" id="tierStripeMonthly" placeholder="price_..." style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Sort Order</label>
          <input type="number" class="form-input" id="tierSortOrder" style="width:100%;">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Features (one per line)</label>
        <textarea class="form-textarea" id="tierFeatures" style="width:100%;"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="tierIsActive" style="width:100%;">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeTierModal()">Cancel</button>
      <button class="btn success" onclick="saveTier()">Save</button>
    </div>
  </div>
</div>

<!-- PRESET MODAL -->
<div class="modal-overlay" id="presetModal">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h3 class="modal-title" id="presetModalTitle">Add UI Preset</h3>
      <button class="modal-close" onclick="closePresetModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editPresetId" />
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Preset Name *</label>
          <input type="text" class="form-input" id="presetName" style="width:100%;">
        </div>
        <div class="form-group">
          <label class="form-label">Industry</label>
          <select class="form-select" id="presetIndustry" style="width:100%;">
            <option value="automotive">Automotive</option>
            <option value="powersports">Powersports</option>
            <option value="marine">Marine</option>
            <option value="field_sales">Field Sales</option>
            <option value="legal">Legal</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" class="form-input" id="presetDescription" style="width:100%;">
      </div>
      <div class="form-group">
        <label class="form-label">Navigation Buttons</label>
        <div class="checkbox-grid" id="presetNavButtons"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Action Buttons</label>
        <div class="checkbox-grid" id="presetActionButtons"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="presetIsActive" style="width:100%;">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Preview</label>
        <div class="button-preview" id="presetPreview"><span style="color:#94a3b8;">Select buttons...</span></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closePresetModal()">Cancel</button>
      <button class="btn success" onclick="savePreset()">Save</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ALL_NAV_BUTTONS = ['Business', 'Customers', 'Vehicles', 'Clients', 'Cases', 'Units', 'Boats', 'Settings'];
const ALL_ACTION_BUTTONS = ['Service', 'Parts', 'Sales', 'Fleet', 'Rentals', 'Scheduler', 'Calendar', 'Routes', 'Leads', 'Tasks', 'Documents', 'Billing', 'Storage', 'Inbox'];

let tiers = [], tenants = [], presets = [], rolePermissions = {};

async function init() {
  await Promise.all([loadTiers(), loadTenants(), loadPresets(), loadRolePermissions()]);
  populatePresetModal();
  populateRolePermissions();
}

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tabName).classList.add('active');
}

// ===== TIERS =====
async function loadTiers() {
  try {
    const { data, error } = await supabaseClient.from('subscription_tiers').select('*').order('sort_order');
    if (error) throw error;
    tiers = data || [];
    renderTiers();
    populateTierSelect();
  } catch (e) { console.error(e); }
}

function renderTiers() {
  document.getElementById('tiersLoading').style.display = 'none';
  document.getElementById('tiersTable').style.display = 'table';
  const tbody = document.getElementById('tiersTableBody');
  if (tiers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No tiers</td></tr>';
    return;
  }
  tbody.innerHTML = tiers.map(t => {
    const limits = [];
    if (t.max_users) limits.push(t.max_users + ' users');
    if (t.max_vehicles) limits.push(t.max_vehicles + ' vehicles');
    return `<tr>
      <td><strong>${t.tier_display_name || t.tier_name}</strong></td>
      <td>$${(t.monthly_price||0).toFixed(2)}</td>
      <td>$${(t.annual_price||0).toFixed(2)}</td>
      <td style="font-size:11px;color:#94a3b8;">${limits.join(', ')||'Unlimited'}</td>
      <td><span class="category-badge cat-${t.is_active?'services':'operations'}">${t.is_active?'Active':'Inactive'}</span></td>
      <td>
        <button class="action-btn" onclick="editTier('${t.tier_id}')">Edit</button>
        <button class="action-btn delete" onclick="deleteTier('${t.tier_id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function populateTierSelect() {
  document.getElementById('userTier').innerHTML = '<option value="">-- Select --</option>' + 
    tiers.filter(t=>t.is_active).map(t => `<option value="${t.tier_id}">${t.tier_display_name||t.tier_name} - $${t.monthly_price}/mo</option>`).join('');
}

function openTierModal() {
  document.getElementById('editTierId').value = '';
  document.getElementById('tierName').value = '';
  document.getElementById('tierDisplayName').value = '';
  document.getElementById('tierMonthlyPrice').value = '';
  document.getElementById('tierAnnualPrice').value = '';
  document.getElementById('tierMaxUsers').value = '';
  document.getElementById('tierMaxVehicles').value = '';
  document.getElementById('tierStripeMonthly').value = '';
  document.getElementById('tierSortOrder').value = tiers.length;
  document.getElementById('tierFeatures').value = '';
  document.getElementById('tierIsActive').value = 'true';
  document.getElementById('tierModalTitle').textContent = 'Add Tier';
  document.getElementById('tierModal').classList.add('active');
}

function closeTierModal() { document.getElementById('tierModal').classList.remove('active'); }

function editTier(id) {
  const t = tiers.find(x => x.tier_id === id);
  if (!t) return;
  document.getElementById('editTierId').value = t.tier_id;
  document.getElementById('tierName').value = t.tier_name || '';
  document.getElementById('tierDisplayName').value = t.tier_display_name || '';
  document.getElementById('tierMonthlyPrice').value = t.monthly_price || '';
  document.getElementById('tierAnnualPrice').value = t.annual_price || '';
  document.getElementById('tierMaxUsers').value = t.max_users || '';
  document.getElementById('tierMaxVehicles').value = t.max_vehicles || '';
  document.getElementById('tierStripeMonthly').value = t.stripe_price_id_monthly || '';
  document.getElementById('tierSortOrder').value = t.sort_order || 0;
  document.getElementById('tierFeatures').value = (t.features || []).join('\n');
  document.getElementById('tierIsActive').value = t.is_active ? 'true' : 'false';
  document.getElementById('tierModalTitle').textContent = 'Edit Tier';
  document.getElementById('tierModal').classList.add('active');
}

async function saveTier() {
  const id = document.getElementById('editTierId').value;
  const name = document.getElementById('tierName').value.trim();
  const monthly = parseFloat(document.getElementById('tierMonthlyPrice').value) || 0;
  if (!name || monthly <= 0) { alert('Name and price required'); return; }
  
  const data = {
    tier_name: name,
    tier_display_name: document.getElementById('tierDisplayName').value.trim() || name,
    monthly_price: monthly,
    annual_price: parseFloat(document.getElementById('tierAnnualPrice').value) || (monthly * 10),
    max_users: parseInt(document.getElementById('tierMaxUsers').value) || null,
    max_vehicles: parseInt(document.getElementById('tierMaxVehicles').value) || null,
    stripe_price_id_monthly: document.getElementById('tierStripeMonthly').value.trim() || null,
    sort_order: parseInt(document.getElementById('tierSortOrder').value) || 0,
    features: document.getElementById('tierFeatures').value.trim().split('\n').filter(f => f.trim()),
    is_active: document.getElementById('tierIsActive').value === 'true',
    updated_at: new Date().toISOString()
  };
  
  try {
    if (id) {
      await supabaseClient.from('subscription_tiers').update(data).eq('tier_id', id);
    } else {
      data.created_at = new Date().toISOString();
      await supabaseClient.from('subscription_tiers').insert([data]);
    }
    alert('Saved!'); closeTierModal(); await loadTiers();
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteTier(id) {
  if (!confirm('Delete this tier?')) return;
  try {
    await supabaseClient.from('subscription_tiers').delete().eq('tier_id', id);
    await loadTiers();
  } catch (e) { alert('Error: ' + e.message); }
}

// ===== PRESETS =====
async function loadPresets() {
  try {
    const { data, error } = await supabaseClient.from('ui_presets').select('*').order('name');
    if (error) throw error;
    presets = data || [];
    if (presets.length === 0) presets = getDefaultPresets();
  } catch (e) {
    presets = getDefaultPresets();
  }
  renderPresets();
  populatePresetSelect();
}

function getDefaultPresets() {
  return [
    { id: 'car_dealership', name: 'Car Dealership', industry: 'automotive', nav_buttons: ['Business','Customers','Vehicles','Settings'], action_buttons: ['Service','Parts','Sales','Fleet','Scheduler'], is_active: true },
    { id: 'traveling_salesman', name: 'Traveling Salesman', industry: 'field_sales', nav_buttons: ['Customers','Settings'], action_buttons: ['Calendar','Routes','Leads','Tasks'], is_active: true },
    { id: 'law_firm', name: 'Law Firm', industry: 'legal', nav_buttons: ['Business','Clients','Cases','Settings'], action_buttons: ['Tasks','Calendar','Documents','Billing'], is_active: true },
    { id: 'powersports', name: 'Powersports', industry: 'powersports', nav_buttons: ['Business','Customers','Units','Settings'], action_buttons: ['Service','Parts','Sales','Rentals','Scheduler'], is_active: true },
    { id: 'marine', name: 'Marine', industry: 'marine', nav_buttons: ['Business','Customers','Boats','Settings'], action_buttons: ['Service','Parts','Rentals','Storage','Scheduler'], is_active: true }
  ];
}

function renderPresets() {
  document.getElementById('presetsLoading').style.display = 'none';
  document.getElementById('presetsTable').style.display = 'table';
  document.getElementById('presetsTableBody').innerHTML = presets.map(p => `<tr>
    <td><strong>${p.name}</strong><br><small style="color:#94a3b8;">${p.description||''}</small></td>
    <td><span class="category-badge cat-fees">${p.industry||'other'}</span></td>
    <td style="font-size:11px;">${[...(p.nav_buttons||[]),...(p.action_buttons||[])].slice(0,5).join(', ')}...</td>
    <td><span class="category-badge cat-${p.is_active?'services':'operations'}">${p.is_active?'Active':'Inactive'}</span></td>
    <td>
      <button class="action-btn" onclick="editPreset('${p.id}')">Edit</button>
      <button class="action-btn delete" onclick="deletePreset('${p.id}')">Delete</button>
    </td>
  </tr>`).join('');
}

function populatePresetSelect() {
  document.getElementById('uiPreset').innerHTML = presets.filter(p=>p.is_active).map(p => 
    `<option value="${p.id}">${p.name} (${p.industry})</option>`
  ).join('');
}

function populatePresetModal() {
  document.getElementById('presetNavButtons').innerHTML = ALL_NAV_BUTTONS.map(b => 
    `<label class="checkbox-item"><input type="checkbox" value="${b}" onchange="updatePresetPreview()"><span>${b}</span></label>`
  ).join('');
  document.getElementById('presetActionButtons').innerHTML = ALL_ACTION_BUTTONS.map(b => 
    `<label class="checkbox-item"><input type="checkbox" value="${b}" onchange="updatePresetPreview()"><span>${b}</span></label>`
  ).join('');
}

function updatePresetPreview() {
  const nav = [...document.querySelectorAll('#presetNavButtons input:checked')].map(c=>c.value);
  const action = [...document.querySelectorAll('#presetActionButtons input:checked')].map(c=>c.value);
  document.getElementById('presetPreview').innerHTML = 
    nav.map(b=>`<span class="preview-btn primary">${b}</span>`).join('') +
    action.map(b=>`<span class="preview-btn">${b}</span>`).join('') || '<span style="color:#94a3b8;">Select buttons...</span>';
}

function openPresetModal() {
  document.getElementById('editPresetId').value = '';
  document.getElementById('presetName').value = '';
  document.getElementById('presetIndustry').value = 'automotive';
  document.getElementById('presetDescription').value = '';
  document.getElementById('presetIsActive').value = 'true';
  document.querySelectorAll('#presetNavButtons input, #presetActionButtons input').forEach(c => c.checked = false);
  document.getElementById('presetPreview').innerHTML = '<span style="color:#94a3b8;">Select buttons...</span>';
  document.getElementById('presetModalTitle').textContent = 'Add UI Preset';
  document.getElementById('presetModal').classList.add('active');
}

function closePresetModal() { document.getElementById('presetModal').classList.remove('active'); }

function editPreset(id) {
  const p = presets.find(x => x.id === id);
  if (!p) return;
  document.getElementById('editPresetId').value = p.id;
  document.getElementById('presetName').value = p.name || '';
  document.getElementById('presetIndustry').value = p.industry || 'other';
  document.getElementById('presetDescription').value = p.description || '';
  document.getElementById('presetIsActive').value = p.is_active ? 'true' : 'false';
  document.querySelectorAll('#presetNavButtons input').forEach(c => c.checked = (p.nav_buttons||[]).includes(c.value));
  document.querySelectorAll('#presetActionButtons input').forEach(c => c.checked = (p.action_buttons||[]).includes(c.value));
  updatePresetPreview();
  document.getElementById('presetModalTitle').textContent = 'Edit UI Preset';
  document.getElementById('presetModal').classList.add('active');
}

async function savePreset() {
  const id = document.getElementById('editPresetId').value;
  const name = document.getElementById('presetName').value.trim();
  if (!name) { alert('Name required'); return; }
  
  const data = {
    name: name,
    industry: document.getElementById('presetIndustry').value,
    description: document.getElementById('presetDescription').value.trim(),
    nav_buttons: [...document.querySelectorAll('#presetNavButtons input:checked')].map(c=>c.value),
    action_buttons: [...document.querySelectorAll('#presetActionButtons input:checked')].map(c=>c.value),
    is_active: document.getElementById('presetIsActive').value === 'true',
    updated_at: new Date().toISOString()
  };
  
  try {
    if (id) {
      await supabaseClient.from('ui_presets').update(data).eq('id', id);
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      data.created_at = new Date().toISOString();
      await supabaseClient.from('ui_presets').insert([data]);
    }
    alert('Saved!'); closePresetModal(); await loadPresets();
  } catch (e) {
    // Save locally if table doesn't exist
    if (id) {
      const idx = presets.findIndex(x => x.id === id);
      if (idx >= 0) presets[idx] = {...presets[idx], ...data};
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      presets.push(data);
    }
    alert('Saved locally!'); closePresetModal(); renderPresets(); populatePresetSelect();
  }
}

async function deletePreset(id) {
  if (!confirm('Delete?')) return;
  try { await supabaseClient.from('ui_presets').delete().eq('id', id); } catch(e) {}
  presets = presets.filter(p => p.id !== id);
  renderPresets(); populatePresetSelect();
}

// ===== ROLE PERMISSIONS =====
async function loadRolePermissions() {
  rolePermissions = {
    owner: [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS],
    manager: ['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Inbox','Tasks'],
    technician: ['Customers','Vehicles','Service','Parts','Scheduler','Tasks'],
    admin: ['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Inbox','Tasks','Billing']
  };
  try {
    const { data } = await supabaseClient.from('role_permissions').select('*');
    if (data) data.forEach(r => rolePermissions[r.role] = r.allowed_buttons || []);
  } catch(e) {}
}

function populateRolePermissions() {
  const all = [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS];
  ['manager','technician','admin'].forEach(role => {
    const c = document.getElementById(role + 'Buttons');
    if (!c) return;
    c.innerHTML = all.map(b => {
      const chk = (rolePermissions[role]||[]).includes(b) ? 'checked' : '';
      return `<label class="checkbox-item"><input type="checkbox" value="${b}" data-role="${role}" ${chk}><span>${b}</span></label>`;
    }).join('');
  });
}

async function saveRolePermissions() {
  ['manager','technician','admin'].forEach(async role => {
    const btns = [...document.querySelectorAll(`#${role}Buttons input:checked`)].map(c=>c.value);
    rolePermissions[role] = btns;
    try { await supabaseClient.from('role_permissions').upsert({role, allowed_buttons: btns, updated_at: new Date().toISOString()}, {onConflict:'role'}); } catch(e) {}
  });
  document.getElementById('rolesSaveMessage').innerHTML = '<span style="color:#4ade80;">Saved!</span>';
  setTimeout(() => document.getElementById('rolesSaveMessage').innerHTML = '', 3000);
}

// ===== TENANTS =====
async function loadTenants() {
  try {
    const { data } = await supabaseClient.from('tenants').select('*, subscription_tiers(tier_display_name)').order('created_at', {ascending:false});
    tenants = data || [];
    for (let t of tenants) {
      const { data: owner } = await supabaseClient.from('users').select('email').eq('tenant_id', t.tenant_id).eq('role', 'owner').limit(1).single();
      t.owner = owner;
    }
    renderTenants();
  } catch(e) { console.error(e); }
}

function renderTenants() {
  document.getElementById('tenantsLoading').style.display = 'none';
  document.getElementById('tenantsTable').style.display = 'table';
  document.getElementById('tenantsTableBody').innerHTML = tenants.map(t => {
    const preset = presets.find(p => p.id === t.ui_preset_id)?.name || t.ui_preset_id || 'Default';
    return `<tr>
      <td><strong>${t.company_name||t.tenant_name}</strong></td>
      <td>${t.owner?.email||t.billing_email||'-'}</td>
      <td><span class="category-badge cat-fees">${preset}</span></td>
      <td>${t.subscription_tiers?.tier_display_name||'None'}</td>
      <td>$${(t.monthly_recurring_revenue||0).toFixed(2)}</td>
      <td><span class="category-badge cat-${t.status==='active'?'services':'operations'}">${t.status}</span></td>
      <td>
        <button class="action-btn" onclick="editTenant('${t.tenant_id}')">Edit</button>
        <button class="action-btn delete" onclick="deleteTenant('${t.tenant_id}')">Delete</button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="7" style="text-align:center;color:#94a3b8;">No tenants</td></tr>';
}

async function addTenantAndUser() {
  const name = document.getElementById('userName').value.trim();
  const email = document.getElementById('userEmail').value.trim();
  const company = document.getElementById('companyName').value.trim();
  if (!name || !email || !company) { alert('Name, email, and company required'); return; }
  
  const now = new Date().toISOString();
  const tier = tiers.find(t => t.tier_id === document.getElementById('userTier').value);
  
  try {
    // UPDATE existing tenant
    if (editingTenantId) {
      await supabaseClient.from('tenants').update({
        tenant_name: company, 
        company_name: company,
        domain: document.getElementById('userDomain').value.trim() || null,
        ui_preset_id: document.getElementById('uiPreset').value || null,
        tier_id: document.getElementById('userTier').value || null,
        status: document.getElementById('userStatus').value,
        billing_cycle: document.getElementById('billingCycle').value,
        billing_email: email,
        monthly_recurring_revenue: tier?.monthly_price || 0,
        metadata: { notes: document.getElementById('userNotes').value },
        updated_at: now
      }).eq('tenant_id', editingTenantId);
      
      alert(`Updated!\nCompany: ${company}\nPreset: ${presets.find(p=>p.id===document.getElementById('uiPreset').value)?.name||'Default'}`);
      cancelEdit();
      await loadTenants();
      return;
    }
    
    // CREATE new tenant
    const tenantId = crypto.randomUUID();
    const userId = crypto.randomUUID();
    
    await supabaseClient.from('tenants').insert([{
      tenant_id: tenantId, tenant_name: company, company_name: company,
      domain: document.getElementById('userDomain').value.trim() || null,
      ui_preset_id: document.getElementById('uiPreset').value || null,
      tier_id: document.getElementById('userTier').value || null,
      status: document.getElementById('userStatus').value,
      billing_cycle: document.getElementById('billingCycle').value,
      billing_email: email,
      monthly_recurring_revenue: tier?.monthly_price || 0,
      metadata: { notes: document.getElementById('userNotes').value },
      created_at: now, updated_at: now
    }]);
    
    await supabaseClient.from('users').insert([{
      user_id: userId, tenant_id: tenantId, email, role: 'owner', is_active: true, created_at: now, updated_at: now
    }]);
    
    const nameParts = name.split(' ');
    await supabaseClient.from('employees').insert([{
      employee_id: crypto.randomUUID(), tenant_id: tenantId, user_id: userId,
      first_name: nameParts[0], last_name: nameParts.slice(1).join(' ') || '',
      email, role: 'owner', is_active: true, created_at: now
    }]);
    
    await supabaseClient.from('business_settings').insert([{
      tenant_id: tenantId, business_name: company, created_at: now, updated_at: now
    }]);
    
    alert(`Created!\nCompany: ${company}\nOwner: ${name}\nPreset: ${presets.find(p=>p.id===document.getElementById('uiPreset').value)?.name||'Default'}`);
    document.getElementById('userName').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('companyName').value = '';
    document.getElementById('userDomain').value = '';
    document.getElementById('userNotes').value = '';
    await loadTenants();
  } catch(e) { alert('Error: ' + e.message); }
}

let editingTenantId = null;

function editTenant(id) {
  const t = tenants.find(x => x.tenant_id === id);
  if (!t) return;
  editingTenantId = id;
  document.getElementById('userName').value = t.tenant_name || '';
  document.getElementById('userEmail').value = t.owner?.email || t.billing_email || '';
  document.getElementById('companyName').value = t.company_name || '';
  document.getElementById('userDomain').value = t.domain || '';
  document.getElementById('uiPreset').value = t.ui_preset_id || '';
  document.getElementById('userTier').value = t.tier_id || '';
  document.getElementById('userStatus').value = t.status || 'active';
  document.getElementById('billingCycle').value = t.billing_cycle || 'monthly';
  document.getElementById('userNotes').value = t.metadata?.notes || '';
  
  // Update button text and show cancel
  const btn = document.querySelector('.panel-title .btn.success');
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (btn) btn.textContent = 'Update Tenant';
  if (cancelBtn) cancelBtn.style.display = 'inline-block';
  
  window.scrollTo(0, 0);
}

function cancelEdit() {
  editingTenantId = null;
  document.getElementById('userName').value = '';
  document.getElementById('userEmail').value = '';
  document.getElementById('companyName').value = '';
  document.getElementById('userDomain').value = '';
  document.getElementById('userNotes').value = '';
  
  const btn = document.querySelector('.panel-title .btn.success');
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (btn) btn.textContent = 'Add Tenant';
  if (cancelBtn) cancelBtn.style.display = 'none';
}

async function deleteTenant(id) {
  if (!confirm('Delete tenant and all data?')) return;
  try {
    await supabaseClient.from('employees').delete().eq('tenant_id', id);
    await supabaseClient.from('users').delete().eq('tenant_id', id);
    await supabaseClient.from('business_settings').delete().eq('tenant_id', id);
    await supabaseClient.from('tenants').delete().eq('tenant_id', id);
    await loadTenants();
  } catch(e) { alert('Error: ' + e.message); }
}

init();
</script>
</body>
</html>
