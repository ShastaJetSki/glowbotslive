<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Platform Admin Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #030508;
      --bg-secondary: #0a0f15;
      --bg-tertiary: #0f1620;
      --bg-card: #111923;
      --border-color: #1a2535;
      --border-glow: #00d4ff;
      --text-primary: #e8f0f8;
      --text-secondary: #7a8fa8;
      --text-muted: #4a5a70;
      --accent-cyan: #00d4ff;
      --accent-cyan-dim: rgba(0, 212, 255, 0.1);
      --accent-green: #00ff88;
      --accent-green-dim: rgba(0, 255, 136, 0.1);
      --accent-orange: #ff6b35;
      --accent-orange-dim: rgba(255, 107, 53, 0.1);
      --accent-purple: #a855f7;
      --accent-purple-dim: rgba(168, 85, 247, 0.1);
      --accent-red: #ff4757;
      --accent-yellow: #ffc107;
      --gradient-cyan: linear-gradient(135deg, #00d4ff, #0099cc);
      --gradient-green: linear-gradient(135deg, #00ff88, #00cc6a);
      --shadow-glow: 0 0 30px rgba(0, 212, 255, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      background-image: 
        radial-gradient(ellipse at 20% 20%, rgba(0, 212, 255, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(0, 255, 136, 0.02) 0%, transparent 50%);
    }

    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
    }

    .header-title {
      font-family: 'Orbitron', monospace;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: var(--gradient-cyan);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-top: 4px;
    }

    .header-actions { display: flex; gap: 12px; }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .kpi-grid { grid-template-columns: 1fr; } }

    /* Speedometer Card */
    .speedo-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .speedo-card:hover {
      border-color: var(--accent-cyan);
      box-shadow: var(--shadow-glow);
    }

    .speedo-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--accent-cyan);
    }

    .speedo-card.green::before { background: var(--accent-green); }
    .speedo-card.orange::before { background: var(--accent-orange); }
    .speedo-card.purple::before { background: var(--accent-purple); }

    .speedo-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .speedo-label {
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .speedo-trend {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 2px;
    }

    .speedo-trend.up { background: var(--accent-green-dim); color: var(--accent-green); }
    .speedo-trend.down { background: var(--accent-orange-dim); color: var(--accent-orange); }

    .speedo-gauge {
      position: relative;
      width: 140px;
      height: 70px;
      margin: 0 auto 15px;
    }

    .speedo-gauge svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .gauge-bg {
      fill: none;
      stroke: var(--bg-secondary);
      stroke-width: 8;
      stroke-linecap: round;
    }

    .gauge-fill {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dasharray 1s ease;
    }

    .gauge-fill.cyan { stroke: url(#cyanGrad); }
    .gauge-fill.green { stroke: url(#greenGrad); }
    .gauge-fill.orange { stroke: url(#orangeGrad); }
    .gauge-fill.purple { stroke: url(#purpleGrad); }

    .speedo-value {
      font-family: 'Orbitron', monospace;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      letter-spacing: 1px;
    }

    .speedo-value.cyan { color: var(--accent-cyan); }
    .speedo-value.green { color: var(--accent-green); }
    .speedo-value.orange { color: var(--accent-orange); }
    .speedo-value.purple { color: var(--accent-purple); }

    .speedo-unit {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .speedo-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .tab {
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 12px 20px;
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 2px;
    }

    .tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }

    .tab.active {
      background: var(--accent-cyan-dim);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Panels */
    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 12px;
    }

    .panel-title {
      font-family: 'Orbitron', monospace;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent-cyan);
    }

    .panel-actions { display: flex; gap: 8px; }

    /* Buttons */
    .btn {
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
      padding: 10px 20px;
      border: 1px solid var(--border-color);
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn:hover { border-color: var(--accent-cyan); transform: translateY(-1px); }

    .btn-primary {
      background: var(--accent-cyan-dim);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .btn-primary:hover { background: var(--accent-cyan); color: var(--bg-primary); }

    .btn-success {
      background: var(--accent-green-dim);
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .btn-success:hover { background: var(--accent-green); color: var(--bg-primary); }

    .btn-danger {
      background: var(--accent-orange-dim);
      border-color: var(--accent-orange);
      color: var(--accent-orange);
    }

    .btn-danger:hover { background: var(--accent-orange); color: var(--bg-primary); }

    .btn-sm { padding: 6px 12px; font-size: 11px; }

    /* Info Box */
    .info-box {
      background: var(--accent-cyan-dim);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 2px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--accent-cyan);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-box::before {
      content: '[i]';
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      opacity: 0.7;
    }

    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }

    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1 / -1; }

    .form-label {
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .form-input, .form-select, .form-textarea {
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.1);
    }

    .form-textarea { resize: vertical; min-height: 80px; }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-align: left;
      padding: 12px;
      background: var(--bg-secondary);
      color: var(--text-muted);
      border-bottom: 2px solid var(--border-color);
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
      vertical-align: middle;
    }

    .data-table tr:hover { background: var(--bg-tertiary); }

    .data-table .actions { white-space: nowrap; }

    /* Badges */
    .badge {
      display: inline-block;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 2px;
    }

    .badge-cyan { background: var(--accent-cyan-dim); color: var(--accent-cyan); border: 1px solid rgba(0, 212, 255, 0.3); }
    .badge-green { background: var(--accent-green-dim); color: var(--accent-green); border: 1px solid rgba(0, 255, 136, 0.3); }
    .badge-orange { background: var(--accent-orange-dim); color: var(--accent-orange); border: 1px solid rgba(255, 107, 53, 0.3); }
    .badge-purple { background: var(--accent-purple-dim); color: var(--accent-purple); border: 1px solid rgba(168, 85, 247, 0.3); }
    .badge-red { background: rgba(255, 71, 87, 0.1); color: var(--accent-red); border: 1px solid rgba(255, 71, 87, 0.3); }

    /* Checkbox Grid */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .checkbox-item:hover { border-color: var(--accent-cyan); }

    .checkbox-item input { width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent-cyan); }
    .checkbox-item span { font-size: 13px; }

    /* Button Label Grid */
    .button-label-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 8px;
    }

    .button-label-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
    }

    .button-label-item input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--accent-cyan); flex-shrink: 0; }

    .button-label-item .btn-id {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      color: var(--text-muted);
      width: 70px;
      flex-shrink: 0;
    }

    .button-label-item input[type="text"] {
      flex: 1;
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      color: var(--text-primary);
      min-width: 80px;
    }

    .button-label-item input[type="text"]:focus { border-color: var(--accent-cyan); outline: none; }
    .button-label-item input[type="text"]:disabled { opacity: 0.4; }

    /* Role Section */
    .role-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .role-header {
      font-family: 'Orbitron', monospace;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--accent-cyan);
      margin-bottom: 12px;
    }

    /* Button Preview */
    .button-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
    }

    .preview-btn {
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      font-weight: 600;
      padding: 8px 14px;
      border: 1px solid var(--border-color);
      border-radius: 2px;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .preview-btn.primary { background: var(--accent-cyan-dim); border-color: var(--accent-cyan); color: var(--accent-cyan); }

    /* Theme Preview */
    .theme-preview-box {
      width: 100%;
      height: 120px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .theme-preview-header {
      height: 24px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      gap: 6px;
    }

    .theme-preview-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .theme-preview-body {
      flex: 1;
      padding: 10px;
      display: flex;
      gap: 8px;
    }

    .theme-preview-sidebar { width: 30%; border-radius: 2px; }
    .theme-preview-content { flex: 1; border-radius: 2px; }

    /* Color Input Row */
    .color-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      margin-bottom: 8px;
    }

    .color-row label {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 120px;
    }

    .color-row input[type="color"] {
      width: 40px;
      height: 30px;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      background: transparent;
    }

    .color-row input[type="text"] {
      flex: 1;
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 2px;
      color: var(--text-primary);
      text-transform: uppercase;
    }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gradient-cyan);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      background: var(--bg-card);
      z-index: 10;
    }

    .modal-title {
      font-family: 'Orbitron', monospace;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent-cyan);
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      line-height: 1;
    }

    .modal-close:hover { color: var(--accent-orange); }

    .modal-body { padding: 20px; }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-family: 'Orbitron', monospace;
      font-size: 12px;
      letter-spacing: 2px;
    }

    /* Status Indicator */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .status-dot.active { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
    .status-dot.inactive { background: var(--text-muted); }
    .status-dot.trial { background: var(--accent-orange); box-shadow: 0 0 8px var(--accent-orange); }

    /* Message */
    .message {
      padding: 12px 16px;
      border-radius: 2px;
      margin-top: 12px;
      font-size: 13px;
    }

    .message.success { background: var(--accent-green-dim); border: 1px solid rgba(0, 255, 136, 0.3); color: var(--accent-green); }
    .message.error { background: rgba(255, 71, 87, 0.1); border: 1px solid rgba(255, 71, 87, 0.3); color: var(--accent-red); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }
  </style>
</head>
<body>

<!-- SVG Gradients -->
<svg style="position:absolute;width:0;height:0;">
  <defs>
    <linearGradient id="cyanGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#0099cc"/>
      <stop offset="100%" style="stop-color:#00d4ff"/>
    </linearGradient>
    <linearGradient id="greenGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#00cc6a"/>
      <stop offset="100%" style="stop-color:#00ff88"/>
    </linearGradient>
    <linearGradient id="orangeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#cc5020"/>
      <stop offset="100%" style="stop-color:#ff6b35"/>
    </linearGradient>
    <linearGradient id="purpleGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#7c3aed"/>
      <stop offset="100%" style="stop-color:#a855f7"/>
    </linearGradient>
  </defs>
</svg>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div>
      <div class="header-title">Platform Admin Console</div>
      <div class="header-subtitle">App Owner Control Center</div>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="refreshAllData()">Refresh Data</button>
      <button class="btn btn-primary" onclick="exportReport()">Export Report</button>
    </div>
  </div>

  <!-- KPI Dashboard -->
  <div class="kpi-grid">
    <!-- MRR -->
    <div class="speedo-card">
      <div class="speedo-header">
        <span class="speedo-label">Monthly Recurring Revenue</span>
        <span class="speedo-trend up" id="mrrTrend">+12.4%</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill cyan" id="mrrGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value cyan" id="mrrValue">$0</div>
      <div class="speedo-unit">Total MRR</div>
      <div class="speedo-footer">
        <span>Target: $50,000</span>
        <span id="mrrPercent">0%</span>
      </div>
    </div>

    <!-- Active Tenants -->
    <div class="speedo-card green">
      <div class="speedo-header">
        <span class="speedo-label">Active Tenants</span>
        <span class="speedo-trend up" id="tenantTrend">+8</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill green" id="tenantGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value green" id="tenantCount">0</div>
      <div class="speedo-unit">Active Accounts</div>
      <div class="speedo-footer">
        <span>Target: 100</span>
        <span id="tenantPercent">0%</span>
      </div>
    </div>

    <!-- Churn Rate -->
    <div class="speedo-card orange">
      <div class="speedo-header">
        <span class="speedo-label">Churn Rate</span>
        <span class="speedo-trend down" id="churnTrend">-0.5%</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill orange" id="churnGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value orange" id="churnValue">0%</div>
      <div class="speedo-unit">Monthly Churn</div>
      <div class="speedo-footer">
        <span>Target: &lt;5%</span>
        <span id="churnStatus">Healthy</span>
      </div>
    </div>

    <!-- Trial Conversion -->
    <div class="speedo-card purple">
      <div class="speedo-header">
        <span class="speedo-label">Trial Conversion</span>
        <span class="speedo-trend up" id="convTrend">+3.2%</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill purple" id="convGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value purple" id="convValue">0%</div>
      <div class="speedo-unit">Conversion Rate</div>
      <div class="speedo-footer">
        <span>Target: 25%</span>
        <span id="convStatus">Good</span>
      </div>
    </div>

    <!-- ARPT -->
    <div class="speedo-card">
      <div class="speedo-header">
        <span class="speedo-label">Avg Revenue Per Tenant</span>
        <span class="speedo-trend up" id="arptTrend">+$15</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill cyan" id="arptGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value cyan" id="arptValue">$0</div>
      <div class="speedo-unit">Per Tenant/Month</div>
      <div class="speedo-footer">
        <span>Target: $500</span>
        <span id="arptPercent">0%</span>
      </div>
    </div>

    <!-- Total Users -->
    <div class="speedo-card green">
      <div class="speedo-header">
        <span class="speedo-label">Total Platform Users</span>
        <span class="speedo-trend up" id="userTrend">+45</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill green" id="userGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value green" id="userCount">0</div>
      <div class="speedo-unit">Total Users</div>
      <div class="speedo-footer">
        <span>Target: 500</span>
        <span id="userPercent">0%</span>
      </div>
    </div>

    <!-- LTV -->
    <div class="speedo-card orange">
      <div class="speedo-header">
        <span class="speedo-label">Customer Lifetime Value</span>
        <span class="speedo-trend up" id="ltvTrend">+$200</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill orange" id="ltvGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value orange" id="ltvValue">$0</div>
      <div class="speedo-unit">Average LTV</div>
      <div class="speedo-footer">
        <span>Target: $6,000</span>
        <span id="ltvPercent">0%</span>
      </div>
    </div>

    <!-- Trial Accounts -->
    <div class="speedo-card purple">
      <div class="speedo-header">
        <span class="speedo-label">Active Trials</span>
        <span class="speedo-trend up" id="trialTrend">+5</span>
      </div>
      <div class="speedo-gauge">
        <svg viewBox="0 0 140 80">
          <path class="gauge-bg" d="M 10 70 A 60 60 0 0 1 130 70"/>
          <path class="gauge-fill purple" id="trialGauge" d="M 10 70 A 60 60 0 0 1 130 70" stroke-dasharray="0 188"/>
        </svg>
      </div>
      <div class="speedo-value purple" id="trialCount">0</div>
      <div class="speedo-unit">In Trial Period</div>
      <div class="speedo-footer">
        <span>Avg Trial: 14 days</span>
        <span id="trialStatus">Pipeline</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('tenants')">Tenants</button>
    <button class="tab" onclick="switchTab('tiers')">Subscription Tiers</button>
    <button class="tab" onclick="switchTab('presets')">UI Presets</button>
    <button class="tab" onclick="switchTab('themes')">Global Themes</button>
    <button class="tab" onclick="switchTab('roles')">Role Permissions</button>
    <button class="tab" onclick="switchTab('analytics')">Analytics</button>
  </div>

  <!-- TENANTS TAB -->
  <div class="tab-content active" id="tenants">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Create Tenant Account</span>
        <div class="panel-actions">
          <button class="btn" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;">Cancel</button>
          <button class="btn btn-success" onclick="addTenantAndUser()" id="saveTenantBtn">Add Tenant</button>
        </div>
      </div>

      <div class="info-box">Creates a new tenant organization with owner account. Assigns UI preset and subscription tier.</div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Owner Full Name *</label>
          <input type="text" class="form-input" id="userName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label class="form-label">Owner Email *</label>
          <input type="email" class="form-input" id="userEmail" placeholder="owner@company.com">
        </div>
        <div class="form-group">
          <label class="form-label">Company Name *</label>
          <input type="text" class="form-input" id="companyName" placeholder="Acme Corporation">
        </div>
        <div class="form-group">
          <label class="form-label">Domain</label>
          <input type="text" class="form-input" id="userDomain" placeholder="acme.example.com">
        </div>
        <div class="form-group">
          <label class="form-label">UI Preset *</label>
          <select class="form-select" id="uiPreset"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Subscription Tier</label>
          <select class="form-select" id="userTier"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Global Theme</label>
          <select class="form-select" id="userTheme"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Account Status</label>
          <select class="form-select" id="userStatus">
            <option value="active">Active</option>
            <option value="trial">Trial</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Billing Cycle</label>
          <select class="form-select" id="billingCycle">
            <option value="monthly">Monthly</option>
            <option value="annual">Annual</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Trial Days</label>
          <input type="number" class="form-input" id="trialDays" placeholder="14" value="14">
        </div>
        <div class="form-group full">
          <label class="form-label">Internal Notes</label>
          <textarea class="form-textarea" id="userNotes" placeholder="Internal notes about this tenant..."></textarea>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">All Tenants</span>
        <div class="panel-actions">
          <input type="text" class="form-input" id="tenantSearch" placeholder="Search tenants..." style="width:200px;" oninput="filterTenants()">
          <button class="btn" onclick="loadTenants()">Refresh</button>
        </div>
      </div>
      <div id="tenantsLoading" class="loading">LOADING TENANT DATA...</div>
      <table class="data-table" id="tenantsTable" style="display:none;">
        <thead>
          <tr>
            <th>Company</th>
            <th>Owner</th>
            <th>Preset</th>
            <th>Theme</th>
            <th>Tier</th>
            <th>MRR</th>
            <th>Users</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tenantsTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- TIERS TAB -->
  <div class="tab-content" id="tiers">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Subscription Tiers</span>
        <button class="btn btn-success" onclick="openTierModal()">+ Add Tier</button>
      </div>
      <div class="info-box">Define pricing tiers with features, limits, and Stripe integration.</div>
      <div id="tiersLoading" class="loading">LOADING TIER DATA...</div>
      <table class="data-table" id="tiersTable" style="display:none;">
        <thead>
          <tr>
            <th>Tier</th>
            <th>Monthly</th>
            <th>Annual</th>
            <th>Limits</th>
            <th>Features</th>
            <th>Subscribers</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tiersTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- PRESETS TAB -->
  <div class="tab-content" id="presets">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">UI Presets - Industry Configurations</span>
        <button class="btn btn-success" onclick="openPresetModal()">+ Add Preset</button>
      </div>
      <div class="info-box">UI Presets define navigation and action buttons for different industries. Custom labels can rename default buttons.</div>
      <div id="presetsLoading" class="loading">LOADING PRESET DATA...</div>
      <table class="data-table" id="presetsTable" style="display:none;">
        <thead>
          <tr>
            <th>Preset Name</th>
            <th>Industry</th>
            <th>Buttons</th>
            <th>Tenants Using</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="presetsTableBody"></tbody>
      </table>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Built-in Preset Templates</span>
      </div>
      <div style="display:grid; gap:12px;">
        <div class="role-section">
          <div class="role-header">Car Dealership</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Vehicles</span>
            <span class="preview-btn">Service</span>
            <span class="preview-btn">Parts</span>
            <span class="preview-btn">Sales</span>
            <span class="preview-btn">Fleet</span>
            <span class="preview-btn">Scheduler</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Traveling Salesman</div>
          <div class="button-preview">
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Appointments</span>
            <span class="preview-btn">Routes</span>
            <span class="preview-btn">Calendar</span>
            <span class="preview-btn">Leads</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Law Firm</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Clients</span>
            <span class="preview-btn primary">Cases</span>
            <span class="preview-btn">Tasks</span>
            <span class="preview-btn">Calendar</span>
            <span class="preview-btn">Billing</span>
          </div>
        </div>
        <div class="role-section">
          <div class="role-header">Powersports / Marine</div>
          <div class="button-preview">
            <span class="preview-btn primary">Business</span>
            <span class="preview-btn primary">Customers</span>
            <span class="preview-btn primary">Units</span>
            <span class="preview-btn">Service</span>
            <span class="preview-btn">Parts</span>
            <span class="preview-btn">Rentals</span>
            <span class="preview-btn">Storage</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- THEMES TAB -->
  <div class="tab-content" id="themes">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Global Theme Manager</span>
        <button class="btn btn-success" onclick="openThemeModal()">+ Create Theme</button>
      </div>
      <div class="info-box">Global themes apply across all tenant settings pages. Tenants can select from available themes.</div>
      <div id="themesLoading" class="loading">LOADING THEME DATA...</div>
      <table class="data-table" id="themesTable" style="display:none;">
        <thead>
          <tr>
            <th>Theme Name</th>
            <th>Preview</th>
            <th>Type</th>
            <th>Tenants Using</th>
            <th>Default</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="themesTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ROLES TAB -->
  <div class="tab-content" id="roles">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Role-Based Permissions</span>
        <button class="btn btn-primary" onclick="saveRolePermissions()">Save Permissions</button>
      </div>
      <div class="info-box">Configure which navigation and action buttons each role can access. Owners always have full access.</div>

      <div class="role-section">
        <div class="role-header">Owner - Full Access [Cannot Be Restricted]</div>
      </div>

      <div class="role-section">
        <div class="role-header">Manager</div>
        <div class="checkbox-grid" id="managerButtons"></div>
      </div>

      <div class="role-section">
        <div class="role-header">Technician</div>
        <div class="checkbox-grid" id="technicianButtons"></div>
      </div>

      <div class="role-section">
        <div class="role-header">Admin</div>
        <div class="checkbox-grid" id="adminButtons"></div>
      </div>

      <div class="role-section">
        <div class="role-header">Sales</div>
        <div class="checkbox-grid" id="salesButtons"></div>
      </div>

      <div id="rolesSaveMessage"></div>
    </div>
  </div>

  <!-- ANALYTICS TAB -->
  <div class="tab-content" id="analytics">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Platform Analytics</span>
        <div class="panel-actions">
          <select class="form-select" id="analyticsRange" onchange="loadAnalytics()" style="width:150px;">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
          </select>
          <button class="btn" onclick="loadAnalytics()">Refresh</button>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; margin-bottom:20px;">
        <div class="role-section" style="text-align:center;">
          <div class="speedo-label">New Signups</div>
          <div class="speedo-value cyan" style="font-size:32px;" id="analyticSignups">0</div>
        </div>
        <div class="role-section" style="text-align:center;">
          <div class="speedo-label">Revenue Growth</div>
          <div class="speedo-value green" style="font-size:32px;" id="analyticGrowth">0%</div>
        </div>
        <div class="role-section" style="text-align:center;">
          <div class="speedo-label">Support Tickets</div>
          <div class="speedo-value orange" style="font-size:32px;" id="analyticTickets">0</div>
        </div>
        <div class="role-section" style="text-align:center;">
          <div class="speedo-label">API Calls</div>
          <div class="speedo-value purple" style="font-size:32px;" id="analyticAPI">0</div>
        </div>
      </div>

      <div class="info-box">Revenue Breakdown by Tier</div>
      <div id="revenueBreakdown" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:12px;"></div>
    </div>
  </div>
</div>

<!-- TIER MODAL -->
<div class="modal-overlay" id="tierModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="tierModalTitle">Add Subscription Tier</span>
      <button class="modal-close" onclick="closeTierModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editTierId">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Tier Name *</label>
          <input type="text" class="form-input" id="tierName" placeholder="e.g., professional">
        </div>
        <div class="form-group">
          <label class="form-label">Display Name</label>
          <input type="text" class="form-input" id="tierDisplayName" placeholder="e.g., Professional Plan">
        </div>
        <div class="form-group">
          <label class="form-label">Monthly Price ($) *</label>
          <input type="number" class="form-input" id="tierMonthlyPrice" step="0.01" placeholder="99.00">
        </div>
        <div class="form-group">
          <label class="form-label">Annual Price ($)</label>
          <input type="number" class="form-input" id="tierAnnualPrice" step="0.01" placeholder="990.00">
        </div>
        <div class="form-group">
          <label class="form-label">Max Users</label>
          <input type="number" class="form-input" id="tierMaxUsers" placeholder="Unlimited if empty">
        </div>
        <div class="form-group">
          <label class="form-label">Max Vehicles/Units</label>
          <input type="number" class="form-input" id="tierMaxVehicles" placeholder="Unlimited if empty">
        </div>
        <div class="form-group">
          <label class="form-label">Max Storage (GB)</label>
          <input type="number" class="form-input" id="tierMaxStorage" placeholder="Unlimited if empty">
        </div>
        <div class="form-group">
          <label class="form-label">API Rate Limit (req/min)</label>
          <input type="number" class="form-input" id="tierApiLimit" placeholder="1000">
        </div>
        <div class="form-group">
          <label class="form-label">Stripe Monthly Price ID</label>
          <input type="text" class="form-input" id="tierStripeMonthly" placeholder="price_...">
        </div>
        <div class="form-group">
          <label class="form-label">Stripe Annual Price ID</label>
          <input type="text" class="form-input" id="tierStripeAnnual" placeholder="price_...">
        </div>
        <div class="form-group">
          <label class="form-label">Sort Order</label>
          <input type="number" class="form-input" id="tierSortOrder" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="tierIsActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="form-group full">
          <label class="form-label">Features (one per line)</label>
          <textarea class="form-textarea" id="tierFeatures" placeholder="Feature 1&#10;Feature 2&#10;Feature 3"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeTierModal()">Cancel</button>
      <button class="btn btn-success" onclick="saveTier()">Save Tier</button>
    </div>
  </div>
</div>

<!-- PRESET MODAL -->
<div class="modal-overlay" id="presetModal">
  <div class="modal" style="max-width:850px;">
    <div class="modal-header">
      <span class="modal-title" id="presetModalTitle">Add UI Preset</span>
      <button class="modal-close" onclick="closePresetModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editPresetId">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Preset Name *</label>
          <input type="text" class="form-input" id="presetName" placeholder="e.g., Car Dealership Pro">
        </div>
        <div class="form-group">
          <label class="form-label">Industry</label>
          <select class="form-select" id="presetIndustry">
            <option value="automotive">Automotive</option>
            <option value="powersports">Powersports</option>
            <option value="marine">Marine</option>
            <option value="field_sales">Field Sales</option>
            <option value="legal">Legal</option>
            <option value="healthcare">Healthcare</option>
            <option value="real_estate">Real Estate</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group full">
          <label class="form-label">Description</label>
          <input type="text" class="form-input" id="presetDescription" placeholder="Brief description of this preset...">
        </div>
        <div class="form-group full">
          <label class="form-label">Navigation Buttons <span style="font-weight:normal;color:var(--text-muted);">[Check to enable, edit label to rename]</span></label>
          <div class="button-label-grid" id="presetNavButtons"></div>
        </div>
        <div class="form-group full">
          <label class="form-label">Action Buttons</label>
          <div class="button-label-grid" id="presetActionButtons"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="presetIsActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="form-group full">
          <label class="form-label">Preview</label>
          <div class="button-preview" id="presetPreview"><span style="color:var(--text-muted);">Select buttons above...</span></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closePresetModal()">Cancel</button>
      <button class="btn btn-success" onclick="savePreset()">Save Preset</button>
    </div>
  </div>
</div>

<!-- THEME MODAL -->
<div class="modal-overlay" id="themeModal">
  <div class="modal" style="max-width:700px;">
    <div class="modal-header">
      <span class="modal-title" id="themeModalTitle">Create Global Theme</span>
      <button class="modal-close" onclick="closeThemeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editThemeId">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Theme Name *</label>
          <input type="text" class="form-input" id="themeName" placeholder="e.g., Corporate Blue">
        </div>
        <div class="form-group">
          <label class="form-label">Theme Type</label>
          <select class="form-select" id="themeType" onchange="updateThemePreview()">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
        <div class="form-group full">
          <label class="form-label">Color Configuration</label>
          <div class="color-row">
            <label>Primary Color</label>
            <input type="color" id="themePrimary" value="#00d4ff" onchange="updateThemePreview()">
            <input type="text" id="themePrimaryHex" value="#00d4ff" onchange="syncColor('Primary')">
          </div>
          <div class="color-row">
            <label>Secondary Color</label>
            <input type="color" id="themeSecondary" value="#00ff88" onchange="updateThemePreview()">
            <input type="text" id="themeSecondaryHex" value="#00ff88" onchange="syncColor('Secondary')">
          </div>
          <div class="color-row">
            <label>Background</label>
            <input type="color" id="themeBg" value="#0a0f15" onchange="updateThemePreview()">
            <input type="text" id="themeBgHex" value="#0a0f15" onchange="syncColor('Bg')">
          </div>
          <div class="color-row">
            <label>Card Background</label>
            <input type="color" id="themeCard" value="#111923" onchange="updateThemePreview()">
            <input type="text" id="themeCardHex" value="#111923" onchange="syncColor('Card')">
          </div>
          <div class="color-row">
            <label>Text Color</label>
            <input type="color" id="themeText" value="#e8f0f8" onchange="updateThemePreview()">
            <input type="text" id="themeTextHex" value="#e8f0f8" onchange="syncColor('Text')">
          </div>
          <div class="color-row">
            <label>Border Color</label>
            <input type="color" id="themeBorder" value="#1a2535" onchange="updateThemePreview()">
            <input type="text" id="themeBorderHex" value="#1a2535" onchange="syncColor('Border')">
          </div>
        </div>
        <div class="form-group full">
          <label class="form-label">Theme Preview</label>
          <div class="theme-preview-box" id="themePreviewBox">
            <div class="theme-preview-header" id="themePreviewHeader">
              <div class="theme-preview-dot" style="background:#ff5f57;"></div>
              <div class="theme-preview-dot" style="background:#febc2e;"></div>
              <div class="theme-preview-dot" style="background:#28c840;"></div>
            </div>
            <div class="theme-preview-body" id="themePreviewBody">
              <div class="theme-preview-sidebar" id="themePreviewSidebar"></div>
              <div class="theme-preview-content" id="themePreviewContent"></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Set as Default</label>
          <select class="form-select" id="themeIsDefault">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="themeIsActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeThemeModal()">Cancel</button>
      <button class="btn btn-success" onclick="saveTheme()">Save Theme</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ALL_NAV_BUTTONS = ['Business', 'Customers', 'Vehicles', 'Clients', 'Cases', 'Units', 'Boats', 'Properties', 'Patients', 'Settings'];
const ALL_ACTION_BUTTONS = ['Service', 'Parts', 'Sales', 'Fleet', 'Rentals', 'Scheduler', 'Calendar', 'Routes', 'Leads', 'Tasks', 'Documents', 'Billing', 'Storage', 'Inbox', 'Reports', 'Appointments'];

let tiers = [], tenants = [], presets = [], themes = [], rolePermissions = {};
let editingTenantId = null;

// Initialize
async function init() {
  await Promise.all([loadTiers(), loadTenants(), loadPresets(), loadThemes(), loadRolePermissions()]);
  populatePresetModal();
  populateRolePermissions();
  updateKPIs();
  loadAnalytics();
}

// Tab switching
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tabName).classList.add('active');
}

// KPI Updates
function updateKPIs() {
  const activeTenants = tenants.filter(t => t.status === 'active');
  const trialTenants = tenants.filter(t => t.status === 'trial');
  const totalMRR = tenants.reduce((sum, t) => sum + (t.monthly_recurring_revenue || 0), 0);
  const totalUsers = tenants.reduce((sum, t) => sum + (t.user_count || 1), 0);

  // MRR
  const mrrTarget = 50000;
  const mrrPercent = Math.min((totalMRR / mrrTarget) * 100, 100);
  document.getElementById('mrrValue').textContent = '$' + totalMRR.toLocaleString();
  document.getElementById('mrrPercent').textContent = mrrPercent.toFixed(1) + '%';
  animateGauge('mrrGauge', mrrPercent);

  // Tenants
  const tenantTarget = 100;
  const tenantPercent = Math.min((activeTenants.length / tenantTarget) * 100, 100);
  document.getElementById('tenantCount').textContent = activeTenants.length;
  document.getElementById('tenantPercent').textContent = tenantPercent.toFixed(1) + '%';
  animateGauge('tenantGauge', tenantPercent);

  // Churn (simulated)
  const churnRate = 3.2;
  document.getElementById('churnValue').textContent = churnRate.toFixed(1) + '%';
  document.getElementById('churnStatus').textContent = churnRate < 5 ? 'Healthy' : 'Warning';
  animateGauge('churnGauge', churnRate * 10);

  // Conversion (simulated)
  const convRate = trialTenants.length > 0 ? 22.5 : 0;
  document.getElementById('convValue').textContent = convRate.toFixed(1) + '%';
  document.getElementById('convStatus').textContent = convRate > 20 ? 'Good' : 'Improve';
  animateGauge('convGauge', convRate * 4);

  // ARPT
  const arpt = activeTenants.length > 0 ? totalMRR / activeTenants.length : 0;
  const arptTarget = 500;
  document.getElementById('arptValue').textContent = '$' + arpt.toFixed(0);
  document.getElementById('arptPercent').textContent = ((arpt / arptTarget) * 100).toFixed(1) + '%';
  animateGauge('arptGauge', Math.min((arpt / arptTarget) * 100, 100));

  // Users
  const userTarget = 500;
  document.getElementById('userCount').textContent = totalUsers;
  document.getElementById('userPercent').textContent = ((totalUsers / userTarget) * 100).toFixed(1) + '%';
  animateGauge('userGauge', Math.min((totalUsers / userTarget) * 100, 100));

  // LTV (simulated - ARPT * avg months)
  const avgMonths = 12;
  const ltv = arpt * avgMonths;
  const ltvTarget = 6000;
  document.getElementById('ltvValue').textContent = '$' + ltv.toFixed(0);
  document.getElementById('ltvPercent').textContent = ((ltv / ltvTarget) * 100).toFixed(1) + '%';
  animateGauge('ltvGauge', Math.min((ltv / ltvTarget) * 100, 100));

  // Trials
  document.getElementById('trialCount').textContent = trialTenants.length;
  document.getElementById('trialStatus').textContent = 'Pipeline';
  animateGauge('trialGauge', trialTenants.length * 10);
}

function animateGauge(id, percent) {
  const maxDash = 188;
  const dash = (percent / 100) * maxDash;
  document.getElementById(id).setAttribute('stroke-dasharray', `${dash} ${maxDash}`);
}

// TIERS
async function loadTiers() {
  try {
    const { data, error } = await supabaseClient.from('subscription_tiers').select('*').order('sort_order');
    if (error) throw error;
    tiers = data || [];
    renderTiers();
    populateTierSelect();
  } catch (e) { console.error('Tiers:', e); tiers = getDefaultTiers(); renderTiers(); populateTierSelect(); }
}

function getDefaultTiers() {
  return [
    { tier_id: 'starter', tier_name: 'starter', tier_display_name: 'Starter', monthly_price: 49, annual_price: 490, max_users: 3, max_vehicles: 50, is_active: true, features: ['Basic Support', 'Core Features'] },
    { tier_id: 'professional', tier_name: 'professional', tier_display_name: 'Professional', monthly_price: 149, annual_price: 1490, max_users: 10, max_vehicles: 200, is_active: true, features: ['Priority Support', 'All Features', 'API Access'] },
    { tier_id: 'enterprise', tier_name: 'enterprise', tier_display_name: 'Enterprise', monthly_price: 399, annual_price: 3990, max_users: null, max_vehicles: null, is_active: true, features: ['24/7 Support', 'Custom Integrations', 'Dedicated Account Manager'] }
  ];
}

function renderTiers() {
  document.getElementById('tiersLoading').style.display = 'none';
  document.getElementById('tiersTable').style.display = 'table';
  const tbody = document.getElementById('tiersTableBody');
  if (tiers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);">No tiers configured</td></tr>';
    return;
  }
  tbody.innerHTML = tiers.map(t => {
    const limits = [];
    if (t.max_users) limits.push(t.max_users + ' users');
    if (t.max_vehicles) limits.push(t.max_vehicles + ' units');
    const subscribers = tenants.filter(tn => tn.tier_id === t.tier_id).length;
    return `<tr>
      <td><strong>${t.tier_display_name || t.tier_name}</strong></td>
      <td>$${(t.monthly_price||0).toFixed(2)}</td>
      <td>$${(t.annual_price||0).toFixed(2)}</td>
      <td style="font-size:12px;">${limits.join(', ')||'Unlimited'}</td>
      <td style="font-size:11px;">${(t.features||[]).slice(0,2).join(', ')}${(t.features||[]).length > 2 ? '...' : ''}</td>
      <td>${subscribers}</td>
      <td><span class="badge ${t.is_active?'badge-green':'badge-orange'}">${t.is_active?'Active':'Inactive'}</span></td>
      <td class="actions">
        <button class="btn btn-sm" onclick="editTier('${t.tier_id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteTier('${t.tier_id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function populateTierSelect() {
  const html = '<option value="">-- Select Tier --</option>' + 
    tiers.filter(t=>t.is_active).map(t => `<option value="${t.tier_id}">${t.tier_display_name||t.tier_name} - $${t.monthly_price}/mo</option>`).join('');
  document.getElementById('userTier').innerHTML = html;
}

function openTierModal() {
  document.getElementById('editTierId').value = '';
  document.getElementById('tierName').value = '';
  document.getElementById('tierDisplayName').value = '';
  document.getElementById('tierMonthlyPrice').value = '';
  document.getElementById('tierAnnualPrice').value = '';
  document.getElementById('tierMaxUsers').value = '';
  document.getElementById('tierMaxVehicles').value = '';
  document.getElementById('tierMaxStorage').value = '';
  document.getElementById('tierApiLimit').value = '';
  document.getElementById('tierStripeMonthly').value = '';
  document.getElementById('tierStripeAnnual').value = '';
  document.getElementById('tierSortOrder').value = tiers.length;
  document.getElementById('tierFeatures').value = '';
  document.getElementById('tierIsActive').value = 'true';
  document.getElementById('tierModalTitle').textContent = 'Add Subscription Tier';
  document.getElementById('tierModal').classList.add('active');
}

function closeTierModal() { document.getElementById('tierModal').classList.remove('active'); }

function editTier(id) {
  const t = tiers.find(x => x.tier_id === id);
  if (!t) return;
  document.getElementById('editTierId').value = t.tier_id;
  document.getElementById('tierName').value = t.tier_name || '';
  document.getElementById('tierDisplayName').value = t.tier_display_name || '';
  document.getElementById('tierMonthlyPrice').value = t.monthly_price || '';
  document.getElementById('tierAnnualPrice').value = t.annual_price || '';
  document.getElementById('tierMaxUsers').value = t.max_users || '';
  document.getElementById('tierMaxVehicles').value = t.max_vehicles || '';
  document.getElementById('tierMaxStorage').value = t.max_storage_gb || '';
  document.getElementById('tierApiLimit').value = t.api_rate_limit || '';
  document.getElementById('tierStripeMonthly').value = t.stripe_price_id_monthly || '';
  document.getElementById('tierStripeAnnual').value = t.stripe_price_id_annual || '';
  document.getElementById('tierSortOrder').value = t.sort_order || 0;
  document.getElementById('tierFeatures').value = (t.features || []).join('\n');
  document.getElementById('tierIsActive').value = t.is_active ? 'true' : 'false';
  document.getElementById('tierModalTitle').textContent = 'Edit Subscription Tier';
  document.getElementById('tierModal').classList.add('active');
}

async function saveTier() {
  const id = document.getElementById('editTierId').value;
  const name = document.getElementById('tierName').value.trim();
  const monthly = parseFloat(document.getElementById('tierMonthlyPrice').value) || 0;
  if (!name || monthly <= 0) { alert('Tier name and monthly price required'); return; }

  const data = {
    tier_name: name,
    tier_display_name: document.getElementById('tierDisplayName').value.trim() || name,
    monthly_price: monthly,
    annual_price: parseFloat(document.getElementById('tierAnnualPrice').value) || (monthly * 10),
    max_users: parseInt(document.getElementById('tierMaxUsers').value) || null,
    max_vehicles: parseInt(document.getElementById('tierMaxVehicles').value) || null,
    max_storage_gb: parseInt(document.getElementById('tierMaxStorage').value) || null,
    api_rate_limit: parseInt(document.getElementById('tierApiLimit').value) || null,
    stripe_price_id_monthly: document.getElementById('tierStripeMonthly').value.trim() || null,
    stripe_price_id_annual: document.getElementById('tierStripeAnnual').value.trim() || null,
    sort_order: parseInt(document.getElementById('tierSortOrder').value) || 0,
    features: document.getElementById('tierFeatures').value.trim().split('\n').filter(f => f.trim()),
    is_active: document.getElementById('tierIsActive').value === 'true',
    updated_at: new Date().toISOString()
  };

  try {
    if (id) {
      await supabaseClient.from('subscription_tiers').update(data).eq('tier_id', id);
    } else {
      data.tier_id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      data.created_at = new Date().toISOString();
      await supabaseClient.from('subscription_tiers').insert([data]);
    }
    alert('Tier saved successfully');
    closeTierModal();
    await loadTiers();
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteTier(id) {
  if (!confirm('Delete this subscription tier?')) return;
  try {
    await supabaseClient.from('subscription_tiers').delete().eq('tier_id', id);
    await loadTiers();
  } catch (e) { alert('Error: ' + e.message); }
}

// PRESETS
async function loadPresets() {
  try {
    const { data, error } = await supabaseClient.from('ui_presets').select('*').order('name');
    if (error) throw error;
    presets = data || [];
    if (presets.length === 0) presets = getDefaultPresets();
  } catch (e) { presets = getDefaultPresets(); }
  renderPresets();
  populatePresetSelect();
}

function getDefaultPresets() {
  return [
    { id: 'car_dealership', name: 'Car Dealership', industry: 'automotive', nav_buttons: ['Business','Customers','Vehicles','Settings'], action_buttons: ['Service','Parts','Sales','Fleet','Scheduler'], button_labels: {}, is_active: true },
    { id: 'traveling_salesman', name: 'Traveling Salesman', industry: 'field_sales', nav_buttons: ['Customers','Settings'], action_buttons: ['Calendar','Routes','Leads','Tasks','Appointments'], button_labels: {}, is_active: true },
    { id: 'law_firm', name: 'Law Firm', industry: 'legal', nav_buttons: ['Business','Clients','Cases','Settings'], action_buttons: ['Tasks','Calendar','Documents','Billing'], button_labels: {}, is_active: true },
    { id: 'powersports', name: 'Powersports', industry: 'powersports', nav_buttons: ['Business','Customers','Units','Settings'], action_buttons: ['Service','Parts','Sales','Rentals','Scheduler'], button_labels: {}, is_active: true },
    { id: 'marine', name: 'Marine', industry: 'marine', nav_buttons: ['Business','Customers','Boats','Settings'], action_buttons: ['Service','Parts','Rentals','Storage','Scheduler'], button_labels: {}, is_active: true }
  ];
}

function renderPresets() {
  document.getElementById('presetsLoading').style.display = 'none';
  document.getElementById('presetsTable').style.display = 'table';
  document.getElementById('presetsTableBody').innerHTML = presets.map(p => {
    const tenantsUsing = tenants.filter(t => t.ui_preset_id === p.id).length;
    const allBtns = [...(p.nav_buttons||[]), ...(p.action_buttons||[])];
    return `<tr>
      <td><strong>${p.name}</strong><br><small style="color:var(--text-muted);">${p.description||''}</small></td>
      <td><span class="badge badge-cyan">${p.industry||'other'}</span></td>
      <td style="font-size:11px;">${allBtns.slice(0,5).join(', ')}${allBtns.length > 5 ? '...' : ''}</td>
      <td>${tenantsUsing}</td>
      <td><span class="badge ${p.is_active?'badge-green':'badge-orange'}">${p.is_active?'Active':'Inactive'}</span></td>
      <td class="actions">
        <button class="btn btn-sm" onclick="editPreset('${p.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deletePreset('${p.id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function populatePresetSelect() {
  document.getElementById('uiPreset').innerHTML = presets.filter(p=>p.is_active).map(p => 
    `<option value="${p.id}">${p.name} (${p.industry})</option>`
  ).join('');
}

function populatePresetModal() {
  document.getElementById('presetNavButtons').innerHTML = ALL_NAV_BUTTONS.map(b => `
    <div class="button-label-item">
      <input type="checkbox" value="${b}" onchange="toggleButtonLabel(this); updatePresetPreview()">
      <span class="btn-id">${b}</span>
      <input type="text" id="label_${b}" placeholder="${b}" value="${b}" disabled onkeyup="updatePresetPreview()">
    </div>
  `).join('');

  document.getElementById('presetActionButtons').innerHTML = ALL_ACTION_BUTTONS.map(b => `
    <div class="button-label-item">
      <input type="checkbox" value="${b}" onchange="toggleButtonLabel(this); updatePresetPreview()">
      <span class="btn-id">${b}</span>
      <input type="text" id="label_${b}" placeholder="${b}" value="${b}" disabled onkeyup="updatePresetPreview()">
    </div>
  `).join('');
}

function toggleButtonLabel(checkbox) {
  const labelInput = document.getElementById('label_' + checkbox.value);
  if (labelInput) {
    labelInput.disabled = !checkbox.checked;
    if (checkbox.checked && !labelInput.value) labelInput.value = checkbox.value;
  }
}

function updatePresetPreview() {
  const nav = [...document.querySelectorAll('#presetNavButtons input[type="checkbox"]:checked')].map(c => {
    const label = document.getElementById('label_' + c.value)?.value || c.value;
    return `<span class="preview-btn primary">${label}</span>`;
  });
  const action = [...document.querySelectorAll('#presetActionButtons input[type="checkbox"]:checked')].map(c => {
    const label = document.getElementById('label_' + c.value)?.value || c.value;
    return `<span class="preview-btn">${label}</span>`;
  });
  document.getElementById('presetPreview').innerHTML = nav.join('') + action.join('') || '<span style="color:var(--text-muted);">Select buttons above...</span>';
}

function getButtonLabels() {
  const labels = {};
  [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS].forEach(btn => {
    const checkbox = document.querySelector(`#presetNavButtons input[value="${btn}"], #presetActionButtons input[value="${btn}"]`);
    const labelInput = document.getElementById('label_' + btn);
    if (checkbox?.checked && labelInput?.value && labelInput.value !== btn) {
      labels[btn] = labelInput.value;
    }
  });
  return labels;
}

function setButtonLabels(labels) {
  Object.entries(labels || {}).forEach(([btn, label]) => {
    const labelInput = document.getElementById('label_' + btn);
    if (labelInput) labelInput.value = label;
  });
}

function openPresetModal() {
  populatePresetModal();
  document.getElementById('editPresetId').value = '';
  document.getElementById('presetName').value = '';
  document.getElementById('presetIndustry').value = 'automotive';
  document.getElementById('presetDescription').value = '';
  document.getElementById('presetIsActive').value = 'true';
  document.querySelectorAll('#presetNavButtons input[type="checkbox"], #presetActionButtons input[type="checkbox"]').forEach(c => {
    c.checked = false;
    toggleButtonLabel(c);
  });
  document.getElementById('presetPreview').innerHTML = '<span style="color:var(--text-muted);">Select buttons above...</span>';
  document.getElementById('presetModalTitle').textContent = 'Add UI Preset';
  document.getElementById('presetModal').classList.add('active');
}

function closePresetModal() { document.getElementById('presetModal').classList.remove('active'); }

function editPreset(id) {
  populatePresetModal();
  const p = presets.find(x => x.id === id);
  if (!p) return;
  document.getElementById('editPresetId').value = p.id;
  document.getElementById('presetName').value = p.name || '';
  document.getElementById('presetIndustry').value = p.industry || 'other';
  document.getElementById('presetDescription').value = p.description || '';
  document.getElementById('presetIsActive').value = p.is_active ? 'true' : 'false';

  document.querySelectorAll('#presetNavButtons input[type="checkbox"]').forEach(c => {
    c.checked = (p.nav_buttons||[]).includes(c.value);
    toggleButtonLabel(c);
  });
  document.querySelectorAll('#presetActionButtons input[type="checkbox"]').forEach(c => {
    c.checked = (p.action_buttons||[]).includes(c.value);
    toggleButtonLabel(c);
  });
  setButtonLabels(p.button_labels);
  updatePresetPreview();
  document.getElementById('presetModalTitle').textContent = 'Edit UI Preset';
  document.getElementById('presetModal').classList.add('active');
}

async function savePreset() {
  const id = document.getElementById('editPresetId').value;
  const name = document.getElementById('presetName').value.trim();
  if (!name) { alert('Preset name required'); return; }

  const data = {
    name: name,
    industry: document.getElementById('presetIndustry').value,
    description: document.getElementById('presetDescription').value.trim(),
    nav_buttons: [...document.querySelectorAll('#presetNavButtons input[type="checkbox"]:checked')].map(c=>c.value),
    action_buttons: [...document.querySelectorAll('#presetActionButtons input[type="checkbox"]:checked')].map(c=>c.value),
    button_labels: getButtonLabels(),
    is_active: document.getElementById('presetIsActive').value === 'true',
    updated_at: new Date().toISOString()
  };

  try {
    if (id) {
      await supabaseClient.from('ui_presets').update(data).eq('id', id);
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      data.created_at = new Date().toISOString();
      await supabaseClient.from('ui_presets').insert([data]);
    }
    alert('Preset saved successfully');
    closePresetModal();
    await loadPresets();
  } catch (e) {
    if (id) {
      const idx = presets.findIndex(x => x.id === id);
      if (idx >= 0) presets[idx] = {...presets[idx], ...data};
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      presets.push(data);
    }
    alert('Saved locally');
    closePresetModal();
    renderPresets();
    populatePresetSelect();
  }
}

async function deletePreset(id) {
  if (!confirm('Delete this preset?')) return;
  try { await supabaseClient.from('ui_presets').delete().eq('id', id); } catch(e) {}
  presets = presets.filter(p => p.id !== id);
  renderPresets();
  populatePresetSelect();
}

// THEMES
async function loadThemes() {
  themes = getDefaultThemes();
  try {
    const { data, error } = await supabaseClient.from('global_themes').select('*').order('name');
    if (!error && data && data.length > 0) themes = data;
  } catch (e) {}
  renderThemes();
  populateThemeSelect();
}

function getDefaultThemes() {
  return [
    { id: 'cyber_dark', name: 'Cyber Dark', type: 'dark', primary: '#00d4ff', secondary: '#00ff88', bg: '#030508', card: '#111923', text: '#e8f0f8', border: '#1a2535', is_default: true, is_active: true },
    { id: 'ocean_blue', name: 'Ocean Blue', type: 'dark', primary: '#3b82f6', secondary: '#60a5fa', bg: '#0c1929', card: '#1e3a5f', text: '#e8f0f8', border: '#2d5a8a', is_default: false, is_active: true },
    { id: 'forest_green', name: 'Forest Green', type: 'dark', primary: '#10b981', secondary: '#34d399', bg: '#0a1f1a', card: '#134e3a', text: '#e8f0f8', border: '#1f5c4a', is_default: false, is_active: true },
    { id: 'corporate_light', name: 'Corporate Light', type: 'light', primary: '#2563eb', secondary: '#3b82f6', bg: '#f8fafc', card: '#ffffff', text: '#1e293b', border: '#e2e8f0', is_default: false, is_active: true },
    { id: 'sunset_warm', name: 'Sunset Warm', type: 'dark', primary: '#f97316', secondary: '#fb923c', bg: '#1a0f0a', card: '#2d1810', text: '#fef3e8', border: '#4a2515', is_default: false, is_active: true }
  ];
}

function renderThemes() {
  document.getElementById('themesLoading').style.display = 'none';
  document.getElementById('themesTable').style.display = 'table';
  document.getElementById('themesTableBody').innerHTML = themes.map(t => {
    const tenantsUsing = tenants.filter(tn => tn.theme_id === t.id).length;
    return `<tr>
      <td><strong>${t.name}</strong></td>
      <td>
        <div class="theme-preview-box" style="width:100px;height:50px;">
          <div class="theme-preview-header" style="background:${t.card};height:12px;">
            <div class="theme-preview-dot" style="width:4px;height:4px;background:${t.primary};"></div>
          </div>
          <div class="theme-preview-body" style="background:${t.bg};padding:4px;">
            <div style="width:25%;height:100%;background:${t.card};border-radius:2px;"></div>
            <div style="flex:1;height:100%;background:${t.card};border-radius:2px;border:1px solid ${t.border};"></div>
          </div>
        </div>
      </td>
      <td><span class="badge ${t.type==='dark'?'badge-purple':'badge-cyan'}">${t.type}</span></td>
      <td>${tenantsUsing}</td>
      <td>${t.is_default ? '<span class="badge badge-green">Default</span>' : '-'}</td>
      <td class="actions">
        <button class="btn btn-sm" onclick="editTheme('${t.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteTheme('${t.id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function populateThemeSelect() {
  const defaultTheme = themes.find(t => t.is_default);
  document.getElementById('userTheme').innerHTML = themes.filter(t=>t.is_active).map(t => 
    `<option value="${t.id}" ${t.is_default?'selected':''}>${t.name} (${t.type})</option>`
  ).join('');
}

function openThemeModal() {
  document.getElementById('editThemeId').value = '';
  document.getElementById('themeName').value = '';
  document.getElementById('themeType').value = 'dark';
  document.getElementById('themePrimary').value = '#00d4ff';
  document.getElementById('themePrimaryHex').value = '#00d4ff';
  document.getElementById('themeSecondary').value = '#00ff88';
  document.getElementById('themeSecondaryHex').value = '#00ff88';
  document.getElementById('themeBg').value = '#0a0f15';
  document.getElementById('themeBgHex').value = '#0a0f15';
  document.getElementById('themeCard').value = '#111923';
  document.getElementById('themeCardHex').value = '#111923';
  document.getElementById('themeText').value = '#e8f0f8';
  document.getElementById('themeTextHex').value = '#e8f0f8';
  document.getElementById('themeBorder').value = '#1a2535';
  document.getElementById('themeBorderHex').value = '#1a2535';
  document.getElementById('themeIsDefault').value = 'false';
  document.getElementById('themeIsActive').value = 'true';
  document.getElementById('themeModalTitle').textContent = 'Create Global Theme';
  updateThemePreview();
  document.getElementById('themeModal').classList.add('active');
}

function closeThemeModal() { document.getElementById('themeModal').classList.remove('active'); }

function editTheme(id) {
  const t = themes.find(x => x.id === id);
  if (!t) return;
  document.getElementById('editThemeId').value = t.id;
  document.getElementById('themeName').value = t.name || '';
  document.getElementById('themeType').value = t.type || 'dark';
  document.getElementById('themePrimary').value = t.primary || '#00d4ff';
  document.getElementById('themePrimaryHex').value = t.primary || '#00d4ff';
  document.getElementById('themeSecondary').value = t.secondary || '#00ff88';
  document.getElementById('themeSecondaryHex').value = t.secondary || '#00ff88';
  document.getElementById('themeBg').value = t.bg || '#0a0f15';
  document.getElementById('themeBgHex').value = t.bg || '#0a0f15';
  document.getElementById('themeCard').value = t.card || '#111923';
  document.getElementById('themeCardHex').value = t.card || '#111923';
  document.getElementById('themeText').value = t.text || '#e8f0f8';
  document.getElementById('themeTextHex').value = t.text || '#e8f0f8';
  document.getElementById('themeBorder').value = t.border || '#1a2535';
  document.getElementById('themeBorderHex').value = t.border || '#1a2535';
  document.getElementById('themeIsDefault').value = t.is_default ? 'true' : 'false';
  document.getElementById('themeIsActive').value = t.is_active ? 'true' : 'false';
  document.getElementById('themeModalTitle').textContent = 'Edit Global Theme';
  updateThemePreview();
  document.getElementById('themeModal').classList.add('active');
}

function syncColor(name) {
  const hex = document.getElementById('theme' + name + 'Hex').value;
  if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
    document.getElementById('theme' + name).value = hex;
    updateThemePreview();
  }
}

function updateThemePreview() {
  const bg = document.getElementById('themeBg').value;
  const card = document.getElementById('themeCard').value;
  const primary = document.getElementById('themePrimary').value;
  const border = document.getElementById('themeBorder').value;

  document.getElementById('themeBgHex').value = bg;
  document.getElementById('themeCardHex').value = card;
  document.getElementById('themePrimaryHex').value = primary;
  document.getElementById('themeBorderHex').value = border;
  document.getElementById('themeSecondaryHex').value = document.getElementById('themeSecondary').value;
  document.getElementById('themeTextHex').value = document.getElementById('themeText').value;

  document.getElementById('themePreviewBox').style.background = bg;
  document.getElementById('themePreviewHeader').style.background = card;
  document.getElementById('themePreviewBody').style.background = bg;
  document.getElementById('themePreviewSidebar').style.background = card;
  document.getElementById('themePreviewContent').style.background = card;
  document.getElementById('themePreviewContent').style.border = '1px solid ' + border;
}

async function saveTheme() {
  const id = document.getElementById('editThemeId').value;
  const name = document.getElementById('themeName').value.trim();
  if (!name) { alert('Theme name required'); return; }

  const isDefault = document.getElementById('themeIsDefault').value === 'true';
  if (isDefault) {
    themes.forEach(t => t.is_default = false);
  }

  const data = {
    name: name,
    type: document.getElementById('themeType').value,
    primary: document.getElementById('themePrimary').value,
    secondary: document.getElementById('themeSecondary').value,
    bg: document.getElementById('themeBg').value,
    card: document.getElementById('themeCard').value,
    text: document.getElementById('themeText').value,
    border: document.getElementById('themeBorder').value,
    is_default: isDefault,
    is_active: document.getElementById('themeIsActive').value === 'true',
    updated_at: new Date().toISOString()
  };

  try {
    if (isDefault) {
      await supabaseClient.from('global_themes').update({ is_default: false }).neq('id', id || 'none');
    }
    if (id) {
      await supabaseClient.from('global_themes').update(data).eq('id', id);
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      data.created_at = new Date().toISOString();
      await supabaseClient.from('global_themes').insert([data]);
    }
    alert('Theme saved successfully');
  } catch (e) {
    if (id) {
      const idx = themes.findIndex(x => x.id === id);
      if (idx >= 0) themes[idx] = {...themes[idx], ...data};
    } else {
      data.id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      themes.push(data);
    }
    alert('Theme saved locally');
  }
  closeThemeModal();
  renderThemes();
  populateThemeSelect();
}

async function deleteTheme(id) {
  if (!confirm('Delete this theme?')) return;
  try { await supabaseClient.from('global_themes').delete().eq('id', id); } catch(e) {}
  themes = themes.filter(t => t.id !== id);
  renderThemes();
  populateThemeSelect();
}

// ROLE PERMISSIONS
async function loadRolePermissions() {
  rolePermissions = {
    owner: [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS],
    manager: ['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Inbox','Tasks','Reports'],
    technician: ['Customers','Vehicles','Service','Parts','Scheduler','Tasks'],
    admin: ['Business','Customers','Vehicles','Settings','Service','Parts','Sales','Scheduler','Inbox','Tasks','Billing','Reports'],
    sales: ['Business','Customers','Vehicles','Sales','Leads','Scheduler','Calendar','Tasks','Inbox']
  };
  try {
    const { data } = await supabaseClient.from('role_permissions').select('*');
    if (data) data.forEach(r => rolePermissions[r.role] = r.allowed_buttons || []);
  } catch(e) {}
}

function populateRolePermissions() {
  const all = [...ALL_NAV_BUTTONS, ...ALL_ACTION_BUTTONS];
  ['manager','technician','admin','sales'].forEach(role => {
    const c = document.getElementById(role + 'Buttons');
    if (!c) return;
    c.innerHTML = all.map(b => {
      const chk = (rolePermissions[role]||[]).includes(b) ? 'checked' : '';
      return `<label class="checkbox-item"><input type="checkbox" value="${b}" data-role="${role}" ${chk}><span>${b}</span></label>`;
    }).join('');
  });
}

async function saveRolePermissions() {
  ['manager','technician','admin','sales'].forEach(async role => {
    const btns = [...document.querySelectorAll(`#${role}Buttons input:checked`)].map(c=>c.value);
    rolePermissions[role] = btns;
    try {
      await supabaseClient.from('role_permissions').upsert({role, allowed_buttons: btns, updated_at: new Date().toISOString()}, {onConflict:'role'});
    } catch(e) {}
  });
  document.getElementById('rolesSaveMessage').innerHTML = '<div class="message success">Permissions saved successfully</div>';
  setTimeout(() => document.getElementById('rolesSaveMessage').innerHTML = '', 3000);
}

// TENANTS
async function loadTenants() {
  try {
    const { data } = await supabaseClient.from('tenants').select('*, subscription_tiers(tier_display_name)').order('created_at', {ascending:false});
    tenants = data || [];
    for (let t of tenants) {
      try {
        const { data: owner } = await supabaseClient.from('users').select('email').eq('tenant_id', t.tenant_id).eq('role', 'owner').limit(1).single();
        t.owner = owner;
        const { count } = await supabaseClient.from('users').select('*', { count: 'exact', head: true }).eq('tenant_id', t.tenant_id);
        t.user_count = count || 1;
      } catch(e) { t.owner = null; t.user_count = 1; }
    }
    renderTenants();
    updateKPIs();
  } catch(e) { console.error('Tenants:', e); }
}

function renderTenants() {
  document.getElementById('tenantsLoading').style.display = 'none';
  document.getElementById('tenantsTable').style.display = 'table';
  if (tenants.length === 0) {
    document.getElementById('tenantsTableBody').innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-muted);">No tenants found</td></tr>';
    return;
  }
  document.getElementById('tenantsTableBody').innerHTML = tenants.map(t => {
    const preset = presets.find(p => p.id === t.ui_preset_id)?.name || t.ui_preset_id || '-';
    const theme = themes.find(th => th.id === t.theme_id)?.name || 'Default';
    const statusClass = t.status === 'active' ? 'active' : t.status === 'trial' ? 'trial' : 'inactive';
    return `<tr>
      <td><strong>${t.company_name||t.tenant_name}</strong><br><small style="color:var(--text-muted);">${t.domain||''}</small></td>
      <td>${t.owner?.email||t.billing_email||'-'}</td>
      <td><span class="badge badge-cyan">${preset}</span></td>
      <td><span class="badge badge-purple">${theme}</span></td>
      <td>${t.subscription_tiers?.tier_display_name||'None'}</td>
      <td>$${(t.monthly_recurring_revenue||0).toFixed(2)}</td>
      <td>${t.user_count||1}</td>
      <td><span class="status-dot ${statusClass}"></span>${t.status}</td>
      <td class="actions">
        <button class="btn btn-sm" onclick="editTenant('${t.tenant_id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteTenant('${t.tenant_id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function filterTenants() {
  const search = document.getElementById('tenantSearch').value.toLowerCase();
  const rows = document.querySelectorAll('#tenantsTableBody tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(search) ? '' : 'none';
  });
}

async function addTenantAndUser() {
  const name = document.getElementById('userName').value.trim();
  const email = document.getElementById('userEmail').value.trim();
  const company = document.getElementById('companyName').value.trim();
  if (!name || !email || !company) { alert('Owner name, email, and company name required'); return; }

  const now = new Date().toISOString();
  const tier = tiers.find(t => t.tier_id === document.getElementById('userTier').value);

  try {
    if (editingTenantId) {
      await supabaseClient.from('tenants').update({
        tenant_name: company,
        company_name: company,
        domain: document.getElementById('userDomain').value.trim() || null,
        ui_preset_id: document.getElementById('uiPreset').value || null,
        theme_id: document.getElementById('userTheme').value || null,
        tier_id: document.getElementById('userTier').value || null,
        status: document.getElementById('userStatus').value,
        billing_cycle: document.getElementById('billingCycle').value,
        billing_email: email,
        monthly_recurring_revenue: tier?.monthly_price || 0,
        metadata: { notes: document.getElementById('userNotes').value, trial_days: parseInt(document.getElementById('trialDays').value) || 14 },
        updated_at: now
      }).eq('tenant_id', editingTenantId);

      alert('Tenant updated successfully');
      cancelEdit();
      await loadTenants();
      return;
    }

    const tenantId = crypto.randomUUID();
    const userId = crypto.randomUUID();

    await supabaseClient.from('tenants').insert([{
      tenant_id: tenantId,
      tenant_name: company,
      company_name: company,
      domain: document.getElementById('userDomain').value.trim() || null,
      ui_preset_id: document.getElementById('uiPreset').value || null,
      theme_id: document.getElementById('userTheme').value || null,
      tier_id: document.getElementById('userTier').value || null,
      status: document.getElementById('userStatus').value,
      billing_cycle: document.getElementById('billingCycle').value,
      billing_email: email,
      monthly_recurring_revenue: tier?.monthly_price || 0,
      metadata: { notes: document.getElementById('userNotes').value, trial_days: parseInt(document.getElementById('trialDays').value) || 14 },
      created_at: now,
      updated_at: now
    }]);

    await supabaseClient.from('users').insert([{
      user_id: userId,
      tenant_id: tenantId,
      email,
      role: 'owner',
      is_active: true,
      created_at: now,
      updated_at: now
    }]);

    const nameParts = name.split(' ');
    await supabaseClient.from('employees').insert([{
      employee_id: crypto.randomUUID(),
      tenant_id: tenantId,
      user_id: userId,
      first_name: nameParts[0],
      last_name: nameParts.slice(1).join(' ') || '',
      email,
      role: 'owner',
      is_active: true,
      created_at: now
    }]);

    await supabaseClient.from('business_settings').insert([{
      tenant_id: tenantId,
      business_name: company,
      created_at: now,
      updated_at: now
    }]);

    alert('Tenant created successfully:\n' + company + '\nOwner: ' + name);
    clearTenantForm();
    await loadTenants();
  } catch(e) { alert('Error: ' + e.message); }
}

function editTenant(id) {
  const t = tenants.find(x => x.tenant_id === id);
  if (!t) return;
  editingTenantId = id;
  document.getElementById('userName').value = t.tenant_name || '';
  document.getElementById('userEmail').value = t.owner?.email || t.billing_email || '';
  document.getElementById('companyName').value = t.company_name || '';
  document.getElementById('userDomain').value = t.domain || '';
  document.getElementById('uiPreset').value = t.ui_preset_id || '';
  document.getElementById('userTheme').value = t.theme_id || '';
  document.getElementById('userTier').value = t.tier_id || '';
  document.getElementById('userStatus').value = t.status || 'active';
  document.getElementById('billingCycle').value = t.billing_cycle || 'monthly';
  document.getElementById('trialDays').value = t.metadata?.trial_days || 14;
  document.getElementById('userNotes').value = t.metadata?.notes || '';

  document.getElementById('saveTenantBtn').textContent = 'Update Tenant';
  document.getElementById('cancelEditBtn').style.display = 'inline-block';
  window.scrollTo(0, 0);
}

function cancelEdit() {
  editingTenantId = null;
  clearTenantForm();
  document.getElementById('saveTenantBtn').textContent = 'Add Tenant';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

function clearTenantForm() {
  document.getElementById('userName').value = '';
  document.getElementById('userEmail').value = '';
  document.getElementById('companyName').value = '';
  document.getElementById('userDomain').value = '';
  document.getElementById('userNotes').value = '';
  document.getElementById('trialDays').value = '14';
}

async function deleteTenant(id) {
  if (!confirm('Delete this tenant and all associated data? This cannot be undone.')) return;
  try {
    await supabaseClient.from('employees').delete().eq('tenant_id', id);
    await supabaseClient.from('users').delete().eq('tenant_id', id);
    await supabaseClient.from('business_settings').delete().eq('tenant_id', id);
    await supabaseClient.from('tenants').delete().eq('tenant_id', id);
    await loadTenants();
  } catch(e) { alert('Error: ' + e.message); }
}

// ANALYTICS
function loadAnalytics() {
  const days = parseInt(document.getElementById('analyticsRange').value);
  
  // Simulated analytics data
  document.getElementById('analyticSignups').textContent = Math.floor(Math.random() * 20 + 5);
  document.getElementById('analyticGrowth').textContent = '+' + (Math.random() * 15 + 5).toFixed(1) + '%';
  document.getElementById('analyticTickets').textContent = Math.floor(Math.random() * 30 + 10);
  document.getElementById('analyticAPI').textContent = (Math.floor(Math.random() * 500 + 100) + 'K');

  // Revenue breakdown by tier
  const breakdown = document.getElementById('revenueBreakdown');
  breakdown.innerHTML = tiers.map(t => {
    const subscribers = tenants.filter(tn => tn.tier_id === t.tier_id).length;
    const revenue = subscribers * (t.monthly_price || 0);
    return `<div class="role-section" style="text-align:center;">
      <div style="font-weight:600;margin-bottom:8px;">${t.tier_display_name || t.tier_name}</div>
      <div class="speedo-value cyan" style="font-size:24px;">$${revenue.toLocaleString()}</div>
      <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">${subscribers} subscribers</div>
    </div>`;
  }).join('');
}

// UTILITIES
function refreshAllData() {
  loadTiers();
  loadTenants();
  loadPresets();
  loadThemes();
  loadRolePermissions();
  loadAnalytics();
}

function exportReport() {
  const report = {
    generated: new Date().toISOString(),
    summary: {
      total_tenants: tenants.length,
      active_tenants: tenants.filter(t => t.status === 'active').length,
      trial_tenants: tenants.filter(t => t.status === 'trial').length,
      total_mrr: tenants.reduce((sum, t) => sum + (t.monthly_recurring_revenue || 0), 0),
      total_users: tenants.reduce((sum, t) => sum + (t.user_count || 1), 0)
    },
    tiers: tiers.map(t => ({
      name: t.tier_display_name || t.tier_name,
      price: t.monthly_price,
      subscribers: tenants.filter(tn => tn.tier_id === t.tier_id).length
    })),
    tenants: tenants.map(t => ({
      company: t.company_name,
      status: t.status,
      mrr: t.monthly_recurring_revenue,
      users: t.user_count
    }))
  };

  const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'platform-report-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

// Initialize on load
init();
</script>
</body>
</html>
