<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Admin - GlowBots</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0b0f14; color: #e8eef6; min-height: 100vh; }

    .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-bottom: 1px solid #223044; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-title { font-size: 22px; font-weight: 700; color: #3b82f6; }
    .header-badge { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .admin-email { color: #9fb0c3; font-size: 14px; }
    .logout-btn { padding: 10px 20px; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { background: #ef4444; color: #fff; }

    .tabs-container { background: #0f1621; border-bottom: 1px solid #223044; padding: 0 24px; position: sticky; top: 0; z-index: 100; }
    .tabs { display: flex; gap: 0; overflow-x: auto; }
    .tab { padding: 14px 20px; color: #9fb0c3; cursor: pointer; font-size: 14px; border: 1px solid transparent; border-bottom: none; border-radius: 8px 8px 0 0; margin-bottom: -1px; transition: all 0.2s; white-space: nowrap; }
    .tab:hover { color: #e8eef6; background: rgba(59, 130, 246, 0.1); }
    .tab.active { color: #0ff; border-color: #0ff; background: transparent; }

    .action-bar { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #0f1621; border-bottom: 1px solid #223044; }
    .action-left { display: flex; gap: 12px; }
    .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
    .btn-dark { background: #1a2535; border: 1px solid #223044; color: #e8eef6; }
    .btn-dark:hover { background: #223044; }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-success:hover { background: #16a34a; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    .btn-outline { background: transparent; border: 1px solid #223044; color: #9fb0c3; }
    .btn-outline:hover { background: #223044; color: #fff; }
    .btn-sm { padding: 6px 14px; font-size: 12px; }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; }

    .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px; color: #60a5fa; font-size: 14px; }

    .table-container { background: #1a2535; border: 1px solid #223044; border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 600; color: #9fb0c3; text-transform: capitalize; background: #0f1621; border-bottom: 1px solid #223044; }
    td { padding: 14px 16px; border-bottom: 1px solid #223044; font-size: 14px; }
    tr:hover { background: rgba(59, 130, 246, 0.05); }
    tr:last-child td { border-bottom: none; }
    .row-title { font-weight: 600; }
    .row-subtitle { font-size: 12px; color: #9fb0c3; margin-top: 2px; }

    .badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .badge-active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .badge-inactive { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .badge-default { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .badge-industry { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }

    .color-preview { width: 50px; height: 28px; border-radius: 6px; border: 2px solid #223044; display: inline-block; vertical-align: middle; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #1a2535; border: 1px solid #223044; border-radius: 12px; padding: 20px; }
    .stat-value { font-size: 28px; font-weight: 700; color: #3b82f6; }
    .stat-label { font-size: 13px; color: #9fb0c3; margin-top: 4px; }

    .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .tool-card { background: #1a2535; border: 1px solid #223044; border-radius: 16px; padding: 24px; cursor: pointer; transition: all 0.3s; text-decoration: none; color: inherit; display: block; }
    .tool-card:hover { border-color: #3b82f6; transform: translateY(-4px); box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15); }
    .tool-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .tool-description { font-size: 14px; color: #9fb0c3; line-height: 1.5; }

    .tenant-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .tenant-card { background: #1a2535; border: 1px solid #223044; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
    .tenant-card:hover { border-color: #3b82f6; background: #223044; }
    .tenant-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .tenant-info { font-size: 13px; color: #9fb0c3; }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #1a2535; border: 1px solid #223044; border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; color: #9fb0c3; margin-bottom: 6px; }
    .form-input, .form-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #223044; background: #0b0f14; color: #fff; font-size: 14px; }
    .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; }
    .modal-actions { display: flex; gap: 12px; margin-top: 24px; }

    .empty-state { text-align: center; padding: 60px 20px; color: #9fb0c3; }
    .empty-state h3 { margin-bottom: 8px; color: #e8eef6; }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 16px; }
      .tabs { flex-wrap: nowrap; }
      .tools-grid, .tenant-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <span class="header-title">GlowBots System Admin</span>
    <span class="header-badge">Super Admin</span>
  </div>
  <div class="header-right">
    <span class="admin-email" id="adminEmail">Loading...</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>

<div class="tabs-container">
  <div class="tabs">
    <div class="tab active" data-tab="tenants">Tenants</div>
    <div class="tab" data-tab="tiers">Tiers</div>
    <div class="tab" data-tab="presets">UI Presets</div>
    <div class="tab" data-tab="themes">Themes</div>
    <div class="tab" data-tab="roles">Roles</div>
    <div class="tab" data-tab="announcements">Announcements</div>
    <div class="tab" data-tab="flags">Feature Flags</div>
    <div class="tab" data-tab="audit">Audit Log</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>
</div>

<!-- TENANTS TAB -->
<div id="tab-tenants" class="tab-content active">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadTenants()">Refresh</button>
      <button class="btn btn-success">Export</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="openTenantModal()">+ Add Tenant</button>
    </div>
  </div>
  <div class="container">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-value" id="statTenants">-</div><div class="stat-label">Total Tenants</div></div>
      <div class="stat-card"><div class="stat-value" id="statUsers">-</div><div class="stat-label">Total Users</div></div>
      <div class="stat-card"><div class="stat-value" id="statTickets">-</div><div class="stat-label">Open Tickets</div></div>
      <div class="stat-card"><div class="stat-value" id="statEmployees">-</div><div class="stat-label">Employees</div></div>
      <div class="stat-card"><div class="stat-value" id="statCustomers">-</div><div class="stat-label">Customers</div></div>
      <div class="stat-card"><div class="stat-value" id="statEvents">-</div><div class="stat-label">Events</div></div>
    </div>

    <div class="section-title">Admin Tools</div>
    <div class="tools-grid">
      <a href="support-admin.html" class="tool-card"><div class="tool-title">Support Tickets</div><div class="tool-description">View and manage all support tickets across all tenants.</div></a>
      <a href="database-map.html" class="tool-card"><div class="tool-title">Database Map</div><div class="tool-description">Visual database schema viewer with relationships.</div></a>
      <a href="analytics.html" class="tool-card"><div class="tool-title">System Analytics</div><div class="tool-description">Platform-wide analytics, KPIs, and performance metrics.</div></a>
      <a href="user-management.html" class="tool-card"><div class="tool-title">User Management</div><div class="tool-description">View all users, reset passwords, update roles.</div></a>
      <a href="integrations.html" class="tool-card"><div class="tool-title">API & Integrations</div><div class="tool-description">Manage VAPI, webhooks, and third-party connections.</div></a>
    </div>

    <div class="section-title">Switch to Tenant Dashboard</div>
    <div class="tenant-grid" id="tenantList">
      <div class="tenant-card" style="opacity:0.5;"><div class="tenant-name">Loading...</div></div>
    </div>
  </div>
</div>

<!-- TIERS TAB -->
<div id="tab-tiers" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadTiers()">Refresh</button>
      <button class="btn btn-success">Export</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="openTierModal()">+ Add Tier</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">Subscription Tiers</div>
    <div class="info-box">Define pricing tiers with features and Stripe integration.</div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Tier</th><th>Monthly</th><th>Annual</th><th>Limits</th><th>Features</th><th>Subscribers</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="tiersBody">
          <tr><td colspan="8" style="text-align:center;padding:40px;color:#9fb0c3;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- UI PRESETS TAB -->
<div id="tab-presets" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadPresets()">Refresh</button>
      <button class="btn btn-success">Export</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="openPresetModal()">+ Add Preset</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">UI Presets - Button Configuration</div>
    <div class="info-box">UI Presets define which buttons appear and their labels/routes. Each button can be enabled, relabeled, and linked to a custom route.</div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Preset</th><th>Industry</th><th>Nav Buttons</th><th>Action Buttons</th><th>Tenants</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="presetsBody">
          <tr><td colspan="7" style="text-align:center;padding:40px;color:#9fb0c3;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- THEMES TAB -->
<div id="tab-themes" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadThemes()">Refresh</button>
      <button class="btn btn-success">Export</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="openThemeModal()">+ Create Theme</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">Global Themes</div>
    <div class="info-box">Global themes apply across all tenant interfaces. Tenants can select from available themes.</div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Theme</th><th>Preview</th><th>Type</th><th>Tenants</th><th>Default</th><th>Actions</th></tr>
        </thead>
        <tbody id="themesBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ROLES TAB -->
<div id="tab-roles" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadRoles()">Refresh</button>
      <button class="btn btn-success">Export</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="openRoleModal()">+ Add Role</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">User Roles</div>
    <div class="info-box">Define roles and their permissions across the platform.</div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Role</th><th>Description</th><th>Users</th><th>Permissions</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="rolesBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ANNOUNCEMENTS TAB -->
<div id="tab-announcements" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadAnnouncements()">Refresh</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="openAnnouncementModal()">+ New Announcement</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">System Announcements</div>
    <div class="info-box">Broadcast messages to all tenants or specific groups.</div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Title</th><th>Message</th><th>Target</th><th>Start</th><th>End</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="announcementsBody">
          <tr><td colspan="7" style="text-align:center;padding:40px;color:#9fb0c3;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- FEATURE FLAGS TAB -->
<div id="tab-flags" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadFlags()">Refresh</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="openFlagModal()">+ Add Flag</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">Feature Flags</div>
    <div class="info-box">Toggle features on/off globally or per tenant.</div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Flag</th><th>Description</th><th>Default</th><th>Overrides</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="flagsBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- AUDIT LOG TAB -->
<div id="tab-audit" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadAuditLog()">Refresh</button>
      <button class="btn btn-success">Export</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">Audit Log</div>
    <div class="info-box">Track all admin actions and system changes.</div>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Timestamp</th><th>User</th><th>Action</th><th>Resource</th><th>Details</th><th>IP</th></tr>
        </thead>
        <tbody id="auditBody">
          <tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- SETTINGS TAB -->
<div id="tab-settings" class="tab-content">
  <div class="action-bar">
    <div class="action-left">
      <button class="btn btn-dark" onclick="loadSettings()">Refresh</button>
    </div>
    <div class="action-right">
      <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
    </div>
  </div>
  <div class="container">
    <div class="section-title">Global Settings</div>
    <div class="info-box">Configure platform-wide settings.</div>
    <div class="table-container" style="padding:24px;">
      <div class="form-group">
        <label class="form-label">Platform Name</label>
        <input type="text" class="form-input" id="settingPlatformName" value="GlowBots">
      </div>
      <div class="form-group">
        <label class="form-label">Support Email</label>
        <input type="email" class="form-input" id="settingSupportEmail" value="support@glowbots.com">
      </div>
      <div class="form-group">
        <label class="form-label">Default Timezone</label>
        <select class="form-select" id="settingTimezone">
          <option value="America/Los_Angeles">Pacific Time</option>
          <option value="America/Denver">Mountain Time</option>
          <option value="America/Chicago">Central Time</option>
          <option value="America/New_York">Eastern Time</option>
          <option value="UTC">UTC</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Maintenance Mode</label>
        <select class="form-select" id="settingMaintenance">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal" id="tenantModal">
  <div class="modal-content">
    <div class="modal-title">Add New Tenant</div>
    <input type="hidden" id="editTenantId">
    <div class="form-group"><label class="form-label">Tenant Name</label><input type="text" class="form-input" id="tenantName"></div>
    <div class="form-group"><label class="form-label">Company Name</label><input type="text" class="form-input" id="tenantCompany"></div>
    <div class="form-group"><label class="form-label">Dashboard URL</label><input type="text" class="form-input" id="tenantDashboard" value="dashboard-business.html"></div>
    <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="tenantStatus"><option value="active">Active</option><option value="trial">Trial</option><option value="inactive">Inactive</option></select></div>
    <div class="modal-actions"><button class="btn btn-outline" onclick="closeModal('tenantModal')">Cancel</button><button class="btn btn-primary" onclick="saveTenant()">Save</button></div>
  </div>
</div>

<div class="modal" id="tierModal">
  <div class="modal-content">
    <div class="modal-title">Add Subscription Tier</div>
    <input type="hidden" id="editTierId">
    <div class="form-group"><label class="form-label">Tier Name</label><input type="text" class="form-input" id="tierName"></div>
    <div class="form-group"><label class="form-label">Monthly Price</label><input type="number" class="form-input" id="tierMonthly" step="0.01"></div>
    <div class="form-group"><label class="form-label">Annual Price</label><input type="number" class="form-input" id="tierAnnual" step="0.01"></div>
    <div class="form-group"><label class="form-label">Features</label><input type="text" class="form-input" id="tierFeatures" placeholder="e.g., Up to 10 users, 5GB storage"></div>
    <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="tierStatus"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
    <div class="modal-actions"><button class="btn btn-outline" onclick="closeModal('tierModal')">Cancel</button><button class="btn btn-primary" onclick="saveTier()">Save</button></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let adminEmail = null;

// TAB SWITCHING
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    
    // Load data for tab
    const t = tab.dataset.tab;
    if (t === 'tenants') loadTenants();
    else if (t === 'tiers') loadTiers();
    else if (t === 'presets') loadPresets();
    else if (t === 'themes') loadThemes();
    else if (t === 'roles') loadRoles();
    else if (t === 'announcements') loadAnnouncements();
    else if (t === 'flags') loadFlags();
    else if (t === 'audit') loadAuditLog();
  });
});

// INIT
async function init() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refresh = localStorage.getItem('sb_refresh_token');
    if (token && refresh) {
      const { data } = await sb.auth.setSession({ access_token: token, refresh_token: refresh });
      if (data?.session) adminEmail = data.session.user.email;
      else { window.location.href = 'login.html'; return; }
    } else { window.location.href = 'login.html'; return; }
  } else { adminEmail = session.user.email; }

  const { data: user } = await sb.from('users').select('role').eq('email', adminEmail).single();
  if (user?.role !== 'super_admin' && adminEmail !== 'glowbotsapp@gmail.com') {
    alert('Access denied. Super admin only.');
    window.location.href = 'login.html';
    return;
  }
  document.getElementById('adminEmail').textContent = adminEmail;
  loadStats();
  loadTenants();
}

// STATS
async function loadStats() {
  try {
    const { count: t } = await sb.from('tenants').select('*', { count: 'exact', head: true }).neq('tenant_id', '00000000-0000-0000-0000-000000000000');
    document.getElementById('statTenants').textContent = t || 0;
    const { count: u } = await sb.from('users').select('*', { count: 'exact', head: true });
    document.getElementById('statUsers').textContent = u || 0;
    const { count: tk } = await sb.from('support_tickets').select('*', { count: 'exact', head: true }).in('status', ['open', 'in_progress']);
    document.getElementById('statTickets').textContent = tk || 0;
    const { count: e } = await sb.from('employees').select('*', { count: 'exact', head: true });
    document.getElementById('statEmployees').textContent = e || 0;
    const { count: c } = await sb.from('customers').select('*', { count: 'exact', head: true });
    document.getElementById('statCustomers').textContent = c || 0;
    const { count: ev } = await sb.from('events').select('*', { count: 'exact', head: true });
    document.getElementById('statEvents').textContent = ev || 0;
  } catch (err) { console.error(err); }
}

// TENANTS
async function loadTenants() {
  const { data, error } = await sb.from('tenants').select('*').neq('tenant_id', '00000000-0000-0000-0000-000000000000').order('tenant_name');
  const c = document.getElementById('tenantList');
  if (error || !data?.length) { c.innerHTML = '<div class="empty-state"><h3>No tenants</h3><p>Create your first tenant</p></div>'; return; }
  c.innerHTML = data.map(t => `<div class="tenant-card" onclick="switchToTenant('${t.tenant_id}','${t.dashboard_url||'dashboard-business.html'}')">
    <div class="tenant-name">${esc(t.tenant_name||'Unknown')}</div>
    <div class="tenant-info">${esc(t.company_name||'')}</div>
    <div class="tenant-info" style="font-family:monospace;font-size:11px;margin-top:4px;">${t.tenant_id.substring(0,8)}...</div>
    <span class="badge badge-${t.status==='active'?'active':'inactive'}" style="margin-top:8px;">${t.status||'active'}</span>
  </div>`).join('');
}

function switchToTenant(id, url) {
  localStorage.setItem('super_admin_viewing_tenant', id);
  window.location.href = url + '?tenant=' + id;
}

function openTenantModal(id) {
  document.getElementById('editTenantId').value = id || '';
  document.getElementById('tenantName').value = '';
  document.getElementById('tenantCompany').value = '';
  document.getElementById('tenantDashboard').value = 'dashboard-business.html';
  document.getElementById('tenantStatus').value = 'active';
  document.getElementById('tenantModal').classList.add('active');
}

async function saveTenant() {
  const id = document.getElementById('editTenantId').value;
  const data = {
    tenant_name: document.getElementById('tenantName').value,
    company_name: document.getElementById('tenantCompany').value,
    dashboard_url: document.getElementById('tenantDashboard').value,
    status: document.getElementById('tenantStatus').value,
    updated_at: new Date().toISOString()
  };
  if (id) {
    await sb.from('tenants').update(data).eq('tenant_id', id);
  } else {
    data.tenant_id = crypto.randomUUID();
    data.created_at = new Date().toISOString();
    await sb.from('tenants').insert(data);
  }
  closeModal('tenantModal');
  loadTenants();
  loadStats();
}

// TIERS
async function loadTiers() {
  const { data, error } = await sb.from('subscription_tiers').select('*').order('monthly_price');
  const body = document.getElementById('tiersBody');
  if (error) { body.innerHTML = `<tr><td colspan="8" style="color:#ef4444;text-align:center;padding:20px;">Error: ${error.message}</td></tr>`; return; }
  if (!data?.length) { body.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#9fb0c3;">No tiers found. Click "+ Add Tier" to create one.</td></tr>'; return; }
  body.innerHTML = data.map(t => `<tr>
    <td><strong>${esc(t.name)}</strong></td>
    <td>$${(t.monthly_price||0).toFixed(2)}</td>
    <td>$${(t.annual_price||0).toFixed(2)}</td>
    <td>${t.limits||'Unlimited'}</td>
    <td>${esc(t.features||'-')}</td>
    <td>${t.subscribers||0}</td>
    <td><span class="badge badge-${t.status==='active'?'active':'inactive'}">${t.status||'active'}</span></td>
    <td><button class="btn btn-outline btn-sm" onclick="editTier('${t.id}')">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteTier('${t.id}')">Delete</button></td>
  </tr>`).join('');
}

function openTierModal() { document.getElementById('tierModal').classList.add('active'); }

async function saveTier() {
  const data = {
    name: document.getElementById('tierName').value,
    monthly_price: parseFloat(document.getElementById('tierMonthly').value) || 0,
    annual_price: parseFloat(document.getElementById('tierAnnual').value) || 0,
    features: document.getElementById('tierFeatures').value,
    status: document.getElementById('tierStatus').value
  };
  await sb.from('subscription_tiers').insert(data);
  closeModal('tierModal');
  loadTiers();
}

// PRESETS
async function loadPresets() {
  const { data, error } = await sb.from('ui_presets').select('*').order('name');
  const body = document.getElementById('presetsBody');
  if (error) { body.innerHTML = `<tr><td colspan="7" style="color:#ef4444;text-align:center;padding:20px;">Error: ${error.message}</td></tr>`; return; }
  if (!data?.length) { body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#9fb0c3;">No presets found.</td></tr>'; return; }
  body.innerHTML = data.map(p => `<tr>
    <td><div class="row-title">${esc(p.name)}</div><div class="row-subtitle">${esc(p.description||'')}</div></td>
    <td><span class="badge badge-industry">${p.industry||'other'}</span></td>
    <td>${p.nav_buttons||0} buttons</td>
    <td>${p.action_buttons||0} buttons</td>
    <td>${p.tenant_count||0}</td>
    <td><span class="badge badge-${p.status==='active'?'active':'inactive'}">${p.status||'active'}</span></td>
    <td><button class="btn btn-outline btn-sm">Edit</button> <button class="btn btn-danger btn-sm">Delete</button></td>
  </tr>`).join('');
}

// THEMES
async function loadThemes() {
  const { data, error } = await sb.from('themes').select('*').order('name');
  const body = document.getElementById('themesBody');
  if (error) { body.innerHTML = `<tr><td colspan="6" style="color:#ef4444;text-align:center;padding:20px;">Error: ${error.message}</td></tr>`; return; }
  if (!data?.length) { body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">No themes found.</td></tr>'; return; }
  body.innerHTML = data.map(t => `<tr>
    <td><strong>${esc(t.name)}</strong></td>
    <td><div class="color-preview" style="background:${t.primary_color||'#3b82f6'};"></div></td>
    <td><span class="badge badge-industry">${t.type||'dark'}</span></td>
    <td>${t.tenant_count||0}</td>
    <td>${t.is_default ? '<span class="badge badge-default">Default</span>' : '-'}</td>
    <td><button class="btn btn-outline btn-sm">Edit</button> <button class="btn btn-danger btn-sm">Delete</button></td>
  </tr>`).join('');
}

// ROLES
async function loadRoles() {
  const { data, error } = await sb.from('roles').select('*').order('name');
  const body = document.getElementById('rolesBody');
  if (error) { body.innerHTML = `<tr><td colspan="6" style="color:#ef4444;text-align:center;padding:20px;">Error: ${error.message}</td></tr>`; return; }
  if (!data?.length) { body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">No roles found.</td></tr>'; return; }
  body.innerHTML = data.map(r => `<tr>
    <td><strong>${esc(r.name)}</strong></td>
    <td>${esc(r.description||'-')}</td>
    <td>${r.user_count||0}</td>
    <td>${r.permissions?.length||0} permissions</td>
    <td><span class="badge badge-${r.status==='active'?'active':'inactive'}">${r.status||'active'}</span></td>
    <td><button class="btn btn-outline btn-sm">Edit</button> <button class="btn btn-danger btn-sm">Delete</button></td>
  </tr>`).join('');
}

// ANNOUNCEMENTS
async function loadAnnouncements() {
  const { data, error } = await sb.from('announcements').select('*').order('created_at', { ascending: false });
  const body = document.getElementById('announcementsBody');
  if (error) { body.innerHTML = `<tr><td colspan="7" style="color:#ef4444;text-align:center;padding:20px;">Error: ${error.message}</td></tr>`; return; }
  if (!data?.length) { body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#9fb0c3;">No announcements.</td></tr>'; return; }
  body.innerHTML = data.map(a => `<tr>
    <td><strong>${esc(a.title)}</strong></td>
    <td>${esc((a.message||'').substring(0,50))}...</td>
    <td>${a.target||'all'}</td>
    <td>${formatDate(a.start_date)}</td>
    <td>${formatDate(a.end_date)}</td>
    <td><span class="badge badge-${a.status==='active'?'active':'inactive'}">${a.status||'draft'}</span></td>
    <td><button class="btn btn-outline btn-sm">Edit</button> <button class="btn btn-danger btn-sm">Delete</button></td>
  </tr>`).join('');
}

// FLAGS
async function loadFlags() {
  const { data, error } = await sb.from('feature_flags').select('*').order('name');
  const body = document.getElementById('flagsBody');
  if (error) { body.innerHTML = `<tr><td colspan="6" style="color:#ef4444;text-align:center;padding:20px;">Error: ${error.message}</td></tr>`; return; }
  if (!data?.length) { body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">No feature flags.</td></tr>'; return; }
  body.innerHTML = data.map(f => `<tr>
    <td><strong>${esc(f.name)}</strong></td>
    <td>${esc(f.description||'-')}</td>
    <td>${f.default_value ? '<span class="badge badge-active">On</span>' : '<span class="badge badge-inactive">Off</span>'}</td>
    <td>${f.override_count||0}</td>
    <td><span class="badge badge-${f.enabled?'active':'inactive'}">${f.enabled?'Enabled':'Disabled'}</span></td>
    <td><button class="btn btn-outline btn-sm">Edit</button> <button class="btn btn-danger btn-sm">Delete</button></td>
  </tr>`).join('');
}

// AUDIT LOG
async function loadAuditLog() {
  const { data, error } = await sb.from('audit_log').select('*').order('created_at', { ascending: false }).limit(100);
  const body = document.getElementById('auditBody');
  if (error) { body.innerHTML = `<tr><td colspan="6" style="color:#ef4444;text-align:center;padding:20px;">Error: ${error.message}</td></tr>`; return; }
  if (!data?.length) { body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#9fb0c3;">No audit logs.</td></tr>'; return; }
  body.innerHTML = data.map(a => `<tr>
    <td>${formatDateTime(a.created_at)}</td>
    <td>${esc(a.user_email||'-')}</td>
    <td><span class="badge badge-industry">${a.action||'-'}</span></td>
    <td>${esc(a.resource||'-')}</td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${esc(JSON.stringify(a.details||{}))}</td>
    <td>${a.ip_address||'-'}</td>
  </tr>`).join('');
}

// HELPERS
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function esc(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
function formatDate(d) { return d ? new Date(d).toLocaleDateString() : '-'; }
function formatDateTime(d) { return d ? new Date(d).toLocaleString() : '-'; }

function logout() {
  localStorage.removeItem('sb_access_token');
  localStorage.removeItem('sb_refresh_token');
  localStorage.removeItem('super_admin_viewing_tenant');
  Object.keys(localStorage).forEach(k => { if (k.startsWith('sb-')) localStorage.removeItem(k); });
  sb.auth.signOut();
  window.location.href = 'login.html?logout=1';
}

init();
</script>
</body>
</html>
