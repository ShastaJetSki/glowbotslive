<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>EventLogicPro</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ===== THEME DEFINITIONS ===== */
    :root { --bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa; }
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fefcf8;--bg-secondary:#faf6ee;--bg-card:#fff;--bg-hover:#f5efe0;--border-default:#e8dcc8;--text-primary:#44402a;--text-secondary:#6a6550;--accent-primary:#a89060;--accent-light:#c4aa78;}

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;}
    body{padding-bottom:120px;}

    /* Theme toggle */
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .theme-toast{position:fixed;bottom:200px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;z-index:1000;display:none;}
    .theme-toast.show{display:block;animation:toastIn .3s ease;}

    /* Headers */
    .desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border-default);}
    .mobile-top-header{display:block;position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);}
    .mobile-header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px;gap:12px;}
    .mobile-menu-toggle{background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text-secondary);font-size:20px;padding:0;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-appearance:none;}
    .mobile-header-center{flex:1;}
    .mobile-header-title{font-size:18px;font-weight:600;}
    .business-name{font-size:12px;color:var(--accent-light);}
    .mobile-header-right{display:flex;align-items:center;gap:12px;}
    .accordion-icon-header{font-size:20px;color:var(--text-secondary);transition:transform .2s ease;}
    .mobile-menu-toggle.active .accordion-icon-header{transform:rotate(180deg);}
    .mobile-header-content{max-height:0;overflow:hidden;transition:max-height .3s ease;}
    .mobile-header-content.expanded{max-height:200px;}
    .mobile-header-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:8px 12px 12px;background:var(--bg-primary);border-top:1px solid var(--border-default);}
    .mobile-header-actions button{padding:10px;font-size:13px;background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border:1px solid color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--accent-light);border-radius:8px;cursor:pointer;-webkit-appearance:none;}

    /* Bottom nav */
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:6px;}
    .mobile-nav-secondary{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
    .mobile-nav-btn{padding:10px 8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:44px;-webkit-appearance:none;transition:all .2s;}
    .mobile-nav-btn:active{transform:scale(.95);}
    .mobile-nav-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}
    .mobile-nav-btn.related{background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border-color:color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--text-primary);}

    /* Content */
    .content{padding:12px;max-width:900px;margin:0 auto;}

    /* Event selector bar */
    .event-bar{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid var(--border-default);}
    .event-bar-top{display:flex;justify-content:space-between;align-items:center;gap:12px;}
    .event-select{flex:1;padding:12px 16px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:15px;font-weight:600;-webkit-appearance:none;cursor:pointer;}
    .event-bar-btn{padding:12px 16px;border-radius:8px;border:none;background:var(--accent-primary);color:#fff;font-size:14px;font-weight:600;cursor:pointer;white-space:nowrap;-webkit-appearance:none;}
    .event-bar-btn:active{opacity:.9;transform:scale(.98);}
    .event-bar-btn.secondary{background:transparent;border:1px solid var(--border-default);color:var(--text-secondary);}
    .event-stats{display:flex;gap:16px;margin-top:12px;flex-wrap:wrap;}
    .event-stat{display:flex;flex-direction:column;gap:2px;}
    .event-stat-label{font-size:11px;color:var(--text-secondary);text-transform:uppercase;}
    .event-stat-value{font-size:18px;font-weight:700;}

    /* Progress bar */
    .progress-bar-wrap{margin-top:12px;}
    .progress-bar-bg{height:8px;background:var(--bg-hover);border-radius:4px;overflow:hidden;}
    .progress-bar-fill{height:100%;background:var(--accent-primary);border-radius:4px;transition:width .5s ease;}
    .progress-bar-label{font-size:11px;color:var(--text-secondary);margin-top:4px;text-align:right;}

    /* Department sections */
    .dept-section{margin-bottom:8px;}
    .dept-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--bg-card);border-radius:8px;cursor:pointer;border:1px solid var(--border-default);transition:all .2s;}
    .dept-header:hover{background:var(--bg-hover);}
    .dept-header.collapsed{border-radius:8px;}
    .dept-header:not(.collapsed){border-radius:8px 8px 0 0;border-bottom:none;}
    .dept-header-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
    .dept-name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .dept-count{font-size:12px;color:var(--text-secondary);}
    .dept-header-right{display:flex;align-items:center;gap:12px;}
    .dept-progress{width:60px;height:6px;background:var(--bg-hover);border-radius:3px;overflow:hidden;}
    .dept-progress-fill{height:100%;background:#22c55e;border-radius:3px;transition:width .3s;}
    .dept-lead{font-size:11px;color:var(--accent-light);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .dept-expand{font-size:12px;color:var(--text-secondary);transition:transform .2s;}
    .dept-header.collapsed .dept-expand{transform:rotate(-90deg);}

    .dept-body{background:var(--bg-secondary);border:1px solid var(--border-default);border-top:none;border-radius:0 0 8px 8px;overflow:hidden;transition:max-height .3s ease;}
    .dept-body.collapsed{max-height:0 !important;border:none;}

    /* Task rows */
    .task-row{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border-default);transition:background .2s;}
    .task-row:last-child{border-bottom:none;}
    .task-row:hover{background:var(--bg-hover);}
    .task-row.completed{opacity:.6;}
    .task-checkbox{width:24px;height:24px;border-radius:6px;border:2px solid var(--border-default);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;transition:all .2s;-webkit-appearance:none;background:transparent;color:transparent;font-size:14px;}
    .task-checkbox:hover{border-color:var(--accent-primary);}
    .task-checkbox.checked{background:#22c55e;border-color:#22c55e;color:#fff;}
    .task-content{flex:1;min-width:0;}
    .task-title{font-size:14px;font-weight:500;margin-bottom:4px;}
    .task-row.completed .task-title{text-decoration:line-through;color:var(--text-secondary);}
    .task-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .task-meta-tag{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg-hover);color:var(--text-secondary);border:1px solid var(--border-default);white-space:nowrap;}
    .task-meta-tag.cost{color:#22c55e;}
    .task-meta-tag.overdue{color:#ef4444;border-color:#ef4444;}
    .task-meta-tag.lead{color:var(--accent-light);border-color:var(--accent-primary);}
    .task-actions{display:flex;gap:6px;flex-shrink:0;}
    .task-edit-btn{padding:6px 10px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:11px;cursor:pointer;-webkit-appearance:none;}
    .task-edit-btn:hover{background:var(--bg-hover);color:var(--text-primary);}

    /* Dept footer */
    .dept-footer{padding:10px 16px;background:var(--bg-card);border-top:1px solid var(--border-default);display:flex;gap:8px;}
    .dept-footer-btn{padding:8px 14px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer;-webkit-appearance:none;}
    .dept-footer-btn:hover{background:var(--bg-hover);}
    .dept-footer-btn.primary{background:color-mix(in srgb,var(--accent-primary) 20%,transparent);border-color:var(--accent-primary);color:var(--accent-light);}

    /* Modal */
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:2000;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.active{display:flex;}
    .modal-content{background:var(--bg-secondary);border-radius:12px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;border:1px solid var(--border-default);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border-default);position:sticky;top:0;background:var(--bg-secondary);z-index:10;}
    .modal-title{font-size:18px;font-weight:600;}
    .modal-close{background:transparent;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;padding:0;line-height:1;}
    .modal-body{padding:20px;}
    .form-group{margin-bottom:16px;}
    .form-label{display:block;font-size:13px;font-weight:500;color:var(--text-secondary);margin-bottom:6px;}
    .form-input,.form-select,.form-textarea{width:100%;padding:12px 14px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:15px;-webkit-appearance:none;}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent-primary);}
    .form-textarea{min-height:70px;resize:vertical;}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .modal-footer{display:flex;gap:12px;justify-content:flex-end;padding:16px 20px;border-top:1px solid var(--border-default);}
    .btn-primary{padding:12px 20px;border-radius:8px;border:none;background:var(--accent-primary);color:#fff;font-size:14px;font-weight:600;cursor:pointer;-webkit-appearance:none;}
    .btn-primary:active{opacity:.9;}
    .btn-secondary{padding:12px 20px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;-webkit-appearance:none;}
    .btn-danger{padding:12px 20px;border-radius:8px;border:1px solid #ef4444;background:rgba(239,68,68,.15);color:#ef4444;font-size:14px;cursor:pointer;-webkit-appearance:none;}

    /* Toast */
    .toast{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--accent-primary);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;font-weight:500;z-index:3000;display:none;}
    .toast.show{display:block;animation:toastIn .3s ease;}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

    /* Empty state */
    .empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary);}
    .empty-state-text{font-size:16px;margin-bottom:16px;}

    /* Desktop header buttons */
    .desktop-dept-btn{padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border:1px solid color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--accent-light);transition:all .2s;-webkit-appearance:none;}
    .desktop-dept-btn:hover{background:color-mix(in srgb,var(--accent-primary) 20%,transparent);}
    .desktop-dept-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}

    /* Task Detail Panel */
    .detail-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:2000;}
    .detail-overlay.active{display:block;}
    .detail-panel{position:fixed;top:0;right:0;bottom:0;width:100%;max-width:520px;background:var(--bg-primary);overflow-y:auto;z-index:2001;transform:translateX(100%);transition:transform .3s ease;border-left:1px solid var(--border-default);}
    .detail-panel.open{transform:translateX(0);}
    .detail-panel-header{position:sticky;top:0;background:var(--bg-secondary);padding:16px 20px;border-bottom:1px solid var(--border-default);display:flex;justify-content:space-between;align-items:center;z-index:10;}
    .detail-panel-title{font-size:16px;font-weight:600;flex:1;margin-right:12px;}
    .detail-panel-close{background:transparent;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;padding:0;line-height:1;-webkit-appearance:none;}
    .detail-body{padding:20px;}
    .detail-field{margin-bottom:20px;}
    .detail-field-label{font-size:11px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:4px;font-weight:600;}
    .detail-field-value{font-size:15px;}
    .detail-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .detail-status{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;}
    .detail-status.done{background:rgba(34,197,94,.15);color:#22c55e;}
    .detail-status.pending{background:rgba(234,179,8,.15);color:#eab308;}
    .detail-status.overdue{background:rgba(239,68,68,.15);color:#ef4444;}
    .detail-notes{background:var(--bg-card);padding:14px;border-radius:8px;border:1px solid var(--border-default);font-size:14px;white-space:pre-wrap;line-height:1.5;min-height:60px;color:var(--text-secondary);}
    .line-items-section{margin-top:20px;}
    .line-items-title{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .line-item-row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border-default);border-radius:6px;margin-bottom:6px;}
    .line-item-desc{font-size:13px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .line-item-amt{font-size:13px;font-weight:600;color:#22c55e;margin-left:12px;white-space:nowrap;}
    .line-item-del{background:transparent;border:none;color:#ef4444;cursor:pointer;font-size:16px;margin-left:8px;padding:0;-webkit-appearance:none;}
    .line-items-total{display:flex;justify-content:space-between;padding:10px 12px;font-weight:600;font-size:14px;border-top:2px solid var(--border-default);margin-top:8px;}
    .line-items-total .total-amt{color:#22c55e;}
    .add-line-item-row{display:flex;gap:8px;margin-top:8px;}
    .add-line-item-row input{flex:1;padding:8px 10px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:13px;-webkit-appearance:none;}
    .add-line-item-row input:focus{outline:none;border-color:var(--accent-primary);}
    .add-line-item-row button{padding:8px 14px;border-radius:6px;border:none;background:var(--accent-primary);color:#fff;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;-webkit-appearance:none;}
    .detail-actions{display:flex;gap:10px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border-default);}
    .detail-actions button{flex:1;}

    @media(max-width:768px){
      .desktop-header{display:none !important;}
      .mobile-top-header{display:block;}
      .mobile-bottom-nav{display:block !important;}
      .modal-overlay{align-items:flex-end;padding:0;}
      .modal-content{border-radius:20px 20px 0 0;max-height:85vh;}
      .form-row{grid-template-columns:1fr;}
    }
    @media(min-width:769px){
      .mobile-top-header{display:none !important;}
      .mobile-bottom-nav{display:none !important;}
      body{padding-bottom:20px;}
    }
  </style>
</head>
<body>

<!-- Mobile Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span class="accordion-icon-header">☰</span></button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">EventLogicPro</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
      </button>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='sharklaw-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
    </div>
  </div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 style="margin:0;font-size:32px;font-weight:600;">EventLogicPro</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <div style="display:flex;align-items:center;gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
      </button>
      <a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex;gap:24px;">
      <a href="dashboard-sharklaw.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Contacts</a>
      <a href="eventlogicpro.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">EventLogicPro</a>
      <a href="sharklaw-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a>
    </nav>
  </div>
</div>

<!-- Main Content -->
<div class="content">

  <!-- Event Selector Bar -->
  <div class="event-bar">
    <div class="event-bar-top">
      <select class="event-select" id="eventProjectSelect" onchange="switchEvent()">
        <option value="">-- Select Event --</option>
      </select>
      <select class="event-select" id="memberSelect" onchange="switchMember()" style="max-width:160px;font-size:13px;">
        <option value="">-- You --</option>
      </select>
      <button class="event-bar-btn" id="btnNewEvent" onclick="openNewEventProjectModal()" style="display:none;">+ New Event</button>
    </div>
    <div id="eventStatsArea" style="display:none;">
      <div class="event-stats">
        <div class="event-stat"><span class="event-stat-label">Departments</span><span class="event-stat-value" id="statDepts">0</span></div>
        <div class="event-stat"><span class="event-stat-label">Tasks</span><span class="event-stat-value" id="statTotalTasks">0</span></div>
        <div class="event-stat"><span class="event-stat-label">Done</span><span class="event-stat-value" id="statDoneTasks" style="color:#22c55e;">0</span></div>
        <div class="event-stat"><span class="event-stat-label">Total Cost</span><span class="event-stat-value" id="statTotalCost">$0</span></div>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
        <div class="progress-bar-label" id="progressLabel">0% Complete</div>
      </div>
    </div>
  </div>

  <!-- Departments & Tasks -->
  <div id="departmentsArea">
    <div class="empty-state">
      <div class="empty-state-text">Select or create an event to get started</div>
    </div>
  </div>

</div>

<!-- Toast -->
<div id="toast" class="toast"></div>
<div class="theme-toast" id="themeToast"></div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-top">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="sharklaw-contacts.html" class="mobile-nav-btn">Contacts</a>
    <a href="eventlogicpro.html" class="mobile-nav-btn active">Events</a>
    <a href="sharklaw-settings.html" class="mobile-nav-btn">Settings</a>
  </div>
</div>

<!-- New Event Project Modal -->
<div class="modal-overlay" id="newEventProjectModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">New Event</div>
      <button class="modal-close" onclick="closeNewEventProjectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Event Name *</label><input type="text" class="form-input" id="epName" placeholder="e.g., Summer Bash 2026"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Event Date</label><input type="date" class="form-input" id="epDate"></div>
        <div class="form-group"><label class="form-label">Budget</label><input type="number" class="form-input" id="epBudget" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="form-group"><label class="form-label">Venue</label><input type="text" class="form-input" id="epVenue" placeholder="Venue name / location"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="epNotes" placeholder="Event details..."></textarea></div>
      <div class="form-group">
        <label class="form-label" style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="epLoadTemplates" checked style="width:18px;height:18px;">
          Load all 16 department templates with tasks
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewEventProjectModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewEventProject()">Create Event</button>
    </div>
  </div>
</div>

<!-- New/Edit Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="taskModalTitle">New Task</div>
      <button class="modal-close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Task Title *</label><input type="text" class="form-input" id="tmTitle" placeholder="Task description"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Lead</label><select class="form-select" id="tmLead"><option value="">-- None --</option></select></div>
        <div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="tmAssigned"><option value="">-- None --</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="tmStart"></div>
        <div class="form-group"><label class="form-label">Deadline</label><input type="date" class="form-input" id="tmDeadline"></div>
      </div>
      <div class="form-group"><label class="form-label">Cost ($)</label><input type="number" class="form-input" id="tmCost" placeholder="0.00" step="0.01"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="tmNotes" placeholder="Notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="tmDeleteBtn" style="display:none;" onclick="deleteTask()">Delete</button>
      <button class="btn-secondary" onclick="closeTaskModal()">Cancel</button>
      <button class="btn-primary" onclick="saveTask()">Save</button>
    </div>
  </div>
</div>

<!-- Task Detail Panel -->
<div class="detail-overlay" id="detailOverlay" onclick="closeDetailPanel()"></div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-panel-header">
    <div class="detail-panel-title" id="detailTitle">Task Details</div>
    <button class="detail-panel-close" onclick="closeDetailPanel()">&times;</button>
  </div>
  <div class="detail-body" id="detailBody"></div>
</div>

<!-- Department Lead Modal -->
<div class="modal-overlay" id="deptLeadModal">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <div class="modal-title" id="deptLeadTitle">Set Department Lead</div>
      <button class="modal-close" onclick="closeDeptLeadModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Department Lead</label><select class="form-select" id="dlLead"><option value="">-- None --</option></select></div>
      <div class="form-group"><label class="form-label">Department Budget ($)</label><input type="number" class="form-input" id="dlBudget" placeholder="0.00" step="0.01"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeDeptLeadModal()">Cancel</button>
      <button class="btn-primary" onclick="saveDeptLead()">Save</button>
    </div>
  </div>
</div>

<script>
var SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

var tenantId=null, userId=null;
var allProjects=[], allDepartments=[], allTasks=[], allMembers=[];
var currentProjectId=null;
var editingTaskId=null, editingTaskDeptId=null;
var editingDeptId=null;
var currentMember=null; // logged-in event_member
var userRole='team'; // admin|manager|team

// ===== THEME =====
var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal'];
var themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=themes.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){themeIndex=(themeIndex+1)%themes.length;var t=themes[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(t.replace(/-/g,' ').replace(/\b\w/g,function(l){return l.toUpperCase();}));}
function showThemeToast(msg){var t=document.getElementById('themeToast');t.textContent='Theme: '+msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
loadTheme();

function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2500);}
function toggleMobileMenu(btn){document.getElementById('mobileHeaderContent').classList.toggle('expanded');btn.classList.toggle('active');}
async function logout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}

// ===== AUTH =====
async function checkAuth(){
  var r=await sb.auth.getSession(); var s=r.data.session;
  if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');
    if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}
    if(!s){window.location.href='login.html';return null;}}
  return s;
}

// ===== LOAD DATA =====
async function loadMembers(){
  var r=await sb.from('event_members').select('*').eq('tenant_id',tenantId).eq('is_active',true).order('first_name');
  allMembers=r.data||[];
}

async function seedDefaultMembers(){
  // Check if any members exist for this tenant
  var r=await sb.from('event_members').select('member_id').eq('tenant_id',tenantId).limit(1);
  if(r.data&&r.data.length>0) return;
  var defaults=[
    {first_name:'Kevin',role_level:'admin'},
    {first_name:'Allen',role_level:'manager'},
    {first_name:'Matt',role_level:'manager'},
    {first_name:'Brian',role_level:'team'},
    {first_name:'Dave',role_level:'team'},
    {first_name:'Hunter',role_level:'team'},
    {first_name:'Joe',role_level:'team'},
    {first_name:'James',role_level:'team'},
    {first_name:'Jimmy',role_level:'team'},
    {first_name:'Dan',role_level:'team'}
  ];
  var inserts=defaults.map(function(d){return{tenant_id:tenantId,first_name:d.first_name,role_level:d.role_level};});
  await sb.from('event_members').insert(inserts);
  await loadMembers();
}

async function identifyCurrentMember(email){
  // Try to match by email first, then let user pick
  if(email){
    var m=allMembers.find(function(x){return x.email&&x.email.toLowerCase()===email.toLowerCase();});
    if(m){currentMember=m;userRole=m.role_level||'team';return;}
  }
  // Check localStorage for last selected member
  var savedId=localStorage.getItem('elp-member-id');
  if(savedId){
    var m=allMembers.find(function(x){return x.member_id===savedId;});
    if(m){currentMember=m;userRole=m.role_level||'team';return;}
  }
  // Default to first admin, or first member
  var admin=allMembers.find(function(x){return x.role_level==='admin';});
  currentMember=admin||allMembers[0]||null;
  userRole=currentMember?currentMember.role_level:'team';
  if(currentMember) localStorage.setItem('elp-member-id',currentMember.member_id);
}

function canEdit(){return userRole==='admin'||userRole==='manager';}
function canAdmin(){return userRole==='admin';}

async function loadProjects(){
  var r=await sb.from('event_projects').select('*').eq('tenant_id',tenantId).order('created_at',{ascending:false});
  allProjects=r.data||[];
  renderProjectSelect();
}

async function loadProjectData(){
  if(!currentProjectId)return;
  var dr=await sb.from('event_departments').select('*').eq('event_project_id',currentProjectId).order('sort_order');
  allDepartments=dr.data||[];
  var tr=await sb.from('event_tasks').select('*').eq('event_project_id',currentProjectId).order('sort_order');
  allTasks=tr.data||[];
}

// ===== RENDER =====
function empName(id){
  if(!id) return '';
  var e=allMembers.find(function(m){return m.member_id===id;});
  return e?((e.first_name||'')+' '+(e.last_name||'')).trim():'Unknown';
}

function renderProjectSelect(){
  var sel=document.getElementById('eventProjectSelect');
  sel.innerHTML='<option value="">-- Select Event --</option>';
  allProjects.forEach(function(p){
    var selected=p.event_project_id===currentProjectId?' selected':'';
    sel.innerHTML+='<option value="'+p.event_project_id+'"'+selected+'>'+p.event_name+(p.event_date?' ('+p.event_date+')':'')+'</option>';
  });
}

function renderAll(){
  renderStats();
  renderDepartments();
}

function renderStats(){
  var area=document.getElementById('eventStatsArea');
  if(!currentProjectId){area.style.display='none';return;}
  area.style.display='block';
  var total=allTasks.length;
  var done=allTasks.filter(function(t){return t.is_complete;}).length;
  var cost=allTasks.reduce(function(s,t){return s+(parseFloat(t.cost)||0);},0);
  var pct=total>0?Math.round(done/total*100):0;
  document.getElementById('statTotalTasks').textContent=total;
  document.getElementById('statDoneTasks').textContent=done;
  document.getElementById('statDepts').textContent=allDepartments.length;
  document.getElementById('statTotalCost').textContent='$'+cost.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:2});
  document.getElementById('progressFill').style.width=pct+'%';
  document.getElementById('progressLabel').textContent=pct+'% Complete ('+done+'/'+total+')';
}



function renderDepartments(){
  var area=document.getElementById('departmentsArea');
  if(!currentProjectId){area.innerHTML='<div class="empty-state"><div class="empty-state-text">Select or create an event to get started</div></div>';return;}
  if(!allDepartments.length){area.innerHTML='<div class="empty-state"><div class="empty-state-text">No departments yet</div><button class="btn-primary" style="margin-top:12px;" onclick="addDepartmentPrompt()">+ Add Department</button></div>';return;}

  var html='';
  allDepartments.forEach(function(dept){
    var tasks=allTasks.filter(function(t){return t.event_department_id===dept.event_department_id;});
    var done=tasks.filter(function(t){return t.is_complete;}).length;
    var pct=tasks.length>0?Math.round(done/tasks.length*100):0;
    var leadName=empName(dept.lead_employee_id);

    html+='<div class="dept-section" id="dept-'+dept.event_department_id+'">';
    html+='<div class="dept-header collapsed" onclick="toggleDept(\''+dept.event_department_id+'\')">';
    html+='<div class="dept-header-left"><span class="dept-name">'+dept.department_name+'</span><span class="dept-count">'+done+'/'+tasks.length+'</span></div>';
    html+='<div class="dept-header-right">'+(leadName?'<span class="dept-lead">'+leadName+'</span>':'')+'<div class="dept-progress"><div class="dept-progress-fill" style="width:'+pct+'%"></div></div><span class="dept-expand">▼</span></div>';
    html+='</div>';

    html+='<div class="dept-body collapsed" id="deptBody-'+dept.event_department_id+'">';
    tasks.forEach(function(task){
      var isComplete=task.is_complete;
      var isOverdue=!isComplete&&task.deadline&&new Date(task.deadline)<new Date();
      var assignedName=empName(task.assigned_to);
      var taskLeadName=empName(task.lead_employee_id);

      var canToggle=canEdit()||(currentMember&&task.assigned_to===currentMember.member_id);
      html+='<div class="task-row'+(isComplete?' completed':'')+'">';
      if(canToggle){
        html+='<button class="task-checkbox'+(isComplete?' checked':'')+'" onclick="event.stopPropagation();toggleTask(\''+task.event_task_id+'\','+!isComplete+')">'+(isComplete?'✓':'')+'</button>';
      } else {
        html+='<div class="task-checkbox'+(isComplete?' checked':'')+'" style="cursor:default;opacity:.5;">'+(isComplete?'✓':'')+'</div>';
      }
      html+='<div class="task-content" style="cursor:pointer;" onclick="event.stopPropagation();openDetailPanel(\''+task.event_task_id+'\')"><div class="task-title">'+task.task_title+'</div><div class="task-meta">';
      if(taskLeadName) html+='<span class="task-meta-tag lead">Lead: '+taskLeadName+'</span>';
      if(assignedName) html+='<span class="task-meta-tag">'+assignedName+'</span>';
      if(task.deadline) html+='<span class="task-meta-tag'+(isOverdue?' overdue':'')+'">Due: '+task.deadline+'</span>';
      if(task.cost>0) html+='<span class="task-meta-tag cost">$'+parseFloat(task.cost).toLocaleString()+'</span>';
      html+='</div></div>';
      if(canEdit()) html+='<div class="task-actions"><button class="task-edit-btn" onclick="event.stopPropagation();openEditTask(\''+task.event_task_id+'\')">Edit</button></div>';
      html+='</div>';
    });
    html+='<div class="dept-footer">';
    if(canEdit()) html+='<button class="dept-footer-btn primary" onclick="openNewTask(\''+dept.event_department_id+'\')">+ Task</button>';
    if(canEdit()) html+='<button class="dept-footer-btn" onclick="openDeptLeadModal(\''+dept.event_department_id+'\')">Lead</button>';
    html+='</div>';
    html+='</div></div>';
  });

  html+='<div style="padding:12px 0;display:flex;gap:8px;">';
  if(canAdmin()) html+='<button class="btn-primary" onclick="addDepartmentPrompt()" style="font-size:13px;padding:10px 16px;">+ Add Department</button>';
  html+='<button class="btn-secondary" onclick="expandAllDepts()" style="font-size:13px;padding:10px 16px;">Expand All</button>';
  html+='<button class="btn-secondary" onclick="collapseAllDepts()" style="font-size:13px;padding:10px 16px;">Collapse All</button>';
  html+='</div>';
  area.innerHTML=html;
}

function toggleDept(id){
  var header=document.querySelector('#dept-'+id+' .dept-header');
  var body=document.getElementById('deptBody-'+id);
  header.classList.toggle('collapsed');
  if(body.classList.contains('collapsed')){body.classList.remove('collapsed');body.style.maxHeight=body.scrollHeight+'px';}
  else{body.style.maxHeight='0px';setTimeout(function(){body.classList.add('collapsed');},300);}
}
function expandAllDepts(){document.querySelectorAll('.dept-header.collapsed').forEach(function(h){h.click();});}
function collapseAllDepts(){document.querySelectorAll('.dept-header:not(.collapsed)').forEach(function(h){h.click();});}

function renderMemberSelect(){
  var sel=document.getElementById('memberSelect');
  sel.innerHTML='';
  allMembers.forEach(function(m){
    var name=((m.first_name||'')+' '+(m.last_name||'')).trim()||'Unknown';
    var badge=m.role_level==='admin'?' [A]':(m.role_level==='manager'?' [M]':'');
    var selected=currentMember&&m.member_id===currentMember.member_id?' selected':'';
    sel.innerHTML+='<option value="'+m.member_id+'"'+selected+'>'+name+badge+'</option>';
  });
}

function switchMember(){
  var sel=document.getElementById('memberSelect');
  var id=sel.value;
  var m=allMembers.find(function(x){return x.member_id===id;});
  if(m){currentMember=m;userRole=m.role_level||'team';localStorage.setItem('elp-member-id',m.member_id);}
  applyPermissions();
  renderAll();
}

function applyPermissions(){
  // New Event button - admin only
  var btn=document.getElementById('btnNewEvent');
  if(btn) btn.style.display=canAdmin()?'block':'none';
}

// ===== EVENT SWITCHING =====
async function switchEvent(){
  var sel=document.getElementById('eventProjectSelect');
  currentProjectId=sel.value||null;
  if(currentProjectId){await loadProjectData();}else{allDepartments=[];allTasks=[];}
  renderAll();
}

// ===== NEW EVENT PROJECT =====
function openNewEventProjectModal(){
  document.getElementById('epName').value='';
  document.getElementById('epDate').value='';
  document.getElementById('epBudget').value='';
  document.getElementById('epVenue').value='';
  document.getElementById('epNotes').value='';
  document.getElementById('epLoadTemplates').checked=true;
  document.getElementById('newEventProjectModal').classList.add('active');
}
function closeNewEventProjectModal(){document.getElementById('newEventProjectModal').classList.remove('active');}

async function saveNewEventProject(){
  var name=document.getElementById('epName').value.trim();
  if(!name){showToast('Enter an event name');return;}
  var data={
    tenant_id:tenantId,
    event_name:name,
    event_date:document.getElementById('epDate').value||null,
    total_budget:parseFloat(document.getElementById('epBudget').value)||0,
    venue:document.getElementById('epVenue').value.trim()||null,
    notes:document.getElementById('epNotes').value.trim()||null,
    status:'planning',
    created_by:userId
  };
  var r=await sb.from('event_projects').insert(data).select().single();
  if(r.error){showToast('Error: '+r.error.message);return;}
  var projectId=r.data.event_project_id;
  var loadTemplates=document.getElementById('epLoadTemplates').checked;
  if(loadTemplates){await loadTemplatesIntoProject(projectId);}
  closeNewEventProjectModal();
  showToast('Event created!');
  currentProjectId=projectId;
  await loadProjects();
  await loadProjectData();
  renderAll();
}

async function loadTemplatesIntoProject(projectId){
  // Get all unique department names from templates
  var tr=await sb.from('event_task_templates').select('department_name,task_title,sort_order').or('tenant_id.is.null,tenant_id.eq.'+tenantId).order('department_name').order('sort_order');
  var templates=tr.data||[];
  if(!templates.length) return;
  var deptMap={};
  templates.forEach(function(t){if(!deptMap[t.department_name])deptMap[t.department_name]=[];deptMap[t.department_name].push(t);});

  var deptNames=Object.keys(deptMap);
  // Insert departments
  var deptInserts=deptNames.map(function(name,i){return{tenant_id:tenantId,event_project_id:projectId,department_name:name,sort_order:i};});
  var dr=await sb.from('event_departments').insert(deptInserts).select();
  if(dr.error){console.error('Dept insert error:',dr.error);return;}
  var insertedDepts=dr.data;

  // Insert tasks for each department
  var taskInserts=[];
  insertedDepts.forEach(function(dept){
    var tasks=deptMap[dept.department_name]||[];
    tasks.forEach(function(t){
      taskInserts.push({
        tenant_id:tenantId,
        event_project_id:projectId,
        event_department_id:dept.event_department_id,
        task_title:t.task_title,
        sort_order:t.sort_order,
        is_complete:false,
        cost:0,
        created_by:userId
      });
    });
  });
  if(taskInserts.length){
    // Supabase can handle bulk inserts
    var batchSize=50;
    for(var i=0;i<taskInserts.length;i+=batchSize){
      var batch=taskInserts.slice(i,i+batchSize);
      await sb.from('event_tasks').insert(batch);
    }
  }
}

// ===== TASKS =====
function populateEmpDropdowns(){
  var selects=['tmLead','tmAssigned','dlLead'];
  selects.forEach(function(id){
    var sel=document.getElementById(id);
    if(!sel) return;
    var current=sel.value;
    sel.innerHTML='<option value="">-- None --</option>';
    allMembers.forEach(function(e){
      var name=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown';
      sel.innerHTML+='<option value="'+e.member_id+'">'+name+'</option>';
    });
    if(current) sel.value=current;
  });
}

function openNewTask(deptId){
  editingTaskId=null;
  editingTaskDeptId=deptId;
  document.getElementById('taskModalTitle').textContent='New Task';
  document.getElementById('tmTitle').value='';
  document.getElementById('tmStart').value='';
  document.getElementById('tmDeadline').value='';
  document.getElementById('tmCost').value='';
  document.getElementById('tmNotes').value='';
  document.getElementById('tmDeleteBtn').style.display='none';
  populateEmpDropdowns();
  document.getElementById('tmLead').value='';
  document.getElementById('tmAssigned').value='';
  document.getElementById('taskModal').classList.add('active');
}

function openEditTask(taskId){
  var task=allTasks.find(function(t){return t.event_task_id===taskId;});
  if(!task){showToast('Task not found');return;}
  editingTaskId=taskId;
  editingTaskDeptId=task.event_department_id;
  document.getElementById('taskModalTitle').textContent='Edit Task';
  document.getElementById('tmTitle').value=task.task_title||'';
  document.getElementById('tmStart').value=task.projected_start||'';
  document.getElementById('tmDeadline').value=task.deadline||'';
  document.getElementById('tmCost').value=task.cost||'';
  document.getElementById('tmNotes').value=task.notes||'';
  document.getElementById('tmDeleteBtn').style.display=canAdmin()?'block':'none';
  populateEmpDropdowns();
  document.getElementById('tmLead').value=task.lead_employee_id||'';
  document.getElementById('tmAssigned').value=task.assigned_to||'';
  document.getElementById('taskModal').classList.add('active');
}

function closeTaskModal(){document.getElementById('taskModal').classList.remove('active');}

async function saveTask(){
  var title=document.getElementById('tmTitle').value.trim();
  if(!title){showToast('Enter a task title');return;}
  var data={
    task_title:title,
    lead_employee_id:document.getElementById('tmLead').value||null,
    assigned_to:document.getElementById('tmAssigned').value||null,
    projected_start:document.getElementById('tmStart').value||null,
    deadline:document.getElementById('tmDeadline').value||null,
    cost:parseFloat(document.getElementById('tmCost').value)||0,
    notes:document.getElementById('tmNotes').value.trim()||null,
    updated_at:new Date().toISOString()
  };
  if(editingTaskId){
    var r=await sb.from('event_tasks').update(data).eq('event_task_id',editingTaskId);
    if(r.error){showToast('Error: '+r.error.message);return;}
    showToast('Task updated');
  }else{
    data.tenant_id=tenantId;
    data.event_project_id=currentProjectId;
    data.event_department_id=editingTaskDeptId;
    data.is_complete=false;
    data.created_by=userId;
    var r=await sb.from('event_tasks').insert(data);
    if(r.error){showToast('Error: '+r.error.message);return;}
    showToast('Task added');
  }
  closeTaskModal();
  await loadProjectData();
  renderAll();
}

async function deleteTask(){
  if(!editingTaskId||!confirm('Delete this task?')) return;
  var r=await sb.from('event_tasks').delete().eq('event_task_id',editingTaskId);
  if(r.error){showToast('Error: '+r.error.message);return;}
  closeTaskModal();showToast('Task deleted');
  await loadProjectData();renderAll();
}

async function toggleTask(taskId,complete){
  var data={is_complete:complete,updated_at:new Date().toISOString()};
  if(complete){data.completed_at=new Date().toISOString();data.completed_by=userId;}
  else{data.completed_at=null;data.completed_by=null;}
  await sb.from('event_tasks').update(data).eq('event_task_id',taskId);
  await loadProjectData();
  renderAll();
}

// ===== DEPARTMENT LEAD =====
function openDeptLeadModal(deptId){
  editingDeptId=deptId;
  var dept=allDepartments.find(function(d){return d.event_department_id===deptId;});
  document.getElementById('deptLeadTitle').textContent=(dept?dept.department_name:'Department')+' - Lead & Budget';
  populateEmpDropdowns();
  document.getElementById('dlLead').value=dept?.lead_employee_id||'';
  document.getElementById('dlBudget').value=dept?.budget||'';
  document.getElementById('deptLeadModal').classList.add('active');
}
function closeDeptLeadModal(){document.getElementById('deptLeadModal').classList.remove('active');}

async function saveDeptLead(){
  if(!editingDeptId) return;
  var data={
    lead_employee_id:document.getElementById('dlLead').value||null,
    budget:parseFloat(document.getElementById('dlBudget').value)||0
  };
  await sb.from('event_departments').update(data).eq('event_department_id',editingDeptId);
  closeDeptLeadModal();showToast('Department updated');
  await loadProjectData();renderAll();
}

// ===== ADD DEPARTMENT =====
async function addDepartmentPrompt(){
  var name=prompt('Department name:');
  if(!name||!name.trim()) return;
  var data={tenant_id:tenantId,event_project_id:currentProjectId,department_name:name.trim(),sort_order:allDepartments.length};
  var r=await sb.from('event_departments').insert(data);
  if(r.error){showToast('Error: '+r.error.message);return;}
  showToast('Department added');
  await loadProjectData();renderAll();
}

// ===== TASK DETAIL PANEL =====
var detailTaskId=null;
var detailLineItems=[];

async function openDetailPanel(taskId){
  detailTaskId=taskId;
  var task=allTasks.find(function(t){return t.event_task_id===taskId;});
  if(!task){showToast('Task not found');return;}
  document.getElementById('detailTitle').textContent=task.task_title;

  // Load line items
  var lr=await sb.from('event_task_line_items').select('*').eq('event_task_id',taskId).order('sort_order');
  detailLineItems=lr.data||[];

  renderDetailBody(task);
  document.getElementById('detailOverlay').classList.add('active');
  document.getElementById('detailPanel').classList.add('open');
}

function closeDetailPanel(){
  document.getElementById('detailOverlay').classList.remove('active');
  document.getElementById('detailPanel').classList.remove('open');
  detailTaskId=null;
}

function renderDetailBody(task){
  var isComplete=task.is_complete;
  var isOverdue=!isComplete&&task.deadline&&new Date(task.deadline)<new Date();
  var statusClass=isComplete?'done':(isOverdue?'overdue':'pending');
  var statusText=isComplete?'Complete':(isOverdue?'Overdue':'Pending');
  var leadName=empName(task.lead_employee_id);
  var assignedName=empName(task.assigned_to);
  var dept=allDepartments.find(function(d){return d.event_department_id===task.event_department_id;});
  var deptName=dept?dept.department_name:'—';

  var lineTotal=detailLineItems.reduce(function(s,li){return s+(parseFloat(li.amount)||0);},0);
  var taskCost=parseFloat(task.cost)||0;

  var h='';
  h+='<div class="detail-field"><div class="detail-field-label">Status</div><span class="detail-status '+statusClass+'">'+statusText+'</span></div>';
  h+='<div class="detail-field"><div class="detail-field-label">Department</div><div class="detail-field-value">'+deptName+'</div></div>';
  h+='<div class="detail-row">';
  h+='<div class="detail-field"><div class="detail-field-label">Lead</div><div class="detail-field-value">'+(leadName||'—')+'</div></div>';
  h+='<div class="detail-field"><div class="detail-field-label">Assigned To</div><div class="detail-field-value">'+(assignedName||'—')+'</div></div>';
  h+='</div>';
  h+='<div class="detail-row">';
  h+='<div class="detail-field"><div class="detail-field-label">Start Date</div><div class="detail-field-value">'+(task.projected_start||'—')+'</div></div>';
  h+='<div class="detail-field"><div class="detail-field-label">Deadline</div><div class="detail-field-value">'+(task.deadline||'—')+'</div></div>';
  h+='</div>';
  h+='<div class="detail-field"><div class="detail-field-label">Task Cost</div><div class="detail-field-value" style="font-size:20px;font-weight:700;color:#22c55e;">$'+(taskCost>0?taskCost.toLocaleString():'0')+'</div></div>';

  h+='<div class="detail-field"><div class="detail-field-label">Notes</div><div class="detail-notes">'+(task.notes||'No notes')+'</div></div>';

  // Line Items
  h+='<div class="line-items-section">';
  h+='<div class="line-items-title"><span>Cost Line Items</span></div>';
  if(detailLineItems.length){
    detailLineItems.forEach(function(li){
      h+='<div class="line-item-row"><span class="line-item-desc">'+li.description+'</span><span class="line-item-amt">$'+(parseFloat(li.amount)||0).toLocaleString(undefined,{minimumFractionDigits:2})+'</span><button class="line-item-del" onclick="deleteLineItem(\''+li.line_item_id+'\')">&times;</button></div>';
    });
    h+='<div class="line-items-total"><span>Line Items Total</span><span class="total-amt">$'+lineTotal.toLocaleString(undefined,{minimumFractionDigits:2})+'</span></div>';
  } else {
    h+='<div style="padding:12px;text-align:center;color:var(--text-secondary);font-size:13px;">No line items</div>';
  }
  h+='<div class="add-line-item-row"><input type="text" id="liDesc" placeholder="Description"><input type="number" id="liAmt" placeholder="0.00" step="0.01" style="max-width:100px;"><button onclick="addLineItem()">Add</button></div>';
  h+='</div>';

  h+='<div class="detail-actions">';
  if(canEdit()) h+='<button class="btn-primary" onclick="openEditTask(\''+task.event_task_id+'\');closeDetailPanel();">Edit Task</button>';
  var canToggleThis=canEdit()||(currentMember&&task.assigned_to===currentMember.member_id);
  if(canToggleThis) h+='<button class="btn-secondary" onclick="toggleTask(\''+task.event_task_id+'\','+!isComplete+');closeDetailPanel();">'+(isComplete?'Mark Pending':'Mark Done')+'</button>';
  h+='</div>';

  document.getElementById('detailBody').innerHTML=h;
}

async function addLineItem(){
  if(!detailTaskId) return;
  var desc=document.getElementById('liDesc').value.trim();
  var amt=parseFloat(document.getElementById('liAmt').value)||0;
  if(!desc){showToast('Enter a description');return;}
  var data={tenant_id:tenantId,event_task_id:detailTaskId,description:desc,amount:amt,sort_order:detailLineItems.length};
  var r=await sb.from('event_task_line_items').insert(data);
  if(r.error){showToast('Error: '+r.error.message);return;}
  // Update task cost to sum of line items
  var lr=await sb.from('event_task_line_items').select('amount').eq('event_task_id',detailTaskId);
  detailLineItems=[];
  var newTotal=(lr.data||[]).reduce(function(s,li){return s+(parseFloat(li.amount)||0);},0);
  await sb.from('event_tasks').update({cost:newTotal,updated_at:new Date().toISOString()}).eq('event_task_id',detailTaskId);
  await loadProjectData();
  renderAll();
  await openDetailPanel(detailTaskId);
}

async function deleteLineItem(lineId){
  await sb.from('event_task_line_items').delete().eq('line_item_id',lineId);
  var lr=await sb.from('event_task_line_items').select('amount').eq('event_task_id',detailTaskId);
  var newTotal=(lr.data||[]).reduce(function(s,li){return s+(parseFloat(li.amount)||0);},0);
  await sb.from('event_tasks').update({cost:newTotal,updated_at:new Date().toISOString()}).eq('event_task_id',detailTaskId);
  await loadProjectData();
  renderAll();
  await openDetailPanel(detailTaskId);
}

// ===== INIT =====
async function init(){
  var s=await checkAuth();
  if(!s) return;
  userId=s.user.id;
  var userEmail=s.user.email||'';
  // Get tenant
  if(userEmail){
    var ur=await sb.from('users').select('tenant_id,user_id').eq('email',userEmail).single();
    if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}
    document.getElementById('mobileBusinessName').textContent=userEmail;
    document.getElementById('desktopBusinessName').textContent=userEmail;
  }
  if(!tenantId){
    var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();
    if(bs.data) tenantId=bs.data.tenant_id;
  }
  if(!tenantId){showToast('Could not determine tenant');return;}
  await seedDefaultMembers();
  await loadMembers();
  await identifyCurrentMember(userEmail);
  renderMemberSelect();
  applyPermissions();
  await loadProjects();
  if(allProjects.length&&!currentProjectId){
    currentProjectId=allProjects[0].event_project_id;
    document.getElementById('eventProjectSelect').value=currentProjectId;
    await loadProjectData();
  }
  renderAll();
}
init();
</script>
</body>
</html>
