<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Budget â€” EventLogicPro</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa; }
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#261214;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fefcf8;--bg-secondary:#faf6ee;--bg-card:#fff;--bg-hover:#f5efe0;--border-default:#e8dcc8;--text-primary:#44402a;--text-secondary:#6a6550;--accent-primary:#a89060;--accent-light:#c4aa78;}

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html{scrollbar-gutter:stable;}html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;}
    body{padding-bottom:120px;}
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .theme-toast{position:fixed;bottom:200px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;z-index:1000;display:none;}
    .theme-toast.show{display:block;animation:toastIn .3s ease;}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
    .desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);flex-shrink:0;}
    .mobile-top-header{display:block;position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);}
    .mobile-header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px;gap:10px;}
    .mobile-menu-toggle{background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text-secondary);font-size:20px;padding:0;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;-webkit-appearance:none;}
    .mobile-header-center{flex:1;min-width:0;}.mobile-header-title{font-size:18px;font-weight:600;}
    .business-name{font-size:12px;color:var(--accent-light);}
    .mobile-header-right{display:flex;align-items:center;gap:8px;}
    .accordion-icon-header{font-size:20px;color:var(--text-secondary);transition:transform .2s ease;}
    .mobile-menu-toggle.active .accordion-icon-header{transform:rotate(180deg);}
    .mobile-header-content{max-height:0;overflow:hidden;transition:max-height .3s ease;}
    .mobile-header-content.expanded{max-height:300px;}
    .mobile-header-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:8px 12px 12px;background:var(--bg-primary);border-top:1px solid var(--border-default);}
    .mobile-header-actions button{padding:10px;font-size:13px;background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border:1px solid color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--accent-light);border-radius:8px;cursor:pointer;-webkit-appearance:none;}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:6px 8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;}
    .mobile-nav-btn{padding:8px 4px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:40px;-webkit-appearance:none;transition:all .2s;}
    .mobile-nav-btn:active{transform:scale(.95);}
    .mobile-nav-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}
    .content{padding:12px;max-width:1100px;margin:0 auto;}
    @media(max-width:768px){.desktop-header{display:none!important;}.mobile-top-header{display:block;}.mobile-bottom-nav{display:block!important;}}
    @media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}body{padding-bottom:20px;}}
    .hdr-est-bar{display:flex;align-items:center;gap:8px;padding:0 24px 8px;}
    .hdr-est-sel{flex:1;max-width:320px;padding:7px 12px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:13px;font-weight:600;font-family:inherit;-webkit-appearance:none;cursor:pointer;transition:border-color .15s;}
    .hdr-est-sel:focus{outline:none;border-color:var(--accent-primary);}
    .hdr-est-btn{padding:7px 14px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .15s;letter-spacing:.2px;}
    .hdr-est-btn:hover{color:var(--text-primary);border-color:var(--text-secondary);}
    .hdr-est-btn.pri{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);font-weight:600;}.hdr-est-btn.pri:hover{opacity:.9;}
    .hdr-est-btn.grn{color:#22c55e;border-color:rgba(34,197,94,.3);}.hdr-est-btn.grn:hover{background:rgba(34,197,94,.08);}
    .hdr-est-btn.unshare{color:#ef4444;border-color:rgba(239,68,68,.25);}.hdr-est-btn.unshare:hover{background:rgba(239,68,68,.08);}
    .hdr-est-btn.del{color:#ef4444;border-color:rgba(239,68,68,.25);}.hdr-est-btn.del:hover{background:rgba(239,68,68,.08);}
    .hdr-est-btn.clone{color:#a78bfa;border-color:rgba(139,92,246,.3);}.hdr-est-btn.clone:hover{background:rgba(139,92,246,.08);}
    .hdr-est-btn.submit{color:#22c55e;border-color:rgba(34,197,94,.3);}.hdr-est-btn.submit:hover{border-color:#22c55e;background:rgba(34,197,94,.08);}
    .hdr-est-btn.publish{background:rgba(34,197,94,.1);color:#22c55e;border-color:rgba(34,197,94,.3);font-weight:600;}.hdr-est-btn.publish:hover{background:rgba(34,197,94,.2);border-color:#22c55e;}
    .view-tabs{display:flex;gap:0;padding:0 24px 0;background:var(--bg-secondary);}
    .view-tab{padding:7px 16px;border:none;border-bottom:2px solid transparent;background:none;color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s;text-transform:uppercase;letter-spacing:.8px;}
    .view-tab:hover{color:var(--text-primary);}
    .view-tab.active{color:var(--accent-primary);border-bottom-color:var(--accent-primary);}
    .view-tab .tab-badge{display:inline-block;background:rgba(255,255,255,.08);border-radius:10px;padding:1px 6px;font-size:10px;margin-left:4px;font-weight:700;}
    .view-tab.active .tab-badge{background:rgba(99,102,241,.15);color:var(--accent-primary);}
    .review-panel{display:none;padding:16px;}
    .review-panel.show{display:block;}
    .review-card{background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:border-color .2s;}
    .review-card:hover{border-color:var(--accent-primary);}
    .review-card.published{border-color:#22c55e;border-width:2px;}
    .review-vote{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:44px;}
    .vote-btn{width:32px;height:24px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .vote-btn:hover{border-color:var(--accent-primary);color:var(--accent-primary);}
    .vote-btn.voted-up{background:#22c55e;color:#fff;border-color:#22c55e;}
    .vote-btn.voted-down{background:#ef4444;color:#fff;border-color:#ef4444;}
    .vote-score{font-size:16px;font-weight:700;color:var(--text-primary);line-height:1;}
    .review-info{flex:1;min-width:0;}
    .review-name{font-size:14px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .review-meta{font-size:11px;color:var(--text-secondary);margin-top:2px;}
    .review-actions{display:flex;gap:6px;flex-shrink:0;}
    .status-badge{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border-radius:10px;}
    .status-draft{background:rgba(255,255,255,.08);color:var(--text-secondary);}
    .status-submitted{background:rgba(59,130,246,.15);color:#3b82f6;}
    .status-published{background:rgba(34,197,94,.15);color:#22c55e;}
    .official-banner{background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.02));border:1px solid rgba(34,197,94,.2);border-radius:10px;padding:14px 18px;margin-bottom:12px;}
    .official-banner-text{font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:2px;}
    .official-banner-sub{font-size:12px;color:var(--text-secondary);}
    .publish-log{margin-top:16px;border-top:1px solid var(--border-default);padding-top:12px;}
    .publish-log-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-secondary);margin-bottom:8px;}
    .publish-log-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:12px;}
    .publish-log-row:last-child{border-bottom:none;}
    .publish-log-dot{width:6px;height:6px;border-radius:50%;background:#22c55e;flex-shrink:0;}
    .publish-log-name{color:var(--text-primary);font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .publish-log-by{color:var(--text-secondary);}
    .publish-log-date{color:var(--text-secondary);flex-shrink:0;font-size:11px;}
    .readonly-overlay{pointer-events:none;opacity:.85;}
    .mob-est-bar{display:flex;align-items:center;gap:6px;padding:0 12px 6px;}
    .mob-est-sel{flex:1;padding:8px 10px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-primary);color:var(--text-primary);font-size:13px;font-weight:600;font-family:inherit;-webkit-appearance:none;cursor:pointer;}
    .mob-est-btn{padding:7px 10px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .15s;}
    .mob-est-btn.pri{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);font-weight:600;}
    .mob-est-btn.submit{color:#22c55e;border-color:rgba(34,197,94,.3);}
    .mob-est-btn.publish{background:rgba(34,197,94,.1);color:#22c55e;border-color:rgba(34,197,94,.3);font-weight:600;}
    .mob-est-btn.del{color:#ef4444;border-color:rgba(239,68,68,.25);}
    .ebar{background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid var(--border-default);}
    .ebar-row{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;align-items:end;}
    @media(max-width:640px){.ebar-row{grid-template-columns:1fr;}.review-card{flex-wrap:wrap;gap:8px;padding:10px;}.review-actions{width:100%;justify-content:flex-end;}}
    .fl{display:block;font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
    .fi{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:14px;font-family:inherit;-webkit-appearance:none;}.fi:focus{outline:none;border-color:var(--accent-primary);}
    .sbar{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px;}
    .scard{background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;padding:14px 16px;text-align:center;}
    .scard .slb{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:4px;}
    .scard .svl{font-size:22px;font-weight:800;font-variant-numeric:tabular-nums;}
    .scard.ex .svl{color:#ef4444;}.scard.rv .svl{color:#22c55e;}
    .scard.pf .svl.pos{color:#22c55e;}.scard.pf .svl.neg{color:#ef4444;}
    .scard.it .svl{color:var(--accent-light);}
    @media(max-width:640px){.sbar{grid-template-columns:repeat(2,1fr);}}
    .csec{background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;margin-bottom:6px;overflow:hidden;transition:transform .15s,box-shadow .15s,border-color .15s;}
    .csec.drag-over{border-color:var(--accent-primary);box-shadow:0 0 0 2px color-mix(in srgb,var(--accent-primary) 30%,transparent);}
    .csec.dragging{opacity:.5;transform:scale(.98);}
    .chdr{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;user-select:none;-webkit-user-select:none;transition:background .15s;}.chdr:hover{background:var(--bg-hover);}
    .cleft{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
    .cdrag{width:20px;height:20px;cursor:grab;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);opacity:.4;flex-shrink:0;font-size:14px;transition:opacity .15s;}.cdrag:hover{opacity:1;}.cdrag:active{cursor:grabbing;}
    .cdot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
    .cttl{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .ccnt{font-size:11px;color:var(--text-secondary);}
    .cright{display:flex;align-items:center;gap:10px;}
    .ctot{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums;}
    .cdel{width:24px;height:24px;border-radius:6px;border:none;background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .15s;}
    .chdr:hover .cdel{opacity:.6;}.cdel:hover{opacity:1!important;background:rgba(239,68,68,.15);color:#ef4444;}
    .cchv{font-size:11px;color:var(--text-secondary);transition:transform .2s;flex-shrink:0;}
    .csec.expanded .cchv{transform:rotate(180deg);}
    .cbody{max-height:0;overflow:hidden;transition:max-height .35s ease;}.csec.expanded .cbody{max-height:5000px;}
    .cinner{padding:0 16px 14px;}
    .lhdr{display:grid;grid-template-columns:1fr 80px 100px 100px 28px;gap:8px;padding:0 0 6px;border-bottom:2px solid var(--border-default);margin-bottom:2px;}
    .lhdr span{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);}
    .lhdr span:nth-child(3),.lhdr span:nth-child(4){text-align:right;}
    .lrow{display:grid;grid-template-columns:1fr 80px 100px 100px 28px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid var(--border-default);}.lrow:last-child{border-bottom:none;}
    .lname{background:transparent;border:none;color:var(--text-primary);font-size:13px;font-family:inherit;width:100%;outline:none;padding:4px 0;}.lname::placeholder{color:var(--text-secondary);opacity:.5;}
    .lrow input[type="number"]{width:100%;padding:6px 8px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-primary);color:var(--text-primary);font-size:13px;font-family:inherit;text-align:right;font-variant-numeric:tabular-nums;-moz-appearance:textfield;-webkit-appearance:none;}
    .lrow input[type="number"]:focus{outline:none;border-color:var(--accent-primary);}
    .ldue{width:100%;padding:5px 4px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-primary);color:var(--text-primary);font-size:11px;font-family:inherit;-webkit-appearance:none;cursor:pointer;}
    .ldue.pre{color:#f59e0b;}.ldue.day{color:#3b82f6;}.ldue.post{color:#a78bfa;}
    .lrm{width:24px;height:24px;border-radius:6px;border:none;background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;}.lrm:hover{background:rgba(239,68,68,.15);color:#ef4444;}
    .ladd{display:inline-block;padding:6px 0;font-size:12px;font-weight:600;color:var(--accent-light);background:transparent;border:none;cursor:pointer;font-family:inherit;margin-top:4px;}.ladd:hover{text-decoration:underline;}
    @media(max-width:640px){.lrow,.lhdr{grid-template-columns:1fr 60px 75px 75px 24px;}.ldue{font-size:10px;padding:4px 2px;}}
    .tbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;}
    .tlbl{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);}
    .tbtns{display:flex;gap:6px;}
    .tbtn{padding:6px 12px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;}.tbtn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .actbar{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border-default);}
    .abtn{padding:10px 18px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;}.abtn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .abtn.pri{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);}.abtn.pri:hover{opacity:.9;}
    @media(max-width:640px){.actbar{flex-wrap:wrap;}.abtn{flex:1;text-align:center;}}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center;}.modal-bg.show{display:flex;}
    .modal{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;padding:24px;width:90%;max-width:400px;}
    .modal h3{margin-bottom:16px;font-size:18px;}.modal .fi{margin-bottom:12px;}
    .modal-row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}
    .color-picks{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
    .cpick{width:28px;height:28px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:border-color .15s;}.cpick.sel{border-color:var(--text-primary);}
    @media print{.desktop-header,.mobile-top-header,.mobile-bottom-nav,.actbar,.ladd,.lrm,.tbtns,.cdrag,.cdel,.view-tabs,.review-panel,.official-banner,.readonly-overlay{display:none!important;}body{background:#fff;color:#000;padding:0;}.content{max-width:100%;padding:10px;}.scard,.csec,.ebar{border:1px solid #ddd;break-inside:avoid;}.cbody{max-height:none!important;overflow:visible!important;}}
  </style>
</head>
<body>
<!-- Mobile Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="togMob(this)"><span class="accordion-icon-header">&#9776;</span></button>
    <div class="mobile-header-center"><div class="mobile-header-title">Budget</div><div class="business-name" id="mobBiz">Loading...</div></div>
    <div class="mobile-header-right"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button></div>
  </div>
  <div class="mob-est-bar">
    <select class="mob-est-sel" id="mobEstSel" onchange="syncSel(this.value)"></select>
    <button class="mob-est-btn pri" onclick="createNew()">New</button>
    <button class="mob-est-btn" onclick="saveToDb()">Save</button>
    <button class="mob-est-btn submit" id="mobSubmitBtn" onclick="submitForReview()" style="display:none;">Submit</button>
    <button class="mob-est-btn publish" id="mobPublishBtn" onclick="publishEst()" style="display:none;">Publish</button>
    <button class="mob-est-btn del" id="mobDelBtn" onclick="deleteEst()" style="display:none;">Delete</button>
  </div>
  <div style="display:flex;gap:0;padding:0 12px 6px;border-bottom:1px solid var(--border-default);">
    <div class="view-tab active" onclick="setViewMode('editor')" style="flex:1;text-align:center;font-size:10px;padding:6px 4px;">My Budgets</div>
    <div class="view-tab" onclick="setViewMode('review')" style="flex:1;text-align:center;font-size:10px;padding:6px 4px;">Review <span class="tab-badge" id="mobReviewCount">0</span></div>
    <div class="view-tab" onclick="setViewMode('official')" style="flex:1;text-align:center;font-size:10px;padding:6px 4px;">Official</div>
  </div>
  <div class="mobile-header-content" id="mobMenu">
    <div class="mobile-header-actions">
      <button id="mobShareBtn" onclick="toggleShare()" style="display:none;">Share with Team</button>
      <button onclick="cloneEst()">Clone</button>
      <button onclick="location.href='eventlogicpro-settings.html'">Settings</button>
      <button onclick="doLogout()">Logout</button>
    </div>
  </div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:14px 24px 6px;display:flex;justify-content:space-between;align-items:center;">
    <div><h1 style="margin:0;font-size:28px;font-weight:600;">EventLogicPro</h1><div class="business-name" id="deskBiz">Loading...</div></div>
    <div style="display:flex;align-items:center;gap:16px;"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button><a onclick="doLogout()" style="color:var(--text-secondary);cursor:pointer;font-size:13px;">Logout</a></div>
  </div>
  <div style="padding:0 24px 10px;"><nav style="display:flex;gap:24px;"><a href="eventlogicpro-scheduler.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Calendar</a><a href="eventlogicpro.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Tasks</a><a href="eventlogicpro-estimator.html" style="padding:10px 0;color:var(--accent-primary);text-decoration:none;font-size:13px;border-bottom:2px solid var(--accent-primary);">Budget</a><a href="eventlogicpro-sponsors.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Sponsors</a><a href="eventlogicpro-sitemap.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Site Map</a></nav></div>
  <div class="hdr-est-bar">
    <select class="hdr-est-sel" id="deskEstSel" onchange="syncSel(this.value)"></select>
    <button class="hdr-est-btn pri" onclick="createNew()">New Budget</button>
    <button class="hdr-est-btn" onclick="saveToDb()">Save</button>
    <button class="hdr-est-btn" onclick="window.print()">Print</button>
    <button class="hdr-est-btn clone" onclick="cloneEst()">Clone</button>
    <button class="hdr-est-btn grn" id="deskShareBtn" onclick="toggleShare()" style="display:none;">Share</button>
    <button class="hdr-est-btn submit" id="deskSubmitBtn" onclick="submitForReview()" style="display:none;">Submit for Review</button>
    <button class="hdr-est-btn publish" id="deskPublishBtn" onclick="publishEst()" style="display:none;">Publish as Official</button>
    <button class="hdr-est-btn del" id="deskDelBtn" onclick="deleteEst()" style="display:none;">Delete</button>
  </div>
  <div class="view-tabs" style="border-bottom:1px solid var(--border-default);">
    <div class="view-tab active" onclick="setViewMode('editor')">My Budgets</div>
    <div class="view-tab" onclick="setViewMode('review')">Review Board <span class="tab-badge" id="deskReviewCount">0</span></div>
    <div class="view-tab" onclick="setViewMode('official')">Official</div>
  </div>
</div>

<div class="content">
  <!-- Review Board -->
  <div class="review-panel" id="reviewPanel">
    <div style="font-size:18px;font-weight:700;margin-bottom:4px;color:var(--text-primary);">Review Board</div>
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">Vote on submitted budget proposals. Admins can publish the winning version.</div>
    <div id="reviewCards"></div>
    <div id="reviewEmpty" style="text-align:center;padding:40px 20px;color:var(--text-secondary);font-size:13px;">No budgets submitted for review yet.<br>Create a budget and click "Submit for Review" to start.</div>
  </div>
  <!-- Official View -->
  <div id="officialView" style="display:none;">
    <div class="official-banner" id="officialBanner">
      <div class="official-banner-text">Official Budget</div>
      <div class="official-banner-sub" id="officialMeta">No official budget published yet</div>
    </div>
    <div class="publish-log" id="publishLogArea">
      <div class="publish-log-title">Publish History</div>
      <div id="publishLogRows"></div>
    </div>
  </div>
  <!-- Editor -->
  <div id="editorView">
  <div class="ebar"><div class="ebar-row">
    <div><label class="fl">Event Name</label><input type="text" class="fi" id="eName" placeholder="e.g., Summer Bash 2026" oninput="markDirty()"></div>
    <div><label class="fl">Event Date</label><input type="date" class="fi" id="eDate" oninput="markDirty()"></div>
    <div><label class="fl">Expected Attendance</label><input type="number" class="fi" id="eAtt" placeholder="200" oninput="markDirty()"></div>
  </div></div>
  <div class="sbar">
    <div class="scard ex"><div class="slb">Total Expenses</div><div class="svl" id="totExp">$0</div><div id="expBreak" style="font-size:10px;margin-top:6px;color:var(--text-secondary);line-height:1.6;"></div></div>
    <div class="scard rv"><div class="slb">Total Revenue</div><div class="svl" id="totRev">$0</div><div id="revBreak" style="font-size:10px;margin-top:6px;color:var(--text-secondary);line-height:1.6;"></div></div>
    <div class="scard pf"><div class="slb">Net Profit / Loss</div><div class="svl" id="totNet">$0</div></div>
    <div class="scard it"><div class="slb">Line Items</div><div class="svl" id="totLI">0</div></div>
  </div>
  <div class="tbar"><span class="tlbl">Expense Departments</span><div class="tbtns"><button class="tbtn" onclick="openAddCat('expense')">+ Add Dept</button><button class="tbtn" onclick="togAll()" id="togBtn">Expand All</button><button class="tbtn" onclick="window.print()">Print</button></div></div>
  <div id="expBox"></div>
  <div class="tbar" style="margin-top:20px;"><span class="tlbl" style="color:#22c55e;">Revenue Sources</span><div class="tbtns"><button class="tbtn" onclick="openAddCat('revenue')">+ Add Source</button></div></div>
  <div id="revBox"></div>
  <div class="actbar">
    <button class="abtn" onclick="resetValues()">Reset Values</button>
    <button class="abtn" onclick="exportCSV()">Export CSV</button>
    <button class="abtn pri" onclick="saveToDb()">Save Estimate</button>
  </div>
  </div><!-- close editorView -->
</div>

<div class="modal-bg" id="addModal"><div class="modal">
  <h3 id="addModalTitle">Add Department</h3>
  <label class="fl">Name</label><input type="text" class="fi" id="newCatName" placeholder="Department name">
  <label class="fl">Color</label><div class="color-picks" id="colorPicks"></div>
  <div class="modal-row"><button class="abtn" onclick="closeModal()">Cancel</button><button class="abtn pri" onclick="confirmAddCat()">Add</button></div>
</div></div>

<div id="themeToast" class="theme-toast"></div>
<div class="mobile-bottom-nav"><div class="mobile-nav-top"><a href="eventlogicpro-scheduler.html" class="mobile-nav-btn">Calendar</a><a href="eventlogicpro.html" class="mobile-nav-btn">Tasks</a><a href="eventlogicpro-estimator.html" class="mobile-nav-btn active">Budget</a><a href="eventlogicpro-sponsors.html" class="mobile-nav-btn">Sponsors</a><a href="eventlogicpro-sitemap.html" class="mobile-nav-btn">Site Map</a></div></div>

<script>
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);
var tenantId=null,userId=null,dirty=false;
var allEstimates=[],currentEstId=null;
var userRole='manager',viewMode='editor';

var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal','cyber','amber','honey','crimson','coral','rose','sand'];
var ti=themes.indexOf(localStorage.getItem('app-theme')||'dark-blue');if(ti<0)ti=0;
function cycleTheme(){ti=(ti+1)%themes.length;var t=themes[ti];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);toast('Theme: '+t.replace(/-/g,' '));}
function toast(m){var t=document.getElementById('themeToast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2500);}
function togMob(b){document.getElementById('mobMenu').classList.toggle('expanded');b.classList.toggle('active');}
async function doLogout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}
async function checkAuth(){var r=await sb.auth.getSession();var s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){window.location.href='login.html';return null;}}return s;}

// ============================================================
// VOTING & PUBLISH SYSTEM
// ============================================================
async function detectRole(){try{var r=await sb.from('event_members').select('role_level').eq('tenant_id',tenantId).eq('email',(await sb.auth.getSession()).data.session.user.email).single();if(r.data)userRole=r.data.role_level||'manager';}catch(e){}}

function setViewMode(mode){viewMode=mode;
document.querySelectorAll('.view-tab').forEach(function(t){t.classList.remove('active');
var txt=t.textContent.toLowerCase();
if((mode==='editor'&&txt.indexOf('my')>=0)||(mode==='review'&&txt.indexOf('review')>=0)||(mode==='official'&&txt.indexOf('official')>=0))t.classList.add('active');});
document.getElementById('reviewPanel').classList.toggle('show',mode==='review');
document.getElementById('officialView').style.display=mode==='official'?'':'none';
if(mode==='editor'){document.getElementById('editorView').style.display='';exitReadOnly();}
else if(mode==='official'){loadOfficialEst();}
else{document.getElementById('editorView').style.display='none';}
if(mode==='review')renderReviewBoard();
updateActionButtons();}

function updateActionButtons(){
var est=currentEstId&&currentEstId!=='preloaded'?allEstimates.find(function(e){return e.estimate_id===currentEstId;}):null;
var isMine=est&&est.created_by===userId;
var isAdmin=userRole==='admin';
var status=est?est.status||'draft':'draft';
document.getElementById('deskDelBtn').style.display=isMine?'':'none';
document.getElementById('mobDelBtn').style.display=isMine?'':'none';
var dsb=document.getElementById('deskShareBtn');dsb.style.display=isMine?'':'none';if(est)dsb.textContent=est.is_shared?'Unshare':'Share';dsb.className='hdr-est-btn '+(est&&est.is_shared?'unshare':'grn');
document.getElementById('mobShareBtn').style.display=isMine?'':'none';if(est)document.getElementById('mobShareBtn').textContent=est.is_shared?'Unshare':'Share with Team';
var canSubmit=isMine&&status==='draft';
document.getElementById('deskSubmitBtn').style.display=canSubmit?'':'none';
document.getElementById('mobSubmitBtn').style.display=canSubmit?'':'none';
var canPublish=isAdmin&&est;
document.getElementById('deskPublishBtn').style.display=canPublish?'':'none';
document.getElementById('mobPublishBtn').style.display=canPublish?'':'none';}

async function submitForReview(){if(!currentEstId||currentEstId==='preloaded')return;
await saveToDb(true);
var uName=(await sb.auth.getSession()).data.session.user.email||'Unknown';
var r=await sb.from('event_estimates').update({status:'submitted',submitted_at:new Date().toISOString(),submitted_by_name:uName}).eq('estimate_id',currentEstId);
if(r.error){toast('Error submitting');return;}
var est=allEstimates.find(function(e){return e.estimate_id===currentEstId;});if(est){est.status='submitted';est.submitted_by_name=uName;}
toast('Submitted for review!');updateActionButtons();updateReviewCounts();}

async function publishEst(estId){
var id=estId||currentEstId;if(!id||id==='preloaded')return;
if(!confirm('Publish this budget as the Official Budget? This will replace any existing official version.'))return;
await sb.from('event_estimates').update({status:'draft'}).eq('tenant_id',tenantId).eq('status','published');
var uName=(await sb.auth.getSession()).data.session.user.email||'Unknown';
var now=new Date().toISOString();
var est=allEstimates.find(function(e){return e.estimate_id===id;});
var estName=est?est.event_name:'Untitled';
var r=await sb.from('event_estimates').update({status:'published',published_by:userId,published_at:now,submitted_by_name:uName}).eq('estimate_id',id);
if(r.error){toast('Error publishing');return;}
await sb.from('publish_history').insert({tenant_id:tenantId,sheet_id:id,sheet_name:estName,published_by:userId,published_by_name:uName,published_at:now,page_type:'budget'});
await loadEstimates();updateActionButtons();updateReviewCounts();
toast('Published as Official Budget!');
if(viewMode==='review')renderReviewBoard();}

async function unpublishEst(estId){
if(!confirm('Unpublish this budget?'))return;
await sb.from('event_estimates').update({status:'submitted'}).eq('estimate_id',estId);
await loadEstimates();updateActionButtons();updateReviewCounts();toast('Unpublished');if(viewMode==='review')renderReviewBoard();}

async function voteOnEst(estId,vote){
var existing=await sb.from('estimate_votes').select('*').eq('estimate_id',estId).eq('user_id',userId).single();
if(existing.data){
if(existing.data.vote===vote){await sb.from('estimate_votes').delete().eq('vote_id',existing.data.vote_id);}
else{await sb.from('estimate_votes').update({vote:vote}).eq('vote_id',existing.data.vote_id);}
}else{await sb.from('estimate_votes').insert({estimate_id:estId,tenant_id:tenantId,user_id:userId,vote:vote});}
renderReviewBoard();}

async function renderReviewBoard(){
var submitted=allEstimates.filter(function(e){return e.status==='submitted'||e.status==='published';});
var area=document.getElementById('reviewCards');var empty=document.getElementById('reviewEmpty');
if(!submitted.length){area.innerHTML='';empty.style.display='';updateReviewCounts();return;}
empty.style.display='none';
var ids=submitted.map(function(e){return e.estimate_id;});
var vr=await sb.from('estimate_votes').select('*').in('estimate_id',ids);
var votes=vr.data||[];
var myVotes={};votes.forEach(function(v){if(v.user_id===userId)myVotes[v.estimate_id]=v.vote;});
var scores={};ids.forEach(function(id){scores[id]=0;});
votes.forEach(function(v){scores[v.estimate_id]=(scores[v.estimate_id]||0)+v.vote;});
submitted.sort(function(a,b){if(a.status==='published'&&b.status!=='published')return -1;if(b.status==='published'&&a.status!=='published')return 1;var sa=scores[a.estimate_id]||0,sb2=scores[b.estimate_id]||0;if(sb2!==sa)return sb2-sa;return new Date(b.submitted_at||0)-new Date(a.submitted_at||0);});
var isAdmin=userRole==='admin';
var h='';submitted.forEach(function(e){
var score=scores[e.estimate_id]||0;var myVote=myVotes[e.estimate_id]||0;
var isPub=e.status==='published';
var when=e.submitted_at?new Date(e.submitted_at).toLocaleDateString():'';
h+='<div class="review-card'+(isPub?' published':'')+'">';
h+='<div class="review-vote">';
h+='<button class="vote-btn'+(myVote===1?' voted-up':'')+'" onclick="voteOnEst(\''+e.estimate_id+'\',1)">&#9650;</button>';
h+='<div class="vote-score"'+(score>0?' style="color:#22c55e"':score<0?' style="color:#ef4444"':'')+'>'+score+'</div>';
h+='<button class="vote-btn'+(myVote===-1?' voted-down':'')+'" onclick="voteOnEst(\''+e.estimate_id+'\',-1)">&#9660;</button>';
h+='</div>';
h+='<div class="review-info"><div class="review-name">'+esc(e.event_name||'Untitled')+' <span class="status-badge status-'+(e.status||'draft')+'">'+(isPub?'OFFICIAL':e.status||'draft')+'</span></div>';
h+='<div class="review-meta">by '+esc(e.submitted_by_name||'Unknown')+' &middot; '+when+'</div></div>';
h+='<div class="review-actions">';
h+='<button class="hdr-est-btn" onclick="syncSel(\''+e.estimate_id+'\');setViewMode(\'editor\')" style="font-size:11px;padding:5px 10px;">View</button>';
if(isAdmin&&!isPub)h+='<button class="hdr-est-btn publish" onclick="publishEst(\''+e.estimate_id+'\')" style="font-size:11px;padding:5px 10px;">Publish</button>';
if(isAdmin&&isPub)h+='<button class="hdr-est-btn del" onclick="unpublishEst(\''+e.estimate_id+'\')" style="font-size:11px;padding:5px 10px;">Unpublish</button>';
h+='</div></div>';});
area.innerHTML=h;updateReviewCounts();}

function updateReviewCounts(){
var count=allEstimates.filter(function(e){return e.status==='submitted';}).length;
var el1=document.getElementById('deskReviewCount');var el2=document.getElementById('mobReviewCount');
if(el1)el1.textContent=count;if(el2)el2.textContent=count;}

async function loadOfficialEst(){
var pub=allEstimates.find(function(e){return e.status==='published';});
var editor=document.getElementById('editorView');
renderPublishLog();
if(!pub){document.getElementById('officialMeta').textContent='No official budget published yet. Submit your budget for review!';
editor.style.display='none';return;}
syncSel(pub.estimate_id);
var when=pub.published_at?new Date(pub.published_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
document.getElementById('officialMeta').textContent='Published by '+(pub.submitted_by_name||'Admin')+' on '+when;
editor.style.display='';editor.classList.add('readonly-overlay');
setTimeout(function(){editor.querySelectorAll('input,select,button,textarea').forEach(function(el){el.disabled=true;});},100);}

async function renderPublishLog(){
var area=document.getElementById('publishLogRows');
var r=await sb.from('publish_history').select('*').eq('tenant_id',tenantId).eq('page_type','budget').order('published_at',{ascending:false}).limit(20);
var rows=r.data||[];
if(!rows.length){area.innerHTML='<div style="font-size:12px;color:var(--text-secondary);padding:8px 0;">No publish history yet.</div>';return;}
var h='';rows.forEach(function(row){
var d=new Date(row.published_at);
var dateStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
var timeStr=d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
h+='<div class="publish-log-row">';
h+='<div class="publish-log-dot"></div>';
h+='<div class="publish-log-name">'+esc(row.sheet_name||'Untitled')+'</div>';
h+='<div class="publish-log-by">'+esc(row.published_by_name||'Unknown')+'</div>';
h+='<div class="publish-log-date">'+dateStr+' '+timeStr+'</div>';
h+='</div>';});
area.innerHTML=h;}

function exitReadOnly(){
document.getElementById('editorView').classList.remove('readonly-overlay');
document.getElementById('editorView').querySelectorAll('input,select,button,textarea').forEach(function(el){el.disabled=false;});}

// ============================================================

var COLORS=['#3b82f6','#f97316','#8b5cf6','#ec4899','#14b8a6','#6366f1','#ef4444','#0ea5e9','#a78bfa','#f472b6','#fbbf24','#22c55e','#fb923c','#dc2626','#06b6d4','#84cc16','#e879f9','#f43f5e','#10b981','#64748b'];
var DEF_EXP=[{id:'venue',color:'#3b82f6',title:'Venue',items:['Locate potential venues / get rental details','Construct proposal with budget','Secure venue','Site plan for event considering all depts','Power upgrades']},{id:'food',color:'#f97316',title:'Food',items:['Multi-level menu creation','Sponsor menu','Food shopping','Food service area setup','Rental equipment for food service']},{id:'bar',color:'#8b5cf6',title:'Bar',items:['Inventory & restock order','Specials drink menu','Sponsor drink special','Hire bartenders / bar backs','Ice machine / coolers','Outside bar setup']},{id:'entertainment',color:'#ec4899',title:'Entertainment Booking',items:['Headliner booking','Band support','Band opener','Go-Go dancers / performers','Deposits & payments','Backstage area setup','Sound/stage requirements']},{id:'rentals',color:'#14b8a6',title:'Rentals',items:['Department rental needs collection','Porta potties & sinks','Shuttle vans','Tables / chairs / tents','Delivery & pickup scheduling']},{id:'stage_sound',color:'#6366f1',title:'Stage / Lights / Sound',items:['Indoor equipment test & setup','Outdoor equipment test & setup','XLR cables count & test','Speaker repair/replace','Dance platform setup','Lighting setup (indoor/outdoor/cage)','Live sound operation']},{id:'security',color:'#ef4444',title:'Security',items:['Pay gate setup','Lower gate post','Guard schedules (pay gate & lower gate)','Shuttle driver schedules','Radios (inspect/test/charge)','Security post manning','Personnel pay']},{id:'parking',color:'#0ea5e9',title:'Parking',items:['Secure Parking Lot A','Secure Parking Lot B','Secure Parking Lot C (overflow)','Security coordination per lot','Signage creation','Post locations to socials & web']},{id:'permits',color:'#a78bfa',title:'Permits & Licenses',items:['Identify permits & licenses needed','Application fees','Permit processing']},{id:'media',color:'#f472b6',title:'Media & Print',items:['Handbill flyer design & print','Poster AD 11x17','Event ticket design & print','Shirt design (front & back)','Poster for sale at event','Website ads','Mobile ads']},{id:'merch',color:'#fbbf24',title:'Merchandise',items:['Merch budget establishment','Event shirt order','Merch booth items (shirts, hats, etc.)','Poker chips','Sponsor shirt bagging','Thank you notes with event art','Merch booth setup']},{id:'sponsors',color:'#22c55e',title:'Sponsors',items:['Sponsor donation collection','VIP sponsor experience package','Banner locations & posting','Sponsor certificates','Thank you notes & invoices']},{id:'vendors',color:'#fb923c',title:'Vendors',items:['Vendor power mapping','Web booking slot setup','Vendor site map creation','Powered/non-powered zone pricing','Vendor location verification']},{id:'medical',color:'#dc2626',title:'Medical',items:['Medical supply inventory','Supply restock','Emergency medical location/tent','Medical water cooler']},{id:'socials',color:'#06b6d4',title:'Social Media',items:['Social media countdown campaign','Media asset meetings','Campaign ad creation','Post scheduling']},{id:'website',color:'#84cc16',title:'Website',items:['Event page creation/updates','Ticket integration','Site map hosting','Event info updates']}];
var DEF_REV=[{id:'rev_tickets',color:'#22c55e',title:'Ticket Sales',items:['General admission','VIP tickets','Early bird tickets']},{id:'rev_sponsors',color:'#16a34a',title:'Sponsor Revenue',items:['Platinum sponsors','Gold sponsors','Silver sponsors','Media sponsors']},{id:'rev_vendors',color:'#059669',title:'Vendor Fees',items:['Powered booth fees','Non-powered booth fees']},{id:'rev_bar',color:'#10b981',title:'Bar Revenue',items:['Drink sales estimate']},{id:'rev_merch',color:'#34d399',title:'Merch Sales',items:['Shirt sales','Hat sales','Other merch']}];

var expCats=[],revCats=[];
var expandedSet=new Set(),allExpanded=false;
var addingType='expense',selColor=COLORS[0];
var dragSrcIdx=null,dragType=null;

function makeDefaults(){return{exp:DEF_EXP.map(function(c){return{id:c.id,color:c.color,title:c.title,items:c.items.map(function(n){return{name:n,est:0,act:0,due:'pre'};})}}),rev:DEF_REV.map(function(c){return{id:c.id,color:c.color,title:c.title,items:c.items.map(function(n){return{name:n,est:0,act:0,due:'day'};})}})};}

function buildOptions(){var mine=allEstimates.filter(function(e){return e.created_by===userId;});var shared=allEstimates.filter(function(e){return e.is_shared&&e.created_by!==userId;});var h='<option value="">-- Select Budget --</option>';if(currentEstId==='preloaded'&&!allEstimates.find(function(e){return e.estimate_id==='preloaded';})){h+='<option value="preloaded" selected>'+esc(document.getElementById('eName').value||'Redding Rock')+' (preloaded)</option>';}if(mine.length){h+='<optgroup label="My Budgets">';mine.forEach(function(e){var st=e.status||'draft';var badge=st==='published'?' \u2605 OFFICIAL':st==='submitted'?' [submitted]':'';var tag=e.is_shared?' [SHARED]':'';h+='<option value="'+e.estimate_id+'"'+(e.estimate_id===currentEstId?' selected':'')+'>'+esc(e.event_name||'Untitled')+badge+tag+'</option>';});h+='</optgroup>';}if(shared.length){h+='<optgroup label="Team Shared">';shared.forEach(function(e){var st=e.status||'draft';var badge=st==='published'?' \u2605 OFFICIAL':st==='submitted'?' [submitted]':'';h+='<option value="'+e.estimate_id+'"'+(e.estimate_id===currentEstId?' selected':'')+'>'+esc(e.event_name||'Untitled')+badge+' [TEAM]</option>';});h+='</optgroup>';}return h;}
function renderSelects(){var h=buildOptions();document.getElementById('deskEstSel').innerHTML=h;document.getElementById('mobEstSel').innerHTML=h;}
function syncSel(id){if(!id){currentEstId=null;clearForm();return;}document.getElementById('deskEstSel').value=id;document.getElementById('mobEstSel').value=id;if(id==='preloaded'){loadPreloaded();return;}currentEstId=id;localStorage.setItem('elp-last-est',id);loadEstimateData(id);}

async function loadEstimateData(id){var est=allEstimates.find(function(e){return e.estimate_id===id;});if(!est)return;document.getElementById('eName').value=est.event_name||'';document.getElementById('eDate').value=est.event_date||'';document.getElementById('eAtt').value=est.expected_attendance||'';var cr=await sb.from('estimate_categories').select('*').eq('estimate_id',id).order('sort_order');var cats=cr.data||[];var lr=await sb.from('estimate_line_items').select('*').eq('estimate_id',id).order('sort_order');var lines=lr.data||[];if(cats.length){expCats=[];revCats=[];cats.forEach(function(c){var cl=lines.filter(function(l){return l.category_key===c.category_key;});var obj={id:c.category_key,color:c.color,title:c.title,items:cl.map(function(l){return{name:l.item_name,est:parseFloat(l.estimated_cost)||0,act:parseFloat(l.actual_cost)||0,due:l.due_timing||'pre'};})};if(!obj.items.length)obj.items=[{name:'',est:0,act:0}];if(c.category_type==='revenue')revCats.push(obj);else expCats.push(obj);});}else{var d=makeDefaults();expCats=d.exp;revCats=d.rev;}updateActionButtons();render();}

function clearForm(){document.getElementById('eName').value='';document.getElementById('eDate').value='';document.getElementById('eAtt').value='';var d=makeDefaults();expCats=d.exp;revCats=d.rev;updateActionButtons();render();}
async function createNew(){if(!tenantId){toast('Not authenticated');return;}var name=prompt('Budget name (e.g., Summer Bash 2026):');if(!name||!name.trim())return;var d=makeDefaults();var ins=await sb.from('event_estimates').insert({tenant_id:tenantId,created_by:userId,event_name:name.trim(),is_shared:false,status:'draft'}).select().single();if(ins.error){toast('Error: '+ins.error.message);return;}var estId=ins.data.estimate_id;var catRows=[],lineRows=[],lo=0;d.exp.forEach(function(c,i){catRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'expense',title:c.title,color:c.color,sort_order:i});c.items.forEach(function(it){lineRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'expense',item_name:it.name,estimated_cost:0,actual_cost:0,due_timing:it.due||'pre',sort_order:lo++});});});d.rev.forEach(function(c,i){catRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'revenue',title:c.title,color:c.color,sort_order:i+100});c.items.forEach(function(it){lineRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'revenue',item_name:it.name,estimated_cost:0,actual_cost:0,due_timing:it.due||'pre',sort_order:lo++});});});await sb.from('estimate_categories').insert(catRows);if(lineRows.length)await sb.from('estimate_line_items').insert(lineRows);currentEstId=estId;localStorage.setItem('elp-last-est',estId);await loadEstimates();syncSel(estId);toast('"'+name.trim()+'" created');}
async function deleteEst(){if(!currentEstId)return;var est=allEstimates.find(function(e){return e.estimate_id===currentEstId;});if(!est||est.created_by!==userId){toast('Cannot delete');return;}if(!confirm('Delete "'+est.event_name+'"? This cannot be undone.'))return;await sb.from('event_estimates').delete().eq('estimate_id',currentEstId);currentEstId=null;localStorage.removeItem('elp-last-est');await loadEstimates();clearForm();toast('Estimate deleted');}
async function toggleShare(){if(!currentEstId)return;var est=allEstimates.find(function(e){return e.estimate_id===currentEstId;});if(!est||est.created_by!==userId)return;var nv=!est.is_shared;await sb.from('event_estimates').update({is_shared:nv}).eq('estimate_id',currentEstId);est.is_shared=nv;renderSelects();updateActionButtons();toast(nv?'Shared with team':'Made private');}
async function loadEstimates(){var r=await sb.from('event_estimates').select('*').eq('tenant_id',tenantId).order('updated_at',{ascending:false});allEstimates=r.data||[];renderSelects();updateReviewCounts();}

function render(){document.getElementById('expBox').innerHTML=expCats.map(function(c,i){return renderCat(c,i,'expense');}).join('');document.getElementById('revBox').innerHTML=revCats.map(function(c,i){return renderCat(c,i,'revenue');}).join('');expandedSet.forEach(function(id){var e=document.getElementById('sec-'+id);if(e)e.classList.add('expanded');});if(allExpanded)document.querySelectorAll('.csec').forEach(function(e){e.classList.add('expanded');});calcTotals();attachDragHandles();}

function renderCat(c,idx,type){var items=c.items||[];var tot=items.reduce(function(s,i){return s+(parseFloat(i.est)||0);},0);var filled=items.filter(function(i){return(parseFloat(i.est)||0)>0;}).length;var h='<div class="csec" id="sec-'+c.id+'" data-idx="'+idx+'" data-type="'+type+'">';h+='<div class="chdr"><div class="cleft">';h+='<div class="cdrag" draggable="true" title="Drag to reorder">&#9783;</div>';h+='<div class="cdot" style="background:'+c.color+';"></div>';h+='<div style="min-width:0;"><div class="cttl">'+esc(c.title)+'</div>';h+='<div class="ccnt">'+filled+' of '+items.length+' items budgeted</div></div></div>';h+='<div class="cright"><div class="ctot" style="color:'+c.color+';">$'+fmt(tot)+'</div>';h+='<button class="cdel" onclick="event.stopPropagation();deleteCat(\''+type+'\','+idx+')" title="Delete">&times;</button>';h+='<span class="cchv" onclick="toggleSec(\''+c.id+'\')">&#9660;</span></div></div>';h+='<div class="cbody"><div class="cinner">';h+='<div class="lhdr"><span>Item</span><span>Due</span><span>Estimated</span><span>Actual</span><span></span></div>';items.forEach(function(item,li){var dv=item.due||'pre';var dc=dv==='pre'?'pre':dv==='day'?'day':'post';h+='<div class="lrow">';h+='<input type="text" class="lname" value="'+esc(item.name)+'" onchange="updName(\''+type+'\','+idx+','+li+',this.value)" placeholder="Line item name">';h+='<select class="ldue '+dc+'" onchange="updDue(\''+type+'\','+idx+','+li+',this.value,this)"><option value="pre"'+(dv==='pre'?' selected':'')+'>Pre</option><option value="day"'+(dv==='day'?' selected':'')+'>Day Of</option><option value="post"'+(dv==='post'?' selected':'')+'>Post</option></select>';h+='<input type="number" value="'+(item.est||'')+'" placeholder="0.00" step="0.01" oninput="updVal(\''+type+'\','+idx+','+li+',\'est\',this.value)">';h+='<input type="number" value="'+(item.act||'')+'" placeholder="0.00" step="0.01" oninput="updVal(\''+type+'\','+idx+','+li+',\'act\',this.value)">';h+='<button class="lrm" onclick="rmItem(\''+type+'\','+idx+','+li+')" title="Remove">&times;</button></div>';});h+='<button class="ladd" onclick="addItem(\''+type+'\','+idx+')">+ Add line item</button>';h+='</div></div></div>';return h;}

function attachDragHandles(){document.querySelectorAll('.cdrag').forEach(function(handle){var sec=handle.closest('.csec');handle.addEventListener('dragstart',function(e){dragSrcIdx=parseInt(sec.dataset.idx);dragType=sec.dataset.type;sec.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',dragSrcIdx);});handle.addEventListener('dragend',function(){sec.classList.remove('dragging');document.querySelectorAll('.csec').forEach(function(s){s.classList.remove('drag-over');});dragSrcIdx=null;dragType=null;});sec.addEventListener('dragover',function(e){if(dragType!==sec.dataset.type)return;e.preventDefault();e.dataTransfer.dropEffect='move';sec.classList.add('drag-over');});sec.addEventListener('dragleave',function(){sec.classList.remove('drag-over');});sec.addEventListener('drop',function(e){e.preventDefault();sec.classList.remove('drag-over');if(dragType!==sec.dataset.type)return;var toIdx=parseInt(sec.dataset.idx);if(dragSrcIdx===null||dragSrcIdx===toIdx)return;var arr=dragType==='expense'?expCats:revCats;var moved=arr.splice(dragSrcIdx,1)[0];arr.splice(toIdx,0,moved);render();markDirty();});});}

function toggleSec(id){var el=document.getElementById('sec-'+id);if(!el)return;el.classList.toggle('expanded');if(el.classList.contains('expanded'))expandedSet.add(id);else expandedSet.delete(id);}
document.addEventListener('click',function(e){var hdr=e.target.closest('.chdr');if(!hdr)return;if(e.target.closest('.cdrag')||e.target.closest('.cdel')||e.target.closest('.cchv'))return;var sec=hdr.closest('.csec');if(sec)toggleSec(sec.id.replace('sec-',''));});
function togAll(){allExpanded=!allExpanded;document.querySelectorAll('.csec').forEach(function(s){var id=s.id.replace('sec-','');if(allExpanded){s.classList.add('expanded');expandedSet.add(id);}else{s.classList.remove('expanded');expandedSet.delete(id);}});document.getElementById('togBtn').textContent=allExpanded?'Collapse All':'Expand All';}

function updVal(type,ci,li,field,val){var arr=type==='expense'?expCats:revCats;if(arr[ci]&&arr[ci].items[li]){arr[ci].items[li][field]=parseFloat(val)||0;calcTotals();updateCatDisplay(type,ci);markDirty();}}
function updName(type,ci,li,val){var arr=type==='expense'?expCats:revCats;if(arr[ci]&&arr[ci].items[li]){arr[ci].items[li].name=val;markDirty();}}
function updDue(type,ci,li,val,sel){var arr=type==='expense'?expCats:revCats;if(arr[ci]&&arr[ci].items[li]){arr[ci].items[li].due=val;sel.className='ldue '+(val==='pre'?'pre':val==='day'?'day':'post');calcTotals();markDirty();}}
function addItem(type,ci){var arr=type==='expense'?expCats:revCats;if(!arr[ci])return;arr[ci].items.push({name:'',est:0,act:0,due:'pre'});expandedSet.add(arr[ci].id);render();var sec=document.getElementById('sec-'+arr[ci].id);if(sec){sec.classList.add('expanded');var inputs=sec.querySelectorAll('.lname');if(inputs.length)inputs[inputs.length-1].focus();}markDirty();}
function rmItem(type,ci,li){var arr=type==='expense'?expCats:revCats;if(arr[ci])arr[ci].items.splice(li,1);render();markDirty();}
function deleteCat(type,ci){var arr=type==='expense'?expCats:revCats;var name=arr[ci]?arr[ci].title:'';if(!confirm('Delete "'+name+'" and all its line items?'))return;arr.splice(ci,1);render();markDirty();}
function updateCatDisplay(type,ci){var arr=type==='expense'?expCats:revCats;var c=arr[ci];if(!c)return;var sec=document.getElementById('sec-'+c.id);if(!sec)return;var tot=c.items.reduce(function(s,i){return s+(parseFloat(i.est)||0);},0);var filled=c.items.filter(function(i){return(parseFloat(i.est)||0)>0;}).length;var te=sec.querySelector('.ctot');if(te)te.textContent='$'+fmt(tot);var ce=sec.querySelector('.ccnt');if(ce)ce.textContent=filled+' of '+c.items.length+' items budgeted';}
function calcTotals(){var exp=0,rev=0,cnt=0;var ePre=0,eDay=0,ePost=0,rPre=0,rDay=0,rPost=0;expCats.forEach(function(c){c.items.forEach(function(i){var v=parseFloat(i.est)||0;exp+=v;cnt++;var d=i.due||'pre';if(d==='pre')ePre+=v;else if(d==='day')eDay+=v;else ePost+=v;});});revCats.forEach(function(c){c.items.forEach(function(i){var v=parseFloat(i.est)||0;rev+=v;cnt++;var d=i.due||'pre';if(d==='pre')rPre+=v;else if(d==='day')rDay+=v;else rPost+=v;});});var net=rev-exp;document.getElementById('totExp').textContent='$'+fmt(exp);document.getElementById('totRev').textContent='$'+fmt(rev);document.getElementById('expBreak').innerHTML='<span style="color:#f59e0b">Pre $'+fmt(ePre)+'</span> &middot; <span style="color:#3b82f6">Day $'+fmt(eDay)+'</span> &middot; <span style="color:#a78bfa">Post $'+fmt(ePost)+'</span>';document.getElementById('revBreak').innerHTML='<span style="color:#f59e0b">Pre $'+fmt(rPre)+'</span> &middot; <span style="color:#3b82f6">Day $'+fmt(rDay)+'</span> &middot; <span style="color:#a78bfa">Post $'+fmt(rPost)+'</span>';var ne=document.getElementById('totNet');ne.textContent=(net>=0?'+$':'-$')+fmt(Math.abs(net));ne.className='svl '+(net>=0?'pos':'neg');document.getElementById('totLI').textContent=cnt;}

function openAddCat(type){addingType=type;selColor=COLORS[0];document.getElementById('addModalTitle').textContent=type==='expense'?'Add Department':'Add Revenue Source';document.getElementById('newCatName').value='';var cp=document.getElementById('colorPicks');cp.innerHTML='';COLORS.forEach(function(c){var d=document.createElement('div');d.className='cpick'+(c===selColor?' sel':'');d.style.background=c;d.onclick=function(){selColor=c;cp.querySelectorAll('.cpick').forEach(function(p){p.classList.remove('sel');});d.classList.add('sel');};cp.appendChild(d);});document.getElementById('addModal').classList.add('show');setTimeout(function(){document.getElementById('newCatName').focus();},100);}
function closeModal(){document.getElementById('addModal').classList.remove('show');}
function confirmAddCat(){var name=document.getElementById('newCatName').value.trim();if(!name){toast('Enter a name');return;}var id=name.toLowerCase().replace(/[^a-z0-9]+/g,'_')+'_'+Date.now();var cat={id:id,color:selColor,title:name,items:[{name:'',est:0,act:0,due:'pre'}]};if(addingType==='expense')expCats.push(cat);else revCats.push(cat);closeModal();expandedSet.add(id);render();markDirty();toast('"'+name+'" added');}

function markDirty(){dirty=true;}

async function saveToDb(silent){if(!tenantId){if(!silent)toast('Not authenticated');return;}if(!currentEstId){if(!silent)toast('Select or create a budget first');return;}var exp=0,rev=0;expCats.forEach(function(c){c.items.forEach(function(i){exp+=(parseFloat(i.est)||0);});});revCats.forEach(function(c){c.items.forEach(function(i){rev+=(parseFloat(i.est)||0);});});var eName=document.getElementById('eName').value||'Untitled';if(currentEstId==='preloaded'){var ins=await sb.from('event_estimates').insert({tenant_id:tenantId,created_by:userId,event_name:eName,event_date:document.getElementById('eDate').value||null,expected_attendance:parseInt(document.getElementById('eAtt').value)||0,total_expenses:exp,total_revenue:rev,net_profit:rev-exp,is_shared:false,status:'draft'}).select().single();if(ins.error){if(!silent)toast('Error: '+ins.error.message);return;}currentEstId=ins.data.estimate_id;localStorage.setItem('elp-last-est',currentEstId);}else{await sb.from('event_estimates').update({event_name:eName,event_date:document.getElementById('eDate').value||null,expected_attendance:parseInt(document.getElementById('eAtt').value)||0,total_expenses:exp,total_revenue:rev,net_profit:rev-exp}).eq('estimate_id',currentEstId);}await sb.from('estimate_categories').delete().eq('estimate_id',currentEstId);var catRows=[];expCats.forEach(function(c,i){catRows.push({estimate_id:currentEstId,tenant_id:tenantId,category_key:c.id,category_type:'expense',title:c.title,color:c.color,sort_order:i});});revCats.forEach(function(c,i){catRows.push({estimate_id:currentEstId,tenant_id:tenantId,category_key:c.id,category_type:'revenue',title:c.title,color:c.color,sort_order:i+100});});if(catRows.length)await sb.from('estimate_categories').insert(catRows);await sb.from('estimate_line_items').delete().eq('estimate_id',currentEstId);var lineRows=[],ord=0;expCats.forEach(function(c){c.items.forEach(function(it){lineRows.push({estimate_id:currentEstId,tenant_id:tenantId,category_key:c.id,category_type:'expense',item_name:it.name||'(unnamed)',estimated_cost:parseFloat(it.est)||0,actual_cost:parseFloat(it.act)||0,sort_order:ord++,due_timing:it.due||'pre'});});});revCats.forEach(function(c){c.items.forEach(function(it){lineRows.push({estimate_id:currentEstId,tenant_id:tenantId,category_key:c.id,category_type:'revenue',item_name:it.name||'(unnamed)',estimated_cost:parseFloat(it.est)||0,actual_cost:parseFloat(it.act)||0,sort_order:ord++,due_timing:it.due||'pre'});});});if(lineRows.length)await sb.from('estimate_line_items').insert(lineRows);await loadEstimates();dirty=false;if(!silent)toast('Saved to database');}

function resetValues(){if(!confirm('Reset all dollar values to zero?'))return;expCats.forEach(function(c){c.items.forEach(function(i){i.est=0;i.act=0;});});revCats.forEach(function(c){c.items.forEach(function(i){i.est=0;i.act=0;});});render();markDirty();toast('Values reset');}
function exportCSV(){var rows=[['Category','Type','Item','Due','Estimated','Actual']];expCats.forEach(function(c){c.items.forEach(function(i){rows.push([c.title,'Expense','"'+(i.name||'').replace(/"/g,'""')+'"',i.due||'pre',i.est||0,i.act||0]);});});revCats.forEach(function(c){c.items.forEach(function(i){rows.push([c.title,'Revenue','"'+(i.name||'').replace(/"/g,'""')+'"',i.due||'pre',i.est||0,i.act||0]);});});var csv=rows.map(function(r){return r.join(',');}).join('\n');var b=new Blob([csv],{type:'text/csv'});var u=URL.createObjectURL(b);var a=document.createElement('a');a.href=u;a.download=(document.getElementById('eName').value||'estimate')+'.csv';a.click();URL.revokeObjectURL(u);toast('CSV exported');}
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ===== PRELOADED: REDDING ROCK 2026 =====
function loadPreloaded(){currentEstId='preloaded';document.getElementById('eName').value='Redding Rock';document.getElementById('eDate').value='2026-06-20';document.getElementById('eAtt').value='500';expCats=[{id:'entertainment',color:'#ec4899',title:'Entertainment Booking',items:[{name:'Headliner booking : Jonny Riser and Red Neck Rippers',est:10000,act:0,due:'pre'},{name:'Band support',est:0,act:0,due:'pre'},{name:'Band opener',est:0,act:0,due:'pre'},{name:'Go-Go dancers / performers',est:0,act:0,due:'pre'},{name:'Backstage area setup',est:0,act:0,due:'pre'}]},{id:'merch',color:'#fbbf24',title:'Merchandise',items:[{name:'Event shirt order - Quantity 200 event shirts',est:4000,act:0,due:'pre'},{name:'Merch booth items (shirts, hats, etc.)',est:0,act:0,due:'pre'},{name:'Poker chips',est:0,act:0,due:'pre'},{name:'crew shirts x 36 @ $10 each 1 color screen',est:360,act:0,due:'pre'}]},{id:'venue',color:'#3b82f6',title:'Venue',items:[{name:'Secure venue',est:2000,act:0,due:'pre'},{name:'Power upgrades Generator',est:500,act:0,due:'pre'},{name:'Gas',est:200,act:0,due:'pre'},{name:'Additional Infrastructure - Hay Bails ect',est:750,act:0,due:'pre'}]},{id:'stage_sound',color:'#6366f1',title:'Stage / Lights / Sound',items:[{name:'Main Stage - RN Sound - stage lights tv screens - Sound Guy',est:2000,act:0,due:'pre'}]},{id:'rentals',color:'#14b8a6',title:'Rentals',items:[{name:'Porta potties & sinks - 1 per 50 people @ avg. $100 per',est:1000,act:0,due:'pre'},{name:'Tables / chairs',est:0,act:0,due:'pre'},{name:'Tents - Shades',est:1000,act:0,due:'pre'}]},{id:'sponsors',color:'#22c55e',title:'Sponsors',items:[{name:'VIP sponsor experience package all three packages',est:1000,act:0,due:'pre'},{name:'Sponsor certificates x 100',est:400,act:0,due:'pre'}]},{id:'socials',color:'#06b6d4',title:'Social Media',items:[{name:'Media Ads',est:500,act:0,due:'pre'}]},{id:'parking',color:'#0ea5e9',title:'Parking',items:[{name:'Signage creation',est:200,act:0,due:'pre'},{name:'Redding Rock Crew Parking - 2hr shift - early or late - crew shirt - event ticket - drink ticket - certificate x 10 crew',est:200,act:0,due:'pre'}]},{id:'security',color:'#ef4444',title:'Security',items:[{name:'Redding Rock Crew - 2hr shift - early or late - crew shirt - event ticket - drink ticket - certificate x 10 crew',est:200,act:0,due:'pre'}]},{id:'permits',color:'#a78bfa',title:'Permits & Licenses',items:[{name:'Identify permits & licenses needed',est:0,act:0,due:'pre'},{name:'Application fees',est:0,act:0,due:'pre'},{name:'Permit processing',est:0,act:0,due:'pre'},{name:'Event Insurance',est:175,act:0,due:'pre'}]},{id:'food',color:'#f97316',title:'Food',items:[{name:'Multi-level menu creation',est:0,act:0,due:'pre'},{name:'Sponsor menu',est:0,act:0,due:'pre'},{name:'Food shopping',est:0,act:0,due:'day'},{name:'Food service area setup',est:0,act:0,due:'day'},{name:'Rental equipment for food service',est:0,act:0,due:'pre'}]},{id:'media',color:'#f472b6',title:'Media & Print',items:[{name:'Handbill flyer design & print',est:0,act:0,due:'pre'},{name:'Poster AD 11x17',est:0,act:0,due:'pre'},{name:'Event ticket design & print',est:0,act:0,due:'pre'},{name:'Shirt design (front & back)',est:0,act:0,due:'pre'},{name:'Poster for sale at event',est:0,act:0,due:'pre'},{name:'Website ads',est:0,act:0,due:'pre'},{name:'Mobile ads',est:0,act:0,due:'pre'}]},{id:'medical',color:'#dc2626',title:'Medical',items:[{name:'Supply restock',est:50,act:0,due:'post'}]},{id:'website',color:'#84cc16',title:'Website',items:[{name:'Email blast',est:50,act:0,due:'post'}]}];revCats=[{id:'rev_sponsors',color:'#16a34a',title:'Sponsor Revenue',items:[{name:'Platinum sponsors - Event shirt bill',est:3500,act:0,due:'pre'},{name:'Gold sponsors - Main Stage',est:2000,act:0,due:'pre'},{name:'Silver sponsors - Sanitation bill',est:1500,act:0,due:'pre'},{name:'Media sponsors on screens Randos @ 50 per x 10',est:500,act:0,due:'pre'},{name:'Standard Sponsor @ $250 x 40',est:10000,act:0,due:'pre'}]},{id:'rev_tickets',color:'#22c55e',title:'Ticket Sales',items:[{name:'General admission @ $40 x 100',est:4000,act:0,due:'day'},{name:'VIP tickets',est:0,act:0,due:'day'},{name:'Early bird tickets 50 x $25',est:1250,act:0,due:'pre'}]},{id:'rev_vendors',color:'#059669',title:'Vendor Fees',items:[{name:'Powered booth fees',est:0,act:0,due:'day'},{name:'Non-powered booth fees - 20 booths @ $50',est:1000,act:0,due:'day'}]},{id:'rev_bar',color:'#10b981',title:'Bar Revenue',items:[{name:'Drink sales estimate',est:2000,act:0,due:'day'}]},{id:'rev_food',color:'#f97316',title:'Food Rev',items:[{name:'Food sales estimate',est:2000,act:0,due:'day'}]},{id:'rev_parking',color:'#0ea5e9',title:'Parking',items:[{name:'Car parking Day of $10 - 150 cars',est:1500,act:0,due:'day'}]},{id:'rev_merch',color:'#34d399',title:'Merch Sales',items:[{name:'Shirt sales',est:800,act:0,due:'day'},{name:'Hat sales',est:200,act:0,due:'day'},{name:'Other merch',est:0,act:0,due:'day'}]},{id:'rev_icecream',color:'#fbbf24',title:'Ice Cream Snacks and Drinks',items:[{name:'Ice cream snacks and drinks sales',est:1000,act:0,due:'day'}]},{id:'rev_camping',color:'#84cc16',title:'Camping',items:[{name:'Camping fees',est:0,act:0,due:'day'}]}];render();renderSelects();}

// ===== CLONE =====
async function cloneEst(){var srcName=document.getElementById('eName').value||'Untitled';var name=prompt('Name for cloned budget:',srcName+' (Copy)');if(!name||!name.trim())return;name=name.trim();var cloneExp=JSON.parse(JSON.stringify(expCats));var cloneRev=JSON.parse(JSON.stringify(revCats));cloneExp.forEach(function(c){c.id=c.id+'_'+Date.now();});cloneRev.forEach(function(c){c.id=c.id+'_'+Date.now();});if(tenantId){var ins=await sb.from('event_estimates').insert({tenant_id:tenantId,created_by:userId,event_name:name,event_date:document.getElementById('eDate').value||null,expected_attendance:parseInt(document.getElementById('eAtt').value)||0,is_shared:false,status:'draft'}).select().single();if(ins.error){toast('Error: '+ins.error.message);return;}var estId=ins.data.estimate_id;var catRows=[],lineRows=[],lo=0;cloneExp.forEach(function(c,i){catRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'expense',title:c.title,color:c.color,sort_order:i});c.items.forEach(function(it){lineRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'expense',item_name:it.name||'(unnamed)',estimated_cost:parseFloat(it.est)||0,actual_cost:parseFloat(it.act)||0,sort_order:lo++,due_timing:it.due||'pre'});});});cloneRev.forEach(function(c,i){catRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'revenue',title:c.title,color:c.color,sort_order:i+100});c.items.forEach(function(it){lineRows.push({estimate_id:estId,tenant_id:tenantId,category_key:c.id,category_type:'revenue',item_name:it.name||'(unnamed)',estimated_cost:parseFloat(it.est)||0,actual_cost:parseFloat(it.act)||0,sort_order:lo++,due_timing:it.due||'pre'});});});await sb.from('estimate_categories').insert(catRows);if(lineRows.length)await sb.from('estimate_line_items').insert(lineRows);currentEstId=estId;localStorage.setItem('elp-last-est',estId);await loadEstimates();syncSel(estId);}else{document.getElementById('eName').value=name;expCats=cloneExp;revCats=cloneRev;currentEstId='preloaded';render();renderSelects();}toast('"'+name+'" cloned');}

// ===== INIT =====
async function init(){var s=await checkAuth();if(!s)return;userId=s.user.id;var email=s.user.email||'';if(email){var ur=await sb.from('users').select('tenant_id,user_id').eq('email',email).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}document.getElementById('mobBiz').textContent=email;document.getElementById('deskBiz').textContent=email;}if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}if(!tenantId){toast('Cannot determine tenant');return;}await detectRole();await loadEstimates();var lastId=localStorage.getItem('elp-last-est');if(lastId&&allEstimates.find(function(e){return e.estimate_id===lastId;})){syncSel(lastId);}else if(allEstimates.length){syncSel(allEstimates[0].estimate_id);}else{loadPreloaded();}}
init();
</script>
</body>
</html>
