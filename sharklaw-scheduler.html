<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Scheduler</title>
  <script>
    (function() {
      var theme = localStorage.getItem('app-theme') || 'dark-blue';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="themes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; --month-alt-bg: #0d1218; }
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; --month-alt-bg: #0d1218; }
    [data-theme="blue-light"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; --month-alt-bg: #e0eaff; }
    [data-theme="slate-dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; --month-alt-bg: #141c2e; }
    [data-theme="slate-light"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; --month-alt-bg: #e2e8f0; }
    [data-theme="ocean-dark"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; --month-alt-bg: #0c1517; }
    [data-theme="ocean-light"] { --bg-primary: #f0fdfa; --bg-secondary: #e0f7f4; --bg-card: #ffffff; --bg-hover: #ccfbf1; --border-default: #99f6e4; --text-primary: #134e4a; --text-secondary: #2d6a66; --accent-primary: #0d9488; --accent-light: #14b8a6; --month-alt-bg: #e0f7f4; }
    [data-theme="midnight-dark"],[data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; --month-alt-bg: #0c0c0f; }
    [data-theme="lavender-light"],[data-theme="lavender"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; --month-alt-bg: #f3e8ff; }
    [data-theme="forest-dark"],[data-theme="forest"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; --month-alt-bg: #0c130e; }
    [data-theme="mint-light"],[data-theme="mint"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; --month-alt-bg: #dcfce7; }
    [data-theme="crimson-dark"],[data-theme="crimson"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; --month-alt-bg: #1a0c0e; }
    [data-theme="coral-light"],[data-theme="coral"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; --month-alt-bg: #fee2e2; }
    [data-theme="amber-dark"],[data-theme="amber"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; --month-alt-bg: #1a1508; }
    [data-theme="honey-light"],[data-theme="honey"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; --month-alt-bg: #fef3c7; }
    [data-theme="rose-dark"],[data-theme="rose"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; --month-alt-bg: #1a0c12; }
    [data-theme="sky-light"],[data-theme="sky"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; --month-alt-bg: #e0f2fe; }
    [data-theme="cyber-dark"],[data-theme="cyber"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; --month-alt-bg: #0f0f18; }
    [data-theme="sand-light"],[data-theme="sand"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; --month-alt-bg: #faf6ee; }
    [data-theme="slate"],[data-theme="ocean"],[data-theme="light-blue"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; --month-alt-bg: #141c2e; }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow-x: hidden; user-select: none; -webkit-user-select: none; }
    body { padding-bottom: 120px; }

    /* Theme Toggle Button - matching dashboard */
    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    .theme-toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 1000; display: none; }
    .theme-toast.show { display: block; }

    /* Desktop Header - matching dashboard exactly */
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }

    .mobile-top-header { display: block; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; }
    .mobile-menu-toggle { background: transparent; border: 1px solid transparent; border-radius: 6px; color: var(--text-secondary); font-size: 20px; padding: 0; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; -webkit-appearance: none; }
    .mobile-header-center { flex: 1; margin-left: 12px; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-primary); }
    .view-style-toggle { display: flex; gap: 4px; background: var(--bg-card); padding: 4px; border-radius: 10px; border: 1px solid var(--border-default); }
    .view-style-btn { padding: 6px 10px; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; -webkit-appearance: none; }
    .view-style-btn.active { background: var(--accent-primary); color: white; }
    .accordion-icon-header { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s ease; }
    .mobile-menu-toggle.active .accordion-icon-header { transform: rotate(180deg); }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: var(--bg-card); border: 1px solid var(--accent-primary); color: var(--text-primary); border-radius: 8px; cursor: pointer; -webkit-appearance: none; }
    .main-tabs { display: flex; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .main-tab { flex: 1; padding: 14px 12px; text-align: center; font-size: 14px; font-weight: 600; color: var(--text-secondary); background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; -webkit-appearance: none; }
    .main-tab.active { color: var(--accent-light); border-bottom-color: var(--accent-primary); }
    .date-nav-container { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .lanes-date-nav { padding: 12px 0; }
    .lanes-controls-row { display: flex; align-items: center; gap: 8px; padding: 0 16px 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .lanes-controls-row::-webkit-scrollbar { display: none; }
    .lanes-today-btn { flex-shrink: 0; padding: 8px 16px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--accent-primary); color: white; font-size: 13px; font-weight: 600; cursor: pointer; -webkit-appearance: none; }
    .lanes-filter-btn { flex-shrink: 0; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; -webkit-appearance: none; }
    .lanes-filter-btn.active { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: var(--accent-primary); color: var(--accent-light); }
    .lanes-filter-btn .count { background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    .expand-toggle-btn { flex-shrink: 0; width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: auto; -webkit-appearance: none; }
    .expand-toggle-btn.expanded { background: color-mix(in srgb, var(--accent-primary) 30%, transparent); border-color: var(--accent-primary); color: var(--accent-light); }
    .lanes-date-chips { display: flex; gap: 6px; padding: 0 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; overscroll-behavior-x: contain; }
    .lanes-date-chips::-webkit-scrollbar { display: none; }
    .month-section { display: flex; gap: 6px; padding: 8px; border-radius: 12px; margin-right: 4px; flex-shrink: 0; }
    .month-section.even { background: var(--bg-secondary); }
    .month-section.odd { background: var(--month-alt-bg); }
    .month-label { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; padding: 4px 2px; opacity: 0.7; }
    .month-days { display: flex; gap: 6px; }
    .lanes-date-chip { flex-shrink: 0; padding: 8px 10px; border-radius: 10px; background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-width: 48px; -webkit-appearance: none; scroll-snap-align: center; }
    .lanes-date-chip.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
    .lanes-date-chip.today:not(.active) { border-color: var(--accent-light); border-width: 2px; }
    .lanes-date-chip .day-name { font-size: 9px; text-transform: uppercase; opacity: 0.8; }
    .lanes-date-chip .day-num { font-size: 16px; font-weight: 700; margin-top: 2px; }
    .lanes-date-chip .job-count { font-size: 8px; margin-top: 2px; opacity: 0.8; }
    .content-area { position: relative; overflow-x: hidden; overflow-y: auto; min-height: calc(100vh - 350px); -webkit-overflow-scrolling: touch; touch-action: pan-y pinch-zoom; }
    .swipe-page { position: absolute; top: 0; left: 0; width: 100%; min-height: 100%; will-change: transform, opacity; transform: translateX(0); opacity: 1; }
    .swipe-page.current { position: relative; transform: translateX(0); opacity: 1; z-index: 2; }
    .swipe-page.prev { transform: translateX(-100%); opacity: 0; z-index: 1; }
    .swipe-page.next { transform: translateX(100%); opacity: 0; z-index: 1; }
    .swipe-page.animating { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    .edge-indicator { position: fixed; top: 50%; transform: translateY(-50%); width: 70px; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; font-size: 24px; color: white; background: linear-gradient(90deg, rgba(59,130,246,0.9), transparent); opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 500; border-radius: 0 16px 16px 0; }
    .edge-indicator.left { left: 0; }
    .edge-indicator.right { right: 0; background: linear-gradient(-90deg, rgba(59,130,246,0.9), transparent); border-radius: 16px 0 0 16px; }
    .edge-indicator.active { opacity: 1; animation: edgePulse 0.6s ease-in-out infinite; }
    .edge-indicator .date-preview { font-size: 12px; font-weight: 700; text-align: center; line-height: 1.3; padding: 0 8px; }
    .edge-indicator .edge-arrow { font-size: 28px; }
    @keyframes edgePulse { 0%, 100% { opacity: 0.85; } 50% { opacity: 1; } }
    .lanes-container { padding: 12px 0; }
    .tech-lane { margin-bottom: 8px; background: var(--bg-card); margin: 0 12px 8px; border-radius: 12px; border: 1px solid var(--border-default); overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s; }
    .tech-lane.drop-target { border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-primary); }
    .lane-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; }
    .lane-header:active { background: var(--bg-hover); }
    .lane-info { display: flex; align-items: center; gap: 12px; }
    .tech-avatar { width: 40px; height: 40px; border-radius: 10px; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: white; }
    .tech-avatar.green { background: #22c55e; }
    .tech-avatar.orange { background: #f97316; }
    .tech-avatar.purple { background: #8b5cf6; }
    .tech-details h3 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .tech-details span { font-size: 12px; color: var(--text-secondary); }
    .lane-header-right { display: flex; align-items: center; gap: 16px; }
    .lane-stats { display: flex; gap: 16px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 16px; font-weight: 700; }
    .stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
    .lane-expand-icon { font-size: 14px; color: var(--text-secondary); transition: transform 0.2s; }
    .tech-lane.expanded .lane-expand-icon { transform: rotate(180deg); }
    .lane-cards-wrapper { max-height: 0; overflow: clip; transition: max-height 0.3s ease; }
    .tech-lane.expanded .lane-cards-wrapper { max-height: 500px; overflow: visible; }
    .lane-cards { display: flex; gap: 10px; overflow-x: scroll; overflow-y: hidden; padding: 0 16px 12px; -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; touch-action: pan-x; }
    .lane-cards::-webkit-scrollbar { display: none; }
    .wo-card { flex-shrink: 0; width: 200px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-default); padding: 10px 12px 32px 12px; cursor: grab; position: relative; border-left: 4px solid var(--accent-primary); touch-action: pan-x pan-y; }
    .wo-card:active { cursor: grabbing; }
    .wo-card.status-in_progress { border-left-color: var(--accent-primary); }
    .wo-card.status-waiting { border-left-color: #eab308; }
    .wo-card.status-completed { border-left-color: #22c55e; }
    .wo-card.status-urgent { border-left-color: #ef4444; }
    .wo-card.fleet::after { content: 'FLEET'; position: absolute; top: 6px; right: 6px; font-size: 7px; font-weight: 700; padding: 2px 4px; border-radius: 3px; background: #14b8a6; color: white; }
    .wo-card.dragging { opacity: 0.5; transform: scale(0.95); touch-action: none; }
    .card-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .card-customer { font-size: 14px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 35px; }
    .card-info-row { display: flex; align-items: center; gap: 6px; }
    .card-vehicle { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; }
    .card-dot { width: 3px; height: 3px; border-radius: 50%; background: var(--text-secondary); }
    .card-status { font-size: 9px; font-weight: 600; text-transform: uppercase; padding: 2px 5px; border-radius: 4px; }
    .card-status.in_progress { background: rgba(59,130,246,0.2); color: var(--accent-light); }
    .card-status.waiting { background: rgba(234,179,8,0.15); color: #eab308; }
    .card-status.completed { background: rgba(34,197,94,0.15); color: #22c55e; }
    .card-status.urgent { background: rgba(239,68,68,0.15); color: #ef4444; }
    .card-status.scheduled { background: var(--bg-hover); color: var(--text-secondary); }
    .card-status.confirmed { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .card-status.event { background: rgba(249,115,22,0.2); color: #f97316; }
    .card-amount { font-size: 12px; font-weight: 700; margin-left: auto; }
    .add-card { flex-shrink: 0; width: 70px; min-height: 60px; background: var(--bg-primary); border-radius: 10px; border: 2px dashed var(--border-default); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; }
    .add-card-icon { width: 22px; height: 22px; border-radius: 6px; background: var(--bg-hover); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text-secondary); }
    .add-card span { font-size: 9px; color: var(--text-secondary); }
    .card-details-btn { position: absolute; bottom: 8px; right: 8px; padding: 4px 8px; font-size: 10px; font-weight: 600; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
    .wo-card:hover .card-details-btn { opacity: 1; }
    .stack-container { padding: 12px; display: flex; flex-direction: column; gap: 0; }
    .stack-section { }
    .stack-section.collapsed .stack-section-content { display: none; }
    .stack-section .stack-expand-icon { float: right; font-size: 10px; }
    .stack-section-content { }
    .stack-section-header { margin-top: 8px; border-radius: 8px 8px 0 0; }
    .stack-section-header:first-child { margin-top: 0; }
    .stack-section-header.drop-target { background: color-mix(in srgb, var(--accent-primary) 30%, transparent) !important; }
    .stack-drop-zone { cursor: pointer; transition: background 0.2s; }
    .stack-card { background: var(--bg-card); border-radius: 0; border: 1px solid var(--border-default); border-top: none; border-left: 4px solid var(--accent-primary); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: relative; cursor: grab; }
    .stack-card:active { cursor: grabbing; }
    .stack-card:last-child { border-radius: 0 0 8px 8px; margin-bottom: 8px; }
    .stack-card.status-in_progress { border-left-color: var(--accent-primary); }
    .stack-card.status-waiting { border-left-color: #eab308; }
    .stack-card.status-completed { border-left-color: #22c55e; }
    .stack-card.status-urgent { border-left-color: #ef4444; }
    .stack-card-left { flex: 1; }
    .stack-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .stack-customer { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .stack-vehicle { font-size: 12px; color: var(--text-secondary); }
    .stack-org { font-size: 11px; color: var(--text-secondary); }
    .stack-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; padding-right: 60px; }
    .stack-assignee { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
    .stack-card:hover .card-details-btn { opacity: 1; }
    .stack-card .card-details-btn { opacity: 0.7; position: relative; bottom: auto; right: auto; }
    .grid-container { padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    .calendar-container { padding: 12px; }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-header-day { text-align: center; font-size: 11px; font-weight: 600; color: var(--text-secondary); padding: 8px 4px; text-transform: uppercase; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 8px; min-height: 80px; padding: 6px; cursor: pointer; transition: all 0.2s; }
    .calendar-day:hover { border-color: var(--accent-primary); }
    .calendar-day.today { border-color: var(--accent-primary); background: color-mix(in srgb, var(--accent-primary) 10%, var(--bg-card)); }
    .calendar-day.selected { border-color: var(--accent-light); border-width: 2px; }
    .calendar-day.other-month { opacity: 0.4; }
    .calendar-day-num { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
    .calendar-day.today .calendar-day-num { color: var(--accent-light); }
    .calendar-dots { display: flex; flex-wrap: wrap; gap: 3px; }
    .calendar-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .calendar-dot.event { border: 1px solid var(--text-secondary); background: transparent; }
    .calendar-dot.appt { background: var(--accent-primary); }
    .calendar-dot.emp-0 { background: #3b82f6; }
    .calendar-dot.emp-1 { background: #22c55e; }
    .calendar-dot.emp-2 { background: #f97316; }
    .calendar-dot.emp-3 { background: #8b5cf6; }
    .calendar-dot.emp-4 { background: #ec4899; }
    .calendar-dot.emp-5 { background: #14b8a6; }
    .calendar-dot.emp-6 { background: #eab308; }
    .calendar-dot.emp-7 { background: #ef4444; }
    .calendar-dot.emp-8 { background: #6366f1; }
    .calendar-dot.emp-9 { background: #84cc16; }
    .calendar-dot.unassigned { background: var(--text-secondary); }
    .calendar-more { font-size: 9px; color: var(--text-secondary); margin-top: 2px; }
    .calendar-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
    .calendar-nav-btn { background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; }
    .calendar-nav-btn:active { background: var(--bg-hover); }
    .calendar-month-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .wo-card.event-card, .stack-card.event-card, .grid-card.event-card { border-left: 3px solid #f97316; }
    .event-badge { display: inline-block; background: #f97316; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 6px; }
    .appt-badge { display: inline-block; background: var(--accent-primary); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 6px; }
    .card-org { font-size: 11px; color: var(--text-secondary); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-cost { font-size: 12px; color: #22c55e; font-weight: 600; }
    .card-type { font-size: 11px; color: var(--accent-light); }
    .card-stage { font-size: 11px; color: var(--text-secondary); }
    .grid-card { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border-default); border-left: 4px solid var(--accent-primary); padding: 12px 16px 40px 16px; position: relative; }
    .grid-card.status-in_progress { border-left-color: var(--accent-primary); }
    .grid-card.status-waiting { border-left-color: #eab308; }
    .grid-card.status-completed { border-left-color: #22c55e; }
    .grid-card.status-urgent { border-left-color: #ef4444; }
    .grid-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .grid-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .grid-customer { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .grid-vehicle { font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; }
    .grid-card-footer { display: flex; justify-content: space-between; align-items: center; }
    .grid-assignee { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
    .grid-amount { font-size: 14px; font-weight: 700; }
    .grid-card:hover .card-details-btn { opacity: 1; }
    .tech-avatar.small { width: 24px; height: 24px; font-size: 10px; border-radius: 6px; }
    .drag-ghost { position: fixed; z-index: 1001; pointer-events: none; opacity: 0.9; transform: scale(1.05) rotate(2deg); box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state-text { font-size: 16px; }

    /* Mobile Bottom Nav */
    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; -webkit-appearance: none; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.action-btn { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 50%, transparent); color: var(--accent-light); font-size: 14px; }
    .toast { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--accent-primary); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 1000; display: none; }
    .toast.show { display: block; animation: toastIn 0.3s ease; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 2000; align-items: flex-end; justify-content: center; padding: 0; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 0; line-height: 1; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
    .modal-close:active { background: var(--bg-hover); }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-label .required { color: #ef4444; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 16px; -webkit-appearance: none; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .search-container { position: relative; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 10px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
    .search-results.show { display: block; }
    .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-default); }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:active { background: var(--bg-hover); }
    .search-result-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .search-result-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .search-result-new { display: flex; align-items: center; gap: 8px; color: var(--accent-light); }
    .search-result-new .plus-icon { width: 20px; height: 20px; border-radius: 50%; background: var(--accent-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
    .selected-chip { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--accent-primary); border-radius: 10px; }
    .selected-chip-info { flex: 1; }
    .selected-chip-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .selected-chip-sub { font-size: 12px; color: var(--text-secondary); }
    .selected-chip-remove { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 4px; }
    .modal-footer { padding: 16px 20px 24px; border-top: 1px solid var(--border-default); }
    .modal-footer-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btn-primary { padding: 14px 12px; border-radius: 12px; border: none; background: var(--accent-primary); color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary:active { opacity: 0.9; transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-secondary:active { background: var(--bg-hover); }
    .btn-danger { padding: 14px 12px; border-radius: 12px; border: 1px solid #ef4444; background: rgba(239,68,68,0.15); color: #ef4444; font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-danger:active { background: rgba(239,68,68,0.25); }
    .btn-outline { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--accent-primary); background: transparent; color: var(--accent-light); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-outline:active { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); }
    .new-fields { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-top: 12px; border: 1px solid var(--border-default); }
    .new-fields .form-group { margin-bottom: 16px; }
    .new-fields .form-group:last-child { margin-bottom: 0; }
    .btn-loading { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .mobile-bottom-nav { display: block; }
      .desktop-header { display: none !important; }
    }
    @media (min-width: 769px) {
      .mobile-bottom-nav { display: none; }
      .mobile-top-header { display: none !important; }
      body { padding-bottom: 20px; }
    }
  </style>
</head>
<body>
<!-- Desktop Header - MATCHING DASHBOARD EXACTLY -->
<div class="desktop-header">
  <div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 style="margin:0;font-size:32px;font-weight:600;">Scheduler</h1>
      <div class="business-name" id="desktopEmail">Loading...</div>
    </div>
    <div style="display:flex;align-items:center;gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex;gap:24px;align-items:center;">
      <a href="dashboard-sharklaw.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Contacts</a>
      <a href="sharklaw-swag.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Swag</a>
      <a href="sharklaw-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a>
    </nav>
  </div>
</div>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span class="accordion-icon-header">â˜°</span></button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Scheduler</div>
      <div class="business-name" id="businessName">Scheduler</div>
    </div>
    <div class="view-style-toggle">
      <button class="view-style-btn active" id="styleLanes" onclick="setViewStyle('lanes')">Lanes</button>
      <button class="view-style-btn" id="styleStack" onclick="setViewStyle('stack')">Stack</button>
      <button class="view-style-btn" id="styleGrid" onclick="setViewStyle('grid')">Grid</button>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions" style="grid-template-columns: repeat(3, 1fr);">
      <button onclick="location.href='sharklaw-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
      <button onclick="location.href='account.html'">Account</button>
    </div>
  </div>
</div>

<div class="date-nav-container" id="lanesDateNav">
  <div class="lanes-date-nav">
    <div class="lanes-controls-row" id="lanesControlsRow"></div>
    <div class="lanes-date-chips" id="lanesDateChips"></div>
  </div>
</div>
<div class="edge-indicator left" id="edgeLeft"><span class="edge-arrow">â—€</span><div class="date-preview" id="edgeLeftPreview"></div></div>
<div class="edge-indicator right" id="edgeRight"><span class="edge-arrow">â–¶</span><div class="date-preview" id="edgeRightPreview"></div></div>
<div class="content-area" id="contentArea" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
  <div class="swipe-page current" id="currentPage"></div>
  <div class="swipe-page prev" id="prevPage"></div>
  <div class="swipe-page next" id="nextPage"></div>
</div>

<div id="toast" class="toast"></div>
<div class="theme-toast" id="themeToast"></div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn active">Scheduler</a>
  </div>
  <div class="mobile-nav-row three-col">
    <button class="mobile-nav-btn action-btn" onclick="openNewApptModal()">+ Appt</button>
    <a href="sharklaw-contacts.html" class="mobile-nav-btn">Contacts</a>
    <a href="sharklaw-swag.html" class="mobile-nav-btn">Swag</a>
  </div>
</div>

<script>
const SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

var tenantId=null,userId=null,selectedDate=0,currentViewStyle='lanes',calendarMonth=new Date(),allExpanded=false;
var allAppointments=[],allEvents=[],allEmployees=[],allCustomers=[];

// Theme system - matching dashboard
var THEME_NAMES={'dark-blue':'Dark Blue','blue-light':'Blue Light','slate-dark':'Slate Dark','slate-light':'Slate Light','ocean-dark':'Ocean Dark','ocean-light':'Ocean Light','midnight-dark':'Midnight','lavender-light':'Lavender','forest-dark':'Forest','mint-light':'Mint','crimson-dark':'Crimson','coral-light':'Coral','amber-dark':'Amber','honey-light':'Honey','rose-dark':'Rose','sky-light':'Sky','cyber-dark':'Cyber','sand-light':'Sand'};
var userThemeBank=['dark-blue'],themeIndex=0;

function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';if(!userThemeBank.includes(t))t='dark-blue';themeIndex=userThemeBank.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){if(userThemeBank.length<=1){showThemeToast('Unlock more themes in Settings!');return;}themeIndex=(themeIndex+1)%userThemeBank.length;var t=userThemeBank[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(THEME_NAMES[t]||t);}
function showThemeToast(msg){var toast=document.getElementById('themeToast');toast.textContent=msg;toast.classList.add('show');setTimeout(function(){toast.classList.remove('show');},2000);}
async function loadUserThemeBank(){if(!userId)return;try{var r=await sb.from('user_theme_bank').select('theme_key').eq('user_id',userId);if(r.data&&r.data.length>0){userThemeBank=['dark-blue'].concat(r.data.map(function(t){return t.theme_key;}));userThemeBank=[...new Set(userThemeBank)];}loadTheme();}catch(e){console.error('Error loading theme bank:',e);}}
loadTheme();

async function logout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}

function toggleMobileMenu(btn){var c=document.getElementById('mobileHeaderContent');c.classList.toggle('expanded');btn.classList.toggle('active');}
function setViewStyle(s){currentViewStyle=s;localStorage.setItem('scheduler-view-style',s);document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('style'+s.charAt(0).toUpperCase()+s.slice(1)).classList.add('active');renderAll();}

async function checkAuth(){var r=await sb.auth.getSession();var s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){window.location.href='login.html';return null;}}return s;}

async function loadBusinessSettings(){var r=await sb.from('business_settings').select('tenant_id').limit(1).single();if(r.data){tenantId=r.data.tenant_id;}}

function getCurrentStaff(){return allEmployees.filter(function(e){return e.role!=='owner'&&e.role!=='admin';});}

async function loadAllData(){if(!tenantId)return;var ar=await sb.from('appointments').select('*').eq('tenant_id',tenantId);allAppointments=ar.data||[];var er=await sb.from('events').select('*').eq('tenant_id',tenantId);allEvents=er.data||[];var emr=await sb.from('employees').select('*').eq('tenant_id',tenantId).order('last_name');allEmployees=emr.data||[];var cr=await sb.from('customers').select('customer_id,full_name,phone').eq('tenant_id',tenantId);allCustomers=cr.data||[];}

async function loadEvents(){var er=await sb.from('events').select('*').eq('tenant_id',tenantId);allEvents=er.data||[];}

function getDateLabel(offset){var d=new Date();d.setDate(d.getDate()+offset);var days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];return days[d.getDay()]+' '+d.toLocaleDateString('en-US',{month:'short',day:'numeric'});}

function getJobsForDateOffset(offset){var target=new Date();target.setDate(target.getDate()+offset);var dateStr=target.toISOString().split('T')[0];var jobs=[];allAppointments.forEach(function(a){if(a.appointment_date===dateStr){jobs.push({id:a.appointment_id,customer:a.customer_name||'Unknown',time:a.appointment_time||'09:00',tech:a.assigned_employee_id,status:a.status||'scheduled',isEvent:false,data:a});}});allEvents.forEach(function(e){if(e.event_date===dateStr){jobs.push({id:e.event_id,customer:e.event_name||'Event',time:e.event_time||'10:00',tech:null,status:'event',isEvent:true,data:e});}});jobs.sort(function(a,b){return(a.time||'').localeCompare(b.time||'');});return jobs;}

function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}

function renderLanesControls(){var row=document.getElementById('lanesControlsRow');row.innerHTML='<button class="lanes-today-btn" onclick="goToToday()">Today</button><button class="lanes-filter-btn" onclick="openNewApptModal()">+ Appt</button><button class="lanes-filter-btn" onclick="openNewEventModal()">+ Event</button><button class="expand-toggle-btn '+(allExpanded?'expanded':'')+'" onclick="toggleAllLanes()" title="'+(allExpanded?'Collapse':'Expand')+' all">'+(allExpanded?'â–²':'â–¼')+'</button>';}

function renderLanesDateChips(){var dc=document.getElementById('lanesDateChips');var months={};for(var i=-14;i<=60;i++){var d=new Date();d.setDate(d.getDate()+i);var mk=d.getFullYear()+'-'+d.getMonth();if(!months[mk])months[mk]={month:d.getMonth(),year:d.getFullYear(),days:[]};months[mk].days.push(i);}var mn=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];var html='',midx=0;Object.keys(months).forEach(function(k){var m=months[k],cls=midx%2===0?'even':'odd';html+='<div class="month-section '+cls+'"><div class="month-label">'+mn[m.month]+'</div><div class="month-days">';m.days.forEach(function(off){var dt=new Date();dt.setDate(dt.getDate()+off);var dn=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];var jobs=getJobsForDateOffset(off);var isToday=off===0,isActive=off===selectedDate;html+='<button class="lanes-date-chip'+(isActive?' active':'')+(isToday?' today':'')+'" data-offset="'+off+'" onclick="selectDate('+off+')"><span class="day-name">'+dn+'</span><span class="day-num">'+dt.getDate()+'</span>'+(jobs.length?'<span class="job-count">'+jobs.length+'</span>':'')+'</button>';});html+='</div></div>';midx++;});dc.innerHTML=html;}

function selectDate(off){selectedDate=off;renderAll();}
function goToToday(){selectedDate=0;calendarMonth=new Date();renderAll();centerOnToday();}
function centerOnToday(){var dc=document.getElementById('lanesDateChips');var chips=dc.querySelectorAll('.lanes-date-chip');chips.forEach(function(c){if(parseInt(c.getAttribute('data-offset'))===0){c.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});}});}

function toggleAllLanes(){allExpanded=!allExpanded;renderAll();}

function renderLanesView(dof){var jobs=getJobsForDateOffset(dof);var staff=getCurrentStaff();if(!staff.length&&!jobs.length)return'<div class="empty-state"><div class="empty-state-text">No staff or appointments</div></div>';var empColors=['#3b82f6','#22c55e','#f97316','#8b5cf6','#ec4899','#14b8a6','#eab308','#ef4444','#6366f1','#84cc16'];var h='<div class="lanes-container">';staff.forEach(function(emp,idx){var empJobs=jobs.filter(function(j){return j.tech===emp.employee_id&&!j.isEvent;});var initials=((emp.first_name||'')[0]||'')+((emp.last_name||'')[0]||'');var color=empColors[idx%empColors.length];h+='<div class="tech-lane'+(allExpanded?' expanded':'')+'"><div class="lane-header" onclick="toggleLane(this)"><div class="lane-info"><div class="tech-avatar" style="background:'+color+'">'+initials+'</div><div class="tech-details"><h3>'+((emp.first_name||'')+' '+(emp.last_name||'')).trim()+'</h3><span>'+(emp.role||'Staff')+'</span></div></div><div class="lane-header-right"><div class="lane-stats"><div class="stat-item"><div class="stat-value">'+empJobs.length+'</div><div class="stat-label">Jobs</div></div></div><span class="lane-expand-icon">â–¼</span></div></div><div class="lane-cards-wrapper"><div class="lane-cards">';empJobs.forEach(function(j){h+='<div class="wo-card status-'+j.status+'" data-id="'+j.id+'"><div class="card-time">'+formatTime(j.time)+'</div><div class="card-customer">'+j.customer+'</div><div class="card-info-row"><span class="card-status '+j.status+'">'+(j.status||'scheduled')+'</span></div><button class="card-details-btn" onclick="event.stopPropagation();openApptDetail(\''+j.id+'\')">Details</button></div>';});h+='<div class="add-card" onclick="openNewApptModal(\''+emp.employee_id+'\')"><div class="add-card-icon">+</div><span>Add</span></div></div></div></div>';});var evts=jobs.filter(function(j){return j.isEvent;});if(evts.length){h+='<div class="tech-lane'+(allExpanded?' expanded':'')+'"><div class="lane-header" onclick="toggleLane(this)"><div class="lane-info"><div class="tech-avatar" style="background:#f97316">ðŸ“…</div><div class="tech-details"><h3>Events</h3><span>'+evts.length+' scheduled</span></div></div><div class="lane-header-right"><span class="lane-expand-icon">â–¼</span></div></div><div class="lane-cards-wrapper"><div class="lane-cards">';evts.forEach(function(e){h+='<div class="wo-card event-card" data-id="'+e.id+'"><div class="card-time">'+formatTime(e.time)+'</div><div class="card-customer">'+e.customer+'<span class="event-badge">EVENT</span></div><div class="card-info-row"><span class="card-status event">Event</span></div><button class="card-details-btn" onclick="event.stopPropagation();editEvent(\''+e.id+'\')">Details</button></div>';});h+='</div></div></div>';}h+='</div>';return h;}

function toggleLane(el){el.parentElement.classList.toggle('expanded');}
function formatTime(t){if(!t)return'';var p=t.split(':'),h=parseInt(p[0]),m=p[1]||'00',ap=h>=12?'PM':'AM';h=h%12||12;return h+':'+m+' '+ap;}

function renderStackView(dof){var jobs=getJobsForDateOffset(dof);if(!jobs.length)return'<div class="empty-state"><div class="empty-state-text">No appointments for this day</div></div>';var staff=getCurrentStaff();var groups={};jobs.forEach(function(j){var k=j.isEvent?'events':(j.tech||'unassigned');if(!groups[k])groups[k]=[];groups[k].push(j);});var h='<div class="stack-container">';Object.keys(groups).forEach(function(k){var items=groups[k],title='Unassigned',color='var(--text-secondary)';if(k==='events'){title='Events';color='#f97316';}else{var emp=staff.find(function(e){return e.employee_id===k;});if(emp){title=((emp.first_name||'')+' '+(emp.last_name||'')).trim();color='var(--accent-primary)';}}h+='<div class="stack-section-header" style="background:var(--bg-card);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;color:'+color+';">'+title+'</span><span style="font-size:12px;color:var(--text-secondary);">'+items.length+' items</span></div>';items.forEach(function(j){h+='<div class="stack-card status-'+(j.isEvent?'event':j.status)+'" data-id="'+j.id+'"><div class="stack-card-left"><div class="stack-time">'+formatTime(j.time)+'</div><div class="stack-customer">'+j.customer+(j.isEvent?'<span class="event-badge">EVENT</span>':'')+'</div></div><div class="stack-card-right"><span class="card-status '+(j.isEvent?'event':j.status)+'">'+(j.isEvent?'Event':j.status)+'</span></div><button class="card-details-btn" onclick="event.stopPropagation();'+(j.isEvent?'editEvent':'openApptDetail')+'(\''+j.id+'\')">Details</button></div>';});});h+='</div>';return h;}

function renderGridView(dof){var days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],months=['January','February','March','April','May','June','July','August','September','October','November','December'];var today=new Date();today.setHours(0,0,0,0);var year=calendarMonth.getFullYear(),month=calendarMonth.getMonth();var firstDay=new Date(year,month,1),lastDay=new Date(year,month+1,0);var startDay=firstDay.getDay(),daysInMonth=lastDay.getDate();var prevMonth=new Date(year,month,0),daysInPrevMonth=prevMonth.getDate();var h='<div class="calendar-container">';h+='<div class="calendar-nav"><button class="calendar-nav-btn" onclick="prevMonth()">â—€ Prev</button><div class="calendar-month-title">'+months[month]+' '+year+'</div><button class="calendar-nav-btn" onclick="nextMonth()">Next â–¶</button></div>';h+='<div class="calendar-header">';for(var d=0;d<7;d++)h+='<div class="calendar-header-day">'+days[d]+'</div>';h+='</div><div class="calendar-grid">';var staff=getCurrentStaff();var staffIndexMap={};staff.forEach(function(s,i){staffIndexMap[s.employee_id]=i;});for(var i=0;i<startDay;i++){var dn=daysInPrevMonth-startDay+i+1;h+='<div class="calendar-day other-month"><div class="calendar-day-num">'+dn+'</div></div>';}for(var d=1;d<=daysInMonth;d++){var cellDate=new Date(year,month,d);var dateStr=cellDate.toISOString().split('T')[0];var isToday=cellDate.getTime()===today.getTime();var offset=Math.round((cellDate-today)/(1000*60*60*24));var isSelected=offset===selectedDate;var jobs=getJobsForDateOffset(offset);var cls='calendar-day';if(isToday)cls+=' today';if(isSelected)cls+=' selected';h+='<div class="'+cls+'" onclick="selectDateAndSwitchToLanes('+offset+')"><div class="calendar-day-num">'+d+'</div><div class="calendar-dots">';var dotCount=0,maxDots=10;for(var j=0;j<jobs.length&&dotCount<maxDots;j++){var job=jobs[j];if(job.isEvent){h+='<div class="calendar-dot event"></div>';}else{var empIndex=staffIndexMap[job.tech];if(empIndex===undefined)empIndex=-1;var dotClass=empIndex>=0?'emp-'+empIndex:'unassigned';h+='<div class="calendar-dot '+dotClass+'"></div>';}dotCount++;}if(jobs.length>maxDots)h+='<div class="calendar-more">+'+(jobs.length-maxDots)+'</div>';h+='</div></div>';}var totalCells=startDay+daysInMonth,remaining=totalCells%7===0?0:7-totalCells%7;for(var i=1;i<=remaining;i++)h+='<div class="calendar-day other-month"><div class="calendar-day-num">'+i+'</div></div>';h+='</div></div>';return h;}

function prevMonth(){calendarMonth.setMonth(calendarMonth.getMonth()-1);renderPages();}
function nextMonth(){calendarMonth.setMonth(calendarMonth.getMonth()+1);renderPages();}
function selectDateAndSwitchToLanes(offset){selectedDate=offset;currentViewStyle='lanes';localStorage.setItem('scheduler-view-style','lanes');document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('styleLanes').classList.add('active');renderAll();showToast(getDateLabel(offset));}

function renderPages(){var content='';if(currentViewStyle==='stack'){content=renderStackView(selectedDate);}else if(currentViewStyle==='grid'){content=renderGridView(selectedDate);}else{content=renderLanesView(selectedDate);}document.getElementById('currentPage').innerHTML=content;}
function renderAll(){renderLanesControls();renderLanesDateChips();renderPages();}

// Touch handling for swipe
var touchStartX=null,touchStartY=null,isSwiping=false;
function handleTouchStart(e){if(currentViewStyle!=='lanes'&&currentViewStyle!=='stack')return;if(e.target.closest('.lane-cards')||e.target.closest('.lanes-date-chips'))return;var touch=e.touches[0];touchStartX=touch.clientX;touchStartY=touch.clientY;isSwiping=false;}
function handleTouchMove(e){if((currentViewStyle!=='lanes'&&currentViewStyle!=='stack')||touchStartX===null)return;var touch=e.touches[0];var deltaX=touch.clientX-touchStartX;var deltaY=touch.clientY-touchStartY;if(Math.abs(deltaX)>Math.abs(deltaY)&&Math.abs(deltaX)>10)isSwiping=true;}
function handleTouchEnd(e){if((currentViewStyle!=='lanes'&&currentViewStyle!=='stack')||touchStartX===null||!isSwiping)return;var touch=e.changedTouches[0];var deltaX=touch.clientX-touchStartX;if(Math.abs(deltaX)>50){if(deltaX<0)selectedDate++;else selectedDate--;renderAll();}touchStartX=null;isSwiping=false;}

// Placeholder modal functions
function openNewApptModal(empId){showToast('Opening appointment modal...');}
function openApptDetail(id){showToast('Opening appointment details...');}
function openNewEventModal(){showToast('Opening event modal...');}
function editEvent(id){showToast('Opening event details...');}

async function init(){var s=await checkAuth();if(!s)return;await loadBusinessSettings();if(s.user&&s.user.email){document.getElementById('businessName').textContent=s.user.email;document.getElementById('desktopEmail').textContent=s.user.email;var ur=await sb.from('users').select('user_id').eq('email',s.user.email).single();if(ur.data)userId=ur.data.user_id;}await loadUserThemeBank();await loadAllData();currentViewStyle=localStorage.getItem('scheduler-view-style')||'lanes';document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('style'+currentViewStyle.charAt(0).toUpperCase()+currentViewStyle.slice(1)).classList.add('active');renderAll();requestAnimationFrame(function(){requestAnimationFrame(centerOnToday);});}
init();
</script>
</body>
</html>
