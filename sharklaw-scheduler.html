<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Scheduler</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
      --month-alt-bg: #0d1218;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa; --month-alt-bg: #0d1218;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373; --month-alt-bg: #161616;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8; --month-alt-bg: #141c2e;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa; --month-alt-bg: #0c0c0f;
    }
    [data-theme="navy"] {
      --bg-primary: #0a0e1a; --bg-secondary: #0f1526; --bg-card: #182035; --bg-hover: #1f2a45;
      --border-default: #253352; --text-primary: #e8ecf4; --text-secondary: #9aa5bd;
      --accent-primary: #4a7cc9; --accent-light: #6b9ae0; --month-alt-bg: #0c111e;
    }
    [data-theme="graphite"] {
      --bg-primary: #0d0d0d; --bg-secondary: #141414; --bg-card: #1f1f1f; --bg-hover: #292929;
      --border-default: #2e2e2e; --text-primary: #e8e8e8; --text-secondary: #999999;
      --accent-primary: #4a9eff; --accent-light: #6bb3ff; --month-alt-bg: #101010;
    }
    [data-theme="ocean"] {
      --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35;
      --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5;
      --accent-primary: #14b8a6; --accent-light: #2dd4bf; --month-alt-bg: #0c1517;
    }
    [data-theme="forest"] {
      --bg-primary: #0a100c; --bg-secondary: #0f1812; --bg-card: #16221a; --bg-hover: #1e2e24;
      --border-default: #263830; --text-primary: #e5f0e8; --text-secondary: #8faa96;
      --accent-primary: #22c55e; --accent-light: #4ade80; --month-alt-bg: #0c130e;
    }
    [data-theme="light-blue"] {
      --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0;
      --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569;
      --accent-primary: #2563eb; --accent-light: #3b82f6; --month-alt-bg: #e2e8f0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary); color: var(--text-primary);
      overflow-x: hidden; user-select: none; -webkit-user-select: none;
    }
    body { padding-bottom: 120px; }
    .mobile-top-header { display: block; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; }
    .mobile-menu-toggle { background: transparent; border: 1px solid transparent; border-radius: 6px; color: var(--text-secondary); font-size: 20px; padding: 0; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; -webkit-appearance: none; }
    .mobile-header-center { flex: 1; margin-left: 12px; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-primary); }
    .view-style-toggle { display: flex; gap: 4px; background: var(--bg-card); padding: 4px; border-radius: 10px; border: 1px solid var(--border-default); }
    .view-style-btn { padding: 6px 10px; border-radius: 6px; border: none; background: transparent; color: var(--text-secondary); font-size: 11px; font-weight: 600; cursor: pointer; -webkit-appearance: none; }
    .view-style-btn.active { background: var(--accent-primary); color: white; }
    .accordion-icon-header { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s ease; }
    .mobile-menu-toggle.active .accordion-icon-header { transform: rotate(180deg); }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: var(--bg-card); border: 1px solid var(--accent-primary); color: var(--text-primary); border-radius: 8px; cursor: pointer; -webkit-appearance: none; }
    .main-tabs { display: flex; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .main-tab { flex: 1; padding: 14px 12px; text-align: center; font-size: 14px; font-weight: 600; color: var(--text-secondary); background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; -webkit-appearance: none; }
    .main-tab.active { color: var(--accent-light); border-bottom-color: var(--accent-primary); }
    .date-nav-container { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .lanes-date-nav { padding: 12px 0; }
    .lanes-controls-row { display: flex; align-items: center; gap: 8px; padding: 0 16px 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .lanes-controls-row::-webkit-scrollbar { display: none; }
    .lanes-today-btn { flex-shrink: 0; padding: 8px 16px; border-radius: 8px; border: 1px solid var(--accent-primary); background: var(--accent-primary); color: white; font-size: 13px; font-weight: 600; cursor: pointer; -webkit-appearance: none; }
    .lanes-filter-btn { flex-shrink: 0; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; -webkit-appearance: none; }
    .lanes-filter-btn.active { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: var(--accent-primary); color: var(--accent-light); }
    .lanes-filter-btn .count { background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    .expand-toggle-btn { flex-shrink: 0; width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: auto; -webkit-appearance: none; }
    .expand-toggle-btn.expanded { background: color-mix(in srgb, var(--accent-primary) 30%, transparent); border-color: var(--accent-primary); color: var(--accent-light); }
    .lanes-date-chips { display: flex; gap: 6px; padding: 0 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; overscroll-behavior-x: contain; }
    .lanes-date-chips::-webkit-scrollbar { display: none; }
    .month-section { display: flex; gap: 6px; padding: 8px; border-radius: 12px; margin-right: 4px; flex-shrink: 0; }
    .month-section.even { background: var(--bg-secondary); }
    .month-section.odd { background: var(--month-alt-bg); }
    .month-label { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; padding: 4px 2px; opacity: 0.7; }
    .month-days { display: flex; gap: 6px; }
    .lanes-date-chip { flex-shrink: 0; padding: 8px 10px; border-radius: 10px; background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-width: 48px; -webkit-appearance: none; scroll-snap-align: center; }
    .lanes-date-chip.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
    .lanes-date-chip.today:not(.active) { border-color: var(--accent-light); border-width: 2px; }
    .lanes-date-chip .day-name { font-size: 9px; text-transform: uppercase; opacity: 0.8; }
    .lanes-date-chip .day-num { font-size: 16px; font-weight: 700; margin-top: 2px; }
    .lanes-date-chip .job-count { font-size: 8px; margin-top: 2px; opacity: 0.8; }
    .content-area { position: relative; overflow-x: hidden; overflow-y: auto; min-height: calc(100vh - 350px); -webkit-overflow-scrolling: touch; touch-action: pan-y pinch-zoom; }
    .swipe-page { position: absolute; top: 0; left: 0; width: 100%; min-height: 100%; will-change: transform, opacity; transform: translateX(0); opacity: 1; }
    .swipe-page.current { position: relative; transform: translateX(0); opacity: 1; z-index: 2; }
    .swipe-page.prev { transform: translateX(-100%); opacity: 0; z-index: 1; }
    .swipe-page.next { transform: translateX(100%); opacity: 0; z-index: 1; }
    .swipe-page.animating { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    .edge-indicator { position: fixed; top: 50%; transform: translateY(-50%); width: 70px; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; font-size: 24px; color: white; background: linear-gradient(90deg, rgba(59,130,246,0.9), transparent); opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 500; border-radius: 0 16px 16px 0; }
    .edge-indicator.left { left: 0; }
    .edge-indicator.right { right: 0; background: linear-gradient(-90deg, rgba(59,130,246,0.9), transparent); border-radius: 16px 0 0 16px; }
    .edge-indicator.active { opacity: 1; animation: edgePulse 0.6s ease-in-out infinite; }
    .edge-indicator .date-preview { font-size: 12px; font-weight: 700; text-align: center; line-height: 1.3; padding: 0 8px; }
    .edge-indicator .edge-arrow { font-size: 28px; }
    @keyframes edgePulse { 0%, 100% { opacity: 0.85; } 50% { opacity: 1; } }
    .lanes-container { padding: 12px 0; }
    .tech-lane { margin-bottom: 8px; background: var(--bg-card); margin: 0 12px 8px; border-radius: 12px; border: 1px solid var(--border-default); overflow: hidden; transition: border-color 0.2s, box-shadow 0.2s; }
    .tech-lane.drop-target { border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-primary); }
    .lane-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; }
    .lane-header:active { background: var(--bg-hover); }
    .lane-info { display: flex; align-items: center; gap: 12px; }
    .tech-avatar { width: 40px; height: 40px; border-radius: 10px; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: white; }
    .tech-avatar.green { background: #22c55e; }
    .tech-avatar.orange { background: #f97316; }
    .tech-avatar.purple { background: #8b5cf6; }
    .tech-details h3 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .tech-details span { font-size: 12px; color: var(--text-secondary); }
    .lane-header-right { display: flex; align-items: center; gap: 16px; }
    .lane-stats { display: flex; gap: 16px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 16px; font-weight: 700; }
    .stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
    .lane-expand-icon { font-size: 14px; color: var(--text-secondary); transition: transform 0.2s; }
    .tech-lane.expanded .lane-expand-icon { transform: rotate(180deg); }
    .lane-cards-wrapper { max-height: 0; overflow: clip; transition: max-height 0.3s ease; }
    .tech-lane.expanded .lane-cards-wrapper { max-height: 500px; overflow: visible; }
    .lane-cards { display: flex; gap: 10px; overflow-x: scroll; overflow-y: hidden; padding: 0 16px 12px; -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; touch-action: pan-x; }
    .lane-cards::-webkit-scrollbar { display: none; }
    .wo-card { flex-shrink: 0; width: 200px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-default); padding: 10px 12px 32px 12px; cursor: grab; position: relative; border-left: 4px solid var(--accent-primary); touch-action: pan-x pan-y; }
    .wo-card:active { cursor: grabbing; }
    .wo-card.status-in_progress { border-left-color: var(--accent-primary); }
    .wo-card.status-waiting { border-left-color: #eab308; }
    .wo-card.status-completed { border-left-color: #22c55e; }
    .wo-card.status-urgent { border-left-color: #ef4444; }
    .wo-card.fleet::after { content: 'FLEET'; position: absolute; top: 6px; right: 6px; font-size: 7px; font-weight: 700; padding: 2px 4px; border-radius: 3px; background: #14b8a6; color: white; }
    .wo-card.dragging { opacity: 0.5; transform: scale(0.95); touch-action: none; }
    .card-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .card-customer { font-size: 14px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 35px; }
    .card-info-row { display: flex; align-items: center; gap: 6px; }
    .card-vehicle { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; }
    .card-dot { width: 3px; height: 3px; border-radius: 50%; background: var(--text-secondary); }
    .card-status { font-size: 9px; font-weight: 600; text-transform: uppercase; padding: 2px 5px; border-radius: 4px; }
    .card-status.in_progress { background: rgba(59,130,246,0.2); color: var(--accent-light); }
    .card-status.waiting { background: rgba(234,179,8,0.15); color: #eab308; }
    .card-status.completed { background: rgba(34,197,94,0.15); color: #22c55e; }
    .card-status.urgent { background: rgba(239,68,68,0.15); color: #ef4444; }
    .card-status.scheduled { background: var(--bg-hover); color: var(--text-secondary); }
    .card-status.confirmed { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .card-status.event { background: rgba(249,115,22,0.2); color: #f97316; }
    .card-amount { font-size: 12px; font-weight: 700; margin-left: auto; }
    .add-card { flex-shrink: 0; width: 70px; min-height: 60px; background: var(--bg-primary); border-radius: 10px; border: 2px dashed var(--border-default); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; }
    .add-card-icon { width: 22px; height: 22px; border-radius: 6px; background: var(--bg-hover); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--text-secondary); }
    .add-card span { font-size: 9px; color: var(--text-secondary); }
    .card-details-btn { position: absolute; bottom: 8px; right: 8px; padding: 4px 8px; font-size: 10px; font-weight: 600; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
    .wo-card:hover .card-details-btn { opacity: 1; }
    .stack-container { padding: 12px; display: flex; flex-direction: column; gap: 0; }
    .stack-section { }
    .stack-section.collapsed .stack-section-content { display: none; }
    .stack-section .stack-expand-icon { float: right; font-size: 10px; }
    .stack-section-content { }
    .stack-section-header { margin-top: 8px; border-radius: 8px 8px 0 0; }
    .stack-section-header:first-child { margin-top: 0; }
    .stack-section-header.drop-target { background: color-mix(in srgb, var(--accent-primary) 30%, transparent) !important; }
    .stack-drop-zone { cursor: pointer; transition: background 0.2s; }
    .stack-card { background: var(--bg-card); border-radius: 0; border: 1px solid var(--border-default); border-top: none; border-left: 4px solid var(--accent-primary); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: relative; cursor: grab; }
    .stack-card:active { cursor: grabbing; }
    .stack-card:last-child { border-radius: 0 0 8px 8px; margin-bottom: 8px; }
    .stack-card.status-in_progress { border-left-color: var(--accent-primary); }
    .stack-card.status-waiting { border-left-color: #eab308; }
    .stack-card.status-completed { border-left-color: #22c55e; }
    .stack-card.status-urgent { border-left-color: #ef4444; }
    .stack-card-left { flex: 1; }
    .stack-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .stack-customer { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .stack-vehicle { font-size: 12px; color: var(--text-secondary); }
    .stack-org { font-size: 11px; color: var(--text-secondary); }
    .stack-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; padding-right: 60px; }
    .stack-assignee { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
    .stack-card:hover .card-details-btn { opacity: 1; }
    .stack-card .card-details-btn { opacity: 0.7; position: relative; bottom: auto; right: auto; }
    .grid-container { padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    
    /* Calendar Grid View */
    .calendar-container { padding: 12px; }
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-header-day { text-align: center; font-size: 11px; font-weight: 600; color: var(--text-secondary); padding: 8px 4px; text-transform: uppercase; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 8px; min-height: 80px; padding: 6px; cursor: pointer; transition: all 0.2s; }
    .calendar-day:hover { border-color: var(--accent-primary); }
    .calendar-day.today { border-color: var(--accent-primary); background: color-mix(in srgb, var(--accent-primary) 10%, var(--bg-card)); }
    .calendar-day.selected { border-color: var(--accent-light); border-width: 2px; }
    .calendar-day.other-month { opacity: 0.4; }
    .calendar-day-num { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
    .calendar-day.today .calendar-day-num { color: var(--accent-light); }
    .calendar-dots { display: flex; flex-wrap: wrap; gap: 3px; }
    .calendar-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .calendar-dot.event { border: 1px solid var(--text-secondary); background: transparent; }
    .calendar-dot.appt { background: var(--accent-primary); }
    .calendar-dot.emp-0 { background: #3b82f6; }
    .calendar-dot.emp-1 { background: #22c55e; }
    .calendar-dot.emp-2 { background: #f97316; }
    .calendar-dot.emp-3 { background: #8b5cf6; }
    .calendar-dot.emp-4 { background: #ec4899; }
    .calendar-dot.emp-5 { background: #14b8a6; }
    .calendar-dot.emp-6 { background: #eab308; }
    .calendar-dot.emp-7 { background: #ef4444; }
    .calendar-dot.emp-8 { background: #6366f1; }
    .calendar-dot.emp-9 { background: #84cc16; }
    .calendar-dot.unassigned { background: var(--text-secondary); }
    .calendar-more { font-size: 9px; color: var(--text-secondary); margin-top: 2px; }
    .calendar-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
    .calendar-nav-btn { background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; }
    .calendar-nav-btn:active { background: var(--bg-hover); }
    .calendar-month-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    
    /* Event card styling */
    .wo-card.event-card, .stack-card.event-card, .grid-card.event-card { border-left: 3px solid #f97316; }
    .event-badge { display: inline-block; background: #f97316; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 6px; }
    .appt-badge { display: inline-block; background: var(--accent-primary); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 6px; }
    .card-org { font-size: 11px; color: var(--text-secondary); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-cost { font-size: 12px; color: #22c55e; font-weight: 600; }
    .card-type { font-size: 11px; color: var(--accent-light); }
    .card-stage { font-size: 11px; color: var(--text-secondary); }
    .grid-card { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border-default); border-left: 4px solid var(--accent-primary); padding: 12px 16px 40px 16px; position: relative; }
    .grid-card.status-in_progress { border-left-color: var(--accent-primary); }
    .grid-card.status-waiting { border-left-color: #eab308; }
    .grid-card.status-completed { border-left-color: #22c55e; }
    .grid-card.status-urgent { border-left-color: #ef4444; }
    .grid-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .grid-time { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .grid-customer { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .grid-vehicle { font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; }
    .grid-card-footer { display: flex; justify-content: space-between; align-items: center; }
    .grid-assignee { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
    .grid-amount { font-size: 14px; font-weight: 700; }
    .grid-card:hover .card-details-btn { opacity: 1; }
    .tech-avatar.small { width: 24px; height: 24px; font-size: 10px; border-radius: 6px; }
    .drag-ghost { position: fixed; z-index: 1001; pointer-events: none; opacity: 0.9; transform: scale(1.05) rotate(2deg); box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state-text { font-size: 16px; }
    
    /* Mobile Bottom Nav - Matching contacts page style */
    .mobile-bottom-nav { 
      display: none; 
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      background: var(--bg-secondary); 
      padding: 8px; 
      z-index: 100; 
      border-top: 1px solid var(--border-default); 
    }
    .mobile-nav-row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 6px; 
      margin-bottom: 6px; 
    }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { 
      padding: 10px 8px; 
      border-radius: 8px; 
      border: 1px solid var(--border-default); 
      background: var(--bg-card); 
      color: var(--text-secondary); 
      font-size: 12px; 
      font-weight: 600; 
      cursor: pointer; 
      text-decoration: none; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      min-height: 44px; 
      -webkit-appearance: none;
    }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { 
      background: color-mix(in srgb, var(--accent-primary) 60%, transparent); 
      border-color: var(--accent-primary); 
      color: var(--text-primary); 
    }
    .mobile-nav-btn.action-btn { 
      background: color-mix(in srgb, var(--accent-primary) 20%, transparent); 
      border-color: color-mix(in srgb, var(--accent-primary) 50%, transparent); 
      color: var(--accent-light); 
      font-size: 14px; 
    }
    
    .toast { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--accent-primary); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 1000; display: none; }
    .toast.show { display: block; animation: toastIn 0.3s ease; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 2000; align-items: flex-end; justify-content: center; padding: 0; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 0; line-height: 1; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
    .modal-close:active { background: var(--bg-hover); }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-label .required { color: #ef4444; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 16px; -webkit-appearance: none; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .search-container { position: relative; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 10px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
    .search-results.show { display: block; }
    .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-default); }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:active { background: var(--bg-hover); }
    .search-result-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .search-result-sub { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .search-result-new { display: flex; align-items: center; gap: 8px; color: var(--accent-light); }
    .search-result-new .plus-icon { width: 20px; height: 20px; border-radius: 50%; background: var(--accent-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
    .selected-chip { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--accent-primary); border-radius: 10px; }
    .selected-chip-info { flex: 1; }
    .selected-chip-name { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .selected-chip-sub { font-size: 12px; color: var(--text-secondary); }
    .selected-chip-remove { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 4px; }
    .modal-footer { padding: 16px 20px 24px; border-top: 1px solid var(--border-default); }
    .modal-footer-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .btn-primary { padding: 14px 12px; border-radius: 12px; border: none; background: var(--accent-primary); color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-primary:active { opacity: 0.9; transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-secondary:active { background: var(--bg-hover); }
    .btn-danger { padding: 14px 12px; border-radius: 12px; border: 1px solid #ef4444; background: rgba(239,68,68,0.15); color: #ef4444; font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-danger:active { background: rgba(239,68,68,0.25); }
    .btn-outline { padding: 14px 12px; border-radius: 12px; border: 1px solid var(--accent-primary); background: transparent; color: var(--accent-light); font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-outline:active { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); }
    .new-fields { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-top: 12px; border: 1px solid var(--border-default); }
    .new-fields .form-group { margin-bottom: 16px; }
    .new-fields .form-group:last-child { margin-bottom: 0; }
    .btn-loading { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Responsive - show mobile nav on mobile only */
    @media (max-width: 768px) {
      .mobile-bottom-nav { display: block; }
    }
    @media (min-width: 769px) {
      .mobile-bottom-nav { display: none; }
      body { padding-bottom: 20px; }
    }
    
    @supports not (background: color-mix(in srgb, red 50%, blue)) {
      .mobile-nav-btn.active { background: var(--accent-primary); }
      .mobile-nav-btn.action-btn { background: var(--bg-hover); }
      .lanes-filter-btn.active { background: var(--bg-hover); }
      .expand-toggle-btn.expanded { background: var(--accent-primary); }
    }
  </style>
</head>
<body>
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span class="accordion-icon-header">☰</span></button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Scheduler</div>
      <div class="business-name" id="businessName">Scheduler</div>
    </div>
    <div class="view-style-toggle">
      <button class="view-style-btn active" id="styleLanes" onclick="setViewStyle('lanes')">Lanes</button>
      <button class="view-style-btn" id="styleStack" onclick="setViewStyle('stack')">Stack</button>
      <button class="view-style-btn" id="styleGrid" onclick="setViewStyle('grid')">Grid</button>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions" style="grid-template-columns: repeat(3, 1fr);">
      <button onclick="location.href='dashboard-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
      <button onclick="location.href='account.html'">Account</button>
    </div>
  </div>
</div>
<!-- Single department - no tabs needed -->
<div class="date-nav-container" id="lanesDateNav">
  <div class="lanes-date-nav">
    <div class="lanes-controls-row" id="lanesControlsRow"></div>
    <div class="lanes-date-chips" id="lanesDateChips"></div>
  </div>
</div>
<div class="edge-indicator left" id="edgeLeft"><span class="edge-arrow">◀</span><div class="date-preview" id="edgeLeftPreview"></div></div>
<div class="edge-indicator right" id="edgeRight"><span class="edge-arrow">▶</span><div class="date-preview" id="edgeRightPreview"></div></div>
<div class="content-area" id="contentArea" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
  <div class="swipe-page current" id="currentPage"></div>
  <div class="swipe-page prev" id="prevPage"></div>
  <div class="swipe-page next" id="nextPage"></div>
</div>

<!-- Quick Work Order Modal -->
<div class="modal-overlay" id="quickWOModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Quick Work Order</div>
      <button class="modal-close" onclick="closeQuickWOModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Customer <span class="required">*</span></label>
        <div id="woCustomerSelected" style="display:none;"></div>
        <div class="search-container" id="woCustomerSearchContainer">
          <input type="text" class="form-input" id="woCustomerSearch" placeholder="Search by name or phone..." oninput="searchWOCustomers(this.value)" autocomplete="off">
          <div class="search-results" id="woCustomerResults"></div>
        </div>
        <div class="new-fields" id="woNewCustomerFields" style="display:none;">
          <div class="form-row">
            <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="woNewFirstName" placeholder="First name"></div>
            <div class="form-group"><label class="form-label">Last Name <span class="required">*</span></label><input type="text" class="form-input" id="woNewLastName" placeholder="Last name"></div>
          </div>
          <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="woNewPhone" placeholder="(555) 123-4567"></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Vehicle <span class="required">*</span></label>
        <div id="woVehicleSelected" style="display:none;"></div>
        <div class="search-container" id="woVehicleSearchContainer">
          <input type="text" class="form-input" id="woVehicleSearch" placeholder="Search or enter Year Make Model..." oninput="searchWOVehicles(this.value)" autocomplete="off">
          <div class="search-results" id="woVehicleResults"></div>
        </div>
        <div class="new-fields" id="woNewVehicleFields" style="display:none;">
          <div class="form-row">
            <div class="form-group"><label class="form-label">Year</label><input type="text" class="form-input" id="woNewVehYear" placeholder="2024" maxlength="4"></div>
            <div class="form-group"><label class="form-label">Make</label><input type="text" class="form-input" id="woNewVehMake" placeholder="Toyota"></div>
          </div>
          <div class="form-group"><label class="form-label">Model</label><input type="text" class="form-input" id="woNewVehModel" placeholder="Camry"></div>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Service Needed</label><textarea class="form-textarea" id="woDescription" placeholder="Brief description of service needed..."></textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="woDate"></div>
        <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="woTime" value="09:00"></div>
      </div>
      <div class="form-group"><label class="form-label">Assign Technician</label><select class="form-select" id="woTechnician"><option value="">-- Unassigned --</option></select></div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-buttons">
        <button class="btn-primary" id="woCreateBtn" onclick="createQuickWorkOrder()"><span id="woCreateText">Set Appt</span><span id="woCreateLoading" class="btn-loading" style="display:none;"></span></button>
        <button class="btn-outline" onclick="editWOCustomerProfile()">Edit Profile</button>
        <button class="btn-secondary" onclick="closeQuickWOModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Quick Appointment Modal -->
<div class="modal-overlay" id="quickApptModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Quick Appointment</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <button class="btn-outline" id="apptNewCustomerBtn" style="padding:8px 12px;font-size:12px;" onclick="showNewApptCustomerFields()">+ New</button>
        <button class="modal-close" onclick="closeQuickApptModal()">&times;</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Contact <span class="required">*</span></label>
        <div id="apptCustomerSelected" style="display:none;"></div>
        <div class="search-container" id="apptCustomerSearchContainer">
          <input type="text" class="form-input" id="apptCustomerSearch" placeholder="Search by name or phone..." oninput="searchApptCustomers(this.value)" autocomplete="off">
          <div class="search-results" id="apptCustomerResults"></div>
        </div>
        <div class="new-fields" id="apptNewCustomerFields" style="display:none;">
          <div class="form-group"><label class="form-label">Contact Name <span class="required">*</span></label><input type="text" class="form-input" id="apptCustomerName" placeholder="Full name"></div>
          <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="apptOrganization" placeholder="Company or organization name"></div>
          <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="apptPhone" placeholder="(555) 123-4567"></div>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="apptOrgField" placeholder="Organization name"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date <span class="required">*</span></label><input type="date" class="form-input" id="apptDate"></div>
        <div class="form-group"><label class="form-label">Time <span class="required">*</span></label><input type="time" class="form-input" id="apptTime" value="10:00"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Funnel Stage</label>
          <select class="form-select" id="apptType">
            <option value="1st Contact">1st Contact</option>
            <option value="Receive Artwork">Receive Artwork</option>
            <option value="Opt-in Contact">Opt-in Contact</option>
            <option value="Deliver Pop Up">Deliver Pop Up</option>
            <option value="Lead">Lead</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Client Type</label>
          <select class="form-select" id="apptClientType">
            <option value="">-- Select --</option>
            <option value="RC">RC</option>
            <option value="HOG">HOG</option>
            <option value="Independent">Independent</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Assign To</label><select class="form-select" id="apptSalesperson"><option value="">-- Unassigned --</option></select></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="apptNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-buttons" id="apptFooterButtons">
        <button class="btn-primary" id="apptCreateBtn" onclick="createQuickAppointment()"><span id="apptCreateText">Set Appt</span><span id="apptCreateLoading" class="btn-loading" style="display:none;"></span></button>
        <button class="btn-outline" onclick="editApptCustomerProfile()">Edit Profile</button>
        <button class="btn-secondary" onclick="closeQuickApptModal()">Cancel</button>
      </div>
      <div class="modal-footer-buttons" id="apptEditFooterButtons" style="display:none;">
        <button class="btn-primary" id="apptSaveBtn" onclick="createQuickAppointment()"><span id="apptSaveText">Save Changes</span><span id="apptSaveLoading" class="btn-loading" style="display:none;"></span></button>
        <button class="btn-outline" onclick="editApptCustomerProfile()">Edit Profile</button>
        <button class="btn-secondary" style="background:rgba(239,68,68,0.15);border-color:#ef4444;color:#ef4444;" onclick="deleteAppointment()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- New Event Modal -->
<div class="modal-overlay" id="newEventModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="eventModalTitle">New Event</div>
      <button class="modal-close" onclick="closeNewEventModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Event Title <span class="required">*</span></label><input type="text" class="form-input" id="eventTitle" placeholder="Event name"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="eventOrganization" placeholder="Hosting organization"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date <span class="required">*</span></label><input type="date" class="form-input" id="eventDate"></div>
        <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="eventTime" value="10:00"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Event Type</label>
        <select class="form-select" id="eventType">
          <option value="">-- Select --</option>
          <option value="Open House">Open House</option>
          <option value="Bike Night">Bike Night</option>
          <option value="Run">Run</option>
          <option value="Party">Party</option>
          <option value="Fundraiser">Fundraiser</option>
          <option value="Support">Support</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ticket Price</label><input type="number" class="form-input" id="eventTicketPrice" placeholder="0.00" step="0.01" min="0"></div>
        <div class="form-group"><label class="form-label">Expected Attendance</label><input type="number" class="form-input" id="eventAttendance" placeholder="0" min="0"></div>
      </div>
      <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="eventLocation" placeholder="Event location"></div>
      <div class="form-group"><label class="form-label">Assign To</label><select class="form-select" id="eventAssignment"><option value="">-- Unassigned --</option></select></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="eventNotes" placeholder="Event details..."></textarea></div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-buttons" id="eventCreateFooter" style="grid-template-columns: 1fr 1fr;">
        <button class="btn-primary" onclick="saveNewEvent()">Create Event</button>
        <button class="btn-secondary" onclick="closeNewEventModal()">Cancel</button>
      </div>
      <div class="modal-footer-buttons" id="eventEditFooter" style="grid-template-columns: 1fr 1fr 1fr; display: none;">
        <button class="btn-primary" onclick="saveNewEvent()">Save</button>
        <button class="btn-danger" onclick="deleteEvent()">Delete</button>
        <button class="btn-secondary" onclick="closeNewEventModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- New Contact Modal -->
<div class="modal-overlay" id="newContactModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">New Contact</div>
      <button class="modal-close" onclick="closeNewContactModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="contactFirstName" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name <span class="required">*</span></label><input type="text" class="form-input" id="contactLastName" placeholder="Last name"></div>
      </div>
      <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="contactPhone" placeholder="(555) 123-4567"></div>
      <div class="form-group"><label class="form-label">Email</label><input type="text" class="form-input" id="contactEmail" placeholder="email@example.com"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="contactOrganization" placeholder="Organization name"></div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Client Type</label>
          <select class="form-select" id="contactClientType">
            <option value="">-- Select --</option>
            <option value="RC">RC</option>
            <option value="HOG">HOG</option>
            <option value="Independent">Independent</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Funnel Stage</label>
          <select class="form-select" id="contactStage">
            <option value="1">1st Contact</option>
            <option value="2">Receive Artwork</option>
            <option value="3">Opt-in Contact</option>
            <option value="4">Deliver Pop Up</option>
            <option value="5">Lead</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="contactNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-buttons" style="grid-template-columns: 1fr 1fr;">
        <button class="btn-primary" onclick="saveNewContact()">Add Contact</button>
        <button class="btn-secondary" onclick="closeNewContactModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Bottom Nav - Matching contacts page style -->
<nav class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn active">Scheduler</a>
  </div>
  <div class="mobile-nav-row three-col">
    <button class="mobile-nav-btn action-btn" onclick="openNewEventModal()">+ Event</button>
    <button class="mobile-nav-btn action-btn" onclick="openNewContactModal()">+ Contact</button>
    <button class="mobile-nav-btn action-btn" onclick="openQuickApptModal()">+ Appointment</button>
  </div>
</nav>

<div class="toast" id="toast"></div>
<script>
var SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// UI Preset variables
var uiPreset = null;
var tenantData = null;

var tenantId=null,technicians=[],salespeople=[],serviceJobs=[],fleetJobs=[],salesJobs=[],allEvents=[],allCustomers=[],allVehicles=[];
var currentTab='sales',currentViewStyle='lanes',selectedDate=0,currentFilter='all',lanesExpanded=false,isAnimating=false;
var calendarMonth=new Date(); // Track current month for calendar view
var woSelectedCustomer=null,woSelectedVehicle=null,woIsNewCustomer=false,woIsNewVehicle=false;
var lastCreatedCustomerId=null;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);}loadTheme();
var savedExpand=localStorage.getItem('lanes-expanded');if(savedExpand==='true')lanesExpanded=true;
var savedStyle=localStorage.getItem('scheduler-view-style');if(savedStyle&&['lanes','stack','grid'].indexOf(savedStyle)!==-1)currentViewStyle=savedStyle;
function toggleMobileMenu(b){document.getElementById('mobileHeaderContent').classList.toggle('expanded');b.classList.toggle('active');}
async function checkAuth(){var s=null;try{var r=await sb.auth.getSession();s=r.data.session;}catch(e){}if(!s){var t=localStorage.getItem('sb_access_token'),rt=localStorage.getItem('sb_refresh_token');if(t&&rt){try{var r=await sb.auth.setSession({access_token:t,refresh_token:rt});if(r.data&&r.data.session)return r.data.session;}catch(e){}}window.location.href='login.html';return null;}return s;}

async function loadBusinessSettings(){
  try{
    var r=await sb.from('business_settings').select('*').single();
    console.log('Business settings result:', r);
    if(r.error){
      document.getElementById('businessName').textContent='My Business';
      return;
    }
    if(r.data){
      tenantId=r.data.tenant_id;
      console.log('Tenant ID set to:', tenantId);
      document.getElementById('businessName').textContent=r.data.business_name||r.data.company_name||'My Business';
    }
  }catch(e){
    console.error('Error loading business settings:', e);
    document.getElementById('businessName').textContent='My Business';
  }
}

async function loadAllData(){if(!tenantId)return;try{await Promise.all([loadTechnicians(),loadSalespeople(),loadCustomersForSearch(),loadVehiclesForSearch(),loadEvents()]);await loadServiceJobs();await loadSalesJobs();renderAll();}catch(e){console.error('Error loading data:', e);}}
async function loadEvents(){var today=new Date(),startDate=new Date(today),endDate=new Date(today);startDate.setDate(startDate.getDate()-7);endDate.setDate(endDate.getDate()+90);try{var r=await sb.from('events').select('*').eq('tenant_id',tenantId).gte('event_date',startDate.toISOString().split('T')[0]).lte('event_date',endDate.toISOString().split('T')[0]).order('event_date',{ascending:true});if(r.error){console.error('Events load error:', r.error);return;}if(r.data&&r.data.length>0){allEvents=r.data.map(function(e){var ed=new Date(e.event_date+'T00:00:00'),ts=new Date(today.getFullYear(),today.getMonth(),today.getDate()),off=Math.round((ed-ts)/(1000*60*60*24));var tid='unassigned';if(e.assigned_to){var f=salespeople.find(function(sp){return sp.name===e.assigned_to;});if(f)tid=f.id;}return{id:e.event_id,customer:e.event_name||'Event',organization:e.description||'',time:formatTime(e.event_time)||'All Day',status:'event',tech:tid,date:off,isEvent:true,eventType:e.event_type,location:e.location,notes:e.notes,cost:e.estimated_cost?'$'+parseFloat(e.estimated_cost).toFixed(2):''};});}else{allEvents=[];}}catch(e){console.error('Events load exception:', e);allEvents=[];}}
async function loadCustomersForSearch(){try{var r=await sb.from('customers').select('customer_id,full_name,phone,email,organization_name,company').eq('tenant_id',tenantId).order('full_name',{ascending:true}).limit(500);if(r.data)allCustomers=r.data;}catch(e){}}
async function loadVehiclesForSearch(){try{var r=await sb.from('vehicles').select('vehicle_id,customer_id,year,make,model,vin,license_plate').eq('tenant_id',tenantId).order('year',{ascending:false}).limit(500);if(r.data)allVehicles=r.data;}catch(e){}}
async function loadTechnicians(){try{var r=await sb.from('employees').select('*').eq('tenant_id',tenantId).eq('is_active',true);if(r.data&&r.data.length>0){technicians=r.data.map(function(e,i){var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown';var ini='??';if(e.first_name&&e.last_name)ini=(e.first_name[0]+e.last_name[0]).toUpperCase();return{id:e.employee_id,name:n,role:formatRole(e.role),initials:ini,color:getColorForIndex(i)};});console.log('Loaded technicians:', technicians.length);}}catch(e){console.error('Error loading technicians:', e);}technicians.push({id:'unassigned',name:'Unassigned',role:'Drag to assign',initials:'?',color:'purple'});populateTechnicianDropdown();}
function populateTechnicianDropdown(){var s=document.getElementById('woTechnician');s.innerHTML='<option value="">-- Unassigned --</option>';technicians.forEach(function(t){if(t.id!=='unassigned')s.innerHTML+='<option value="'+t.id+'">'+t.name+'</option>';});}
async function loadSalespeople(){try{console.log('Loading salespeople for tenant:', tenantId);var r=await sb.from('employees').select('*').eq('tenant_id',tenantId).eq('is_active',true);console.log('Employees query result:', r);if(r.data&&r.data.length>0){salespeople=r.data.map(function(e,i){var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||'Unknown';var ini='??';if(e.first_name&&e.last_name)ini=(e.first_name[0]+e.last_name[0]).toUpperCase();return{id:e.employee_id,name:n,role:formatRole(e.role),initials:ini,color:getColorForIndex(i)};});console.log('Salespeople loaded:', salespeople.length);}}catch(e){console.error('Error loading employees:',e);}salespeople.push({id:'unassigned',name:'Unassigned',role:'Drag to assign',initials:'?',color:'purple'});populateSalespersonDropdown();}
function populateSalespersonDropdown(){var s=document.getElementById('apptSalesperson');s.innerHTML='<option value="">-- Unassigned --</option>';salespeople.forEach(function(sp){if(sp.id!=='unassigned')s.innerHTML+='<option value="'+sp.id+'">'+sp.name+'</option>';});}
function formatRole(r){if(!r)return'Staff';return r.replace(/_/g,' ').replace(/\b\w/g,function(l){return l.toUpperCase();});}
async function loadServiceJobs(){var today=new Date(),startDate=new Date(today),endDate=new Date(today);startDate.setDate(startDate.getDate()-7);endDate.setDate(endDate.getDate()+60);try{var r=await sb.from('work_orders').select('*').eq('tenant_id',tenantId).eq('deleted',false).gte('scheduled_start',startDate.toISOString()).lte('scheduled_start',endDate.toISOString()).order('scheduled_start',{ascending:true});if(r.error)return;if(r.data&&r.data.length>0){var cids=[...new Set(r.data.map(function(w){return w.customer_id;}).filter(Boolean))];var vids=[...new Set(r.data.map(function(w){return w.vehicle_id;}).filter(Boolean))];var cm={};if(cids.length>0){var cr=await sb.from('customers').select('customer_id,full_name').in('customer_id',cids);if(cr.data)cr.data.forEach(function(c){cm[c.customer_id]=c.full_name;});}var vm={};if(vids.length>0){var vr=await sb.from('vehicles').select('vehicle_id,make,model,year').in('vehicle_id',vids);if(vr.data)vr.data.forEach(function(v){vm[v.vehicle_id]=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');});}var nfj=r.data.filter(function(w){return!w.fleet_id;});serviceJobs=nfj.map(function(w){var jd=new Date(w.scheduled_start),ts=new Date(today.getFullYear(),today.getMonth(),today.getDate()),js=new Date(jd.getFullYear(),jd.getMonth(),jd.getDate()),off=Math.round((js-ts)/(1000*60*60*24));return{id:w.work_order_id,wo_number:w.wo_number,customer:cm[w.customer_id]||'WO #'+w.wo_number,vehicle:(vm[w.vehicle_id]||w.summary||'Service').trim(),time:formatTimeFromTimestamp(w.scheduled_start),status:mapStatus(w.status),tech:w.assigned_employee_id||'unassigned',amount:formatAmount(w.grand_total),date:off,fleet:false,priority:w.priority};});var fjs=r.data.filter(function(w){return w.fleet_id;});var fids=[...new Set(fjs.map(function(w){return w.fleet_id;}).filter(Boolean))];var fm={};if(fids.length>0){var fr=await sb.from('fleets').select('fleet_id,fleet_name').in('fleet_id',fids);if(fr.data)fr.data.forEach(function(f){fm[f.fleet_id]=f.fleet_name;});}fleetJobs=fjs.map(function(w){var jd=new Date(w.scheduled_start),ts=new Date(today.getFullYear(),today.getMonth(),today.getDate()),js=new Date(jd.getFullYear(),jd.getMonth(),jd.getDate()),off=Math.round((js-ts)/(1000*60*60*24));return{id:w.work_order_id,wo_number:w.wo_number,customer:fm[w.fleet_id]||'Fleet WO #'+w.wo_number,vehicle:(vm[w.vehicle_id]||w.summary||'Fleet Service').trim(),time:formatTimeFromTimestamp(w.scheduled_start),status:mapStatus(w.status),tech:w.assigned_employee_id||'unassigned',amount:formatAmount(w.grand_total),date:off,fleet:true,priority:w.priority};});}}catch(e){}}
async function loadSalesJobs(){var today=new Date(),startDate=new Date(today),endDate=new Date(today);startDate.setDate(startDate.getDate()-7);endDate.setDate(endDate.getDate()+60);try{var r=await sb.from('sales_appointments').select('*').eq('tenant_id',tenantId).gte('appointment_date',startDate.toISOString().split('T')[0]).lte('appointment_date',endDate.toISOString().split('T')[0]).order('appointment_date',{ascending:true});if(r.error)return;if(r.data&&r.data.length>0){salesJobs=r.data.map(function(a){var ad=new Date(a.appointment_date+'T00:00:00'),ts=new Date(today.getFullYear(),today.getMonth(),today.getDate()),off=Math.round((ad-ts)/(1000*60*60*24));var tid='unassigned';if(a.assigned_to){var f=salespeople.find(function(sp){return sp.name===a.assigned_to||sp.id===a.assigned_to;});if(f)tid=f.id;}return{id:a.appointment_id,customer:a.customer_name||'Unknown',organization:a.organization||'',time:formatTime(a.appointment_time),status:mapStatus(a.status),tech:tid,date:off,fleet:false,appointmentType:a.appointment_type||'',funnelStage:a.appointment_type||''};});}}catch(e){}}
function formatTimeFromTimestamp(ts){if(!ts)return'TBD';try{var d=new Date(ts),h=d.getHours(),m=d.getMinutes().toString().padStart(2,'0'),ap=h>=12?'PM':'AM';h=h%12||12;return h+':'+m+' '+ap;}catch(e){return'TBD';}}
function getColorForIndex(i){var c=['','green','orange','purple','','green','orange'];return c[i%c.length];}
function formatTime(ts){if(!ts)return'TBD';try{var p=ts.split(':'),h=parseInt(p[0]),m=p[1]||'00',ap=h>=12?'PM':'AM';h=h%12||12;return h+':'+m+' '+ap;}catch(e){return ts;}}
function formatAmount(a){if(!a&&a!==0)return'TBD';var n=parseFloat(a);if(isNaN(n))return'TBD';return'$'+n.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});}
function mapStatus(s){if(!s)return'scheduled';var l=s.toLowerCase();if(l==='in_progress'||l==='in progress'||l==='active')return'in_progress';if(l==='parts_on_order'||l==='waiting'||l==='waiting for parts'||l==='parts')return'waiting';if(l==='completed'||l==='complete'||l==='done'||l==='invoiced')return'completed';if(l==='urgent'||l==='priority'||l==='rush')return'urgent';if(l==='confirmed')return'confirmed';return'scheduled';}
function openQuickWOModal(){woSelectedCustomer=null;woSelectedVehicle=null;woIsNewCustomer=false;woIsNewVehicle=false;lastCreatedCustomerId=null;document.getElementById('woCustomerSearch').value='';document.getElementById('woVehicleSearch').value='';document.getElementById('woDescription').value='';document.getElementById('woTechnician').value='';document.getElementById('woCustomerSelected').style.display='none';document.getElementById('woCustomerSearchContainer').style.display='block';document.getElementById('woNewCustomerFields').style.display='none';document.getElementById('woVehicleSelected').style.display='none';document.getElementById('woVehicleSearchContainer').style.display='block';document.getElementById('woNewVehicleFields').style.display='none';var td=new Date();td.setDate(td.getDate()+selectedDate);document.getElementById('woDate').value=td.toISOString().split('T')[0];document.getElementById('quickWOModal').classList.add('active');}
function closeQuickWOModal(){document.getElementById('quickWOModal').classList.remove('active');}
function editWOCustomerProfile(){if(woSelectedCustomer&&woSelectedCustomer.customer_id){window.location.href='customer-profile.html?id='+woSelectedCustomer.customer_id;}else{showToast('Select a customer first');}}
var woSearchTimeout=null;
function searchWOCustomers(q){clearTimeout(woSearchTimeout);var rd=document.getElementById('woCustomerResults');if(q.length<2){rd.classList.remove('show');return;}woSearchTimeout=setTimeout(function(){var ql=q.toLowerCase();var m=allCustomers.filter(function(c){return(c.full_name&&c.full_name.toLowerCase().includes(ql))||(c.phone&&c.phone.includes(q));}).slice(0,5);var h='';m.forEach(function(c){h+='<div class="search-result-item" onclick="selectWOCustomer(\''+c.customer_id+'\')"><div class="search-result-name">'+(c.full_name||'Unknown')+'</div><div class="search-result-sub">'+(c.phone||'No phone')+'</div></div>';});h+='<div class="search-result-item" onclick="showNewCustomerFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Customer</div></div>';rd.innerHTML=h;rd.classList.add('show');},200);}
function selectWOCustomer(cid){var c=allCustomers.find(function(x){return x.customer_id===cid;});if(!c)return;woSelectedCustomer=c;woIsNewCustomer=false;document.getElementById('woCustomerResults').classList.remove('show');document.getElementById('woCustomerSearchContainer').style.display='none';document.getElementById('woNewCustomerFields').style.display='none';document.getElementById('woCustomerSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+(c.full_name||'Unknown')+'</div><div class="selected-chip-sub">'+(c.phone||'No phone')+'</div></div><button class="selected-chip-remove" onclick="clearWOCustomer()">&times;</button></div>';document.getElementById('woCustomerSelected').style.display='block';loadVehiclesForCustomer(cid);}
function clearWOCustomer(){woSelectedCustomer=null;woIsNewCustomer=false;document.getElementById('woCustomerSelected').style.display='none';document.getElementById('woCustomerSearchContainer').style.display='block';document.getElementById('woCustomerSearch').value='';clearWOVehicle();}
function showNewCustomerFields(){woIsNewCustomer=true;woSelectedCustomer=null;document.getElementById('woCustomerResults').classList.remove('show');document.getElementById('woCustomerSearchContainer').style.display='none';document.getElementById('woNewCustomerFields').style.display='block';var sq=document.getElementById('woCustomerSearch').value.trim().split(' ');if(sq.length>=2){document.getElementById('woNewFirstName').value=sq[0];document.getElementById('woNewLastName').value=sq.slice(1).join(' ');}else if(sq.length===1){document.getElementById('woNewFirstName').value=sq[0];}document.getElementById('woNewFirstName').focus();}
function loadVehiclesForCustomer(cid){var cv=allVehicles.filter(function(v){return v.customer_id===cid;});if(cv.length===1){selectWOVehicle(cv[0].vehicle_id);}else if(cv.length>1){var rd=document.getElementById('woVehicleResults'),h='';cv.forEach(function(v){var vl=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');h+='<div class="search-result-item" onclick="selectWOVehicle(\''+v.vehicle_id+'\')"><div class="search-result-name">'+vl.trim()+'</div><div class="search-result-sub">'+(v.license_plate||v.vin||'')+'</div></div>';});h+='<div class="search-result-item" onclick="showNewVehicleFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Vehicle</div></div>';rd.innerHTML=h;rd.classList.add('show');}}
var woVehSearchTimeout=null;
function searchWOVehicles(q){clearTimeout(woVehSearchTimeout);var rd=document.getElementById('woVehicleResults');if(q.length<2){rd.classList.remove('show');return;}woVehSearchTimeout=setTimeout(function(){var ql=q.toLowerCase();var m=allVehicles.filter(function(v){var l=((v.year||'')+' '+(v.make||'')+' '+(v.model||'')).toLowerCase();return l.includes(ql)||(v.vin&&v.vin.toLowerCase().includes(ql))||(v.license_plate&&v.license_plate.toLowerCase().includes(ql));}).slice(0,5);var h='';m.forEach(function(v){var vl=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');h+='<div class="search-result-item" onclick="selectWOVehicle(\''+v.vehicle_id+'\')"><div class="search-result-name">'+vl.trim()+'</div><div class="search-result-sub">'+(v.license_plate||v.vin||'')+'</div></div>';});h+='<div class="search-result-item" onclick="showNewVehicleFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Vehicle</div></div>';rd.innerHTML=h;rd.classList.add('show');},200);}
function selectWOVehicle(vid){var v=allVehicles.find(function(x){return x.vehicle_id===vid;});if(!v)return;woSelectedVehicle=v;woIsNewVehicle=false;document.getElementById('woVehicleResults').classList.remove('show');document.getElementById('woVehicleSearchContainer').style.display='none';document.getElementById('woNewVehicleFields').style.display='none';var vl=(v.year||'')+' '+(v.make||'')+' '+(v.model||'');document.getElementById('woVehicleSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+vl.trim()+'</div><div class="selected-chip-sub">'+(v.license_plate||v.vin||'')+'</div></div><button class="selected-chip-remove" onclick="clearWOVehicle()">&times;</button></div>';document.getElementById('woVehicleSelected').style.display='block';}
function clearWOVehicle(){woSelectedVehicle=null;woIsNewVehicle=false;document.getElementById('woVehicleSelected').style.display='none';document.getElementById('woVehicleSearchContainer').style.display='block';document.getElementById('woVehicleSearch').value='';document.getElementById('woNewVehicleFields').style.display='none';}
function showNewVehicleFields(){woIsNewVehicle=true;woSelectedVehicle=null;document.getElementById('woVehicleResults').classList.remove('show');document.getElementById('woVehicleSearchContainer').style.display='none';document.getElementById('woNewVehicleFields').style.display='block';var sq=document.getElementById('woVehicleSearch').value.trim().split(' ');if(sq.length>=1&&/^\d{4}$/.test(sq[0])){document.getElementById('woNewVehYear').value=sq[0];if(sq.length>=2)document.getElementById('woNewVehMake').value=sq[1];if(sq.length>=3)document.getElementById('woNewVehModel').value=sq.slice(2).join(' ');}document.getElementById('woNewVehYear').focus();}
async function createQuickWorkOrder(){var cid=null,vid=null;if(woIsNewCustomer){var fn=document.getElementById('woNewFirstName').value.trim(),ln=document.getElementById('woNewLastName').value.trim(),ph=document.getElementById('woNewPhone').value.trim();if(!fn||!ln||!ph){showToast('Please fill in customer name and phone');return;}try{var cr=await sb.from('customers').insert({tenant_id:tenantId,full_name:fn+' '+ln,first_name:fn,last_name:ln,phone:ph,created_at:new Date().toISOString()}).select().single();if(cr.error)throw cr.error;cid=cr.data.customer_id;lastCreatedCustomerId=cid;}catch(e){showToast('Error creating customer');return;}}else if(woSelectedCustomer){cid=woSelectedCustomer.customer_id;}else{showToast('Please select or add a customer');return;}if(woIsNewVehicle){var y=document.getElementById('woNewVehYear').value.trim(),mk=document.getElementById('woNewVehMake').value.trim(),md=document.getElementById('woNewVehModel').value.trim();if(!y&&!mk&&!md){showToast('Please enter vehicle information');return;}try{var vr=await sb.from('vehicles').insert({tenant_id:tenantId,customer_id:cid,year:y||null,make:mk||null,model:md||null,created_at:new Date().toISOString()}).select().single();if(vr.error)throw vr.error;vid=vr.data.vehicle_id;}catch(e){showToast('Error creating vehicle');return;}}else if(woSelectedVehicle){vid=woSelectedVehicle.vehicle_id;}else{showToast('Please select or add a vehicle');return;}document.getElementById('woCreateText').style.display='none';document.getElementById('woCreateLoading').style.display='inline-block';document.getElementById('woCreateBtn').disabled=true;try{var wnr=await sb.from('work_orders').select('wo_number').eq('tenant_id',tenantId).order('wo_number',{ascending:false}).limit(1);var nwn=1001;if(wnr.data&&wnr.data.length>0&&wnr.data[0].wo_number)nwn=parseInt(wnr.data[0].wo_number)+1;var sd=document.getElementById('woDate').value,st=document.getElementById('woTime').value||'09:00',ss=new Date(sd+'T'+st+':00');var tid=document.getElementById('woTechnician').value||null,desc=document.getElementById('woDescription').value.trim();var wor=await sb.from('work_orders').insert({tenant_id:tenantId,wo_number:nwn,customer_id:cid,vehicle_id:vid,summary:desc||'Service',status:'scheduled',scheduled_start:ss.toISOString(),assigned_employee_id:tid,created_at:new Date().toISOString(),deleted:false}).select().single();if(wor.error)throw wor.error;closeQuickWOModal();showToast('Work Order #'+nwn+' created!');setTimeout(function(){window.location.href='work-order-edit.html?id='+wor.data.work_order_id;},500);}catch(e){showToast('Error creating work order');document.getElementById('woCreateText').style.display='inline';document.getElementById('woCreateLoading').style.display='none';document.getElementById('woCreateBtn').disabled=false;}}
var apptCreatedCustomerId=null;
var editingAppointmentId=null;
var apptSelectedCustomer=null;
var apptIsNewCustomer=false;
function openQuickApptModal(){console.log('Opening Quick Appointment modal, tenantId:', tenantId);editingAppointmentId=null;apptCreatedCustomerId=null;apptSelectedCustomer=null;apptIsNewCustomer=false;document.querySelector('#quickApptModal .modal-title').textContent='Quick Appointment';document.getElementById('apptNewCustomerBtn').style.display='inline-block';document.getElementById('apptCustomerSelected').style.display='none';document.getElementById('apptCustomerSearchContainer').style.display='block';document.getElementById('apptCustomerSearch').value='';document.getElementById('apptNewCustomerFields').style.display='none';document.getElementById('apptCustomerName').value='';document.getElementById('apptOrganization').value='';document.getElementById('apptPhone').value='';document.getElementById('apptOrgField').value='';document.getElementById('apptType').selectedIndex=0;document.getElementById('apptClientType').value='';document.getElementById('apptSalesperson').value='';document.getElementById('apptNotes').value='';var td=new Date();td.setDate(td.getDate()+selectedDate);document.getElementById('apptDate').value=td.toISOString().split('T')[0];document.getElementById('apptTime').value='10:00';document.getElementById('apptFooterButtons').style.display='grid';document.getElementById('apptEditFooterButtons').style.display='none';document.getElementById('quickApptModal').classList.add('active');}
var apptSearchTimeout=null;
function searchApptCustomers(q){clearTimeout(apptSearchTimeout);var rd=document.getElementById('apptCustomerResults');if(q.length<2){rd.classList.remove('show');return;}apptSearchTimeout=setTimeout(function(){var ql=q.toLowerCase();var m=allCustomers.filter(function(c){return(c.full_name&&c.full_name.toLowerCase().includes(ql))||(c.phone&&c.phone.includes(q));}).slice(0,5);var h='';m.forEach(function(c){h+='<div class="search-result-item" onclick="selectApptCustomer(\''+c.customer_id+'\')"><div class="search-result-name">'+(c.full_name||'Unknown')+'</div><div class="search-result-sub">'+(c.phone||'No phone')+'</div></div>';});h+='<div class="search-result-item" onclick="showNewApptCustomerFields()"><div class="search-result-new"><span class="plus-icon">+</span> Add New Customer</div></div>';rd.innerHTML=h;rd.classList.add('show');},200);}
function selectApptCustomer(cid){var c=allCustomers.find(function(x){return x.customer_id===cid;});if(!c)return;apptSelectedCustomer=c;apptIsNewCustomer=false;document.getElementById('apptCustomerResults').classList.remove('show');document.getElementById('apptCustomerSearchContainer').style.display='none';document.getElementById('apptNewCustomerFields').style.display='none';document.getElementById('apptNewCustomerBtn').style.display='none';document.getElementById('apptCustomerSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+(c.full_name||'Unknown')+'</div><div class="selected-chip-sub">'+(c.phone||'No phone')+'</div></div><button class="selected-chip-remove" onclick="clearApptCustomer()">&times;</button></div>';document.getElementById('apptCustomerSelected').style.display='block';if(c.organization_name||c.company)document.getElementById('apptOrgField').value=c.organization_name||c.company||'';}
function clearApptCustomer(){apptSelectedCustomer=null;apptIsNewCustomer=false;document.getElementById('apptCustomerSelected').style.display='none';document.getElementById('apptCustomerSearchContainer').style.display='block';document.getElementById('apptCustomerSearch').value='';document.getElementById('apptNewCustomerFields').style.display='none';document.getElementById('apptNewCustomerBtn').style.display='inline-block';document.getElementById('apptOrgField').value='';}
function showNewApptCustomerFields(){apptIsNewCustomer=true;apptSelectedCustomer=null;document.getElementById('apptCustomerResults').classList.remove('show');document.getElementById('apptCustomerSearchContainer').style.display='none';document.getElementById('apptNewCustomerFields').style.display='block';document.getElementById('apptNewCustomerBtn').style.display='none';var sq=document.getElementById('apptCustomerSearch').value.trim().split(' ');if(sq.length>=1&&sq[0]){document.getElementById('apptCustomerName').value=document.getElementById('apptCustomerSearch').value.trim();}document.getElementById('apptCustomerName').focus();}
async function editSalesAppointment(appointmentId){var r=await sb.from('sales_appointments').select('*').eq('appointment_id',appointmentId).single();if(r.error||!r.data){showToast('Could not load appointment');return;}var appt=r.data;editingAppointmentId=appointmentId;apptIsNewCustomer=false;apptSelectedCustomer=null;document.querySelector('#quickApptModal .modal-title').textContent='Edit Appointment';document.getElementById('apptNewCustomerBtn').style.display='none';var foundCustomer=null;if(appt.customer_phone){foundCustomer=allCustomers.find(function(c){return c.phone===appt.customer_phone;});}if(!foundCustomer&&appt.customer_name){foundCustomer=allCustomers.find(function(c){return c.full_name&&c.full_name.toLowerCase()===appt.customer_name.toLowerCase();});}if(foundCustomer){apptSelectedCustomer=foundCustomer;document.getElementById('apptCustomerSearchContainer').style.display='none';document.getElementById('apptNewCustomerFields').style.display='none';document.getElementById('apptCustomerSelected').innerHTML='<div class="selected-chip"><div class="selected-chip-info"><div class="selected-chip-name">'+(foundCustomer.full_name||'Unknown')+'</div><div class="selected-chip-sub">'+(foundCustomer.phone||'No phone')+'</div></div><button class="selected-chip-remove" onclick="clearApptCustomer()">&times;</button></div>';document.getElementById('apptCustomerSelected').style.display='block';}else{apptIsNewCustomer=true;document.getElementById('apptCustomerSelected').style.display='none';document.getElementById('apptCustomerSearchContainer').style.display='none';document.getElementById('apptNewCustomerFields').style.display='block';document.getElementById('apptCustomerName').value=appt.customer_name||'';document.getElementById('apptOrganization').value=appt.organization||'';document.getElementById('apptPhone').value=appt.customer_phone||'';}document.getElementById('apptOrgField').value=appt.organization||'';document.getElementById('apptDate').value=appt.appointment_date||'';document.getElementById('apptTime').value=appt.appointment_time||'10:00';var typeSelect=document.getElementById('apptType');var typeValue=appt.appointment_type||'1st Contact';typeSelect.value=typeValue;document.getElementById('apptClientType').value=appt.client_type||'';document.getElementById('apptNotes').value=appt.notes||'';var spSelect=document.getElementById('apptSalesperson');spSelect.value='';if(appt.assigned_to){var sp=salespeople.find(function(s){return s.name===appt.assigned_to||s.id===appt.assigned_to;});if(sp&&sp.id!=='unassigned')spSelect.value=sp.id;}document.getElementById('apptFooterButtons').style.display='none';document.getElementById('apptEditFooterButtons').style.display='grid';document.getElementById('quickApptModal').classList.add('active');}
function closeQuickApptModal(){document.getElementById('quickApptModal').classList.remove('active');document.getElementById('apptCreateText').style.display='inline';document.getElementById('apptCreateLoading').style.display='none';document.getElementById('apptCreateBtn').disabled=false;document.getElementById('apptSaveText').style.display='inline';document.getElementById('apptSaveLoading').style.display='none';document.getElementById('apptSaveBtn').disabled=false;document.getElementById('apptFooterButtons').style.display='grid';document.getElementById('apptEditFooterButtons').style.display='none';document.getElementById('apptOrgField').value='';document.getElementById('apptClientType').value='';apptSelectedCustomer=null;apptIsNewCustomer=false;editingAppointmentId=null;}
async function deleteAppointment(){if(!editingAppointmentId){showToast('No appointment selected');return;}if(!confirm('Delete this appointment?\n\nThis will NOT delete the customer.')){return;}try{var r=await sb.from('sales_appointments').delete().eq('appointment_id',editingAppointmentId);if(r.error)throw r.error;closeQuickApptModal();showToast('Appointment deleted');await loadSalesJobs();renderAll();}catch(e){showToast('Error deleting appointment');console.error(e);}}
async function editApptCustomerProfile(){if(apptSelectedCustomer&&apptSelectedCustomer.customer_id){window.location.href='customer-profile.html?id='+apptSelectedCustomer.customer_id;return;}var cn=document.getElementById('apptCustomerName').value.trim();var ph=document.getElementById('apptPhone').value.trim();var org=document.getElementById('apptOrganization').value.trim();if(!cn&&!ph){showToast('Select or enter a customer first');return;}var existingCustomer=null;if(ph){var r=await sb.from('customers').select('customer_id').eq('tenant_id',tenantId).eq('phone',ph).limit(1);if(r.data&&r.data.length>0)existingCustomer=r.data[0];}if(!existingCustomer&&cn){var r=await sb.from('customers').select('customer_id').eq('tenant_id',tenantId).ilike('full_name',cn).limit(1);if(r.data&&r.data.length>0)existingCustomer=r.data[0];}if(existingCustomer){window.location.href='customer-profile.html?id='+existingCustomer.customer_id;}else{var names=cn.split(' ');var fn=names[0]||'';var ln=names.slice(1).join(' ')||'';try{var cr=await sb.from('customers').insert({tenant_id:tenantId,full_name:cn,first_name:fn,last_name:ln,phone:ph||null,organization_name:org||null,customer_type:'sales',created_at:new Date().toISOString()}).select().single();if(cr.error)throw cr.error;window.location.href='customer-profile.html?id='+cr.data.customer_id;}catch(e){showToast('Error creating customer');}}}
async function createQuickAppointment(){var cn,org,ph,customerId=null;if(apptSelectedCustomer){cn=apptSelectedCustomer.full_name||'';ph=apptSelectedCustomer.phone||'';org=document.getElementById('apptOrgField').value.trim();customerId=apptSelectedCustomer.customer_id;}else if(apptIsNewCustomer){cn=document.getElementById('apptCustomerName').value.trim();org=document.getElementById('apptOrganization').value.trim()||document.getElementById('apptOrgField').value.trim();ph=document.getElementById('apptPhone').value.trim();}else{var searchVal=document.getElementById('apptCustomerSearch').value.trim();if(searchVal){showToast('Select contact or click + New');return;}showToast('Select or add a contact');return;}var ad=document.getElementById('apptDate').value,at=document.getElementById('apptTime').value||'10:00';var isEditing=!!editingAppointmentId;if(!cn){showToast('Enter contact name');return;}if(!ph){showToast('Enter phone number');return;}if(!ad){showToast('Select a date');return;}if(isEditing){document.getElementById('apptSaveText').style.display='none';document.getElementById('apptSaveLoading').style.display='inline-block';document.getElementById('apptSaveBtn').disabled=true;}else{document.getElementById('apptCreateText').style.display='none';document.getElementById('apptCreateLoading').style.display='inline-block';document.getElementById('apptCreateBtn').disabled=true;}try{if(apptIsNewCustomer&&!customerId){var names=cn.split(' ');var firstName=names[0]||'';var lastName=names.slice(1).join(' ')||'';var customerData={tenant_id:tenantId,full_name:cn,first_name:firstName,last_name:lastName,phone:ph||null,customer_type:'prospect',funnel_stage:1,created_at:new Date().toISOString()};var cr=await sb.from('customers').insert(customerData).select().single();if(cr.error)throw cr.error;customerId=cr.data.customer_id;allCustomers.push({customer_id:customerId,full_name:cn,phone:ph});}var apt=document.getElementById('apptType').value||'1st Contact',clientType=document.getElementById('apptClientType').value||null,spid=document.getElementById('apptSalesperson').value,nt=document.getElementById('apptNotes').value.trim();var ato=null,spUuid=null;if(spid&&spid!==''){var sp=salespeople.find(function(s){return s.id===spid;});if(sp&&sp.id!=='unassigned'){ato=sp.name;spUuid=sp.id;}}var appointmentData={customer_name:cn,organization:org||null,customer_phone:ph,customer_id:customerId||null,appointment_date:ad,appointment_time:at,appointment_type:apt,client_type:clientType,assigned_to:ato,notes:nt||null,updated_at:new Date().toISOString()};if(spUuid)appointmentData.assigned_salesperson_id=spUuid;var ar;if(isEditing){ar=await sb.from('sales_appointments').update(appointmentData).eq('appointment_id',editingAppointmentId).select().single();}else{appointmentData.tenant_id=tenantId;appointmentData.status='confirmed';appointmentData.created_at=new Date().toISOString();ar=await sb.from('sales_appointments').insert(appointmentData).select().single();}if(ar.error)throw ar.error;closeQuickApptModal();showToast(isEditing?'Updated!':'Created!');await loadSalesJobs();renderAll();}catch(e){showToast('Error: '+(e.message||'Save failed'));if(isEditing){document.getElementById('apptSaveText').style.display='inline';document.getElementById('apptSaveLoading').style.display='none';document.getElementById('apptSaveBtn').disabled=false;}else{document.getElementById('apptCreateText').style.display='inline';document.getElementById('apptCreateLoading').style.display='none';document.getElementById('apptCreateBtn').disabled=false;}}}
document.addEventListener('click',function(e){if(!e.target.closest('.search-container'))document.querySelectorAll('.search-results').forEach(function(el){el.classList.remove('show');});});
document.addEventListener('dragover',function(e){if(!draggedJobId)return;var y=e.clientY;var vh=window.innerHeight;var scrollZone=100;if(y<scrollZone){startAutoScroll('up');}else if(y>vh-scrollZone){startAutoScroll('down');}else{stopAutoScroll();}});
document.addEventListener('dragend',function(){stopAutoScroll();});
function setViewStyle(s){currentViewStyle=s;document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('style'+s.charAt(0).toUpperCase()+s.slice(1)).classList.add('active');localStorage.setItem('scheduler-view-style',s);renderAll();showToast(s.charAt(0).toUpperCase()+s.slice(1)+' view');}
function switchTab(t){currentTab=t;document.querySelectorAll('.main-tab').forEach(function(b){b.classList.remove('active');});document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');currentFilter='all';renderAll();}
function toggleExpandPreference(){lanesExpanded=!lanesExpanded;localStorage.setItem('lanes-expanded',lanesExpanded?'true':'false');renderLanesControls();renderPages();}
function renderLanesControls(){var jobs=getJobsForDateOffset(selectedDate),all=jobs.length;var ei=lanesExpanded?'▼':'☐',ec=lanesExpanded?' expanded':'';var h='<button class="lanes-today-btn" onclick="goToToday()">Today</button>';h+='<span style="font-size:14px;color:var(--text-secondary);padding:8px 12px;">'+all+' Appts</span>';h+='<button class="expand-toggle-btn'+ec+'" onclick="toggleExpandPreference()">'+ei+'</button>';document.getElementById('lanesControlsRow').innerHTML=h;}
function goToToday(){if(selectedDate===0){centerOnToday();return;}selectedDate=0;renderAll();showToast('Today');setTimeout(centerOnToday,100);}
function centerOnToday(){var c=document.getElementById('lanesDateChips'),tc=document.getElementById('today-chip');if(tc&&c){var cw=c.offsetWidth,cl=tc.offsetLeft,chw=tc.offsetWidth;c.scrollLeft=cl-(cw/2)+(chw/2);}}
function renderLanesDateChips(){var c=document.getElementById('lanesDateChips'),days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],today=new Date(),so=-60,eo=120,mg={},mo=[];for(var i=so;i<eo;i++){var d=new Date(today);d.setDate(d.getDate()+i);var mk=d.getFullYear()+'-'+d.getMonth();if(!mg[mk]){mg[mk]={month:d.getMonth(),year:d.getFullYear(),label:months[d.getMonth()],days:[]};mo.push(mk);}mg[mk].days.push({offset:i,date:d,dayName:days[d.getDay()],dayNum:d.getDate(),isToday:i===0});}var h='',mi=0;for(var k=0;k<mo.length;k++){var key=mo[k],g=mg[key],eo=mi%2===0?'even':'odd';h+='<div class="month-section '+eo+'"><div class="month-label">'+g.label+'</div><div class="month-days">';for(var j=0;j<g.days.length;j++){var day=g.days[j],jc=getJobsForDateOffset(day.offset).length,ia=day.offset===selectedDate,cls='lanes-date-chip';if(ia)cls+=' active';if(day.isToday)cls+=' today';var ida=day.isToday?' id="today-chip"':'';h+='<button class="'+cls+'"'+ida+' data-offset="'+day.offset+'" onclick="selectDate('+day.offset+')"><span class="day-name">'+day.dayName+'</span><span class="day-num">'+day.dayNum+'</span>';if(jc>0)h+='<span class="job-count">'+jc+'</span>';h+='</button>';}h+='</div></div>';mi++;}c.innerHTML=h;}
function selectDate(o){if(o===selectedDate||isAnimating)return;selectedDate=o;renderAll();showToast(getDateLabel(selectedDate));}
function setFilter(f){currentFilter=f;renderLanesControls();renderPages();}
function getDateLabel(o){if(o===0)return'Today';if(o===1)return'Tomorrow';if(o===-1)return'Yesterday';var d=new Date();d.setDate(d.getDate()+o);return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});}
function getJobsForDateOffset(o){var jobs=salesJobs.filter(function(j){return j.date===o;});var eventsForDate=allEvents.filter(function(e){return e.date===o;});jobs=jobs.concat(eventsForDate);return jobs;}
function getJobsForDate(dateStr){var jobs=[];var targetDate=new Date(dateStr+'T00:00:00');var today=new Date();today.setHours(0,0,0,0);var offset=Math.round((targetDate-today)/(1000*60*60*24));return getJobsForDateOffset(offset);}
function getCurrentStaff(){return salespeople;}
function getTechById(id){var st=getCurrentStaff();for(var i=0;i<st.length;i++)if(st[i].id===id)return st[i];return{id:id,name:id,initials:'?',color:'purple',role:''};}
var statusLabels={'in_progress':'Active','waiting':'Parts','completed':'Done','urgent':'Urgent','scheduled':'Scheduled','confirmed':'Confirmed','event':'Event'};
function toggleLane(tid,dof){var l=document.getElementById('lane-'+tid+'-'+dof);if(l)l.classList.toggle('expanded');}
function toggleStackSection(sectionId){var section=document.getElementById('stack-'+sectionId+'-section');if(section){section.classList.toggle('collapsed');var icon=section.querySelector('.stack-expand-icon');if(icon){icon.textContent=section.classList.contains('collapsed')?'▶':'▼';}}}
var draggedJobId=null;
var autoScrollInterval=null;
function onDragStart(e,jobId){draggedJobId=jobId;e.target.classList.add('dragging');e.dataTransfer.effectAllowed='move';}
function onDragEnd(e){e.target.classList.remove('dragging');e.target.style.opacity='1';draggedJobId=null;draggedEventId=null;document.querySelectorAll('.tech-lane').forEach(function(l){l.classList.remove('drop-target');});document.querySelectorAll('.stack-drop-zone').forEach(function(l){l.classList.remove('drop-target');});stopAutoScroll();}
function startAutoScroll(direction){if(autoScrollInterval)return;var speed=direction==='up'?-10:10;autoScrollInterval=setInterval(function(){window.scrollBy(0,speed);},16);}
function stopAutoScroll(){if(autoScrollInterval){clearInterval(autoScrollInterval);autoScrollInterval=null;}}
function onDragOver(e){e.preventDefault();e.currentTarget.classList.add('drop-target');}
function onDragLeave(e){e.currentTarget.classList.remove('drop-target');}
var draggedEventId=null;
function onDragStartEvent(e,eventId){draggedEventId=eventId;draggedJobId=null;e.dataTransfer.effectAllowed='move';e.currentTarget.style.opacity='0.5';}
async function onStackDrop(e,techId){e.preventDefault();e.currentTarget.classList.remove('drop-target');if(draggedEventId){var assignedName=null;if(techId!=='unassigned'){var sp=salespeople.find(function(s){return s.id===techId;});if(sp)assignedName=sp.name;}var r=await sb.from('events').update({assigned_to:assignedName,updated_at:new Date().toISOString()}).eq('event_id',draggedEventId);if(r.error){showToast('Error assigning event');console.error(r.error);draggedEventId=null;return;}showToast('Event assigned to '+(assignedName||'Unassigned'));draggedEventId=null;await loadEvents();renderAll();return;}if(!draggedJobId)return;var job=salesJobs.find(function(j){return j.id===draggedJobId;});if(job){var assignedName=null;if(techId!=='unassigned'){var sp=salespeople.find(function(s){return s.id===techId;});if(sp)assignedName=sp.name;}var r=await sb.from('sales_appointments').update({assigned_to:assignedName,assigned_salesperson_id:techId==='unassigned'?null:techId,updated_at:new Date().toISOString()}).eq('appointment_id',draggedJobId);if(r.error){showToast('Error assigning');return;}showToast('Assigned to '+(assignedName||'Unassigned'));await loadSalesJobs();renderAll();}}
async function onDrop(e,techId){e.preventDefault();e.currentTarget.classList.remove('drop-target');if(draggedEventId){var assignedName=null;if(techId!=='unassigned'){var sp=salespeople.find(function(s){return s.id===techId;});if(sp)assignedName=sp.name;}var r=await sb.from('events').update({assigned_to:assignedName,updated_at:new Date().toISOString()}).eq('event_id',draggedEventId);if(r.error){showToast('Error assigning event');console.error(r.error);draggedEventId=null;return;}showToast('Event assigned to '+(assignedName||'Unassigned'));draggedEventId=null;await loadEvents();renderAll();return;}if(!draggedJobId)return;var job=salesJobs.find(function(j){return j.id===draggedJobId;});if(job){var assignedName=null;if(techId!=='unassigned'){var sp=salespeople.find(function(s){return s.id===techId;});if(sp)assignedName=sp.name;}var r=await sb.from('sales_appointments').update({assigned_to:assignedName,assigned_salesperson_id:techId==='unassigned'?null:techId,updated_at:new Date().toISOString()}).eq('appointment_id',draggedJobId);if(r.error){showToast('Error assigning');return;}showToast('Assigned to '+(assignedName||'Unassigned'));await loadSalesJobs();renderAll();}}
function renderLanesView(dof){var jobs=getJobsForDateOffset(dof);if(currentFilter!=='all')jobs=jobs.filter(function(j){return j.status===currentFilter;});var staff=getCurrentStaff();console.log('renderLanesView - staff:', staff.length, 'jobs:', jobs.length);var staffSorted=staff.slice().map(function(p){var jobCount=jobs.filter(function(j){return j.tech===p.id;}).length;return{person:p,jobCount:jobCount};}).sort(function(a,b){if(a.jobCount>0&&b.jobCount>0)return b.jobCount-a.jobCount;if(a.jobCount>0&&b.jobCount===0)return-1;if(a.jobCount===0&&b.jobCount>0)return 1;return 0;});if(staffSorted.length===0)return'<div class="empty-state"><div class="empty-state-text">No staff available</div></div>';var h='<div class="lanes-container">';var unassignedEvents=jobs.filter(function(j){return j.isEvent&&(j.tech==='unassigned'||!j.tech);});if(unassignedEvents.length>0){h+='<div class="tech-lane" id="lane-events-'+dof+'" style="border-left:3px solid #f97316;"><div class="lane-header" onclick="toggleLane(\'events\','+dof+')"><div class="lane-info"><div class="tech-avatar" style="background:#f97316;">📅</div><div class="tech-details"><h3>Events</h3><span>'+unassignedEvents.length+' event(s)</span></div></div><div class="lane-header-right"><span class="lane-expand-icon">▼</span></div></div><div class="lane-cards-wrapper"><div class="lane-cards">';unassignedEvents.forEach(function(j){h+='<div class="wo-card event-card status-event" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStartEvent(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="card-time">'+j.time+'<span class="event-badge">EVENT</span></div>';h+='<div class="card-customer">'+j.customer+'</div>';h+='<div class="card-org">'+(j.organization||'')+'</div>';h+='<div class="card-info-row">'+(j.cost?'<span class="card-cost">'+j.cost+'</span>':'')+'</div>';h+='<button class="card-details-btn" onclick="event.stopPropagation();editEvent(\''+j.id+'\')">Details</button>';h+='</div>';});h+='<div class="add-card" onclick="openNewEventModal()"><div class="add-card-icon">+</div><span>Event</span></div>';h+='</div></div></div>';}var unassignedJobs=jobs.filter(function(j){return !j.isEvent&&(j.tech==='unassigned'||!j.tech);});if(unassignedJobs.length>0){h+='<div class="tech-lane" id="lane-unassigned-'+dof+'" style="border-left:3px solid #a855f7;" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event,\'unassigned\')"><div class="lane-header" onclick="toggleLane(\'unassigned\','+dof+')"><div class="lane-info"><div class="tech-avatar purple">?</div><div class="tech-details"><h3>Unassigned</h3><span>'+unassignedJobs.length+' appt(s)</span></div></div><div class="lane-header-right"><span class="lane-expand-icon">▼</span></div></div><div class="lane-cards-wrapper"><div class="lane-cards">';unassignedJobs.forEach(function(j){h+='<div class="wo-card status-'+j.status+'" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStart(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="card-time">'+j.time+'<span class="appt-badge">APPT</span></div>';h+='<div class="card-customer">'+j.customer+'</div>';h+='<div class="card-org">'+(j.organization||'')+'</div>';h+='<div class="card-info-row"><span class="card-type">'+(j.appointmentType||'')+'</span></div>';h+='<button class="card-details-btn" onclick="event.stopPropagation();editSalesAppointment(\''+j.id+'\')">Details</button>';h+='</div>';});h+='<div class="add-card" onclick="event.stopPropagation();openQuickApptModal()"><div class="add-card-icon">+</div><span>Appt</span></div>';h+='</div></div></div>';}staffSorted.forEach(function(item){var p=item.person;if(p.id==='unassigned')return;var pj=jobs.filter(function(j){return j.tech===p.id;});var ec=lanesExpanded?' expanded':'';var hasJobs=pj.length>0;var laneOpacity=hasJobs?'0.81':'0.4';h+='<div class="tech-lane'+ec+'" id="lane-'+p.id+'-'+dof+'" data-tech="'+p.id+'" data-date="'+dof+'" style="opacity:'+laneOpacity+';" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event,\''+p.id+'\')">';h+='<div class="lane-header" onclick="toggleLane(\''+p.id+'\','+dof+')"><div class="lane-info"><div class="tech-avatar '+p.color+'">'+p.initials+'</div><div class="tech-details"><h3>'+p.name+'</h3><span>'+p.role+'</span></div></div><div class="lane-header-right"><div class="lane-stats"><div class="stat-item"><div class="stat-value">'+pj.length+'</div><div class="stat-label">Appts</div></div></div><span class="lane-expand-icon">▼</span></div></div>';h+='<div class="lane-cards-wrapper"><div class="lane-cards">';pj.forEach(function(j){var isEvent=j.isEvent;var cardClass=isEvent?'wo-card event-card status-event':'wo-card status-'+j.status;if(isEvent){h+='<div class="'+cardClass+'" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStartEvent(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="card-time">'+j.time+'<span class="event-badge">EVENT</span></div>';h+='<div class="card-customer">'+j.customer+'</div>';h+='<div class="card-org">'+(j.organization||'')+'</div>';h+='<div class="card-info-row">'+(j.cost?'<span class="card-cost">'+j.cost+'</span>':'')+'</div>';h+='<button class="card-details-btn" onclick="event.stopPropagation();editEvent(\''+j.id+'\')">Details</button>';h+='</div>';}else{h+='<div class="'+cardClass+'" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStart(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="card-time">'+j.time+'<span class="appt-badge">APPT</span></div>';h+='<div class="card-customer">'+j.customer+'</div>';h+='<div class="card-org">'+(j.organization||'')+'</div>';h+='<div class="card-info-row"><span class="card-type">'+(j.appointmentType||'')+'</span>'+(j.funnelStage&&j.funnelStage!==j.appointmentType?'<span class="card-dot"></span><span class="card-stage">'+j.funnelStage+'</span>':'')+'</div>';h+='<button class="card-details-btn" onclick="event.stopPropagation();editSalesAppointment(\''+j.id+'\')">Details</button>';h+='</div>';}});h+='<div class="add-card" onclick="event.stopPropagation();openQuickApptModal()"><div class="add-card-icon">+</div><span>Appt</span></div>';h+='</div></div></div>';});h+='</div>';return h;}
function renderStackView(dof){var jobs=getJobsForDateOffset(dof);if(currentFilter!=='all')jobs=jobs.filter(function(j){return j.status===currentFilter;});if(jobs.length===0)return'<div class="empty-state"><div class="empty-state-text">No appointments for '+getDateLabel(dof)+'</div></div>';var staff=getCurrentStaff();var roleOrder={'owner':1,'ceo':1,'president':1,'manager':2,'general_manager':2,'sales_manager':2,'supervisor':2,'sales':3,'sales_associate':3,'associate':3,'rep':3,'staff':4};function getRolePriority(role){if(!role)return 5;var r=role.toLowerCase().replace(/\s+/g,'_');for(var key in roleOrder){if(r.includes(key))return roleOrder[key];}return 5;}var groupedByStaff={};var unassignedAppts=[];var unassignedEvents=[];jobs.forEach(function(j){if(j.isEvent){if(!j.tech||j.tech==='unassigned'){unassignedEvents.push(j);}else{if(!groupedByStaff[j.tech])groupedByStaff[j.tech]=[];groupedByStaff[j.tech].push(j);}}else if(!j.tech||j.tech==='unassigned'){unassignedAppts.push(j);}else{if(!groupedByStaff[j.tech])groupedByStaff[j.tech]=[];groupedByStaff[j.tech].push(j);}});var staffWithAppts=[];for(var techId in groupedByStaff){var person=staff.find(function(s){return s.id===techId;});if(person){staffWithAppts.push({person:person,appts:groupedByStaff[techId].sort(function(a,b){return a.time.localeCompare(b.time);})});}}staffWithAppts.sort(function(a,b){var aPri=getRolePriority(a.person.role);var bPri=getRolePriority(b.person.role);return aPri-bPri;});var h='<div class="stack-container">';if(unassignedEvents.length>0){h+='<div class="stack-section" id="stack-events-section"><div class="stack-section-header" onclick="toggleStackSection(\'events\')" style="background:var(--bg-hover);padding:10px 16px;font-weight:600;color:#f97316;border-left:3px solid #f97316;cursor:pointer;">📅 Events ('+unassignedEvents.length+') <span class="stack-expand-icon">▼</span></div><div class="stack-section-content">';unassignedEvents.forEach(function(j){h+='<div class="stack-card event-card status-event" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStartEvent(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="stack-card-left">';h+='<div class="stack-time">'+j.time+'<span class="event-badge">EVENT</span></div>';h+='<div class="stack-customer">'+j.customer+'</div>';h+='<div class="stack-org">'+(j.organization||'')+'</div>';h+='</div><div class="stack-card-right">';h+=j.cost?'<span class="card-cost">'+j.cost+'</span>':'';h+='<button class="card-details-btn" onclick="event.stopPropagation();editEvent(\''+j.id+'\')">Details</button>';h+='</div></div>';});h+='</div></div>';}if(unassignedAppts.length>0){unassignedAppts.sort(function(a,b){return a.time.localeCompare(b.time);});h+='<div class="stack-section collapsed" id="stack-unassigned-section"><div class="stack-section-header stack-drop-zone" data-tech="unassigned" onclick="toggleStackSection(\'unassigned\')" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onStackDrop(event,\'unassigned\')" style="background:var(--bg-hover);padding:10px 16px;font-weight:600;color:var(--text-secondary);border-left:3px solid var(--text-secondary);cursor:pointer;">? Unassigned ('+unassignedAppts.length+') <span class="stack-expand-icon">▶</span></div><div class="stack-section-content">';unassignedAppts.forEach(function(j){h+='<div class="stack-card status-'+j.status+'" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStart(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="stack-card-left">';h+='<div class="stack-time">'+j.time+'<span class="appt-badge">APPT</span></div>';h+='<div class="stack-customer">'+j.customer+'</div>';h+='<div class="stack-org">'+(j.organization||'')+'</div>';h+='</div><div class="stack-card-right">';h+='<span class="card-type">'+(j.appointmentType||'')+'</span>';h+='<button class="card-details-btn" onclick="event.stopPropagation();editSalesAppointment(\''+j.id+'\')">Details</button>';h+='</div></div>';});h+='</div></div>';}staffWithAppts.forEach(function(item){var p=item.person;h+='<div class="stack-section-header stack-drop-zone" data-tech="'+p.id+'" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onStackDrop(event,\''+p.id+'\')" style="background:var(--bg-hover);padding:10px 16px;font-weight:600;color:var(--accent-light);display:flex;align-items:center;gap:10px;"><div class="tech-avatar small '+p.color+'">'+p.initials+'</div>'+p.name+' <span style="font-weight:400;color:var(--text-secondary);font-size:12px;">'+p.role+'</span></div>';item.appts.forEach(function(j){var isEvent=j.isEvent;if(isEvent){h+='<div class="stack-card event-card status-event" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStartEvent(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="stack-card-left">';h+='<div class="stack-time">'+j.time+'<span class="event-badge">EVENT</span></div>';h+='<div class="stack-customer">'+j.customer+'</div>';h+='<div class="stack-org">'+(j.organization||'')+'</div>';h+='</div><div class="stack-card-right">';h+=j.cost?'<span class="card-cost">'+j.cost+'</span>':'';h+='<button class="card-details-btn" onclick="event.stopPropagation();editEvent(\''+j.id+'\')">Details</button>';h+='</div></div>';}else{h+='<div class="stack-card status-'+j.status+'" data-job-id="'+j.id+'" draggable="true" ondragstart="onDragStart(event,\''+j.id+'\')" ondragend="onDragEnd(event)">';h+='<div class="stack-card-left">';h+='<div class="stack-time">'+j.time+'<span class="appt-badge">APPT</span></div>';h+='<div class="stack-customer">'+j.customer+'</div>';h+='<div class="stack-org">'+(j.organization||'')+'</div>';h+='</div><div class="stack-card-right">';h+='<span class="card-type">'+(j.appointmentType||'')+'</span>';h+='<button class="card-details-btn" onclick="event.stopPropagation();editSalesAppointment(\''+j.id+'\')">Details</button>';h+='</div></div>';}});});staff.filter(function(s){return s.id!=='unassigned'&&!groupedByStaff[s.id];}).forEach(function(p){h+='<div class="stack-section-header stack-drop-zone" data-tech="'+p.id+'" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onStackDrop(event,\''+p.id+'\')" style="background:var(--bg-hover);padding:10px 16px;font-weight:600;color:var(--text-secondary);display:flex;align-items:center;gap:10px;opacity:0.5;"><div class="tech-avatar small '+p.color+'">'+p.initials+'</div>'+p.name+' <span style="font-weight:400;color:var(--text-secondary);font-size:12px;">'+p.role+'</span></div>';});h+='</div>';return h;}
function renderGridView(dof){var days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],months=['January','February','March','April','May','June','July','August','September','October','November','December'];var today=new Date();today.setHours(0,0,0,0);var year=calendarMonth.getFullYear(),month=calendarMonth.getMonth();var firstDay=new Date(year,month,1),lastDay=new Date(year,month+1,0);var startDay=firstDay.getDay(),daysInMonth=lastDay.getDate();var prevMonth=new Date(year,month,0),daysInPrevMonth=prevMonth.getDate();var h='<div class="calendar-container">';h+='<div class="calendar-nav"><button class="calendar-nav-btn" onclick="prevMonth()">◀ Prev</button><div class="calendar-month-title">'+months[month]+' '+year+'</div><button class="calendar-nav-btn" onclick="nextMonth()">Next ▶</button></div>';h+='<div class="calendar-header">';for(var d=0;d<7;d++)h+='<div class="calendar-header-day">'+days[d]+'</div>';h+='</div><div class="calendar-grid">';var staff=getCurrentStaff();var staffIndexMap={};staff.forEach(function(s,i){staffIndexMap[s.id]=i;});for(var i=0;i<startDay;i++){var dn=daysInPrevMonth-startDay+i+1;h+='<div class="calendar-day other-month"><div class="calendar-day-num">'+dn+'</div></div>';}for(var d=1;d<=daysInMonth;d++){var cellDate=new Date(year,month,d);var dateStr=cellDate.toISOString().split('T')[0];var isToday=cellDate.getTime()===today.getTime();var offset=Math.round((cellDate-today)/(1000*60*60*24));var isSelected=offset===selectedDate;var jobs=getJobsForDateOffset(offset);var cls='calendar-day';if(isToday)cls+=' today';if(isSelected)cls+=' selected';h+='<div class="'+cls+'" onclick="selectDateAndSwitchToLanes('+offset+')">';h+='<div class="calendar-day-num">'+d+'</div>';h+='<div class="calendar-dots">';var dotCount=0,maxDots=10;for(var j=0;j<jobs.length&&dotCount<maxDots;j++){var job=jobs[j];if(job.isEvent){h+='<div class="calendar-dot event" title="'+job.customer+'"></div>';}else{var empIndex=staffIndexMap[job.tech];if(empIndex===undefined)empIndex=-1;var dotClass=empIndex>=0?'emp-'+empIndex:'unassigned';h+='<div class="calendar-dot '+dotClass+'" title="'+job.customer+'"></div>';}dotCount++;}if(jobs.length>maxDots)h+='<div class="calendar-more">+'+(jobs.length-maxDots)+'</div>';h+='</div></div>';}var totalCells=startDay+daysInMonth,remaining=totalCells%7===0?0:7-totalCells%7;for(var i=1;i<=remaining;i++)h+='<div class="calendar-day other-month"><div class="calendar-day-num">'+i+'</div></div>';h+='</div>';h+='<div style="margin-top:12px;padding:8px;background:var(--bg-card);border-radius:8px;"><div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;">Legend:</div><div style="display:flex;flex-wrap:wrap;gap:8px;font-size:10px;">';h+='<span><span class="calendar-dot event" style="display:inline-block;vertical-align:middle;margin-right:4px;"></span>Event</span>';staff.slice(0,10).forEach(function(s,i){h+='<span><span class="calendar-dot emp-'+i+'" style="display:inline-block;vertical-align:middle;margin-right:4px;"></span>'+s.name.split(' ')[0]+'</span>';});h+='</div></div></div>';return h;}
function prevMonth(){calendarMonth.setMonth(calendarMonth.getMonth()-1);renderPages();}
function nextMonth(){calendarMonth.setMonth(calendarMonth.getMonth()+1);renderPages();}
function selectDateAndSwitchToLanes(offset){selectedDate=offset;currentViewStyle='lanes';localStorage.setItem('scheduler-view-style','lanes');document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('styleLanes').classList.add('active');renderAll();showToast(getDateLabel(offset));setTimeout(function(){var chips=document.querySelectorAll('.lanes-date-chip');chips.forEach(function(c){if(parseInt(c.getAttribute('data-offset'))===offset){c.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});}});},100);}
function renderPages(){var content='';if(currentViewStyle==='stack'){content=renderStackView(selectedDate);}else if(currentViewStyle==='grid'){content=renderGridView(selectedDate);}else{content=renderLanesView(selectedDate);}document.getElementById('currentPage').innerHTML=content;document.getElementById('prevPage').innerHTML='';document.getElementById('nextPage').innerHTML='';}
function renderAll(){renderLanesControls();var dc=document.getElementById('lanesDateChips');dc.style.display='flex';renderLanesDateChips();renderPages();}
function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
var touchStartX=null,touchStartY=null,touchStartTime=null,isSwiping=false;
function handleTouchStart(e){if(currentViewStyle!=='lanes'&&currentViewStyle!=='stack')return;if(e.target.closest('.lane-cards')||e.target.closest('.lanes-date-chips'))return;var touch=e.touches[0];touchStartX=touch.clientX;touchStartY=touch.clientY;touchStartTime=Date.now();isSwiping=false;}
function handleTouchMove(e){if((currentViewStyle!=='lanes'&&currentViewStyle!=='stack')||touchStartX===null)return;var touch=e.touches[0];var deltaX=touch.clientX-touchStartX;var deltaY=touch.clientY-touchStartY;if(Math.abs(deltaX)>Math.abs(deltaY)&&Math.abs(deltaX)>10){isSwiping=true;}}
function handleTouchEnd(e){if((currentViewStyle!=='lanes'&&currentViewStyle!=='stack')||touchStartX===null||!isSwiping)return;var touch=e.changedTouches[0];var deltaX=touch.clientX-touchStartX;var deltaTime=Date.now()-touchStartTime;var velocity=Math.abs(deltaX)/deltaTime;var threshold=50;var velocityThreshold=0.3;if(Math.abs(deltaX)>threshold||velocity>velocityThreshold){if(deltaX<0){swipeToNextDay();}else{swipeToPrevDay();}}touchStartX=null;touchStartY=null;isSwiping=false;}
function swipeToNextDay(){var contentArea=document.getElementById('contentArea');var currentPage=document.getElementById('currentPage');currentPage.style.transition='transform 0.25s ease-out, opacity 0.25s ease-out';currentPage.style.transform='translateX(-100%)';currentPage.style.opacity='0';setTimeout(function(){selectedDate++;currentPage.style.transition='none';currentPage.style.transform='translateX(100%)';currentPage.style.opacity='0';renderAll();scrollToSelectedChip();setTimeout(function(){currentPage.style.transition='transform 0.25s ease-out, opacity 0.25s ease-out';currentPage.style.transform='translateX(0)';currentPage.style.opacity='1';},20);},250);}
function swipeToPrevDay(){var contentArea=document.getElementById('contentArea');var currentPage=document.getElementById('currentPage');currentPage.style.transition='transform 0.25s ease-out, opacity 0.25s ease-out';currentPage.style.transform='translateX(100%)';currentPage.style.opacity='0';setTimeout(function(){selectedDate--;currentPage.style.transition='none';currentPage.style.transform='translateX(-100%)';currentPage.style.opacity='0';renderAll();scrollToSelectedChip();setTimeout(function(){currentPage.style.transition='transform 0.25s ease-out, opacity 0.25s ease-out';currentPage.style.transform='translateX(0)';currentPage.style.opacity='1';},20);},250);}
function scrollToSelectedChip(){var chips=document.querySelectorAll('.lanes-date-chip');chips.forEach(function(c){if(parseInt(c.getAttribute('data-offset'))===selectedDate){c.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});}});}

// Event Modal Functions
var editingEventId=null;
function openNewEventModal(){editingEventId=null;document.getElementById('eventModalTitle').textContent='New Event';document.getElementById('eventTitle').value='';document.getElementById('eventOrganization').value='';document.getElementById('eventType').value='';document.getElementById('eventTicketPrice').value='';document.getElementById('eventAttendance').value='';document.getElementById('eventLocation').value='';document.getElementById('eventNotes').value='';var td=new Date();td.setDate(td.getDate()+selectedDate);document.getElementById('eventDate').value=td.toISOString().split('T')[0];document.getElementById('eventTime').value='10:00';var assignSelect=document.getElementById('eventAssignment');assignSelect.innerHTML='<option value="">-- Unassigned --</option>';salespeople.forEach(function(sp){if(sp.id!=='unassigned'){assignSelect.innerHTML+='<option value="'+sp.id+'">'+sp.name+'</option>';}});assignSelect.value='';document.getElementById('eventCreateFooter').style.display='grid';document.getElementById('eventEditFooter').style.display='none';document.getElementById('newEventModal').classList.add('active');}
async function editEvent(eventId){var r=await sb.from('events').select('*').eq('event_id',eventId).single();if(r.error||!r.data){showToast('Could not load event');return;}var ev=r.data;editingEventId=eventId;document.getElementById('eventModalTitle').textContent='Edit Event';document.getElementById('eventTitle').value=ev.event_name||'';document.getElementById('eventOrganization').value=ev.description||'';document.getElementById('eventDate').value=ev.event_date||'';document.getElementById('eventTime').value=ev.event_time||'10:00';document.getElementById('eventType').value=ev.event_type||'';document.getElementById('eventTicketPrice').value=ev.estimated_cost||'';document.getElementById('eventAttendance').value=ev.mileage||'';document.getElementById('eventLocation').value=ev.location||'';document.getElementById('eventNotes').value=ev.notes||'';var assignSelect=document.getElementById('eventAssignment');assignSelect.innerHTML='<option value="">-- Unassigned --</option>';salespeople.forEach(function(sp){if(sp.id!=='unassigned'){assignSelect.innerHTML+='<option value="'+sp.id+'">'+sp.name+'</option>';}});assignSelect.value='';if(ev.assigned_to){var found=salespeople.find(function(sp){return sp.name===ev.assigned_to;});if(found)assignSelect.value=found.id;}document.getElementById('eventCreateFooter').style.display='none';document.getElementById('eventEditFooter').style.display='grid';document.getElementById('newEventModal').classList.add('active');}
function closeNewEventModal(){document.getElementById('newEventModal').classList.remove('active');editingEventId=null;}
async function saveNewEvent(){var eventName=document.getElementById('eventTitle').value.trim(),org=document.getElementById('eventOrganization').value.trim(),date=document.getElementById('eventDate').value,time=document.getElementById('eventTime').value,eventType=document.getElementById('eventType').value,ticketPrice=document.getElementById('eventTicketPrice').value,attendance=document.getElementById('eventAttendance').value,location=document.getElementById('eventLocation').value.trim(),notes=document.getElementById('eventNotes').value.trim(),assignId=document.getElementById('eventAssignment').value;if(!eventName){showToast('Please enter event title');return;}if(!date){showToast('Please select a date');return;}var assignedName=null;if(assignId&&assignId!==''){var sp=salespeople.find(function(s){return s.id===assignId;});if(sp)assignedName=sp.name;}try{var eventData={event_name:eventName,description:org||null,event_date:date,event_time:time||null,event_type:eventType||null,estimated_cost:ticketPrice?parseFloat(ticketPrice):null,mileage:attendance?parseInt(attendance):null,location:location||null,notes:notes||null,updated_at:new Date().toISOString()};if(assignedName){eventData.assigned_to=assignedName;}var r;if(editingEventId){r=await sb.from('events').update(eventData).eq('event_id',editingEventId);}else{eventData.tenant_id=tenantId;eventData.created_at=new Date().toISOString();r=await sb.from('events').insert(eventData).select().single();}if(r.error){console.error('Event save error:', r.error);showToast('Error: '+r.error.message);return;}closeNewEventModal();showToast(editingEventId?'Event updated!':'Event created!');await loadEvents();renderAll();}catch(e){console.error('Event save exception:', e);showToast('Error: '+(e.message||'Failed to save event'));}}
async function deleteEvent(){if(!editingEventId){showToast('No event selected');return;}if(!confirm('Delete this event?')){return;}try{var r=await sb.from('events').delete().eq('event_id',editingEventId);if(r.error)throw r.error;closeNewEventModal();showToast('Event deleted');await loadEvents();renderAll();}catch(e){showToast('Error deleting event');console.error(e);}}

// Contact Modal Functions
function openNewContactModal(){document.getElementById('contactFirstName').value='';document.getElementById('contactLastName').value='';document.getElementById('contactPhone').value='';document.getElementById('contactEmail').value='';document.getElementById('contactOrganization').value='';document.getElementById('contactClientType').value='';document.getElementById('contactStage').value='1';document.getElementById('contactNotes').value='';document.getElementById('newContactModal').classList.add('active');}
function closeNewContactModal(){document.getElementById('newContactModal').classList.remove('active');}
async function saveNewContact(){var firstName=document.getElementById('contactFirstName').value.trim(),lastName=document.getElementById('contactLastName').value.trim(),phone=document.getElementById('contactPhone').value.trim(),email=document.getElementById('contactEmail').value.trim(),org=document.getElementById('contactOrganization').value.trim(),clientType=document.getElementById('contactClientType').value,stage=document.getElementById('contactStage').value,notes=document.getElementById('contactNotes').value.trim();if(!firstName||!lastName){showToast('Enter first and last name');return;}if(!phone){showToast('Enter phone number');return;}try{var contactData={tenant_id:tenantId,first_name:firstName,last_name:lastName,full_name:firstName+' '+lastName,phone:phone,customer_type:clientType||'prospect',funnel_stage:parseInt(stage)||1,created_at:new Date().toISOString()};if(email)contactData.email=email;if(org)contactData.organization_name=org;if(notes)contactData.notes=notes;var r=await sb.from('customers').insert(contactData).select().single();if(r.error)throw r.error;allCustomers.push({customer_id:r.data.customer_id,full_name:firstName+' '+lastName,phone:phone});closeNewContactModal();showToast('Contact added!');}catch(e){showToast('Error: '+(e.message||'Save failed'));}}

async function init(){var s=await checkAuth();if(!s)return;if(s.user&&s.user.email){document.getElementById('businessName').textContent=s.user.email;}await loadBusinessSettings();await loadAllData();document.querySelectorAll('.view-style-btn').forEach(function(b){b.classList.remove('active');});document.getElementById('style'+currentViewStyle.charAt(0).toUpperCase()+currentViewStyle.slice(1)).classList.add('active');renderAll();requestAnimationFrame(function(){requestAnimationFrame(centerOnToday);});}
init();
</script>
</body>
</html>
