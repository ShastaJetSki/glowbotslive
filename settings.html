<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - WorkLogicPro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --bg: #0b0f14;
      --surface: #0f1621;
      --card: #1a2535;
      --text: #e8eef6;
      --text-secondary: #9fb0c3;
      --text-muted: #6b7280;
      --border: #223044;
      --green: #10b981;
      --yellow: #f59e0b;
      --red: #ef4444;
      --purple: #8b5cf6;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 { font-size: 24px; font-weight: 700; }
    .business-name { font-size: 14px; color: var(--primary); margin-top: 4px; }

    .header-nav { display: flex; gap: 8px; }
    .header-nav a {
      padding: 8px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      border-radius: 8px;
    }
    .header-nav a:hover { background: var(--card); }
    .header-nav a.active { background: var(--primary); color: #fff; }

    .logout-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
    }

    .settings-layout {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      gap: 24px;
    }

    .settings-sidebar { width: 200px; flex-shrink: 0; }

    .sidebar-nav {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: sticky;
      top: 90px;
    }

    .sidebar-title {
      padding: 14px 18px;
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }
    .sidebar-item:hover { background: var(--card); color: var(--text); }
    .sidebar-item.active {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .sidebar-badge {
      background: var(--primary);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 8px;
    }

    .settings-main { flex: 1; min-width: 0; }

    .section { display: none; }
    .section.active { display: block; }

    .section-header { margin-bottom: 24px; }
    .section-title { font-size: 24px; font-weight: 800; margin-bottom: 6px; }
    .section-subtitle { color: var(--text-secondary); font-size: 14px; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title { font-size: 15px; font-weight: 700; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 11px 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea { min-height: 80px; resize: vertical; }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-success { background: var(--green); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-danger { background: rgba(239,68,68,0.1); border: 1px solid var(--red); color: var(--red); }
    .btn-block { width: 100%; }

    /* Toggle */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .toggle-row:last-child { border-bottom: none; }

    .toggle-info h4 { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .toggle-info p { font-size: 12px; color: var(--text-muted); }

    .toggle { position: relative; width: 44px; height: 24px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--border);
      border-radius: 24px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      content: "";
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }
    input:checked + .toggle-slider { background: var(--green); }
    input:checked + .toggle-slider:before { transform: translateX(20px); }

    /* Employee Grid */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 14px;
    }

    .employee-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }
    .employee-card:hover { border-color: var(--primary); }

    .emp-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--purple));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin: 0 auto 8px;
      border: 2px solid var(--border);
    }

    .emp-actions { display: flex; justify-content: center; gap: 6px; margin-bottom: 10px; }

    .emp-btn {
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }
    .emp-btn:hover { border-color: var(--primary); color: var(--primary); }
    .emp-btn.delete:hover { border-color: var(--red); color: var(--red); }

    .emp-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
    .emp-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .role-owner { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .role-manager { background: rgba(139,92,246,0.2); color: #a78bfa; }
    .role-technician { background: rgba(16,185,129,0.2); color: #34d399; }
    .role-sales { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .role-parts_manager { background: rgba(236,72,153,0.2); color: #f472b6; }
    .role-service_advisor { background: rgba(20,184,166,0.2); color: #2dd4bf; }

    .emp-info { font-size: 11px; color: var(--text-muted); }
    .emp-rate { font-size: 12px; font-weight: 600; color: var(--green); }

    .add-card {
      background: var(--card);
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 160px;
    }
    .add-card:hover { border-color: var(--primary); }
    .add-card-plus {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(59,130,246,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .add-card-text { font-size: 12px; font-weight: 600; color: var(--text-secondary); }

    /* Media Grid */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 14px;
    }

    .media-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
    }

    .media-label { font-size: 13px; font-weight: 600; margin-bottom: 10px; }

    .media-preview {
      width: 100%;
      height: 80px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--surface);
      font-size: 12px;
      color: var(--text-muted);
    }
    .media-preview:hover { border-color: var(--primary); }

    .media-hint { font-size: 10px; color: var(--text-muted); margin-top: 6px; }

    .media-btns { display: flex; gap: 6px; margin-top: 10px; }
    .media-btns .btn { flex: 1; font-size: 11px; padding: 8px; }

    .social-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
    }

    .social-item { display: flex; align-items: center; gap: 10px; }
    .social-label { width: 80px; font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .social-item input {
      flex: 1;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 12px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show { display: flex; }

    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h3 { font-size: 16px; }
    .modal-close { background: none; border: none; font-size: 20px; color: var(--text-muted); cursor: pointer; }

    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 14px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .alert {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 22px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      display: none;
      z-index: 1001;
    }
    .alert.show { display: block; }
    .alert.success { background: var(--green); color: #fff; }

    @media (max-width: 900px) {
      .settings-layout { flex-direction: column; }
      .settings-sidebar { width: 100%; }
      .sidebar-nav { position: static; display: flex; flex-wrap: wrap; gap: 4px; padding: 8px; }
      .sidebar-title { display: none; }
      .sidebar-item { padding: 8px 12px; border-left: none; border-radius: 6px; font-size: 12px; }
      .header-nav { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <h1>Settings</h1>
        <div class="business-name" id="businessName">Loading...</div>
      </div>
      <div class="header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html">Scheduling</a>
        <a href="dashboard-settings.html" class="active">Settings</a>
      </div>
      <button class="logout-btn" onclick="logout()">Sign Out</button>
    </div>
  </div>

  <div class="settings-layout">
    <div class="settings-sidebar">
      <div class="sidebar-nav">
        <div class="sidebar-title">General</div>
        <div class="sidebar-item active" onclick="showSection('business', this)">Business</div>
        <div class="sidebar-item" onclick="showSection('employees', this)">Employees <span class="sidebar-badge" id="empCount">0</span></div>
        <div class="sidebar-item" onclick="showSection('media', this)">Media</div>
        
        <div class="sidebar-title">Departments</div>
        <div class="sidebar-item" onclick="showSection('service', this)">Service</div>
        <div class="sidebar-item" onclick="showSection('parts', this)">Parts</div>
        <div class="sidebar-item" onclick="showSection('sales', this)">Sales</div>
        <div class="sidebar-item" onclick="showSection('fleet', this)">Fleet</div>
        <div class="sidebar-item" onclick="showSection('scheduling', this)">Scheduling</div>
        <div class="sidebar-item" onclick="showSection('reports', this)">Reports</div>
      </div>
    </div>

    <div class="settings-main">

      <!-- ========== BUSINESS ========== -->
      <div id="section-business" class="section active">
        <div class="section-header">
          <h2 class="section-title">Business Settings</h2>
          <p class="section-subtitle">Your business information and pricing</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Business Information</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Business Name</label><input type="text" id="bizName" placeholder="Your Business Name"></div>
            <div class="form-group"><label>Contact Name</label><input type="text" id="bizContact" placeholder="Owner Name"></div>
            <div class="form-group"><label>Email</label><input type="email" id="bizEmail" placeholder="contact@business.com"></div>
            <div class="form-group"><label>Phone</label><input type="tel" id="bizPhone" placeholder="(555) 555-5555"></div>
            <div class="form-group" style="grid-column: span 2;"><label>Address</label><input type="text" id="bizAddress" placeholder="Street Address"></div>
            <div class="form-group"><label>City, State, ZIP</label><input type="text" id="bizCityState" placeholder="City, ST 12345"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Rates and Pricing</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Labor Rate ($/hr)</label><input type="number" id="laborRate" step="0.01" placeholder="95.00"></div>
            <div class="form-group"><label>Tax Rate (%)</label><input type="number" id="taxRate" step="0.01" placeholder="8.5"></div>
            <div class="form-group"><label>Parts Markup (%)</label><input type="number" id="partsMarkup" step="0.01" placeholder="35"></div>
            <div class="form-group"><label>Shop Supplies (%)</label><input type="number" id="shopFee" step="0.01" placeholder="3"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Business Hours</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Monday - Friday</label><input type="text" placeholder="8:00 AM - 6:00 PM"></div>
            <div class="form-group"><label>Saturday</label><input type="text" placeholder="9:00 AM - 3:00 PM"></div>
            <div class="form-group"><label>Sunday</label><input type="text" placeholder="Closed"></div>
            <div class="form-group"><label>Timezone</label>
              <select><option>Pacific Time (PT)</option><option>Mountain Time (MT)</option><option>Central Time (CT)</option><option>Eastern Time (ET)</option></select>
            </div>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Business settings saved!', 'success')">Save Business Settings</button>
      </div>

      <!-- ========== EMPLOYEES ========== -->
      <div id="section-employees" class="section">
        <div class="section-header">
          <h2 class="section-title">Employee Settings</h2>
          <p class="section-subtitle">Manage your team members, roles, and permissions</p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Team Members</div>
            <button class="btn btn-primary" onclick="openEmployeeModal()">+ Add Employee</button>
          </div>
          <div class="employee-grid" id="employeeGrid"></div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Default Employee Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Default Hourly Rate</label><input type="number" step="0.01" placeholder="65.00"></div>
            <div class="form-group"><label>Overtime Multiplier</label><input type="number" step="0.1" placeholder="1.5"></div>
            <div class="form-group"><label>Max Hours Per Day</label><input type="number" placeholder="10"></div>
            <div class="form-group"><label>Default Role</label>
              <select><option>Technician</option><option>Service Advisor</option><option>Parts Manager</option><option>Sales</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Permissions</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Technicians can view customer info</h4><p>Allow techs to see customer contact details</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Technicians can edit work orders</h4><p>Allow techs to modify work order details</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Require manager approval for discounts</h4><p>Discounts over threshold need approval</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Employee settings saved!', 'success')">Save Employee Settings</button>
      </div>

      <!-- ========== MEDIA ========== -->
      <div id="section-media" class="section">
        <div class="section-header">
          <h2 class="section-title">Media Settings</h2>
          <p class="section-subtitle">Upload logos, images, and manage branding</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Business Images</div></div>
          <div class="media-grid">
            <div class="media-card">
              <div class="media-label">Business Logo</div>
              <div class="media-preview">Click to upload</div>
              <div class="media-hint">200x200px, PNG or SVG</div>
              <div class="media-btns"><button class="btn btn-outline">Upload</button><button class="btn btn-danger">Remove</button></div>
            </div>
            <div class="media-card">
              <div class="media-label">Invoice Header</div>
              <div class="media-preview">Click to upload</div>
              <div class="media-hint">600x100px</div>
              <div class="media-btns"><button class="btn btn-outline">Upload</button><button class="btn btn-danger">Remove</button></div>
            </div>
            <div class="media-card">
              <div class="media-label">Email Header</div>
              <div class="media-preview">Click to upload</div>
              <div class="media-hint">600x150px</div>
              <div class="media-btns"><button class="btn btn-outline">Upload</button><button class="btn btn-danger">Remove</button></div>
            </div>
            <div class="media-card">
              <div class="media-label">Receipt Footer</div>
              <div class="media-preview">Click to upload</div>
              <div class="media-hint">Printed receipts</div>
              <div class="media-btns"><button class="btn btn-outline">Upload</button><button class="btn btn-danger">Remove</button></div>
            </div>
            <div class="media-card">
              <div class="media-label">Photo Watermark</div>
              <div class="media-preview">Click to upload</div>
              <div class="media-hint">Transparent PNG</div>
              <div class="media-btns"><button class="btn btn-outline">Upload</button><button class="btn btn-danger">Remove</button></div>
            </div>
            <div class="media-card">
              <div class="media-label">Review QR Code</div>
              <div class="media-preview" style="background:#fff; color:#666;">Auto-generated</div>
              <div class="media-hint">Google review link</div>
              <div class="media-btns"><button class="btn btn-primary">Generate</button><button class="btn btn-outline">Download</button></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Social Media Links</div></div>
          <div class="social-grid">
            <div class="social-item"><span class="social-label">Website</span><input type="url" placeholder="https://yourwebsite.com"></div>
            <div class="social-item"><span class="social-label">Facebook</span><input type="url" placeholder="https://facebook.com/business"></div>
            <div class="social-item"><span class="social-label">Instagram</span><input type="url" placeholder="https://instagram.com/business"></div>
            <div class="social-item"><span class="social-label">Google</span><input type="url" placeholder="https://g.page/business"></div>
            <div class="social-item"><span class="social-label">Yelp</span><input type="url" placeholder="https://yelp.com/biz/business"></div>
            <div class="social-item"><span class="social-label">TikTok</span><input type="url" placeholder="https://tiktok.com/@business"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Branding Options</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Show logo on invoices</h4><p>Display business logo at top of invoices</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Watermark work order photos</h4><p>Add watermark to all uploaded photos</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Include social links in emails</h4><p>Add social media icons to email footers</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Media settings saved!', 'success')">Save Media Settings</button>
      </div>

      <!-- ========== SERVICE ========== -->
      <div id="section-service" class="section">
        <div class="section-header">
          <h2 class="section-title">Service Department</h2>
          <p class="section-subtitle">Configure work orders, labor, and service settings</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Work Order Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>WO Number Prefix</label><input type="text" placeholder="WO-"></div>
            <div class="form-group"><label>Starting WO Number</label><input type="number" placeholder="1001"></div>
            <div class="form-group"><label>Default Priority</label>
              <select><option>Normal</option><option>Low</option><option>High</option><option>Urgent</option></select>
            </div>
            <div class="form-group"><label>Default Status</label>
              <select><option>Draft</option><option>Scheduled</option><option>In Progress</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Labor Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Labor Rate ($/hr)</label><input type="number" step="0.01" placeholder="95.00"></div>
            <div class="form-group"><label>Minimum Labor Charge</label><input type="number" step="0.01" placeholder="50.00"></div>
            <div class="form-group"><label>Labor Rounding</label>
              <select><option>Round to nearest 0.1 hr</option><option>Round to nearest 0.25 hr</option><option>Round to nearest 0.5 hr</option><option>No rounding</option></select>
            </div>
            <div class="form-group"><label>Diagnostic Fee</label><input type="number" step="0.01" placeholder="75.00"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Service Options</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Require vehicle inspection</h4><p>Mandatory inspection before work begins</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Auto-assign technicians</h4><p>Automatically assign based on availability</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Require customer signature</h4><p>Customer must sign before work begins</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Send completion notification</h4><p>Email/SMS when vehicle is ready</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Service settings saved!', 'success')">Save Service Settings</button>
      </div>

      <!-- ========== PARTS ========== -->
      <div id="section-parts" class="section">
        <div class="section-header">
          <h2 class="section-title">Parts Department</h2>
          <p class="section-subtitle">Configure inventory, pricing, and ordering</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Pricing Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Default Markup (%)</label><input type="number" step="0.01" placeholder="35"></div>
            <div class="form-group"><label>Wholesale Markup (%)</label><input type="number" step="0.01" placeholder="15"></div>
            <div class="form-group"><label>Core Charge Handling</label>
              <select><option>Add to invoice</option><option>Separate line item</option><option>Include in part price</option></select>
            </div>
            <div class="form-group"><label>Tax on Parts</label>
              <select><option>Taxable</option><option>Non-taxable</option><option>Use item setting</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Inventory Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Low Stock Threshold</label><input type="number" placeholder="5"></div>
            <div class="form-group"><label>Reorder Point</label><input type="number" placeholder="10"></div>
            <div class="form-group"><label>Default Bin Location</label><input type="text" placeholder="A-1"></div>
            <div class="form-group"><label>Inventory Method</label>
              <select><option>FIFO</option><option>LIFO</option><option>Average Cost</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Parts Options</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Track serial numbers</h4><p>Record serial numbers for parts</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Low stock alerts</h4><p>Notify when parts fall below threshold</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Auto-generate PO</h4><p>Create purchase orders automatically</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Parts settings saved!', 'success')">Save Parts Settings</button>
      </div>

      <!-- ========== SALES ========== -->
      <div id="section-sales" class="section">
        <div class="section-header">
          <h2 class="section-title">Sales Department</h2>
          <p class="section-subtitle">Configure vehicle sales, deals, and commissions</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Sales Pipeline</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Lead Source Tracking</label>
              <select><option>Enabled</option><option>Disabled</option></select>
            </div>
            <div class="form-group"><label>Default Follow-up Days</label><input type="number" placeholder="3"></div>
            <div class="form-group"><label>Deal Number Prefix</label><input type="text" placeholder="DEAL-"></div>
            <div class="form-group"><label>Quote Valid Days</label><input type="number" placeholder="7"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Commission Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Base Commission (%)</label><input type="number" step="0.1" placeholder="3.0"></div>
            <div class="form-group"><label>Bonus Threshold ($)</label><input type="number" placeholder="50000"></div>
            <div class="form-group"><label>Bonus Commission (%)</label><input type="number" step="0.1" placeholder="5.0"></div>
            <div class="form-group"><label>Commission Basis</label>
              <select><option>Gross Profit</option><option>Sale Price</option><option>Net Profit</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Sales Options</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Require trade-in appraisal</h4><p>Mandatory appraisal for trade-ins</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Enable financing calculator</h4><p>Show payment calculator to customers</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Auto-send deal documents</h4><p>Email documents when deal is closed</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Sales settings saved!', 'success')">Save Sales Settings</button>
      </div>

      <!-- ========== FLEET ========== -->
      <div id="section-fleet" class="section">
        <div class="section-header">
          <h2 class="section-title">Fleet Management</h2>
          <p class="section-subtitle">Configure fleet tracking, rentals, and loaners</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Fleet Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Fleet ID Prefix</label><input type="text" placeholder="FLT-"></div>
            <div class="form-group"><label>Default Mileage Limit</label><input type="number" placeholder="150"></div>
            <div class="form-group"><label>Overage Rate ($/mi)</label><input type="number" step="0.01" placeholder="0.35"></div>
            <div class="form-group"><label>Fuel Policy</label>
              <select><option>Full to Full</option><option>Same to Same</option><option>Prepaid</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Loaner Vehicle Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Max Loaner Days</label><input type="number" placeholder="5"></div>
            <div class="form-group"><label>Deposit Amount</label><input type="number" placeholder="500"></div>
            <div class="form-group"><label>Insurance Required</label>
              <select><option>Yes - Verify Coverage</option><option>Yes - Offer Add-on</option><option>No</option></select>
            </div>
            <div class="form-group"><label>Age Requirement</label><input type="number" placeholder="21"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Fleet Options</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Track GPS location</h4><p>Enable GPS tracking for fleet vehicles</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Maintenance reminders</h4><p>Auto-schedule based on mileage/time</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Require inspection photos</h4><p>Photos before and after rental</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Fleet settings saved!', 'success')">Save Fleet Settings</button>
      </div>

      <!-- ========== SCHEDULING ========== -->
      <div id="section-scheduling" class="section">
        <div class="section-header">
          <h2 class="section-title">Scheduling Settings</h2>
          <p class="section-subtitle">Configure appointments, calendar, and reminders</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Appointment Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Time Slot Duration</label>
              <select><option>15 minutes</option><option>30 minutes</option><option>1 hour</option></select>
            </div>
            <div class="form-group"><label>Buffer Between Appointments</label>
              <select><option>None</option><option>15 minutes</option><option>30 minutes</option></select>
            </div>
            <div class="form-group"><label>Max Appointments Per Day</label><input type="number" placeholder="20"></div>
            <div class="form-group"><label>Advance Booking Days</label><input type="number" placeholder="30"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Reminder Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>First Reminder</label>
              <select><option>24 hours before</option><option>48 hours before</option><option>1 week before</option></select>
            </div>
            <div class="form-group"><label>Second Reminder</label>
              <select><option>2 hours before</option><option>4 hours before</option><option>Morning of</option></select>
            </div>
            <div class="form-group"><label>Reminder Method</label>
              <select><option>Email only</option><option>SMS only</option><option>Email and SMS</option></select>
            </div>
            <div class="form-group"><label>Service Reminder Interval</label>
              <select><option>3 months</option><option>6 months</option><option>12 months</option><option>By mileage</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Calendar Options</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Online booking</h4><p>Allow customers to book online</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Double booking allowed</h4><p>Allow overlapping appointments</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Show technician availability</h4><p>Display tech schedules to advisors</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Scheduling settings saved!', 'success')">Save Scheduling Settings</button>
      </div>

      <!-- ========== REPORTS ========== -->
      <div id="section-reports" class="section">
        <div class="section-header">
          <h2 class="section-title">Reports Settings</h2>
          <p class="section-subtitle">Configure analytics, exports, and dashboards</p>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Dashboard Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Default Date Range</label>
              <select><option>This Week</option><option>This Month</option><option>Last 30 Days</option><option>This Quarter</option></select>
            </div>
            <div class="form-group"><label>Fiscal Year Start</label>
              <select><option>January</option><option>April</option><option>July</option><option>October</option></select>
            </div>
            <div class="form-group"><label>Currency</label>
              <select><option>USD ($)</option><option>CAD ($)</option><option>EUR</option><option>GBP</option></select>
            </div>
            <div class="form-group"><label>Number Format</label>
              <select><option>1,234.56</option><option>1.234,56</option><option>1 234.56</option></select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Auto Reports</div></div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Daily summary email</h4><p>Send daily business summary</p></div>
            <label class="toggle"><input type="checkbox"><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Weekly report</h4><p>Send weekly performance report</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info"><h4>Monthly financial report</h4><p>Detailed monthly financials</p></div>
            <label class="toggle"><input type="checkbox" checked><span class="toggle-slider"></span></label>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">Export Settings</div></div>
          <div class="form-grid">
            <div class="form-group"><label>Default Export Format</label>
              <select><option>PDF</option><option>Excel</option><option>CSV</option></select>
            </div>
            <div class="form-group"><label>Include Logo</label>
              <select><option>Yes</option><option>No</option></select>
            </div>
            <div class="form-group"><label>Date Format</label>
              <select><option>MM/DD/YYYY</option><option>DD/MM/YYYY</option><option>YYYY-MM-DD</option></select>
            </div>
            <div class="form-group"><label>Report Recipients</label><input type="email" placeholder="owner@business.com"></div>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="showAlert('Report settings saved!', 'success')">Save Report Settings</button>
      </div>

    </div>
  </div>

  <!-- Employee Modal -->
  <div id="employeeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="empModalTitle">Add Employee</h3>
        <button class="modal-close" onclick="closeEmployeeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Photo</label>
          <div style="display:flex; align-items:center; gap:14px;">
            <div style="width:50px; height:50px; border-radius:50%; background:var(--card); border:2px dashed var(--border); display:flex; align-items:center; justify-content:center; color:var(--text-muted);">?</div>
            <button class="btn btn-outline" style="font-size:12px;">Upload Photo</button>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group"><label>First Name</label><input type="text" id="empFirstName"></div>
          <div class="form-group"><label>Last Name</label><input type="text" id="empLastName"></div>
        </div>
        <div class="form-group"><label>Email</label><input type="email" id="empEmail"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="empPhone"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group"><label>Role</label>
            <select id="empRole">
              <option value="technician">Technician</option>
              <option value="manager">Manager</option>
              <option value="service_advisor">Service Advisor</option>
              <option value="parts_manager">Parts Manager</option>
              <option value="sales">Sales</option>
            </select>
          </div>
          <div class="form-group"><label>Hourly Rate</label><input type="number" id="empRate" step="0.01"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeEmployeeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEmployee()">Save</button>
      </div>
    </div>
  </div>

  <div id="alert" class="alert"></div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let employees = [];
let workOrders = [];

async function checkAuth() {
  let { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refreshToken = localStorage.getItem('sb_refresh_token');
    if (token && refreshToken) {
      const { data, error } = await sb.auth.setSession({ access_token: token, refresh_token: refreshToken });
      if (error || !data.session) { window.location.href = 'login-worklogic.html'; return null; }
      return data.session;
    }
    window.location.href = 'login-worklogic.html';
    return null;
  }
  return session;
}

async function logout() {
  await sb.auth.signOut();
  localStorage.removeItem('sb_access_token');
  localStorage.removeItem('sb_refresh_token');
  window.location.href = 'login-worklogic.html?logout=1';
}

function showSection(section, el) {
  document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(`section-${section}`).classList.add('active');
}

function renderEmployees() {
  const grid = document.getElementById('employeeGrid');
  document.getElementById('empCount').textContent = employees.length;

  if (employees.length === 0) {
    grid.innerHTML = `<div class="add-card" onclick="openEmployeeModal()"><div class="add-card-plus">+</div><div class="add-card-text">Add First Employee</div></div>`;
    return;
  }

  let html = employees.map(emp => {
    const initials = `${(emp.first_name||'?')[0]}${(emp.last_name||'?')[0]}`.toUpperCase();
    const name = `${emp.first_name||''} ${emp.last_name||''}`.trim();
    const role = emp.role || 'technician';
    const roleLabel = role.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase());
    const rate = emp.hourly_labor_rate ? `$${parseFloat(emp.hourly_labor_rate).toFixed(0)}/hr` : '-';

    return `
      <div class="employee-card">
        <div class="emp-photo">${initials}</div>
        <div class="emp-actions">
          <button class="emp-btn" onclick="editEmployee('${emp.employee_id}')">Edit</button>
          <button class="emp-btn delete" onclick="deleteEmployee('${emp.employee_id}','${name}')">Delete</button>
        </div>
        <div class="emp-name">${name}</div>
        <div class="emp-role role-${role}">${roleLabel}</div>
        <div class="emp-info">${emp.email||'-'}</div>
        <div class="emp-rate">${rate}</div>
      </div>
    `;
  }).join('');

  html += `<div class="add-card" onclick="openEmployeeModal()"><div class="add-card-plus">+</div><div class="add-card-text">Add Employee</div></div>`;
  grid.innerHTML = html;
}

function openEmployeeModal() {
  document.getElementById('empModalTitle').textContent = 'Add Employee';
  document.getElementById('empFirstName').value = '';
  document.getElementById('empLastName').value = '';
  document.getElementById('empEmail').value = '';
  document.getElementById('empPhone').value = '';
  document.getElementById('empRole').value = 'technician';
  document.getElementById('empRate').value = '';
  document.getElementById('employeeModal').classList.add('show');
}

function closeEmployeeModal() { document.getElementById('employeeModal').classList.remove('show'); }

function editEmployee(id) {
  const emp = employees.find(e => e.employee_id === id);
  if (!emp) return;
  document.getElementById('empModalTitle').textContent = 'Edit Employee';
  document.getElementById('empFirstName').value = emp.first_name || '';
  document.getElementById('empLastName').value = emp.last_name || '';
  document.getElementById('empEmail').value = emp.email || '';
  document.getElementById('empPhone').value = emp.phone || '';
  document.getElementById('empRole').value = emp.role || 'technician';
  document.getElementById('empRate').value = emp.hourly_labor_rate || '';
  document.getElementById('employeeModal').classList.add('show');
}

function saveEmployee() { showAlert('Employee saved!', 'success'); closeEmployeeModal(); }

function deleteEmployee(id, name) {
  if (!confirm(`Remove ${name}?`)) return;
  employees = employees.filter(e => e.employee_id !== id);
  renderEmployees();
  showAlert(`${name} removed`, 'success');
}

async function loadBusinessSettings() {
  const { data } = await sb.from('business_settings').select('*').single();
  if (data) {
    document.getElementById('businessName').textContent = data.business_name || '';
    document.getElementById('bizName').value = data.business_name || '';
    document.getElementById('bizContact').value = data.contact_name || '';
    document.getElementById('bizEmail').value = data.contact_email || '';
    document.getElementById('bizPhone').value = data.contact_phone || '';
    document.getElementById('bizAddress').value = data.address || '';
    document.getElementById('bizCityState').value = data.business_city_state_zip || '';
    document.getElementById('laborRate').value = data.labor_rate || '';
    document.getElementById('taxRate').value = data.local_tax || '';
    document.getElementById('partsMarkup').value = data.parts_markup || '';
  }
}

function showAlert(msg, type) {
  const a = document.getElementById('alert');
  a.textContent = msg;
  a.className = `alert ${type} show`;
  setTimeout(() => a.classList.remove('show'), 3000);
}

async function load() {
  const session = await checkAuth();
  if (!session) return;

  await loadBusinessSettings();

  const { data: empData } = await sb.from('employees').select('*');
  employees = empData || [];

  const { data: woData } = await sb.from('work_orders').select('*');
  workOrders = woData || [];

  renderEmployees();
}

load();
</script>
</body>
</html>
