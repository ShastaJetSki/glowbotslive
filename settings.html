<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - WorkLogicPro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --bg: #0b0f14;
      --surface: #0f1621;
      --card: #1a2535;
      --text: #e8eef6;
      --text-secondary: #9fb0c3;
      --text-muted: #6b7280;
      --border: #223044;
      --green: #10b981;
      --yellow: #f59e0b;
      --red: #ef4444;
      --purple: #8b5cf6;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 { font-size: 24px; font-weight: 700; }
    .business-name { font-size: 14px; color: var(--primary); margin-top: 4px; }

    .header-nav { display: flex; gap: 8px; }
    .header-nav a {
      padding: 8px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      border-radius: 8px;
    }
    .header-nav a:hover { background: var(--card); }
    .header-nav a.active { background: var(--primary); color: #fff; }

    .logout-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
    }

    /* Layout */
    .settings-layout {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      gap: 24px;
    }

    /* Sidebar */
    .settings-sidebar { width: 200px; flex-shrink: 0; }

    .sidebar-nav {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      position: sticky;
      top: 90px;
    }

    .sidebar-title {
      padding: 16px 20px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }
    .sidebar-item:hover { background: var(--card); color: var(--text); }
    .sidebar-item.active {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .sidebar-badge {
      background: var(--primary);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* Main */
    .settings-main { flex: 1; min-width: 0; }

    .section { display: none; }
    .section.active { display: block; }

    .section-header { margin-bottom: 24px; }
    .section-title { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
    .section-subtitle { color: var(--text-secondary); font-size: 14px; }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title { font-size: 15px; font-weight: 700; }

    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-success { background: var(--green); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-danger { background: rgba(239,68,68,0.1); border: 1px solid var(--red); color: var(--red); }
    .btn-block { width: 100%; justify-content: center; }

    /* Employee Grid */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    .employee-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.2s;
    }
    .employee-card:hover { border-color: var(--primary); }

    .emp-photo-wrap { position: relative; display: inline-block; margin-bottom: 8px; }

    .emp-photo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--purple));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      border: 3px solid var(--border);
      overflow: hidden;
    }
    .emp-photo img { width: 100%; height: 100%; object-fit: cover; }

    .emp-actions {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
    }

    .emp-action-btn {
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .emp-action-btn:hover { border-color: var(--primary); color: var(--primary); }
    .emp-action-btn.delete:hover { border-color: var(--red); color: var(--red); }

    .emp-name { font-size: 15px; font-weight: 700; margin: 12px 0 4px; }

    .emp-role {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .role-owner { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .role-manager { background: rgba(139,92,246,0.2); color: #a78bfa; }
    .role-technician { background: rgba(16,185,129,0.2); color: #34d399; }
    .role-sales { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .role-parts_manager { background: rgba(236,72,153,0.2); color: #f472b6; }
    .role-service_advisor { background: rgba(20,184,166,0.2); color: #2dd4bf; }

    .emp-info { font-size: 11px; color: var(--text-muted); margin-bottom: 2px; }
    .emp-rate { font-size: 13px; font-weight: 600; color: var(--green); }

    .emp-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .emp-stat-value { font-size: 16px; font-weight: 700; color: var(--primary); }
    .emp-stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }

    /* Add Card */
    .add-card {
      background: var(--card);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 180px;
      transition: all 0.2s;
    }
    .add-card:hover { border-color: var(--primary); }

    .add-card-plus {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(59,130,246,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 10px;
      font-weight: 300;
    }

    .add-card-text { font-size: 13px; font-weight: 600; color: var(--text-secondary); }

    /* Media Grid */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .media-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .media-label { font-size: 13px; font-weight: 600; margin-bottom: 10px; }

    .media-preview {
      width: 100%;
      height: 90px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--surface);
    }
    .media-preview:hover { border-color: var(--primary); }

    .media-preview-text { font-size: 12px; color: var(--text-muted); }
    .media-hint { font-size: 10px; color: var(--text-muted); margin-top: 8px; }

    .media-btns { display: flex; gap: 8px; margin-top: 10px; }
    .media-btns .btn { flex: 1; font-size: 11px; padding: 8px 10px; }

    /* Social */
    .social-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .social-item { display: flex; align-items: center; gap: 10px; }

    .social-label {
      width: 80px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .social-item input {
      flex: 1;
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 12px;
    }

    /* Departments */
    .dept-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .dept-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .dept-info { flex: 1; }
    .dept-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .dept-desc { font-size: 11px; color: var(--text-muted); }

    .dept-toggle { position: relative; width: 44px; height: 24px; }
    .dept-toggle input { opacity: 0; width: 0; height: 0; }

    .dept-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--border);
      border-radius: 24px;
      transition: 0.3s;
    }

    .dept-slider:before {
      content: "";
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }

    input:checked + .dept-slider { background: var(--green); }
    input:checked + .dept-slider:before { transform: translateX(20px); }

    /* Promos */
    .promo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .promo-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }

    .promo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .promo-name { font-weight: 600; font-size: 14px; }

    .promo-status {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .promo-status.active { background: rgba(16,185,129,0.2); color: var(--green); }
    .promo-status.expired { background: rgba(107,114,128,0.2); color: var(--text-muted); }

    .promo-discount { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
    .promo-meta { font-size: 11px; color: var(--text-muted); }
    .promo-code { font-family: monospace; color: var(--green); }

    .promo-actions { display: flex; gap: 8px; margin-top: 12px; }
    .promo-actions .btn { flex: 1; font-size: 11px; padding: 8px; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show { display: flex; }

    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-width: 460px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h3 { font-size: 17px; }

    .modal-close {
      background: none;
      border: none;
      font-size: 22px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .modal-body { padding: 20px; }

    .modal-footer {
      padding: 14px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* Alert */
    .alert {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 22px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      display: none;
      z-index: 1001;
    }
    .alert.show { display: block; }
    .alert.success { background: var(--green); color: #fff; }

    /* Mobile */
    @media (max-width: 900px) {
      .settings-layout { flex-direction: column; }
      .settings-sidebar { width: 100%; }
      .sidebar-nav { position: static; display: flex; flex-wrap: wrap; gap: 4px; padding: 8px; }
      .sidebar-title { display: none; }
      .sidebar-item { padding: 10px 14px; border-left: none; border-radius: 8px; font-size: 13px; }
      .header-nav { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <h1>Settings</h1>
        <div class="business-name" id="businessName">Loading...</div>
      </div>
      <div class="header-nav">
        <a href="dashboard-business.html">Dashboard</a>
        <a href="dashboard-customer-search.html">Customers</a>
        <a href="dashboard-vehicle-search.html">Vehicles</a>
        <a href="dashboard-scheduling.html">Scheduling</a>
        <a href="dashboard-settings.html" class="active">Settings</a>
      </div>
      <button class="logout-btn" onclick="logout()">Sign Out</button>
    </div>
  </div>

  <div class="settings-layout">
    <!-- Sidebar -->
    <div class="settings-sidebar">
      <div class="sidebar-nav">
        <div class="sidebar-title">Settings</div>
        <div class="sidebar-item active" onclick="showSection('business', this)">Business</div>
        <div class="sidebar-item" onclick="showSection('employees', this)">
          Employees
          <span class="sidebar-badge" id="empCount">0</span>
        </div>
        <div class="sidebar-item" onclick="showSection('media', this)">Media</div>
        <div class="sidebar-item" onclick="showSection('promotions', this)">Promotions</div>
        <div class="sidebar-item" onclick="showSection('notifications', this)">Notifications</div>
        <div class="sidebar-item" onclick="showSection('departments', this)">Departments</div>
      </div>
    </div>

    <!-- Main -->
    <div class="settings-main">

      <!-- BUSINESS SECTION -->
      <div id="section-business" class="section active">
        <div class="section-header">
          <h2 class="section-title">Business Settings</h2>
          <p class="section-subtitle">Your business information and pricing</p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Business Information</div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Business Name</label>
              <input type="text" id="bizName" placeholder="Your Business Name">
            </div>
            <div class="form-group">
              <label>Contact Name</label>
              <input type="text" id="bizContact" placeholder="Owner Name">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="bizEmail" placeholder="contact@business.com">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="bizPhone" placeholder="(555) 555-5555">
            </div>
            <div class="form-group" style="grid-column: span 2;">
              <label>Address</label>
              <input type="text" id="bizAddress" placeholder="Street Address">
            </div>
            <div class="form-group">
              <label>City, State, ZIP</label>
              <input type="text" id="bizCityState" placeholder="City, ST 12345">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Rates and Pricing</div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Labor Rate ($/hr)</label>
              <input type="number" id="laborRate" step="0.01" placeholder="95.00">
            </div>
            <div class="form-group">
              <label>Tax Rate (%)</label>
              <input type="number" id="taxRate" step="0.01" placeholder="8.5">
            </div>
            <div class="form-group">
              <label>Parts Markup (%)</label>
              <input type="number" id="partsMarkup" step="0.01" placeholder="35">
            </div>
            <div class="form-group">
              <label>Shop Supplies (%)</label>
              <input type="number" id="shopFee" step="0.01" placeholder="3">
            </div>
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="saveBusinessSettings()">Save Business Settings</button>
      </div>

      <!-- EMPLOYEES SECTION -->
      <div id="section-employees" class="section">
        <div class="section-header">
          <h2 class="section-title">Employees</h2>
          <p class="section-subtitle">Manage your team members and roles</p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Team Members</div>
            <button class="btn btn-primary" onclick="openEmployeeModal()">+ Add Employee</button>
          </div>
          <div class="employee-grid" id="employeeGrid"></div>
        </div>
      </div>

      <!-- MEDIA SECTION -->
      <div id="section-media" class="section">
        <div class="section-header">
          <h2 class="section-title">Media and Branding</h2>
          <p class="section-subtitle">Upload logos, images, and manage social links</p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Business Images</div>
          </div>
          <div class="media-grid">
            <div class="media-card">
              <div class="media-label">Business Logo</div>
              <div class="media-preview" onclick="document.getElementById('logoUpload').click()">
                <div class="media-preview-text">Click to upload</div>
              </div>
              <input type="file" id="logoUpload" accept="image/*" style="display:none;">
              <div class="media-hint">200x200px, PNG or SVG</div>
              <div class="media-btns">
                <button class="btn btn-outline">Upload</button>
                <button class="btn btn-danger">Remove</button>
              </div>
            </div>
            <div class="media-card">
              <div class="media-label">Invoice Header</div>
              <div class="media-preview">
                <div class="media-preview-text">Click to upload</div>
              </div>
              <div class="media-hint">600x100px, top of invoices</div>
              <div class="media-btns">
                <button class="btn btn-outline">Upload</button>
                <button class="btn btn-danger">Remove</button>
              </div>
            </div>
            <div class="media-card">
              <div class="media-label">Email Header</div>
              <div class="media-preview">
                <div class="media-preview-text">Click to upload</div>
              </div>
              <div class="media-hint">600x150px, customer emails</div>
              <div class="media-btns">
                <button class="btn btn-outline">Upload</button>
                <button class="btn btn-danger">Remove</button>
              </div>
            </div>
            <div class="media-card">
              <div class="media-label">Receipt Footer</div>
              <div class="media-preview">
                <div class="media-preview-text">Click to upload</div>
              </div>
              <div class="media-hint">Printed receipt footer</div>
              <div class="media-btns">
                <button class="btn btn-outline">Upload</button>
                <button class="btn btn-danger">Remove</button>
              </div>
            </div>
            <div class="media-card">
              <div class="media-label">Photo Watermark</div>
              <div class="media-preview">
                <div class="media-preview-text">Click to upload</div>
              </div>
              <div class="media-hint">Transparent PNG</div>
              <div class="media-btns">
                <button class="btn btn-outline">Upload</button>
                <button class="btn btn-danger">Remove</button>
              </div>
            </div>
            <div class="media-card">
              <div class="media-label">Review QR Code</div>
              <div class="media-preview" style="background:#fff;">
                <div class="media-preview-text" style="color:#666;">Auto-generated</div>
              </div>
              <div class="media-hint">Scan for Google review</div>
              <div class="media-btns">
                <button class="btn btn-primary">Generate</button>
                <button class="btn btn-outline">Download</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Social Media Links</div>
          </div>
          <div class="social-grid">
            <div class="social-item"><span class="social-label">Website</span><input type="url" placeholder="https://yourwebsite.com"></div>
            <div class="social-item"><span class="social-label">Facebook</span><input type="url" placeholder="https://facebook.com/yourbusiness"></div>
            <div class="social-item"><span class="social-label">Instagram</span><input type="url" placeholder="https://instagram.com/yourbusiness"></div>
            <div class="social-item"><span class="social-label">Google</span><input type="url" placeholder="https://g.page/yourbusiness"></div>
            <div class="social-item"><span class="social-label">Yelp</span><input type="url" placeholder="https://yelp.com/biz/yourbusiness"></div>
            <div class="social-item"><span class="social-label">TikTok</span><input type="url" placeholder="https://tiktok.com/@yourbusiness"></div>
          </div>
          <button class="btn btn-success btn-block" style="margin-top:20px;" onclick="showAlert('Social links saved!', 'success')">Save Social Links</button>
        </div>
      </div>

      <!-- PROMOTIONS SECTION -->
      <div id="section-promotions" class="section">
        <div class="section-header">
          <h2 class="section-title">Promotions</h2>
          <p class="section-subtitle">Create discounts, coupons, and special offers</p>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Active Promotions</div>
            <button class="btn btn-primary" onclick="openPromoModal()">+ Create Promotion</button>
          </div>
          <div class="promo-grid" id="promoGrid"></div>
        </div>
      </div>

      <!-- NOTIFICATIONS SECTION -->
      <div id="section-notifications" class="section">
        <div class="section-header">
          <h2 class="section-title">Notifications</h2>
          <p class="section-subtitle">Configure email and SMS preferences</p>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:16px;">Customer Notifications</div>
          <div class="dept-grid">
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Work Order Created</div><div class="dept-desc">Email when new WO created</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Ready for Pickup</div><div class="dept-desc">Notify when vehicle ready</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Invoice Sent</div><div class="dept-desc">Email invoice to customer</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Service Reminders</div><div class="dept-desc">Automated service reminders</div></div>
              <label class="dept-toggle"><input type="checkbox"><span class="dept-slider"></span></label>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:16px;">Staff Notifications</div>
          <div class="dept-grid">
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Work Order Assigned</div><div class="dept-desc">Notify tech when assigned</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Low Inventory</div><div class="dept-desc">Alert when parts low</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Daily Summary</div><div class="dept-desc">Daily business summary email</div></div>
              <label class="dept-toggle"><input type="checkbox"><span class="dept-slider"></span></label>
            </div>
          </div>
        </div>
      </div>

      <!-- DEPARTMENTS SECTION -->
      <div id="section-departments" class="section">
        <div class="section-header">
          <h2 class="section-title">Departments</h2>
          <p class="section-subtitle">Enable or disable business modules</p>
        </div>
        <div class="card">
          <div class="dept-grid">
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Service Department</div><div class="dept-desc">Work orders, repairs, maintenance</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Parts Department</div><div class="dept-desc">Inventory, ordering, sales</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Sales Department</div><div class="dept-desc">Vehicle sales, deals, CRM</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Scheduling</div><div class="dept-desc">Appointments, calendar</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Reports and Analytics</div><div class="dept-desc">Business insights, KPIs</div></div>
              <label class="dept-toggle"><input type="checkbox" checked><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">AI Assistant</div><div class="dept-desc">Smart recommendations</div></div>
              <label class="dept-toggle"><input type="checkbox"><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Rental / Loaner</div><div class="dept-desc">Rental fleet management</div></div>
              <label class="dept-toggle"><input type="checkbox"><span class="dept-slider"></span></label>
            </div>
            <div class="dept-card">
              <div class="dept-info"><div class="dept-name">Fleet Management</div><div class="dept-desc">Commercial fleet tracking</div></div>
              <label class="dept-toggle"><input type="checkbox"><span class="dept-slider"></span></label>
            </div>
          </div>
        </div>
        <button class="btn btn-success btn-block" onclick="showAlert('Department settings saved!', 'success')">Save Departments</button>
      </div>

    </div>
  </div>

  <!-- Employee Modal -->
  <div id="employeeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="empModalTitle">Add Employee</h3>
        <button class="modal-close" onclick="closeEmployeeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Photo</label>
          <div style="display:flex; align-items:center; gap:14px;">
            <div id="empPhotoPreview" style="width:60px; height:60px; border-radius:50%; background:var(--card); border:2px dashed var(--border); display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--text-muted); overflow:hidden;">?</div>
            <div>
              <button class="btn btn-outline" style="font-size:12px;" onclick="document.getElementById('empPhotoInput').click()">Upload Photo</button>
              <input type="file" id="empPhotoInput" accept="image/*" style="display:none;">
              <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">Max 2MB</div>
            </div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group"><label>First Name</label><input type="text" id="empFirstName"></div>
          <div class="form-group"><label>Last Name</label><input type="text" id="empLastName"></div>
        </div>
        <div class="form-group"><label>Email</label><input type="email" id="empEmail"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="empPhone" placeholder="(555) 555-5555"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group">
            <label>Role</label>
            <select id="empRole">
              <option value="technician">Technician</option>
              <option value="manager">Manager</option>
              <option value="service_advisor">Service Advisor</option>
              <option value="parts_manager">Parts Manager</option>
              <option value="sales">Sales</option>
            </select>
          </div>
          <div class="form-group"><label>Hourly Rate ($)</label><input type="number" id="empRate" step="0.01" placeholder="65.00"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeEmployeeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEmployee()">Save Employee</button>
      </div>
    </div>
  </div>

  <!-- Promo Modal -->
  <div id="promoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create Promotion</h3>
        <button class="modal-close" onclick="closePromoModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label>Promotion Name</label><input type="text" id="promoName" placeholder="Summer Special"></div>
        <div class="form-group"><label>Description</label><textarea id="promoDesc" placeholder="Get 20% off all brake services..."></textarea></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group">
            <label>Discount Type</label>
            <select id="promoType">
              <option value="percent">Percentage Off</option>
              <option value="fixed">Fixed Amount Off</option>
              <option value="free">Free Service</option>
            </select>
          </div>
          <div class="form-group"><label>Discount Value</label><input type="number" id="promoValue" step="0.01" placeholder="20"></div>
        </div>
        <div class="form-group"><label>Promo Code</label><input type="text" id="promoCode" placeholder="SUMMER20" style="text-transform:uppercase;"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group"><label>Start Date</label><input type="date" id="promoStart"></div>
          <div class="form-group"><label>End Date</label><input type="date" id="promoEnd"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closePromoModal()">Cancel</button>
        <button class="btn btn-primary" onclick="savePromo()">Create Promotion</button>
      </div>
    </div>
  </div>

  <div id="alert" class="alert"></div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let employees = [];
let workOrders = [];

async function checkAuth() {
  let { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refreshToken = localStorage.getItem('sb_refresh_token');
    if (token && refreshToken) {
      const { data, error } = await sb.auth.setSession({ access_token: token, refresh_token: refreshToken });
      if (error || !data.session) { window.location.href = 'login-worklogic.html'; return null; }
      return data.session;
    }
    window.location.href = 'login-worklogic.html';
    return null;
  }
  return session;
}

async function logout() {
  await sb.auth.signOut();
  localStorage.removeItem('sb_access_token');
  localStorage.removeItem('sb_refresh_token');
  window.location.href = 'login-worklogic.html?logout=1';
}

function showSection(section, el) {
  document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(`section-${section}`).classList.add('active');
}

function renderEmployees() {
  const grid = document.getElementById('employeeGrid');
  document.getElementById('empCount').textContent = employees.length;

  if (employees.length === 0) {
    grid.innerHTML = `<div class="add-card" onclick="openEmployeeModal()"><div class="add-card-plus">+</div><div class="add-card-text">Add First Employee</div></div>`;
    return;
  }

  let html = employees.map(emp => {
    const initials = `${(emp.first_name||'?')[0]}${(emp.last_name||'?')[0]}`.toUpperCase();
    const name = `${emp.first_name||''} ${emp.last_name||''}`.trim();
    const role = emp.role || 'technician';
    const roleLabel = role.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase());
    const rate = emp.hourly_labor_rate ? `$${parseFloat(emp.hourly_labor_rate).toFixed(0)}/hr` : '-';
    const assigned = workOrders.filter(w => w.assigned_to === emp.employee_id).length;
    const completed = workOrders.filter(w => w.assigned_to === emp.employee_id && (w.status==='completed'||w.status==='closed')).length;

    return `
      <div class="employee-card">
        <div class="emp-photo-wrap">
          <div class="emp-photo">${emp.photo_url ? `<img src="${emp.photo_url}">` : initials}</div>
        </div>
        <div class="emp-actions">
          <button class="emp-action-btn" onclick="editEmployee('${emp.employee_id}')">Edit</button>
          <button class="emp-action-btn delete" onclick="deleteEmployee('${emp.employee_id}','${name}')">Delete</button>
        </div>
        <div class="emp-name">${name}</div>
        <div class="emp-role role-${role}">${roleLabel}</div>
        <div class="emp-info">${emp.email||'-'}</div>
        <div class="emp-rate">${rate}</div>
        <div class="emp-stats">
          <div><div class="emp-stat-value">${assigned}</div><div class="emp-stat-label">Assigned</div></div>
          <div><div class="emp-stat-value" style="color:var(--green);">${completed}</div><div class="emp-stat-label">Completed</div></div>
        </div>
      </div>
    `;
  }).join('');

  html += `<div class="add-card" onclick="openEmployeeModal()"><div class="add-card-plus">+</div><div class="add-card-text">Add Employee</div></div>`;
  grid.innerHTML = html;
}

function openEmployeeModal() {
  document.getElementById('empModalTitle').textContent = 'Add Employee';
  document.getElementById('empFirstName').value = '';
  document.getElementById('empLastName').value = '';
  document.getElementById('empEmail').value = '';
  document.getElementById('empPhone').value = '';
  document.getElementById('empRole').value = 'technician';
  document.getElementById('empRate').value = '';
  document.getElementById('employeeModal').classList.add('show');
}

function closeEmployeeModal() { document.getElementById('employeeModal').classList.remove('show'); }

function editEmployee(id) {
  const emp = employees.find(e => e.employee_id === id);
  if (!emp) return;
  document.getElementById('empModalTitle').textContent = 'Edit Employee';
  document.getElementById('empFirstName').value = emp.first_name || '';
  document.getElementById('empLastName').value = emp.last_name || '';
  document.getElementById('empEmail').value = emp.email || '';
  document.getElementById('empPhone').value = emp.phone || '';
  document.getElementById('empRole').value = emp.role || 'technician';
  document.getElementById('empRate').value = emp.hourly_labor_rate || '';
  document.getElementById('employeeModal').classList.add('show');
}

function saveEmployee() { showAlert('Employee saved!', 'success'); closeEmployeeModal(); }

function deleteEmployee(id, name) {
  if (!confirm(`Remove ${name}?`)) return;
  employees = employees.filter(e => e.employee_id !== id);
  renderEmployees();
  showAlert(`${name} removed`, 'success');
}

function renderPromos() {
  const grid = document.getElementById('promoGrid');
  const promos = [
    { name: 'Summer Special', discount: '20% OFF', code: 'SUMMER20', status: 'active', uses: 47 },
    { name: 'New Customer', discount: '$50 OFF', code: 'WELCOME50', status: 'active', uses: 123 },
    { name: 'Oil Change Deal', discount: 'FREE ROTATE', code: 'FREEROTATE', status: 'expired', uses: 89 }
  ];

  let html = promos.map(p => `
    <div class="promo-card">
      <div class="promo-header">
        <span class="promo-name">${p.name}</span>
        <span class="promo-status ${p.status}">${p.status.toUpperCase()}</span>
      </div>
      <div class="promo-discount">${p.discount}</div>
      <div class="promo-meta">Code: <span class="promo-code">${p.code}</span> | ${p.uses} uses</div>
      <div class="promo-actions">
        <button class="btn btn-outline">Edit</button>
        <button class="btn btn-danger">Delete</button>
      </div>
    </div>
  `).join('');

  html += `<div class="add-card" style="min-height:140px;" onclick="openPromoModal()"><div class="add-card-plus" style="background:rgba(16,185,129,0.1); color:var(--green);">+</div><div class="add-card-text">Create Promotion</div></div>`;
  grid.innerHTML = html;
}

function openPromoModal() { document.getElementById('promoModal').classList.add('show'); }
function closePromoModal() { document.getElementById('promoModal').classList.remove('show'); }
function savePromo() { showAlert('Promotion created!', 'success'); closePromoModal(); }

async function loadBusinessSettings() {
  const { data } = await sb.from('business_settings').select('*').single();
  if (data) {
    document.getElementById('businessName').textContent = data.business_name || '';
    document.getElementById('bizName').value = data.business_name || '';
    document.getElementById('bizContact').value = data.contact_name || '';
    document.getElementById('bizEmail').value = data.contact_email || '';
    document.getElementById('bizPhone').value = data.contact_phone || '';
    document.getElementById('bizAddress').value = data.address || '';
    document.getElementById('bizCityState').value = data.business_city_state_zip || '';
    document.getElementById('laborRate').value = data.labor_rate || '';
    document.getElementById('taxRate').value = data.local_tax || '';
    document.getElementById('partsMarkup').value = data.parts_markup || '';
  }
}

function saveBusinessSettings() { showAlert('Business settings saved!', 'success'); }

function showAlert(msg, type) {
  const a = document.getElementById('alert');
  a.textContent = msg;
  a.className = `alert ${type} show`;
  setTimeout(() => a.classList.remove('show'), 3000);
}

async function load() {
  const session = await checkAuth();
  if (!session) return;

  await loadBusinessSettings();

  const { data: empData } = await sb.from('employees').select('*');
  employees = empData || [];

  const { data: woData } = await sb.from('work_orders').select('*');
  workOrders = woData || [];

  renderEmployees();
  renderPromos();
}

load();
</script>
</body>
</html>
