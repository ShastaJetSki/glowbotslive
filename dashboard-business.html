<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Business Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }

    /* pin app name top-right */
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; display:flex; align-items:center; gap:10px; }

    .row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px; }
    .card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:14px 16px; }

    button {
      padding:8px 14px; border-radius:10px; border:1px solid #2a3b55;
      background:#1a2535; color:#fff; cursor:pointer;
    }

    .filters { display:flex; gap:8px; margin: 8px 0 14px; flex-wrap:wrap; }
    .pill {
      padding:6px 10px; border-radius:10px; border:1px solid #223044;
      background:#0f1621; color:#e8eef6; cursor:pointer; font-size:12px;
      user-select:none;
    }
    .pill.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

    /* KPI */
    .kpi { min-width:260px; flex: 1 1 260px; cursor:pointer; }
    .kpi:hover { border-color:#2f4461; }
    .label { font-size:12px; color:#9fb0c3; }
    .value { font-size:18px; font-weight:650; margin-top:6px; line-height:1.3; }
    .muted { font-size:12px; color:#9fb0c3; margin-top:6px; }
    .error { color:#ffb3b3; white-space:pre-wrap; }

    /* TECH card (manager capacity) */
    .tech {
      min-width:320px; flex: 1 1 320px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer;
    }
    .tech.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

    .techLeft { display:flex; flex-direction:column; gap:8px; min-width:0; }
    .metric { font-size:18px; font-weight:700; }
    .sub { font-size:12px; color:#9fb0c3; }

    .load { font-size:12px; font-weight:700; }
    .load.light { color:#4ade80; }
    .load.normal { color:#60a5fa; }
    .load.heavy { color:#f59e0b; }
    .load.over { color:#ef4444; }

    .techRight { display:flex; flex-direction:column; align-items:center; gap:8px; min-width:96px; }
    .avatar {
      width:66px; height:66px; border-radius:999px;
      border:1px solid #223044; background:#0b0f14;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:20px; color:#e8eef6;
    }

    /* --- overdue red dot (tiny + bright) --- */
    .dot{
      display:inline-block;
      width:5px;
      height:5px;
      border-radius:50%;
      background:#ff2d2d;
      box-shadow:0 0 7px #ff2d2d;
      margin-right:6px;
      transform: translateY(-1px);
    }

    .techName { font-size:12px; text-align:center; line-height:1.2; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .wo strong { font-weight:650; }

    .woRow { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .woStatus { font-size:12px; color:#9fb0c3; }

    /* Priority badge */
    .priority {
      display:inline-block;
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      margin-right:6px;
    }
    .priority.urgent { background:#ef4444; color:#fff; }
    .priority.high { background:#f59e0b; color:#fff; }
    .priority.normal { background:#3b82f6; color:#fff; }
    .priority.low { background:#6b7280; color:#fff; }

    /* Work order card right side */
    .woRight {
      text-align:right;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      align-items:flex-end;
      min-width:100px;
      align-self:stretch;
    }
    .woRevenue {
      font-size:14px;
      font-weight:700;
      color:#e8eef6;
    }
    .woTech {
      font-size:11px;
      color:#9fb0c3;
      margin-top:4px;
    }

    /* Edit button */
    .editBtn {
      padding:6px 16px;
      border-radius:6px;
      border:1px solid #3b82f6;
      background:#1e3a5f;
      color:#60a5fa;
      font-size:12px;
      cursor:pointer;
      margin-top:auto;
    }
    .editBtn:hover {
      background:#2563eb;
      color:#fff;
    }

    /* Modal */
    .modal {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.85);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .modal.active { display:flex; }
    .modalContent {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:14px;
      padding:24px;
      max-width:600px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
    }
    .modalHeader {
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:1px solid #223044;
    }
    .modalTitle {
      font-size:20px;
      font-weight:700;
      color:#e8eef6;
    }
    .modalBody {
      flex:1;
      overflow-y:auto;
    }
    .modalFooter {
      display:flex;
      justify-content:center;
      padding-top:20px;
      margin-top:20px;
      border-top:1px solid #223044;
    }
    .closeBtn {
      padding:10px 32px;
      border-radius:8px;
      border:1px solid #3b82f6;
      background:#1e3a5f;
      color:#60a5fa;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
    }
    .closeBtn:hover {
      background:#2563eb;
      color:#fff;
      border-color:#60a5fa;
    }
    .detailRow {
      display:flex;
      padding:12px 0;
      border-bottom:1px solid #1a2535;
    }
    .detailRow:last-child {
      border-bottom:none;
    }
    .detailLabel {
      font-size:12px;
      color:#9fb0c3;
      width:140px;
      flex-shrink:0;
      font-weight:600;
    }
    .detailValue {
      font-size:14px;
      color:#e8eef6;
      flex:1;
    }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <h1 id="tenantTitle">Business Dashboard</h1>
    <button onclick="logout()">Logout</button>
  </header>

  <!-- KPI row -->
  <div class="row" id="kpis"></div>

  <!-- RANGE buttons stay ABOVE TECHS -->
  <div class="filters">
    <div class="pill active" id="btnToday" onclick="setRange('today')">Today</div>
    <div class="pill" id="btnNext7" onclick="setRange('next7')">Next 7 Days</div>
    <div class="pill" id="btnNext30" onclick="setRange('next30')">Next 30 Days</div>
  </div>

  <!-- Tech cards -->
  <h2>Technicians</h2>
  <div class="row" id="techCards"></div>

  <!-- The rest of the buttons go back ABOVE WORK ORDERS -->
  <div class="filters">
    <div class="pill" id="btnAll" onclick="setRange('all')">All</div>
    <div class="pill" id="btnUnassigned" onclick="filterUnassigned()">Unassigned</div>
    <div class="pill" id="sortPriority" onclick="setSort('priority')">Priority</div>
    <div class="pill" onclick="clearFilters()">Clear Filters</div>
  </div>

  <!-- Work Orders -->
  <h2>
    Work Orders
    <button onclick="createWorkOrder()">+ New Work Order</button>
  </h2>
  <div id="workOrders">Loading‚Ä¶</div>

  <!-- Modal removed - using work-order-edit.html instead -->

<script>
  console.log('üöÄ Dashboard script loading...');
  
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
  const REST_BASE = `${API_BASE}/rest/v1`;
  const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

  console.log('üì° API configured:', { FUNCTIONS_BASE, REST_BASE });

  // Business Settings - Shop Labor Rate from localStorage
  const RATE_KEY = "wl_labor_rate";
  const DEFAULT_LABOR_RATE = 125;
  function getShopLaborRate(){
    const v = Number(localStorage.getItem(RATE_KEY));
    return Number.isFinite(v) && v > 0 ? v : DEFAULT_LABOR_RATE;
  }

  // SSOT status buckets
  const STATUS_BUCKETS = {
    scheduled: ["draft","scheduled","in_progress","repairing","testing","ready_for_pickup"],
    waiting: ["awaiting_parts","parts_on_order"],
    complications: ["diagnosis_required","customer_approval"],
    completed: ["completed","closed"]
  };
  function statusIn(bucket, status){
    return (STATUS_BUCKETS[bucket] || []).includes(status);
  }

  // State
  let employees = [];
  let employeesById = {};
  let technicians = [];
  let orders = [];
  let customers = [];
  let customersById = {};
  let vehicles = [];
  let vehiclesById = {};

  let activeTechId = null;
  let activeRange = "today";
  let activeKpi = null;
  let activeSort = null;

  // Date helpers
  function startOfToday(){ const d = new Date(); d.setHours(0,0,0,0); return d; }
  function endOfToday(){ const d = new Date(); d.setHours(23,59,59,999); return d; }
  function startOfNext7Days(){ 
    const d = new Date(); 
    d.setHours(0,0,0,0); 
    return d; 
  }
  function endOfNext7Days(){ 
    const d = new Date(); 
    d.setDate(d.getDate() + 7);
    d.setHours(23,59,59,999); 
    return d; 
  }
  function startOfNext30Days(){ 
    const d = new Date(); 
    d.setHours(0,0,0,0); 
    return d; 
  }
  function endOfNext30Days(){ 
    const d = new Date(); 
    d.setDate(d.getDate() + 30);
    d.setHours(23,59,59,999); 
    return d; 
  }

  function money(n){ return `$${Number(n || 0).toFixed(0)}`; }

  function logout(){
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
  }

  async function validateAuth(){
    const token = localStorage.getItem("sb_access_token");
    if (!token) return null;

    const res = await fetch(`${API_BASE}/auth/v1/user`, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });

    if (!res.ok) return null;
    return token;
  }

  async function fetchJson(url, token){
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function fetchRest(table, token){
    const res = await fetch(`${REST_BASE}/${table}?select=*`, {
      headers: { 
        Authorization: `Bearer ${token}`, 
        apikey: ANON_KEY,
        'Content-Type': 'application/json'
      }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function createWorkOrder(){
    location.href = "work-order-new.html";
  }

  // Calculate hours from scheduled times
  function jobHours(w){
    if (w.scheduled_start && w.scheduled_end) {
      return (new Date(w.scheduled_end) - new Date(w.scheduled_start)) / 36e5;
    }
    // Fallback estimates by status
    if (w.status === "diagnosis_required") return 2;
    if (w.status === "awaiting_parts") return 1;
    if (["scheduled","in_progress","repairing","testing","ready_for_pickup"].includes(w.status)) return 3;
    return 0;
  }

  // Calculate revenue using shop labor rate
  function jobRevenue(w){
    const hours = jobHours(w);
    const shopRate = getShopLaborRate();
    return hours * shopRate;
  }

  // Format as "15.3h / $1,913"
  function formatHrsRev(hours){
    const shopRate = getShopLaborRate();
    const rev = hours * shopRate;
    return `${Number(hours || 0).toFixed(1)}h / ${money(rev)}`;
  }

  // OVERDUE LOGIC: scheduled_start < NOW AND status NOT IN ('completed','closed')
  function isOverdue(w){
    if (!w.scheduled_start) return false;
    if (["completed","closed"].includes(w.status)) return false;
    return new Date(w.scheduled_start) < new Date();
  }

  function inRange(w){
    if (activeRange === "all") return true;

    const d = w.scheduled_start ? new Date(w.scheduled_start) : null;
    const sToday = startOfToday();
    const eToday = endOfToday();
    const sNext7 = startOfNext7Days();
    const eNext7 = endOfNext7Days();
    const sNext30 = startOfNext30Days();
    const eNext30 = endOfNext30Days();

    if (activeRange === "today") {
      if (!d && w.status === "scheduled") return true;
      return d && d >= sToday && d <= eToday;
    }
    if (activeRange === "next7") {
      if (!d && w.status === "scheduled") return true;
      return d && d >= sNext7 && d <= eNext7;
    }
    if (activeRange === "next30") {
      if (!d && w.status === "scheduled") return true;
      return d && d >= sNext30 && d <= eNext30;
    }
    return true;
  }

  function initialsFromName(name){
    const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
    if (!parts.length) return "??";
    return (parts[0][0] + (parts[1]?.[0] || "")).toUpperCase();
  }

  function techDisplayName(t){
    const first = (t.first_name || "").trim();
    const last = (t.last_name || "").trim();
    return (first || last) ? `${first} ${last}`.trim() : (t.name || "Tech");
  }

  function setTenantTitleSafely(){
    const el = document.getElementById("tenantTitle");
    const name =
      orders.find(o => o.tenant_name)?.tenant_name ||
      employees.find(e => e.tenant_name)?.tenant_name ||
      "Business Dashboard";
    el.textContent = name;
  }

  /* KPI rendering - Filters tech cards when clicked */
  function renderKPIs(){
    const inView = orders.filter(w => inRange(w));

    const scheduled = inView.filter(w => statusIn("scheduled", w.status));
    const waiting = inView.filter(w => statusIn("waiting", w.status));
    const complications = inView.filter(w => statusIn("complications", w.status));
    const completed = inView.filter(w => statusIn("completed", w.status));

    function sumH(arr){ return arr.reduce((s,w)=> s + jobHours(w), 0); }

    const kpiCard = (key, title, arr) => {
      const hours = sumH(arr);
      return `
        <div class="card kpi ${activeKpi===key?'active':''}" onclick="toggleKpi('${key}')">
          <div class="label">${title}</div>
          <div class="value">${formatHrsRev(hours)}</div>
          <div class="muted">Jobs: ${arr.length}</div>
        </div>
      `;
    };

    document.getElementById("kpis").innerHTML =
      kpiCard("scheduled", "Scheduled Work", scheduled) +
      kpiCard("waiting", "Waiting on Parts", waiting) +
      kpiCard("complications", "Needs Approval", complications) +
      kpiCard("completed", "Ready for Pickup", completed);
  }

  window.toggleKpi = function(key){
    activeKpi = (activeKpi === key) ? null : key;
    renderKPIs();
    renderTechCards(); // KPI filters tech cards
    renderWorkOrders();
  };

  window.setRange = function(r){
    activeRange = r;

    const btnToday = document.getElementById("btnToday");
    const btnNext7 = document.getElementById("btnNext7");
    const btnNext30 = document.getElementById("btnNext30");
    const btnAll   = document.getElementById("btnAll");

    if (btnToday) btnToday.classList.toggle("active", r==="today");
    if (btnNext7) btnNext7.classList.toggle("active", r==="next7");
    if (btnNext30) btnNext30.classList.toggle("active", r==="next30");
    if (btnAll)   btnAll.classList.toggle("active", r==="all");

    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  };

  window.setSort = function(s){
    activeSort = s;
    const p = document.getElementById("sortPriority");
    if (p) p.classList.toggle("active", s === "priority");
    renderWorkOrders();
  };

  window.filterUnassigned = function(){
    activeTechId = "__unassigned__";
    document.getElementById("btnUnassigned").classList.add("active");
    renderTechCards();
    renderWorkOrders();
  };

  window.clearFilters = function(){
    activeTechId = null;
    activeKpi = null;
    activeRange = "today";
    activeSort = null;

    const btnToday = document.getElementById("btnToday");
    const btnNext7 = document.getElementById("btnNext7");
    const btnNext30 = document.getElementById("btnNext30");
    const btnAll   = document.getElementById("btnAll");
    const sortPriority = document.getElementById("sortPriority");
    const btnUnassigned = document.getElementById("btnUnassigned");

    if (btnToday) btnToday.classList.add("active");
    if (btnNext7) btnNext7.classList.remove("active");
    if (btnNext30) btnNext30.classList.remove("active");
    if (btnAll)   btnAll.classList.remove("active");
    if (sortPriority) sortPriority.classList.remove("active");
    if (btnUnassigned) btnUnassigned.classList.remove("active");

    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  };

  /* Tech cards - Filters work orders when clicked */
  function renderTechCards(){
    document.getElementById("techCards").innerHTML =
      technicians.map(t=>{
        const name = techDisplayName(t);
        const initials = initialsFromName(name);

        // Tech card shows jobs in current range AND KPI filter
        const mine = orders.filter(w =>
          w.assigned_employee_id === t.employee_id &&
          inRange(w) &&
          (!activeKpi || statusIn(activeKpi, w.status))
        );

        // RED DOT: Check if this tech has ANY overdue work orders (ignores filters)
        const hasOverdue = orders.some(w => 
          w.assigned_employee_id === t.employee_id && 
          isOverdue(w)
        );

        // FILTERED RANGE hours (respects current filter: today, next7, next30, or all)
        const filteredH = mine.reduce((sum, w) => sum + jobHours(w), 0);

        // Calculate utilization based on filtered range
        let totalAvailableHours = 8; // default for today
        let rangeLabel = "Today";
        
        if (activeRange === "next7") {
          totalAvailableHours = 40; // 5 days * 8 hours
          rangeLabel = "Next 7 Days";
        } else if (activeRange === "next30") {
          totalAvailableHours = 160; // ~20 working days * 8 hours
          rangeLabel = "Next 30 Days";
        } else if (activeRange === "all") {
          totalAvailableHours = 160; // Show as monthly for "all"
          rangeLabel = "All Time";
        }

        const utilizationPct = totalAvailableHours > 0 ? (filteredH / totalAvailableHours) * 100 : 0;

        // Color coding based on utilization
        let cls="light", lbl="LIGHT";
        if (utilizationPct >= 50) { cls="normal"; lbl="NORMAL"; }
        if (utilizationPct >= 80) { cls="heavy"; lbl="HEAVY"; }
        if (utilizationPct > 100) { cls="over";  lbl="OVERBOOKED"; }

        const active = activeTechId === t.employee_id ? "active" : "";

        return `
          <div class="card tech ${active}" onclick="selectTech('${t.employee_id}')">
            <div class="techLeft">
              <div class="metric">${formatHrsRev(filteredH)}</div>
              <div class="sub">Booked (${rangeLabel})</div>

              <div class="metric">${utilizationPct.toFixed(0)}%</div>
              <div class="sub">Utilization</div>

              <div class="load ${cls}">${hasOverdue ? '<span class="dot"></span>' : ''}${lbl}</div>
            </div>

            <div class="techRight">
              <div class="avatar">${initials}</div>
              <div class="techName">${name}</div>
            </div>
          </div>
        `;
      }).join("");
  }

  window.selectTech = function(id){
    activeTechId = (activeTechId === id) ? null : id;
    renderTechCards();
    renderWorkOrders(); // Tech card filters work orders
  };

  function priorityRank(p){
    const v = String(p || "").toLowerCase();
    if (v === "urgent" || v === "high") return 0;
    if (v === "medium") return 1;
    if (v === "low") return 2;
    return 3;
  }

  function workOrdersFiltered(){
    let arr = orders.filter(w => inRange(w));

    if (!activeKpi) arr = arr.filter(w => !statusIn("completed", w.status));

    if (activeKpi) arr = arr.filter(w => statusIn(activeKpi, w.status));

    if (activeTechId === "__unassigned__") {
      arr = arr.filter(w => !w.assigned_employee_id && !w.assigned_to);
    } else if (activeTechId) {
      arr = arr.filter(w => 
        w.assigned_employee_id === activeTechId || 
        w.assigned_to === activeTechId
      );
    }

    return arr;
  }

  function priorityBadge(priority){
    const p = String(priority || "normal").toLowerCase();
    return `<span class="priority ${p}">${p}</span>`;
  }

  /* ========== WORK ORDERS SECTION ========== */

  /* Work orders - OPTION 3: Clean display with job summary in title */
  function renderWorkOrders(){
    const list = document.getElementById("workOrders");
    const filtered = workOrdersFiltered();

    if (!filtered.length) {
      list.innerHTML = `<div class="muted">No work orders for this view.</div>`;
      return;
    }

    filtered.sort((a,b)=>{
      if (activeSort === "priority") {
        const pr = priorityRank(a.priority) - priorityRank(b.priority);
        if (pr !== 0) return pr;
      }
      const da = a.scheduled_start ? new Date(a.scheduled_start).getTime() : Number.MAX_SAFE_INTEGER;
      const db = b.scheduled_start ? new Date(b.scheduled_start).getTime() : Number.MAX_SAFE_INTEGER;
      return da - db;
    });

    list.innerHTML = filtered.map(w=>{
      // Get customer info
      const customer = customersById[w.customer_id];
      const customerName = customer 
        ? `${customer.first_name || ''} ${customer.last_name || ''}`.trim() 
        : "Unknown Customer";
      const customerPhone = customer?.phone || "";

      // Get vehicle info
      const vehicle = vehiclesById[w.vehicle_id];
      const vehicleDisplay = vehicle 
        ? `${vehicle.year || ''} ${vehicle.make || ''} ${vehicle.model || ''}`.trim()
        : "";

      // Get tech info
      const techId = w.assigned_employee_id || w.assigned_to;
      const tech = techId ? employeesById[techId] : null;
      
      // Debug logging
      if (!tech && techId) {
        console.log('Tech not found:', {
          workOrderId: w.work_order_id,
          techId: techId,
          assigned_employee_id: w.assigned_employee_id,
          assigned_to: w.assigned_to,
          availableTechs: Object.keys(employeesById)
        });
      }
      
      const techName = tech 
        ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() || "Unknown Tech"
        : "Unassigned";

      // Calculate revenue
      const hours = jobHours(w);

      // Get job summary
      const jobDesc = w.summary || "No description";

      // RED DOT: Show if this work order is overdue
      const overdueIndicator = isOverdue(w) ? '<span class="dot"></span>' : '';

      return `
        <div class="card wo" onclick="window.location.href='work-order-edit.html?id=${w.work_order_id}'" style="cursor:pointer;">
          <div class="woRow">
            <div style="flex:1;">
              <div style="margin-bottom:4px;">
                <strong>${customerName}</strong>
              </div>
              <div style="margin-bottom:4px;">
                ${jobDesc}
              </div>
              <div class="muted" style="margin-bottom:8px;">${vehicleDisplay}</div>
              <div style="display:flex; align-items:center; gap:8px;">
                ${overdueIndicator}${priorityBadge(w.priority)}
                <span class="woStatus">${w.status}</span>
              </div>
            </div>
            <div class="woRight">
              <div style="text-align:right;">
                <div class="woRevenue">${formatHrsRev(hours)}</div>
                <div class="woTech">${techName}</div>
              </div>
              <button class="editBtn" onclick="event.stopPropagation(); window.location.href='work-order-edit.html?id=${w.work_order_id}'">Edit</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function load(){
    console.log('üîÑ Starting data load...');
    
    const token = await validateAuth();
    if (!token) {
      console.log('‚ùå No auth token, redirecting to login');
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
      return;
    }

    console.log('‚úÖ Auth token validated');

    try {
      console.log('üì• Fetching data from APIs...');
      
      const [rawEmployees, rawOrders, rawCustomers, rawVehicles] = await Promise.all([
        fetchJson(`${FUNCTIONS_BASE}/employees`, token),
        fetchJson(`${FUNCTIONS_BASE}/work_orders`, token),
        fetchRest('customers', token),
        fetchRest('vehicles', token)
      ]);

      console.log('üìä Raw data received:', {
        employees: rawEmployees?.length || 0,
        orders: rawOrders?.length || 0,
        customers: rawCustomers?.length || 0,
        vehicles: rawVehicles?.length || 0
      });

      // Process employees
      employees = rawEmployees.map(e => ({ 
        ...e, 
        name: techDisplayName(e)
      }));
      employeesById = {};
      employees.forEach(e => employeesById[e.employee_id] = e);
      technicians = employees.filter(e => e.role === "technician");

      // Process customers
      customers = Array.isArray(rawCustomers) ? rawCustomers : [];
      customersById = {};
      customers.forEach(c => customersById[c.customer_id] = c);

      // Process vehicles
      vehicles = Array.isArray(rawVehicles) ? rawVehicles : [];
      vehiclesById = {};
      vehicles.forEach(v => vehiclesById[v.vehicle_id] = v);

      // Process work orders
      orders = (Array.isArray(rawOrders) ? rawOrders : []).map(w => ({
        ...w,
        assigned_employee_id: w.assigned_employee_id || null,
        assigned_to: w.assigned_to || null
      }));

      // Debug: Log tech assignment info
      console.log('=== TECH ASSIGNMENT DEBUG ===');
      console.log('Total work orders:', orders.length);
      console.log('Available techs:', Object.keys(employeesById));
      console.log('Technician details:', technicians.map(t => ({
        id: t.employee_id,
        name: `${t.first_name} ${t.last_name}`
      })));
      
      const assignedCount = orders.filter(w => w.assigned_employee_id || w.assigned_to).length;
      const unassignedCount = orders.length - assignedCount;
      console.log('Assigned orders:', assignedCount);
      console.log('Unassigned orders:', unassignedCount);
      
      // Check for mismatched tech IDs
      const uniqueTechIds = new Set();
      orders.forEach(w => {
        const techId = w.assigned_employee_id || w.assigned_to;
        if (techId) uniqueTechIds.add(techId);
      });
      console.log('Unique tech IDs in work orders:', Array.from(uniqueTechIds));
      
      // Find tech IDs that don't match
      uniqueTechIds.forEach(tid => {
        if (!employeesById[tid]) {
          console.warn(`‚ö†Ô∏è Work order has unknown tech ID: ${tid}`);
        }
      });
      
      // Debug first 3 work orders
      console.log('First 3 work orders with tech info:');
      orders.slice(0, 3).forEach(w => {
        const techId = w.assigned_employee_id || w.assigned_to;
        const tech = techId ? employeesById[techId] : null;
        console.log({
          summary: w.summary,
          techId: techId,
          tech: tech ? {
            id: tech.employee_id,
            first_name: tech.first_name,
            last_name: tech.last_name,
            fullName: `${tech.first_name || ''} ${tech.last_name || ''}`.trim()
          } : 'NO TECH FOUND'
        });
      });
      
      console.log('=========================');

      setTenantTitleSafely();

      renderKPIs();
      renderTechCards();
      renderWorkOrders();

      setRange("today");
      setSort(null);

      console.log('‚úÖ Dashboard loaded successfully!');

    } catch (err) {
      console.error('‚ùå Dashboard load error:', err);
      document.getElementById("workOrders").innerHTML =
        `<div class="error">DASHBOARD ERROR:\n${err?.message || err}</div>`;
    }
  }

  console.log('üé¨ Starting dashboard load...');
  load();
</script>

</body>
</html>
