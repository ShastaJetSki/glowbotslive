<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="stylesheet" href="theme-system.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: var(--bg-primary, #0b0f14); color: var(--text-primary, #e8eef6); }
    
    .desktop-header {
      position: sticky; top: 0; z-index: 100;
      background: var(--bg-primary, #0b0f14); border-bottom: 1px solid var(--border-default, #223044);
    }
    
    .mobile-top-header {
      display: none; position: sticky; top: 0; z-index: 100;
      background: var(--bg-secondary, #0f1621); border-bottom: 1px solid var(--border-default, #223044);
    }

    .mobile-header-bar {
      display: flex; justify-content: space-between;
      align-items: center; padding: 12px;
    }

    .mobile-menu-toggle {
      background: transparent; border: 1px solid transparent;
      border-radius: 6px; color: var(--text-secondary, #6b7280); font-size: 20px;
      padding: 0; width: 36px; height: 36px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    .mobile-header-center { flex: 1; margin-left: 12px; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }

    .mobile-header-content {
      max-height: 0; overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .mobile-header-content.expanded { max-height: 200px; }

    .mobile-header-actions {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 8px; padding: 8px 12px 12px;
      background: var(--bg-primary, #0b0f14); border-top: 1px solid var(--border-default, #223044);
    }

    .mobile-header-actions button {
      padding: 10px; font-size: 13px;
      background: var(--bg-card, #1a2535); border: 1px solid var(--accent-primary, #3b82f6);
      color: var(--text-primary, #e8eef6); border-radius: 8px; cursor: pointer;
    }

    .mobile-bottom-nav {
      display: none; position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--bg-secondary, #0f1621); padding: 8px; z-index: 100;
    }

    .mobile-nav-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 6px; margin-bottom: 6px;
    }

    .mobile-nav-secondary {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
    }

    .mobile-nav-btn {
      padding: 10px 8px; border-radius: 8px;
      border: 1px solid var(--border-default, #223044); background: var(--bg-card, #1a2535);
      color: var(--text-secondary, #9fb0c3); font-size: 12px; font-weight: 600;
      cursor: pointer; text-decoration: none;
      display: flex; align-items: center; justify-content: center;
      min-height: 44px;
    }
    
    .mobile-nav-grid .mobile-nav-btn { background: var(--bg-hover, #1f2e40); }
    .mobile-nav-btn.active { background: var(--accent-primary, #3b82f6); border-color: var(--accent-primary, #3b82f6); color: #fff; }
    
    .content { flex: 1; padding: 20px; }
    
    /* Fixed filter bar above mobile nav */
    .filter-bar-fixed {
      display: none;
      position: fixed;
      bottom: 102px;
      left: 0;
      right: 0;
      background: var(--bg-card, #1a2535);
      border-top: 1px solid var(--border-default, #223044);
      padding: 10px 12px;
      z-index: 99;
    }
    
    .filter-bar-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .filter-bar-fixed .range-select {
      flex: 1;
      padding: 10px 12px;
      font-size: 13px;
      min-width: 0;
    }
    
    .filter-bar-fixed .direction-btn {
      padding: 10px 16px;
      font-size: 13px;
      min-width: auto;
    }
    
    .filter-bar-fixed .date-display {
      width: 100%;
      text-align: center;
      font-size: 11px;
      color: var(--accent-light, #60a5fa);
      margin-top: 6px;
    }
    
    .top-bar { 
      background: var(--bg-card, #1a2535); border-bottom: 1px solid var(--border-default, #2d3f56); 
      padding: 16px 20px; margin-bottom: 20px; 
    }
    
    .date-range-container {
      display: flex; gap: 12px; align-items: center;
      justify-content: center; margin-bottom: 12px; flex-wrap: wrap;
    }
    
    .range-select {
      padding: 12px 16px; border-radius: 8px;
      border: 2px solid var(--border-default, #223044); background: var(--bg-secondary, #0f1621);
      color: var(--text-primary, #e8eef6); font-size: 14px; font-weight: 600;
      cursor: pointer; min-width: 180px;
    }
    
    .direction-toggle { display: flex; gap: 8px; }
    
    .direction-btn {
      padding: 12px 24px; border-radius: 8px;
      border: 2px solid var(--border-default, #223044); background: var(--bg-secondary, #0f1621);
      color: var(--text-secondary, #9fb0c3); cursor: pointer; font-size: 14px;
      font-weight: 600; min-width: 100px;
    }
    .direction-btn.active {
      background: var(--accent-primary, #3b82f6); border-color: var(--accent-primary, #3b82f6); color: white;
    }
    
    .section-header {
      display: flex; justify-content: space-between;
      align-items: center; padding: 16px;
      background: var(--bg-card, #1a2535); border-radius: 8px;
      margin-bottom: 16px; cursor: pointer;
    }
    .section-header:hover { background: var(--bg-hover, #223044); }
    
    .section-header-title {
      font-size: 20px; font-weight: 700; color: var(--accent-light, #60a5fa);
      display: flex; align-items: center; gap: 8px;
    }
    
    .section-header-icon {
      font-size: 24px; color: var(--text-secondary, #9fb0c3); transition: transform 0.2s;
    }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    
    .section-content {
      overflow: hidden; transition: max-height 0.3s ease;
      margin-bottom: 24px;
    }
    .section-content.collapsed { max-height: 0 !important; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--bg-card, #1a2535); padding: 16px;
      border-radius: 8px; border-left: 4px solid var(--accent-primary, #3b82f6);
    }
    .stat-card.warning { border-left-color: #f59e0b; }
    .stat-card.success { border-left-color: #10b981; }
    .stat-card.danger { border-left-color: #ef4444; }
    
    .stat-label {
      color: var(--text-secondary, #94a3b8); font-size: 12px; margin-bottom: 8px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 28px; font-weight: 700;
      color: var(--text-primary, #e8eef6); margin-bottom: 4px;
    }
    
    .stat-subtext { font-size: 13px; color: var(--text-secondary, #9fb0c3); }
    
    .chart-container {
      background: var(--bg-card, #1a2535); padding: 20px;
      border-radius: 8px; margin-bottom: 16px;
    }
    
    .chart-title {
      font-size: 16px; font-weight: 600;
      color: var(--accent-light, #60a5fa); margin-bottom: 16px;
    }
    
    canvas { max-height: 300px; }

    .business-name { font-size: 14px; color: var(--accent-light, #60a5fa); font-weight: 600; }
    
    /* Badge count */
    .badge-count {
      background: #ef4444; color: #fff;
      padding: 2px 8px; border-radius: 12px;
      font-size: 12px; font-weight: 600;
      min-width: 20px; text-align: center;
    }
    .badge-count.warning { background: #f59e0b; color: #000; }
    
    /* Inbox/Messages Styles */
    .inbox-container {
      background: var(--bg-secondary, #0f1621);
      border-radius: 8px; overflow: hidden;
    }
    
    .inbox-tabs {
      display: flex; gap: 4px; padding: 12px;
      background: var(--bg-card, #1a2535);
      border-bottom: 1px solid var(--border-default, #223044);
      overflow-x: auto;
    }
    
    .inbox-tab {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default, #223044);
      background: transparent; color: var(--text-secondary, #9fb0c3);
      font-size: 13px; font-weight: 500;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    
    .inbox-tab:hover { background: var(--bg-hover, #1f2e40); }
    .inbox-tab.active {
      background: var(--accent-primary, #3b82f6);
      border-color: var(--accent-primary, #3b82f6); color: #fff;
    }
    
    .inbox-list { max-height: 400px; overflow-y: auto; }
    
    .inbox-item {
      display: flex; gap: 12px; padding: 12px 16px;
      border-bottom: 1px solid var(--border-default, #223044);
      cursor: pointer; transition: background 0.2s;
    }
    
    .inbox-item:hover { background: var(--bg-hover, #1f2e40); }
    
    .inbox-item.unread {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid var(--accent-primary, #3b82f6);
    }
    
    .inbox-item-icon {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--bg-card, #1a2535);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    
    .inbox-item-content { flex: 1; min-width: 0; }
    
    .inbox-item-header {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 4px;
    }
    
    .inbox-item-title {
      font-weight: 600; font-size: 14px;
      color: var(--text-primary, #e8eef6);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    .inbox-item-time {
      font-size: 11px; color: var(--text-secondary, #9fb0c3); white-space: nowrap;
    }
    
    .inbox-item-body {
      font-size: 13px; color: var(--text-secondary, #9fb0c3);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    .inbox-item-tag {
      display: inline-block; font-size: 10px;
      padding: 2px 6px; border-radius: 4px;
      background: var(--bg-card, #1a2535);
      color: var(--text-secondary, #9fb0c3); margin-top: 6px;
    }
    
    .inbox-item-tag.urgent { background: #7f1d1d; color: #fca5a5; }
    .inbox-item-tag.high { background: #78350f; color: #fcd34d; }
    
    .inbox-empty {
      padding: 40px; text-align: center;
      color: var(--text-secondary, #9fb0c3);
    }
    .inbox-empty-icon { font-size: 48px; margin-bottom: 12px; }
    
    .inbox-actions {
      display: flex; gap: 8px; padding: 12px;
      background: var(--bg-card, #1a2535);
      border-top: 1px solid var(--border-default, #223044);
    }
    
    .inbox-action-btn {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default, #223044);
      background: transparent; color: var(--text-secondary, #9fb0c3);
      font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    
    .inbox-action-btn:hover { background: var(--bg-hover, #1f2e40); }
    .inbox-action-btn.primary {
      background: var(--accent-primary, #3b82f6);
      border-color: var(--accent-primary, #3b82f6); color: #fff;
    }
    
    /* Tasks Styles */
    .tasks-container {
      background: var(--bg-secondary, #0f1621);
      border-radius: 8px; overflow: hidden;
    }
    
    .tasks-tabs {
      display: flex; gap: 4px; padding: 12px;
      background: var(--bg-card, #1a2535);
      border-bottom: 1px solid var(--border-default, #223044);
      overflow-x: auto;
    }
    
    .tasks-tab {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default, #223044);
      background: transparent; color: var(--text-secondary, #9fb0c3);
      font-size: 13px; font-weight: 500;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    
    .tasks-tab:hover { background: var(--bg-hover, #1f2e40); }
    .tasks-tab.active {
      background: var(--accent-primary, #3b82f6);
      border-color: var(--accent-primary, #3b82f6); color: #fff;
    }
    
    .tasks-list { max-height: 400px; overflow-y: auto; }
    
    .task-item {
      display: flex; gap: 12px; padding: 12px 16px;
      border-bottom: 1px solid var(--border-default, #223044);
      align-items: flex-start;
    }
    
    .task-checkbox {
      width: 22px; height: 22px; border-radius: 50%;
      border: 2px solid var(--border-default, #223044);
      cursor: pointer; display: flex;
      align-items: center; justify-content: center;
      flex-shrink: 0; margin-top: 2px; transition: all 0.2s;
    }
    
    .task-checkbox:hover {
      border-color: var(--accent-primary, #3b82f6);
      background: rgba(59, 130, 246, 0.1);
    }
    
    .task-checkbox.completed {
      background: #10b981; border-color: #10b981; color: #fff;
    }
    
    .task-content { flex: 1; min-width: 0; }
    
    .task-title {
      font-weight: 600; font-size: 14px;
      color: var(--text-primary, #e8eef6); margin-bottom: 4px;
    }
    
    .task-item.completed .task-title {
      text-decoration: line-through;
      color: var(--text-secondary, #9fb0c3);
    }
    
    .task-description {
      font-size: 13px; color: var(--text-secondary, #9fb0c3); margin-bottom: 6px;
    }
    
    .task-meta {
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
    }
    
    .task-meta-item {
      display: flex; align-items: center; gap: 4px;
      font-size: 11px; color: var(--text-secondary, #9fb0c3);
    }
    
    .task-meta-item.overdue { color: #ef4444; }
    
    .task-priority {
      padding: 2px 6px; border-radius: 4px;
      font-size: 10px; font-weight: 600; text-transform: uppercase;
    }
    
    .task-priority.urgent { background: #7f1d1d; color: #fca5a5; }
    .task-priority.high { background: #78350f; color: #fcd34d; }
    .task-priority.normal { background: #1e3a8a; color: #93c5fd; }
    .task-priority.low { background: #14532d; color: #86efac; }
    
    .tasks-empty {
      padding: 40px; text-align: center;
      color: var(--text-secondary, #9fb0c3);
    }
    .tasks-empty-icon { font-size: 48px; margin-bottom: 12px; }
    
    .tasks-actions {
      display: flex; gap: 8px; padding: 12px;
      background: var(--bg-card, #1a2535);
      border-top: 1px solid var(--border-default, #223044);
    }
    
    .tasks-action-btn {
      padding: 8px 16px; border-radius: 6px;
      border: 1px solid var(--border-default, #223044);
      background: transparent; color: var(--text-secondary, #9fb0c3);
      font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    
    .tasks-action-btn:hover { background: var(--bg-hover, #1f2e40); }
    .tasks-action-btn.primary {
      background: var(--accent-primary, #3b82f6);
      border-color: var(--accent-primary, #3b82f6); color: #fff;
    }
    
    /* Modal */
    .modal-overlay {
      display: none; position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    
    .modal-content {
      background: var(--bg-secondary, #0f1621);
      border-radius: 12px; width: 100%; max-width: 500px;
      max-height: 90vh; overflow-y: auto;
      border: 1px solid var(--border-default, #223044);
    }
    
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; border-bottom: 1px solid var(--border-default, #223044);
    }
    
    .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary, #e8eef6); }
    
    .modal-close {
      background: transparent; border: none;
      color: var(--text-secondary, #9fb0c3);
      font-size: 24px; cursor: pointer; padding: 0; line-height: 1;
    }
    
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 16px; }
    
    .form-label {
      display: block; font-size: 13px; font-weight: 500;
      color: var(--text-secondary, #9fb0c3); margin-bottom: 6px;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 10px 12px; border-radius: 6px;
      border: 1px solid var(--border-default, #223044);
      background: var(--bg-card, #1a2535);
      color: var(--text-primary, #e8eef6); font-size: 14px;
    }
    
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    
    .modal-footer {
      display: flex; gap: 12px; justify-content: flex-end;
      padding: 16px 20px; border-top: 1px solid var(--border-default, #223044);
    }
    
    .btn-secondary {
      padding: 10px 20px; border-radius: 6px;
      border: 1px solid var(--border-default, #223044);
      background: transparent; color: var(--text-secondary, #9fb0c3);
      font-size: 14px; cursor: pointer;
    }
    
    .btn-primary {
      padding: 10px 20px; border-radius: 6px; border: none;
      background: var(--accent-primary, #3b82f6); color: #fff;
      font-size: 14px; font-weight: 500; cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      .filter-bar-fixed { display: block; }
      .top-bar { display: none; }
      body { padding-bottom: 160px; }
      .content { padding: 12px; }
      .stats-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .filter-bar-fixed { display: none !important; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span>‚ò∞</span></button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Business Dashboard</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='dashboard-service.html'">Service</button>
      <button onclick="location.href='dashboard-parts.html'">Parts</button>
      <button onclick="location.href='dashboard-sales.html'">Sales</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:32px; font-weight:600;">Business Dashboard</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px;">
      <a href="dashboard-business.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Business</a>
      <a href="dashboard-customer-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Customers</a>
      <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Vehicles</a>
      <a href="dashboard-settings.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; border-bottom:2px solid transparent;">Settings</a>
    </nav>
  </div>
  <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
    <div style="display:flex; gap:12px; justify-content:flex-end;">
      <button onclick="location.href='dashboard-service.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer;">Service</button>
      <button onclick="location.href='dashboard-parts.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer;">Parts</button>
      <button onclick="location.href='dashboard-sales.html'" style="padding:8px 16px; background:transparent; border:1px solid var(--border-default); color:var(--text-secondary); border-radius:8px; cursor:pointer;">Sales</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="top-bar">
    <div class="date-range-container">
      <select id="rangeSelect" class="range-select" onchange="rangeChanged()">
        <option value="today">Today</option>
        <option value="week">1 Week</option>
        <option value="30days" selected>30 Days</option>
        <option value="60days">60 Days</option>
        <option value="90days">90 Days</option>
        <option value="ytd">Year to Date</option>
      </select>
      <div class="direction-toggle">
        <button class="direction-btn active" id="pastBtn" onclick="setDirection('past')">Past</button>
        <button class="direction-btn" id="futureBtn" onclick="setDirection('future')">Future</button>
      </div>
    </div>
    <div style="text-align:center; color:var(--text-secondary); font-size:13px; margin-top:8px;">
      <span id="dateRangeDisplay" style="color:var(--accent-light); font-weight:600;">30 Days (Past)</span>
    </div>
  </div>

  <div class="content">
    
    <!-- Messages & Notifications Section -->
    <div class="section-header" onclick="toggleSection('messages')">
      <div class="section-header-title">
        üí¨ Messages & Notifications
        <span class="badge-count" id="messagesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content" id="messagesContent">
      <div class="inbox-container">
        <div class="inbox-tabs">
          <button class="inbox-tab active" data-tab="all" onclick="switchInboxTab('all', this)">All</button>
          <button class="inbox-tab" data-tab="unread" onclick="switchInboxTab('unread', this)">Unread</button>
          <button class="inbox-tab" data-tab="wo_notes" onclick="switchInboxTab('wo_notes', this)">WO Notes</button>
        </div>
        <div class="inbox-list" id="inboxList">
          <div class="inbox-empty">
            <div class="inbox-empty-icon">üì≠</div>
            <div>No messages yet</div>
          </div>
        </div>
        <div class="inbox-actions">
          <button class="inbox-action-btn" onclick="markAllNotificationsRead()">‚úì Mark All Read</button>
          <button class="inbox-action-btn" onclick="loadInboxData()">üîÑ Refresh</button>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="section-header collapsed" onclick="toggleSection('tasks')">
      <div class="section-header-title">
        üìã Tasks
        <span class="badge-count warning" id="tasksBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="tasksContent">
      <div class="tasks-container">
        <div class="tasks-tabs">
          <button class="tasks-tab active" data-tab="pending" onclick="switchTasksTab('pending', this)">Pending</button>
          <button class="tasks-tab" data-tab="in_progress" onclick="switchTasksTab('in_progress', this)">In Progress</button>
          <button class="tasks-tab" data-tab="overdue" onclick="switchTasksTab('overdue', this)">Overdue</button>
          <button class="tasks-tab" data-tab="completed" onclick="switchTasksTab('completed', this)">Done</button>
        </div>
        <div class="tasks-list" id="tasksList">
          <div class="tasks-empty">
            <div class="tasks-empty-icon">‚úÖ</div>
            <div>No tasks</div>
          </div>
        </div>
        <div class="tasks-actions">
          <button class="tasks-action-btn primary" onclick="openNewTaskModal()">+ New Task</button>
        </div>
      </div>
    </div>

    <!-- Service Department Section -->
    <div class="section-header collapsed" onclick="toggleSection('service')">
      <div class="section-header-title">Service Department</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="serviceContent">
      <div class="stats-grid">
        <div class="stat-card success"><div class="stat-label">Total Revenue</div><div class="stat-value" id="serviceRevenue">$0</div><div class="stat-subtext">Completed Work Orders</div></div>
        <div class="stat-card"><div class="stat-label">Work Orders</div><div class="stat-value" id="serviceOrders">0</div><div class="stat-subtext" id="serviceOrdersLabel">Completed</div></div>
        <div class="stat-card"><div class="stat-label">Avg Ticket</div><div class="stat-value" id="serviceAvgTicket">$0</div><div class="stat-subtext">Per Work Order</div></div>
        <div class="stat-card warning"><div class="stat-label">In Progress</div><div class="stat-value" id="serviceInProgress">0</div><div class="stat-subtext">Active Now</div></div>
        <div class="stat-card"><div class="stat-label">Scheduled</div><div class="stat-value" id="serviceScheduled">0</div><div class="stat-subtext">Upcoming</div></div>
      </div>
      <div class="chart-container"><div class="chart-title">Work Orders by Status</div><canvas id="serviceStatusChart"></canvas></div>
    </div>

    <!-- Parts Department Section -->
    <div class="section-header collapsed" onclick="toggleSection('parts')">
      <div class="section-header-title">Parts Department</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="partsContent">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Inventory Value</div><div class="stat-value" id="partsInventoryValue">$0</div><div class="stat-subtext">On Hand</div></div>
        <div class="stat-card"><div class="stat-label">Total Items</div><div class="stat-value" id="partsTotalItems">0</div><div class="stat-subtext">In Inventory</div></div>
        <div class="stat-card warning"><div class="stat-label">Low Stock Items</div><div class="stat-value" id="partsLowStock">0</div><div class="stat-subtext">Need Reorder</div></div>
      </div>
    </div>

    <!-- Sales Department Section -->
    <div class="section-header collapsed" onclick="toggleSection('sales')">
      <div class="section-header-title">Sales Department</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="salesContent">
      <div class="stats-grid">
        <div class="stat-card success"><div class="stat-label">Total Revenue</div><div class="stat-value" id="salesRevenue">$0</div><div class="stat-subtext">Closed Won</div></div>
        <div class="stat-card"><div class="stat-label">Deals Closed</div><div class="stat-value" id="salesDeals">0</div><div class="stat-subtext">Won</div></div>
        <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value" id="salesWinRate">0%</div><div class="stat-subtext">Close Rate</div></div>
        <div class="stat-card warning"><div class="stat-label">Pipeline Value</div><div class="stat-value" id="salesPipeline">$0</div><div class="stat-subtext">Active Opportunities</div></div>
      </div>
      <div class="chart-container"><div class="chart-title">Pipeline by Stage</div><canvas id="salesPipelineChart"></canvas></div>
    </div>

    <!-- Overall Summary Section -->
    <div class="section-header collapsed" onclick="toggleSection('summary')">
      <div class="section-header-title">Overall Business Summary</div>
      <div class="section-header-icon">‚ñº</div>
    </div>
    <div class="section-content collapsed" id="summaryContent">
      <div class="stats-grid">
        <div class="stat-card success"><div class="stat-label">Total Revenue</div><div class="stat-value" id="totalRevenue">$0</div><div class="stat-subtext">Service + Sales</div></div>
        <div class="stat-card"><div class="stat-label">Total Customers</div><div class="stat-value" id="totalCustomers">0</div><div class="stat-subtext">In Database</div></div>
        <div class="stat-card"><div class="stat-label">Total Vehicles</div><div class="stat-value" id="totalVehicles">0</div><div class="stat-subtext">Registered</div></div>
      </div>
      <div class="chart-container"><div class="chart-title">Revenue by Department</div><canvas id="summaryRevenueChart"></canvas></div>
    </div>
  </div>
</div>

<!-- New Task Modal -->
<div class="modal-overlay" id="newTaskModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üìã New Task</div>
      <button class="modal-close" onclick="closeNewTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Task Title *</label>
        <input type="text" class="form-input" id="taskTitle" placeholder="Enter task title">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-select" id="taskPriority">
            <option value="low">Low</option>
            <option value="normal" selected>Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" class="form-input" id="taskDueDate">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Assign To</label>
        <select class="form-select" id="taskAssignee"><option value="">-- Select Employee --</option></select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewTaskModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- Fixed Filter Bar (Mobile) -->
<div class="filter-bar-fixed">
  <div class="filter-bar-row">
    <select id="rangeSelectMobile" class="range-select" onchange="rangeChangedMobile()">
      <option value="today">Today</option>
      <option value="week">1 Week</option>
      <option value="30days" selected>30 Days</option>
      <option value="60days">60 Days</option>
      <option value="90days">90 Days</option>
      <option value="ytd">Year to Date</option>
    </select>
    <button class="direction-btn active" id="pastBtnMobile" onclick="setDirectionMobile('past')">Past</button>
    <button class="direction-btn" id="futureBtnMobile" onclick="setDirectionMobile('future')">Future</button>
  </div>
  <div class="date-display" id="dateRangeDisplayMobile">30 Days (Past)</div>
</div>

<div class="mobile-bottom-nav">
  <div class="mobile-nav-grid">
    <a href="dashboard-business.html" class="mobile-nav-btn active">Business</a>
    <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
    <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
    <a href="dashboard-settings.html" class="mobile-nav-btn">Settings</a>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentRange = '30days', currentDirection = 'past';
let startDate = new Date(), endDate = new Date();
let charts = {}, currentUserId = null;
let currentInboxTab = 'all', currentTasksTab = 'pending';
let allNotifications = [], allTasks = [], allEmployees = [];

function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

function toggleMobileMenu() { document.getElementById('mobileHeaderContent').classList.toggle('expanded'); }

async function logout() {
  await sb.auth.signOut();
  localStorage.removeItem("sb_access_token"); localStorage.removeItem("sb_refresh_token");
  Object.keys(localStorage).forEach(key => { if (key.startsWith('sb-')) localStorage.removeItem(key); });
  location.replace("login.html?logout=1");
}

function toggleSection(sectionId) {
  const content = document.getElementById(sectionId + 'Content');
  const header = event.currentTarget;
  content.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
  content.style.maxHeight = content.classList.contains('collapsed') ? '0px' : content.scrollHeight + 'px';
}

// ========== INBOX / MESSAGES ==========
async function loadInboxData() {
  try {
    const { data: notifications } = await sb.from('notifications').select('*').order('created_at', { ascending: false }).limit(50);
    allNotifications = notifications || [];
    
    const { data: woNotes } = await sb.from('work_order_notes').select('*').eq('requires_manager_review', true).eq('is_deleted', false).order('created_at', { ascending: false }).limit(20);
    if (woNotes && woNotes.length > 0) {
      const noteItems = woNotes.map(note => ({
        notification_id: 'note_' + note.note_id, notification_type: 'wo_note',
        title: 'WO Note - Review Required', body: note.content,
        priority: 'high', is_read: false, created_at: note.created_at,
        source_type: 'work_order_note', source_id: note.work_order_id
      }));
      allNotifications = [...noteItems, ...allNotifications];
    }
    renderInbox(); updateInboxBadge();
  } catch (error) { console.error('Error loading inbox:', error); allNotifications = []; renderInbox(); }
}

function renderInbox() {
  const container = document.getElementById('inboxList');
  let filtered = allNotifications;
  if (currentInboxTab === 'unread') filtered = allNotifications.filter(n => !n.is_read);
  else if (currentInboxTab === 'wo_notes') filtered = allNotifications.filter(n => n.notification_type === 'wo_note');
  
  if (filtered.length === 0) {
    container.innerHTML = `<div class="inbox-empty"><div class="inbox-empty-icon">üì≠</div><div>No ${currentInboxTab === 'unread' ? 'unread ' : ''}messages</div></div>`;
    return;
  }
  
  container.innerHTML = filtered.map(item => {
    const icons = { 'message': 'üí¨', 'wo_note': 'üîß', 'task_assigned': 'üìã', 'task_due': '‚è∞', 'mention': '@', 'approval_needed': '‚úã', 'vehicle_ready': 'üöó', 'system': '‚ÑπÔ∏è' };
    const icon = icons[item.notification_type] || 'üì¢';
    const timeAgo = formatTimeAgo(item.created_at);
    const priorityTag = (item.priority === 'urgent' || item.priority === 'high') ? `<span class="inbox-item-tag ${item.priority}">${item.priority}</span>` : '';
    return `<div class="inbox-item ${item.is_read ? '' : 'unread'}" onclick="handleInboxClick('${item.notification_id}', '${item.source_type || ''}', '${item.source_id || ''}')">
      <div class="inbox-item-icon">${icon}</div>
      <div class="inbox-item-content">
        <div class="inbox-item-header"><div class="inbox-item-title">${item.title || 'Notification'}</div><div class="inbox-item-time">${timeAgo}</div></div>
        <div class="inbox-item-body">${item.body || ''}</div>${priorityTag}
      </div></div>`;
  }).join('');
}

function switchInboxTab(tab, btn) {
  currentInboxTab = tab;
  document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderInbox();
}

async function handleInboxClick(id, sourceType, sourceId) {
  if (!id.startsWith('note_')) await sb.from('notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('notification_id', id);
  if (sourceType === 'work_order_note' || sourceType === 'work_order') window.location.href = `work-order-edit.html?id=${sourceId}`;
  loadInboxData();
}

async function markAllNotificationsRead() {
  await sb.from('notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('is_read', false);
  loadInboxData();
}

function updateInboxBadge() {
  const unreadCount = allNotifications.filter(n => !n.is_read).length;
  const badge = document.getElementById('messagesBadge');
  if (unreadCount > 0) { badge.textContent = unreadCount > 99 ? '99+' : unreadCount; badge.style.display = 'inline-block'; }
  else { badge.style.display = 'none'; }
}

// ========== TASKS ==========
async function loadTasksData() {
  try {
    const { data: tasks } = await sb.from('tasks').select('*').order('due_at', { ascending: true });
    allTasks = tasks || [];
    renderTasks(); updateTasksBadge();
  } catch (error) { console.error('Error loading tasks:', error); allTasks = []; renderTasks(); }
}

function renderTasks() {
  const container = document.getElementById('tasksList');
  const now = new Date();
  let filtered = allTasks;
  
  if (currentTasksTab === 'pending') filtered = allTasks.filter(t => t.status === 'pending' || t.status === 'todo');
  else if (currentTasksTab === 'in_progress') filtered = allTasks.filter(t => t.status === 'in_progress');
  else if (currentTasksTab === 'overdue') filtered = allTasks.filter(t => t.status !== 'completed' && t.due_at && new Date(t.due_at) < now);
  else if (currentTasksTab === 'completed') filtered = allTasks.filter(t => t.status === 'completed');
  
  if (filtered.length === 0) {
    const msgs = { 'pending': 'No pending tasks', 'in_progress': 'No tasks in progress', 'overdue': 'No overdue tasks üéâ', 'completed': 'No completed tasks yet' };
    container.innerHTML = `<div class="tasks-empty"><div class="tasks-empty-icon">‚úÖ</div><div>${msgs[currentTasksTab]}</div></div>`;
    return;
  }
  
  container.innerHTML = filtered.map(task => {
    const isCompleted = task.status === 'completed';
    const isOverdue = task.due_at && new Date(task.due_at) < now && !isCompleted;
    const dueText = task.due_at ? formatDueDate(task.due_at) : '';
    const priorityClass = task.priority || 'normal';
    return `<div class="task-item ${isCompleted ? 'completed' : ''}">
      <div class="task-checkbox ${isCompleted ? 'completed' : ''}" onclick="toggleTaskComplete('${task.task_id}', ${!isCompleted})">${isCompleted ? '‚úì' : ''}</div>
      <div class="task-content">
        <div class="task-title">${task.title}</div>
        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
        <div class="task-meta">
          <span class="task-priority ${priorityClass}">${priorityClass}</span>
          ${dueText ? `<span class="task-meta-item ${isOverdue ? 'overdue' : ''}">üìÖ ${dueText}</span>` : ''}
        </div>
      </div></div>`;
  }).join('');
}

function switchTasksTab(tab, btn) {
  currentTasksTab = tab;
  document.querySelectorAll('.tasks-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderTasks();
}

async function toggleTaskComplete(taskId, completed) {
  await sb.from('tasks').update({ status: completed ? 'completed' : 'pending', completed_at: completed ? new Date().toISOString() : null }).eq('task_id', taskId);
  loadTasksData();
}

function updateTasksBadge() {
  const pendingCount = allTasks.filter(t => t.status !== 'completed').length;
  const badge = document.getElementById('tasksBadge');
  if (pendingCount > 0) { badge.textContent = pendingCount > 99 ? '99+' : pendingCount; badge.style.display = 'inline-block'; }
  else { badge.style.display = 'none'; }
}

function formatDueDate(dateStr) {
  const date = new Date(dateStr), now = new Date();
  const days = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
  if (days < 0) return `${Math.abs(days)} days overdue`;
  if (days === 0) return 'Due today';
  if (days === 1) return 'Due tomorrow';
  if (days <= 7) return `Due in ${days} days`;
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// ========== NEW TASK MODAL ==========
async function openNewTaskModal() {
  try {
    const { data: employees } = await sb.from('employees').select('employee_id, first_name, last_name').eq('is_active', true);
    allEmployees = employees || [];
    const select = document.getElementById('taskAssignee');
    select.innerHTML = '<option value="">-- Select Employee --</option>' + allEmployees.map(e => `<option value="${e.employee_id}">${e.first_name} ${e.last_name}</option>`).join('');
  } catch (e) { console.error('Error loading employees:', e); }
  const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById('taskDueDate').value = tomorrow.toISOString().split('T')[0];
  document.getElementById('newTaskModal').classList.add('active');
}

function closeNewTaskModal() {
  document.getElementById('newTaskModal').classList.remove('active');
  document.getElementById('taskTitle').value = '';
  document.getElementById('taskDescription').value = '';
  document.getElementById('taskPriority').value = 'normal';
}

async function saveNewTask() {
  const title = document.getElementById('taskTitle').value.trim();
  if (!title) { alert('Please enter a task title'); return; }
  
  const newTask = {
    title, description: document.getElementById('taskDescription').value.trim() || null,
    priority: document.getElementById('taskPriority').value, status: 'pending',
    due_at: document.getElementById('taskDueDate').value ? new Date(document.getElementById('taskDueDate').value).toISOString() : null,
    assigned_to: document.getElementById('taskAssignee').value || null, created_by: currentUserId
  };
  
  const { data: userData } = await sb.from('users').select('tenant_id').single();
  if (userData) newTask.tenant_id = userData.tenant_id;
  
  const { error } = await sb.from('tasks').insert(newTask);
  if (error) { alert('Error creating task: ' + error.message); return; }
  closeNewTaskModal(); loadTasksData();
}

// ========== UTILITY ==========
function formatTimeAgo(dateStr) {
  const diff = new Date() - new Date(dateStr);
  const mins = Math.floor(diff / 60000), hrs = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return `${mins}m ago`;
  if (hrs < 24) return `${hrs}h ago`;
  if (days < 7) return `${days}d ago`;
  return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// ========== EXISTING DASHBOARD FUNCTIONS ==========
function formatDateDisplay(date) { return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }

function rangeChanged() { 
  currentRange = document.getElementById('rangeSelect').value;
  // Sync mobile
  const mobileSelect = document.getElementById('rangeSelectMobile');
  if (mobileSelect) mobileSelect.value = currentRange;
  calculateDateRange(); updateDisplay(); loadDashboardData(); 
}

function rangeChangedMobile() {
  currentRange = document.getElementById('rangeSelectMobile').value;
  // Sync desktop
  document.getElementById('rangeSelect').value = currentRange;
  calculateDateRange(); updateDisplay(); loadDashboardData();
}

function setDirection(direction) {
  currentDirection = direction;
  document.getElementById('pastBtn').classList.remove('active');
  document.getElementById('futureBtn').classList.remove('active');
  document.getElementById(direction + 'Btn').classList.add('active');
  // Sync mobile
  document.getElementById('pastBtnMobile')?.classList.remove('active');
  document.getElementById('futureBtnMobile')?.classList.remove('active');
  document.getElementById(direction + 'BtnMobile')?.classList.add('active');
  calculateDateRange(); updateDisplay(); loadDashboardData();
}

function setDirectionMobile(direction) {
  currentDirection = direction;
  document.getElementById('pastBtnMobile').classList.remove('active');
  document.getElementById('futureBtnMobile').classList.remove('active');
  document.getElementById(direction + 'BtnMobile').classList.add('active');
  // Sync desktop
  document.getElementById('pastBtn').classList.remove('active');
  document.getElementById('futureBtn').classList.remove('active');
  document.getElementById(direction + 'Btn').classList.add('active');
  calculateDateRange(); updateDisplay(); loadDashboardData();
}

function calculateDateRange() {
  const today = new Date(); today.setHours(0, 0, 0, 0);
  if (currentDirection === 'future') {
    startDate = new Date(today); endDate = new Date(today);
    switch(currentRange) {
      case 'today': endDate.setHours(23, 59, 59, 999); break;
      case 'week': endDate.setDate(today.getDate() + 6); break;
      case '30days': endDate.setDate(today.getDate() + 29); break;
      case '60days': endDate.setDate(today.getDate() + 59); break;
      case '90days': endDate.setDate(today.getDate() + 89); break;
      case 'ytd': endDate = new Date(today.getFullYear(), 11, 31); break;
    }
    endDate.setHours(23, 59, 59, 999);
  } else {
    endDate = new Date(today); endDate.setHours(23, 59, 59, 999);
    startDate = new Date(today);
    switch(currentRange) {
      case 'today': startDate.setHours(0, 0, 0, 0); break;
      case 'week': startDate.setDate(today.getDate() - 6); break;
      case '30days': startDate.setDate(today.getDate() - 29); break;
      case '60days': startDate.setDate(today.getDate() - 59); break;
      case '90days': startDate.setDate(today.getDate() - 89); break;
      case 'ytd': startDate = new Date(today.getFullYear(), 0, 1); break;
    }
  }
}

function updateDisplay() {
  const rangeText = { 'today': 'Today', 'week': '1 Week', '30days': '30 Days', '60days': '60 Days', '90days': '90 Days', 'ytd': 'Year to Date' };
  const displayText = `${rangeText[currentRange]} (${currentDirection === 'future' ? 'Future' : 'Past'}) ‚Ä¢ ${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`;
  document.getElementById('dateRangeDisplay').textContent = displayText;
  // Sync mobile
  const mobileDisplay = document.getElementById('dateRangeDisplayMobile');
  if (mobileDisplay) mobileDisplay.textContent = displayText;
}

async function checkAuth() {
  let { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const token = localStorage.getItem('sb_access_token'), refreshToken = localStorage.getItem('sb_refresh_token');
    if (token && refreshToken) {
      const { data, error } = await sb.auth.setSession({ access_token: token, refresh_token: refreshToken });
      if (error || !data.session) { window.location.href = 'login.html'; return null; }
      session = data.session;
    } else { window.location.href = 'login.html'; return null; }
  }
  currentUserId = session.user.id;
  return session;
}

async function loadBusinessSettings() {
  const { data } = await sb.from('business_settings').select('*').single();
  if (data) {
    const name = data.business_name || data.company_name || '';
    document.getElementById('desktopBusinessName').textContent = name;
    document.getElementById('mobileBusinessName').textContent = name;
  }
}

async function loadDashboardData() { await Promise.all([loadServiceData(), loadPartsData(), loadSalesData(), loadSummaryData()]); }

async function loadServiceData() {
  try {
    const { data: allOrders } = await sb.from('work_orders').select('*');
    const orders = allOrders || [];
    const filteredOrders = orders.filter(wo => {
      if (currentDirection === 'future') { const d = wo.scheduled_start ? new Date(wo.scheduled_start) : null; return d && d >= startDate && d <= endDate; }
      else { return new Date(wo.created_at) >= startDate && new Date(wo.created_at) <= endDate; }
    });
    const completedOrders = filteredOrders.filter(wo => wo.status === 'completed' || wo.status === 'closed');
    const inProgressOrders = filteredOrders.filter(wo => wo.status === 'in_progress');
    const scheduledOrders = filteredOrders.filter(wo => wo.status === 'scheduled');
    const totalRevenue = completedOrders.reduce((sum, wo) => sum + (parseFloat(wo.total_amount) || 0), 0);
    const avgTicket = completedOrders.length > 0 ? totalRevenue / completedOrders.length : 0;
    document.getElementById('serviceRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString();
    document.getElementById('serviceOrders').textContent = completedOrders.length;
    document.getElementById('serviceAvgTicket').textContent = '$' + Math.round(avgTicket).toLocaleString();
    document.getElementById('serviceInProgress').textContent = inProgressOrders.length;
    document.getElementById('serviceScheduled').textContent = scheduledOrders.length;
    createServiceChart(completedOrders.length, inProgressOrders.length, scheduledOrders.length);
  } catch (error) { console.error('Error loading service data:', error); }
}

function createServiceChart(completed, inProgress, scheduled) {
  if (charts.serviceStatus) charts.serviceStatus.destroy();
  const ctx = document.getElementById('serviceStatusChart');
  charts.serviceStatus = new Chart(ctx, { type: 'doughnut', data: { labels: ['Completed', 'In Progress', 'Scheduled'], datasets: [{ data: [completed, inProgress, scheduled], backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } } } });
}

async function loadPartsData() {
  try {
    const { data: inventory } = await sb.from('parts_inventory').select('*');
    const parts = inventory || [];
    const inventoryValue = parts.reduce((sum, p) => sum + ((parseFloat(p.quantity_on_hand) || 0) * (parseFloat(p.unit_cost) || 0)), 0);
    const lowStock = parts.filter(p => (p.quantity_on_hand || 0) <= (p.reorder_point || 5)).length;
    document.getElementById('partsInventoryValue').textContent = '$' + Math.round(inventoryValue).toLocaleString();
    document.getElementById('partsTotalItems').textContent = parts.length;
    document.getElementById('partsLowStock').textContent = lowStock;
  } catch (error) { console.error('Error loading parts data:', error); }
}

async function loadSalesData() {
  try {
    const { data: allDeals } = await sb.from('deals').select('*');
    const deals = allDeals || [];
    const filteredDeals = deals.filter(d => new Date(d.created_at) >= startDate && new Date(d.created_at) <= endDate);
    const wonDeals = filteredDeals.filter(d => d.status === 'won' || d.status === 'closed_won');
    const lostDeals = filteredDeals.filter(d => d.status === 'lost' || d.status === 'closed_lost');
    const activeDeals = filteredDeals.filter(d => d.status !== 'won' && d.status !== 'lost' && d.status !== 'closed_won' && d.status !== 'closed_lost');
    const totalRevenue = wonDeals.reduce((sum, d) => sum + (parseFloat(d.deal_value) || parseFloat(d.amount) || 0), 0);
    const pipelineValue = activeDeals.reduce((sum, d) => sum + (parseFloat(d.deal_value) || parseFloat(d.amount) || 0), 0);
    const totalClosed = wonDeals.length + lostDeals.length;
    const winRate = totalClosed > 0 ? Math.round((wonDeals.length / totalClosed) * 100) : 0;
    document.getElementById('salesRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString();
    document.getElementById('salesDeals').textContent = wonDeals.length;
    document.getElementById('salesWinRate').textContent = winRate + '%';
    document.getElementById('salesPipeline').textContent = '$' + Math.round(pipelineValue).toLocaleString();
    const stageCounts = {}; activeDeals.forEach(d => { const stage = d.stage || d.status || 'Unknown'; stageCounts[stage] = (stageCounts[stage] || 0) + 1; });
    createSalesPipelineChart(stageCounts);
  } catch (error) { console.error('Error loading sales data:', error); }
}

function createSalesPipelineChart(stageCounts) {
  if (charts.salesPipeline) charts.salesPipeline.destroy();
  const labels = Object.keys(stageCounts).length > 0 ? Object.keys(stageCounts) : ['No Active Deals'];
  const values = Object.keys(stageCounts).length > 0 ? Object.values(stageCounts) : [0];
  const ctx = document.getElementById('salesPipelineChart');
  charts.salesPipeline = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Deals', data: values, backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }, x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } } } } });
}

async function loadSummaryData() {
  try {
    const { data: customers } = await sb.from('customers').select('customer_id');
    const { data: vehicles } = await sb.from('vehicles').select('vehicle_id');
    document.getElementById('totalCustomers').textContent = (customers || []).length;
    document.getElementById('totalVehicles').textContent = (vehicles || []).length;
    setTimeout(() => {
      const serviceRev = parseFloat(document.getElementById('serviceRevenue').textContent.replace(/[$,]/g, '')) || 0;
      const salesRev = parseFloat(document.getElementById('salesRevenue').textContent.replace(/[$,]/g, '')) || 0;
      document.getElementById('totalRevenue').textContent = '$' + Math.round(serviceRev + salesRev).toLocaleString();
      createSummaryChart(serviceRev, salesRev);
    }, 500);
  } catch (error) { console.error('Error loading summary data:', error); }
}

function createSummaryChart(serviceRev, salesRev) {
  if (charts.summaryRevenue) charts.summaryRevenue.destroy();
  const ctx = document.getElementById('summaryRevenueChart');
  charts.summaryRevenue = new Chart(ctx, { type: 'doughnut', data: { labels: ['Service', 'Sales'], datasets: [{ data: [serviceRev || 0, salesRev || 0], backgroundColor: ['#3b82f6', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } } } });
}

async function init() {
  const session = await checkAuth();
  if (!session) return;
  await loadBusinessSettings();
  calculateDateRange(); updateDisplay();
  await Promise.all([loadDashboardData(), loadInboxData(), loadTasksData()]);
  const messagesContent = document.getElementById('messagesContent');
  messagesContent.style.maxHeight = messagesContent.scrollHeight + 'px';
}

init();
</script>
</body>
</html>
