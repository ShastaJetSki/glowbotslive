<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
.appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }
header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; }
h1 { margin:0; font-size:40px; }
h2 { margin:18px 0 10px; font-size:18px; }

.row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px; }
.card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:14px 16px; }

.filters { display:flex; gap:8px; margin:8px 0 14px; flex-wrap:wrap; }

.pill {
padding:6px 10px;
border-radius:10px;
border:1px solid #223044;
background:#0f1621;
color:#e8eef6;
cursor:pointer;
font-size:12px;
}
.pill.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

.tech { min-width:320px; flex:1 1 320px; display:flex; justify-content:space-between; cursor:pointer; }
.tech.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

.metric { font-size:18px; font-weight:700; }
.sub { font-size:12px; color:#9fb0c3; }

.load.light { color:#4ade80; }

.avatar {
width:66px; height:66px; border-radius:50%;
border:1px solid #223044;
display:flex; align-items:center; justify-content:center;
font-weight:800;
}

.dot {
width:6px;
height:6px;
background:#ff2d2d;
border-radius:50%;
box-shadow:0 0 6px #ff2d2d;
display:inline-block;
margin-right:6px;
}
</style>
</head>

<body>

<div class="appName">WorkLogicPro</div>

<header>
<h1 id="tenantTitle">Business Dashboard</h1>
<button onclick="logout()">Logout</button>
</header>

<div class="row" id="kpis"></div>

<!-- RANGE FILTERS ABOVE TECHS -->
<div class="filters">
<div class="pill active" id="btnToday" onclick="setRange('today')">Today</div>
<div class="pill" id="btnWeek" onclick="setRange('week')">This Week</div>
</div>

<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<!-- FILTERS ABOVE WORK ORDERS -->
<div class="filters">
<div class="pill" id="btnAll" onclick="setRange('all')">All</div>
<div class="pill" onclick="setSort('priority')">Priority</div>
<div class="pill" onclick="clearFilters()">Clear Filters</div>
</div>

<h2>Work Orders</h2>
<div id="workOrders">Loading…</div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let orders = [];
let technicians = [];
let employeesById = {};
let activeRange = "today";
let activeSort = null;

function logout(){
localStorage.removeItem("sb_access_token");
location.replace("login.html");
}

function startOfToday(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
function startOfWeekMonday(){ const d=new Date(); d.setDate(d.getDate()-((d.getDay()+6)%7)); d.setHours(0,0,0,0); return d; }

function jobHours(w){ return 1; }

function isOverdue(w){
return w.scheduled_start &&
!["completed","closed"].includes(w.status) &&
new Date(w.scheduled_start) < new Date();
}

function inRange(w){
if(activeRange==="all") return true;
const d=w.scheduled_start?new Date(w.scheduled_start):null;
if(activeRange==="today") return d>=startOfToday();
if(activeRange==="week") return d>=startOfWeekMonday();
return true;
}

function setRange(r){
activeRange=r;
["btnToday","btnWeek","btnAll"].forEach(id=>{
const el=document.getElementById(id);
if(el) el.classList.toggle("active", id==="btn"+r.charAt(0).toUpperCase()+r.slice(1));
});
render();
}

function setSort(s){ activeSort=s; render(); }

function clearFilters(){
activeRange="today";
activeSort=null;
setRange("today");
}

function render(){
renderTechCards();
renderWorkOrders();
}

function renderTechCards(){
document.getElementById("techCards").innerHTML =
technicians.map(t=>{
const mine=orders.filter(w=>w.assigned_employee_id===t.employee_id && inRange(w));
const hasOverdue=orders.some(w=>w.assigned_employee_id===t.employee_id && isOverdue(w));
return `
<div class="card tech">
<div>
<div class="metric">${mine.length} jobs</div>
<div class="sub">${hasOverdue?'<span class="dot"></span>':''}LIGHT</div>
</div>
<div class="avatar">${t.initials}</div>
</div>`;
}).join("");
}

function renderWorkOrders(){
const list=document.getElementById("workOrders");
const arr=orders.filter(inRange);
list.innerHTML=arr.map(w=>`<div class="card">${w.summary||"—"}</div>`).join("") || "No work orders";
}

async function load(){
orders = await fetch(`${FUNCTIONS_BASE}/work_orders`,{headers:{apikey:ANON_KEY}}).then(r=>r.json());
const emps = await fetch(`${FUNCTIONS_BASE}/employees`,{headers:{apikey:ANON_KEY}}).then(r=>r.json());
technicians = emps.filter(e=>e.role==="technician").map(e=>({
...e,
initials:(e.first_name[0]+e.last_name[0]).toUpperCase()
}));
render();
}

load();
</script>

</body>
</html>
