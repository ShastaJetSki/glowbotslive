<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4"/>

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
header{display:flex;justify-content:space-between;align-items:center}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.card{background:#0f1621;border:1px solid #223044;border-radius:14px;padding:14px;flex:1}
.tech{cursor:pointer}
.tech.active{border-color:#3b82f6}
.muted{color:#9fb0c3;font-size:13px}
button{background:#1a2535;color:#fff;border:1px solid #2a3b55;border-radius:10px;padding:8px 12px}
</style>
</head>

<body>

<header>
<h1>Business Dashboard</h1>
<button onclick="logout()">Logout</button>
</header>

<div class="row" id="techCards"></div>

<h2>Work Orders</h2>
<div id="orders">Loading…</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API=`https://${PROJECT_REF}.supabase.co`;
const FN=`${API}/functions/v1`;
const KEY=document.querySelector('meta[name="supabase-anon-key"]').content;

let token=localStorage.getItem("sb_access_token");
let employeesById={};
let activeTech=null;
let orders=[];

function logout(){
  localStorage.removeItem("sb_access_token");
  location.href="login.html";
}

/* ✅ SAFE TOKEN VALIDATION — NO LOOP */
async function validateToken(){
  if(!token) return false;
  const r=await fetch(`${API}/auth/v1/user`,{
    headers:{Authorization:`Bearer ${token}`,apikey:KEY}
  });
  return r.ok;
}

async function load(){
  if(!(await validateToken())){
    logout();
    return;
  }

  /* EMPLOYEES */
  const emps=await fetch(`${FN}/employees`,{
    headers:{Authorization:`Bearer ${token}`,apikey:KEY}
  }).then(r=>r.json());

  emps.forEach(e=>employeesById[e.employee_id]=e);

  document.getElementById("techCards").innerHTML =
    emps.filter(e=>e.role==="technician").map(t=>`
      <div class="card tech ${activeTech===t.employee_id?'active':''}"
        onclick="selectTech('${t.employee_id}')">
        <strong>Tech · ${t.name}</strong>
      </div>
    `).join("");

  /* WORK ORDERS */
  orders=await fetch(`${FN}/work_orders`,{
    headers:{Authorization:`Bearer ${token}`,apikey:KEY}
  }).then(r=>r.json());

  renderOrders();
}

function selectTech(id){
  activeTech = activeTech===id ? null : id;
  load();
}

function renderOrders(){
  const list = orders.filter(o=>!activeTech || o.assigned_to===activeTech);
  document.getElementById("orders").innerHTML = list.map(o=>{
    const tech = o.assigned_to
      ? employeesById[o.assigned_to]?.name || "Unknown Tech"
      : "Unassigned";

    return `
      <div class="card">
        <strong>${o.customer_name || "Customer"} · ${o.status}</strong>
        <div class="muted">${o.customer_phone || ""}</div>
        <div class="muted">${o.summary}</div>
        <div class="muted">Assigned to: ${tech}</div>
      </div>
    `;
  }).join("");
}

load();
</script>

</body>
</html>
