<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="YOUR_ANON_KEY_HERE" />

<style>
  body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
  header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }

  button{
    padding:8px 14px; border-radius:10px; border:1px solid #2a3b55;
    background:#1a2535; color:#fff; cursor:pointer;
  }

  .row{ display:flex; flex-wrap:wrap; gap:12px; margin-bottom:14px; }

  .card{
    background:#0f1621; border:1px solid #223044; border-radius:14px;
    padding:14px 16px;
  }

  .card.clickable{ cursor:pointer; }
  .card.active{ border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

  .kpi{ min-width:260px; flex:1 1 260px; }
  .tech{ min-width:240px; flex:1 1 240px; }

  .label{ font-size:12px; color:#9fb0c3; }
  .value{ font-size:18px; font-weight:650; margin-top:6px; line-height:1.3; }

  .job-title{ font-weight:750; font-size:16px; }
  .muted{ font-size:12px; color:#9fb0c3; margin-top:6px; }
  .meta{ font-size:11px; color:#7c8ca3; margin-top:6px; }

  h2{ margin:18px 0 8px; font-size:18px; }
  .wo{ margin-bottom:10px; }

  .toolbar{ display:flex; gap:8px; margin-bottom:10px; }
  .toolbar button{ font-size:13px; padding:6px 10px; }
</style>
</head>

<body>

<header>
  <h1 style="margin:0;">Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<!-- KPI ROW -->
<div class="row" id="kpis"></div>

<!-- TECH ROW -->
<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<!-- FILTER BAR -->
<div class="toolbar">
  <button onclick="setRange('day')">Today</button>
  <button onclick="setRange('week')">This Week</button>
  <button onclick="setRange('all')">All</button>
  <button onclick="clearFilters()">Clear Filters</button>
</div>

<h2>Work Orders</h2>
<div id="workOrders">Loading…</div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const DEFAULT_JOB_HOURS = 1.0;

// state
let employees=[], employeesById={}, technicians=[];
let orders=[];
let activeTechId=null;
let activeKpiFilter=null; // today | waiting | complications
let activeRange="day"; // day | week | all

const now = new Date();
const startOfToday = new Date(now.setHours(0,0,0,0));
const startOfWeek = new Date(startOfToday); startOfWeek.setDate(startOfWeek.getDate()-startOfWeek.getDay());

function money(n){ return `$${Number(n||0).toFixed(2)}`; }

function jobHours(w){
  if (w.scheduled_start && w.scheduled_end) {
    return (new Date(w.scheduled_end)-new Date(w.scheduled_start))/36e5;
  }
  if (w.status==="scheduled") return DEFAULT_JOB_HOURS;
  return 0;
}

function rateFor(w){
  return w.assigned_to ? (employeesById[w.assigned_to]?.hourly_labor_rate||0) : 0;
}

function revenueFor(w){ return jobHours(w)*rateFor(w); }

async function fetchJson(url,token){
  const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function auth(){
  const t=localStorage.getItem("sb_access_token");
  if(!t) return null;
  const r=await fetch(`${API_BASE}/auth/v1/user`,{headers:{Authorization:`Bearer ${t}`,apikey:ANON_KEY}});
  return r.ok ? t : null;
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

/* ================= KPIs ================= */

function renderKPIs(){
  let todayH=0,todayR=0,futureH=0,futureR=0,waitH=0,waitR=0,compH=0,compR=0;

  orders.forEach(w=>{
    const h=jobHours(w), r=revenueFor(w);
    const s=w.scheduled_start?new Date(w.scheduled_start):null;
    const isToday=s && s>=startOfToday && s<new Date(startOfToday.getTime()+86400000);
    const isFuture=s && s>new Date(startOfToday.getTime()+86400000);

    if(["scheduled","new","in_progress"].includes(w.status)){
      if(isToday || (!s && w.status==="scheduled")){ todayH+=h; todayR+=r; }
      if(isFuture){ futureH+=h; futureR+=r; }
    }
    if(["waiting","waiting_parts"].includes(w.status)){ waitH+=h; waitR+=r; }
    if(["blocked","issue","complications"].includes(w.status)){ compH+=h; compR+=r; }
  });

  document.getElementById("kpis").innerHTML=`
    <div class="card kpi clickable ${activeKpiFilter==='today'?'active':''}"
         onclick="setKpi('today')">
      <div class="label">Scheduled Work</div>
      <div class="value">
        Today ${todayH.toFixed(1)}h / ${money(todayR)}<br>
        <span class="muted">Future ${futureH.toFixed(1)}h / ${money(futureR)}</span>
      </div>
    </div>

    <div class="card kpi clickable ${activeKpiFilter==='waiting'?'active':''}"
         onclick="setKpi('waiting')">
      <div class="label">Waiting on Parts / Service</div>
      <div class="value">${waitH.toFixed(1)}h / ${money(waitR)}</div>
    </div>

    <div class="card kpi clickable ${activeKpiFilter==='complications'?'active':''}"
         onclick="setKpi('complications')">
      <div class="label">Complications</div>
      <div class="value">${compH.toFixed(1)}h / ${money(compR)}</div>
    </div>
  `;
}

function setKpi(k){ activeKpiFilter=(activeKpiFilter===k?null:k); renderKPIs(); renderWorkOrders(); }
window.setKpi=setKpi;

/* ================= TECH ================= */

function renderTechCards(){
  const stats={};
  technicians.forEach(t=>stats[t.employee_id]={h:0,r:0,c:0});

  orders.forEach(w=>{
    const t=w.assigned_to;
    if(!stats[t]) return;
    const s=w.scheduled_start?new Date(w.scheduled_start):null;
    if(activeRange==="day" && !(s && s>=startOfToday)) return;
    if(activeRange==="week" && !(s && s>=startOfWeek)) return;
    stats[t].h+=jobHours(w);
    stats[t].r+=revenueFor(w);
    stats[t].c++;
  });

  document.getElementById("techCards").innerHTML=
    technicians.map(t=>{
      const st=stats[t.employee_id];
      return `
        <div class="card tech clickable ${activeTechId===t.employee_id?'active':''}"
             onclick="selectTech('${t.employee_id}')">
          <div class="label">${t.name}</div>
          <div class="value">${st.h.toFixed(1)}h / ${money(st.r)}</div>
          <div class="muted">Rate ${money(t.hourly_labor_rate)}/hr · Jobs ${st.c}</div>
        </div>
      `;
    }).join("");
}

function selectTech(id){
  activeTechId = (activeTechId===id?null:id);
  renderTechCards(); renderWorkOrders();
}
window.selectTech=selectTech;

/* ================= RANGE ================= */

function setRange(r){ activeRange=r; renderTechCards(); renderWorkOrders(); }
window.setRange=setRange;

function clearFilters(){
  activeTechId=null; activeKpiFilter=null; activeRange="day";
  renderKPIs(); renderTechCards(); renderWorkOrders();
}
window.clearFilters=clearFilters;

/* ================= WORK ORDERS ================= */

function renderWorkOrders(){
  const list=document.getElementById("workOrders");

  const filtered=orders.filter(w=>{
    if(activeTechId && w.assigned_to!==activeTechId) return false;

    if(activeKpiFilter){
      if(activeKpiFilter==="waiting") return ["waiting","waiting_parts"].includes(w.status);
      if(activeKpiFilter==="complications") return ["blocked","issue","complications"].includes(w.status);
      if(activeKpiFilter==="today"){
        const s=w.scheduled_start?new Date(w.scheduled_start):null;
        return s && s>=startOfToday;
      }
    }

    if(activeRange!=="all"){
      const s=w.scheduled_start?new Date(w.scheduled_start):null;
      if(!s) return false;
      if(activeRange==="day" && s<startOfToday) return false;
      if(activeRange==="week" && s<startOfWeek) return false;
    }

    return true;
  });

  if(!filtered.length){
    list.innerHTML=`<div class="muted">No work orders for this view.</div>`;
    return;
  }

  list.innerHTML=filtered.map(w=>{
    const tech=employeesById[w.assigned_to]?.name||"Unassigned";
    return `
      <div class="card wo">
        <div class="job-title">${w.customer_name||"Unknown Customer"}</div>
        <div class="muted">${w.customer_phone||""}</div>
        <div class="muted">${w.summary||"Service"} · ${jobHours(w).toFixed(1)}h · ${money(revenueFor(w))}</div>
        <div class="meta">Status ${w.status}</div>
        <div class="meta">Assigned ${tech}</div>
      </div>
    `;
  }).join("");
}

/* ================= LOAD ================= */

async function load(){
  const token=await auth();
  if(!token){ logout(); return; }

  employees=await fetchJson(`${FUNCTIONS_BASE}/employees`,token);
  employees.forEach(e=>employeesById[e.employee_id]=e);
  technicians=employees.filter(e=>e.role==="technician");

  orders=await fetchJson(`${FUNCTIONS_BASE}/work_orders`,token);

  renderKPIs(); renderTechCards(); renderWorkOrders();
}

load();
</script>

</body>
</html>
