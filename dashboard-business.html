<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Business Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }

    .row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px; }
    .card {
      background:#0f1621; border:1px solid #223044; border-radius:14px;
      padding:14px 16px;
    }

    .kpi { min-width:260px; flex: 1 1 260px; cursor:pointer; }
    .kpi:hover { border-color:#2f4461; }

    /* TECH CARD — UPDATED LAYOUT */
    .tech {
      min-width:260px; flex: 1 1 260px; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .tech.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

    .techLeft { min-width: 0; }
    .techRight { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; }
    .avatar {
      width:52px; height:52px; border-radius:999px;
      border:1px solid #223044; background:#0b0f14;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; font-weight:700; color:#e8eef6;
    }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .techName { font-size:12px; color:#e8eef6; text-align:center; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .detailsBtn { margin-top:10px; }

    .label { font-size:12px; color:#9fb0c3; }
    .value { font-size:18px; font-weight:650; margin-top:6px; line-height:1.3; }
    .muted { font-size:12px; color:#9fb0c3; margin-top:6px; }
    .error { color:#ffb3b3; white-space:pre-wrap; }

    button {
      padding:8px 14px; border-radius:10px; border:1px solid #2a3b55;
      background:#1a2535; color:#fff; cursor:pointer;
    }

    .filters { display:flex; gap:8px; margin: 8px 0 14px; flex-wrap:wrap; }
    .pill {
      padding:6px 10px; border-radius:10px; border:1px solid #223044;
      background:#0f1621; color:#e8eef6; cursor:pointer; font-size:12px;
    }
    .pill.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

    .wo strong { font-weight:650; }

    /* HEADER RIGHT — app name above logout */
    .headerRight { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
    .appName { font-size:12px; color:#9fb0c3; line-height:1; }
  </style>
</head>

<body>

<header>
  <!-- Replace "Business Dashboard" with tenant business name -->
  <h1 id="tenantTitle">Business Dashboard</h1>

  <div class="headerRight">
    <div class="appName">WorkLogicPro</div>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<!-- Business KPI row -->
<div class="row" id="kpis"></div>

<!-- Tech cards row -->
<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<div class="filters">
  <div class="pill active" id="btnToday" onclick="setRange('today')">Today</div>
  <div class="pill" id="btnWeek" onclick="setRange('week')">This Week</div>
  <div class="pill" id="btnAll" onclick="setRange('all')">All</div>
  <div class="pill" onclick="clearFilters()">Clear Filters</div>
</div>

<!-- Work Orders list -->
<h2>Work Orders</h2>
<div id="workOrders">Loading…</div>

<script>
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
  const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

  // Fallback for “scheduled but no times”
  const DEFAULT_JOB_HOURS = 1.0;

  // ✅ SSOT STATUS BUCKETS (matches DB constraint)
  const STATUS_BUCKETS = {
    scheduled: ["scheduled","in_progress","repairing","testing","ready_for_pickup"],
    waiting: ["awaiting_parts","parts_on_order"],
    complications: ["diagnosis_required","customer_approval"],
    completed: ["completed","closed"]
  };
  function statusIn(bucket, status){
    return (STATUS_BUCKETS[bucket] || []).includes(status);
  }

  // State
  let employees = [];
  let employeesById = {};
  let technicians = [];
  let orders = [];
  let activeTechId = null;
  let activeRange = "today"; // today | week | all
  let activeKpiFilter = null; // 'scheduled' | 'waiting' | 'complications' | 'completed'

  // Date helpers
  const now = new Date();
  const startOfToday = new Date(now); startOfToday.setHours(0,0,0,0);
  const endOfToday = new Date(now); endOfToday.setHours(23,59,59,999);
  const startOfWeek = new Date(now);
  startOfWeek.setDate(now.getDate() - ((now.getDay() + 6) % 7)); // Monday
  startOfWeek.setHours(0,0,0,0);

  function money(n){ return `$${Number(n || 0).toFixed(2)}`; }

  function logout(){
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
  }

  /* ✅ AUTH: keep same behavior style as your working version */
  async function validateAuth(){
    const token = localStorage.getItem("sb_access_token");
    if (!token) return null;

    const res = await fetch(`${API_BASE}/auth/v1/user`, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });

    if (!res.ok) return null;
    return token;
  }

  async function fetchJson(url, token){
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function jobHours(w){
    if (w.scheduled_start && w.scheduled_end) {
      return (new Date(w.scheduled_end) - new Date(w.scheduled_start)) / 36e5;
    }
    if (w.status === "scheduled") return DEFAULT_JOB_HOURS;
    return 0;
  }

  // uses HOURLY rate from employees table as the “labor rate” for calc (your current setup)
  function orderRevenue(w){
    const hrs = jobHours(w);
    const techRate = employeesById[w.assigned_to]?.hourly_labor_rate;
    const rate = Number(techRate || 0);
    return hrs * rate;
  }

  function inRange(w){
    if (activeRange === "all") return true;

    const d = w.scheduled_start ? new Date(w.scheduled_start) : null;

    if (activeRange === "today") {
      // treat scheduled-without-time as “today”
      if (!d && w.status === "scheduled") return true;
      return d && d >= startOfToday && d <= endOfToday;
    }

    if (activeRange === "week") {
      if (!d && w.status === "scheduled") return true;
      return d && d >= startOfWeek;
    }

    return true;
  }

  /* ✅ Tenant name extraction — safe, won’t crash */
  function setTenantTitleFromData(){
    const el = document.getElementById("tenantTitle");
    const candidates = [];

    // Sometimes functions may return { data: [...], tenant_name: "..." }
    // We never assume shape; we just try safe picks.
    if (employees && employees.tenant_name) candidates.push(employees.tenant_name);
    if (orders && orders.tenant_name) candidates.push(orders.tenant_name);

    // Try first row fields if present
    const firstEmp = Array.isArray(employees) ? employees[0] : null;
    const firstOrd = Array.isArray(orders) ? orders[0] : null;

    if (firstEmp) {
      candidates.push(firstEmp.tenant_name, firstEmp.business_name, firstEmp.account_name, firstEmp.company_name);
    }
    if (firstOrd) {
      candidates.push(firstOrd.tenant_name, firstOrd.business_name, firstOrd.account_name, firstOrd.company_name);
    }

    const name = candidates.find(v => typeof v === "string" && v.trim().length > 0);
    el.textContent = name ? name.trim() : "Business Dashboard";
  }

  function kpiCard(key, title, arr){
    function sumH(a){ return a.reduce((s,w)=> s + jobHours(w), 0); }
    function sumR(a){ return a.reduce((s,w)=> s + orderRevenue(w), 0); }

    return `
      <div class="card kpi" onclick="setKpi('${key}')">
        <div class="label">${title}</div>
        <div class="value">${sumH(arr).toFixed(1)}h / ${money(sumR(arr))}</div>
        <div class="muted">Jobs: ${arr.length}</div>
      </div>
    `;
  }

  function renderKPIs(){
    const scheduled = orders.filter(w => inRange(w) && statusIn("scheduled", w.status));
    const waiting = orders.filter(w => inRange(w) && statusIn("waiting", w.status));
    const complications = orders.filter(w => inRange(w) && statusIn("complications", w.status));
    const completed = orders.filter(w => {
      if (!statusIn("completed", w.status)) return false;
      const d = new Date(w.updated_at || w.created_at);
      if (activeRange === "today") return d >= startOfToday && d <= endOfToday;
      if (activeRange === "week") return d >= startOfWeek;
      return true;
    });

    document.getElementById("kpis").innerHTML =
      kpiCard("scheduled", "Scheduled Work", scheduled) +
      kpiCard("waiting", "Waiting on Parts", waiting) +
      kpiCard("complications", "Complications", complications) +
      kpiCard("completed", "Completed", completed);
  }

  window.setKpi = function(key){
    activeKpiFilter = (activeKpiFilter === key) ? null : key;
    renderTechCards();
    renderWorkOrders();
  }

  function initialsFromName(name){
    const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
    if (!parts.length) return "??";
    return (parts[0][0] + (parts[1]?.[0] || "")).toUpperCase();
  }

  function techDisplayName(t){
    const first = (t.first_name || "").trim();
    const last = (t.last_name || "").trim();
    const displayName = (first || last) ? `${first} ${last}`.trim() : (t.name || "Tech");
    return displayName;
  }

  function techAvatarHtml(t, displayName){
    // Accept common fields if present, but never require them
    const url = t.profile_photo_url || t.avatar_url || t.photo_url || t.profile_url || "";
    if (url && typeof url === "string") {
      return `<div class="avatar"><img src="${url}" alt="${displayName}"/></div>`;
    }
    return `<div class="avatar">${initialsFromName(displayName)}</div>`;
  }

  function renderTechCards(){
    const byTech = {};
    technicians.forEach(t=>{
      byTech[t.employee_id] = { hrs:0, rev:0, jobs:0 };
    });

    orders.forEach(w=>{
      if (!inRange(w)) return;

      if (activeKpiFilter && !statusIn(activeKpiFilter, w.status)) return;

      const techId = w.assigned_to;
      if (!techId || !byTech[techId]) return;

      byTech[techId].hrs += jobHours(w);
      byTech[techId].rev += orderRevenue(w);
      byTech[techId].jobs += 1;
    });

    document.getElementById("techCards").innerHTML =
      technicians.map(t=>{
        const stat = byTech[t.employee_id] || { hrs:0, rev:0, jobs:0 };
        const active = activeTechId === t.employee_id ? "active" : "";
        const name = techDisplayName(t);

        return `
          <div class="card tech ${active}" onclick="selectTech('${t.employee_id}')">
            <div class="techLeft">
              <div class="value">${stat.hrs.toFixed(1)}h / ${money(stat.rev)}</div>
              <div class="muted">Jobs: ${stat.jobs}</div>
              <button class="detailsBtn" onclick="event.stopPropagation(); techDetails('${t.employee_id}')">Details</button>
            </div>

            <div class="techRight">
              ${techAvatarHtml(t, name)}
              <div class="techName">${name}</div>
            </div>
          </div>
        `;
      }).join("");
  }

  window.techDetails = function(id){
    const tech = employeesById[id];
    const name = techDisplayName(tech || {});
    alert(`Tech Details (placeholder)\n\n${name}\n\nNext: week/month hours, completed jobs, avg cycle time, etc.`);
  }

  window.selectTech = function(id){
    activeTechId = (activeTechId === id) ? null : id;
    renderTechCards();
    renderWorkOrders();
  }

  function workOrdersFiltered(){
    return orders.filter(w=>{
      if (!inRange(w)) return false;
      if (activeTechId && w.assigned_to !== activeTechId) return false;
      if (activeKpiFilter && !statusIn(activeKpiFilter, w.status)) return false;
      return true;
    });
  }

  function renderWorkOrders(){
    const list = document.getElementById("workOrders");
    const filtered = workOrdersFiltered();

    if (!filtered.length) {
      list.innerHTML = `<div class="muted">No work orders for this view.</div>`;
      return;
    }

    list.innerHTML = filtered.map(w=>{
      const techName = w.assigned_to
        ? (employeesById[w.assigned_to]?.name
            || `${employeesById[w.assigned_to]?.first_name||""} ${employeesById[w.assigned_to]?.last_name||""}`.trim()
            || "Unknown Tech")
        : "Unassigned";

      const customerName = w.customer_name || "—";
      const customerPhone = w.customer_phone || "—";
      const jobDesc = w.summary || "—";

      return `
        <div class="card wo">
          <div><strong>${customerName}</strong> · ${w.status}</div>
          <div class="muted">${customerPhone} — ${jobDesc}</div>
          <div class="muted">Assigned to: ${techName}</div>
        </div>
      `;
    }).join("");
  }

  window.setRange = function(r){
    activeRange = r;

    document.getElementById("btnToday").classList.toggle("active", r==="today");
    document.getElementById("btnWeek").classList.toggle("active", r==="week");
    document.getElementById("btnAll").classList.toggle("active", r==="all");

    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }

  window.clearFilters = function(){
    activeTechId = null;
    activeKpiFilter = null;
    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }

  async function load(){
    const token = await validateAuth();
    if (!token) {
      // ✅ Only auth failure redirects to login
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
      return;
    }

    try {
      // Employees (expects array with fields: employee_id, name, first_name, last_name, role, hourly_labor_rate)
      const emp = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);
      employees = emp;

      employeesById = {};
      employees.forEach(e => employeesById[e.employee_id] = e);

      // prefer first/last if present
      employees = employees.map(e => {
        const first = (e.first_name || "").trim();
        const last = (e.last_name || "").trim();
        const full = (first || last) ? `${first} ${last}`.trim() : e.name;
        return { ...e, name: full || e.name || "Employee" };
      });

      technicians = employees.filter(e => e.role === "technician");

      // Work Orders (expects array; each row should include customer_name/customer_phone + assigned_to)
      orders = await fetchJson(`${FUNCTIONS_BASE}/work_orders`, token);

      // ✅ Set tenant title safely (never crashes)
      setTenantTitleFromData();

      // Render
      renderKPIs();
      renderTechCards();
      renderWorkOrders();

      // ensure Today selected visually
      setRange("today");

    } catch (err) {
      // ✅ IMPORTANT: do NOT logout on data/render error
      document.getElementById("workOrders").innerHTML =
        `<div class="error">DASHBOARD ERROR (not auth):\n${err.message || err}</div>`;
    }
  }

  load();
</script>

</body>
</html>
