<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
  content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
.appName{position:fixed;top:10px;right:24px;font-size:12px;color:#9fb0c3}
header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:20px}
h1{margin:0;font-size:38px}
h2{margin:22px 0 12px;font-size:18px;display:flex;gap:12px;align-items:center}
button{padding:8px 14px;border-radius:10px;border:1px solid #2a3b55;background:#1a2535;color:#fff;cursor:pointer}
.row{display:flex;flex-wrap:wrap;gap:14px;margin-bottom:18px}
.card{background:#0f1621;border:1px solid #223044;border-radius:16px;padding:18px}
.kpi{min-width:220px;flex:1 1 220px;cursor:pointer}
.kpi.active{border-color:#3b82f6;box-shadow:0 0 0 1px rgba(59,130,246,.35) inset}
.kpi .label{font-size:12px;color:#9fb0c3}
.kpi .value{font-size:22px;font-weight:700}

.tech{min-width:340px;flex:1 1 340px;display:flex;justify-content:space-between;align-items:center}
.techLeft{display:flex;flex-direction:column;gap:8px}
.metric{font-size:20px;font-weight:700}
.sub{font-size:12px;color:#9fb0c3}
.load{font-size:12px;font-weight:700}
.load.light{color:#4ade80}
.load.normal{color:#60a5fa}
.load.heavy{color:#f59e0b}
.load.over{color:#ef4444}
.techRight{display:flex;flex-direction:column;align-items:center;gap:8px}
.avatar{width:56px;height:56px;border-radius:50%;background:#0b0f14;border:1px solid #223044;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700}
.techName{font-size:12px}
.muted{font-size:12px;color:#9fb0c3}
.wo{margin-bottom:12px}
.error{color:#ffb3b3;white-space:pre-wrap}
</style>
</head>

<body>

<div class="appName">WorkLogicPro</div>

<header>
  <h1 id="tenantTitle">Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<!-- KPI ROW -->
<div class="row" id="kpis"></div>

<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<h2>
  Work Orders
  <button onclick="createWorkOrder()">+ New Work Order</button>
</h2>

<div id="workOrders">Loading…</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API_BASE=`https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE=`${API_BASE}/functions/v1`;
const ANON_KEY=document.querySelector('meta[name="supabase-anon-key"]').content;

const DEFAULT_RATE=125;
const WEEKLY_CAPACITY=40;

const STATUS_BUCKETS={
  scheduled:["scheduled","in_progress","repairing","testing","ready_for_pickup"],
  waiting:["awaiting_parts","parts_on_order"],
  complications:["diagnosis_required","customer_approval"],
  completed:["completed","closed"]
};

let employees=[],technicians=[],orders=[];
let activeKpi=null;

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const t=localStorage.getItem("sb_access_token");
  if(!t) return null;
  const r=await fetch(`${API_BASE}/auth/v1/user`,{headers:{Authorization:`Bearer ${t}`,apikey:ANON_KEY}});
  return r.ok?t:null;
}

async function fetchJson(url,token){
  const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function hoursBetween(a,b){
  if(!a||!b) return 1;
  return (new Date(b)-new Date(a))/36e5;
}
function hrsRev(h){return `${h.toFixed(1)}h / $${(h*DEFAULT_RATE).toFixed(0)}`}

function createWorkOrder(){location.href="work-order-new.html"}

/* KPI */
function renderKPIs(){
  const card=(key,label,arr)=>`
    <div class="card kpi ${activeKpi===key?'active':''}"
      onclick="toggleKpi('${key}')">
      <div class="label">${label}</div>
      <div class="value">${arr.length}</div>
    </div>`;
  document.getElementById("kpis").innerHTML=
    card("scheduled","Scheduled",orders.filter(o=>STATUS_BUCKETS.scheduled.includes(o.status)))+
    card("waiting","Waiting",orders.filter(o=>STATUS_BUCKETS.waiting.includes(o.status)))+
    card("complications","Complications",orders.filter(o=>STATUS_BUCKETS.complications.includes(o.status)))+
    card("completed","Completed",orders.filter(o=>STATUS_BUCKETS.completed.includes(o.status)));
}
function toggleKpi(k){activeKpi=activeKpi===k?null:k;renderKPIs();renderWorkOrders()}

/* TECH CARDS */
function renderTechCards(){
  document.getElementById("techCards").innerHTML=
    technicians.map(t=>{
      const name=`${t.first_name||""} ${t.last_name||""}`.trim();
      const initials=name.split(" ").map(x=>x[0]).join("").slice(0,2);
      let weekHrs=0;
      orders.filter(o=>o.assigned_employee_id===t.employee_id)
        .forEach(o=>weekHrs+=hoursBetween(o.scheduled_start,o.scheduled_end));
      const pct=weekHrs/WEEKLY_CAPACITY;
      let cls="light",lbl="LIGHT";
      if(pct>=.5){cls="normal";lbl="NORMAL"}
      if(pct>=.8){cls="heavy";lbl="HEAVY"}
      if(pct>1){cls="over";lbl="OVERBOOKED"}
      return `
        <div class="card tech">
          <div class="techLeft">
            <div class="metric">${hrsRev(weekHrs)}</div>
            <div class="sub">Booked This Week</div>
            <div class="load ${cls}">● ${lbl}</div>
          </div>
          <div class="techRight">
            <div class="avatar">${initials}</div>
            <div class="techName">${name}</div>
          </div>
        </div>`;
    }).join("");
}

/* WORK ORDERS */
function renderWorkOrders(){
  const list=document.getElementById("workOrders");
  let filtered=orders.filter(o=>!STATUS_BUCKETS.completed.includes(o.status));
  if(activeKpi) filtered=orders.filter(o=>STATUS_BUCKETS[activeKpi].includes(o.status));
  filtered.sort((a,b)=>{
    const da=a.scheduled_start?new Date(a.scheduled_start):new Date(8640000000000000);
    const db=b.scheduled_start?new Date(b.scheduled_start):new Date(8640000000000000);
    return da-db;
  });
  if(!filtered.length){list.innerHTML=`<div class="muted">No work orders.</div>`;return}
  list.innerHTML=filtered.map(w=>`
    <div class="card wo">
      <strong>${w.customer_name||"Unknown Customer"}</strong> · ${w.status}
      <div class="muted">${w.summary||""}</div>
    </div>`).join("");
}

/* LOAD */
async function load(){
  const token=await validateAuth();
  if(!token){logout();return}
  try{
    employees=await fetchJson(`${FUNCTIONS_BASE}/employees`,token);
    technicians=employees.filter(e=>e.role==="technician");
    orders=await fetchJson(`${FUNCTIONS_BASE}/work_orders`,token);
    if(orders[0]?.tenant_name) document.getElementById("tenantTitle").textContent=orders[0].tenant_name;
    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }catch(e){
    document.getElementById("workOrders").innerHTML=`<div class="error">${e.message}</div>`;
  }
}
load();
</script>

</body>
</html>
