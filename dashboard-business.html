<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
  content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body {
  margin:0;
  padding:24px;
  font-family:system-ui;
  background:#0b0f14;
  color:#e8eef6;
}

.appName {
  position:fixed;
  top:10px;
  right:24px;
  font-size:12px;
  color:#9fb0c3;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:20px;
}

h1 { margin:0; font-size:38px; }
h2 { margin:20px 0 10px; font-size:18px; display:flex; gap:12px; align-items:center; }

button {
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #2a3b55;
  background:#1a2535;
  color:#fff;
  cursor:pointer;
}

.row { display:flex; flex-wrap:wrap; gap:14px; margin-bottom:18px; }

.card {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:16px;
  padding:18px;
}

/* TECH CARD — MANAGER CAPACITY VIEW */
.tech {
  min-width:340px;
  flex:1 1 340px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.techLeft {
  display:flex;
  flex-direction:column;
  gap:8px;
}

.metric {
  font-size:20px;
  font-weight:700;
}

.sub {
  font-size:12px;
  color:#9fb0c3;
}

.load {
  font-size:12px;
  font-weight:700;
}

.load.light { color:#4ade80; }
.load.normal { color:#60a5fa; }
.load.heavy { color:#f59e0b; }
.load.over { color:#ef4444; }

.techRight {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}

.avatar {
  width:56px;
  height:56px;
  border-radius:50%;
  background:#0b0f14;
  border:1px solid #223044;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:700;
}

.techName {
  font-size:12px;
}

.muted { font-size:12px; color:#9fb0c3; }
.wo { margin-bottom:10px; }
.error { color:#ffb3b3; white-space:pre-wrap; }
</style>
</head>

<body>

<div class="appName">WorkLogicPro</div>

<header>
  <h1 id="tenantTitle">Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<h2>
  Work Orders
  <button onclick="createWorkOrder()">+ New Work Order</button>
</h2>

<div id="workOrders">Loading…</div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

/* ================================
   CONFIG (SSOT-friendly)
================================ */
const DEFAULT_LABOR_RATE = 125; // $/hour (temporary; will come from business-settings.html)
const DAILY_CAPACITY = 8;
const WEEKLY_CAPACITY = 40;

let employees=[], technicians=[], orders=[];

/* ================================
   AUTH (DO NOT TOUCH)
================================ */
function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token=localStorage.getItem("sb_access_token");
  if(!token) return null;
  const r=await fetch(`${API_BASE}/auth/v1/user`,{
    headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
  });
  return r.ok?token:null;
}

async function fetchJson(url,token){
  const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

/* ================================
   HELPERS
================================ */
function hoursBetween(start,end){
  if(!start || !end) return 1; // default 1 hour if unscheduled (testing safe)
  return (new Date(end) - new Date(start)) / 36e5;
}

function formatHrsRev(hours){
  const rev = hours * DEFAULT_LABOR_RATE;
  return `${hours.toFixed(1)}h / $${rev.toFixed(0)}`;
}

function createWorkOrder(){
  location.href="work-order-new.html";
}

/* ================================
   TECH CARDS — MANAGER VIEW
================================ */
function renderTechCards(){
  const todayStart=new Date(); todayStart.setHours(0,0,0,0);
  const todayEnd=new Date(); todayEnd.setHours(23,59,59,999);

  const weekStart=new Date(todayStart);
  weekStart.setDate(todayStart.getDate()-((todayStart.getDay()+6)%7));

  document.getElementById("techCards").innerHTML =
    technicians.map(t=>{
      const name =
        t.name ||
        `${t.first_name||""} ${t.last_name||""}`.trim() ||
        "Technician";

      const initials = name
        .split(" ")
        .map(x=>x[0])
        .join("")
        .slice(0,2)
        .toUpperCase();

      const techOrders = orders.filter(
        w => w.assigned_employee_id === t.employee_id
      );

      let todayHours = 0;
      let weekHours = 0;

      techOrders.forEach(w=>{
        const hrs = hoursBetween(w.scheduled_start, w.scheduled_end);
        const d = w.scheduled_start ? new Date(w.scheduled_start) : null;

        if(d && d >= todayStart && d <= todayEnd) todayHours += hrs;
        if(d && d >= weekStart) weekHours += hrs;
      });

      const loadPct = weekHours / WEEKLY_CAPACITY;
      let loadClass="light", loadLabel="LIGHT";
      if(loadPct >= 0.5) { loadClass="normal"; loadLabel="NORMAL"; }
      if(loadPct >= 0.8) { loadClass="heavy"; loadLabel="HEAVY"; }
      if(loadPct > 1)   { loadClass="over";   loadLabel="OVERBOOKED"; }

      return `
        <div class="card tech">
          <div class="techLeft">
            <div class="metric">${formatHrsRev(todayHours)}</div>
            <div class="sub">Booked Today</div>

            <div class="metric">${formatHrsRev(weekHours)}</div>
            <div class="sub">Booked This Week</div>

            <div class="load ${loadClass}">● ${loadLabel}</div>
          </div>

          <div class="techRight">
            <div class="avatar">${initials}</div>
            <div class="techName">${name}</div>
          </div>
        </div>
      `;
    }).join("");
}

/* ================================
   WORK ORDERS (UNCHANGED)
================================ */
function renderWorkOrders(){
  const list=document.getElementById("workOrders");
  if(!orders.length){
    list.innerHTML=`<div class="muted">No work orders.</div>`;
    return;
  }
  list.innerHTML=orders.map(w=>`
    <div class="card wo">
      <strong>${w.customer_name||"Unknown Customer"}</strong> · ${w.status}
      <div class="muted">${w.summary||""}</div>
    </div>
  `).join("");
}

/* ================================
   LOAD
================================ */
async function load(){
  const token=await validateAuth();
  if(!token){ logout(); return; }

  try{
    employees = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);
    technicians = employees.filter(e=>e.role==="technician");

    orders = await fetchJson(`${FUNCTIONS_BASE}/work_orders`, token);

    if(orders[0]?.tenant_name){
      document.getElementById("tenantTitle").textContent = orders[0].tenant_name;
    }

    renderTechCards();
    renderWorkOrders();
  }catch(err){
    document.getElementById("workOrders").innerHTML =
      `<div class="error">${err.message}</div>`;
  }
}

load();
</script>

</body>
</html>
