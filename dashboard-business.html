<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
  content="REPLACE_WITH_YOUR_ANON_KEY" />

<style>
/* ===== BASE ===== */
body {
  margin:0;
  padding:24px;
  font-family:system-ui;
  background:#0b0f14;
  color:#e8eef6;
}

/* App name */
.appName {
  position:fixed;
  top:10px;
  right:24px;
  font-size:12px;
  color:#9fb0c3;
}

/* Header */
header {
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:16px;
}
h1 { margin:0; font-size:40px; }
h2 { margin:18px 0 10px; font-size:18px; }

/* Nav */
.sub-nav {
  display:flex;
  gap:16px;
  margin:8px 0 24px;
  padding-bottom:10px;
  border-bottom:1px solid #1f2937;
}
.sub-nav a {
  font-size:14px;
  color:#9ca3af;
  text-decoration:none;
  padding:4px 2px;
}
.sub-nav a.active {
  color:#38bdf8;
  font-weight:500;
  border-bottom:2px solid #38bdf8;
  padding-bottom:10px;
}

/* Cards */
.row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px; }
.card {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:14px;
  padding:14px 16px;
}

/* Buttons */
button {
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #2a3b55;
  background:#1a2535;
  color:#fff;
  cursor:pointer;
}

/* Filters */
.filters {
  display:flex;
  gap:8px;
  margin:8px 0 14px;
  flex-wrap:wrap;
}
.pill {
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #223044;
  background:#0f1621;
  color:#e8eef6;
  cursor:pointer;
  font-size:12px;
}
.pill.active {
  border-color:#3b82f6;
  box-shadow:0 0 0 1px rgba(59,130,246,.35) inset;
}

/* KPI */
.kpi { min-width:260px; flex:1 1 260px; cursor:pointer; }
.label { font-size:12px; color:#9fb0c3; }
.value { font-size:18px; font-weight:650; margin-top:6px; }
.muted { font-size:12px; color:#9fb0c3; margin-top:6px; }

/* Tech cards */
.tech {
  min-width:320px;
  flex:1 1 320px;
  display:flex;
  justify-content:space-between;
}
.tech.active {
  border-color:#3b82f6;
  box-shadow:0 0 0 1px rgba(59,130,246,.35) inset;
}
.avatar {
  width:66px;
  height:66px;
  border-radius:999px;
  border:1px solid #223044;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
}
.dot {
  width:6px;
  height:6px;
  background:#ff2d2d;
  border-radius:50%;
  display:inline-block;
  margin-right:6px;
}

/* Work orders */
.wo { cursor:pointer; }
.woRow {
  display:flex;
  justify-content:space-between;
  gap:12px;
}
.woStatus {
  font-size:12px;
  color:#9fb0c3;
}

/* Errors */
.error {
  color:#ffb3b3;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div class="appName">WorkLogicPro</div>

<header>
  <h1 id="tenantTitle">Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="sub-nav">
  <a href="dashboard-business.html" class="active">Dashboard</a>
  <a href="dashboard-customer-search.html">Customers</a>
  <a href="dashboard-settings.html">Settings</a>
</div>

<!-- KPIs -->
<div class="row" id="kpis"></div>

<!-- Range -->
<div class="filters">
  <div class="pill active" id="btnToday" onclick="setRange('today')">Today</div>
  <div class="pill" onclick="setRange('week')">This Week</div>
  <div class="pill" onclick="setRange('all')">All</div>
</div>

<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<div class="filters">
  <div class="pill" onclick="filterUnassigned()">Unassigned</div>
  <div class="pill" onclick="setSort('priority')">Priority</div>
  <div class="pill" onclick="clearFilters()">Clear Filters</div>
</div>

<h2>
  Work Orders
  <button onclick="createWorkOrder()">+ New Work Order</button>
</h2>

<div id="workOrders">Loadingâ€¦</div>

<script>
/* ================= CONFIG ================= */
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

/* ================= STATE ================= */
let orders = [];
let customers = [];
let vehicles = [];
let employees = [];

let customersById = {};
let vehiclesById = {};
let employeesById = {};

let activeRange = "today";
let activeTechId = null;
let activeSort = null;

/* ================= AUTH ================= */
function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return null;
  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ Authorization:`Bearer ${token}`, apikey:ANON_KEY }
  });
  return r.ok ? token : null;
}

async function fetchJson(url, token){
  const r = await fetch(url, {
    headers:{ Authorization:`Bearer ${token}`, apikey:ANON_KEY }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function fetchRest(table, token){
  const r = await fetch(`${REST_BASE}/${table}?select=*`, {
    headers:{ Authorization:`Bearer ${token}`, apikey:ANON_KEY }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

/* ================= HELPERS ================= */
function inRange(w){
  if (activeRange === "all") return true;
  if (!w.scheduled_start) return true;
  const d = new Date(w.scheduled_start);
  const now = new Date();
  if (activeRange === "today") return d.toDateString() === now.toDateString();
  if (activeRange === "week") {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate()-7);
    return d >= weekAgo;
  }
  return true;
}

/* ================= RENDER ================= */
function renderWorkOrders(){
  const el = document.getElementById("workOrders");
  const list = orders.filter(w => inRange(w));

  if (!list.length){
    el.innerHTML = `<div class="muted">No work orders.</div>`;
    return;
  }

  el.innerHTML = list.map(w=>{
    const c = customersById[w.customer_id];
    const v = vehiclesById[w.vehicle_id];
    const t = employeesById[w.assigned_employee_id];

    return `
      <div class="card wo">
        <div class="woRow">
          <div><strong>${c ? `${c.first_name} ${c.last_name}` : "Unknown Customer"}</strong></div>
          <div class="woStatus">${w.status}</div>
        </div>
        <div class="muted">${v ? `${v.year||""} ${v.make||""} ${v.model||""}` : "No vehicle"}</div>
        <div class="muted">Tech: ${t ? `${t.first_name} ${t.last_name}` : "Unassigned"}</div>
        <div class="muted">${w.summary || ""}</div>
      </div>
    `;
  }).join("");
}

/* ================= LOAD ================= */
async function load(){
  const token = await validateAuth();
  if (!token) return location.replace("login.html");

  employees = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);
  employees.forEach(e => employeesById[e.employee_id] = e);

  orders = await fetchJson(`${FUNCTIONS_BASE}/work_orders`, token);

  customers = await fetchRest("customers", token);
  vehicles = await fetchRest("vehicles", token);

  customers.forEach(c => customersById[c.customer_id] = c);
  vehicles.forEach(v => vehiclesById[v.vehicle_id] = v);

  renderWorkOrders();
}

document.addEventListener("DOMContentLoaded", load);
</script>
</body>
</html>
