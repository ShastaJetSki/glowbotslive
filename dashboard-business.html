<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body {
  margin:0;
  padding:24px;
  font-family:system-ui;
  background:#0b0f14;
  color:#e8eef6;
}
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
button {
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #2a3b55;
  background:#1a2535;
  color:#fff;
  cursor:pointer;
}
.kpis, .techs {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:24px;
}
.kpi, .tech {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:12px;
  padding:16px;
  min-width:260px;
}
.kpi .label, .tech .label {
  font-size:12px;
  color:#9fb0c3;
}
.kpi .value, .tech .value {
  font-size:18px;
  font-weight:600;
  line-height:1.4;
}
.tech {
  cursor:pointer;
}
.tech.active {
  border-color:#3b82f6;
}
.section {
  margin-top:24px;
}
.card {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:12px;
  padding:14px;
  margin-bottom:10px;
}
.muted {
  color:#9fb0c3;
  font-size:12px;
}
.error {
  color:#ffb3b3;
}
</style>
</head>

<body>

<header>
  <h1>Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="kpis" id="kpis"></div>
<div class="techs" id="techCards"></div>

<div class="section">
  <h3>Work Orders</h3>
  <div id="workOrders">Loading…</div>
</div>

<script>
/* ================= CONFIG ================= */
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const DEFAULT_JOB_HOURS = 1.0;
const LABOR_RATE = Number(localStorage.getItem("shop_labor_rate") || 50);

/* ================= STATE ================= */
let allOrders = [];
let activeEmployee = null;

/* ================= TIME HELPERS ================= */
const startOfToday = new Date();
startOfToday.setHours(0,0,0,0);
const endOfToday = new Date();
endOfToday.setHours(23,59,59,999);

function money(h){ return `$${(h * LABOR_RATE).toFixed(0)}`; }

function jobHours(w){
  if (w.scheduled_start && w.scheduled_end) {
    return (new Date(w.scheduled_end) - new Date(w.scheduled_start)) / 36e5;
  }
  if (w.status === "scheduled") return DEFAULT_JOB_HOURS;
  return 0;
}

/* ================= AUTH ================= */
async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return logout(true);

  try {
    const res = await fetch(`${API_BASE}/auth/v1/user`, {
      headers: {
        Authorization: `Bearer ${token}`,
        apikey: ANON_KEY
      }
    });
    if (!res.ok) throw new Error();
    return token;
  } catch {
    logout(true);
  }
}

function logout(force){
  localStorage.removeItem("sb_access_token");
  if (force) location.replace("login.html");
  else location.href = "login.html";
}

/* ================= LOAD ================= */
async function load(){
  const token = await validateAuth();
  if (!token) return;

  try {
    const res = await fetch(`${FUNCTIONS_BASE}/work_orders`, {
      headers:{
        Authorization:`Bearer ${token}`,
        apikey:ANON_KEY
      }
    });
    if(!res.ok) throw new Error(await res.text());
    allOrders = await res.json();
    renderKPIs();
    renderTechs();
    renderOrders();
  } catch(err){
    document.getElementById("workOrders").innerHTML =
      `<div class="error">${err.message}</div>`;
  }
}

/* ================= KPI ================= */
function renderKPIs(){
  let today=0, future=0, waiting=0, blocked=0, completed=0;

  allOrders.forEach(w=>{
    const hrs = jobHours(w);
    const s = w.scheduled_start ? new Date(w.scheduled_start) : null;
    const isToday = s && s>=startOfToday && s<=endOfToday;
    const isFuture = s && s>endOfToday;

    if(["scheduled","in_progress","new"].includes(w.status)){
      if(isToday) today+=hrs;
      if(isFuture) future+=hrs;
    }
    if(["waiting","waiting_parts"].includes(w.status)) waiting+=hrs;
    if(["blocked","issue"].includes(w.status)) blocked+=hrs;
    if(w.status==="completed" && isToday) completed+=hrs;
  });

  document.getElementById("kpis").innerHTML = `
    <div class="kpi">
      <div class="label">Scheduled Work</div>
      <div class="value">
        Today: ${today.toFixed(1)} hrs / ${money(today)}<br>
        <span class="muted">Future: ${future.toFixed(1)} hrs / ${money(future)}</span>
      </div>
    </div>

    <div class="kpi">
      <div class="label">Waiting on Parts / Service</div>
      <div class="value">${waiting.toFixed(1)} hrs / ${money(waiting)}</div>
    </div>

    <div class="kpi">
      <div class="label">Complications</div>
      <div class="value">${blocked.toFixed(1)} hrs / ${money(blocked)}</div>
    </div>

    <div class="kpi">
      <div class="label">Completed Today</div>
      <div class="value">${completed.toFixed(1)} hrs / ${money(completed)}</div>
    </div>
  `;
}

/* ================= TECH CARDS ================= */
function renderTechs(){
  const map = {};
  allOrders.forEach(w=>{
    if(!w.assigned_employee_id) return;
    const hrs = jobHours(w);
    if(!map[w.assigned_employee_id])
      map[w.assigned_employee_id]={today:0,future:0};
    map[w.assigned_employee_id].today+=hrs;
  });

  document.getElementById("techCards").innerHTML =
    Object.entries(map).map(([id,v])=>`
      <div class="tech ${activeEmployee===id?'active':''}"
           onclick="selectTech('${id}')">
        <div class="label">Technician</div>
        <div class="value">
          Today: ${v.today.toFixed(1)} hrs / ${money(v.today)}
        </div>
      </div>
    `).join("");
}

function selectTech(id){
  activeEmployee = activeEmployee===id?null:id;
  renderTechs();
  renderOrders();
}

/* ================= WORK ORDERS ================= */
function renderOrders(){
  document.getElementById("workOrders").innerHTML =
    allOrders
      .filter(w=>!activeEmployee || w.assigned_employee_id===activeEmployee)
      .map(w=>`
        <div class="card">
          ${w.summary} · ${w.status}
          <div class="muted">
            Assigned: ${w.assigned_employee_id||"Unassigned"}
          </div>
        </div>
      `).join("");
}

load();
</script>

</body>
</html>
