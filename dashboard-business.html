<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Business Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }

    /* pin app name top-right */
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; display:flex; align-items:center; gap:10px; }

    .row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px; }
    .card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:14px 16px; }

    button {
      padding:8px 14px; border-radius:10px; border:1px solid #2a3b55;
      background:#1a2535; color:#fff; cursor:pointer;
    }

    .filters { display:flex; gap:8px; margin: 8px 0 14px; flex-wrap:wrap; }
    .pill {
      padding:6px 10px; border-radius:10px; border:1px solid #223044;
      background:#0f1621; color:#e8eef6; cursor:pointer; font-size:12px;
      user-select:none;
    }
    .pill.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

    /* KPI */
    .kpi { min-width:260px; flex: 1 1 260px; cursor:pointer; }
    .kpi:hover { border-color:#2f4461; }
    .label { font-size:12px; color:#9fb0c3; }
    .value { font-size:18px; font-weight:650; margin-top:6px; line-height:1.3; }
    .muted { font-size:12px; color:#9fb0c3; margin-top:6px; }
    .error { color:#ffb3b3; white-space:pre-wrap; }

    /* TECH card (manager capacity) */
    .tech {
      min-width:320px; flex: 1 1 320px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:pointer;
    }
    .tech.active { border-color:#3b82f6; box-shadow:0 0 0 1px rgba(59,130,246,.35) inset; }

    .techLeft { display:flex; flex-direction:column; gap:8px; min-width:0; }
    .metric { font-size:18px; font-weight:700; }
    .sub { font-size:12px; color:#9fb0c3; }

    .load { font-size:12px; font-weight:700; }
    .load.light { color:#4ade80; }
    .load.normal { color:#60a5fa; }
    .load.heavy { color:#f59e0b; }
    .load.over { color:#ef4444; }

    .techRight { display:flex; flex-direction:column; align-items:center; gap:8px; min-width:96px; }
    .avatar {
      width:66px; height:66px; border-radius:999px;
      border:1px solid #223044; background:#0b0f14;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:20px; color:#e8eef6;
    }

    /* --- overdue red dot --- */
.dot {
  display:inline-block;
  width:8px;
  height:8px;
  border-radius:50%;
  background:#ef4444;
  margin-left:6px;
}

.dot.big {
  width:10px;
  height:10px;
}

    .techName { font-size:12px; text-align:center; line-height:1.2; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .wo strong { font-weight:650; }

    .woRow { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .woStatus { font-size:12px; color:#9fb0c3; }
  </style>
 

</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <h1 id="tenantTitle">Business Dashboard</h1>
    <button onclick="logout()">Logout</button>
  </header>

  <!-- KPI row -->
  <div class="row" id="kpis"></div>

  <!-- Tech cards -->
  <h2>Technicians</h2>
  <div class="row" id="techCards"></div>

  <!-- Range + Sort controls -->
  <div class="filters">
    <div class="pill active" id="btnToday" onclick="setRange('today')">Today</div>
    <div class="pill" id="btnWeek" onclick="setRange('week')">This Week</div>
    <div class="pill" id="btnAll" onclick="setRange('all')">All</div>

    <div class="pill active" id="sortSoonest" onclick="setSort('soonest')">Soonest</div>
    <div class="pill" id="sortLatest" onclick="setSort('latest')">Latest</div>
    <div class="pill" id="sortPriority" onclick="setSort('priority')">Priority</div>

    <div class="pill" onclick="clearFilters()">Clear Filters</div>
  </div>

  <!-- Work Orders -->
  <h2>
    Work Orders
    <button onclick="createWorkOrder()">+ New Work Order</button>
  </h2>
  <div id="workOrders">Loading…</div>

<script>
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
  const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

  // Business Settings (temporary default; business-settings.html will set later)
  const DEFAULT_LABOR_RATE = 125; // $/hr
  const RATE_KEY = "wl_labor_rate";
  function getLaborRate(){
    const v = Number(localStorage.getItem(RATE_KEY));
    return Number.isFinite(v) && v > 0 ? v : DEFAULT_LABOR_RATE;
  }

  const DEFAULT_JOB_HOURS = 1.0; // fallback when start/end missing

  // SSOT status buckets (matches your DB constraint vocabulary)
  const STATUS_BUCKETS = {
    scheduled: ["draft","scheduled","in_progress","repairing","testing","ready_for_pickup"],
    waiting: ["awaiting_parts","parts_on_order"],
    complications: ["diagnosis_required","customer_approval"],
    completed: ["completed","closed"]
  };
  function statusIn(bucket, status){
    return (STATUS_BUCKETS[bucket] || []).includes(status);
  }

  // State
  let employees = [];
  let employeesById = {};
  let technicians = [];
  let orders = [];
  let activeTechId = null;
  let activeRange = "today";   // today | week | all
  let activeKpi = null;        // scheduled | waiting | complications | completed | null
  let activeSort = "chrono"; // locked default: due soonest → latest

  // Date helpers
  function startOfToday(){
    const d = new Date(); d.setHours(0,0,0,0); return d;
  }
  function endOfToday(){
    const d = new Date(); d.setHours(23,59,59,999); return d;
  }
  function startOfWeekMonday(){
    const now = new Date();
    const d = new Date(now);
    d.setDate(now.getDate() - ((now.getDay() + 6) % 7)); // Monday
    d.setHours(0,0,0,0);
    return d;
  }

  function money(n){ return `$${Number(n || 0).toFixed(0)}`; }

  function formatHrsRev(hours){
    const rate = getLaborRate();
    const rev = hours * rate;
    return `${Number(hours || 0).toFixed(1)}h / ${money(rev)}`;
  }

  function logout(){
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
  }

  /* AUTH (do not change) */
  async function validateAuth(){
    const token = localStorage.getItem("sb_access_token");
    if (!token) return null;

    const res = await fetch(`${API_BASE}/auth/v1/user`, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });

    if (!res.ok) return null;
    return token;
  }

  async function fetchJson(url, token){
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function createWorkOrder(){
    // You can replace this later with your create flow
    location.href = "work-order-new.html";
  }

  function jobHours(w){
    if (w.scheduled_start && w.scheduled_end) {
      return (new Date(w.scheduled_end) - new Date(w.scheduled_start)) / 36e5;
    }
    // fallback for scheduled-like statuses
    if (["scheduled","in_progress","repairing","testing","ready_for_pickup"].includes(w.status)) return DEFAULT_JOB_HOURS;
    return 0;
  }

  // --------------------------------------------------
// Overdue helper (SSOT)
// scheduled_start < NOW
// AND status NOT IN ('completed','closed')
// --------------------------------------------------
function isOverdue(w){
  if (!w.scheduled_start) return false;

  if (["completed","closed"].includes(w.status)) {
    return false;
  }

  return new Date(w.scheduled_start) < new Date();
}


  function inRange(w){
    if (activeRange === "all") return true;

    const d = w.scheduled_start ? new Date(w.scheduled_start) : null;
    const sToday = startOfToday();
    const eToday = endOfToday();
    const sWeek = startOfWeekMonday();

    if (activeRange === "today") {
      if (!d && w.status === "scheduled") return true;
      return d && d >= sToday && d <= eToday;
    }
    if (activeRange === "week") {
      if (!d && w.status === "scheduled") return true;
      return d && d >= sWeek;
    }
    return true;
  }

  function defaultExcludeCompleted(w){
    // Default list should NOT show completed/closed unless explicitly filtered by KPI=completed
    return !statusIn("completed", w.status);
  }

  function initialsFromName(name){
    const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
    if (!parts.length) return "??";
    return (parts[0][0] + (parts[1]?.[0] || "")).toUpperCase();
  }

  function techDisplayName(t){
    const first = (t.first_name || "").trim();
    const last = (t.last_name || "").trim();
    return (first || last) ? `${first} ${last}`.trim() : (t.name || "Tech");
  }

  function setTenantTitleSafely(){
    const el = document.getElementById("tenantTitle");
    const name = orders?.[0]?.tenant_name;
    el.textContent = (typeof name === "string" && name.trim()) ? name.trim() : "Business Dashboard";
  }

  /* KPI rendering */
  function renderKPIs(){
    const inView = orders.filter(w => inRange(w));

    const scheduled = inView.filter(w => statusIn("scheduled", w.status));
    const waiting = inView.filter(w => statusIn("waiting", w.status));
    const complications = inView.filter(w => statusIn("complications", w.status));
    const completed = inView.filter(w => statusIn("completed", w.status));

    function sumH(arr){ return arr.reduce((s,w)=> s + jobHours(w), 0); }
    function sumR(arr){ return sumH(arr) * getLaborRate(); }

    const kpiCard = (key, title, arr) => `
      <div class="card kpi ${activeKpi===key?'active':''}" onclick="toggleKpi('${key}')">
        <div class="label">${title}</div>
        <div class="value">${formatHrsRev(sumH(arr))}</div>
        <div class="muted">Jobs: ${arr.length}</div>
      </div>
    `;

    document.getElementById("kpis").innerHTML =
      kpiCard("scheduled", "Scheduled Work", scheduled) +
      kpiCard("waiting", "Waiting on Parts/Serviced", waiting) +
      kpiCard("complications", "Needs Approval / Diagnosis", complications) +
      kpiCard("completed", "Ready for Pickup", completed);
  }

  window.toggleKpi = function(key){
    activeKpi = (activeKpi === key) ? null : key;
    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }

  /* Range + Sort UI */
  window.setRange = function(r){
    activeRange = r;
    document.getElementById("btnToday").classList.toggle("active", r==="today");
    document.getElementById("btnWeek").classList.toggle("active", r==="week");
    document.getElementById("btnAll").classList.toggle("active", r==="all");

    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }

  window.setSort = function(s){
    activeSort = s;
    document.getElementById("sortSoonest").classList.toggle("active", s==="soonest");
    document.getElementById("sortLatest").classList.toggle("active", s==="latest");
    document.getElementById("sortPriority").classList.toggle("active", s==="priority");
    renderWorkOrders();
  }

  window.clearFilters = function(){
    activeTechId = null;
    activeKpi = null;
    activeRange = "today";
    activeSort = "soonest";

    document.getElementById("btnToday").classList.add("active");
    document.getElementById("btnWeek").classList.remove("active");
    document.getElementById("btnAll").classList.remove("active");

    document.getElementById("sortSoonest").classList.add("active");
    document.getElementById("sortLatest").classList.remove("active");
    document.getElementById("sortPriority").classList.remove("active");

    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }

  /* Tech cards (manager: hours booked today & week) */
  function renderTechCards(){
    const sToday = startOfToday();
    const eToday = endOfToday();
    const sWeek = startOfWeekMonday();

    // In manager view, we calculate from orders in the selected range AND KPI filter (if set)
    const base = orders.filter(w => inRange(w));
    const scoped = activeKpi ? base.filter(w => statusIn(activeKpi, w.status)) : base;

    document.getElementById("techCards").innerHTML =
      technicians.map(t=>{
        const name = techDisplayName(t);
        const initials = initialsFromName(name);

        const mine = scoped.filter(w => w.assigned_employee_id === t.employee_id);

        let todayH = 0;
        let weekH = 0;

        mine.forEach(w=>{
          const hrs = jobHours(w);
          const d = w.scheduled_start ? new Date(w.scheduled_start) : null;

          if (d && d >= sToday && d <= eToday) todayH += hrs;
          if (d && d >= sWeek) weekH += hrs;
        });

        // load indicator based on weekly hours vs 40
        const pct = weekH / 40;
        let cls="light", lbl="LIGHT";
        if (pct >= 0.5) { cls="normal"; lbl="NORMAL"; }
        if (pct >= 0.8) { cls="heavy"; lbl="HEAVY"; }
        if (pct >  1.0) { cls="over";  lbl="OVERBOOKED"; }

        const active = activeTechId === t.employee_id ? "active" : "";
        return `
          <div class="card tech ${active}" onclick="selectTech('${t.employee_id}')">
            <div class="techLeft">
              <div class="metric">${formatHrsRev(todayH)}</div>
              <div class="sub">Booked Today</div>

              <div class="metric">${formatHrsRev(weekH)}</div>
              <div class="sub">Booked This Week</div>

              <div class="load ${cls}">● ${lbl}</div>
            </div>

            <div class="techRight">
              <div class="avatar">${initials}</div>
              <div class="techName">${name}</div>
            </div>
          </div>
        `;
      }).join("");
  }

  window.selectTech = function(id){
  activeTechId = (activeTechId === id) ? null : id;
  renderTechCards();
  renderWorkOrders();

  // auto-scroll so it feels responsive
  document.getElementById("workOrders")
    .scrollIntoView({ behavior: "smooth", block: "start" });
}


  function workOrdersFiltered(){
  // 1️⃣ Range filter
  let arr = orders.filter(w => inRange(w));

  // 2️⃣ Default: hide completed unless KPI = completed
  if (!activeKpi) {
    arr = arr.filter(w => !statusIn("completed", w.status));
  }

  // 3️⃣ KPI filter
  if (activeKpi) {
    arr = arr.filter(w => statusIn(activeKpi, w.status));
  }

  // 4️⃣ Tech filter (SSOT fix)
  if (activeTechId) {
    arr = arr.filter(w => w.assigned_employee_id === activeTechId);
  }

  return arr;
}


  function priorityRank(p){
    // optional: adjust later if your enum differs
    const v = String(p || "").toLowerCase();
    if (v === "urgent" || v === "high") return 0;
    if (v === "medium") return 1;
    if (v === "low") return 2;
    return 3;
  }

  function renderWorkOrders(){
    const list = document.getElementById("workOrders");
    const filtered = workOrdersFiltered();

    if (!filtered.length) {
      list.innerHTML = `<div class="muted">No work orders for this view.</div>`;
      return;
    }

    // Sorting (default soonest -> furthest)
filtered.sort((a, b) => {
  // Priority override only if selected
  if (activeSort === "priority") {
    const pr = priorityRank(a.priority) - priorityRank(b.priority);
    if (pr !== 0) return pr;
  }

  // Always chronological (soonest → latest)
  const da = a.scheduled_start
    ? new Date(a.scheduled_start).getTime()
    : Number.MAX_SAFE_INTEGER;

  const db = b.scheduled_start
    ? new Date(b.scheduled_start).getTime()
    : Number.MAX_SAFE_INTEGER;

  return da - db;
});



    // IMPORTANT: replace HTML (not +=) to prevent repeating scroll bug
    list.innerHTML = filtered.map(w=>{
      const tech = w.assigned_employee_id
        ? (employeesById[w.assigned_employee_id]?.name
            || `${employeesById[w.assigned_employee_id]?.first_name||""} ${employeesById[w.assigned_employee_id]?.last_name||""}`.trim()
            || "Unknown Tech")
        : "Unassigned";

      const customerName = w.customer_name || "—";
      const customerPhone = w.customer_phone || "—";
      const jobDesc = w.summary || "—";

      return `
        <div class="card wo">
          <div class="woRow">
            <div><strong>${customerName}</strong></div>
            <div class="woStatus">${w.status}</div>
          </div>
          <div class="muted">${customerPhone} — ${jobDesc}</div>
          <div class="muted">Tech: ${tech}</div>
        </div>
      `;
    }).join("");
  }

  async function load(){
    const token = await validateAuth();
    if (!token) {
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
      return;
    }

    try {
      // Employees
      employees = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);

      employeesById = {};
      employees.forEach(e => employeesById[e.employee_id] = e);

      // normalize employee name
      employees = employees.map(e => {
        const n = techDisplayName(e);
        return { ...e, name: n };
      });

      technicians = employees.filter(e => e.role === "technician");

      // Work Orders
      orders = await fetchJson(`${FUNCTIONS_BASE}/work_orders_with_customer`, token);

      // Tenant title
      setTenantTitleSafely();

      // Initial render
      renderKPIs();
      renderTechCards();
      renderWorkOrders();

      // ensure default buttons visually correct
      setRange("today");
      setSort("soonest");

    } catch (err) {
      document.getElementById("workOrders").innerHTML =
        `<div class="error">DASHBOARD ERROR (not auth):\n${err.message || err}</div>`;
    }
  }

  load();
</script>

</body>
</html>
