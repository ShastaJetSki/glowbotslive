<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>WorkLogicPro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
  content="PASTE_YOUR_ANON_KEY_HERE" />

<style>
body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
h1 { margin:0; font-size:32px; }
.app-name { font-size:12px; color:#9fb0c3; margin-bottom:6px; }

button {
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #2a3b55;
  background:#1a2535;
  color:#fff;
  cursor:pointer;
}

.row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px; }
.card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:14px 16px; }

.tech {
  min-width:260px;
  flex:1 1 260px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.tech.active { border-color:#3b82f6; }

.tech-left .value { font-size:18px; font-weight:650; }
.tech-left .muted { font-size:12px; color:#9fb0c3; }

.tech-right { text-align:center; }
.tech-photo {
  width:48px; height:48px;
  border-radius:50%;
  background:#1a2535;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}
.tech-name { font-size:12px; margin-top:6px; }

.filters { display:flex; gap:8px; margin:8px 0 14px; flex-wrap:wrap; }
.pill {
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #223044;
  background:#0f1621;
  font-size:12px;
  cursor:pointer;
}
.pill.active { border-color:#3b82f6; }

.muted { font-size:12px; color:#9fb0c3; }
.error { color:#ffb3b3; white-space:pre-wrap; }
</style>
</head>

<body>

<header>
  <h1 id="tenantName">Business</h1>
  <div style="text-align:right">
    <div class="app-name">WorkLogicPro</div>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<h2>Work Orders</h2>
<div id="workOrders">Loadingâ€¦</div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const STATUS_BUCKETS = {
  scheduled: ["scheduled","in_progress","repairing","testing","ready_for_pickup"],
  waiting: ["awaiting_parts","parts_on_order"],
  complications: ["diagnosis_required","customer_approval"],
  completed: ["completed","closed"]
};

let employees = [], employeesById = {}, technicians = [], orders = [];
let activeTechId = null;

function statusIn(bucket, status){
  return STATUS_BUCKETS[bucket]?.includes(status);
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

/* ðŸ”’ AUTH â€” RESTORED TO WORKING VERSION */
async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return null;

  const res = await fetch(`${API_BASE}/auth/v1/user`, {
    headers: {
      Authorization: `Bearer ${token}`,
      apikey: ANON_KEY,
      Accept: "application/json"
    }
  });

  if (!res.ok) return null;
  return token;
}

async function fetchJson(url, token){
  const res = await fetch(url, {
    headers: {
      Authorization: `Bearer ${token}`,
      apikey: ANON_KEY,
      Accept: "application/json"
    }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function jobHours(w){
  if (w.scheduled_start && w.scheduled_end) {
    return (new Date(w.scheduled_end)-new Date(w.scheduled_start))/36e5;
  }
  return w.status === "scheduled" ? 1 : 0;
}

function orderRevenue(w){
  const rate = employeesById[w.assigned_to]?.hourly_labor_rate || 0;
  return jobHours(w) * rate;
}

function renderTechCards(){
  const stats = {};
  technicians.forEach(t => stats[t.employee_id] = { hrs:0, rev:0, jobs:0 });

  orders.forEach(w => {
    if (!stats[w.assigned_to]) return;
    stats[w.assigned_to].hrs += jobHours(w);
    stats[w.assigned_to].rev += orderRevenue(w);
    stats[w.assigned_to].jobs++;
  });

  document.getElementById("techCards").innerHTML =
    technicians.map(t => {
      const s = stats[t.employee_id];
      const name = `${t.first_name||""} ${t.last_name||""}`.trim();
      const initials = name.split(" ").map(x=>x[0]).join("").slice(0,2).toUpperCase();

      return `
      <div class="card tech ${activeTechId===t.employee_id?'active':''}"
        onclick="activeTechId='${t.employee_id}'; renderTechCards();">
        <div class="tech-left">
          <div class="value">${s.hrs.toFixed(1)}h / $${s.rev.toFixed(2)}</div>
          <div class="muted">Jobs: ${s.jobs}</div>
        </div>
        <div class="tech-right">
          <div class="tech-photo">${initials}</div>
          <div class="tech-name">${name || "Tech"}</div>
        </div>
      </div>`;
    }).join("");
}

function renderWorkOrders(){
  const list = document.getElementById("workOrders");
  if (!orders.length) {
    list.innerHTML = `<div class="muted">No work orders.</div>`;
    return;
  }
  list.innerHTML = orders.map(w => `
    <div class="card">
      <strong>${w.customer_name||"â€”"}</strong> Â· ${w.status}
      <div class="muted">${w.customer_phone||"â€”"} â€” ${w.summary||"â€”"}</div>
    </div>
  `).join("");
}

async function load(){
  const token = await validateAuth();
  if (!token) { logout(); return; }

  employees = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);
  employees.forEach(e => employeesById[e.employee_id] = e);
  technicians = employees.filter(e => e.role === "technician");

  orders = await fetchJson(`${FUNCTIONS_BASE}/work_orders`, token);

  renderTechCards();
  renderWorkOrders();
}

load();
</script>

</body>
</html>
