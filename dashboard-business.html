<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
  content="YOUR_ANON_KEY_HERE" />

<style>
/* ⚠️ STYLES UNCHANGED — omitted here for brevity */
/* USE YOUR EXACT EXISTING <style> BLOCK */
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<header>
  <h1 id="tenantTitle">Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="row" id="kpis"></div>

<div class="filters">
  <div class="pill active" id="btnToday" onclick="setRange('today')">Today</div>
  <div class="pill" onclick="setRange('week')">This Week</div>
</div>

<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<div class="filters">
  <div class="pill" onclick="setRange('all')">All</div>
  <div class="pill" onclick="filterUnassigned()">Unassigned</div>
  <div class="pill" onclick="setSort('priority')">Priority</div>
  <div class="pill" onclick="clearFilters()">Clear Filters</div>
</div>

<h2>
  Work Orders
  <button onclick="createWorkOrder()">+ New Work Order</button>
</h2>

<div id="workOrders">Loading…</div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let orders = [];
let customers = [];
let vehicles = [];
let employees = [];
let employeesById = {};
let customersById = {};
let vehiclesById = {};

let activeRange = "today";
let activeTechId = null;
let activeSort = null;

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return null;

  const res = await fetch(`${API_BASE}/auth/v1/user`, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });

  return res.ok ? token : null;
}

async function fetchJson(url, token){
  const r = await fetch(url, {
    headers: { Authorization:`Bearer ${token}`, apikey: ANON_KEY }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function fetchRest(table, token){
  const r = await fetch(`${REST_BASE}/${table}?select=*`, {
    headers:{
      Authorization:`Bearer ${token}`,
      apikey:ANON_KEY
    }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function inRange(w){
  if (activeRange === "all") return true;
  if (!w.scheduled_start) return true;
  const d = new Date(w.scheduled_start);
  const now = new Date();
  if (activeRange === "today") {
    return d.toDateString() === now.toDateString();
  }
  if (activeRange === "week") {
    return d >= new Date(now.setDate(now.getDate()-7));
  }
  return true;
}

function renderWorkOrders(){
  const el = document.getElementById("workOrders");
  const list = orders.filter(w => inRange(w));

  if (!list.length){
    el.innerHTML = `<div class="muted">No work orders.</div>`;
    return;
  }

  el.innerHTML = list.map(w=>{
    const customer = customersById[w.customer_id];
    const vehicle = vehiclesById[w.vehicle_id];
    const tech = employeesById[w.assigned_employee_id];

    return `
      <div class="card wo">
        <div class="woRow">
          <div>
            <strong>${customer ? `${customer.first_name} ${customer.last_name}` : "Unknown Customer"}</strong>
          </div>
          <div class="woStatus">${w.status}</div>
        </div>
        <div class="muted">
          ${vehicle ? `${vehicle.year||""} ${vehicle.make||""} ${vehicle.model||""}` : "No vehicle"}
        </div>
        <div class="muted">
          Tech: ${tech ? tech.first_name+" "+tech.last_name : "Unassigned"}
        </div>
        <div class="muted">${w.summary || ""}</div>
      </div>
    `;
  }).join("");
}

async function load(){
  const token = await validateAuth();
  if (!token) return location.replace("login.html");

  employees = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);
  employees.forEach(e=>employeesById[e.employee_id]=e);

  orders = await fetchJson(`${FUNCTIONS_BASE}/work_orders`, token);
  customers = await fetchRest("customers", token);
  vehicles = await fetchRest("vehicles", token);

  customers.forEach(c=>customersById[c.customer_id]=c);
  vehicles.forEach(v=>vehiclesById[v.vehicle_id]=v);

  renderWorkOrders();
}

document.addEventListener("DOMContentLoaded", load);
</script>
</body>
</html>
