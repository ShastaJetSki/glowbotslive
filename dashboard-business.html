<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body {
  margin:0;
  padding:24px;
  font-family:system-ui;
  background:#0b0f14;
  color:#e8eef6;
}
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
button {
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #2a3b55;
  background:#1a2535;
  color:#fff;
  cursor:pointer;
}
.kpis {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:20px;
}
.kpi, .tech {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:12px;
  padding:16px;
  min-width:260px;
}
.kpi .label, .tech .label {
  font-size:12px;
  color:#9fb0c3;
}
.kpi .value, .tech .value {
  font-size:18px;
  font-weight:600;
}
.tech {
  cursor:pointer;
  transition:transform .15s ease, border-color .15s ease;
}
.tech:hover {
  transform:translateY(-2px);
  border-color:#3b82f6;
}
.tech.active {
  border-color:#3b82f6;
}
.section { margin-top:28px; }
.card {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:12px;
  padding:14px;
  margin-bottom:10px;
}
.muted { color:#9fb0c3; font-size:12px; }
</style>
</head>

<body>

<header>
  <h1>Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<!-- TOP KPI ROW -->
<div class="kpis" id="kpis"></div>

<!-- EMPLOYEE ROW -->
<div class="kpis" id="techCards"></div>

<!-- WORK ORDERS -->
<div class="section">
  <h3>Work Orders</h3>
  <div id="workOrders"></div>
</div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const FUNCTIONS_BASE = `https://${PROJECT_REF}.supabase.co/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;
const token = localStorage.getItem("sb_access_token");
if (!token) location.href = "login.html";

const LABOR_RATE = Number(localStorage.getItem("shop_labor_rate") || 50);

const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
const endOfToday = new Date(); endOfToday.setHours(23,59,59,999);

const ACTIVE_STATUSES = ["new","open","scheduled","in_progress","waiting","waiting_parts"];

let allOrders = [];
let activeEmployee = null;

function hoursBetween(start,end){
  if(!start) return 0;
  if(!end) return 1;
  return (new Date(end)-new Date(start))/36e5;
}
function money(h){ return `$${(h*LABOR_RATE).toFixed(0)}` }

async function load(){
  const res = await fetch(`${FUNCTIONS_BASE}/work_orders`,{
    headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
  });
  allOrders = await res.json();

  renderKPIs();
  renderEmployees();
  renderWorkOrders();
}

function renderKPIs(){
  let today=0,future=0;
  allOrders.forEach(w=>{
    if(!w.scheduled_start) return;
    const s=new Date(w.scheduled_start);
    const hrs=hoursBetween(w.scheduled_start,w.scheduled_end);
    if(!ACTIVE_STATUSES.includes(w.status)) return;
    if(s>=startOfToday && s<=endOfToday) today+=hrs;
    if(s>endOfToday) future+=hrs;
  });

  document.getElementById("kpis").innerHTML=`
    <div class="kpi">
      <div class="label">Scheduled Work</div>
      <div class="value">
        Today: ${today.toFixed(1)} hrs / ${money(today)}<br>
        <span class="muted">Future: ${future.toFixed(1)} hrs / ${money(future)}</span>
      </div>
    </div>`;
}

function renderEmployees(){
  const map={};

  allOrders.forEach(w=>{
    if(!w.assigned_employee_id||!w.scheduled_start) return;
    const id=w.assigned_employee_id;
    if(!map[id]) map[id]={today:0,future:0};
    const hrs=hoursBetween(w.scheduled_start,w.scheduled_end);
    const s=new Date(w.scheduled_start);
    if(s>=startOfToday && s<=endOfToday) map[id].today+=hrs;
    if(s>endOfToday) map[id].future+=hrs;
  });

  document.getElementById("techCards").innerHTML =
    Object.entries(map).map(([id,v])=>`
      <div class="tech ${activeEmployee===id?'active':''}"
           onclick="selectEmployee('${id}')">
        <div class="label">Employee</div>
        <div class="value">
          Today: ${v.today.toFixed(1)} hrs / ${money(v.today)}<br>
          <span class="muted">Future: ${v.future.toFixed(1)} hrs / ${money(v.future)}</span>
        </div>
      </div>
    `).join("");
}

function selectEmployee(id){
  activeEmployee = activeEmployee===id ? null : id;
  renderEmployees();
  renderWorkOrders();
}

function renderWorkOrders(){
  const list = allOrders.filter(w=>{
    if(activeEmployee && w.assigned_employee_id!==activeEmployee) return false;
    return true;
  });

  document.getElementById("workOrders").innerHTML =
    list.map(w=>`
      <div class="card">
        ${w.summary||"Work Order"} Â· ${w.status}
        <div class="muted">${w.assigned_employee_id||"Unassigned"}</div>
      </div>
    `).join("");
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.href="login.html";
}

load();
</script>

</body>
</html>
