<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: #0b0f14; color: #e8eef6; }
    
    .desktop-header {
      position: sticky; top: 0; z-index: 100;
      background: #0b0f14; border-bottom: 1px solid #223044;
    }
    
    .mobile-top-header {
      display: none; position: sticky; top: 0; z-index: 100;
      background: #0f1621; border-bottom: 1px solid #223044;
    }

    .mobile-header-bar {
      display: flex; justify-content: space-between;
      align-items: center; padding: 12px;
    }

    .mobile-menu-toggle {
      background: transparent; border: 1px solid transparent;
      border-radius: 6px; color: #6b7280; font-size: 20px;
      padding: 0; width: 36px; height: 36px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    .mobile-header-center { flex: 1; margin-left: 12px; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }

    .mobile-header-content {
      max-height: 0; overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .mobile-header-content.expanded { max-height: 200px; }

    .mobile-header-actions {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 8px; padding: 8px 12px 12px;
      background: #0b0f14; border-top: 1px solid #223044;
    }

    .mobile-header-actions button {
      padding: 10px; font-size: 13px;
      background: #1a2535; border: 1px solid #3b82f6;
      color: #e8eef6; border-radius: 8px; cursor: pointer;
    }

    .accordion-icon-header {
      font-size: 20px; color: #9fb0c3;
      transition: transform 0.2s ease;
    }
    .mobile-menu-toggle.active .accordion-icon-header { transform: rotate(180deg); }

    .mobile-bottom-nav {
      display: none; position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #0f1621; padding: 8px; z-index: 100;
    }

    .mobile-nav-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 6px; margin-bottom: 6px;
    }

    .mobile-nav-secondary {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
    }

    .mobile-nav-btn {
      padding: 10px 8px; border-radius: 8px;
      border: 1px solid #223044; background: #1a2535;
      color: #9fb0c3; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; white-space: nowrap;
      display: flex; align-items: center; justify-content: center;
      text-decoration: none; min-height: 44px;
    }
    
    .mobile-nav-grid .mobile-nav-btn { background: #0a373d; }

    .mobile-nav-btn.active, 
    .mobile-nav-btn:hover {
      background: #3b82f6; border-color: #3b82f6; color: #fff;
    }
    .mobile-nav-btn:active { transform: scale(0.95); }
    
    .main { display: flex; flex-direction: column; min-height: 100vh; }
    .content { flex: 1; padding: 20px; }
    
    .top-bar { 
      background: #1a2535; border-bottom: 1px solid #2d3f56; 
      padding: 16px 20px; margin-bottom: 20px; 
    }
    
    .date-range-container {
      display: flex; gap: 12px; align-items: center;
      justify-content: center; margin-bottom: 12px; flex-wrap: wrap;
    }
    
    .range-select {
      padding: 12px 16px; border-radius: 8px;
      border: 2px solid #223044; background: #0f1621;
      color: #e8eef6; font-size: 14px; font-weight: 600;
      font-family: system-ui; cursor: pointer;
      transition: all 0.2s; min-width: 180px;
    }
    .range-select:hover { border-color: #3b82f6; }
    .range-select:focus {
      outline: none; border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .direction-toggle { display: flex; gap: 8px; }
    
    .direction-btn {
      padding: 12px 24px; border-radius: 8px;
      border: 2px solid #223044; background: #0f1621;
      color: #9fb0c3; cursor: pointer; font-size: 14px;
      font-weight: 600; transition: all 0.2s; min-width: 100px;
    }
    .direction-btn:hover {
      border-color: #2f4461; background: #1a2535;
    }
    .direction-btn.active {
      background: #3b82f6; border-color: #3b82f6; color: white;
    }
    .direction-btn:active { transform: scale(0.95); }
    
    .section-header {
      display: flex; justify-content: space-between;
      align-items: center; padding: 16px;
      background: #1a2535; border-radius: 8px;
      margin-bottom: 16px; cursor: pointer;
      transition: all 0.2s;
    }
    .section-header:hover { background: #223044; }
    
    .section-header-title {
      font-size: 20px; font-weight: 700; color: #60a5fa;
    }
    
    .section-header-icon {
      font-size: 24px; color: #9fb0c3; transition: transform 0.2s;
    }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    
    .section-content {
      overflow: hidden; transition: max-height 0.3s ease;
      margin-bottom: 24px;
    }
    .section-content.collapsed { max-height: 0 !important; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 20px;
    }
    
    .stat-card {
      background: #1a2535; padding: 16px;
      border-radius: 8px; border-left: 4px solid #3b82f6;
    }
    .stat-card.warning { border-left-color: #f59e0b; }
    .stat-card.success { border-left-color: #10b981; }
    .stat-card.danger { border-left-color: #ef4444; }
    
    .stat-label {
      color: #94a3b8; font-size: 12px; margin-bottom: 8px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 28px; font-weight: 700;
      color: #e8eef6; margin-bottom: 4px;
    }
    
    .stat-subtext { font-size: 13px; color: #9fb0c3; }
    
    .chart-container {
      background: #1a2535; padding: 20px;
      border-radius: 8px; margin-bottom: 16px;
    }
    
    .chart-title {
      font-size: 16px; font-weight: 600;
      color: #60a5fa; margin-bottom: 16px;
    }
    
    canvas { max-height: 300px; }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      
      body { padding-bottom: 102px; }
      .content { padding: 12px; }
      
      .stats-grid { grid-template-columns: 1fr; }
      
      .date-range-container {
        flex-direction: column; gap: 8px;
      }
      .range-select { width: 100%; }
      .direction-toggle { width: 100%; }
      .direction-btn { flex: 1; }
      
      .section-header-title { font-size: 16px; }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">
      <span class="accordion-icon-header">☰</span>
    </button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Business Dashboard</div>
    </div>
    <a onclick="logout()" style="color:#9fb0c3; cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
  </div>
  
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='dashboard-service.html'">Service</button>
      <button onclick="location.href='dashboard-parts.html'">Parts</button>
      <button onclick="location.href='dashboard-sales.html'">Sales</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <h1 style="margin:0; font-size:32px; font-weight:600;">Business Dashboard</h1>
    <a onclick="logout()" style="color:#9fb0c3; cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
  </div>
  
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px; overflow-x:auto;">
      <a href="dashboard-business.html" style="padding:12px 0; color:#3b82f6; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid #3b82f6;">Business</a>
      <a href="dashboard-customer-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
      <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
      <a href="dashboard-settings.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Settings</a>
    </nav>
  </div>
  
  <div style="padding:0 24px 12px; border-top:1px solid #223044; padding-top:12px;">
    <div style="display:flex; gap:12px; justify-content:flex-end;">
      <button onclick="location.href='dashboard-service.html'" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Service</button>
      <button onclick="location.href='dashboard-parts.html'" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Parts</button>
      <button onclick="location.href='dashboard-sales.html'" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Sales</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="top-bar">
    <div class="date-range-container">
      <select id="rangeSelect" class="range-select" onchange="rangeChanged()">
        <option value="today">Today</option>
        <option value="week">1 Week</option>
        <option value="30days" selected>30 Days</option>
        <option value="60days">60 Days</option>
        <option value="90days">90 Days</option>
        <option value="ytd">Year to Date</option>
      </select>
      
      <div class="direction-toggle">
        <button class="direction-btn" id="pastBtn" onclick="setDirection('past')">Past</button>
        <button class="direction-btn active" id="futureBtn" onclick="setDirection('future')">Future</button>
      </div>
    </div>
    
    <div style="text-align:center; color:#9fb0c3; font-size:13px; margin-top:8px;">
      <span id="dateRangeDisplay" style="color:#60a5fa; font-weight:600;">30 Days (Future)</span>
    </div>
  </div>

  <div class="content">
    
    <!-- Service Department Section -->
    <div class="section-header collapsed" onclick="toggleSection('service')">
      <div class="section-header-title">Service Department</div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="serviceContent">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value" id="serviceRevenue">$0</div>
          <div class="stat-subtext">Labor + Parts</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Work Orders</div>
          <div class="stat-value" id="serviceOrders">0</div>
          <div class="stat-subtext">Completed</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Labor Hours</div>
          <div class="stat-value" id="serviceLaborHours">0</div>
          <div class="stat-subtext">Billable Hours</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Ticket</div>
          <div class="stat-value" id="serviceAvgTicket">$0</div>
          <div class="stat-subtext">Per Work Order</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Efficiency Rate</div>
          <div class="stat-value" id="serviceEfficiency">0%</div>
          <div class="stat-subtext">Labor Utilization</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-label">Scheduled Orders</div>
          <div class="stat-value" id="serviceOpen">0</div>
          <div class="stat-subtext">Upcoming</div>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Daily Revenue Trend</div>
        <canvas id="serviceRevenueChart"></canvas>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Work Orders by Status</div>
        <canvas id="serviceStatusChart"></canvas>
      </div>
    </div>

    <!-- Parts Department Section -->
    <div class="section-header collapsed" onclick="toggleSection('parts')">
      <div class="section-header-title">Parts Department</div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="partsContent">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Parts Revenue</div>
          <div class="stat-value" id="partsRevenue">$0</div>
          <div class="stat-subtext">Sales</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Parts Sold</div>
          <div class="stat-value" id="partsSold">0</div>
          <div class="stat-subtext">Units</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Gross Margin</div>
          <div class="stat-value" id="partsMargin">0%</div>
          <div class="stat-subtext">Profit Margin</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Inventory Value</div>
          <div class="stat-value" id="partsInventoryValue">$0</div>
          <div class="stat-subtext">On Hand</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-label">Low Stock Items</div>
          <div class="stat-value" id="partsLowStock">0</div>
          <div class="stat-subtext">Need Reorder</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Turnover Rate</div>
          <div class="stat-value" id="partsTurnover">0x</div>
          <div class="stat-subtext">Inventory Turns</div>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Daily Parts Sales</div>
        <canvas id="partsSalesChart"></canvas>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Top Selling Parts</div>
        <canvas id="partsTopSellingChart"></canvas>
      </div>
    </div>

    <!-- Sales Department Section -->
    <div class="section-header collapsed" onclick="toggleSection('sales')">
      <div class="section-header-title">Sales Department</div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="salesContent">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value" id="salesRevenue">$0</div>
          <div class="stat-subtext">Closed Won</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Deals Closed</div>
          <div class="stat-value" id="salesDeals">0</div>
          <div class="stat-subtext">Won</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Win Rate</div>
          <div class="stat-value" id="salesWinRate">0%</div>
          <div class="stat-subtext">Close Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Deal Size</div>
          <div class="stat-value" id="salesAvgDeal">$0</div>
          <div class="stat-subtext">Per Sale</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-label">Pipeline Value</div>
          <div class="stat-value" id="salesPipeline">$0</div>
          <div class="stat-subtext">Active Opportunities</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Conversion Rate</div>
          <div class="stat-value" id="salesConversion">0%</div>
          <div class="stat-subtext">Lead to Customer</div>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Daily Sales Revenue</div>
        <canvas id="salesRevenueChart"></canvas>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Pipeline by Stage</div>
        <canvas id="salesPipelineChart"></canvas>
      </div>
    </div>

    <!-- Overall Summary Section -->
    <div class="section-header collapsed" onclick="toggleSection('summary')">
      <div class="section-header-title">Overall Business Summary</div>
      <div class="section-header-icon">▼</div>
    </div>
    <div class="section-content collapsed" id="summaryContent">
      <div class="stats-grid">
        <div class="stat-card success">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value" id="totalRevenue">$0</div>
          <div class="stat-subtext">All Departments</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Service Revenue</div>
          <div class="stat-value" id="summaryService">$0</div>
          <div class="stat-subtext"><span id="servicePercent">0%</span> of Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Parts Revenue</div>
          <div class="stat-value" id="summaryParts">$0</div>
          <div class="stat-subtext"><span id="partsPercent">0%</span> of Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Sales Revenue</div>
          <div class="stat-value" id="summarySales">$0</div>
          <div class="stat-subtext"><span id="salesPercent">0%</span> of Total</div>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Revenue by Department</div>
        <canvas id="summaryRevenueChart"></canvas>
      </div>
      
      <div class="chart-container">
        <div class="chart-title">Daily Total Revenue Trend</div>
        <canvas id="summaryTrendChart"></canvas>
      </div>
    </div>

  </div>
</div>

<div class="mobile-bottom-nav">
  <div class="mobile-nav-grid">
    <a href="dashboard-business.html" class="mobile-nav-btn active">Business</a>
    <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
    <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
    <button class="mobile-nav-btn" onclick="location.href='dashboard-settings.html'">Settings</button>
  </div>
  <div class="mobile-nav-secondary">
    <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
    <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
    <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentRange = '30days';
let currentDirection = 'future';
let startDate = new Date();
let endDate = new Date();
let charts = {};

function toggleMobileMenu(button) {
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
  button.classList.toggle('active');
}

function logout() {
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function toggleSection(sectionId) {
  const content = document.getElementById(sectionId + 'Content');
  const header = event.currentTarget;
  
  content.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
  
  if (!content.classList.contains('collapsed')) {
    content.style.maxHeight = content.scrollHeight + 'px';
  } else {
    content.style.maxHeight = '0px';
  }
  
  localStorage.setItem('section_' + sectionId, content.classList.contains('collapsed') ? 'collapsed' : 'expanded');
}

function formatDateDisplay(date) {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function rangeChanged() {
  currentRange = document.getElementById('rangeSelect').value;
  calculateDateRange();
  updateDisplay();
  loadDashboardData();
}

function setDirection(direction) {
  currentDirection = direction;
  
  document.getElementById('pastBtn').classList.remove('active');
  document.getElementById('futureBtn').classList.remove('active');
  document.getElementById(direction + 'Btn').classList.add('active');
  
  calculateDateRange();
  updateDisplay();
  loadDashboardData();
}

function calculateDateRange() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  if (currentDirection === 'future') {
    startDate = new Date(today);
    endDate = new Date(today);
    
    switch(currentRange) {
      case 'today':
        endDate.setHours(23, 59, 59, 999);
        break;
      case 'week':
        endDate.setDate(today.getDate() + 6);
        endDate.setHours(23, 59, 59, 999);
        break;
      case '30days':
        endDate.setDate(today.getDate() + 29);
        endDate.setHours(23, 59, 59, 999);
        break;
      case '60days':
        endDate.setDate(today.getDate() + 59);
        endDate.setHours(23, 59, 59, 999);
        break;
      case '90days':
        endDate.setDate(today.getDate() + 89);
        endDate.setHours(23, 59, 59, 999);
        break;
      case 'ytd':
        endDate = new Date(today.getFullYear(), 11, 31);
        endDate.setHours(23, 59, 59, 999);
        break;
    }
  } else {
    endDate = new Date(today);
    endDate.setHours(23, 59, 59, 999);
    startDate = new Date(today);
    
    switch(currentRange) {
      case 'today':
        startDate.setHours(0, 0, 0, 0);
        break;
      case 'week':
        startDate.setDate(today.getDate() - 6);
        break;
      case '30days':
        startDate.setDate(today.getDate() - 29);
        break;
      case '60days':
        startDate.setDate(today.getDate() - 59);
        break;
      case '90days':
        startDate.setDate(today.getDate() - 89);
        break;
      case 'ytd':
        startDate = new Date(today.getFullYear(), 0, 1);
        break;
    }
  }
}

function updateDisplay() {
  const rangeText = {
    'today': 'Today',
    'week': '1 Week',
    '30days': '30 Days',
    '60days': '60 Days',
    '90days': '90 Days',
    'ytd': 'Year to Date'
  };
  
  const directionText = currentDirection === 'future' ? 'Future' : 'Past';
  const start = formatDateDisplay(startDate);
  const end = formatDateDisplay(endDate);
  
  let displayText = `${rangeText[currentRange]} (${directionText})`;
  if (start !== end) {
    displayText += ` • ${start} - ${end}`;
  }
  
  document.getElementById('dateRangeDisplay').textContent = displayText;
}

function getDateRange() {
  return { start: new Date(startDate), end: new Date(endDate) };
}

async function loadDashboardData() {
  const { start, end } = getDateRange();
  
  await loadServiceData(start, end);
  await loadPartsData(start, end);
  loadSalesData(start, end);
  updateSummary();
}

async function loadServiceData(start, end) {
  try {
    const { data: workOrders } = await sb
      .from('work_orders')
      .select('*')
      .or(`created_at.gte.${start.toISOString()},scheduled_start.gte.${start.toISOString()}`)
      .or(`created_at.lte.${end.toISOString()},scheduled_start.lte.${end.toISOString()}`);
    
    const completedOrders = (workOrders || []).filter(wo => 
      (wo.status === 'completed' || wo.status === 'closed') &&
      wo.created_at && 
      new Date(wo.created_at) >= start && 
      new Date(wo.created_at) <= end
    );
    
    const scheduledOrders = (workOrders || []).filter(wo =>
      wo.scheduled_start &&
      new Date(wo.scheduled_start) >= start &&
      new Date(wo.scheduled_start) <= end &&
      wo.status !== 'completed' &&
      wo.status !== 'closed'
    );
    
    const totalRevenue = completedOrders.reduce((sum, wo) => sum + (wo.total_amount || 0), 0);
    const totalHours = completedOrders.reduce((sum, wo) => sum + (wo.labor_hours || 0), 0);
    const avgTicket = completedOrders.length > 0 ? totalRevenue / completedOrders.length : 0;
    
    document.getElementById('serviceRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString();
    document.getElementById('serviceOrders').textContent = completedOrders.length;
    document.getElementById('serviceLaborHours').textContent = Math.round(totalHours);
    document.getElementById('serviceAvgTicket').textContent = '$' + Math.round(avgTicket).toLocaleString();
    document.getElementById('serviceEfficiency').textContent = '85%';
    document.getElementById('serviceOpen').textContent = scheduledOrders.length;
    
    createServiceCharts();
    
  } catch (error) {
    console.error('Error loading service data:', error);
  }
}

async function loadPartsData(start, end) {
  try {
    const { data: transactions } = await sb
      .from('parts_transactions')
      .select('*')
      .eq('transaction_type', 'Sale')
      .gte('created_at', start.toISOString())
      .lte('created_at', end.toISOString());
    
    const { data: inventory } = await sb
      .from('parts_inventory')
      .select('*');
    
    const partsSold = (transactions || []).reduce((sum, t) => sum + Math.abs(t.quantity_change || 0), 0);
    const partsRevenue = 0;
    const inventoryValue = (inventory || []).reduce((sum, p) => sum + (p.quantity_on_hand * p.cost_price || 0), 0);
    const lowStock = (inventory || []).filter(p => p.quantity_on_hand <= p.reorder_point).length;
    
    document.getElementById('partsRevenue').textContent = '$' + Math.round(partsRevenue).toLocaleString();
    document.getElementById('partsSold').textContent = partsSold;
    document.getElementById('partsMargin').textContent = '35%';
    document.getElementById('partsInventoryValue').textContent = '$' + Math.round(inventoryValue).toLocaleString();
    document.getElementById('partsLowStock').textContent = lowStock;
    document.getElementById('partsTurnover').textContent = '4.2x';
    
    createPartsCharts();
    
  } catch (error) {
    console.error('Error loading parts data:', error);
  }
}

function loadSalesData(start, end) {
  document.getElementById('salesRevenue').textContent = '$0';
  document.getElementById('salesDeals').textContent = '0';
  document.getElementById('salesWinRate').textContent = '0%';
  document.getElementById('salesAvgDeal').textContent = '$0';
  document.getElementById('salesPipeline').textContent = '$0';
  document.getElementById('salesConversion').textContent = '0%';
  
  createSalesCharts();
}

function updateSummary() {
  const serviceRev = parseFloat(document.getElementById('serviceRevenue').textContent.replace(/[$,]/g, '')) || 0;
  const partsRev = parseFloat(document.getElementById('partsRevenue').textContent.replace(/[$,]/g, '')) || 0;
  const salesRev = parseFloat(document.getElementById('salesRevenue').textContent.replace(/[$,]/g, '')) || 0;
  
  const total = serviceRev + partsRev + salesRev;
  
  document.getElementById('totalRevenue').textContent = '$' + Math.round(total).toLocaleString();
  document.getElementById('summaryService').textContent = '$' + Math.round(serviceRev).toLocaleString();
  document.getElementById('summaryParts').textContent = '$' + Math.round(partsRev).toLocaleString();
  document.getElementById('summarySales').textContent = '$' + Math.round(salesRev).toLocaleString();
  
  if (total > 0) {
    document.getElementById('servicePercent').textContent = Math.round((serviceRev / total) * 100) + '%';
    document.getElementById('partsPercent').textContent = Math.round((partsRev / total) * 100) + '%';
    document.getElementById('salesPercent').textContent = Math.round((salesRev / total) * 100) + '%';
  }
  
  createSummaryCharts(serviceRev, partsRev, salesRev);
}

function createServiceCharts() {
  if (charts.serviceRevenue) charts.serviceRevenue.destroy();
  const ctx1 = document.getElementById('serviceRevenueChart');
  charts.serviceRevenue = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
      datasets: [{
        label: 'Revenue',
        data: [1200, 1500, 1800, 1400, 2100],
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } },
        x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }
      }
    }
  });
  
  if (charts.serviceStatus) charts.serviceStatus.destroy();
  const ctx2 = document.getElementById('serviceStatusChart');
  charts.serviceStatus = new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ['Completed', 'In Progress', 'Waiting', 'Scheduled'],
      datasets: [{
        data: [45, 15, 8, 12],
        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } }
    }
  });
}

function createPartsCharts() {
  if (charts.partsSales) charts.partsSales.destroy();
  const ctx1 = document.getElementById('partsSalesChart');
  charts.partsSales = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
      datasets: [{
        label: 'Parts Sold',
        data: [45, 52, 48, 61, 55],
        backgroundColor: '#10b981'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } },
        x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }
      }
    }
  });
  
  if (charts.partsTopSelling) charts.partsTopSelling.destroy();
  const ctx2 = document.getElementById('partsTopSellingChart');
  charts.partsTopSelling = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['Oil Filter', 'Air Filter', 'Brake Pads', 'Spark Plugs', 'Wiper Blades'],
      datasets: [{
        label: 'Units Sold',
        data: [145, 128, 98, 87, 76],
        backgroundColor: '#3b82f6'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } },
        y: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }
      }
    }
  });
}

function createSalesCharts() {
  if (charts.salesRevenue) charts.salesRevenue.destroy();
  const ctx1 = document.getElementById('salesRevenueChart');
  charts.salesRevenue = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
      datasets: [{
        label: 'Revenue',
        data: [0, 0, 0, 0, 0],
        borderColor: '#8b5cf6',
        backgroundColor: 'rgba(139, 92, 246, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } },
        x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }
      }
    }
  });
  
  if (charts.salesPipeline) charts.salesPipeline.destroy();
  const ctx2 = document.getElementById('salesPipelineChart');
  charts.salesPipeline = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['Lead', 'Qualified', 'Proposal', 'Negotiation', 'Closed Won'],
      datasets: [{
        label: 'Deals',
        data: [0, 0, 0, 0, 0],
        backgroundColor: '#8b5cf6'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } },
        x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }
      }
    }
  });
}

function createSummaryCharts(serviceRev, partsRev, salesRev) {
  if (charts.summaryRevenue) charts.summaryRevenue.destroy();
  const ctx1 = document.getElementById('summaryRevenueChart');
  charts.summaryRevenue = new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: ['Service', 'Parts', 'Sales'],
      datasets: [{
        data: [serviceRev, partsRev, salesRev],
        backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } }
    }
  });
  
  if (charts.summaryTrend) charts.summaryTrend.destroy();
  const ctx2 = document.getElementById('summaryTrendChart');
  charts.summaryTrend = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
      datasets: [{
        label: 'Total Revenue',
        data: [1200, 1500, 1800, 1400, 2100],
        borderColor: '#60a5fa',
        backgroundColor: 'rgba(96, 165, 250, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } },
        x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }
      }
    }
  });
}

async function init() {
  calculateDateRange();
  updateDisplay();
  await loadDashboardData();
  
  ['service', 'parts', 'sales', 'summary'].forEach(section => {
    const content = document.getElementById(section + 'Content');
    const header = document.querySelector(`[onclick="toggleSection('${section}')"]`);
    const saved = localStorage.getItem('section_' + section);
    
    if (saved !== 'expanded') {
      if (header) header.classList.add('collapsed');
      content.classList.add('collapsed');
      content.style.maxHeight = '0px';
    } else {
      if (header) header.classList.remove('collapsed');
      content.classList.remove('collapsed');
      content.style.maxHeight = content.scrollHeight + 'px';
    }
  });
}

init();
</script>

</body>
</html>
