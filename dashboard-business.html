<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Business Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="stylesheet" href="theme-system.css">
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="dark-blue"] {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    [data-theme="grey"] {
      --bg-primary: #111111; --bg-secondary: #1a1a1a; --bg-card: #242424; --bg-hover: #2e2e2e;
      --border-default: #333333; --text-primary: #e5e5e5; --text-secondary: #a3a3a3;
      --accent-primary: #525252; --accent-light: #737373;
    }
    [data-theme="slate"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155;
      --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-primary: #6366f1; --accent-light: #818cf8;
    }
    [data-theme="midnight"] {
      --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228;
      --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4;
      --accent-primary: #8b5cf6; --accent-light: #a78bfa;
    }
    [data-theme="light-blue"] {
      --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0;
      --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569;
      --accent-primary: #2563eb; --accent-light: #3b82f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .theme-toggle-btn {
      width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default);
      background: transparent; color: var(--text-secondary); cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;
    }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    
    .theme-toast {
      position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%);
      background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary);
      padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; z-index: 1000;
      display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .theme-toast.show { display: block; animation: toastIn 0.3s ease; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: 1px solid transparent; border-radius: 6px; color: var(--text-secondary); font-size: 20px; padding: 0; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; margin-left: 0; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); border-radius: 8px; cursor: pointer; }
    .accordion-icon-header { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s ease; }
    .mobile-menu-toggle.active .accordion-icon-header { transform: rotate(180deg); }

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; }
    .mobile-nav-top { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 6px; }
    .mobile-nav-secondary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; transition: all 0.2s; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.related { background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--text-primary); }
    
    .content { flex: 1; padding: 20px; }
    
    .filter-bar-fixed { display: none; position: fixed; bottom: 102px; left: 0; right: 0; background: var(--bg-card); border-top: 1px solid var(--border-default); padding: 10px 12px; z-index: 99; transform: translateY(100%); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
    .filter-bar-fixed.visible { transform: translateY(0); opacity: 1; }
    .filter-bar-row { display: flex; gap: 8px; align-items: center; }
    .filter-bar-fixed .range-select { flex: 1; padding: 10px 12px; font-size: 13px; min-width: 0; background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: 8px; color: var(--text-primary); }
    .filter-bar-fixed .direction-btn { padding: 10px 16px; font-size: 13px; min-width: auto; background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
    .filter-bar-fixed .direction-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .filter-bar-fixed .date-display { width: 100%; text-align: center; font-size: 11px; color: var(--accent-light); margin-top: 6px; }
    
    .top-bar { background: var(--bg-card); border-bottom: 1px solid var(--border-default); padding: 16px 20px; margin-bottom: 20px; }
    .date-range-container { display: flex; gap: 12px; align-items: center; justify-content: center; margin-bottom: 12px; flex-wrap: wrap; }
    .range-select { padding: 12px 16px; border-radius: 8px; border: 2px solid var(--border-default); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; min-width: 180px; }
    .direction-toggle { display: flex; gap: 8px; }
    .direction-btn { padding: 12px 24px; border-radius: 8px; border: 2px solid var(--border-default); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 600; min-width: 100px; }
    .direction-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; cursor: pointer; scroll-margin-top: 70px; }
    .section-header:hover { background: var(--bg-hover); }
    .section-header.collapsed { border-radius: 8px; }
    .section-header-title { font-size: 18px; font-weight: 700; color: var(--accent-light); display: flex; align-items: center; gap: 8px; }
    .section-header-icon { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s; }
    .section-header.collapsed .section-header-icon { transform: rotate(-90deg); }
    .section-content { overflow: hidden; transition: max-height 0.3s ease; margin-bottom: 8px; }
    .section-content.collapsed { max-height: 0 !important; margin-bottom: 0; }
    
    .badge-count { background: var(--bg-hover); color: var(--text-primary); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; min-width: 20px; text-align: center; border: 1px solid var(--border-default); }
    .badge-count.warning { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: #f87171; }
    
    .kpi-container { background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .kpi-container:last-child { margin-bottom: 0; }
    .kpi-section-title { font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-default); text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-default); }
    .kpi-row:last-child { border-bottom: none; }
    .kpi-label { font-size: 13px; color: var(--text-secondary); }
    .kpi-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    
    .dept-cards-container { display: flex; flex-direction: column; gap: 12px; background: var(--bg-secondary); padding: 16px; border-radius: 0 0 8px 8px; }
    .dept-card { background: var(--bg-card); border-radius: 12px; padding: 16px; border-left: 4px solid var(--accent-primary); cursor: pointer; transition: all 0.3s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .dept-card:hover { border-left-color: var(--accent-light); background: var(--bg-hover); }
    .dept-card.service { border-left-color: #3b82f6; }
    .dept-card.parts { border-left-color: #8b5cf6; }
    .dept-card.sales { border-left-color: #10b981; }
    .dept-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .dept-card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .dept-card-expand { font-size: 18px; color: var(--text-secondary); transition: transform 0.2s; padding: 4px 8px; cursor: pointer; }
    .dept-card.collapsed .dept-card-expand { transform: rotate(-90deg); }
    .dept-card-summary { display: flex; gap: 16px; flex-wrap: wrap; }
    .dept-card-metric { display: flex; flex-direction: column; gap: 2px; min-width: 80px; }
    .dept-card-metric-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
    .dept-card-metric-value { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .dept-card-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; margin-top: 0; }
    .dept-card:not(.collapsed) .dept-card-details { max-height: 500px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-default); }
    .dept-card.collapsed .dept-card-details { max-height: 0; margin-top: 0; }
    .dept-detail-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-default); }
    .dept-detail-row:last-child { border-bottom: none; }
    .dept-detail-label { font-size: 13px; color: var(--text-secondary); }
    .dept-detail-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    
    .totals-card { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--accent-primary); }
    .totals-card-title { font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .totals-row { display: flex; gap: 16px; flex-wrap: wrap; }
    .totals-item { display: flex; flex-direction: column; gap: 2px; min-width: 100px; flex: 1; }
    .totals-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
    .totals-value { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    
    .chart-container { background: var(--bg-card); padding: 20px; border-radius: 8px; margin-top: 12px; }
    .chart-title { font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 16px; }
    canvas { max-height: 250px; }
    
    /* ========== ENHANCED INBOX/MESSAGES ========== */
    .inbox-container { background: var(--bg-secondary); border-radius: 8px; overflow: hidden; }
    .inbox-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); flex-wrap: wrap; gap: 8px; }
    .inbox-tabs { display: flex; gap: 4px; overflow-x: auto; }
    .inbox-tab { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
    .inbox-tab:hover { background: var(--bg-hover); }
    .inbox-tab.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    .inbox-list { max-height: 400px; overflow-y: auto; }
    .inbox-item { display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-default); cursor: pointer; transition: all 0.2s; }
    .inbox-item:hover { background: var(--bg-hover); opacity: 1 !important; }
    .inbox-item.unread { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent-primary); }
    .inbox-item.read { opacity: 0.4; }
    .inbox-item.read:hover { opacity: 0.8; }
    .inbox-item-content { flex: 1; min-width: 0; }
    .inbox-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .inbox-item-title { font-weight: 600; font-size: 14px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-item-time { font-size: 11px; color: var(--text-secondary); white-space: nowrap; }
    .inbox-item-from { font-size: 12px; color: var(--accent-light); margin-bottom: 2px; }
    .inbox-item-body { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .inbox-item-tag { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--bg-hover); color: var(--text-primary); margin-top: 6px; border: 1px solid var(--border-default); }
    .inbox-item-attachments { display: flex; gap: 4px; margin-top: 6px; }
    .inbox-attachment-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
    .inbox-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .inbox-empty-icon { font-size: 48px; margin-bottom: 12px; }
    .inbox-actions { display: flex; gap: 8px; padding: 12px; background: var(--bg-card); border-top: 1px solid var(--border-default); align-items: center; }
    .inbox-action-btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .inbox-action-btn:hover { background: var(--bg-hover); }
    .inbox-action-btn.primary { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    .inbox-search-input { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); }
    .inbox-search-input:focus { border-color: var(--accent-primary); outline: none; }
    .inbox-item-icon { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--text-secondary); font-size: 18px; }
    .inbox-item.unread .inbox-item-icon { color: var(--accent-light); }
    
    /* ========== ENHANCED TASKS ========== */
    .tasks-container { background: var(--bg-secondary); border-radius: 8px; overflow: hidden; }
    .tasks-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); flex-wrap: wrap; gap: 8px; }
    .tasks-tabs { display: flex; gap: 4px; overflow-x: auto; }
    .tasks-tab { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
    .tasks-tab:hover { background: var(--bg-hover); }
    .tasks-tab.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    .tasks-list { max-height: 500px; overflow-y: auto; }
    .task-item { display: flex; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border-default); align-items: flex-start; cursor: pointer; transition: background 0.2s; }
    .task-item:hover { background: var(--bg-hover); }
    .task-checkbox { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-default); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: all 0.2s; font-size: 12px; }
    .task-checkbox:hover { border-color: var(--accent-primary); background: rgba(59, 130, 246, 0.1); }
    .task-checkbox.completed { background: #10b981; border-color: #10b981; color: #fff; }
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px; }
    .task-item.completed .task-title { text-decoration: line-through; color: var(--text-secondary); }
    .task-description { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .task-org { font-size: 12px; color: var(--accent-light); margin-bottom: 4px; }
    .task-meta { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .task-meta-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-secondary); }
    .task-meta-item.overdue { color: #f87171; font-weight: 600; }
    .task-priority { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .task-priority.low { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
    .task-priority.normal { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .task-priority.high { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .task-priority.urgent { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .task-status-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .task-status-badge.pending, .task-status-badge.open { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
    .task-status-badge.in_progress { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .task-status-badge.review { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .task-status-badge.completed { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .tasks-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .tasks-empty-icon { font-size: 48px; margin-bottom: 12px; }
    .tasks-actions { display: flex; gap: 8px; padding: 12px; background: var(--bg-card); border-top: 1px solid var(--border-default); }
    .tasks-action-btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .tasks-action-btn:hover { background: var(--bg-hover); }
    .tasks-action-btn.primary { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: #fff; }
    
    /* Task Kanban View */
    .tasks-view-toggle { display: flex; gap: 4px; }
    .tasks-view-btn { padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 12px; cursor: pointer; }
    .tasks-view-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }
    .tasks-kanban { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 12px; min-height: 300px; }
    .kanban-column { background: var(--bg-card); border-radius: 8px; padding: 12px; min-height: 250px; }
    .kanban-column-header { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
    .kanban-count { background: var(--bg-hover); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    .kanban-task { background: var(--bg-secondary); border-radius: 6px; padding: 10px; margin-bottom: 8px; cursor: pointer; border-left: 3px solid var(--accent-primary); transition: all 0.2s; }
    .kanban-task:hover { background: var(--bg-hover); }
    .kanban-task.priority-high { border-left-color: #f59e0b; }
    .kanban-task.priority-urgent { border-left-color: #ef4444; }
    .kanban-task-title { font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 4px; }
    .kanban-task-org { font-size: 11px; color: var(--accent-light); margin-bottom: 4px; }
    .kanban-task-due { font-size: 10px; color: var(--text-secondary); }
    .kanban-task-due.overdue { color: #f87171; }
    
    @media (max-width: 768px) {
      .tasks-kanban { grid-template-columns: 1fr; }
    }
    
    /* Employees Section Styles */
    .employees-container { background: var(--bg-secondary); border-radius: 8px; overflow: hidden; }
    .employees-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-default); }
    .employees-summary { display: flex; gap: 16px; flex-wrap: wrap; }
    .emp-stat { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.green { background: #10b981; }
    .status-dot.yellow { background: #f59e0b; }
    .status-dot.red { background: #ef4444; }
    .status-dot.gray { background: #6b7280; }
    .employees-list { max-height: 600px; overflow-y: auto; }
    .employees-empty { padding: 40px; text-align: center; color: var(--text-secondary); }
    .employees-empty-icon { font-size: 48px; margin-bottom: 12px; color: var(--text-secondary); }
    .employees-actions { display: flex; gap: 8px; padding: 12px; background: var(--bg-card); border-top: 1px solid var(--border-default); }
    .dept-group { border-bottom: 1px solid var(--border-default); }
    .dept-group:last-child { border-bottom: none; }
    .dept-header { padding: 10px 16px; background: var(--bg-hover); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent-light); }
    .emp-strip { border-bottom: 1px solid var(--border-default); transition: background 0.2s; }
    .emp-strip:last-child { border-bottom: none; }
    .emp-strip.no-show { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; }
    .emp-strip-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; }
    .emp-strip-header:hover { background: var(--bg-hover); }
    .emp-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: var(--accent-light); flex-shrink: 0; overflow: hidden; }
    .emp-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 15px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .emp-phone { font-size: 13px; color: var(--text-secondary); }
    .emp-status { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; padding: 4px 8px; border-radius: 4px; background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border-default); }
    .emp-status.clocked-in { color: #10b981; border-color: #10b981; }
    .emp-status.scheduled { color: #f59e0b; border-color: #f59e0b; }
    .emp-status.no-show { color: #ef4444; border-color: #ef4444; }
    
    /* ========== MODALS ========== */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-default); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 1; }
    .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-textarea { min-height: 100px; resize: vertical; font-family: inherit; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border-default); position: sticky; bottom: 0; background: var(--bg-secondary); }
    .btn-secondary { padding: 10px 20px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; cursor: pointer; }
    .btn-secondary:hover { background: var(--bg-hover); }
    .btn-primary { padding: 10px 20px; border-radius: 6px; border: none; background: var(--accent-primary); color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-danger { padding: 10px 20px; border-radius: 6px; border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.1); color: #f87171; font-size: 14px; cursor: pointer; }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }
    
    /* Autocomplete */
    .autocomplete-container { position: relative; }
    .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 10; display: none; }
    .autocomplete-results.show { display: block; }
    .autocomplete-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-default); }
    .autocomplete-item:last-child { border-bottom: none; }
    .autocomplete-item:hover { background: var(--bg-hover); }
    .autocomplete-item-name { font-size: 14px; color: var(--text-primary); }
    
    /* File upload */
    .file-upload-area { border: 2px dashed var(--border-default); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .file-upload-area:hover { border-color: var(--accent-primary); background: rgba(59, 130, 246, 0.05); }
    .file-upload-area.dragover { border-color: var(--accent-primary); background: rgba(59, 130, 246, 0.1); }
    .file-upload-icon { font-size: 32px; color: var(--text-secondary); margin-bottom: 8px; }
    .file-upload-text { font-size: 14px; color: var(--text-secondary); }
    .file-upload-hint { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    .file-list { margin-top: 12px; }
    .file-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-card); border-radius: 6px; margin-bottom: 6px; }
    .file-item-icon { font-size: 16px; }
    .file-item-name { flex: 1; font-size: 13px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-item-size { font-size: 11px; color: var(--text-secondary); }
    .file-item-remove { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 16px; padding: 4px; }
    .file-item-remove:hover { color: #ef4444; }
    
    /* Status pipeline */
    .status-pipeline { display: flex; gap: 4px; margin-bottom: 16px; }
    .status-step { flex: 1; padding: 10px; text-align: center; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-secondary); }
    .status-step:hover { background: var(--bg-hover); }
    .status-step.active { background: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }
    .status-step.completed { background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981; }
    
    .desktop-dept-btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); transition: all 0.2s; }
    .desktop-dept-btn:hover { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); }
    .desktop-header-right { display: flex; align-items: center; gap: 16px; }
    
    /* Message thread */
    .message-thread { padding: 16px; }
    .message-bubble { max-width: 80%; margin-bottom: 12px; }
    .message-bubble.sent { margin-left: auto; }
    .message-bubble-content { padding: 12px 16px; border-radius: 12px; }
    .message-bubble.received .message-bubble-content { background: var(--bg-card); border-bottom-left-radius: 4px; }
    .message-bubble.sent .message-bubble-content { background: var(--accent-primary); border-bottom-right-radius: 4px; }
    .message-bubble-sender { font-size: 12px; color: var(--accent-light); margin-bottom: 4px; }
    .message-bubble-text { font-size: 14px; color: var(--text-primary); }
    .message-bubble-time { font-size: 10px; color: var(--text-secondary); margin-top: 4px; text-align: right; }
    .message-bubble.sent .message-bubble-time { color: rgba(255,255,255,0.7); }
    .message-attachments { margin-top: 8px; }
    .message-attachment { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-hover); border-radius: 6px; font-size: 12px; color: var(--text-primary); cursor: pointer; margin-right: 6px; margin-bottom: 6px; }
    .message-attachment:hover { background: var(--bg-card); }
    .message-image { max-width: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer; }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      .filter-bar-fixed { display: block; }
      .top-bar { display: none; }
      body { padding-bottom: 102px; }
      body.filter-bar-open { padding-bottom: 160px; }
      .content { padding: 12px; }
      .form-row { grid-template-columns: 1fr; }
      .status-pipeline { flex-wrap: wrap; }
      .status-step { flex: none; width: calc(50% - 2px); }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .filter-bar-fixed { display: none !important; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span class="accordion-icon-header">â˜°</span></button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Business Dashboard</div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="business-name" id="mobileBusinessName">Loading...</div>
        <div class="business-name" id="mobileUserEmail" style="color:var(--text-secondary);"></div>
      </div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
      </button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='dashboard-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:32px; font-weight:600;">Business Dashboard</h1>
      <div style="display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div class="business-name" id="desktopBusinessName">Loading...</div>
        <div id="desktopUserEmail" style="font-size:12px; color:var(--text-secondary);"></div>
      </div>
    </div>
    <div class="desktop-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
      </button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <!-- DYNAMIC NAV BUTTONS - Loaded based on tenant preset + role -->
  <div style="padding:0 24px 12px;">
    <nav id="desktop-nav-buttons" style="display:flex; gap:24px;">
      <!-- Dynamically populated by nav-loader.js -->
      <a href="dashboard-business.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Dashboard</a>
      <span style="color:var(--text-secondary); font-size:13px; padding:12px 0;">Loading...</span>
    </nav>
  </div>
  <!-- DYNAMIC ACTION BUTTONS -->
  <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
    <div id="desktop-action-buttons" style="display:flex; gap:12px; justify-content:flex-end;">
      <!-- Dynamically populated by nav-loader.js -->
    </div>
  </div>
</div>

<div class="main">
  <div class="top-bar">
    <div class="date-range-container">
      <select id="rangeSelect" class="range-select" onchange="rangeChanged()">
        <option value="today">Today</option>
        <option value="week">1 Week</option>
        <option value="30days" selected>30 Days</option>
        <option value="60days">60 Days</option>
        <option value="90days">90 Days</option>
        <option value="ytd">Year to Date</option>
      </select>
      <div class="direction-toggle">
        <button class="direction-btn active" id="pastBtn" onclick="setDirection('past')">Past</button>
        <button class="direction-btn" id="futureBtn" onclick="setDirection('future')">Future</button>
      </div>
    </div>
    <div style="text-align:center; color:var(--text-secondary); font-size:13px; margin-top:8px;">
      <span id="dateRangeDisplay" style="color:var(--accent-light); font-weight:600;">30 Days (Past)</span>
    </div>
  </div>

  <div class="content">
    
    <!-- Messages & Notifications Section -->
    <div class="section-header collapsed" onclick="toggleSection('messages')">
      <div class="section-header-title">
        Messages & Notifications
        <span class="badge-count" id="messagesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">â–¼</div>
    </div>
    <div class="section-content collapsed" id="messagesContent">
      <div class="inbox-container">
        <div class="inbox-header">
          <div class="inbox-tabs">
            <button class="inbox-tab active" data-tab="inbox" onclick="switchInboxTab('inbox', this)">Inbox</button>
            <button class="inbox-tab" data-tab="all" onclick="switchInboxTab('all', this)">All Mail</button>
            <button class="inbox-tab" data-tab="notifications" onclick="switchInboxTab('notifications', this)">Alerts</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" class="form-input inbox-search-input" id="inboxSearch" placeholder="Search messages..." style="width:180px; padding:6px 10px; font-size:12px;" oninput="searchInbox(this.value)">
            <button class="inbox-action-btn primary" onclick="openComposeModal()">+ Compose</button>
          </div>
        </div>
        <div class="inbox-list" id="inboxList">
          <div class="inbox-empty">
            <div class="inbox-empty-icon">ðŸ“­</div>
            <div>No messages yet</div>
          </div>
        </div>
        <div class="inbox-actions">
          <button class="inbox-action-btn" onclick="markAllNotificationsRead()">Mark All as Read</button>
          <button class="inbox-action-btn" onclick="loadInboxData()">â†» Refresh</button>
          <span style="flex:1;"></span>
          <span style="font-size:11px; color:var(--text-secondary);" id="inboxCount"></span>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="section-header collapsed" onclick="toggleSection('tasks')">
      <div class="section-header-title">
        Tasks
        <span class="badge-count warning" id="tasksBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">â–¼</div>
    </div>
    <div class="section-content collapsed" id="tasksContent">
      <div class="tasks-container">
        <div class="tasks-header">
          <div class="tasks-tabs">
            <button class="tasks-tab active" data-tab="open" onclick="switchTasksTab('open', this)">Open</button>
            <button class="tasks-tab" data-tab="in_progress" onclick="switchTasksTab('in_progress', this)">In Progress</button>
            <button class="tasks-tab" data-tab="review" onclick="switchTasksTab('review', this)">Review</button>
            <button class="tasks-tab" data-tab="completed" onclick="switchTasksTab('completed', this)">Done</button>
            <button class="tasks-tab" data-tab="overdue" onclick="switchTasksTab('overdue', this)">Overdue</button>
          </div>
          <div class="tasks-view-toggle">
            <button class="tasks-view-btn active" onclick="setTasksView('list', this)">List</button>
            <button class="tasks-view-btn" onclick="setTasksView('kanban', this)">Board</button>
          </div>
        </div>
        <div id="tasksListContainer">
          <div class="tasks-list" id="tasksList">
            <div class="tasks-empty">
              <div class="tasks-empty-icon">âœ“</div>
              <div>No tasks</div>
            </div>
          </div>
        </div>
        <div class="tasks-actions">
          <button class="tasks-action-btn primary" onclick="openTaskModal()">+ New Task</button>
        </div>
      </div>
    </div>

    <!-- Employees Section -->
    <div class="section-header collapsed" onclick="toggleSection('employees')">
      <div class="section-header-title">
        Employees
        <span class="badge-count" id="employeesBadge" style="display:none;">0</span>
      </div>
      <div class="section-header-icon">â–¼</div>
    </div>
    <div class="section-content collapsed" id="employeesContent">
      <div class="employees-container">
        <div class="employees-header">
          <div class="employees-summary">
            <span class="emp-stat"><span class="status-dot green"></span> <span id="clockedInCount">0</span> Clocked In</span>
            <span class="emp-stat"><span class="status-dot yellow"></span> <span id="scheduledLaterCount">0</span> Later</span>
            <span class="emp-stat"><span class="status-dot red"></span> <span id="noShowCount">0</span> No Show</span>
          </div>
        </div>
        <div class="employees-list" id="employeesList">
          <div class="employees-empty">
            <div class="employees-empty-icon">ðŸ‘¥</div>
            <div>Loading employees...</div>
          </div>
        </div>
        <div class="employees-actions" id="employeesActions" style="display:none;">
          <button class="tasks-action-btn primary" onclick="openNewEmployeeModal()">+ Add Employee</button>
        </div>
      </div>
    </div>

    <!-- Overall Business Summary -->
    <div class="section-header collapsed" onclick="toggleSummarySection(event)" id="summaryHeader">
      <div class="section-header-title">Overall Business Summary</div>
      <div class="section-header-icon">â–¼</div>
    </div>
    <div class="section-content collapsed" id="summaryContent">
      <div class="dept-cards-container">
        <div class="totals-card">
          <div class="totals-card-title">Business Totals</div>
          <div class="totals-row">
            <div class="totals-item"><span class="totals-label">Total Revenue</span><span class="totals-value" id="totalRevenue">$0</span></div>
            <div class="totals-item"><span class="totals-label">Customers</span><span class="totals-value" id="totalCustomers">0</span></div>
            <div class="totals-item"><span class="totals-label">Vehicles</span><span class="totals-value" id="totalVehicles">0</span></div>
          </div>
        </div>
        
        <div class="dept-card service collapsed" onclick="toggleDeptCard(event, 'service')">
          <div class="dept-card-header"><div class="dept-card-title">Service Department</div><div class="dept-card-expand">â–¼</div></div>
          <div class="dept-card-summary">
            <div class="dept-card-metric"><span class="dept-card-metric-label">Revenue</span><span class="dept-card-metric-value" id="serviceRevenueSummary">$0</span></div>
            <div class="dept-card-metric"><span class="dept-card-metric-label">Completed</span><span class="dept-card-metric-value" id="serviceOrdersSummary">0</span></div>
            <div class="dept-card-metric"><span class="dept-card-metric-label">In Progress</span><span class="dept-card-metric-value" id="serviceInProgressSummary">0</span></div>
          </div>
          <div class="dept-card-details">
            <div class="dept-detail-row"><span class="dept-detail-label">Service Revenue</span><span class="dept-detail-value" id="serviceRevenue">$0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Work Orders Completed</span><span class="dept-detail-value" id="serviceOrders">0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Avg Ticket</span><span class="dept-detail-value" id="serviceAvgTicket">$0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">In Progress</span><span class="dept-detail-value" id="serviceInProgress">0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Scheduled</span><span class="dept-detail-value" id="serviceScheduled">0</span></div>
          </div>
        </div>
        
        <div class="dept-card parts collapsed" onclick="toggleDeptCard(event, 'parts')">
          <div class="dept-card-header"><div class="dept-card-title">Parts Department</div><div class="dept-card-expand">â–¼</div></div>
          <div class="dept-card-summary">
            <div class="dept-card-metric"><span class="dept-card-metric-label">Inventory</span><span class="dept-card-metric-value" id="partsInventorySummary">$0</span></div>
            <div class="dept-card-metric"><span class="dept-card-metric-label">Items</span><span class="dept-card-metric-value" id="partsTotalSummary">0</span></div>
            <div class="dept-card-metric"><span class="dept-card-metric-label">Low Stock</span><span class="dept-card-metric-value" id="partsLowStockSummary">0</span></div>
          </div>
          <div class="dept-card-details">
            <div class="dept-detail-row"><span class="dept-detail-label">Inventory Value</span><span class="dept-detail-value" id="partsInventoryValue">$0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Total Items</span><span class="dept-detail-value" id="partsTotalItems">0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Low Stock Items</span><span class="dept-detail-value" id="partsLowStock">0</span></div>
          </div>
        </div>
        
        <div class="dept-card sales collapsed" onclick="toggleDeptCard(event, 'sales')">
          <div class="dept-card-header"><div class="dept-card-title">Sales Department</div><div class="dept-card-expand">â–¼</div></div>
          <div class="dept-card-summary">
            <div class="dept-card-metric"><span class="dept-card-metric-label">Revenue</span><span class="dept-card-metric-value" id="salesRevenueSummary">$0</span></div>
            <div class="dept-card-metric"><span class="dept-card-metric-label">Deals</span><span class="dept-card-metric-value" id="salesDealsSummary">0</span></div>
            <div class="dept-card-metric"><span class="dept-card-metric-label">Win Rate</span><span class="dept-card-metric-value" id="salesWinRateSummary">0%</span></div>
          </div>
          <div class="dept-card-details">
            <div class="dept-detail-row"><span class="dept-detail-label">Sales Revenue</span><span class="dept-detail-value" id="salesRevenue">$0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Deals Closed</span><span class="dept-detail-value" id="salesDeals">0</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Win Rate</span><span class="dept-detail-value" id="salesWinRate">0%</span></div>
            <div class="dept-detail-row"><span class="dept-detail-label">Pipeline Value</span><span class="dept-detail-value" id="salesPipeline">$0</span></div>
          </div>
        </div>
        
        <div class="chart-container"><div class="chart-title">Revenue by Department</div><canvas id="summaryRevenueChart"></canvas></div>
        <div class="chart-container"><div class="chart-title">Work Orders by Status</div><canvas id="serviceStatusChart"></canvas></div>
        <div class="chart-container"><div class="chart-title">Sales Pipeline by Stage</div><canvas id="salesPipelineChart"></canvas></div>
      </div>
    </div>

  </div>
</div>

<!-- Compose Message Modal -->
<div class="modal-overlay" id="composeModal">
  <div class="modal-content" style="max-width:650px;">
    <div class="modal-header">
      <div class="modal-title">Compose Message</div>
      <button class="modal-close" onclick="closeComposeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">To *</label>
        <select class="form-select" id="msgRecipient"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Subject *</label>
        <input type="text" class="form-input" id="msgSubject" placeholder="Message subject">
      </div>
      <div class="form-group">
        <label class="form-label">Message *</label>
        <textarea class="form-textarea" id="msgBody" placeholder="Write your message..." style="min-height:150px;"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Attachments</label>
        <div class="file-upload-area" id="msgFileUploadArea" onclick="document.getElementById('msgFileInput').click()">
          <div class="file-upload-icon">ðŸ“Ž</div>
          <div class="file-upload-text">Click or drag files here to upload</div>
          <div class="file-upload-hint">Images, PDFs, Documents (Max 10MB each)</div>
        </div>
        <input type="file" id="msgFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display:none;" onchange="handleFileSelect(event)">
        <div class="file-list" id="msgFileList"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeComposeModal()">Cancel</button>
      <button class="btn-primary" onclick="sendMessage()">Send Message</button>
    </div>
  </div>
</div>

<!-- View Message Modal -->
<div class="modal-overlay" id="viewMessageModal">
  <div class="modal-content" style="max-width:650px;">
    <div class="modal-header">
      <div class="modal-title" id="viewMsgSubject">Message</div>
      <button class="modal-close" onclick="closeViewMessageModal()">&times;</button>
    </div>
    <div class="modal-body" id="viewMsgBody"></div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeViewMessageModal()">Close</button>
      <button class="btn-primary" onclick="replyToMessage()">Reply</button>
    </div>
  </div>
</div>

<!-- Task Modal (New/Edit) -->
<div class="modal-overlay" id="taskModal">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <div class="modal-title" id="taskModalTitle">New Task</div>
      <button class="modal-close" onclick="closeTaskModal()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Status Pipeline (edit mode only) -->
      <div class="form-group" id="taskStatusPipelineGroup" style="display:none;">
        <label class="form-label">Status</label>
        <div class="status-pipeline" id="taskStatusPipeline">
          <div class="status-step" data-status="open" onclick="setTaskStatus('open')">Open</div>
          <div class="status-step" data-status="in_progress" onclick="setTaskStatus('in_progress')">In Progress</div>
          <div class="status-step" data-status="review" onclick="setTaskStatus('review')">Review</div>
          <div class="status-step" data-status="completed" onclick="setTaskStatus('completed')">Completed</div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Task Title *</label>
        <input type="text" class="form-input" id="taskTitle" placeholder="Enter task title">
      </div>
      
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea>
      </div>
      
      <div class="form-group autocomplete-container">
        <label class="form-label">Organization</label>
        <input type="text" class="form-input" id="taskOrganization" placeholder="Search or enter organization..." autocomplete="off" oninput="searchOrganizations(this.value)">
        <div class="autocomplete-results" id="orgAutocompleteResults"></div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-select" id="taskPriority">
            <option value="low">Low</option>
            <option value="normal" selected>Normal</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" class="form-input" id="taskDueDate">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Assign To</label>
        <select class="form-select" id="taskAssignee"><option value="">-- Select Employee --</option></select>
      </div>
      
      <div class="form-group" id="taskNotesGroup" style="display:none;">
        <label class="form-label">Notes / Updates</label>
        <textarea class="form-textarea" id="taskNotes" placeholder="Add notes or updates..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="taskDeleteBtn" onclick="deleteTask()" style="display:none; margin-right:auto;">Delete</button>
      <button class="btn-secondary" onclick="closeTaskModal()">Cancel</button>
      <button class="btn-primary" id="taskSaveBtn" onclick="saveTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- Employee View Modal -->
<div class="modal-overlay" id="employeeViewModal">
  <div class="modal-content" style="max-width: 550px;">
    <div class="modal-header">
      <div class="modal-title" id="empViewModalTitle">Employee Details</div>
      <button class="modal-close" onclick="closeEmployeeViewModal()">&times;</button>
    </div>
    <div class="modal-body" id="empViewModalBody" style="max-height: 75vh; overflow-y: auto;"></div>
  </div>
</div>

<!-- New Employee Modal -->
<div class="modal-overlay" id="newEmployeeModal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <div class="modal-title">Add New Employee</div>
      <button class="modal-close" onclick="closeNewEmployeeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name *</label><input type="text" class="form-input" id="newEmpFirstName" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name *</label><input type="text" class="form-input" id="newEmpLastName" placeholder="Last name"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="newEmpEmail" placeholder="email@example.com"></div>
        <div class="form-group"><label class="form-label">Phone *</label><input type="tel" class="form-input" id="newEmpPhone" placeholder="(555) 123-4567"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Department</label>
          <select class="form-select" id="newEmpDepartment">
            <option value="">-- Select --</option>
            <option value="service">Service</option>
            <option value="parts">Parts</option>
            <option value="sales">Sales</option>
            <option value="admin">Admin</option>
            <option value="management">Management</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" id="newEmpRole">
            <option value="">-- Select --</option>
            <option value="technician">Technician</option>
            <option value="service_advisor">Service Advisor</option>
            <option value="parts_counter">Parts Counter</option>
            <option value="sales_consultant">Sales Consultant</option>
            <option value="manager">Manager</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Hire Date</label><input type="date" class="form-input" id="newEmpHireDate"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewEmployeeModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewEmployee()">Add Employee</button>
    </div>
  </div>
</div>

<!-- Fixed Filter Bar (Mobile) -->
<div class="filter-bar-fixed" id="filterBarFixed">
  <div class="filter-bar-row">
    <select id="rangeSelectMobile" class="range-select" onchange="rangeChangedMobile()">
      <option value="today">Today</option>
      <option value="week">1 Week</option>
      <option value="30days" selected>30 Days</option>
      <option value="60days">60 Days</option>
      <option value="90days">90 Days</option>
      <option value="ytd">Year to Date</option>
    </select>
    <button class="direction-btn active" id="pastBtnMobile" onclick="setDirectionMobile('past')">Past</button>
    <button class="direction-btn" id="futureBtnMobile" onclick="setDirectionMobile('future')">Future</button>
  </div>
  <div class="date-display" id="dateRangeDisplayMobile">30 Days (Past)</div>
</div>

<!-- Mobile Bottom Navigation - DYNAMIC -->
<div class="mobile-bottom-nav">
  <div id="mobile-nav-top" class="mobile-nav-top">
    <!-- Dynamically populated by nav-loader.js -->
    <a href="dashboard-business.html" class="mobile-nav-btn active">Business</a>
    <a href="#" class="mobile-nav-btn">Loading...</a>
  </div>
  <div id="mobile-nav-secondary" class="mobile-nav-secondary">
    <!-- Dynamically populated by nav-loader.js -->
  </div>
</div>

<script>
// ============================================================================
// NAV LOADER - Dynamic Navigation Based on UI Presets + Role Permissions
// ============================================================================

const BUTTON_CONFIG = {
  'Business': { url: 'dashboard-business.html', label: 'Business' },
  'Customers': { url: 'dashboard-customer-search.html', label: 'Customers' },
  'Vehicles': { url: 'dashboard-vehicle-search.html', label: 'Vehicles' },
  'Clients': { url: 'dashboard-clients.html', label: 'Clients' },
  'Cases': { url: 'dashboard-cases.html', label: 'Cases' },
  'Units': { url: 'dashboard-units.html', label: 'Units' },
  'Boats': { url: 'dashboard-boats.html', label: 'Boats' },
  'Settings': { url: 'dashboard-settings.html', label: 'Settings' },
  'Search': { url: 'dashboard-search.html', label: 'Search' },
  'Service': { url: 'dashboard-service.html', label: 'Service', class: 'related' },
  'Parts': { url: 'dashboard-parts.html', label: 'Parts', class: 'related' },
  'Sales': { url: 'dashboard-sales.html', label: 'Sales', class: 'related' },
  'Fleet': { url: 'dashboard-fleet.html', label: 'Fleet', class: 'related' },
  'Rentals': { url: 'dashboard-rentals.html', label: 'Rentals', class: 'related' },
  'Scheduler': { url: 'dashboard-scheduler.html', label: 'Scheduler', class: 'related' },
  'Calendar': { url: 'dashboard-calendar.html', label: 'Calendar', class: 'related' },
  'Routes': { url: 'dashboard-routes.html', label: 'Routes', class: 'related' },
  'Leads': { url: 'dashboard-leads.html', label: 'Leads', class: 'related' },
  'Tasks': { url: 'dashboard-tasks.html', label: 'Tasks', class: 'related' },
  'Documents': { url: 'dashboard-documents.html', label: 'Documents', class: 'related' },
  'Billing': { url: 'dashboard-billing.html', label: 'Billing', class: 'related' },
  'Storage': { url: 'dashboard-storage.html', label: 'Storage', class: 'related' },
  'Inbox': { url: 'dashboard-inbox.html', label: 'Inbox', class: 'related' }
};

const DEFAULT_NAV_BUTTONS = ['Business', 'Customers', 'Vehicles', 'Settings'];
const DEFAULT_ACTION_BUTTONS = ['Service', 'Parts', 'Sales'];

async function getVisibleButtons(supabase, tenantId, userRole) {
  try {
    // Try database function first
    const { data: fnResult, error: fnError } = await supabase.rpc('get_visible_buttons', { p_tenant_id: tenantId, p_user_role: userRole });
    if (!fnError && fnResult) {
      return { nav_buttons: fnResult.nav_buttons || DEFAULT_NAV_BUTTONS, action_buttons: fnResult.action_buttons || DEFAULT_ACTION_BUTTONS };
    }
    
    // Fallback: manual query
    const { data: tenant } = await supabase.from('tenants').select('ui_preset_id').eq('tenant_id', tenantId).single();
    let presetButtons = { nav_buttons: DEFAULT_NAV_BUTTONS, action_buttons: DEFAULT_ACTION_BUTTONS };
    
    if (tenant?.ui_preset_id) {
      const { data: preset } = await supabase.from('ui_presets').select('nav_buttons, action_buttons').eq('id', tenant.ui_preset_id).single();
      if (preset) presetButtons = { nav_buttons: preset.nav_buttons || DEFAULT_NAV_BUTTONS, action_buttons: preset.action_buttons || DEFAULT_ACTION_BUTTONS };
    }
    
    if (userRole === 'owner') return presetButtons;
    
    const { data: rolePerms } = await supabase.from('role_permissions').select('allowed_buttons').eq('role', userRole).single();
    const allowedButtons = rolePerms?.allowed_buttons || [];
    
    return {
      nav_buttons: presetButtons.nav_buttons.filter(btn => allowedButtons.includes(btn)),
      action_buttons: presetButtons.action_buttons.filter(btn => allowedButtons.includes(btn))
    };
  } catch (error) {
    console.log('Using default buttons:', error.message);
    return { nav_buttons: DEFAULT_NAV_BUTTONS, action_buttons: DEFAULT_ACTION_BUTTONS };
  }
}

function renderDesktopNav(navButtons, actionButtons, currentPage) {
  const navContainer = document.getElementById('desktop-nav-buttons');
  const actionContainer = document.getElementById('desktop-action-buttons');
  
  if (navContainer) {
    navContainer.innerHTML = navButtons.map(btnName => {
      const btn = BUTTON_CONFIG[btnName];
      if (!btn) return '';
      const isActive = currentPage === btnName.toLowerCase();
      const activeStyle = isActive ? 'color:var(--accent-primary); border-bottom:2px solid var(--accent-primary);' : 'color:var(--text-secondary);';
      return `<a href="${btn.url}" style="padding:12px 0; text-decoration:none; font-size:14px; ${activeStyle}">${btn.label}</a>`;
    }).join('');
  }
  
  if (actionContainer) {
    actionContainer.innerHTML = actionButtons.map(btnName => {
      const btn = BUTTON_CONFIG[btnName];
      if (!btn) return '';
      return `<button onclick="location.href='${btn.url}'" class="desktop-dept-btn">${btn.label}</button>`;
    }).join('');
  }
}

function renderMobileNav(navButtons, actionButtons, currentPage) {
  const topContainer = document.getElementById('mobile-nav-top');
  const secondaryContainer = document.getElementById('mobile-nav-secondary');
  
  const topButtons = navButtons.slice(0, 2);
  const bottomButtons = actionButtons.slice(0, 3);
  
  if (topContainer) {
    topContainer.innerHTML = topButtons.map(btnName => {
      const btn = BUTTON_CONFIG[btnName];
      if (!btn) return '';
      const isActive = currentPage === btnName.toLowerCase();
      return `<a href="${btn.url}" class="mobile-nav-btn ${isActive ? 'active' : ''}">${btn.label}</a>`;
    }).join('');
  }
  
  if (secondaryContainer) {
    secondaryContainer.innerHTML = bottomButtons.map(btnName => {
      const btn = BUTTON_CONFIG[btnName];
      if (!btn) return '';
      return `<a href="${btn.url}" class="mobile-nav-btn ${btn.class || ''}">${btn.label}</a>`;
    }).join('');
  }
}

async function initNavigation(supabase, tenantId, userRole, currentPage = '') {
  const buttons = await getVisibleButtons(supabase, tenantId, userRole);
  window.visibleButtons = buttons;
  renderDesktopNav(buttons.nav_buttons, buttons.action_buttons, currentPage);
  renderMobileNav(buttons.nav_buttons, buttons.action_buttons, currentPage);
  console.log('Navigation loaded:', buttons);
  return buttons;
}

function canSeeButton(buttonName) {
  if (!window.visibleButtons) return false;
  const allButtons = [...(window.visibleButtons.nav_buttons || []), ...(window.visibleButtons.action_buttons || [])];
  return allButtons.includes(buttonName);
}
</script>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentRange = '30days', currentDirection = 'past';
let startDate = new Date(), endDate = new Date();
let charts = {}, currentUserId = null, currentTenantId = null;
let currentInboxTab = 'inbox', currentTasksTab = 'open', currentTasksView = 'list';
let allNotifications = [], allMessages = [], allConversations = [], allTasks = [], allEmployeesData = [];
let inboxSearchQuery = '';
let timeClockData = [], scheduleData = [], allOrganizations = [];
let currentUserRole = null, isOwner = false;
let editingTaskId = null, selectedFiles = [], viewingMessageId = null, viewingConversationId = null;
let currentTaskStatus = 'open';
let currentEmployeeId = null; // The employee_id of the logged-in user

// Theme system
var themes = ['dark-blue', 'grey', 'slate', 'midnight', 'light-blue'];
var themeIndex = 0;

function loadTheme() { var savedTheme = localStorage.getItem('app-theme') || 'dark-blue'; document.documentElement.setAttribute('data-theme', savedTheme); themeIndex = themes.indexOf(savedTheme); if (themeIndex < 0) themeIndex = 0; }
function cycleTheme() { themeIndex = (themeIndex + 1) % themes.length; var newTheme = themes[themeIndex]; document.documentElement.setAttribute('data-theme', newTheme); localStorage.setItem('app-theme', newTheme); showThemeToast('Theme: ' + newTheme.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())); }
function showThemeToast(msg) { var toast = document.getElementById('themeToast'); if (!toast) { toast = document.createElement('div'); toast.id = 'themeToast'; toast.className = 'theme-toast'; document.body.appendChild(toast); } toast.textContent = msg; toast.classList.add('show'); setTimeout(function() { toast.classList.remove('show'); }, 2000); }
loadTheme();

function toggleMobileMenu(button) { document.getElementById('mobileHeaderContent').classList.toggle('expanded'); button.classList.toggle('active'); }
async function logout() { await sb.auth.signOut(); localStorage.removeItem("sb_access_token"); localStorage.removeItem("sb_refresh_token"); location.replace("login.html?logout=1"); }

function toggleSection(sectionId) { const content = document.getElementById(sectionId + 'Content'); const header = event.currentTarget; const wasCollapsed = content.classList.contains('collapsed'); content.classList.toggle('collapsed'); header.classList.toggle('collapsed'); content.style.maxHeight = content.classList.contains('collapsed') ? '0px' : content.scrollHeight + 'px'; if (wasCollapsed) setTimeout(() => header.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50); }
function toggleSummarySection(event) { const content = document.getElementById('summaryContent'); const header = document.getElementById('summaryHeader'); const filterBar = document.getElementById('filterBarFixed'); const wasCollapsed = content.classList.contains('collapsed'); content.classList.toggle('collapsed'); header.classList.toggle('collapsed'); content.style.maxHeight = content.classList.contains('collapsed') ? '0px' : content.scrollHeight + 'px'; if (wasCollapsed) { filterBar.classList.add('visible'); document.body.classList.add('filter-bar-open'); setTimeout(() => header.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50); } else { filterBar.classList.remove('visible'); document.body.classList.remove('filter-bar-open'); } }
function toggleDeptCard(event, deptId) { event.stopPropagation(); event.currentTarget.classList.toggle('collapsed'); setTimeout(() => document.getElementById('summaryContent').style.maxHeight = document.getElementById('summaryContent').scrollHeight + 'px', 50); }

// ========== MESSAGING SYSTEM (PRIVATE - only sender/receiver can see) ==========
// conversations: conversation_id, tenant_id, conversation_type, title, created_by, etc.
// messages: message_id, tenant_id, conversation_id (FK), sender_id, content, attachments, created_at
// message_read_receipts: receipt_id, message_id, employee_id, read_at

async function loadInboxData() {
  try {
    if (!currentTenantId) return;
    
    // Load notifications for current user only
    const { data: notifications } = await sb.from('notifications')
      .select('*')
      .eq('tenant_id', currentTenantId)
      .eq('recipient_id', currentUserId)
      .order('created_at', { ascending: false })
      .limit(50);
    allNotifications = notifications || [];
    
    // Load conversations created by current user
    const { data: myConversations } = await sb.from('conversations')
      .select('*')
      .eq('tenant_id', currentTenantId)
      .eq('created_by', currentUserId)
      .order('last_message_at', { ascending: false, nullsFirst: false })
      .limit(50);
    
    // Load all messages to find ones where user is mentioned (recipient)
    const { data: allMsgs } = await sb.from('messages')
      .select('*')
      .eq('tenant_id', currentTenantId)
      .order('created_at', { ascending: false })
      .limit(200);
    
    // Filter messages: only show where current user is sender OR mentioned as recipient
    const myMessages = (allMsgs || []).filter(msg => {
      // User sent this message
      if (msg.sender_id === currentUserId) return true;
      
      // User is mentioned (recipient) - check mentions array
      if (msg.mentions && Array.isArray(msg.mentions)) {
        const isMentioned = msg.mentions.some(m => 
          m.employee_id === currentEmployeeId || 
          m.user_id === currentUserId
        );
        if (isMentioned) return true;
      }
      
      return false;
    });
    
    allMessages = myMessages;
    
    // Get unique conversation IDs from filtered messages
    const myConvIds = new Set(myMessages.map(m => m.conversation_id));
    
    // Load conversations for these messages
    const { data: convData } = await sb.from('conversations')
      .select('*')
      .eq('tenant_id', currentTenantId)
      .in('conversation_id', Array.from(myConvIds));
    
    allConversations = convData || [];
    
    // Load read receipts for current employee to determine read status
    if (currentEmployeeId && allMessages.length > 0) {
      const messageIds = allMessages.map(m => m.message_id);
      const { data: readReceipts } = await sb.from('message_read_receipts')
        .select('message_id, read_at')
        .eq('employee_id', currentEmployeeId)
        .in('message_id', messageIds);
      const readMap = new Map((readReceipts || []).map(r => [r.message_id, r.read_at]));
      allMessages = allMessages.map(m => ({ ...m, is_read: readMap.has(m.message_id) }));
    }
    
    // Attach conversation title to messages
    const convMap = new Map(allConversations.map(c => [c.conversation_id, c]));
    allMessages = allMessages.map(m => ({
      ...m,
      conversation_title: convMap.get(m.conversation_id)?.title || 'No Subject'
    }));
    
    // Load WO notes requiring review (only if user has appropriate role)
    if (currentUserRole === 'owner' || currentUserRole === 'manager') {
      const { data: woNotes } = await sb.from('work_order_notes')
        .select('*')
        .eq('tenant_id', currentTenantId)
        .eq('requires_manager_review', true)
        .order('created_at', { ascending: false })
        .limit(20);
      if (woNotes && woNotes.length > 0) {
        const noteItems = woNotes.map(note => ({
          notification_id: 'note_' + note.note_id,
          notification_type: 'wo_note',
          title: 'WO Note - Review Required',
          body: note.content,
          priority: 'high',
          is_read: false,
          created_at: note.created_at,
          source_type: 'work_order_note',
          source_id: note.work_order_id
        }));
        allNotifications = [...noteItems, ...allNotifications];
      }
    }
    
    renderInbox();
    updateInboxBadge();
  } catch (error) { console.error('Error loading inbox:', error); }
}

function renderInbox() {
  const container = document.getElementById('inboxList');
  let items = [];
  
  // Combine messages and notifications based on tab
  if (currentInboxTab === 'inbox') {
    // Inbox = unread messages only (like email inbox)
    const msgItems = allMessages.filter(m => !m.is_read).map(m => ({ ...m, itemType: 'message' }));
    items = msgItems.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  } else if (currentInboxTab === 'all') {
    // All Mail = all messages, read ones dimmed
    const msgItems = allMessages.map(m => ({ ...m, itemType: 'message' }));
    items = msgItems.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  } else if (currentInboxTab === 'notifications') {
    // Alerts = system notifications and WO notes
    items = allNotifications.map(n => ({ ...n, itemType: 'notification' }));
  }
  
  // Apply search filter
  if (inboxSearchQuery.length >= 2) {
    const query = inboxSearchQuery.toLowerCase();
    items = items.filter(item => {
      if (item.itemType === 'message') {
        const sender = allEmployeesData.find(e => e.employee_id === item.sender_id || e.user_id === item.sender_id);
        const senderName = sender ? `${sender.first_name} ${sender.last_name}`.toLowerCase() : '';
        return (item.conversation_title || '').toLowerCase().includes(query) ||
               (item.content || '').toLowerCase().includes(query) ||
               senderName.includes(query);
      } else {
        return (item.title || '').toLowerCase().includes(query) ||
               (item.body || '').toLowerCase().includes(query);
      }
    });
  }
  
  if (items.length === 0) {
    const emptyMsg = currentInboxTab === 'inbox' ? 'No unread messages' : 
                     currentInboxTab === 'all' ? 'No messages' : 'No notifications';
    container.innerHTML = `<div class="inbox-empty"><div class="inbox-empty-icon">ðŸ“­</div><div>${inboxSearchQuery ? 'No results found' : emptyMsg}</div></div>`;
    return;
  }
  
  container.innerHTML = items.map(item => {
    if (item.itemType === 'message') {
      // Determine sender
      const sender = allEmployeesData.find(e => e.employee_id === item.sender_id || e.user_id === item.sender_id);
      const senderName = sender ? `${sender.first_name} ${sender.last_name}` : 'Unknown';
      const isSentByMe = item.sender_id === currentUserId;
      
      // Determine recipient from mentions
      let recipientName = 'Unknown';
      if (item.mentions && Array.isArray(item.mentions) && item.mentions.length > 0) {
        const recipientId = item.mentions[0].employee_id;
        const recipient = allEmployeesData.find(e => e.employee_id === recipientId);
        recipientName = recipient ? `${recipient.first_name} ${recipient.last_name}` : 'Unknown';
      }
      
      const hasAttachments = item.attachments && (Array.isArray(item.attachments) ? item.attachments.length > 0 : Object.keys(item.attachments).length > 0);
      const timeAgo = formatTimeAgo(item.created_at);
      const readClass = item.is_read ? 'read' : 'unread';
      
      // Show different labels based on whether user sent or received
      const directionLabel = isSentByMe 
        ? `<span style="color:#10b981;">To: ${recipientName}</span>` 
        : `<span style="color:var(--accent-light);">From: ${senderName}</span>`;
      
      const icon = isSentByMe ? 'ðŸ“¤' : 'ðŸ“¥';
      
      return `<div class="inbox-item ${readClass}" onclick="openViewMessage('${item.message_id}', '${item.conversation_id}')">
        <div class="inbox-item-icon">${icon}</div>
        <div class="inbox-item-content">
          <div class="inbox-item-from">${directionLabel}</div>
          <div class="inbox-item-header">
            <div class="inbox-item-title">${item.conversation_title}</div>
            <div class="inbox-item-time">${timeAgo}</div>
          </div>
          <div class="inbox-item-body">${item.content || ''}</div>
          ${hasAttachments ? `<div class="inbox-item-attachments"><span class="inbox-attachment-badge">ðŸ“Ž Attachments</span></div>` : ''}
        </div>
      </div>`;
    } else {
      const icon = item.notification_type === 'wo_note' ? 'ðŸ“‹' : 'ðŸ””';
      const readClass = item.is_read ? 'read' : 'unread';
      return `<div class="inbox-item ${readClass}" onclick="handleInboxClick('${item.notification_id}', '${item.source_type || ''}', '${item.source_id || ''}')">
        <div class="inbox-item-icon">${icon}</div>
        <div class="inbox-item-content">
          <div class="inbox-item-header">
            <div class="inbox-item-title">${item.title || 'Notification'}</div>
            <div class="inbox-item-time">${formatTimeAgo(item.created_at)}</div>
          </div>
          <div class="inbox-item-body">${item.body || ''}</div>
          ${item.priority === 'high' || item.priority === 'urgent' ? `<span class="inbox-item-tag">${item.priority}</span>` : ''}
        </div>
      </div>`;
    }
  }).join('');
  
  // Update count display
  const countEl = document.getElementById('inboxCount');
  if (countEl) {
    const unreadCount = allMessages.filter(m => !m.is_read).length;
    const totalCount = allMessages.length;
    countEl.textContent = `${unreadCount} unread of ${totalCount} messages`;
  }
}

function searchInbox(query) {
  inboxSearchQuery = query.trim();
  renderInbox();
}

function switchInboxTab(tab, btn) { 
  currentInboxTab = tab; 
  inboxSearchQuery = '';
  const searchInput = document.getElementById('inboxSearch');
  if (searchInput) searchInput.value = '';
  document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active')); 
  btn.classList.add('active'); 
  renderInbox(); 
}
async function handleInboxClick(id, sourceType, sourceId) { if (!id.startsWith('note_')) await sb.from('notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('notification_id', id); if (sourceType === 'work_order_note' || sourceType === 'work_order') window.location.href = `work-order-edit.html?id=${sourceId}`; loadInboxData(); }

async function markAllNotificationsRead() { 
  // Mark notifications as read
  await sb.from('notifications').update({ is_read: true, read_at: new Date().toISOString() })
    .eq('is_read', false)
    .eq('tenant_id', currentTenantId)
    .or(`recipient_id.eq.${currentUserId},recipient_id.is.null`);
  
  // Mark messages as read via read receipts (uses employee_id, not user_id)
  if (currentEmployeeId && allMessages.length > 0) {
    const unreadMessages = allMessages.filter(m => !m.is_read);
    for (const msg of unreadMessages) {
      await sb.from('message_read_receipts').upsert({
        message_id: msg.message_id,
        employee_id: currentEmployeeId,
        read_at: new Date().toISOString()
      }, { onConflict: 'message_id,employee_id' });
      msg.is_read = true; // Update local state
    }
  }
  
  // Mark local notifications as read
  allNotifications.forEach(n => n.is_read = true);
  
  updateInboxBadge();
  renderInbox();
}

function updateInboxBadge() { 
  const unreadMsgs = allMessages.filter(m => !m.is_read).length;
  const unreadNotifs = allNotifications.filter(n => !n.is_read).length;
  const badge = document.getElementById('messagesBadge'); 
  if (unreadMsgs > 0) { 
    badge.textContent = unreadMsgs > 99 ? '99+' : unreadMsgs; 
    badge.style.display = 'inline-block'; 
    badge.classList.remove('warning');
  } else if (unreadNotifs > 0) {
    badge.textContent = unreadNotifs > 99 ? '99+' : unreadNotifs; 
    badge.style.display = 'inline-block'; 
    badge.classList.add('warning');
  } else { 
    badge.style.display = 'none'; 
  } 
}

// Compose Message - FIXED: Creates conversation first, then message
function openComposeModal() {
  selectedFiles = [];
  document.getElementById('msgSubject').value = '';
  document.getElementById('msgBody').value = '';
  document.getElementById('msgFileList').innerHTML = '';
  
  // Populate recipients dropdown using employee_id
  const select = document.getElementById('msgRecipient');
  select.innerHTML = '<option value="">-- Select Recipient --</option>' + 
    allEmployeesData.map(e => 
      `<option value="${e.employee_id}">${e.first_name} ${e.last_name} (${e.role || 'Staff'})</option>`
    ).join('');
  
  document.getElementById('composeModal').classList.add('active');
}

function closeComposeModal() { document.getElementById('composeModal').classList.remove('active'); }

function handleFileSelect(event) {
  const files = Array.from(event.target.files);
  files.forEach(file => {
    if (file.size > 10 * 1024 * 1024) { alert(`File "${file.name}" is too large. Max 10MB.`); return; }
    selectedFiles.push(file);
  });
  renderFileList();
}

function renderFileList() {
  const container = document.getElementById('msgFileList');
  if (selectedFiles.length === 0) { container.innerHTML = ''; return; }
  container.innerHTML = selectedFiles.map((file, idx) => {
    const icon = file.type.startsWith('image/') ? 'ðŸ–¼ï¸' : 'ðŸ“„';
    const size = (file.size / 1024).toFixed(1) + ' KB';
    return `<div class="file-item"><span class="file-item-icon">${icon}</span><span class="file-item-name">${file.name}</span><span class="file-item-size">${size}</span><button class="file-item-remove" onclick="removeFile(${idx})">&times;</button></div>`;
  }).join('');
}

function removeFile(idx) { selectedFiles.splice(idx, 1); renderFileList(); }

async function sendMessage() {
  const recipientEmployeeId = document.getElementById('msgRecipient').value;
  const subject = document.getElementById('msgSubject').value.trim();
  const content = document.getElementById('msgBody').value.trim();
  
  if (!recipientEmployeeId) { alert('Please select a recipient'); return; }
  if (!subject) { alert('Please enter a subject'); return; }
  if (!content) { alert('Please enter a message'); return; }
  
  try {
    // Upload attachments if any
    let attachments = [];
    for (const file of selectedFiles) {
      const fileName = `${Date.now()}_${file.name}`;
      const { data, error } = await sb.storage.from('message-attachments').upload(`${currentTenantId}/${fileName}`, file);
      if (!error) {
        const { data: urlData } = sb.storage.from('message-attachments').getPublicUrl(`${currentTenantId}/${fileName}`);
        attachments.push({ name: file.name, url: urlData.publicUrl, type: file.type, size: file.size });
      }
    }
    
    const now = new Date().toISOString();
    
    // STEP 1: Create conversation first (required by FK constraint)
    const conversationId = crypto.randomUUID();
    const conversation = {
      conversation_id: conversationId,
      tenant_id: currentTenantId,
      conversation_type: 'direct',
      title: subject,
      description: content.substring(0, 200),
      created_by: currentUserId,
      message_count: 1,
      last_message_at: now,
      last_message_preview: content.substring(0, 100),
      last_message_sender_id: currentUserId,
      created_at: now,
      updated_at: now
    };
    
    const { error: convError } = await sb.from('conversations').insert(conversation);
    if (convError) throw convError;
    
    // STEP 2: Create message referencing the conversation
    const messageId = crypto.randomUUID();
    const message = {
      message_id: messageId,
      tenant_id: currentTenantId,
      conversation_id: conversationId,
      sender_id: currentUserId,
      sender_type: 'employee',
      message_type: 'text',
      content: content,
      attachments: attachments.length > 0 ? attachments : [],
      mentions: [{ employee_id: recipientEmployeeId }],
      created_at: now,
      updated_at: now
    };
    
    const { error: msgError } = await sb.from('messages').insert(message);
    if (msgError) throw msgError;
    
    // STEP 3: Create notification for recipient
    const recipientEmp = allEmployeesData.find(e => e.employee_id === recipientEmployeeId);
    const recipientUserId = recipientEmp?.user_id;
    
    if (recipientUserId) {
      const notification = {
        tenant_id: currentTenantId,
        recipient_id: recipientUserId,
        sender_id: currentUserId,
        notification_type: 'message',
        title: `New Message: ${subject}`,
        body: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
        source_type: 'message',
        source_id: messageId,
        priority: 'normal',
        is_read: false,
        delivered_in_app: true,
        created_at: now
      };
      await sb.from('notifications').insert(notification);
    }
    
    closeComposeModal();
    loadInboxData();
    alert('Message sent!');
  } catch (err) { console.error('Error sending message:', err); alert('Error: ' + err.message); }
}

async function openViewMessage(messageId, conversationId) {
  viewingMessageId = messageId;
  viewingConversationId = conversationId;
  const message = allMessages.find(m => m.message_id === messageId);
  if (!message) return;
  
  // Mark as read by inserting/updating read receipt (uses employee_id)
  if (!message.is_read && currentEmployeeId) {
    await sb.from('message_read_receipts').upsert({
      message_id: messageId,
      employee_id: currentEmployeeId,
      read_at: new Date().toISOString()
    }, { onConflict: 'message_id,employee_id' });
    message.is_read = true;
    updateInboxBadge();
    renderInbox(); // Re-render to update read status / remove from inbox view
  }
  
  // Get sender info
  const sender = allEmployeesData.find(e => e.employee_id === message.sender_id || e.user_id === message.sender_id);
  const senderName = sender ? `${sender.first_name} ${sender.last_name}` : 'Unknown';
  
  // Get recipient info from mentions
  let recipientName = 'Unknown';
  if (message.mentions && Array.isArray(message.mentions) && message.mentions.length > 0) {
    const recipientId = message.mentions[0].employee_id;
    const recipient = allEmployeesData.find(e => e.employee_id === recipientId);
    recipientName = recipient ? `${recipient.first_name} ${recipient.last_name}` : 'Unknown';
  }
  
  const isSentByMe = message.sender_id === currentUserId;
  
  let attachmentsHtml = '';
  if (message.attachments && (Array.isArray(message.attachments) ? message.attachments.length > 0 : Object.keys(message.attachments).length > 0)) {
    const attachList = Array.isArray(message.attachments) ? message.attachments : Object.values(message.attachments);
    attachmentsHtml = `<div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border-default);">
      <div style="font-size:12px; color:var(--text-secondary); margin-bottom:8px;">Attachments:</div>
      ${attachList.map(a => {
        if (a.type && a.type.startsWith('image/')) return `<img src="${a.url}" class="message-image" onclick="window.open('${a.url}', '_blank')" alt="${a.name}">`;
        return `<a href="${a.url}" target="_blank" class="message-attachment">ðŸ“„ ${a.name}</a>`;
      }).join('')}
    </div>`;
  }
  
  document.getElementById('viewMsgSubject').textContent = message.conversation_title || 'No Subject';
  document.getElementById('viewMsgBody').innerHTML = `
    <div style="margin-bottom:16px; padding:12px; background:var(--bg-card); border-radius:8px;">
      <div style="font-size:13px; color:var(--text-secondary); margin-bottom:4px;">
        From: <span style="color:var(--accent-light); font-weight:500;">${senderName}</span>
        ${isSentByMe ? '<span style="color:#10b981; font-size:11px; margin-left:8px;">(You)</span>' : ''}
      </div>
      <div style="font-size:13px; color:var(--text-secondary); margin-bottom:4px;">
        To: <span style="color:var(--accent-light); font-weight:500;">${recipientName}</span>
        ${!isSentByMe ? '<span style="color:#10b981; font-size:11px; margin-left:8px;">(You)</span>' : ''}
      </div>
      <div style="font-size:12px; color:var(--text-secondary);">Date: ${new Date(message.created_at).toLocaleString()}</div>
    </div>
    <div style="font-size:14px; color:var(--text-primary); white-space:pre-wrap; line-height:1.6;">${message.content}</div>
    ${attachmentsHtml}
  `;
  document.getElementById('viewMessageModal').classList.add('active');
}

function closeViewMessageModal() { document.getElementById('viewMessageModal').classList.remove('active'); }

function replyToMessage() {
  const message = allMessages.find(m => m.message_id === viewingMessageId);
  const conversation = allConversations.find(c => c.conversation_id === viewingConversationId);
  if (!message) return;
  closeViewMessageModal();
  openComposeModal();
  const title = conversation?.title || message.conversation_title || '';
  document.getElementById('msgSubject').value = title.startsWith('Re: ') ? title : 'Re: ' + title;
  
  // Select the original sender as recipient
  const senderEmp = allEmployeesData.find(e => e.user_id === message.sender_id || e.employee_id === message.sender_id);
  if (senderEmp) {
    document.getElementById('msgRecipient').value = senderEmp.employee_id;
  }
}

// Drag and drop
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.getElementById('msgFileUploadArea');
  if (uploadArea) {
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      Array.from(e.dataTransfer.files).forEach(file => { if (file.size <= 10 * 1024 * 1024) selectedFiles.push(file); });
      renderFileList();
    });
  }
});

// ========== TASKS SYSTEM (FIXED: assigned_to uses user_id) ==========
async function loadTasksData() {
  try {
    if (!currentTenantId) return;
    const { data: tasks } = await sb.from('tasks')
      .select('*')
      .eq('tenant_id', currentTenantId)
      .order('created_at', { ascending: false });
    allTasks = tasks || [];
    
    // Load organizations for autocomplete
    const { data: customers } = await sb.from('customers')
      .select('customer_id, full_name, organization_name')
      .eq('tenant_id', currentTenantId);
    const orgs = new Set();
    (customers || []).forEach(c => { 
      if (c.organization_name) orgs.add(c.organization_name); 
      if (c.full_name) orgs.add(c.full_name); 
    });
    allOrganizations = Array.from(orgs).sort();
    
    renderTasks();
    updateTasksBadge();
  } catch (error) { console.error('Error loading tasks:', error); }
}

function renderTasks() {
  if (currentTasksView === 'kanban') renderTasksKanban();
  else renderTasksList();
}

function renderTasksList() {
  const container = document.getElementById('tasksListContainer');
  const now = new Date();
  let filtered = allTasks;
  
  // Default status is 'open' per DB schema
  if (currentTasksTab === 'open') filtered = allTasks.filter(t => t.status === 'open' || t.status === 'pending' || !t.status);
  else if (currentTasksTab === 'in_progress') filtered = allTasks.filter(t => t.status === 'in_progress');
  else if (currentTasksTab === 'review') filtered = allTasks.filter(t => t.status === 'review');
  else if (currentTasksTab === 'overdue') filtered = allTasks.filter(t => t.status !== 'completed' && t.due_at && new Date(t.due_at) < now);
  else if (currentTasksTab === 'completed') filtered = allTasks.filter(t => t.status === 'completed');
  
  if (filtered.length === 0) {
    container.innerHTML = `<div class="tasks-list"><div class="tasks-empty"><div class="tasks-empty-icon">âœ“</div><div>No tasks</div></div></div>`;
    return;
  }
  
  filtered.sort((a, b) => {
    const priorityOrder = { urgent: 0, high: 1, normal: 2, low: 3 };
    if (a.due_at && b.due_at) return new Date(a.due_at) - new Date(b.due_at);
    if (a.due_at) return -1;
    if (b.due_at) return 1;
    return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
  });
  
  container.innerHTML = `<div class="tasks-list">${filtered.map(task => {
    const isCompleted = task.status === 'completed';
    const isOverdue = task.due_at && new Date(task.due_at) < now && !isCompleted;
    const dueText = task.due_at ? formatDueDate(task.due_at) : '';
    // assigned_to is user_id, find employee by user_id
    const assignee = allEmployeesData.find(e => e.user_id === task.assigned_to);
    const assigneeName = assignee ? `${assignee.first_name} ${assignee.last_name}` : '';
    
    return `<div class="task-item ${isCompleted ? 'completed' : ''}" onclick="openTaskModal('${task.task_id}')">
      <div class="task-checkbox ${isCompleted ? 'completed' : ''}" onclick="event.stopPropagation(); toggleTaskComplete('${task.task_id}', ${!isCompleted})">${isCompleted ? 'âœ“' : ''}</div>
      <div class="task-content">
        <div class="task-title">${task.title}</div>
        ${task.organization ? `<div class="task-org">ðŸ¢ ${task.organization}</div>` : ''}
        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
        <div class="task-meta">
          <span class="task-priority ${task.priority || 'normal'}">${task.priority || 'normal'}</span>
          <span class="task-status-badge ${task.status || 'open'}">${(task.status || 'open').replace('_', ' ')}</span>
          ${dueText ? `<span class="task-meta-item ${isOverdue ? 'overdue' : ''}">ðŸ“… ${dueText}</span>` : ''}
          ${assigneeName ? `<span class="task-meta-item">ðŸ‘¤ ${assigneeName}</span>` : ''}
        </div>
      </div>
    </div>`;
  }).join('')}</div>`;
}

function renderTasksKanban() {
  const container = document.getElementById('tasksListContainer');
  const now = new Date();
  
  const columns = {
    open: allTasks.filter(t => t.status === 'open' || t.status === 'pending' || !t.status),
    in_progress: allTasks.filter(t => t.status === 'in_progress'),
    review: allTasks.filter(t => t.status === 'review'),
    completed: allTasks.filter(t => t.status === 'completed')
  };
  
  container.innerHTML = `<div class="tasks-kanban">
    ${['open', 'in_progress', 'review', 'completed'].map(status => {
      const tasks = columns[status];
      const labels = { open: 'Open', in_progress: 'In Progress', review: 'Review', completed: 'Completed' };
      return `<div class="kanban-column">
        <div class="kanban-column-header"><span>${labels[status]}</span><span class="kanban-count">${tasks.length}</span></div>
        ${tasks.map(task => {
          const isOverdue = task.due_at && new Date(task.due_at) < now && task.status !== 'completed';
          const dueText = task.due_at ? formatDueDate(task.due_at) : '';
          return `<div class="kanban-task priority-${task.priority || 'normal'}" onclick="openTaskModal('${task.task_id}')">
            <div class="kanban-task-title">${task.title}</div>
            ${task.organization ? `<div class="kanban-task-org">ðŸ¢ ${task.organization}</div>` : ''}
            ${dueText ? `<div class="kanban-task-due ${isOverdue ? 'overdue' : ''}">ðŸ“… ${dueText}</div>` : ''}
          </div>`;
        }).join('')}
      </div>`;
    }).join('')}
  </div>`;
}

function setTasksView(view, btn) { currentTasksView = view; document.querySelectorAll('.tasks-view-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderTasks(); }
function switchTasksTab(tab, btn) { currentTasksTab = tab; document.querySelectorAll('.tasks-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); if (currentTasksView === 'list') renderTasksList(); }
async function toggleTaskComplete(taskId, completed) { 
  await sb.from('tasks').update({ 
    status: completed ? 'completed' : 'open', 
    completed_at: completed ? new Date().toISOString() : null 
  }).eq('task_id', taskId); 
  loadTasksData(); 
}
function updateTasksBadge() { 
  const now = new Date(); 
  const overdueCount = allTasks.filter(t => t.status !== 'completed' && t.due_at && new Date(t.due_at) < now).length; 
  const openCount = allTasks.filter(t => t.status !== 'completed').length; 
  const badge = document.getElementById('tasksBadge'); 
  if (overdueCount > 0) { 
    badge.textContent = overdueCount; 
    badge.style.display = 'inline-block'; 
    badge.classList.add('warning'); 
  } else if (openCount > 0) { 
    badge.textContent = openCount > 99 ? '99+' : openCount; 
    badge.style.display = 'inline-block'; 
    badge.classList.remove('warning'); 
  } else { 
    badge.style.display = 'none'; 
  } 
}
function formatDueDate(dateStr) { 
  const date = new Date(dateStr), now = new Date(); 
  const days = Math.ceil((date - now) / (1000 * 60 * 60 * 24)); 
  if (days < 0) return `${Math.abs(days)} days overdue`; 
  if (days === 0) return 'Due today'; 
  if (days === 1) return 'Due tomorrow'; 
  if (days <= 7) return `Due in ${days} days`; 
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); 
}

// Organization autocomplete
let orgSearchTimeout = null;
function searchOrganizations(query) {
  clearTimeout(orgSearchTimeout);
  const results = document.getElementById('orgAutocompleteResults');
  if (query.length < 2) { results.classList.remove('show'); return; }
  orgSearchTimeout = setTimeout(() => {
    const matches = allOrganizations.filter(o => o.toLowerCase().includes(query.toLowerCase())).slice(0, 8);
    if (matches.length === 0) { results.classList.remove('show'); return; }
    results.innerHTML = matches.map(org => `<div class="autocomplete-item" onclick="selectOrganization('${org.replace(/'/g, "\\'")}')""><div class="autocomplete-item-name">${org}</div></div>`).join('');
    results.classList.add('show');
  }, 200);
}

function selectOrganization(org) { document.getElementById('taskOrganization').value = org; document.getElementById('orgAutocompleteResults').classList.remove('show'); }
document.addEventListener('click', (e) => { if (!e.target.closest('.autocomplete-container')) document.querySelectorAll('.autocomplete-results').forEach(r => r.classList.remove('show')); });

// Task Modal - Shows all employees, handles FK constraint
async function openTaskModal(taskId = null) {
  editingTaskId = taskId;
  
  // If no employees loaded yet, try to load them now
  if (allEmployeesData.length === 0) {
    console.log('No employees in memory, reloading...');
    await loadEmployeesData();
  }
  
  console.log('openTaskModal - employees available:', allEmployeesData.length);
  console.log('Employee list:', allEmployeesData.map(e => `${e.first_name} ${e.last_name} (user_id: ${e.user_id})`));
  
  // Build assignee select - show ALL employees
  const assigneeSelect = document.getElementById('taskAssignee');
  
  if (allEmployeesData.length === 0) {
    assigneeSelect.innerHTML = '<option value="">-- No employees found --</option>';
    console.error('Still no employees after reload attempt');
  } else {
    assigneeSelect.innerHTML = '<option value="">-- Unassigned --</option>' + 
      allEmployeesData.map(e => {
        // Prefer user_id if it exists and is valid, otherwise use employee_id
        const hasValidUserId = e.user_id && typeof e.user_id === 'string' && e.user_id.length > 10;
        const valueId = hasValidUserId ? e.user_id : e.employee_id;
        const warningMark = hasValidUserId ? '' : ' âš ï¸';
        return `<option value="${valueId}" data-employee-id="${e.employee_id}" data-user-id="${e.user_id || ''}" data-has-user="${hasValidUserId}">${e.first_name} ${e.last_name}${warningMark}</option>`;
      }).join('');
  }
  
  if (taskId) {
    const task = allTasks.find(t => t.task_id === taskId);
    if (!task) return;
    document.getElementById('taskModalTitle').textContent = 'Edit Task';
    document.getElementById('taskSaveBtn').textContent = 'Save Changes';
    document.getElementById('taskDeleteBtn').style.display = 'block';
    document.getElementById('taskStatusPipelineGroup').style.display = 'block';
    document.getElementById('taskNotesGroup').style.display = 'block';
    
    document.getElementById('taskTitle').value = task.title || '';
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskOrganization').value = task.organization || '';
    document.getElementById('taskPriority').value = task.priority || 'normal';
    document.getElementById('taskDueDate').value = task.due_at ? task.due_at.split('T')[0] : '';
    document.getElementById('taskNotes').value = task.notes || '';
    setTaskStatus(task.status || 'open');
    
    // Try to find and select the assigned employee
    if (task.assigned_to) {
      let found = false;
      for (let opt of assigneeSelect.options) {
        if (opt.dataset.userId === task.assigned_to || opt.value === task.assigned_to) {
          opt.selected = true;
          found = true;
          break;
        }
      }
      if (!found) {
        for (let opt of assigneeSelect.options) {
          if (opt.dataset.employeeId === task.assigned_to) {
            opt.selected = true;
            break;
          }
        }
      }
    }
  } else {
    document.getElementById('taskModalTitle').textContent = 'New Task';
    document.getElementById('taskSaveBtn').textContent = 'Create Task';
    document.getElementById('taskDeleteBtn').style.display = 'none';
    document.getElementById('taskStatusPipelineGroup').style.display = 'none';
    document.getElementById('taskNotesGroup').style.display = 'none';
    
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskOrganization').value = '';
    document.getElementById('taskPriority').value = 'normal';
    document.getElementById('taskNotes').value = '';
    assigneeSelect.value = '';
    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('taskDueDate').value = tomorrow.toISOString().split('T')[0];
    currentTaskStatus = 'open';
  }
  
  document.getElementById('taskModal').classList.add('active');
}

function closeTaskModal() { document.getElementById('taskModal').classList.remove('active'); }

function setTaskStatus(status) {
  currentTaskStatus = status;
  document.querySelectorAll('.status-step').forEach(step => {
    step.classList.remove('active', 'completed');
    const statusOrder = ['open', 'in_progress', 'review', 'completed'];
    const currentIdx = statusOrder.indexOf(status);
    const stepIdx = statusOrder.indexOf(step.dataset.status);
    if (step.dataset.status === status) step.classList.add('active');
    else if (stepIdx < currentIdx) step.classList.add('completed');
  });
}

async function saveTask() {
  const title = document.getElementById('taskTitle').value.trim();
  if (!title) { alert('Please enter a task title'); return; }
  
  const assigneeSelect = document.getElementById('taskAssignee');
  const selectedOption = assigneeSelect.options[assigneeSelect.selectedIndex];
  
  // Check if selected employee has a valid user_id (required by FK constraint)
  let assignedToUserId = null;
  if (selectedOption && selectedOption.value) {
    const hasValidUser = selectedOption.dataset.hasUser === 'true';
    if (hasValidUser) {
      assignedToUserId = selectedOption.dataset.userId || selectedOption.value;
    } else {
      // Employee doesn't have a linked user account - can't assign due to FK constraint
      const confirmUnassigned = confirm(
        'This employee does not have a linked user account and cannot be assigned tasks.\n\n' +
        'Would you like to save the task as unassigned?'
      );
      if (!confirmUnassigned) return;
      assignedToUserId = null;
    }
  }
  
  const taskData = {
    tenant_id: currentTenantId,
    title,
    description: document.getElementById('taskDescription').value.trim() || null,
    organization: document.getElementById('taskOrganization').value.trim() || null,
    priority: document.getElementById('taskPriority').value,
    status: editingTaskId ? currentTaskStatus : 'open', // Default status is 'open'
    due_at: document.getElementById('taskDueDate').value ? new Date(document.getElementById('taskDueDate').value).toISOString() : null,
    assigned_to: assignedToUserId, // Must be user_id or null per FK constraint
    notes: document.getElementById('taskNotes').value.trim() || null,
    updated_at: new Date().toISOString()
  };
  
  try {
    if (editingTaskId) {
      const { error } = await sb.from('tasks').update(taskData).eq('task_id', editingTaskId);
      if (error) throw error;
    } else {
      taskData.created_by = currentUserId; // Also user_id per FK constraint
      taskData.created_at = new Date().toISOString();
      const { error } = await sb.from('tasks').insert(taskData);
      if (error) throw error;
    }
    closeTaskModal();
    loadTasksData();
  } catch (err) { console.error('Error saving task:', err); alert('Error: ' + err.message); }
}

async function deleteTask() {
  if (!editingTaskId) return;
  if (!confirm('Delete this task?')) return;
  try {
    const { error } = await sb.from('tasks').delete().eq('task_id', editingTaskId);
    if (error) throw error;
    closeTaskModal();
    loadTasksData();
  } catch (err) { console.error('Error deleting task:', err); alert('Error: ' + err.message); }
}

// ========== EMPLOYEES ==========
async function loadEmployeesData() {
  console.log('loadEmployeesData called, tenantId:', currentTenantId);
  try {
    let employees = [];
    let empError = null;
    
    // First try with tenant_id filter
    if (currentTenantId) {
      const result = await sb.from('employees')
        .select('*')
        .eq('tenant_id', currentTenantId)
        .order('first_name');
      employees = result.data || [];
      empError = result.error;
      console.log('Employees with tenant filter:', employees.length, empError);
    }
    
    // If no employees found, try without tenant filter (single-tenant mode)
    if (employees.length === 0) {
      console.log('No employees with tenant filter, trying without...');
      const result2 = await sb.from('employees')
        .select('*')
        .order('first_name')
        .limit(100);
      employees = result2.data || [];
      empError = result2.error;
      console.log('Employees without tenant filter:', employees.length, empError);
    }
    
    if (empError) {
      console.error('Error fetching employees:', empError);
    }
    
    allEmployeesData = employees;
    console.log('Final employees loaded:', allEmployeesData.length);
    
    // Log first few employees for debugging
    if (allEmployeesData.length > 0) {
      console.log('Sample employees:', allEmployeesData.slice(0, 3).map(e => `${e.first_name} ${e.last_name} (user_id: ${e.user_id})`));
    }
    
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    try {
      const { data: timeClock } = await sb.from('time_clock')
        .select('*')
        .gte('clock_in', todayStr + 'T00:00:00')
        .lte('clock_in', todayStr + 'T23:59:59');
      timeClockData = timeClock || [];
    } catch (e) { timeClockData = []; }
    
    try {
      const { data: schedules } = await sb.from('employee_schedules')
        .select('*')
        .eq('schedule_date', todayStr);
      scheduleData = schedules || [];
    } catch (e) { scheduleData = []; }
    
    // Find current user's employee record
    const userEmail = (await sb.auth.getUser()).data?.user?.email;
    console.log('Looking for current user employee, email:', userEmail, 'userId:', currentUserId);
    
    const currentEmp = allEmployeesData.find(e => 
      e.user_id === currentUserId || 
      (e.email && userEmail && e.email.toLowerCase() === userEmail.toLowerCase())
    );
    currentEmployeeId = currentEmp?.employee_id || null;
    currentUserRole = currentEmp?.role || null;
    isOwner = currentUserRole === 'owner';
    
    console.log('Current employee found:', currentEmp ? `${currentEmp.first_name} ${currentEmp.last_name}` : 'NOT FOUND');
    
    renderEmployees();
    updateEmployeesBadge();
    if (isOwner) document.getElementById('employeesActions').style.display = 'flex';
  } catch (error) { 
    console.error('Error in loadEmployeesData:', error); 
  }
}

function getEmployeeStatus(employee) {
  const now = new Date();
  const currentHour = now.getHours();
  const clockEntry = timeClockData.find(tc => tc.employee_id === employee.employee_id && !tc.clock_out);
  if (clockEntry) return { status: 'clocked-in', label: 'Clocked In', dot: 'green' };
  
  const schedule = scheduleData.find(s => s.employee_id === employee.employee_id);
  if (schedule) {
    const startTime = schedule.start_time ? parseInt(schedule.start_time.split(':')[0]) : null;
    const endTime = schedule.end_time ? parseInt(schedule.end_time.split(':')[0]) : null;
    if (startTime !== null && currentHour >= startTime && (endTime === null || currentHour < endTime)) 
      return { status: 'no-show', label: 'No Show', dot: 'red', isNoShow: true };
    if (startTime !== null && currentHour < startTime) 
      return { status: 'scheduled', label: `Scheduled ${formatScheduleTime(schedule.start_time)}`, dot: 'yellow' };
  }
  return { status: 'off', label: 'Off Today', dot: 'gray' };
}

function formatScheduleTime(timeStr) { 
  if (!timeStr) return ''; 
  const [hours, mins] = timeStr.split(':'); 
  const h = parseInt(hours); 
  const ampm = h >= 12 ? 'PM' : 'AM'; 
  const h12 = h % 12 || 12; 
  return `${h12}:${mins} ${ampm}`; 
}

function renderEmployees() {
  const container = document.getElementById('employeesList');
  if (allEmployeesData.length === 0) { 
    container.innerHTML = `<div class="employees-empty"><div class="employees-empty-icon">ðŸ‘¥</div><div>No employees found</div></div>`; 
    return; 
  }
  
  const employeesWithStatus = allEmployeesData.map(emp => ({ ...emp, statusInfo: getEmployeeStatus(emp) }));
  employeesWithStatus.sort((a, b) => { 
    if (a.statusInfo.isNoShow && !b.statusInfo.isNoShow) return -1; 
    if (!a.statusInfo.isNoShow && b.statusInfo.isNoShow) return 1; 
    return (a.department || 'zzz').localeCompare(b.department || 'zzz'); 
  });
  
  const clockedIn = employeesWithStatus.filter(e => e.statusInfo.status === 'clocked-in').length;
  const scheduledLater = employeesWithStatus.filter(e => e.statusInfo.status === 'scheduled').length;
  const noShow = employeesWithStatus.filter(e => e.statusInfo.isNoShow).length;
  
  document.getElementById('clockedInCount').textContent = clockedIn;
  document.getElementById('scheduledLaterCount').textContent = scheduledLater;
  document.getElementById('noShowCount').textContent = noShow;
  
  const noShows = employeesWithStatus.filter(e => e.statusInfo.isNoShow);
  const others = employeesWithStatus.filter(e => !e.statusInfo.isNoShow);
  const departments = {};
  others.forEach(emp => { 
    const dept = emp.department || 'Unassigned'; 
    if (!departments[dept]) departments[dept] = []; 
    departments[dept].push(emp); 
  });
  
  let html = '';
  if (noShows.length > 0) html += `<div class="dept-group"><div class="dept-header" style="background:rgba(239,68,68,0.2); color:#f87171;">âš ï¸ No Shows</div>${noShows.map(emp => renderEmployeeStrip(emp)).join('')}</div>`;
  
  const deptOrder = ['management', 'service', 'parts', 'sales', 'admin', 'Unassigned'];
  deptOrder.forEach(dept => { 
    if (departments[dept] && departments[dept].length > 0) { 
      const deptLabel = dept.charAt(0).toUpperCase() + dept.slice(1); 
      html += `<div class="dept-group"><div class="dept-header">${deptLabel} (${departments[dept].length})</div>${departments[dept].map(emp => renderEmployeeStrip(emp)).join('')}</div>`; 
    } 
  });
  
  container.innerHTML = html;
}

function renderEmployeeStrip(emp) {
  const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
  const initials = `${(emp.first_name || 'U')[0]}${(emp.last_name || '')[0] || ''}`.toUpperCase();
  const phone = emp.phone || emp.phone_number || '--';
  const statusInfo = emp.statusInfo;
  const avatarContent = emp.avatar_url ? `<img src="${emp.avatar_url}" alt="${name}">` : initials;
  return `<div class="emp-strip ${statusInfo.isNoShow ? 'no-show' : ''}" onclick="openEmployeeViewModal('${emp.employee_id}')">
    <div class="emp-strip-header">
      <div class="emp-avatar">${avatarContent}</div>
      <div class="emp-info">
        <div class="emp-name">${name}</div>
        <div class="emp-phone">${phone}</div>
      </div>
      <div class="emp-status ${statusInfo.status}">
        <span class="status-dot ${statusInfo.dot}"></span>${statusInfo.label}
      </div>
    </div>
  </div>`;
}

function openEmployeeViewModal(empId) {
  const emp = allEmployeesData.find(e => e.employee_id === empId);
  if (!emp) return;
  const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
  const phone = emp.phone || emp.phone_number || '--';
  const statusInfo = getEmployeeStatus(emp);
  document.getElementById('empViewModalBody').innerHTML = `
    <div style="text-align:center; margin-bottom:20px;">
      <div style="width:60px;height:60px;border-radius:50%;background:var(--bg-card);display:inline-flex;align-items:center;justify-content:center;font-size:24px;font-weight:600;color:var(--accent-light);margin-bottom:12px;">
        ${emp.avatar_url ? `<img src="${emp.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : `${(emp.first_name || 'U')[0]}${(emp.last_name || '')[0] || ''}`}
      </div>
      <div style="font-size:18px;font-weight:600;color:var(--text-primary);">${name}</div>
      <div style="font-size:14px;color:var(--text-secondary);">${(emp.role || '--').replace(/_/g, ' ')} â€¢ ${(emp.department || '--').replace(/_/g, ' ')}</div>
      <div class="emp-status ${statusInfo.status}" style="margin-top:8px;display:inline-flex;">
        <span class="status-dot ${statusInfo.dot}"></span>${statusInfo.label}
      </div>
    </div>
    <div class="kpi-container">
      <div class="kpi-row">
        <span class="kpi-label">Phone</span>
        <span class="kpi-value"><a href="tel:${phone}" style="color:var(--accent-light);text-decoration:none;">${phone}</a></span>
      </div>
      <div class="kpi-row">
        <span class="kpi-label">Email</span>
        <span class="kpi-value">${emp.email ? `<a href="mailto:${emp.email}" style="color:var(--accent-light);text-decoration:none;">${emp.email}</a>` : '--'}</span>
      </div>
      <div class="kpi-row">
        <span class="kpi-label">Hire Date</span>
        <span class="kpi-value">${emp.hire_date ? new Date(emp.hire_date).toLocaleDateString() : '--'}</span>
      </div>
    </div>`;
  document.getElementById('empViewModalTitle').textContent = name;
  document.getElementById('employeeViewModal').classList.add('active');
}

function closeEmployeeViewModal() { document.getElementById('employeeViewModal').classList.remove('active'); }

function updateEmployeesBadge() { 
  const noShowCount = allEmployeesData.filter(emp => getEmployeeStatus(emp).isNoShow).length; 
  const badge = document.getElementById('employeesBadge'); 
  if (noShowCount > 0) { 
    badge.textContent = noShowCount; 
    badge.style.display = 'inline-block'; 
    badge.classList.add('warning'); 
  } else { 
    badge.style.display = 'none'; 
  } 
}

function openNewEmployeeModal() { 
  if (!isOwner) { alert('Only owners can add employees.'); return; } 
  document.getElementById('newEmpFirstName').value = ''; 
  document.getElementById('newEmpLastName').value = ''; 
  document.getElementById('newEmpEmail').value = ''; 
  document.getElementById('newEmpPhone').value = ''; 
  document.getElementById('newEmpDepartment').value = ''; 
  document.getElementById('newEmpRole').value = ''; 
  document.getElementById('newEmpHireDate').value = new Date().toISOString().split('T')[0]; 
  document.getElementById('newEmployeeModal').classList.add('active'); 
}

function closeNewEmployeeModal() { document.getElementById('newEmployeeModal').classList.remove('active'); }

async function saveNewEmployee() { 
  if (!isOwner) { alert('Only owners can add employees.'); return; } 
  const firstName = document.getElementById('newEmpFirstName').value.trim(); 
  const lastName = document.getElementById('newEmpLastName').value.trim(); 
  const phone = document.getElementById('newEmpPhone').value.trim(); 
  const email = document.getElementById('newEmpEmail').value.trim() || null;
  const empRole = document.getElementById('newEmpRole').value || 'technician';
  
  // Map employee role to valid user role (admin, technician, owner, manager)
  const userRoleMap = {
    'owner': 'owner',
    'manager': 'manager',
    'sales_manager': 'manager',
    'sales_consultant': 'technician',
    'technician': 'technician',
    'admin': 'admin'
  };
  const userRole = userRoleMap[empRole] || 'technician';
  
  if (!firstName || !lastName || !phone) { alert('First name, last name, and phone are required.'); return; } 
  
  let userId = null;
  
  // If email provided, create a user account first so employee can be assigned tasks
  if (email) {
    // Check if user already exists with this email
    const { data: existingUser } = await sb.from('users')
      .select('user_id')
      .eq('email', email)
      .eq('tenant_id', currentTenantId)
      .single();
    
    if (existingUser) {
      userId = existingUser.user_id;
    } else {
      // Create new user record
      const newUserId = crypto.randomUUID();
      const { error: userError } = await sb.from('users').insert({
        user_id: newUserId,
        tenant_id: currentTenantId,
        email: email,
        role: userRole,
        is_active: true,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      });
      
      if (userError) {
        console.error('Error creating user:', userError);
        // Continue without user_id - employee can still be created
      } else {
        userId = newUserId;
      }
    }
  }
  
  const newEmp = { 
    tenant_id: currentTenantId, 
    first_name: firstName, 
    last_name: lastName, 
    email: email, 
    phone: phone, 
    department: document.getElementById('newEmpDepartment').value || null, 
    role: empRole, 
    hire_date: document.getElementById('newEmpHireDate').value || null, 
    user_id: userId,
    is_active: true 
  }; 
  
  const { error } = await sb.from('employees').insert(newEmp); 
  if (error) { alert('Error adding employee: ' + error.message); return; } 
  
  closeNewEmployeeModal(); 
  await loadEmployeesData();
  
  if (userId) {
    alert(`Employee added! ${firstName} ${lastName} can now be assigned tasks.`);
  } else {
    alert(`Employee added! Note: Without an email, ${firstName} cannot be assigned tasks.`);
  }
}

// ========== UTILITY ==========
function formatTimeAgo(dateStr) { 
  const diff = new Date() - new Date(dateStr); 
  const mins = Math.floor(diff / 60000), hrs = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000); 
  if (mins < 1) return 'Just now'; 
  if (mins < 60) return `${mins}m ago`; 
  if (hrs < 24) return `${hrs}h ago`; 
  if (days < 7) return `${days}d ago`; 
  return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); 
}

// ========== DATE RANGE ==========
function formatDateDisplay(date) { return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
function rangeChanged() { currentRange = document.getElementById('rangeSelect').value; const mobileSelect = document.getElementById('rangeSelectMobile'); if (mobileSelect) mobileSelect.value = currentRange; calculateDateRange(); updateDisplay(); loadDashboardData(); }
function rangeChangedMobile() { currentRange = document.getElementById('rangeSelectMobile').value; document.getElementById('rangeSelect').value = currentRange; calculateDateRange(); updateDisplay(); loadDashboardData(); }
function setDirection(direction) { currentDirection = direction; document.getElementById('pastBtn').classList.toggle('active', direction === 'past'); document.getElementById('futureBtn').classList.toggle('active', direction === 'future'); document.getElementById('pastBtnMobile')?.classList.toggle('active', direction === 'past'); document.getElementById('futureBtnMobile')?.classList.toggle('active', direction === 'future'); calculateDateRange(); updateDisplay(); loadDashboardData(); }
function setDirectionMobile(direction) { setDirection(direction); }
function calculateDateRange() { 
  const today = new Date(); 
  today.setHours(0, 0, 0, 0); 
  if (currentDirection === 'future') { 
    startDate = new Date(today); 
    endDate = new Date(today); 
    switch(currentRange) { 
      case 'today': endDate.setHours(23, 59, 59, 999); break; 
      case 'week': endDate.setDate(today.getDate() + 6); break; 
      case '30days': endDate.setDate(today.getDate() + 29); break; 
      case '60days': endDate.setDate(today.getDate() + 59); break; 
      case '90days': endDate.setDate(today.getDate() + 89); break; 
      case 'ytd': endDate = new Date(today.getFullYear(), 11, 31); break; 
    } 
    endDate.setHours(23, 59, 59, 999); 
  } else { 
    endDate = new Date(today); 
    endDate.setHours(23, 59, 59, 999); 
    startDate = new Date(today); 
    switch(currentRange) { 
      case 'today': startDate.setHours(0, 0, 0, 0); break; 
      case 'week': startDate.setDate(today.getDate() - 6); break; 
      case '30days': startDate.setDate(today.getDate() - 29); break; 
      case '60days': startDate.setDate(today.getDate() - 59); break; 
      case '90days': startDate.setDate(today.getDate() - 89); break; 
      case 'ytd': startDate = new Date(today.getFullYear(), 0, 1); break; 
    } 
  } 
}
function updateDisplay() { 
  const rangeText = { 'today': 'Today', 'week': '1 Week', '30days': '30 Days', '60days': '60 Days', '90days': '90 Days', 'ytd': 'Year to Date' }; 
  const displayText = `${rangeText[currentRange]} (${currentDirection === 'future' ? 'Future' : 'Past'})`; 
  document.getElementById('dateRangeDisplay').textContent = displayText; 
  const mobileDisplay = document.getElementById('dateRangeDisplayMobile'); 
  if (mobileDisplay) mobileDisplay.textContent = displayText; 
}

// ========== DASHBOARD DATA ==========
async function checkAuth() { 
  let { data: { session } } = await sb.auth.getSession(); 
  if (!session) { 
    const token = localStorage.getItem('sb_access_token'), refreshToken = localStorage.getItem('sb_refresh_token'); 
    if (token && refreshToken) { 
      const { data, error } = await sb.auth.setSession({ access_token: token, refresh_token: refreshToken }); 
      if (error || !data.session) { window.location.href = 'login.html'; return null; } 
      session = data.session; 
    } else { 
      window.location.href = 'login.html'; 
      return null; 
    } 
  } 
  currentUserId = session.user.id; 
  return session; 
}

async function loadBusinessSettings() { 
  const { data } = await sb.from('business_settings').select('*').limit(1).single(); 
  if (data) { 
    const name = data.business_name || data.company_name || ''; 
    document.getElementById('desktopBusinessName').textContent = name; 
    document.getElementById('mobileBusinessName').textContent = name; 
    if (!currentTenantId && data.tenant_id) currentTenantId = data.tenant_id; 
  } 
}

async function loadDashboardData() { await Promise.all([loadServiceData(), loadPartsData(), loadSalesData(), loadSummaryData()]); }

async function loadServiceData() { 
  try { 
    const { data: allOrders } = await sb.from('work_orders').select('*'); 
    const orders = allOrders || []; 
    const filteredOrders = orders.filter(wo => { 
      if (currentDirection === 'future') { 
        const d = wo.scheduled_start ? new Date(wo.scheduled_start) : null; 
        return d && d >= startDate && d <= endDate; 
      } else { 
        return new Date(wo.created_at) >= startDate && new Date(wo.created_at) <= endDate; 
      } 
    }); 
    const completedOrders = filteredOrders.filter(wo => wo.status === 'completed' || wo.status === 'closed'); 
    const inProgressOrders = filteredOrders.filter(wo => wo.status === 'in_progress'); 
    const scheduledOrders = filteredOrders.filter(wo => wo.status === 'scheduled'); 
    const totalRevenue = completedOrders.reduce((sum, wo) => sum + (parseFloat(wo.total_amount) || 0), 0); 
    const avgTicket = completedOrders.length > 0 ? totalRevenue / completedOrders.length : 0; 
    document.getElementById('serviceRevenueSummary').textContent = '$' + Math.round(totalRevenue).toLocaleString(); 
    document.getElementById('serviceOrdersSummary').textContent = completedOrders.length; 
    document.getElementById('serviceInProgressSummary').textContent = inProgressOrders.length; 
    document.getElementById('serviceRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString(); 
    document.getElementById('serviceOrders').textContent = completedOrders.length; 
    document.getElementById('serviceAvgTicket').textContent = '$' + Math.round(avgTicket).toLocaleString(); 
    document.getElementById('serviceInProgress').textContent = inProgressOrders.length; 
    document.getElementById('serviceScheduled').textContent = scheduledOrders.length; 
    createServiceChart(completedOrders.length, inProgressOrders.length, scheduledOrders.length); 
  } catch (error) { console.error('Error loading service data:', error); } 
}

function createServiceChart(completed, inProgress, scheduled) { 
  if (charts.serviceStatus) charts.serviceStatus.destroy(); 
  const ctx = document.getElementById('serviceStatusChart'); 
  charts.serviceStatus = new Chart(ctx, { 
    type: 'doughnut', 
    data: { 
      labels: ['Completed', 'In Progress', 'Scheduled'], 
      datasets: [{ data: [completed, inProgress, scheduled], backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6'] }] 
    }, 
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } } } 
  }); 
}

async function loadPartsData() { 
  try { 
    const { data: inventory } = await sb.from('parts_inventory').select('*'); 
    const parts = inventory || []; 
    const inventoryValue = parts.reduce((sum, p) => sum + ((parseFloat(p.quantity_on_hand) || 0) * (parseFloat(p.unit_cost) || 0)), 0); 
    const lowStock = parts.filter(p => (p.quantity_on_hand || 0) <= (p.reorder_point || 5)).length; 
    document.getElementById('partsInventorySummary').textContent = '$' + Math.round(inventoryValue).toLocaleString(); 
    document.getElementById('partsTotalSummary').textContent = parts.length; 
    document.getElementById('partsLowStockSummary').textContent = lowStock; 
    document.getElementById('partsInventoryValue').textContent = '$' + Math.round(inventoryValue).toLocaleString(); 
    document.getElementById('partsTotalItems').textContent = parts.length; 
    document.getElementById('partsLowStock').textContent = lowStock; 
  } catch (error) { console.error('Error loading parts data:', error); } 
}

async function loadSalesData() { 
  try { 
    const { data: allDeals } = await sb.from('deals').select('*'); 
    const deals = allDeals || []; 
    const filteredDeals = deals.filter(d => new Date(d.created_at) >= startDate && new Date(d.created_at) <= endDate); 
    const wonDeals = filteredDeals.filter(d => d.status === 'won' || d.status === 'closed_won'); 
    const lostDeals = filteredDeals.filter(d => d.status === 'lost' || d.status === 'closed_lost'); 
    const activeDeals = filteredDeals.filter(d => d.status !== 'won' && d.status !== 'lost' && d.status !== 'closed_won' && d.status !== 'closed_lost'); 
    const totalRevenue = wonDeals.reduce((sum, d) => sum + (parseFloat(d.deal_value) || parseFloat(d.amount) || 0), 0); 
    const pipelineValue = activeDeals.reduce((sum, d) => sum + (parseFloat(d.deal_value) || parseFloat(d.amount) || 0), 0); 
    const totalClosed = wonDeals.length + lostDeals.length; 
    const winRate = totalClosed > 0 ? Math.round((wonDeals.length / totalClosed) * 100) : 0; 
    document.getElementById('salesRevenueSummary').textContent = '$' + Math.round(totalRevenue).toLocaleString(); 
    document.getElementById('salesDealsSummary').textContent = wonDeals.length; 
    document.getElementById('salesWinRateSummary').textContent = winRate + '%'; 
    document.getElementById('salesRevenue').textContent = '$' + Math.round(totalRevenue).toLocaleString(); 
    document.getElementById('salesDeals').textContent = wonDeals.length; 
    document.getElementById('salesWinRate').textContent = winRate + '%'; 
    document.getElementById('salesPipeline').textContent = '$' + Math.round(pipelineValue).toLocaleString(); 
    const stageCounts = {}; 
    activeDeals.forEach(d => { const stage = d.stage || d.status || 'Unknown'; stageCounts[stage] = (stageCounts[stage] || 0) + 1; }); 
    createSalesPipelineChart(stageCounts); 
  } catch (error) { console.error('Error loading sales data:', error); } 
}

function createSalesPipelineChart(stageCounts) { 
  if (charts.salesPipeline) charts.salesPipeline.destroy(); 
  const labels = Object.keys(stageCounts).length > 0 ? Object.keys(stageCounts) : ['No Active Deals']; 
  const values = Object.keys(stageCounts).length > 0 ? Object.values(stageCounts) : [0]; 
  const ctx = document.getElementById('salesPipelineChart'); 
  charts.salesPipeline = new Chart(ctx, { 
    type: 'bar', 
    data: { labels, datasets: [{ label: 'Deals', data: values, backgroundColor: '#8b5cf6' }] }, 
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } }, x: { grid: { color: '#223044' }, ticks: { color: '#9fb0c3' } } } } 
  }); 
}

async function loadSummaryData() { 
  try { 
    const { data: customers } = await sb.from('customers').select('customer_id'); 
    const { data: vehicles } = await sb.from('vehicles').select('vehicle_id'); 
    document.getElementById('totalCustomers').textContent = (customers || []).length; 
    document.getElementById('totalVehicles').textContent = (vehicles || []).length; 
    setTimeout(() => { 
      const serviceRev = parseFloat(document.getElementById('serviceRevenue').textContent.replace(/[$,]/g, '')) || 0; 
      const salesRev = parseFloat(document.getElementById('salesRevenue').textContent.replace(/[$,]/g, '')) || 0; 
      document.getElementById('totalRevenue').textContent = '$' + Math.round(serviceRev + salesRev).toLocaleString(); 
      createSummaryChart(serviceRev, salesRev); 
    }, 500); 
  } catch (error) { console.error('Error loading summary data:', error); } 
}

function createSummaryChart(serviceRev, salesRev) { 
  if (charts.summaryRevenue) charts.summaryRevenue.destroy(); 
  const ctx = document.getElementById('summaryRevenueChart'); 
  charts.summaryRevenue = new Chart(ctx, { 
    type: 'doughnut', 
    data: { labels: ['Service', 'Sales'], datasets: [{ data: [serviceRev || 0, salesRev || 0], backgroundColor: ['#3b82f6', '#8b5cf6'] }] }, 
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e8eef6' } } } } 
  }); 
}

async function init() {
  console.log('=== INIT STARTED ===');
  const session = await checkAuth();
  if (!session) {
    console.error('No session, redirecting to login');
    return;
  }
  
  const authEmail = session.user?.email;
  const authUserId = session.user?.id;
  console.log('Auth session email:', authEmail);
  console.log('Auth session user id:', authUserId);
  
  // Display logged-in user email in headers
  if (authEmail) {
    const desktopEmail = document.getElementById('desktopUserEmail');
    const mobileEmail = document.getElementById('mobileUserEmail');
    if (desktopEmail) desktopEmail.textContent = authEmail;
    if (mobileEmail) mobileEmail.textContent = authEmail;
  }
  
  // PRIORITY 1: Check employees table first (most reliable for multi-tenant)
  if (authEmail) { 
    const { data: empByEmail, error: err1 } = await sb.from('employees').select('tenant_id, user_id, employee_id, email').eq('email', authEmail).single(); 
    console.log('Employee by email lookup:', empByEmail, err1);
    if (empByEmail?.tenant_id) { 
      currentTenantId = empByEmail.tenant_id; 
      if (empByEmail.user_id) currentUserId = empByEmail.user_id;
      currentEmployeeId = empByEmail.employee_id;
      console.log('Got tenant from employees table:', currentTenantId);
    } 
  }
  
  // PRIORITY 2: Check users table by email
  if (!currentTenantId && authEmail) { 
    const { data: userByEmail, error: err2 } = await sb.from('users').select('*').eq('email', authEmail).single(); 
    console.log('User by email lookup:', userByEmail, err2);
    if (userByEmail?.tenant_id) { 
      currentTenantId = userByEmail.tenant_id; 
      currentUserId = userByEmail.user_id; 
      console.log('Got tenant from users table:', currentTenantId);
    } 
  }
  
  // PRIORITY 3: Check users table by auth user_id
  if (!currentTenantId && authUserId) { 
    const { data: userData, error: err3 } = await sb.from('users').select('*').eq('user_id', authUserId).single(); 
    console.log('User by auth user_id lookup:', userData, err3);
    if (userData?.tenant_id) {
      currentTenantId = userData.tenant_id;
      currentUserId = userData.user_id;
      console.log('Got tenant from user_id lookup:', currentTenantId);
    }
  }
  
  // PRIORITY 4: Try tenants table directly if user has access
  if (!currentTenantId) {
    const { data: tenantData, error: err4 } = await sb.from('tenants').select('tenant_id').limit(1).single();
    console.log('Tenants table lookup:', tenantData, err4);
    if (tenantData?.tenant_id) {
      currentTenantId = tenantData.tenant_id;
      console.log('Got tenant from tenants table:', currentTenantId);
    }
  }
  
  // LAST RESORT: business_settings (might return wrong tenant in multi-tenant setup)
  if (!currentTenantId) { 
    const { data: bsData, error: err5 } = await sb.from('business_settings').select('tenant_id, business_name').limit(1).single(); 
    console.log('Business settings lookup (FALLBACK):', bsData, err5);
    if (bsData?.tenant_id) {
      currentTenantId = bsData.tenant_id;
      console.log('Got tenant from business_settings:', currentTenantId);
    }
  }
  
  console.log('=== FINAL VALUES ===');
  console.log('currentTenantId:', currentTenantId);
  console.log('currentUserId:', currentUserId);
  
  if (!currentTenantId) { 
    console.error('Could not determine tenant_id'); 
    alert('Error: Could not determine your organization. Please contact support.');
    return; 
  }
  
  // Get user's role for navigation permissions
  let userRole = 'owner'; // Default to owner if not found
  if (currentUserId) {
    const { data: userRoleData } = await sb.from('users').select('role').eq('user_id', currentUserId).single();
    if (userRoleData?.role) userRole = userRoleData.role;
  }
  console.log('User role:', userRole);
  
  // Initialize dynamic navigation based on tenant preset + user role
  if (typeof initNavigation === 'function') {
    await initNavigation(sb, currentTenantId, userRole, 'business');
    console.log('Dynamic navigation loaded');
  }
  
  await loadBusinessSettings();
  calculateDateRange();
  updateDisplay();
  
  // Load employees FIRST since tasks and messages need employee data
  console.log('Loading employees...');
  await loadEmployeesData();
  console.log('Employees loaded, count:', allEmployeesData.length);
  
  // Then load other data in parallel
  console.log('Loading other data...');
  await Promise.all([loadDashboardData(), loadTasksData(), loadInboxData()]);
  console.log('=== INIT COMPLETE ===');
}

init();
</script>
</body>
</html>
