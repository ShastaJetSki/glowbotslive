<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Business Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
  content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body {
  margin:0;
  padding:24px;
  font-family:system-ui;
  background:#0b0f14;
  color:#e8eef6;
}

.appName {
  position:fixed;
  top:10px;
  right:24px;
  font-size:12px;
  color:#9fb0c3;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:20px;
}

h1 { margin:0; font-size:38px; }
h2 { margin:20px 0 10px; font-size:18px; display:flex; gap:12px; align-items:center; }

button {
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #2a3b55;
  background:#1a2535;
  color:#fff;
  cursor:pointer;
}

.row { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px; }

.card {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:14px;
  padding:14px 16px;
}

/* KPI */
.kpi { min-width:220px; flex:1 1 220px; }
.kpi .label { font-size:12px; color:#9fb0c3; }
.kpi .value { font-size:22px; font-weight:700; }

/* TECH */
.tech {
  min-width:260px;
  flex:1 1 260px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.tech.active {
  border-color:#3b82f6;
  box-shadow:0 0 0 1px rgba(59,130,246,.35) inset;
}
.techLeft .value { font-size:18px; font-weight:650; }
.techLeft .muted { font-size:12px; color:#9fb0c3; }
.techRight { display:flex; flex-direction:column; align-items:center; gap:6px; }
.avatar {
  width:52px; height:52px; border-radius:50%;
  background:#0b0f14; border:1px solid #223044;
  display:flex; align-items:center; justify-content:center;
  font-weight:700;
}
.techName { font-size:12px; }

/* FILTERS */
.filters { display:flex; gap:8px; margin:10px 0 16px; }
.pill {
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #223044;
  background:#0f1621;
  font-size:12px;
  cursor:pointer;
}
.pill.active { border-color:#3b82f6; }

.muted { font-size:12px; color:#9fb0c3; }
.wo { margin-bottom:10px; }
.error { color:#ffb3b3; white-space:pre-wrap; }
</style>
</head>

<body>

<div class="appName">WorkLogicPro</div>

<header>
  <h1 id="tenantTitle">Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<!-- KPI ROW -->
<div class="row" id="kpis"></div>

<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<div class="filters">
  <div class="pill active" onclick="setRange('today')" id="btnToday">Today</div>
  <div class="pill" onclick="setRange('week')" id="btnWeek">This Week</div>
  <div class="pill" onclick="setRange('all')" id="btnAll">All</div>
  <div class="pill" onclick="clearFilters()">Clear Filters</div>
</div>

<h2>
  Work Orders
  <button onclick="createWorkOrder()">+ New Work Order</button>
</h2>

<div id="workOrders">Loading…</div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const STATUS_BUCKETS = {
  scheduled:["scheduled","in_progress","repairing","testing","ready_for_pickup"],
  waiting:["awaiting_parts","parts_on_order"],
  complications:["diagnosis_required","customer_approval"],
  completed:["completed","closed"]
};

let employees=[], employeesById={}, technicians=[], orders=[];
let activeTechId=null, activeRange="today";

function statusIn(bucket,s){ return STATUS_BUCKETS[bucket].includes(s); }

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token=localStorage.getItem("sb_access_token");
  if(!token) return null;
  const r=await fetch(`${API_BASE}/auth/v1/user`,{
    headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
  });
  return r.ok?token:null;
}

async function fetchJson(url,token){
  const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function createWorkOrder(){
  location.href="work-order-new.html";
}

/* KPI */
function renderKPIs(){
  const bucket=(b)=>orders.filter(w=>statusIn(b,w.status));
  const card=(t,c)=>`
    <div class="card kpi">
      <div class="label">${t}</div>
      <div class="value">${c.length}</div>
    </div>`;
  document.getElementById("kpis").innerHTML =
    card("Scheduled",bucket("scheduled"))+
    card("Waiting",bucket("waiting"))+
    card("Complications",bucket("complications"))+
    card("Completed",bucket("completed"));
}

/* TECH */
function renderTechCards(){
  const counts={};
  technicians.forEach(t=>counts[t.employee_id]=0);
  orders.forEach(w=>{
    if(w.assigned_employee_id && counts[w.assigned_employee_id]!=null)
      counts[w.assigned_employee_id]++;
  });

  document.getElementById("techCards").innerHTML =
    technicians.map(t=>{
      const name=t.name||`${t.first_name||""} ${t.last_name||""}`.trim();
      const initials=name.split(" ").map(x=>x[0]).join("").slice(0,2);
      return `
        <div class="card tech ${activeTechId===t.employee_id?'active':''}"
          onclick="selectTech('${t.employee_id}')">
          <div class="techLeft">
            <div class="value">${counts[t.employee_id]} jobs</div>
            <div class="muted">Today</div>
          </div>
          <div class="techRight">
            <div class="avatar">${initials}</div>
            <div class="techName">${name}</div>
          </div>
        </div>`;
    }).join("");
}

function selectTech(id){
  activeTechId=(activeTechId===id)?null:id;
  renderWorkOrders();
}

/* WORK ORDERS */
function renderWorkOrders(){
  const list=document.getElementById("workOrders");
  let filtered=orders;
  if(activeTechId) filtered=filtered.filter(w=>w.assigned_employee_id===activeTechId);

  if(!filtered.length){
    list.innerHTML=`<div class="muted">No work orders.</div>`;
    return;
  }

  list.innerHTML=filtered.map(w=>{
    const tech=w.assigned_employee_id
      ? employeesById[w.assigned_employee_id]?.name||"Assigned Tech"
      : "Unassigned";
    return `
      <div class="card wo">
        <strong>${w.customer_name||"Unknown Customer"}</strong> · ${w.status}
        <div class="muted">${w.summary||""}</div>
        <div class="muted">Tech: ${tech}</div>
      </div>`;
  }).join("");
}

async function load(){
  const token=await validateAuth();
  if(!token){ logout(); return; }

  try{
    employees=await fetchJson(`${FUNCTIONS_BASE}/employees`,token);
    employees.forEach(e=>employeesById[e.employee_id]=e);
    technicians=employees.filter(e=>e.role==="technician");

    orders=await fetchJson(`${FUNCTIONS_BASE}/work_orders`,token);

    if(orders[0]?.tenant_name)
      document.getElementById("tenantTitle").textContent=orders[0].tenant_name;

    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }catch(err){
    document.getElementById("workOrders").innerHTML=
      `<div class="error">${err.message}</div>`;
  }
}

load();
</script>

</body>
</html>
