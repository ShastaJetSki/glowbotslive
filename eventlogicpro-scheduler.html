<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>EventLogicPro - Scheduler</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fefcf8;--bg-secondary:#faf6ee;--bg-card:#fff;--bg-hover:#f5efe0;--border-default:#e8dcc8;--text-primary:#44402a;--text-secondary:#6a6550;--accent-primary:#a89060;--accent-light:#c4aa78;}
    /* (all other theme definitions identical to original) */

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow:hidden;height:100%;}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--text-primary);padding:12px 24px;border-radius:10px;font-size:13px;font-weight:600;border:1px solid var(--accent-primary);z-index:9999;display:none;}
    .toast.show{display:block;animation:fadeIn .3s;}
    @keyframes fadeIn{from{opacity:0;transform:translateX(-50%) translateY(10px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
    .business-name{font-size:13px;color:var(--text-secondary);}
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);}
    .theme-toggle-btn svg{width:18px;height:18px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;}
    .app-shell{display:flex;flex-direction:column;height:100%;}
    .desktop-header{background:var(--bg-secondary);border-bottom:1px solid var(--border-default);flex-shrink:0;}
    .app-body{display:flex;flex:1;overflow:hidden;}
    .sidebar{width:230px;background:var(--bg-secondary);border-right:1px solid var(--border-default);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;scrollbar-width:thin;scrollbar-color:var(--border-default) transparent;}
    .sidebar::-webkit-scrollbar{width:5px;}.sidebar::-webkit-scrollbar-thumb{background:var(--border-default);border-radius:4px;}
    .sidebar-section{padding:12px 14px;border-bottom:1px solid var(--border-default);}.sidebar-section:last-child{border-bottom:none;}
    .sidebar-title{font-size:10px;text-transform:uppercase;font-weight:700;color:var(--text-secondary);letter-spacing:.8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
    .sidebar-add{width:20px;height:20px;border-radius:4px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;line-height:1;}
    .sidebar-add:hover{background:var(--bg-hover);color:var(--text-primary);}
    .mini-cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
    .mini-cal-title{font-size:12px;font-weight:600;}
    .mini-cal-btn{width:24px;height:24px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;border-radius:4px;font-size:13px;display:flex;align-items:center;justify-content:center;}
    .mini-cal-btn:hover{background:var(--bg-hover);}
    .mini-grid{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;}
    .mini-hdr{font-size:9px;color:var(--text-secondary);padding:2px 0;}
    .mini-day{font-size:10px;padding:3px 0;border-radius:50%;cursor:pointer;width:26px;height:26px;display:flex;align-items:center;justify-content:center;margin:0 auto;}
    .mini-day:hover{background:var(--bg-hover);}.mini-day.today{background:var(--accent-primary);color:#fff;font-weight:700;}.mini-day.selected{border:2px solid var(--accent-light);}.mini-day.other{color:var(--text-secondary);opacity:.4;}
    .cal-layer{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:8px;cursor:pointer;transition:all .15s;margin-bottom:3px;position:relative;}
    .cal-layer:hover{background:var(--bg-hover);}
    .cal-layer-check{width:16px;height:16px;border-radius:4px;border:2px solid;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;position:relative;}
    .cal-layer-check.on{background:currentColor;}.cal-layer-check.on::after{content:'';width:4px;height:8px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);position:absolute;top:1px;}
    .cal-layer-name{font-size:12px;font-weight:500;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cal-layer-count{font-size:9px;background:var(--bg-hover);padding:1px 6px;border-radius:10px;color:var(--text-secondary);flex-shrink:0;}
    .cal-layer-actions{opacity:0;transition:opacity .15s;display:flex;gap:1px;}.cal-layer:hover .cal-layer-actions{opacity:1;}
    .cal-layer-btn{width:20px;height:20px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;border-radius:4px;font-size:11px;display:flex;align-items:center;justify-content:center;}.cal-layer-btn:hover{background:var(--bg-primary);color:var(--text-primary);}
    .cal-layer.active-glow{box-shadow:inset 0 0 0 1px currentColor;background:color-mix(in srgb,currentColor 8%,transparent);}
    .emp-row{display:flex;align-items:center;gap:8px;padding:4px 8px;border-radius:6px;cursor:pointer;margin-bottom:2px;}.emp-row:hover{background:var(--bg-hover);}
    .emp-avatar{width:22px;height:22px;border-radius:50%;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:#fff;}
    .emp-name{font-size:11px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .emp-chk{width:14px;height:14px;border-radius:3px;border:2px solid var(--border-default);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;position:relative;}
    .emp-chk.on{background:var(--accent-primary);border-color:var(--accent-primary);}.emp-chk.on::after{content:'';width:3px;height:7px;border:solid #fff;border-width:0 1.5px 1.5px 0;transform:rotate(45deg);position:absolute;top:0px;}
    .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .sched-controls{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;gap:8px;flex-wrap:wrap;flex-shrink:0;border-bottom:1px solid var(--border-default);}
    .sched-nav{display:flex;align-items:center;gap:6px;}
    .sched-nav-btn{width:32px;height:32px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}.sched-nav-btn:hover{background:var(--bg-hover);}
    .sched-title{font-size:17px;font-weight:700;min-width:140px;text-align:center;}
    .sched-today-btn{padding:5px 12px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-primary);font-size:12px;font-weight:600;cursor:pointer;}.sched-today-btn:hover{background:var(--bg-hover);}
    .view-toggle{display:flex;border-radius:6px;overflow:hidden;border:1px solid var(--border-default);}
    .view-btn{padding:6px 14px;border:none;background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;}.view-btn.active{background:var(--accent-primary);color:#fff;}.view-btn+.view-btn{border-left:1px solid var(--border-default);}
    .sched-add-btn{padding:6px 14px;border-radius:6px;border:none;background:var(--accent-primary);color:#fff;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;}.sched-add-btn:hover{filter:brightness(1.1);}
    .cal-drawer-btn{display:none;width:32px;height:32px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);cursor:pointer;font-size:16px;align-items:center;justify-content:center;}
    .view-area{flex:1;overflow:hidden;padding:0 12px 12px;}
    .month-wrap{display:flex;flex-direction:column;height:100%;}
    .cal-header{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;flex-shrink:0;}
    .cal-header-day{text-align:center;font-size:13px;font-weight:600;color:var(--text-secondary);padding:10px 4px;text-transform:uppercase;border-bottom:1px solid var(--border-default);}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(6,1fr);gap:1px;flex:1;min-height:0;}
    .cal-cell{background:var(--bg-card);border:1px solid var(--border-default);border-radius:4px;padding:5px 6px;cursor:pointer;transition:border-color .15s;overflow:hidden;display:flex;flex-direction:column;min-height:165px;}
    .cal-cell:hover{border-color:var(--accent-primary);}.cal-cell.today{border-color:var(--accent-primary);border-width:2px;}.cal-cell.other{opacity:.3;}
    .cal-day-num{font-size:13px;font-weight:600;margin-bottom:4px;flex-shrink:0;line-height:1.4;}
    .cal-cell.today .cal-day-num{background:var(--accent-primary);color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;}
    .cal-events{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:3px;min-height:0;scrollbar-width:thin;scrollbar-color:color-mix(in srgb,var(--text-secondary) 30%,transparent) transparent;}
    .cal-events::-webkit-scrollbar{width:4px;}.cal-events::-webkit-scrollbar-track{background:transparent;}.cal-events::-webkit-scrollbar-thumb{background:color-mix(in srgb,var(--text-secondary) 40%,transparent);border-radius:4px;}
    .cal-strip{font-size:13px;padding:4px 10px;border-radius:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;font-weight:500;border-left:4px solid;line-height:1.6;}.cal-strip:hover{filter:brightness(1.15);}
    .week-wrap{display:flex;flex-direction:column;height:100%;}
    .week-header{display:grid;grid-template-columns:52px repeat(7,1fr);gap:0;flex-shrink:0;}
    .week-header-day{text-align:center;font-size:11px;font-weight:600;color:var(--text-secondary);padding:6px 2px;border-bottom:2px solid var(--border-default);}.week-header-day.today{color:var(--accent-light);border-bottom-color:var(--accent-primary);}
    .week-header-day .wh-num{font-size:22px;font-weight:700;color:var(--text-primary);display:block;line-height:1.2;}.week-header-day.today .wh-num{color:var(--accent-light);}
    .week-scroll{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:color-mix(in srgb,var(--text-secondary) 30%,transparent) transparent;}
    .week-scroll::-webkit-scrollbar{width:5px;}.week-scroll::-webkit-scrollbar-thumb{background:color-mix(in srgb,var(--text-secondary) 40%,transparent);border-radius:4px;}
    .week-grid{display:grid;grid-template-columns:52px repeat(7,1fr);gap:0;}
    .week-time{font-size:10px;color:var(--text-secondary);text-align:right;padding:2px 6px 0 0;height:56px;border-top:1px solid var(--border-default);}
    .week-cell{border-top:1px solid var(--border-default);border-left:1px solid color-mix(in srgb,var(--border-default) 50%,transparent);min-height:56px;padding:2px;cursor:pointer;}.week-cell:hover{background:var(--bg-hover);}.week-cell.today-col{background:color-mix(in srgb,var(--accent-primary) 4%,transparent);}
    .week-ev{font-size:11px;padding:3px 6px;border-radius:4px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;border-left:3px solid;font-weight:500;}
    .day-wrap{display:flex;flex-direction:column;height:100%;}
    .day-scroll{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:color-mix(in srgb,var(--text-secondary) 30%,transparent) transparent;}
    .day-scroll::-webkit-scrollbar{width:5px;}.day-scroll::-webkit-scrollbar-thumb{background:color-mix(in srgb,var(--text-secondary) 40%,transparent);border-radius:4px;}
    .day-hour{display:grid;grid-template-columns:52px 1fr;min-height:68px;border-top:1px solid var(--border-default);}
    .day-hour-label{font-size:11px;color:var(--text-secondary);text-align:right;padding:3px 8px 0 0;}
    .day-hour-content{padding:3px 6px;cursor:pointer;min-height:68px;}.day-hour-content:hover{background:var(--bg-hover);}
    .day-ev{padding:8px 12px;border-radius:6px;margin-bottom:4px;cursor:pointer;border-left:4px solid;}.day-ev-title{font-weight:600;font-size:14px;}.day-ev-meta{font-size:12px;opacity:.8;margin-top:2px;}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s;}.modal-overlay.active{opacity:1;pointer-events:auto;}
    .modal-content{background:var(--bg-card);border-radius:14px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;border:1px solid var(--border-default);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border-default);}.modal-title{font-size:15px;font-weight:700;}
    .modal-close{width:28px;height:28px;border-radius:6px;border:none;background:transparent;color:var(--text-secondary);font-size:18px;cursor:pointer;}.modal-close:hover{background:var(--bg-hover);}
    .modal-body{padding:16px 18px;}.modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 18px;border-top:1px solid var(--border-default);}
    .form-group{margin-bottom:12px;}.form-label{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:3px;display:block;}
    .form-input,.form-select,.form-textarea{width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);font-size:13px;font-family:inherit;}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent-primary);}.form-textarea{resize:vertical;min-height:50px;}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .btn-primary{padding:8px 16px;border-radius:6px;border:none;background:var(--accent-primary);color:#fff;font-size:12px;font-weight:600;cursor:pointer;}.btn-primary:hover{filter:brightness(1.1);}
    .btn-secondary{padding:8px 16px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-primary);font-size:12px;font-weight:600;cursor:pointer;}
    .btn-danger{padding:8px 16px;border-radius:6px;border:none;background:#ef4444;color:#fff;font-size:12px;font-weight:600;cursor:pointer;margin-right:auto;}
    .color-picker{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
    .color-swatch{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;}.color-swatch:hover{transform:scale(1.2);}.color-swatch.picked{border-color:var(--text-primary);box-shadow:0 0 0 2px var(--bg-card);}
    .mobile-top-header{display:none;}
    .mobile-header-bar{display:flex;align-items:center;padding:10px 12px;gap:8px;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);}
    .mobile-menu-toggle{width:34px;height:34px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-primary);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .mobile-header-center{flex:1;min-width:0;}.mobile-header-title{font-size:15px;font-weight:700;}
    .mobile-header-content{display:none;padding:10px 12px;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);max-height:60vh;overflow-y:auto;}.mobile-header-content.expanded{display:block;}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:6px 8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;}
    .mobile-nav-btn{padding:8px 4px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:10px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:38px;transition:all .15s;}
    .mobile-nav-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}
    .mobile-cal-drawer{display:none;position:fixed;bottom:52px;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border-default);z-index:99;max-height:50vh;overflow-y:auto;border-radius:16px 16px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.3);transform:translateY(100%);transition:transform .25s ease;}.mobile-cal-drawer.open{transform:translateY(0);}
    .drawer-handle{width:36px;height:4px;background:var(--border-default);border-radius:2px;margin:8px auto;}
    @media(max-width:768px){.desktop-header{display:none!important;}.mobile-top-header{display:block!important;}.mobile-bottom-nav{display:block!important;}.sidebar{display:none!important;}.mobile-cal-drawer{display:block!important;}.cal-drawer-btn{display:flex!important;}.sched-controls{padding:6px 10px;}.sched-title{font-size:14px;min-width:100px;}.view-area{padding:0 6px 60px;}.cal-header-day{font-size:10px;padding:5px 2px;}.cal-day-num{font-size:10px;}.cal-cell.today .cal-day-num{width:20px;height:20px;font-size:9px;}.cal-strip{font-size:9px;padding:2px 5px;border-left-width:2px;line-height:1.5;}.week-header{grid-template-columns:36px repeat(7,1fr);}.week-grid{grid-template-columns:36px repeat(7,1fr);}.week-time{font-size:8px;padding-right:2px;}.week-header-day{font-size:8px;}.week-header-day .wh-num{font-size:14px;}.week-ev{font-size:8px;padding:1px 2px;border-left-width:2px;}.day-hour{grid-template-columns:36px 1fr;}.modal-overlay{align-items:flex-end;padding:0;}.modal-content{border-radius:16px 16px 0 0;max-height:85vh;}.form-row{grid-template-columns:1fr;}}
    @media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}.mobile-cal-drawer{display:none!important;}}
  </style>
</head>
<body>
<div class="app-shell">

<!-- MOBILE HEADER -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileDrawer()">‚ò∞</button>
    <div class="mobile-header-center"><div class="mobile-header-title">Scheduler</div><div class="business-name" id="mBizName">Loading...</div></div>
    <div class="view-toggle">
      <button class="view-btn active" id="mVM" onclick="setView('month')">M</button>
      <button class="view-btn" id="mVW" onclick="setView('week')">W</button>
      <button class="view-btn" id="mVD" onclick="setView('day')">D</button>
    </div>
  </div>
</div>

<!-- DESKTOP HEADER ‚Äî UPDATED NAV -->
<div class="desktop-header">
  <div style="padding:14px 24px 6px;display:flex;justify-content:space-between;align-items:center;">
    <div><h1 style="margin:0;font-size:28px;font-weight:600;">EventLogicPro</h1><div class="business-name" id="dBizName">Loading...</div></div>
    <div style="display:flex;align-items:center;gap:14px;"><button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button><a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:13px;">Logout</a></div>
  </div>
  <div style="padding:0 24px 10px;"><nav style="display:flex;gap:24px;"><a href="eventlogicpro-scheduler.html" style="padding:10px 0;color:var(--accent-primary);text-decoration:none;font-size:13px;border-bottom:2px solid var(--accent-primary);">Calendar</a><a href="eventlogicpro.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Events</a><a href="eventlogicpro-estimator.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Estimator</a><a href="eventlogicpro-sitemap.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Site Map</a></nav></div>
</div>

<div class="app-body">
<div class="sidebar" id="sidebar">
  <div class="sidebar-section" id="miniCalSection"></div>
  <div class="sidebar-section"><div class="sidebar-title">My Calendars <button class="sidebar-add" onclick="openCalModal()">+</button></div><div id="calLayerList"></div></div>
  <div class="sidebar-section"><div class="sidebar-title">Team Members</div><div id="empFilterList"></div></div>
</div>
<div class="main-content">
  <div class="sched-controls">
    <div class="sched-nav"><button class="sched-nav-btn" onclick="navPrev()">‚óÄ</button><div class="sched-title" id="schedTitle"></div><button class="sched-nav-btn" onclick="navNext()">‚ñ∂</button><button class="sched-today-btn" onclick="goToday()">Today</button></div>
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
      <button class="cal-drawer-btn" onclick="toggleMobileDrawer()">‚ò∑</button>
      <div class="view-toggle" id="dViewToggle"><button class="view-btn active" id="dVM" onclick="setView('month')">Month</button><button class="view-btn" id="dVW" onclick="setView('week')">Week</button><button class="view-btn" id="dVD" onclick="setView('day')">Day</button></div>
      <button class="sched-add-btn" onclick="openEventModal()">+ Add</button>
    </div>
  </div>
  <div class="view-area">
    <div id="monthView" class="month-wrap"></div>
    <div id="weekView" class="week-wrap" style="display:none;"></div>
    <div id="dayView" class="day-wrap" style="display:none;"></div>
  </div>
</div>
</div>
</div>

<!-- MOBILE DRAWER -->
<div class="mobile-cal-drawer" id="mobileDrawer"><div class="drawer-handle"></div><div style="padding:8px 14px 14px;"><div class="sidebar-title">My Calendars <button class="sidebar-add" onclick="openCalModal()">+</button></div><div id="mCalLayerList"></div><div class="sidebar-title" style="margin-top:12px;">Team Members</div><div id="mEmpFilterList"></div></div></div>

<!-- UPDATED MOBILE NAV -->
<div class="mobile-bottom-nav"><div class="mobile-nav-top"><a href="eventlogicpro-scheduler.html" class="mobile-nav-btn active">Calendar</a><a href="eventlogicpro.html" class="mobile-nav-btn">Events</a><a href="eventlogicpro-estimator.html" class="mobile-nav-btn">Estimator</a><a href="eventlogicpro-sitemap.html" class="mobile-nav-btn">Site Map</a></div></div>

<!-- EVENT MODAL -->
<div class="modal-overlay" id="eventModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title" id="emModalTitle">Add Event</div><button class="modal-close" onclick="closeEventModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Title *</label><input type="text" class="form-input" id="emTitle"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Date *</label><input type="date" class="form-input" id="emDate"></div><div class="form-group"><label class="form-label">Calendar</label><select class="form-select" id="emCalendar"></select></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Start Time</label><input type="time" class="form-input" id="emStart"></div><div class="form-group"><label class="form-label">End Time</label><input type="time" class="form-input" id="emEnd"></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="emCategory"><option value="meeting">Meeting</option><option value="deadline">Deadline</option><option value="milestone">Milestone</option><option value="setup">Setup / Load-in</option><option value="rehearsal">Rehearsal</option><option value="other">Other</option></select></div><div class="form-group"><label class="form-label">Assigned To</label><select class="form-select" id="emAssigned"><option value="">-- None --</option></select></div></div>
      <div class="form-group"><label class="form-label">Event Project</label><select class="form-select" id="emProject"><option value="">-- None --</option></select></div>
      <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="emLocation"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="emNotes"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn-danger" id="emDeleteBtn" style="display:none;" onclick="deleteScheduleItem()">Delete</button><button class="btn-secondary" onclick="closeEventModal()">Cancel</button><button class="btn-primary" onclick="saveScheduleItem()">Save</button></div>
  </div>
</div>
<!-- CALENDAR MODAL -->
<div class="modal-overlay" id="calModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title" id="calModalTitle">New Calendar</div><button class="modal-close" onclick="closeCalModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Calendar Name *</label><input type="text" class="form-input" id="cmName" placeholder="e.g. Swag Orders"></div>
      <div class="form-group"><label class="form-label">Color</label><div class="color-picker" id="cmColorPicker"></div></div>
    </div>
    <div class="modal-footer"><button class="btn-danger" id="cmDeleteBtn" style="display:none;" onclick="deleteCalendar()">Delete</button><button class="btn-secondary" onclick="closeCalModal()">Cancel</button><button class="btn-primary" onclick="saveCalendar()">Save</button></div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ===== FULL ORIGINAL SCHEDULER JS ‚Äî UNCHANGED ===== */
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co',SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);var tenantId=null,userId=null;var allItems=[],allProjects=[],allMembers=[],allCalendars=[];var visibleCalIds=new Set(),visibleEmpIds=new Set(),allEmpsVisible=true;var currentView='month',viewDate=new Date(),miniDate=new Date(),editingItemId=null,editingCalId=null;
var PALETTE=['#3b82f6','#ef4444','#f59e0b','#22c55e','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#64748b','#84cc16','#a855f7','#e11d48','#0ea5e9','#d946ef'];var EMP_COLORS=['#3b82f6','#ef4444','#f59e0b','#22c55e','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#64748b'];var MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];var DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];var DAYS_S=['S','M','T','W','T','F','S'];
var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal','cyber','amber','honey','crimson','coral','rose','sand'];var themeIdx=0;function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);themeIdx=themes.indexOf(t);if(themeIdx<0)themeIdx=0;}function cycleTheme(){themeIdx=(themeIdx+1)%themes.length;var t=themes[themeIdx];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);}loadTheme();
function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2500);}function dateStr(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}function isToday(d){var t=new Date();return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate();}function getWeekStart(d){var w=new Date(d);w.setDate(w.getDate()-w.getDay());return w;}function empName(id){if(!id)return '';var m=allMembers.find(function(x){return x.member_id===id;});return m?((m.first_name||'')+' '+(m.last_name||'')).trim():'';}function getCalColor(calId){var c=allCalendars.find(function(x){return x.calendar_id===calId;});return c?c.color:'#64748b';}function getCalName(calId){var c=allCalendars.find(function(x){return x.calendar_id===calId;});return c?c.calendar_name:'General';}
async function logout(){await sb.auth.signOut();window.location.href='login.html';}async function checkAuth(){var r=await sb.auth.getSession();var s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){window.location.href='login.html';return null;}}return s;}
async function loadCalendars(){var r=await sb.from('event_calendars').select('*').eq('tenant_id',tenantId).order('sort_order');allCalendars=r.data||[];if(!allCalendars.length){await sb.from('event_calendars').insert({tenant_id:tenantId,calendar_name:'General',color:'#3b82f6',is_default:true});var r2=await sb.from('event_calendars').select('*').eq('tenant_id',tenantId);allCalendars=r2.data||[];}var saved=localStorage.getItem('visible_cals_'+tenantId);if(saved){try{var arr=JSON.parse(saved);visibleCalIds=new Set(arr);}catch(e){allCalendars.forEach(function(c){visibleCalIds.add(c.calendar_id);});}}else{allCalendars.forEach(function(c){visibleCalIds.add(c.calendar_id);});}}
async function loadProjects(){var r=await sb.from('event_projects').select('event_project_id,event_name').eq('tenant_id',tenantId).order('created_at',{ascending:false});allProjects=r.data||[];}
async function loadMembers(){var r=await sb.from('event_members').select('*').eq('tenant_id',tenantId).eq('is_active',true).order('first_name');allMembers=r.data||[];allMembers.forEach(function(m){visibleEmpIds.add(m.member_id);});}
async function loadItems(){var r=await sb.from('event_schedule_items').select('*').eq('tenant_id',tenantId).order('item_date').order('start_time');allItems=r.data||[];}
function getVisibleItems(ds){return allItems.filter(function(it){if(it.item_date!==ds)return false;if(it.calendar_id&&!visibleCalIds.has(it.calendar_id))return false;if(!allEmpsVisible&&it.assigned_to&&!visibleEmpIds.has(it.assigned_to))return false;return true;});}
function saveVisibleCals(){localStorage.setItem('visible_cals_'+tenantId,JSON.stringify([...visibleCalIds]));}
var drawerOpen=false;function toggleMobileDrawer(){drawerOpen=!drawerOpen;document.getElementById('mobileDrawer').classList.toggle('open',drawerOpen);}
function renderMiniCal(){var el=document.getElementById('miniCalSection');var y=miniDate.getFullYear(),mo=miniDate.getMonth();var first=new Date(y,mo,1),sd=first.getDay(),dim=new Date(y,mo+1,0).getDate(),prev=new Date(y,mo,0).getDate();var h='<div class="mini-cal-nav"><button class="mini-cal-btn" onclick="miniPrev()">‚óÄ</button><div class="mini-cal-title">'+MONTHS[mo].substring(0,3)+' '+y+'</div><button class="mini-cal-btn" onclick="miniNext()">‚ñ∂</button></div><div class="mini-grid">';DAYS_S.forEach(function(d){h+='<div class="mini-hdr">'+d+'</div>';});for(var i=0;i<42;i++){var dn,cls='mini-day',dt;if(i<sd){dn=prev-sd+i+1;dt=new Date(y,mo-1,dn);cls+=' other';}else if(i-sd>=dim){dn=i-sd-dim+1;dt=new Date(y,mo+1,dn);cls+=' other';}else{dn=i-sd+1;dt=new Date(y,mo,dn);}if(isToday(dt))cls+=' today';if(dateStr(dt)===dateStr(viewDate))cls+=' selected';h+='<div class="'+cls+'" onclick="miniClick(\''+dateStr(dt)+'\')">'+dn+'</div>';}h+='</div>';el.innerHTML=h;}function miniPrev(){miniDate.setMonth(miniDate.getMonth()-1);renderMiniCal();}function miniNext(){miniDate.setMonth(miniDate.getMonth()+1);renderMiniCal();}function miniClick(ds){viewDate=new Date(ds+'T12:00:00');if(currentView==='month'){viewDate=new Date(ds+'T12:00:00');miniDate=new Date(viewDate);}render();renderMiniCal();}
function renderCalLayers(){var h='';allCalendars.forEach(function(c){var on=visibleCalIds.has(c.calendar_id);var cnt=allItems.filter(function(it){return it.calendar_id===c.calendar_id;}).length;h+='<div class="cal-layer'+(on?' active-glow':'')+'" style="'+(on?'color:'+c.color+';':'')+'" onclick="toggleCal(\''+c.calendar_id+'\')">';h+='<div class="cal-layer-check'+(on?' on':'')+'" style="border-color:'+c.color+';'+(on?'background:'+c.color+';':'')+'"></div>';h+='<div class="cal-layer-name">'+c.calendar_name+'</div>';if(cnt)h+='<div class="cal-layer-count">'+cnt+'</div>';h+='<div class="cal-layer-actions"><button class="cal-layer-btn" onclick="event.stopPropagation();openEditCal(\''+c.calendar_id+'\')">‚úé</button></div>';h+='</div>';});document.getElementById('calLayerList').innerHTML=h;var ml=document.getElementById('mCalLayerList');if(ml)ml.innerHTML=h;}
function renderEmpFilters(){var h='<div class="emp-row" onclick="toggleAllEmps()"><div class="emp-avatar" style="background:var(--accent-primary);font-size:8px;">ALL</div><div class="emp-name" style="font-weight:600;">All Members</div><div class="emp-chk'+(allEmpsVisible?' on':'')+'"></div></div>';allMembers.forEach(function(m,i){var on=visibleEmpIds.has(m.member_id);var col=EMP_COLORS[i%EMP_COLORS.length];var initials=((m.first_name||'')[0]||'')+((m.last_name||'')[0]||'');h+='<div class="emp-row" onclick="toggleEmp(\''+m.member_id+'\')">';h+='<div class="emp-avatar" style="background:'+col+';">'+initials.toUpperCase()+'</div>';h+='<div class="emp-name">'+((m.first_name||'')+' '+(m.last_name||'')).trim()+'</div>';h+='<div class="emp-chk'+(on?' on':'')+'"></div></div>';});document.getElementById('empFilterList').innerHTML=h;var ml=document.getElementById('mEmpFilterList');if(ml)ml.innerHTML=h;}
function toggleCal(id){if(visibleCalIds.has(id))visibleCalIds.delete(id);else visibleCalIds.add(id);saveVisibleCals();renderCalLayers();render();}function toggleEmp(id){if(visibleEmpIds.has(id))visibleEmpIds.delete(id);else visibleEmpIds.add(id);allEmpsVisible=allMembers.every(function(m){return visibleEmpIds.has(m.member_id);});renderEmpFilters();render();}function toggleAllEmps(){if(allEmpsVisible){visibleEmpIds.clear();allEmpsVisible=false;}else{allMembers.forEach(function(m){visibleEmpIds.add(m.member_id);});allEmpsVisible=true;}renderEmpFilters();render();}
function setView(v){currentView=v;document.getElementById('monthView').style.display=v==='month'?'flex':'none';document.getElementById('weekView').style.display=v==='week'?'flex':'none';document.getElementById('dayView').style.display=v==='day'?'flex':'none';['dVM','dVW','dVD','mVM','mVW','mVD'].forEach(function(id){var e=document.getElementById(id);if(e)e.classList.remove('active');});var map={month:'M',week:'W',day:'D'};var dl=document.getElementById('dV'+map[v]);if(dl)dl.classList.add('active');var ml=document.getElementById('mV'+map[v]);if(ml)ml.classList.add('active');render();}
function navPrev(){if(currentView==='month')viewDate.setMonth(viewDate.getMonth()-1);else if(currentView==='week')viewDate.setDate(viewDate.getDate()-7);else viewDate.setDate(viewDate.getDate()-1);miniDate=new Date(viewDate);render();renderMiniCal();}function navNext(){if(currentView==='month')viewDate.setMonth(viewDate.getMonth()+1);else if(currentView==='week')viewDate.setDate(viewDate.getDate()+7);else viewDate.setDate(viewDate.getDate()+1);miniDate=new Date(viewDate);render();renderMiniCal();}function goToday(){viewDate=new Date();miniDate=new Date();render();renderMiniCal();}
function render(){var title='';if(currentView==='month'){title=MONTHS[viewDate.getMonth()]+' '+viewDate.getFullYear();renderMonth();}else if(currentView==='week'){var ws=getWeekStart(viewDate),we=new Date(ws);we.setDate(we.getDate()+6);var sm=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];title=sm[ws.getMonth()]+' '+ws.getDate()+' ‚Äì '+sm[we.getMonth()]+' '+we.getDate()+', '+we.getFullYear();renderWeek();}else{title=DAYS[viewDate.getDay()]+', '+MONTHS[viewDate.getMonth()]+' '+viewDate.getDate()+', '+viewDate.getFullYear();renderDay();}document.getElementById('schedTitle').textContent=title;}
function stripHTML(it){var col=getCalColor(it.calendar_id);var bg=col+'22';return '<div class="cal-strip" style="border-left-color:'+col+';background:'+bg+';color:var(--text-primary);" onclick="event.stopPropagation();openEditItem(\''+it.schedule_item_id+'\')" title="'+it.title+(it.start_time?' '+it.start_time.substring(0,5):'')+'">'+it.title+'</div>';}
function renderMonth(){var el=document.getElementById('monthView'),y=viewDate.getFullYear(),mo=viewDate.getMonth();var first=new Date(y,mo,1),sd=first.getDay(),dim=new Date(y,mo+1,0).getDate(),prev=new Date(y,mo,0).getDate();var h='<div class="cal-header">';DAYS.forEach(function(d){h+='<div class="cal-header-day">'+d+'</div>';});h+='</div><div class="cal-grid">';for(var i=0;i<42;i++){var dn,ds,cls='cal-cell';if(i<sd){dn=prev-sd+i+1;ds=dateStr(new Date(y,mo-1,dn));cls+=' other';}else if(i-sd>=dim){dn=i-sd-dim+1;ds=dateStr(new Date(y,mo+1,dn));cls+=' other';}else{dn=i-sd+1;var cd=new Date(y,mo,dn);ds=dateStr(cd);if(isToday(cd))cls+=' today';}var items=getVisibleItems(ds);h+='<div class="'+cls+'" onclick="clickDate(\''+ds+'\')">';h+='<div class="cal-day-num">'+dn+'</div><div class="cal-events">';items.forEach(function(it){h+=stripHTML(it);});h+='</div></div>';}h+='</div>';el.innerHTML=h;}
function renderWeek(){var el=document.getElementById('weekView'),ws=getWeekStart(viewDate);var h='<div class="week-header"><div class="week-header-day"></div>';for(var d=0;d<7;d++){var dd=new Date(ws);dd.setDate(dd.getDate()+d);h+='<div class="week-header-day'+(isToday(dd)?' today':'')+'"><span class="wh-num">'+dd.getDate()+'</span>'+DAYS[d]+'</div>';}h+='</div><div class="week-scroll"><div class="week-grid">';for(var hr=6;hr<22;hr++){var lb=hr<12?(hr===0?'12a':hr+'a'):(hr===12?'12p':(hr-12)+'p');h+='<div class="week-time">'+lb+'</div>';for(var d=0;d<7;d++){var dd=new Date(ws);dd.setDate(dd.getDate()+d);var ds=dateStr(dd);var items=getVisibleItems(ds).filter(function(it){if(!it.start_time)return hr===8;return parseInt(it.start_time.split(':')[0])===hr;});h+='<div class="week-cell'+(isToday(dd)?' today-col':'')+'" onclick="clickDate(\''+ds+'\','+hr+')">';items.forEach(function(it){var col=getCalColor(it.calendar_id);h+='<div class="week-ev" style="border-left-color:'+col+';background:'+col+'22;" onclick="event.stopPropagation();openEditItem(\''+it.schedule_item_id+'\')">'+it.title+'</div>';});h+='</div>';}}h+='</div></div>';el.innerHTML=h;}
function renderDay(){var el=document.getElementById('dayView'),ds=dateStr(viewDate);var h='<div class="day-scroll">';for(var hr=6;hr<22;hr++){var lb=hr===0?'12 AM':hr<12?hr+' AM':hr===12?'12 PM':(hr-12)+' PM';var items=getVisibleItems(ds).filter(function(it){if(!it.start_time)return hr===8;return parseInt(it.start_time.split(':')[0])===hr;});h+='<div class="day-hour"><div class="day-hour-label">'+lb+'</div><div class="day-hour-content" onclick="clickDate(\''+ds+'\','+hr+')">';items.forEach(function(it){var col=getCalColor(it.calendar_id);var ts=it.start_time?(it.start_time.substring(0,5)+(it.end_time?' ‚Äì '+it.end_time.substring(0,5):'')):'';h+='<div class="day-ev" style="border-left-color:'+col+';background:'+col+'18;" onclick="event.stopPropagation();openEditItem(\''+it.schedule_item_id+'\')">';h+='<div class="day-ev-title">'+it.title+'</div>';if(ts)h+='<div class="day-ev-meta">'+ts+'</div>';var cn=getCalName(it.calendar_id);if(cn)h+='<div class="day-ev-meta">'+cn+'</div>';if(it.location)h+='<div class="day-ev-meta">üìç '+it.location+'</div>';var a=empName(it.assigned_to);if(a)h+='<div class="day-ev-meta">üë§ '+a+'</div>';h+='</div>';});h+='</div></div>';}h+='</div>';el.innerHTML=h;}
function clickDate(ds,hr){if(currentView==='month'){viewDate=new Date(ds+'T12:00:00');setView('day');}else{openEventModal(ds,hr);}}
function populateSelects(){var cp=document.getElementById('emProject');cp.innerHTML='<option value="">-- None --</option>';allProjects.forEach(function(p){cp.innerHTML+='<option value="'+p.event_project_id+'">'+p.event_name+'</option>';});var ca=document.getElementById('emAssigned');ca.innerHTML='<option value="">-- None --</option>';allMembers.forEach(function(m){ca.innerHTML+='<option value="'+m.member_id+'">'+((m.first_name||'')+' '+(m.last_name||'')).trim()+'</option>';});var cc=document.getElementById('emCalendar');cc.innerHTML='';allCalendars.forEach(function(c){cc.innerHTML+='<option value="'+c.calendar_id+'" style="color:'+c.color+';">'+c.calendar_name+'</option>';});}
function openEventModal(ds,hr){editingItemId=null;populateSelects();document.getElementById('emModalTitle').textContent='Add Event';document.getElementById('emTitle').value='';document.getElementById('emDate').value=ds||dateStr(viewDate);document.getElementById('emStart').value=hr!==undefined?String(hr).padStart(2,'0')+':00':'09:00';document.getElementById('emEnd').value=hr!==undefined?String(Math.min(hr+1,23)).padStart(2,'0')+':00':'10:00';document.getElementById('emCategory').value='meeting';document.getElementById('emCalendar').value=allCalendars.length?allCalendars[0].calendar_id:'';document.getElementById('emProject').value='';document.getElementById('emAssigned').value='';document.getElementById('emLocation').value='';document.getElementById('emNotes').value='';document.getElementById('emDeleteBtn').style.display='none';document.getElementById('eventModal').classList.add('active');}
function openEditItem(id){var it=allItems.find(function(x){return x.schedule_item_id===id;});if(!it)return;editingItemId=id;populateSelects();document.getElementById('emModalTitle').textContent='Edit Event';document.getElementById('emTitle').value=it.title||'';document.getElementById('emDate').value=it.item_date||'';document.getElementById('emStart').value=it.start_time?it.start_time.substring(0,5):'';document.getElementById('emEnd').value=it.end_time?it.end_time.substring(0,5):'';document.getElementById('emCategory').value=it.category||'meeting';document.getElementById('emCalendar').value=it.calendar_id||'';document.getElementById('emProject').value=it.event_project_id||'';document.getElementById('emAssigned').value=it.assigned_to||'';document.getElementById('emLocation').value=it.location||'';document.getElementById('emNotes').value=it.notes||'';document.getElementById('emDeleteBtn').style.display='block';document.getElementById('eventModal').classList.add('active');}
function closeEventModal(){document.getElementById('eventModal').classList.remove('active');}
async function saveScheduleItem(){var title=document.getElementById('emTitle').value.trim(),dt=document.getElementById('emDate').value;if(!title||!dt){showToast('Title and date required');return;}var data={title:title,item_date:dt,category:document.getElementById('emCategory').value,calendar_id:document.getElementById('emCalendar').value||null,start_time:document.getElementById('emStart').value||null,end_time:document.getElementById('emEnd').value||null,event_project_id:document.getElementById('emProject').value||null,assigned_to:document.getElementById('emAssigned').value||null,location:document.getElementById('emLocation').value.trim()||null,notes:document.getElementById('emNotes').value.trim()||null};if(editingItemId){await sb.from('event_schedule_items').update(data).eq('schedule_item_id',editingItemId);showToast('Updated');}else{data.tenant_id=tenantId;data.created_by=userId;await sb.from('event_schedule_items').insert(data);showToast('Added');}closeEventModal();await loadItems();renderCalLayers();render();}
async function deleteScheduleItem(){if(!editingItemId||!confirm('Delete this event?'))return;await sb.from('event_schedule_items').delete().eq('schedule_item_id',editingItemId);closeEventModal();showToast('Deleted');await loadItems();renderCalLayers();render();}
function renderColorPicker(sel){var el=document.getElementById('cmColorPicker');el.innerHTML='';PALETTE.forEach(function(c){el.innerHTML+='<div class="color-swatch'+(c===sel?' picked':'')+'" style="background:'+c+';" onclick="pickColor(\''+c+'\')"></div>';});}
var pickedColor=PALETTE[0];function pickColor(c){pickedColor=c;renderColorPicker(c);}
function openCalModal(){editingCalId=null;document.getElementById('calModalTitle').textContent='New Calendar';document.getElementById('cmName').value='';pickedColor=PALETTE[Math.floor(Math.random()*PALETTE.length)];renderColorPicker(pickedColor);document.getElementById('cmDeleteBtn').style.display='none';document.getElementById('calModal').classList.add('active');}
function openEditCal(id){var c=allCalendars.find(function(x){return x.calendar_id===id;});if(!c)return;editingCalId=id;document.getElementById('calModalTitle').textContent='Edit Calendar';document.getElementById('cmName').value=c.calendar_name;pickedColor=c.color;renderColorPicker(pickedColor);document.getElementById('cmDeleteBtn').style.display=c.is_default?'none':'block';document.getElementById('calModal').classList.add('active');}
function closeCalModal(){document.getElementById('calModal').classList.remove('active');}
async function saveCalendar(){var name=document.getElementById('cmName').value.trim();if(!name){showToast('Name required');return;}if(editingCalId){await sb.from('event_calendars').update({calendar_name:name,color:pickedColor}).eq('calendar_id',editingCalId);showToast('Updated');}else{await sb.from('event_calendars').insert({tenant_id:tenantId,calendar_name:name,color:pickedColor,created_by:userId});showToast('Calendar created');}closeCalModal();await loadCalendars();allCalendars.forEach(function(c){visibleCalIds.add(c.calendar_id);});saveVisibleCals();renderCalLayers();populateSelects();render();}
async function deleteCalendar(){if(!editingCalId||!confirm('Delete this calendar? Events in it will become unlinked.'))return;await sb.from('event_schedule_items').update({calendar_id:null}).eq('calendar_id',editingCalId);await sb.from('event_calendars').delete().eq('calendar_id',editingCalId);closeCalModal();showToast('Deleted');visibleCalIds.delete(editingCalId);saveVisibleCals();await loadCalendars();await loadItems();renderCalLayers();render();}
var tx=0;document.addEventListener('touchstart',function(e){tx=e.touches[0].clientX;},{passive:true});document.addEventListener('touchend',function(e){var dx=e.changedTouches[0].clientX-tx;if(Math.abs(dx)>80){if(dx>0)navPrev();else navNext();}},{passive:true});
async function init(){var s=await checkAuth();if(!s)return;userId=s.user.id;var ue=s.user.email||'';if(ue){var ur=await sb.from('users').select('tenant_id,user_id').eq('email',ue).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}}if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}if(!tenantId){showToast('Could not determine tenant');return;}document.getElementById('dBizName').textContent=ue;document.getElementById('mBizName').textContent=ue;await loadCalendars();await loadProjects();await loadMembers();await loadItems();renderMiniCal();renderCalLayers();renderEmpFilters();populateSelects();render();}
init();
</script>
</body>
</html>
