<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Add Customer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  
  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:0; font-family:system-ui; background:#0b0f14; color:#e8eef6; overflow-x:hidden; visibility:hidden; }
    body.auth-verified { visibility:visible; }
    
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }
    h3 { margin:16px 0 10px; font-size:14px; font-weight:700; color:#60a5fa; text-transform:uppercase; letter-spacing:0.5px; }
    
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:240px; }
    
    .card { 
      background:#0f1621; 
      border:2px solid #223044; 
      border-radius:12px; 
      padding:20px; 
      margin-bottom:16px;
      box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    label { 
      display:block; 
      font-size:12px; 
      color:#9fb0c3; 
      margin-bottom:6px; 
      font-weight:600; 
      text-transform:uppercase; 
      letter-spacing:0.5px; 
    }
    
    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #223044;
      background:#1a2535;
      color:#e8eef6;
      font-size:14px;
      outline:none;
      box-sizing:border-box;
    }
    input:focus, select:focus, textarea:focus { border-color:#3b82f6; }
    
    textarea { min-height:90px; resize:vertical; }
    
    button {
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
      min-height: 44px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button:hover { background:#243648; }
    .primary { 
      background:#3b82f6;
      border-color:#3b82f6;
      color:#fff;
    }
    .primary:hover { 
      background:#2563eb; 
    }
    
    .muted { font-size:12px; color:#9fb0c3; }
    .error { color:#ffb3b3; }
    .success { color:#4ade80; }
    
    /* Mobile Header */
    .mobile-header {
      display: none;
      background: #0f1621;
      border-bottom: 1px solid #223044;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .mobile-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
    }
    
    .mobile-menu-toggle {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: #6b7280;
      font-size: 20px;
      padding: 0;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mobile-header-center {
      flex: 1;
      margin-left: 12px;
    }
    
    .mobile-header-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-header { display: block; }
      
      .main-content {
        padding: 12px !important;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .col {
        min-width: 100%;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-header { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="goBack()">←</button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Add Customer</div>
      </div>
    </div>
  </div>

  <!-- Desktop Header -->
  <div class="desktop-header" style="position:sticky; top:0; z-index:100; background:#0b0f14; border-bottom:1px solid #223044;">
    <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
      <h1 style="margin:0; font-size:32px; font-weight:600;">Add Customer</h1>
      <div style="font-size:14px; color:#9fb0c3;">WorkLogicPro</div>
    </div>
    
    <div style="padding:0 24px 12px;">
      <nav style="display:flex; gap:24px; overflow-x:auto;">
        <a href="dashboard-business.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Dashboard</a>
        <a href="dashboard-customer-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
        <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
        <a href="dashboard-settings.html" style="padding:12px 0; color:#9fb0c3; text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Settings</a>
      </nav>
    </div>
    
    <div style="padding:0 24px 12px; border-top:1px solid #223044; padding-top:12px;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="goBack()" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Back</button>
        <button onclick="logout()" style="padding:8px 16px; background:transparent; border:1px solid #223044; color:#9fb0c3; border-radius:8px; cursor:pointer; font-size:14px;">Logout</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" style="padding:24px; max-width:1000px; margin:0 auto;">
    <div class="muted" id="hint" style="margin-bottom:16px;">Fill out the form below to add a new customer.</div>

    <div class="card" style="border-left: 4px solid #3b82f6;">
      <h2>Customer Information</h2>
      
      <!-- Customer Basic Info -->
      <h3>Basic Information</h3>
      <div class="row">
        <div class="col">
          <label>First Name *</label>
          <input id="first_name" type="text" placeholder="John" />
        </div>
        <div class="col">
          <label>Last Name *</label>
          <input id="last_name" type="text" placeholder="Smith" />
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Phone Number *</label>
          <input id="phone" type="tel" placeholder="(555) 123-4567" />
        </div>
        <div class="col">
          <label>Email Address</label>
          <input id="email" type="email" placeholder="john@example.com" />
        </div>
      </div>
      
      <!-- Additional Details -->
      <h3 style="margin-top:24px;">Additional Details (Optional)</h3>
      <div class="row">
        <div class="col">
          <label>Company Name</label>
          <input id="company" type="text" placeholder="ABC Corp" />
        </div>
        <div class="col">
          <label>Customer Type</label>
          <select id="customer_type">
            <option value="individual">Individual</option>
            <option value="business">Business</option>
            <option value="fleet">Fleet</option>
          </select>
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Street Address</label>
          <input id="address" type="text" placeholder="123 Main St" />
        </div>
        <div class="col">
          <label>City</label>
          <input id="city" type="text" placeholder="Sacramento" />
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>State / Province</label>
          <input id="state" type="text" placeholder="CA" />
        </div>
        <div class="col">
          <label>ZIP / Postal Code</label>
          <input id="zip" type="text" placeholder="95814" />
        </div>
      </div>
      
      <div class="row" style="margin-top:12px;">
        <div class="col">
          <label>Customer Notes</label>
          <textarea id="notes" placeholder="Preferred contact method, special instructions..."></textarea>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:20px; gap:12px;">
        <button onclick="goBack()">Cancel</button>
        <button class="primary" onclick="saveCustomer()">Save Customer</button>
      </div>

      <div id="msg" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const REST_BASE = `${API_BASE}/rest/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let AUTH = null;
let TENANT_ID = null;

function goBack(){
  window.history.back();
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if (!token) return null;

  const res = await fetch(`${API_BASE}/auth/v1/user`, {
    headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
  });

  if (!res.ok) return null;
  const user = await res.json();
  
  TENANT_ID = user?.user_metadata?.tenant_id || null;
  return token;
}

async function saveCustomer(){
  const msg = document.getElementById('msg');
  msg.textContent = '';
  msg.className = '';
  
  const firstName = document.getElementById('first_name').value.trim();
  const lastName = document.getElementById('last_name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  
  if(!firstName || !lastName){
    msg.textContent = 'First name and last name are required';
    msg.className = 'error';
    return;
  }
  
  if(!phone){
    msg.textContent = 'Phone number is required';
    msg.className = 'error';
    return;
  }
  
  try {
    msg.textContent = 'Saving customer...';
    msg.className = 'muted';
    
    const data = {
      tenant_id: TENANT_ID,
      first_name: firstName,
      last_name: lastName,
      phone: phone,
      email: document.getElementById('email').value.trim() || null,
      company_name: document.getElementById('company').value.trim() || null,
      customer_type: document.getElementById('customer_type').value || 'individual',
      address: document.getElementById('address').value.trim() || null,
      city: document.getElementById('city').value.trim() || null,
      state: document.getElementById('state').value.trim() || null,
      zip: document.getElementById('zip').value.trim() || null,
      notes: document.getElementById('notes').value.trim() || null
    };
    
    const res = await fetch(`${REST_BASE}/customers`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${AUTH}`,
        'apikey': ANON_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(data)
    });
    
    if(!res.ok){
      const err = await res.text();
      throw new Error(err);
    }
    
    msg.textContent = '✓ Customer saved successfully! Redirecting...';
    msg.className = 'success';
    
    setTimeout(() => {
      location.href = 'dashboard-customer-search.html';
    }, 1000);
    
  } catch(err){
    console.error('Save error:', err);
    msg.textContent = `Error: ${err.message}`;
    msg.className = 'error';
  }
}

async function load(){
  const token = await validateAuth();
  if (!token) {
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
    return;
  }
  
  AUTH = token;
  document.body.classList.add('auth-verified');
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", load);
} else {
  load();
}
</script>

</body>
</html>
