<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="themes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="employee-utils.js"></script>

  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
    }
    /* Core themes */
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="blue-light"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }
    [data-theme="slate-dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="slate-light"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; }
    [data-theme="ocean-dark"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="ocean-light"] { --bg-primary: #f0fdfa; --bg-secondary: #e0f7f4; --bg-card: #ffffff; --bg-hover: #ccfbf1; --border-default: #99f6e4; --text-primary: #134e4a; --text-secondary: #2d6a66; --accent-primary: #0d9488; --accent-light: #14b8a6; }
    [data-theme="midnight-dark"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="lavender-light"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; }
    [data-theme="forest-dark"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="mint-light"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="crimson-dark"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; }
    [data-theme="coral-light"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; }
    [data-theme="amber-dark"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; }
    [data-theme="honey-light"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; }
    [data-theme="rose-dark"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; }
    [data-theme="sky-light"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="cyber-dark"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; }
    [data-theme="sand-light"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; }
    /* Backwards compatibility */
    [data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="lavender"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; }
    [data-theme="forest"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="mint"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="crimson"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; }
    [data-theme="coral"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; }
    [data-theme="amber"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; }
    [data-theme="honey"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; }
    [data-theme="rose"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; }
    [data-theme="sky"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="cyber"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; }
    [data-theme="sand"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; }
    [data-theme="slate"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="ocean"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="light-blue"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding-bottom: 140px; }

    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }

    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    .mobile-header-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .mobile-header-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px 12px 12px; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); border-radius: 8px; cursor: pointer; }

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }

    .content { padding: 20px; max-width: 900px; margin: 0 auto; }

    .card { background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: 14px; padding: 20px; margin-bottom: 16px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .card-header h2 { margin: 0; font-size: 18px; font-weight: 700; }
    .card-icon { font-size: 20px; color: var(--text-secondary); transition: transform 0.2s; }
    .card-header.active .card-icon { transform: rotate(180deg); }
    .card-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .card-content.active { max-height: 3000px; }
    .card-inner { padding-top: 20px; }

    .section-title { font-size: 14px; color: var(--accent-light); border-bottom: 1px solid var(--border-default); padding-bottom: 8px; margin-bottom: 16px; }

    .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border-default); gap: 16px; }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { font-size: 14px; font-weight: 500; }
    .setting-desc { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

    input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="date"], textarea, select {
      padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; width: 220px;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary); }
    textarea { min-height: 80px; resize: vertical; }

    input[type="color"] { width: 50px; height: 40px; padding: 4px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); cursor: pointer; }

    .btn { padding: 12px 20px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; cursor: pointer; }
    .btn:hover { background: var(--bg-hover); }
    .btn-primary { background: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-danger { border-color: #991b1b; color: #991b1b; }

    .success { color: #10b981; font-size: 12px; margin-top: 8px; }
    .error { color: #991b1b; font-size: 12px; margin-top: 8px; }

    .employee-grid { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
    .emp-strip { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .emp-strip:hover { border-color: var(--accent-primary); background: var(--bg-hover); }
    .emp-avatar { width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: #fff; flex-shrink: 0; }
    .emp-info { flex: 1; min-width: 0; }
    .emp-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .emp-role { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; }
    .emp-arrow { font-size: 24px; color: var(--text-secondary); }

    .color-picker-row { display: flex; align-items: center; gap: 12px; }
    .color-preview { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-default); }
    .color-options { display: flex; gap: 8px; flex-wrap: wrap; }
    .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; opacity: 0.81; }
    .color-option:hover { transform: scale(1.1); opacity: 1; }
    .color-option.selected { border-color: #fff; box-shadow: 0 0 0 2px var(--accent-primary); opacity: 1; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: flex-end; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-default); position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
    .modal-title { font-size: 20px; font-weight: 700; }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px 24px; border-top: 1px solid var(--border-default); }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; }
    .theme-card { background: var(--bg-primary); border: 2px solid var(--border-default); border-radius: 12px; padding: 12px; cursor: pointer; text-align: center; transition: all 0.2s; position: relative; }
    .theme-card:hover { border-color: var(--accent-primary); }
    .theme-card.active { border-color: var(--accent-primary); box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
    .theme-card.locked { opacity: 0.5; cursor: not-allowed; }
    .theme-card.locked::after { content: 'ðŸ”’'; position: absolute; top: 8px; right: 8px; font-size: 14px; }
    .theme-preview { height: 50px; border-radius: 6px; margin-bottom: 10px; display: flex; gap: 3px; padding: 6px; }
    .theme-preview div { flex: 1; border-radius: 3px; }
    .theme-name { font-size: 12px; font-weight: 600; }
    .theme-type { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    .theme-card .remove-btn { display: none; position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; border-radius: 50%; background: #991b1b; color: #fff; border: none; font-size: 14px; cursor: pointer; line-height: 1; }
    .theme-card:hover .remove-btn { display: block; }

    .achievement-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 10px; transition: all 0.2s; }
    .achievement-item.unlocked { border-color: var(--accent-primary); background: color-mix(in srgb, var(--accent-primary) 5%, var(--bg-primary)); }
    .achievement-item.unlocked .achievement-dot { background: var(--accent-primary); box-shadow: 0 0 8px var(--accent-primary); }
    .achievement-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--bg-hover); flex-shrink: 0; transition: all 0.3s; }
    .achievement-info { flex: 1; min-width: 0; }
    .achievement-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .achievement-desc { font-size: 12px; color: var(--text-secondary); }
    .achievement-reward { text-align: right; }
    .achievement-theme-mini { width: 36px; height: 24px; border-radius: 4px; display: flex; gap: 1px; padding: 3px; margin-bottom: 4px; }
    .achievement-theme-mini div { flex: 1; border-radius: 2px; }
    .achievement-status { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    .achievement-status.unlocked { color: var(--accent-primary); }
    .achievement-progress { margin-top: 6px; }
    .progress-bar { height: 4px; background: var(--bg-hover); border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent-primary); border-radius: 2px; transition: width 0.3s; }
    .progress-text { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }

    /* Flashy unlock animation */
    .unlock-overlay { position: fixed; inset: 0; z-index: 9999; pointer-events: none; overflow: hidden; }
    .unlock-particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; animation: particleBurst 1.2s ease-out forwards; }
    @keyframes particleBurst { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 50% { opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(1); opacity: 0; } }
    .unlock-flash { position: fixed; inset: 0; background: var(--accent-primary); opacity: 0; animation: flashPulse 0.6s ease-out; z-index: 9998; pointer-events: none; }
    @keyframes flashPulse { 0% { opacity: 0.3; } 100% { opacity: 0; } }
    .unlock-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); border: 2px solid var(--accent-primary); border-radius: 16px; padding: 24px 40px; text-align: center; z-index: 10000; animation: toastPop 0.4s ease-out, toastFade 0.4s ease-in 2s forwards; box-shadow: 0 0 40px var(--accent-primary); }
    @keyframes toastPop { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
    @keyframes toastFade { to { opacity: 0; transform: translate(-50%, -60%) scale(0.9); } }
    .unlock-toast-title { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent-primary); margin-bottom: 8px; }
    .unlock-toast-name { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .unlock-toast-theme { font-size: 13px; color: var(--text-secondary); }

    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block; }
      .setting-row { flex-direction: column; align-items: flex-start; }
      input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="date"], textarea, select { width: 100%; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
      .modal-overlay { align-items: center; padding: 20px; }
      .modal-content { border-radius: 12px; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Settings</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
    </div>
  </div>
  <div class="mobile-header-content" id="mobileHeaderContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='sharklaw-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
      <button onclick="location.href='account.html'">Account</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:32px; font-weight:600;">Settings</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <div style="display:flex; align-items:center; gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px;">
      <a href="dashboard-sharklaw.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Contacts</a>
      <a href="sharklaw-swag.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Swag</a>
      <a href="sharklaw-settings.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Settings</a>
    </nav>
  </div>
</div>

<div class="content">

  <!-- Business Settings -->
  <div class="card">
    <div class="card-header" onclick="toggleCard(this)">
      <h2>Business Information</h2>
      <span class="card-icon">â–¼</span>
    </div>
    <div class="card-content">
      <div class="card-inner">
        <div class="setting-row">
          <div><div class="setting-label">Business Name</div><div class="setting-desc">Your company name</div></div>
          <input type="text" id="businessName" placeholder="Business Name">
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Contact Email</div></div>
          <input type="email" id="contactEmail" placeholder="email@example.com">
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Contact Phone</div></div>
          <input type="tel" id="contactPhone" placeholder="555-555-5555">
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Address</div></div>
          <input type="text" id="businessAddress" placeholder="123 Main St">
        </div>
        <div class="setting-row">
          <div><div class="setting-label">City, State ZIP</div></div>
          <input type="text" id="businessCityStateZip" placeholder="City, ST 12345">
        </div>
        <button class="btn btn-primary" style="margin-top:16px;" onclick="saveBusinessSettings()">Save Business Settings</button>
        <div id="businessSaveMsg"></div>
      </div>
    </div>
  </div>

  <!-- Employees -->
  <div class="card">
    <div class="card-header active" onclick="toggleCard(this)">
      <h2>Team Members</h2>
      <span class="card-icon">â–¼</span>
    </div>
    <div class="card-content active">
      <div class="card-inner">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:16px;">
          <div>
            <span class="setting-desc">Manage team members and their profile colors</span>
            <span id="employeeCount" style="margin-left:8px; background:var(--bg-hover); padding:4px 10px; border-radius:12px; font-size:12px; font-weight:600;">0</span>
          </div>
          <button class="btn btn-primary" onclick="openAddEmployeeModal()">+ Add Team Member</button>
        </div>

        <div id="employeeGrid" class="employee-grid">
          <div style="text-align:center; color:var(--text-secondary); padding:40px;">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements & Themes -->
  <div class="card">
    <div class="card-header active" onclick="toggleCard(this)">
      <h2>Achievements & Themes</h2>
      <span class="card-icon">â–¼</span>
    </div>
    <div class="card-content active">
      <div class="card-inner">
        
        <!-- Current Theme -->
        <div class="section-title">Current Theme</div>
        <div id="currentThemeDisplay" style="display:flex; align-items:center; gap:16px; margin-bottom:24px; padding:16px; background:var(--bg-primary); border-radius:10px; border:1px solid var(--border-default);">
          <div id="currentThemePreview" style="width:60px; height:40px; border-radius:6px; display:flex; gap:2px; padding:4px;"></div>
          <div>
            <div id="currentThemeName" style="font-weight:600; font-size:16px;">Dark Blue</div>
            <div style="font-size:12px; color:var(--text-secondary);">Default Theme</div>
          </div>
        </div>

        <!-- Theme Bank -->
        <div class="section-title">Your Theme Bank <span id="themeBankCount" style="font-size:12px; font-weight:400; color:var(--text-secondary);">(0/10)</span></div>
        <div class="setting-desc" style="margin-bottom:12px;">Unlock themes through achievements. Bank holds 10 themes max.</div>
        <div id="themeBankGrid" class="theme-grid" style="margin-bottom:24px;">
          <div style="text-align:center; color:var(--text-secondary); padding:20px; grid-column:1/-1;">Loading themes...</div>
        </div>

        <!-- Achievements -->
        <div class="section-title">Achievements</div>
        <div class="setting-desc" style="margin-bottom:12px;">Complete actions to unlock new themes!</div>
        <div id="achievementsList" style="display:flex; flex-direction:column; gap:8px;">
          <div style="text-align:center; color:var(--text-secondary); padding:20px;">Loading achievements...</div>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Unlock Effects Container -->
<div id="unlockEffects"></div>

<!-- Add/Edit Employee Modal -->
<div class="modal-overlay" id="employeeModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="employeeModalTitle">Add Team Member</div>
      <button class="modal-close" onclick="closeEmployeeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">First Name *</label>
          <input type="text" id="empFirstName" style="width:100%;" placeholder="John">
        </div>
        <div class="form-group">
          <label class="form-label">Last Name *</label>
          <input type="text" id="empLastName" style="width:100%;" placeholder="Smith">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="empEmail" style="width:100%;" placeholder="john@company.com">
        <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">Required for task assignments</div>
      </div>
      <div class="form-group">
        <label class="form-label">Phone</label>
        <input type="tel" id="empPhone" style="width:100%;" placeholder="555-123-4567">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Department</label>
          <select id="empDepartment" style="width:100%;">
            <option value="">Select...</option>
            <option value="operations">Operations</option>
            <option value="sales">Sales</option>
            <option value="marketing">Marketing</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select id="empRole" style="width:100%;">
            <option value="associate">Associate</option>
            <option value="manager">Manager</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Profile Color</label>
        <div class="setting-desc" style="margin-bottom:12px;">This color represents them on tasks, schedules, and charts</div>
        <div class="color-options" id="colorOptions"></div>
        <input type="hidden" id="empColor" value="#3b82f6">
      </div>
    </div>
    <div class="modal-footer">
      <div style="display:flex; gap:10px;" id="modalFooterAdd">
        <button class="btn btn-primary" style="flex:1;" onclick="saveEmployee()">Add Team Member</button>
        <button class="btn" style="flex:1;" onclick="closeEmployeeModal()">Cancel</button>
      </div>
      <div style="display:none; gap:10px;" id="modalFooterEdit">
        <button class="btn btn-primary" style="flex:1;" onclick="saveEmployee()">Save Changes</button>
        <button class="btn btn-danger" style="flex:1;" id="empDeleteBtn" onclick="deleteEmployee()">Deactivate</button>
        <button class="btn" onclick="closeEmployeeModal()">Cancel</button>
      </div>
      <div id="employeeModalMsg"></div>
    </div>
  </div>
</div>

<div class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a>
  </div>
  <div class="mobile-nav-row three-col">
    <a href="sharklaw-settings.html" class="mobile-nav-btn active">Settings</a>
    <a href="sharklaw-contacts.html" class="mobile-nav-btn">Contacts</a>
    <a href="sharklaw-swag.html" class="mobile-nav-btn">Swag</a>
  </div>
</div>

<script>
const SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let currentTenantId=null,userEmail=null,currentUserRole=null;
let allEmployees=[],editingEmployeeId=null;

// Get employee color from database (using employee-utils.js pattern)
function getEmployeeColorById(empId){
  var emp = allEmployees.find(function(e){ return e.employee_id === empId; });
  if (!emp) return null;
  return emp.color || null;
}

// Save employee color to database
async function saveEmployeeColorToDb(empId, color) {
  var r = await sb.from('employees').update({ color: color }).eq('employee_id', empId);
  if (!r.error) {
    // Update local cache
    var emp = allEmployees.find(function(e){ return e.employee_id === empId; });
    if (emp) emp.color = color;
  }
  return r;
}

var userThemeBankLocal=['dark-blue'];
var themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';if(!userThemeBankLocal.includes(t))t='dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=userThemeBankLocal.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){if(userThemeBankLocal.length<=1)return;themeIndex=(themeIndex+1)%userThemeBankLocal.length;var t=userThemeBankLocal[themeIndex];setTheme(t);}
function setTheme(t){if(!userThemeBankLocal.includes(t)&&t!=='dark-blue')return;document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);themeIndex=userThemeBankLocal.indexOf(t);renderThemeBank();}
function syncLocalThemeBank(){userThemeBankLocal=['dark-blue'].concat(userThemeBank.map(function(t){return t.theme_key;}));userThemeBankLocal=[...new Set(userThemeBankLocal)];}
loadTheme();

function toggleMobileMenu(){document.getElementById('mobileHeaderContent').classList.toggle('expanded');}
function toggleCard(header){header.classList.toggle('active');header.nextElementSibling.classList.toggle('active');}
async function logout(){await sb.auth.signOut();localStorage.clear();location.replace('/');}

// Render color options using COLOR_OPTIONS from employee-utils.js
function renderColorOptions(selectedColor) {
  var container = document.getElementById('colorOptions');
  // Use COLOR_OPTIONS from employee-utils.js if available, otherwise use defaults
  var colors = (typeof COLOR_OPTIONS !== 'undefined') ? COLOR_OPTIONS : [
    { value: '#3b82f6', name: 'Blue' },
    { value: '#22c55e', name: 'Green' },
    { value: '#f97316', name: 'Orange' },
    { value: '#8b5cf6', name: 'Purple' },
    { value: '#ec4899', name: 'Pink' },
    { value: '#14b8a6', name: 'Teal' },
    { value: '#eab308', name: 'Yellow' },
    { value: '#ef4444', name: 'Red' },
    { value: '#6366f1', name: 'Indigo' },
    { value: '#84cc16', name: 'Lime' },
    { value: '#06b6d4', name: 'Cyan' },
    { value: '#a855f7', name: 'Violet' }
  ];
  
  container.innerHTML = colors.map(function(c) {
    var isSelected = c.value === selectedColor;
    return '<div class="color-option' + (isSelected ? ' selected' : '') + '" style="background:' + c.value + ';" data-color="' + c.value + '" title="' + c.name + '" onclick="selectColor(this)"></div>';
  }).join('');
}

async function selectColor(el){
  document.querySelectorAll('.color-option').forEach(function(o){o.classList.remove('selected');});
  el.classList.add('selected');
  var color=el.dataset.color;
  document.getElementById('empColor').value=color;
  
  // If editing, save color immediately to database
  if(editingEmployeeId){
    el.style.transform='scale(1.3)';
    el.style.boxShadow='0 0 12px '+color;
    
    var r = await saveEmployeeColorToDb(editingEmployeeId, color);
    if (r.error) {
      document.getElementById('employeeModalMsg').innerHTML='<span class="error">Error saving color</span>';
    } else {
      // Update the display
      renderEmployees();
    }
    
    setTimeout(function(){el.style.transform='';el.style.boxShadow='';},300);
  }
}

async function checkAuth(){
  var r=await sb.auth.getSession();
  var session=r.data.session;
  if(!session){
    var token=localStorage.getItem('sb_access_token'),refresh=localStorage.getItem('sb_refresh_token');
    if(token&&refresh){var sr=await sb.auth.setSession({access_token:token,refresh_token:refresh});session=sr.data?.session;}
    if(!session){window.location.href='login.html';return null;}
  }
  userEmail=session.user.email;
  return session;
}

function updateEmailDisplay(){
  if(userEmail){
    document.getElementById('desktopBusinessName').textContent=userEmail;
    document.getElementById('mobileBusinessName').textContent=userEmail;
  }
}

async function loadBusinessSettings(){
  if(!currentTenantId)return;
  var r=await sb.from('business_settings').select('*').eq('tenant_id',currentTenantId).single();
  if(r.data){
    document.getElementById('businessName').value=r.data.business_name||'';
    document.getElementById('contactEmail').value=r.data.contact_email||'';
    document.getElementById('contactPhone').value=r.data.contact_phone||'';
    document.getElementById('businessAddress').value=r.data.address||'';
    document.getElementById('businessCityStateZip').value=r.data.city_state_zip||'';
  }
}

async function saveBusinessSettings(){
  var data={
    business_name:document.getElementById('businessName').value.trim()||null,
    contact_email:document.getElementById('contactEmail').value.trim()||null,
    contact_phone:document.getElementById('contactPhone').value.trim()||null,
    address:document.getElementById('businessAddress').value.trim()||null,
    city_state_zip:document.getElementById('businessCityStateZip').value.trim()||null,
    updated_at:new Date().toISOString()
  };
  var r=await sb.from('business_settings').update(data).eq('tenant_id',currentTenantId);
  if(r.error){document.getElementById('businessSaveMsg').innerHTML='<span class="error">Error: '+r.error.message+'</span>';}
  else{document.getElementById('businessSaveMsg').innerHTML='<span class="success">Saved!</span>';setTimeout(function(){document.getElementById('businessSaveMsg').innerHTML='';},3000);}
}

async function loadEmployees(){
  if(!currentTenantId)return;
  // Only load active employees (exclude soft-deleted)
  var r=await sb.from('employees')
    .select('employee_id, first_name, last_name, email, phone, department, role, color, is_active, created_at')
    .eq('tenant_id',currentTenantId)
    .or('is_active.is.null,is_active.eq.true')
    .order('last_name');
  allEmployees=r.data||[];
  renderEmployees();
  updateEmployeeStats();
}

function renderEmployees(){
  var grid=document.getElementById('employeeGrid');
  if(allEmployees.length===0){grid.innerHTML='<div style="text-align:center; color:var(--text-secondary); padding:40px;">No team members yet. Add your first!</div>';return;}
  
  var roleOrder={'owner':1,'manager':2,'admin':3,'sales_manager':2,'staff':4,'technician':4,'sales_consultant':4};
  var sorted=allEmployees.slice().sort(function(a,b){
    var ra=roleOrder[(a.role||'staff').toLowerCase()]||5;
    var rb=roleOrder[(b.role||'staff').toLowerCase()]||5;
    if(ra!==rb)return ra-rb;
    return((a.last_name||'')+(a.first_name||'')).localeCompare((b.last_name||'')+(b.first_name||''));
  });
  
  // Use DEFAULT_EMPLOYEE_COLORS from employee-utils.js for fallback
  var defaultColors = (typeof DEFAULT_EMPLOYEE_COLORS !== 'undefined') ? DEFAULT_EMPLOYEE_COLORS : ['#3b82f6','#22c55e','#f97316','#8b5cf6','#ec4899','#14b8a6','#eab308','#ef4444','#6366f1','#84cc16'];
  
  grid.innerHTML=sorted.map(function(emp, idx){
    var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||'Unknown';
    var initials=((emp.first_name||'?')[0]+((emp.last_name||'')[0]||'')).toUpperCase();
    // Use database color, fallback to default by index
    var color = emp.color || defaultColors[idx % defaultColors.length];
    var role=(emp.role||'staff').replace(/_/g,' ');
    role=role.charAt(0).toUpperCase()+role.slice(1);
    return '<div class="emp-strip" onclick="openEditEmployee(\''+emp.employee_id+'\')">'+
      '<div class="emp-avatar" style="background:'+color+';">'+initials+'</div>'+
      '<div class="emp-info"><div class="emp-name">'+name+'</div><div class="emp-role">'+role+(emp.department?' â€¢ '+emp.department:'')+'</div></div>'+
      '<div class="emp-arrow">â€º</div>'+
      '</div>';
  }).join('');
}

function updateEmployeeStats(){
  document.getElementById('employeeCount').textContent=allEmployees.length;
}

function openAddEmployeeModal(){
  editingEmployeeId=null;
  document.getElementById('employeeModalTitle').textContent='Add Team Member';
  document.getElementById('empFirstName').value='';
  document.getElementById('empLastName').value='';
  document.getElementById('empEmail').value='';
  document.getElementById('empPhone').value='';
  document.getElementById('empDepartment').value='';
  document.getElementById('empRole').value='associate';
  document.getElementById('empColor').value='#3b82f6';
  renderColorOptions('#3b82f6');
  document.getElementById('modalFooterAdd').style.display='flex';
  document.getElementById('modalFooterEdit').style.display='none';
  document.getElementById('employeeModalMsg').innerHTML='';
  document.getElementById('employeeModal').classList.add('active');
}

function openEditEmployee(id){
  var emp=allEmployees.find(function(e){return e.employee_id===id;});
  if(!emp)return;
  editingEmployeeId=id;
  document.getElementById('employeeModalTitle').textContent='Edit Team Member';
  document.getElementById('empFirstName').value=emp.first_name||'';
  document.getElementById('empLastName').value=emp.last_name||'';
  document.getElementById('empEmail').value=emp.email||'';
  document.getElementById('empPhone').value=emp.phone||'';
  document.getElementById('empDepartment').value=emp.department||'';
  document.getElementById('empRole').value=emp.role||'associate';
  
  // Use database color or fallback
  var defaultColors = (typeof DEFAULT_EMPLOYEE_COLORS !== 'undefined') ? DEFAULT_EMPLOYEE_COLORS : ['#3b82f6','#22c55e','#f97316','#8b5cf6','#ec4899','#14b8a6','#eab308','#ef4444','#6366f1','#84cc16'];
  var idx = allEmployees.findIndex(function(e){ return e.employee_id === id; });
  var color = emp.color || defaultColors[idx % defaultColors.length];
  
  document.getElementById('empColor').value=color;
  renderColorOptions(color);
  
  document.getElementById('modalFooterAdd').style.display='none';
  document.getElementById('modalFooterEdit').style.display='flex';
  
  // Only owner can delete
  var isOwner = currentUserRole === 'owner';
  var deleteBtn = document.getElementById('empDeleteBtn');
  if(deleteBtn) deleteBtn.style.display = isOwner ? '' : 'none';
  
  // Only owner can change admin/owner roles
  var roleSelect = document.getElementById('empRole');
  var isProtectedRole = ['admin', 'owner'].includes(emp.role);
  if(isProtectedRole && !isOwner){
    roleSelect.disabled = true;
    roleSelect.title = 'Only owner can change this role';
  } else {
    roleSelect.disabled = false;
    roleSelect.title = '';
  }
  
  // Non-owners can't promote to admin/owner
  if(!isOwner){
    Array.from(roleSelect.options).forEach(function(opt){
      if(['admin', 'owner'].includes(opt.value)){
        opt.disabled = true;
      } else {
        opt.disabled = false;
      }
    });
  } else {
    Array.from(roleSelect.options).forEach(function(opt){
      opt.disabled = false;
    });
  }
  
  document.getElementById('employeeModalMsg').innerHTML='';
  document.getElementById('employeeModal').classList.add('active');
}

function closeEmployeeModal(){
  document.getElementById('employeeModal').classList.remove('active');
  editingEmployeeId=null;
}

async function saveEmployee(){
  var firstName=document.getElementById('empFirstName').value.trim();
  var lastName=document.getElementById('empLastName').value.trim();
  if(!firstName||!lastName){document.getElementById('employeeModalMsg').innerHTML='<span class="error">First and last name required</span>';return;}
  
  var selectedColor=document.getElementById('empColor').value||'#3b82f6';
  var selectedRole=document.getElementById('empRole').value||'associate';
  var employeeEmail=document.getElementById('empEmail').value.trim()||null;
  
  var data={
    first_name:firstName,
    last_name:lastName,
    email:employeeEmail,
    phone:document.getElementById('empPhone').value.trim()||null,
    department:document.getElementById('empDepartment').value||null,
    role:selectedRole,
    color: selectedColor  // Save color to database
  };
  
  try{
    if(editingEmployeeId){
      // Editing existing
      var r=await sb.from('employees').update(data).eq('employee_id',editingEmployeeId);
      if(r.error)throw r.error;
      
      // Also update users table role if employee has email
      if(employeeEmail){
        await sb.from('users').update({ role: selectedRole }).eq('email', employeeEmail);
      }
    }else{
      data.tenant_id=currentTenantId;
      data.is_active=true;
      data.created_at=new Date().toISOString();
      var r=await sb.from('employees').insert(data).select('employee_id');
      if(r.error)throw r.error;
      // Track achievement stat
      await incrementUserStat('team_members_added');
    }
    closeEmployeeModal();
    await loadEmployees();
    await checkAndUnlockAchievements();
  }catch(e){
    document.getElementById('employeeModalMsg').innerHTML='<span class="error">Error: '+(e.message||'Failed')+'</span>';
  }
}

async function incrementUserStat(statName,amount){
  if(!currentUserId||!currentTenantId)return;
  amount=amount||1;
  var r=await sb.from('user_stats').select('*').eq('user_id',currentUserId).single();
  var stats=r.data;
  if(!stats){
    stats={user_id:currentUserId,tenant_id:currentTenantId};
    stats[statName]=amount;
    await sb.from('user_stats').insert(stats);
    userStats=stats;
  }else{
    var update={};
    update[statName]=(stats[statName]||0)+amount;
    update.updated_at=new Date().toISOString();
    await sb.from('user_stats').update(update).eq('user_id',currentUserId);
    userStats[statName]=update[statName];
  }
}

async function deleteEmployee(){
  if(!editingEmployeeId||!confirm('Deactivate this team member? They will be hidden but historical data preserved.'))return;
  try{
    // Soft delete - set is_active to false instead of deleting
    var r=await sb.from('employees').update({ is_active: false }).eq('employee_id',editingEmployeeId);
    if(r.error)throw r.error;
    closeEmployeeModal();
    loadEmployees();
  }catch(e){
    document.getElementById('employeeModalMsg').innerHTML='<span class="error">Error: '+(e.message||'Failed')+'</span>';
  }
}

// =====================================================
// ACHIEVEMENT & THEME SYSTEM
// =====================================================

var currentUserId = null;
var userStats = null;
var userAchievements = [];
var userThemeBank = [];

// Theme definitions with preview colors
var THEMES = {
  'dark-blue': { name: 'Dark Blue', type: 'dark', default: true, bg: '#0b0f14', card: '#1a2535', accent: '#3b82f6', light: '#60a5fa' },
  'blue-light': { name: 'Blue Light', type: 'light', bg: '#f0f5ff', card: '#ffffff', accent: '#2563eb', light: '#3b82f6' },
  'slate-dark': { name: 'Slate Dark', type: 'dark', bg: '#0f172a', card: '#273549', accent: '#64748b', light: '#94a3b8' },
  'slate-light': { name: 'Slate Light', type: 'light', bg: '#f8fafc', card: '#ffffff', accent: '#475569', light: '#64748b' },
  'ocean-dark': { name: 'Ocean Dark', type: 'dark', bg: '#0a1214', card: '#152228', accent: '#14b8a6', light: '#2dd4bf' },
  'ocean-light': { name: 'Ocean Light', type: 'light', bg: '#f0fdfa', card: '#ffffff', accent: '#0d9488', light: '#14b8a6' },
  'midnight-dark': { name: 'Midnight', type: 'dark', bg: '#09090b', card: '#18181d', accent: '#8b5cf6', light: '#a78bfa' },
  'lavender-light': { name: 'Lavender', type: 'light', bg: '#faf5ff', card: '#ffffff', accent: '#7c3aed', light: '#8b5cf6' },
  'forest-dark': { name: 'Forest', type: 'dark', bg: '#071209', card: '#132618', accent: '#22c55e', light: '#4ade80' },
  'mint-light': { name: 'Mint', type: 'light', bg: '#f0fdf4', card: '#ffffff', accent: '#16a34a', light: '#22c55e' },
  'crimson-dark': { name: 'Crimson', type: 'dark', bg: '#120708', card: '#261214', accent: '#dc2626', light: '#ef4444' },
  'coral-light': { name: 'Coral', type: 'light', bg: '#fff5f5', card: '#ffffff', accent: '#dc2626', light: '#ef4444' },
  'amber-dark': { name: 'Amber', type: 'dark', bg: '#120f07', card: '#261f12', accent: '#d97706', light: '#f59e0b' },
  'honey-light': { name: 'Honey', type: 'light', bg: '#fffbeb', card: '#ffffff', accent: '#d97706', light: '#f59e0b' },
  'rose-dark': { name: 'Rose', type: 'dark', bg: '#120709', card: '#261216', accent: '#db2777', light: '#ec4899' },
  'sky-light': { name: 'Sky', type: 'light', bg: '#f0f9ff', card: '#ffffff', accent: '#0284c7', light: '#0ea5e9' },
  'cyber-dark': { name: 'Cyber', type: 'dark', bg: '#0a0a0f', card: '#161622', accent: '#00ffaa', light: '#50ffcc' },
  'sand-light': { name: 'Sand', type: 'light', bg: '#fdfcfb', card: '#ffffff', accent: '#a8a29e', light: '#d6d3d1' },
  // Backwards compatibility aliases
  'midnight': { name: 'Midnight', type: 'dark', bg: '#09090b', card: '#18181d', accent: '#8b5cf6', light: '#a78bfa' },
  'lavender': { name: 'Lavender', type: 'light', bg: '#faf5ff', card: '#ffffff', accent: '#7c3aed', light: '#8b5cf6' },
  'forest': { name: 'Forest', type: 'dark', bg: '#071209', card: '#132618', accent: '#22c55e', light: '#4ade80' },
  'mint': { name: 'Mint', type: 'light', bg: '#f0fdf4', card: '#ffffff', accent: '#16a34a', light: '#22c55e' },
  'crimson': { name: 'Crimson', type: 'dark', bg: '#120708', card: '#261214', accent: '#dc2626', light: '#ef4444' },
  'coral': { name: 'Coral', type: 'light', bg: '#fff5f5', card: '#ffffff', accent: '#dc2626', light: '#ef4444' },
  'amber': { name: 'Amber', type: 'dark', bg: '#120f07', card: '#261f12', accent: '#d97706', light: '#f59e0b' },
  'honey': { name: 'Honey', type: 'light', bg: '#fffbeb', card: '#ffffff', accent: '#d97706', light: '#f59e0b' },
  'rose': { name: 'Rose', type: 'dark', bg: '#120709', card: '#261216', accent: '#db2777', light: '#ec4899' },
  'sky': { name: 'Sky', type: 'light', bg: '#f0f9ff', card: '#ffffff', accent: '#0284c7', light: '#0ea5e9' },
  'cyber': { name: 'Cyber', type: 'dark', bg: '#0a0a0f', card: '#161622', accent: '#00ffaa', light: '#50ffcc' },
  'sand': { name: 'Sand', type: 'light', bg: '#fdfcfb', card: '#ffffff', accent: '#a8a29e', light: '#d6d3d1' },
  'slate': { name: 'Slate', type: 'dark', bg: '#0f172a', card: '#273549', accent: '#64748b', light: '#94a3b8' },
  'ocean': { name: 'Ocean', type: 'dark', bg: '#0a1214', card: '#152228', accent: '#14b8a6', light: '#2dd4bf' },
  'light-blue': { name: 'Blue Light', type: 'light', bg: '#f0f5ff', card: '#ffffff', accent: '#2563eb', light: '#3b82f6' }
};

// Achievement definitions
var ACHIEVEMENTS = [
  { key: 'first_message', name: 'First Words', desc: 'Send your first message', theme: 'blue-light', stat: 'messages_sent', target: 1, difficulty: 'easy' },
  { key: 'first_task', name: 'Task Starter', desc: 'Create your first task', theme: 'slate-dark', stat: 'tasks_created', target: 1, difficulty: 'easy' },
  { key: 'first_contact', name: 'People Person', desc: 'Add your first contact', theme: 'slate-light', stat: 'contacts_added', target: 1, difficulty: 'easy' },
  { key: 'first_appointment', name: 'On the Books', desc: 'Create your first appointment', theme: 'ocean-dark', stat: 'appointments_created', target: 1, difficulty: 'easy' },
  { key: 'first_complete', name: 'Done Deal', desc: 'Complete your first task', theme: 'ocean-light', stat: 'tasks_completed', target: 1, difficulty: 'easy' },
  { key: 'task_10', name: 'Task Tackler', desc: 'Complete 10 tasks', theme: 'midnight-dark', stat: 'tasks_completed', target: 10, difficulty: 'medium' },
  { key: 'appointments_10', name: 'Fully Booked', desc: 'Complete 10 appointments', theme: 'lavender-light', stat: 'appointments_completed', target: 10, difficulty: 'medium' },
  { key: 'contacts_25', name: 'Rolodex', desc: 'Add 25 contacts', theme: 'forest-dark', stat: 'contacts_added', target: 25, difficulty: 'medium' },
  { key: 'messages_25', name: 'Messenger', desc: 'Send 25 messages', theme: 'mint-light', stat: 'messages_sent', target: 25, difficulty: 'medium' },
  { key: 'streak_7', name: 'Consistency', desc: '7-day login streak', theme: 'crimson-dark', stat: 'current_login_streak', target: 7, difficulty: 'medium' },
  { key: 'team_3', name: 'Team Player', desc: 'Add 3 team members', theme: 'coral-light', stat: 'team_members_added', target: 3, difficulty: 'medium' },
  { key: 'task_50', name: 'Task Master', desc: 'Complete 50 tasks', theme: 'amber-dark', stat: 'tasks_completed', target: 50, difficulty: 'hard' },
  { key: 'appointments_100', name: 'Appointment King', desc: 'Complete 100 appointments', theme: 'honey-light', stat: 'appointments_completed', target: 100, difficulty: 'hard' },
  { key: 'contacts_100', name: 'Networking Pro', desc: 'Add 100 contacts', theme: 'rose-dark', stat: 'contacts_added', target: 100, difficulty: 'hard' },
  { key: 'streak_30', name: 'Month Strong', desc: '30-day login streak', theme: 'sky-light', stat: 'longest_login_streak', target: 30, difficulty: 'hard' },
  { key: 'speed_5', name: 'Speed Demon', desc: 'Complete 5 tasks in one day', theme: 'cyber-dark', stat: 'tasks_completed_today', target: 5, difficulty: 'hard' },
  { key: 'early_10', name: 'Early Bird', desc: 'Login before 7am 10 times', theme: 'sand-light', stat: 'early_bird_count', target: 10, difficulty: 'hard' }
];

function renderThemePreview(themeKey, size) {
  var t = THEMES[themeKey];
  if (!t) return '';
  var s = size === 'large' ? 'width:60px;height:40px;' : 'width:36px;height:24px;';
  return '<div style="'+s+'border-radius:6px;display:flex;gap:2px;padding:4px;background:'+t.bg+';">' +
    '<div style="flex:1;border-radius:2px;background:'+t.card+';"></div>' +
    '<div style="flex:1;border-radius:2px;background:'+t.accent+';"></div>' +
    '<div style="flex:1;border-radius:2px;background:'+t.light+';"></div></div>';
}

async function loadUserStats() {
  if (!currentUserId || !currentTenantId) return;
  var r = await sb.from('user_stats').select('*').eq('user_id', currentUserId).single();
  if (r.data) {
    userStats = r.data;
  } else {
    userStats = { user_id: currentUserId, tenant_id: currentTenantId };
    await sb.from('user_stats').insert(userStats);
  }
}

async function loadUserAchievements() {
  if (!currentUserId) return;
  var r = await sb.from('user_achievements').select('*').eq('user_id', currentUserId);
  userAchievements = r.data || [];
}

async function loadUserThemeBank() {
  if (!currentUserId) return;
  var r = await sb.from('user_theme_bank').select('*').eq('user_id', currentUserId);
  userThemeBank = r.data || [];
  syncLocalThemeBank();
}

function isThemeUnlocked(themeKey) {
  if (themeKey === 'dark-blue') return true;
  return userAchievements.some(function(a) { return a.theme_key === themeKey; });
}

function isThemeInBank(themeKey) {
  if (themeKey === 'dark-blue') return true;
  return userThemeBank.some(function(t) { return t.theme_key === themeKey; });
}

function isAchievementUnlocked(achievementKey) {
  return userAchievements.some(function(a) { return a.achievement_key === achievementKey; });
}

function getAchievementProgress(achievement) {
  if (!userStats) return 0;
  return userStats[achievement.stat] || 0;
}

async function addThemeToBank(themeKey) {
  if (userThemeBank.length >= 10) {
    alert('Theme bank is full! Remove a theme first.');
    return false;
  }
  if (isThemeInBank(themeKey)) return true;
  
  var r = await sb.from('user_theme_bank').insert({
    user_id: currentUserId,
    tenant_id: currentTenantId,
    theme_key: themeKey
  });
  if (!r.error) {
    userThemeBank.push({ theme_key: themeKey });
    syncLocalThemeBank();
    renderThemeBank();
    return true;
  }
  return false;
}

async function removeThemeFromBank(themeKey) {
  if (themeKey === 'dark-blue') return;
  var currentTheme = localStorage.getItem('app-theme') || 'dark-blue';
  if (currentTheme === themeKey) {
    setTheme('dark-blue');
  }
  
  var r = await sb.from('user_theme_bank').delete().eq('user_id', currentUserId).eq('theme_key', themeKey);
  if (!r.error) {
    userThemeBank = userThemeBank.filter(function(t) { return t.theme_key !== themeKey; });
    syncLocalThemeBank();
    renderThemeBank();
  }
}

function renderThemeBank() {
  var grid = document.getElementById('themeBankGrid');
  var bankThemes = ['dark-blue'].concat(userThemeBank.map(function(t) { return t.theme_key; }));
  bankThemes = [...new Set(bankThemes)];
  bankThemes = bankThemes.filter(function(key) { return THEMES[key]; });
  
  var count = bankThemes.length - 1;
  document.getElementById('themeBankCount').textContent = '(' + count + '/10)';
  
  var currentTheme = localStorage.getItem('app-theme') || 'dark-blue';
  
  grid.innerHTML = bankThemes.map(function(key) {
    var t = THEMES[key];
    if (!t) return '';
    var isActive = currentTheme === key;
    var isDefault = key === 'dark-blue';
    return '<div class="theme-card' + (isActive ? ' active' : '') + '" onclick="setTheme(\'' + key + '\')">' +
      (!isDefault ? '<button class="remove-btn" onclick="event.stopPropagation();removeThemeFromBank(\'' + key + '\')">&times;</button>' : '') +
      '<div class="theme-preview" style="background:' + t.bg + ';">' +
        '<div style="background:' + t.card + ';"></div>' +
        '<div style="background:' + t.accent + ';"></div>' +
        '<div style="background:' + t.light + ';"></div>' +
      '</div>' +
      '<div class="theme-name">' + t.name + '</div>' +
      '<div class="theme-type">' + t.type + '</div>' +
    '</div>';
  }).join('');
  
  var ct = THEMES[currentTheme] || THEMES['dark-blue'];
  document.getElementById('currentThemePreview').innerHTML = 
    '<div style="flex:1;border-radius:3px;background:' + ct.card + ';"></div>' +
    '<div style="flex:1;border-radius:3px;background:' + ct.accent + ';"></div>' +
    '<div style="flex:1;border-radius:3px;background:' + ct.light + ';"></div>';
  document.getElementById('currentThemePreview').style.background = ct.bg;
  document.getElementById('currentThemeName').textContent = ct.name;
}

function renderAchievements() {
  var list = document.getElementById('achievementsList');
  
  list.innerHTML = ACHIEVEMENTS.map(function(ach) {
    var unlocked = isAchievementUnlocked(ach.key);
    var progress = getAchievementProgress(ach);
    var pct = Math.min(100, Math.round((progress / ach.target) * 100));
    var t = THEMES[ach.theme];
    var inBank = isThemeInBank(ach.theme);
    
    return '<div class="achievement-item' + (unlocked ? ' unlocked' : '') + '">' +
      '<div class="achievement-dot"></div>' +
      '<div class="achievement-info">' +
        '<div class="achievement-name">' + ach.name + '</div>' +
        '<div class="achievement-desc">' + ach.desc + '</div>' +
        (!unlocked ? '<div class="achievement-progress"><div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%;"></div></div><div class="progress-text">' + progress + '/' + ach.target + '</div></div>' : '') +
      '</div>' +
      '<div class="achievement-reward">' +
        '<div class="achievement-theme-mini" style="background:' + t.bg + ';">' +
          '<div style="background:' + t.card + ';"></div>' +
          '<div style="background:' + t.accent + ';"></div>' +
          '<div style="background:' + t.light + ';"></div>' +
        '</div>' +
        '<div class="achievement-status' + (unlocked ? ' unlocked' : '') + '">' + 
          (unlocked ? (inBank ? 'IN BANK' : '<span style="cursor:pointer;text-decoration:underline;" onclick="addThemeToBank(\'' + ach.theme + '\')">+ ADD</span>') : ach.difficulty) + 
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

function showAchievementUnlock(achievement) {
  var t = THEMES[achievement.theme];
  var container = document.getElementById('unlockEffects');
  
  var flash = document.createElement('div');
  flash.className = 'unlock-flash';
  flash.style.background = t.accent;
  container.appendChild(flash);
  
  var overlay = document.createElement('div');
  overlay.className = 'unlock-overlay';
  var colors = [t.accent, t.light, t.card, '#ffffff'];
  for (var i = 0; i < 40; i++) {
    var particle = document.createElement('div');
    particle.className = 'unlock-particle';
    particle.style.left = '50%';
    particle.style.top = '50%';
    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
    var angle = (Math.random() * 360) * Math.PI / 180;
    var distance = 100 + Math.random() * 200;
    particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
    particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
    particle.style.animationDelay = (Math.random() * 0.2) + 's';
    particle.style.width = (4 + Math.random() * 8) + 'px';
    particle.style.height = particle.style.width;
    overlay.appendChild(particle);
  }
  container.appendChild(overlay);
  
  var toast = document.createElement('div');
  toast.className = 'unlock-toast';
  toast.style.borderColor = t.accent;
  toast.style.boxShadow = '0 0 40px ' + t.accent;
  toast.innerHTML = '<div class="unlock-toast-title">Theme Unlocked</div>' +
    '<div class="unlock-toast-name">' + achievement.name + '</div>' +
    '<div class="unlock-toast-theme">' + t.name + '</div>';
  container.appendChild(toast);
  
  setTimeout(function() {
    container.innerHTML = '';
  }, 2500);
}

async function checkAndUnlockAchievements() {
  if (!userStats) return;
  
  for (var i = 0; i < ACHIEVEMENTS.length; i++) {
    var ach = ACHIEVEMENTS[i];
    if (isAchievementUnlocked(ach.key)) continue;
    
    var progress = userStats[ach.stat] || 0;
    if (progress >= ach.target) {
      var r = await sb.from('user_achievements').insert({
        user_id: currentUserId,
        tenant_id: currentTenantId,
        achievement_key: ach.key,
        theme_key: ach.theme
      });
      if (!r.error) {
        userAchievements.push({ achievement_key: ach.key, theme_key: ach.theme });
        if (userThemeBank.length < 10) {
          await addThemeToBank(ach.theme);
        }
        showAchievementUnlock(ach);
        renderAchievements();
        renderThemeBank();
        break;
      }
    }
  }
}

async function init(){
  var session=await checkAuth();
  if(!session)return;
  var email=session.user?.email;
  if(email){
    var r=await sb.from('users').select('user_id, tenant_id, role').eq('email',email).single();
    if(r.data){
      currentTenantId=r.data.tenant_id;
      currentUserId=r.data.user_id;
      currentUserRole=r.data.role||null;
    }
  }
  if(!currentTenantId){
    var r=await sb.from('business_settings').select('tenant_id').limit(1).single();
    if(r.data?.tenant_id)currentTenantId=r.data.tenant_id;
  }
  if(!currentTenantId){console.error('No tenant');return;}
  
  // Also check employees table for role if not set
  if(!currentUserRole && email){
    var empR=await sb.from('employees').select('role').eq('email',email).single();
    if(empR.data?.role) currentUserRole=empR.data.role;
  }
  
  // Access control: only owner and admin can access Settings
  var allowedRoles = ['owner', 'admin'];
  if(!allowedRoles.includes(currentUserRole)){
    alert('Access denied. Only owners and admins can access settings.');
    window.location.href = 'dashboard-sharklaw.html';
    return;
  }
  
  updateEmailDisplay();
  await loadBusinessSettings();
  await loadEmployees();
  
  if(currentUserId){
    await loadUserStats();
    await loadUserAchievements();
    await loadUserThemeBank();
    renderThemeBank();
    renderAchievements();
    await checkAndUnlockAchievements();
  }
}

init();
</script>
</body>
</html>
