<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Work Orders • WorkLogic Pro</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a30;
      --card2:#111f3a;
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --brand:#7aa7ff;
      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --info:#60a5fa;
      --chip:#152546;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:24px;
      --pad:16px;
      --pad2:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 30% -10%, rgba(122,167,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(45,212,191,.16), transparent 60%),
        linear-gradient(180deg, #070b14 0%, var(--bg) 60%, #070b14 100%);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:16px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(122,167,255,.9), rgba(45,212,191,.8));
      box-shadow:var(--shadow);
    }
    .title h1{font-size:18px;margin:0;letter-spacing:.2px}
    .title p{font-size:12px;margin:2px 0 0;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      appearance:none;border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;box-shadow:none;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight:600;font-size:13px;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(122,167,255,.4); background:rgba(122,167,255,.14)}
    .btn.primary:hover{background:rgba(122,167,255,.18)}
    .btn.danger{border-color:rgba(251,113,133,.35); background:rgba(251,113,133,.12)}
    .btn.danger:hover{background:rgba(251,113,133,.16)}
    .grid{
      display:grid;grid-template-columns: 1.3fr .7fr;
      gap:16px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.10);
    }
    .card .hd h2{margin:0;font-size:14px;letter-spacing:.2px}
    .card .hd .sub{color:var(--muted);font-size:12px}
    .card .bd{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(159,176,208,.7)}
    .stack{display:grid;gap:10px}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:12px;color:var(--muted);
    }
    .mono{font-family:var(--mono)}
    .err{
      margin-top:10px;
      background:rgba(251,113,133,.12);
      border:1px solid rgba(251,113,133,.30);
      color:#ffd6dd;
      padding:10px 12px;border-radius:14px;
      font-size:12px;line-height:1.35;
      white-space:pre-wrap;
    }

    /* Table / cards */
    .table{
      width:100%;
      border-collapse:collapse;
    }
    .table th, .table td{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:13px;
    }
    .table th{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .trbtn{
      cursor:pointer;
      transition:background .15s ease;
    }
    .trbtn:hover{background:rgba(255,255,255,.04)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:700;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .b-new .dot,.b-open .dot{background:#94a3b8}
    .b-scheduled .dot{background:var(--info)}
    .b-in_progress .dot{background:var(--warn)}
    .b-waiting .dot,.b-waiting_parts .dot{background:var(--warn)}
    .b-completed .dot{background:var(--ok)}
    .b-cancelled .dot{background:var(--bad)}
    .muted{color:var(--muted)}
    .kpi{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
      margin-top:12px;
    }
    .kpi .k{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:18px;
      padding:12px;
    }
    .k .l{font-size:12px;color:var(--muted)}
    .k .v{font-size:18px;font-weight:800;margin-top:6px}
    @media (max-width: 520px){
      .kpi{grid-template-columns:1fr}
      .hide-sm{display:none}
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(760px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .mh{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .modal .mh .left{display:flex;flex-direction:column;gap:4px}
    .modal .mh h3{margin:0;font-size:14px}
    .modal .mh .sm{font-size:12px;color:var(--muted)}
    .modal .mb{padding:16px}
    .modal .close{font-weight:800}
    .two{
      display:grid;grid-template-columns: 1fr 1fr;gap:10px;
    }
    @media (max-width:720px){.two{grid-template-columns:1fr}}
    .list{
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      border-radius:18px;
      overflow:hidden;
    }
    .list .item{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
    }
    .list .item:last-child{border-bottom:none}
    .item .top{display:flex;justify-content:space-between;gap:10px}
    .item .desc{font-weight:800}
    .item .meta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Work Orders</h1>
          <p>Read-only dashboard • SSOT views • Edge Functions</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill"><span class="muted">Project</span> <span class="mono" id="projRefLabel">—</span></span>
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn danger" id="btnLogout">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Work orders -->
      <div class="card">
        <div class="hd">
          <h2>Work orders</h2>
          <div class="sub" id="countLabel">0 shown</div>
        </div>
        <div class="bd">
          <div class="row" style="justify-content:space-between;margin-bottom:12px;">
            <div style="flex:1;min-width:220px;">
              <label for="statusFilter">Filter by status</label>
              <select id="statusFilter">
                <option value="">All</option>
                <option value="new">new</option>
                <option value="open">open</option>
                <option value="scheduled">scheduled</option>
                <option value="in_progress">in_progress</option>
                <option value="waiting">waiting</option>
                <option value="waiting_parts">waiting_parts</option>
                <option value="completed">completed</option>
                <option value="cancelled">cancelled</option>
              </select>
            </div>

            <div style="flex:1;min-width:220px;">
              <label for="search">Search (customer / id)</label>
              <input id="search" placeholder="e.g. emily or 2ac8" />
            </div>
          </div>

          <div class="kpi">
            <div class="k">
              <div class="l">Scheduled</div>
              <div class="v" id="kScheduled">—</div>
            </div>
            <div class="k">
              <div class="l">In progress</div>
              <div class="v" id="kInProgress">—</div>
            </div>
            <div class="k">
              <div class="l">Completed</div>
              <div class="v" id="kCompleted">—</div>
            </div>
          </div>

          <div style="margin-top:14px;overflow:auto;border-radius:18px;border:1px solid var(--line)">
            <table class="table" id="woTable">
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Status</th>
                  <th class="hide-sm">Created</th>
                  <th class="mono">ID</th>
                </tr>
              </thead>
              <tbody id="woTbody">
                <tr><td colspan="4" class="muted">No data yet.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="err" id="errorBox" style="display:none;"></div>
        </div>
      </div>

      <!-- RIGHT: Auth / Config -->
      <div class="card">
        <div class="hd">
          <h2>Session</h2>
          <div class="sub">JWT required • no apikey</div>
        </div>
        <div class="bd">
          <div class="stack">
            <div>
              <label for="projectRef">Supabase project ref</label>
              <input id="projectRef" placeholder="kxqkwpkmtgvmthpafoqx" />
              <div class="hint" style="margin-top:6px;">
                This page calls Edge Functions:<br>
                <span class="mono">/functions/v1/work_orders</span> and <span class="mono">/functions/v1/work_orders/&lt;id&gt;</span>
              </div>
            </div>

            <div>
              <label for="jwt">Access token (JWT)</label>
              <input id="jwt" placeholder="paste access_token (Bearer token)" />
              <div class="hint" style="margin-top:6px;">
                Must be a valid <b>access_token</b> for this project and include <span class="mono">tenant_id</span> in user metadata.
              </div>
            </div>

            <div class="row">
              <button class="btn primary" id="btnSave">Save & Load</button>
              <button class="btn" id="btnTest">Test Token</button>
            </div>

            <div class="hint">
              If you see <span class="mono">Tenant not found in token</span>, your JWT does not include tenant context yet.
              Fix via your existing metadata injection process, then log in again and paste the new token.
            </div>

            <div class="err" id="sessionBox" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div class="left">
          <h3 id="mTitle">Work order</h3>
          <div class="sm mono" id="mSub">—</div>
        </div>
        <button class="btn close" id="btnClose">Close</button>
      </div>
      <div class="mb">
        <div class="row" style="justify-content:space-between;margin-bottom:10px;">
          <span class="badge" id="mStatus"><span class="dot"></span><span>—</span></span>
          <span class="pill"><span class="muted">Source</span>&nbsp;<span class="mono">work_order_schedule_rollup</span></span>
        </div>

        <div class="two">
          <div>
            <div class="muted" style="font-size:12px;margin-bottom:8px;">Labor lines</div>
            <div class="list" id="mLabor"></div>
          </div>
          <div>
            <div class="muted" style="font-size:12px;margin-bottom:8px;">Raw</div>
            <pre class="list mono" id="mRaw" style="padding:12px;margin:0;white-space:pre-wrap;max-height:360px;overflow:auto;"></pre>
          </div>
        </div>

        <div class="err" id="modalErr" style="display:none;margin-top:12px;"></div>
      </div>
    </div>
  </div>

<script>
/**
 * SSOT rules applied:
 * - Edge Functions are called with Authorization: Bearer <JWT> ONLY (no apikey header).
 * - Underscore function naming: /functions/v1/work_orders
 * - Read-only. No writes.
 */

const STORAGE_KEY = "wlpro_workorders_page_v1";

function $(id){ return document.getElementById(id); }
function setText(id, v){ $(id).textContent = v; }
function show(el, yes){ el.style.display = yes ? "" : "none"; }

function shortId(id){ return (id || "").toString().slice(-8); }
function fmtDate(iso){
  if(!iso) return "—";
  try{
    const d = new Date(iso);
    return d.toLocaleString();
  }catch{ return iso; }
}
function badgeClass(status){
  const s = (status || "").toString();
  if (s === "scheduled") return "b-scheduled";
  if (s === "in_progress") return "b-in_progress";
  if (s === "completed") return "b-completed";
  if (s === "cancelled") return "b-cancelled";
  if (s === "waiting_parts") return "b-waiting_parts";
  if (s === "waiting") return "b-waiting";
  if (s === "open") return "b-open";
  if (s === "new") return "b-new";
  return "b-open";
}

function apiBase(projectRef){
  return `https://${projectRef}.supabase.co/functions/v1`;
}

async function edgeFetch(projectRef, path, jwt){
  const res = await fetch(`${apiBase(projectRef)}${path}`, {
    method: "GET",
    headers: {
      "Authorization": `Bearer ${jwt}`,
      "Content-Type": "application/json"
    }
  });
  const text = await res.text();
  let data = {};
  try{ data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

  if(!res.ok){
    const msg = data?.error || data?.message || `${res.status} ${res.statusText}`;
    throw new Error(`${res.status}: ${msg}`);
  }
  return data;
}

function saveSession(projectRef, jwt){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ projectRef, jwt }));
}

function loadSession(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}

function setError(msg){
  const box = $("errorBox");
  if(!msg){ show(box,false); box.textContent=""; return; }
  box.textContent = msg;
  show(box,true);
}

function setSessionMsg(msg){
  const box = $("sessionBox");
  if(!msg){ show(box,false); box.textContent=""; return; }
  box.textContent = msg;
  show(box,true);
}

let WORK_ORDERS = [];

function renderTable(rows){
  const tbody = $("woTbody");
  tbody.innerHTML = "";

  if(!rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">No work orders found.</td>`;
    tbody.appendChild(tr);
    setText("countLabel", "0 shown");
    setText("kScheduled","0");
    setText("kInProgress","0");
    setText("kCompleted","0");
    return;
  }

  const scheduled = rows.filter(r => r.status === "scheduled").length;
  const inprog = rows.filter(r => r.status === "in_progress").length;
  const completed = rows.filter(r => r.status === "completed").length;
  setText("kScheduled", String(scheduled));
  setText("kInProgress", String(inprog));
  setText("kCompleted", String(completed));
  setText("countLabel", `${rows.length} shown`);

  for(const r of rows){
    const tr = document.createElement("tr");
    tr.className = "trbtn";
    tr.addEventListener("click", () => openDetail(r.work_order_id));
    tr.innerHTML = `
      <td>${escapeHtml(r.customer_name ?? "—")}</td>
      <td>
        <span class="badge ${badgeClass(r.status)}">
          <span class="dot"></span>
          <span>${escapeHtml(r.status ?? "—")}</span>
        </span>
      </td>
      <td class="hide-sm muted">${escapeHtml(fmtDate(r.created_at))}</td>
      <td class="mono">${escapeHtml(shortId(r.work_order_id))}</td>
    `;
    tbody.appendChild(tr);
  }
}

function applyFilters(){
  const status = $("statusFilter").value;
  const q = $("search").value.trim().toLowerCase();

  let rows = WORK_ORDERS.slice();
  if(status) rows = rows.filter(r => (r.status || "") === status);
  if(q){
    rows = rows.filter(r => {
      const c = (r.customer_name || "").toLowerCase();
      const id = (r.work_order_id || "").toLowerCase();
      return c.includes(q) || id.includes(q);
    });
  }
  renderTable(rows);
}

async function loadWorkOrders(){
  setError("");
  const projectRef = $("projectRef").value.trim();
  const jwt = $("jwt").value.trim();

  if(!projectRef) return setError("Missing project ref.");
  if(!jwt) return setError("Missing access token (JWT).");

  setSessionMsg("Loading work orders…");
  try{
    const data = await edgeFetch(projectRef, "/work_orders", jwt);
    WORK_ORDERS = Array.isArray(data.work_orders) ? data.work_orders : [];
    setSessionMsg("");
    applyFilters();
  }catch(e){
    setSessionMsg("");
    setError(String(e.message || e));
  }
}

function openModal(){
  show($("modalBackdrop"), true);
}
function closeModal(){
  show($("modalBackdrop"), false);
  $("modalErr").textContent = "";
  show($("modalErr"), false);
  $("mLabor").innerHTML = "";
  $("mRaw").textContent = "";
}

async function openDetail(workOrderId){
  const projectRef = $("projectRef").value.trim();
  const jwt = $("jwt").value.trim();
  if(!projectRef || !jwt) return;

  $("mTitle").textContent = "Work order";
  $("mSub").textContent = workOrderId;
  $("mLabor").innerHTML = `<div class="item muted">Loading…</div>`;
  $("mRaw").textContent = "";
  $("modalErr").textContent = "";
  show($("modalErr"), false);
  openModal();

  try{
    const data = await edgeFetch(projectRef, `/work_orders/${workOrderId}`, jwt);

    const status = data.status || "—";
    const badge = $("mStatus");
    badge.className = `badge ${badgeClass(status)}`;
    badge.querySelector("span:nth-child(2)").textContent = status;

    const lines = Array.isArray(data.labor_lines) ? data.labor_lines : [];
    const labor = $("mLabor");
    labor.innerHTML = "";
    if(!lines.length){
      labor.innerHTML = `<div class="item muted">No labor lines.</div>`;
    }else{
      for(const l of lines){
        const sched = l.schedule?.start ? `${fmtTime(l.schedule.start)}–${fmtTime(l.schedule.end)}` : "Unscheduled";
        const who = l.employee_name ? l.employee_name : (l.employee_id ? shortId(l.employee_id) : "—");
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="top">
            <div class="desc">${escapeHtml(l.description || "—")}</div>
            <span class="badge ${badgeClass(l.status)}"><span class="dot"></span><span>${escapeHtml(l.status || "—")}</span></span>
          </div>
          <div class="meta">
            <span>Tech: <b>${escapeHtml(who)}</b></span>
            <span>Time: <b>${escapeHtml(sched)}</b></span>
            <span class="mono">Labor: ${escapeHtml(shortId(l.labor_line_id || ""))}</span>
          </div>
        `;
        labor.appendChild(div);
      }
    }

    $("mRaw").textContent = JSON.stringify(data, null, 2);
  }catch(e){
    $("mLabor").innerHTML = "";
    $("modalErr").textContent = String(e.message || e);
    show($("modalErr"), true);
  }
}

function fmtTime(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleTimeString([], { hour: "2-digit", minute:"2-digit" });
  }catch{ return iso; }
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

$("btnClose").addEventListener("click", closeModal);
$("modalBackdrop").addEventListener("click", (e) => {
  if(e.target === $("modalBackdrop")) closeModal();
});

$("btnSave").addEventListener("click", async () => {
  const projectRef = $("projectRef").value.trim();
  const jwt = $("jwt").value.trim();
  saveSession(projectRef, jwt);
  setText("projRefLabel", projectRef || "—");
  await loadWorkOrders();
});

$("btnRefresh").addEventListener("click", loadWorkOrders);
$("btnTest").addEventListener("click", async () => {
  setError("");
  const projectRef = $("projectRef").value.trim();
  const jwt = $("jwt").value.trim();
  if(!projectRef) return setSessionMsg("Missing project ref.");
  if(!jwt) return setSessionMsg("Missing JWT.");
  try{
    setSessionMsg("Testing token against /work_orders…");
    await edgeFetch(projectRef, "/work_orders", jwt);
    setSessionMsg("✅ Token works for /work_orders");
  }catch(e){
    setSessionMsg(`❌ ${String(e.message || e)}`);
  }
});

$("btnLogout").addEventListener("click", () => {
  localStorage.removeItem(STORAGE_KEY);
  $("jwt").value = "";
  WORK_ORDERS = [];
  renderTable([]);
  setSessionMsg("Logged out (cleared local token).");
});

$("statusFilter").addEventListener("change", applyFilters);
$("search").addEventListener("input", applyFilters);

// boot
(function init(){
  const sess = loadSession();
  if(sess?.projectRef) $("projectRef").value = sess.projectRef;
  if(sess?.jwt) $("jwt").value = sess.jwt;
  setText("projRefLabel", $("projectRef").value.trim() || "—");
  renderTable([]);
})();
</script>
</body>
</html>
