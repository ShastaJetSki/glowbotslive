<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sponsors — EventLogicPro</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa; }
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fdfbf7;--bg-secondary:#f5f0e8;--bg-card:#fff;--bg-hover:#ebe4d6;--border-default:#d4c9b6;--text-primary:#3d3526;--text-secondary:#6b5f4e;--accent-primary:#a0845c;--accent-light:#b89a6e;}
    html{scrollbar-gutter:stable;}
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;}
    body{padding-bottom:120px;}
    .desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);flex-shrink:0;}
    .mobile-top-header{display:none!important;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);position:sticky;top:0;z-index:100;}
    .mobile-header-bar{display:flex;align-items:center;padding:12px 16px;gap:12px;}
    .mobile-header-center{flex:1;min-width:0;}.mobile-header-title{font-size:16px;font-weight:600;}
    .business-name{font-size:11px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .mobile-header-right{display:flex;gap:8px;}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:6px 8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;}
    .mobile-nav-btn{padding:8px 4px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:40px;transition:all .2s;}
    .mobile-nav-btn:active{transform:scale(.95);}
    .mobile-nav-btn.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);}
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .content{max-width:900px;margin:0 auto;padding:16px;}
    .hdr-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
    .hdr-sel{flex:1;min-width:200px;padding:10px 14px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:14px;}
    .hdr-btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;}
    .hdr-btn:hover{background:var(--bg-hover);}
    .hdr-btn.primary{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);}
    .hdr-btn.danger{color:#ef4444;border-color:#ef4444;}
    .meta-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
    .meta-input{padding:10px 14px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:14px;width:100%;}
    .level-card{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;margin-bottom:12px;overflow:hidden;transition:border-color .2s;}
    .level-card:hover{border-color:var(--accent-primary);}
    .level-drag{cursor:grab;color:var(--text-secondary);padding:8px 6px;user-select:none;touch-action:none;opacity:.3;transition:opacity .2s;display:grid;grid-template-columns:repeat(2,4px);gap:3px;}
    .level-drag:hover{opacity:.7;}.level-drag:active{cursor:grabbing;opacity:1;}
    .level-drag i{display:block;width:4px;height:4px;border-radius:50%;background:currentColor;}
    .level-card.dragging{opacity:.3;border-color:var(--accent-primary);}
    .level-card.drag-over{border-top:3px solid var(--accent-primary);}
    .level-hdr{display:flex;align-items:center;padding:16px;gap:12px;cursor:pointer;user-select:none;}
    .level-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
    .level-info{flex:1;min-width:0;}
    .level-name{font-size:16px;font-weight:700;}
    .level-sub{font-size:12px;color:var(--text-secondary);margin-top:2px;}
    .level-price{font-size:18px;font-weight:700;margin-right:8px;}
    .level-del{width:28px;height:28px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
    .level-del:hover{color:#ef4444;border-color:#ef4444;}
    .level-chv{font-size:12px;color:var(--text-secondary);transition:transform .2s;}
    .level-card.expanded .level-chv{transform:rotate(180deg);}
    .level-body{max-height:0;overflow:hidden;transition:max-height .35s ease;}
    .level-card.expanded .level-body{max-height:5000px;}
    .level-inner{padding:0 16px 16px;}
    .level-meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;}
    .lm-label{font-size:11px;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;}
    .lm-input{padding:8px 12px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:14px;width:100%;}
    .lm-color{width:100%;height:36px;border-radius:8px;border:1px solid var(--border-default);cursor:pointer;background:none;padding:2px;}
    .perks-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .perk-row{display:grid;grid-template-columns:50px 1fr 80px 80px 32px;gap:8px;align-items:center;margin-bottom:6px;}
    .perk-qty{padding:8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:14px;text-align:center;width:100%;}
    .perk-name{padding:8px 12px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:14px;width:100%;}
    .perk-del{width:28px;height:28px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
    .perk-del:hover{color:#ef4444;border-color:#ef4444;}
    .perk-cost{padding:8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:#22c55e;font-size:13px;text-align:right;width:100%;}
    .perk-value{padding:8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--accent-light);font-size:13px;text-align:right;width:100%;}
    .add-perk-btn{display:block;width:100%;padding:8px;border-radius:8px;border:1px dashed var(--border-default);background:transparent;color:var(--text-secondary);font-size:13px;cursor:pointer;text-align:center;margin-top:6px;}
    .add-perk-btn:hover{background:var(--bg-hover);color:var(--text-primary);border-color:var(--accent-primary);}
    .add-level-btn{display:block;width:100%;padding:14px;border-radius:12px;border:2px dashed var(--border-default);background:transparent;color:var(--text-secondary);font-size:15px;font-weight:600;cursor:pointer;text-align:center;margin-top:8px;}
    .add-level-btn:hover{background:var(--bg-hover);color:var(--text-primary);border-color:var(--accent-primary);}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--text-primary);padding:12px 24px;border-radius:10px;border:1px solid var(--border-default);font-size:14px;opacity:0;transition:opacity .3s;z-index:9999;pointer-events:none;}
    .toast.show{opacity:1;}
    .save-indicator{position:fixed;top:12px;right:12px;z-index:9999;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;opacity:0;transition:opacity .3s;pointer-events:none;}
    .save-indicator.saving{opacity:1;background:var(--accent-primary);color:#fff;}
    .save-indicator.saved{opacity:1;background:#22c55e;color:#fff;}
    .save-indicator.fade{opacity:0;}
    .summary-bar{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;padding:16px;margin-bottom:16px;display:grid;grid-template-columns:repeat(5,1fr);gap:12px;text-align:center;}
    .sb-val{font-size:22px;font-weight:700;}
    .sb-lbl{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
    .section-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    @media(max-width:768px){.desktop-header{display:none!important;}.mobile-top-header{display:block!important;}.mobile-bottom-nav{display:block!important;}body{padding-bottom:80px;}.content{padding:10px;}.meta-row{grid-template-columns:1fr;}.level-meta{grid-template-columns:1fr;}.summary-bar{grid-template-columns:1fr;}}
    .rev-dashboard{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;padding:20px;margin-bottom:16px;}
    .rev-total-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;text-align:center;}
    .rev-total-card{background:var(--bg-hover);border-radius:10px;padding:14px 8px;}
    .rev-total-val{font-size:24px;font-weight:800;}
    .rev-total-lbl{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
    .rev-slider-row{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border-default);}
    .rev-slider-row:last-child{border-bottom:none;}
    .rev-slider-left{min-width:0;flex-shrink:0;width:140px;}
    .rev-slider-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .rev-slider-price{font-size:12px;color:var(--text-secondary);}
    .rev-slider-mid{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0;}
    .rev-range-wrap{position:relative;height:28px;display:flex;align-items:center;}
    .rev-range{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:3px;background:var(--border-default);outline:none;cursor:pointer;}
    .rev-range::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent-primary);border:2px solid var(--bg-card);cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,.3);}
    .rev-range::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent-primary);border:2px solid var(--bg-card);cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,.3);}
    .rev-range::-webkit-slider-thumb:active{cursor:grabbing;transform:scale(1.15);}
    .rev-ticks{display:flex;justify-content:space-between;padding:0 2px;}
    .rev-tick{font-size:9px;color:var(--text-secondary);}
    .rev-slider-right{text-align:right;flex-shrink:0;width:120px;}
    .rev-qty-row{display:flex;align-items:center;gap:6px;justify-content:flex-end;}
    .rev-qty-input{width:56px;padding:6px 4px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:15px;font-weight:700;text-align:center;}
    .rev-subtotal{font-size:16px;font-weight:700;color:#22c55e;margin-top:2px;}
    .rev-bar{height:4px;border-radius:2px;background:var(--border-default);margin-top:2px;overflow:hidden;}
    .rev-bar-fill{height:100%;border-radius:2px;transition:width .15s ease;}
    @media(max-width:768px){.rev-total-row{grid-template-columns:repeat(2,1fr);}.rev-slider-row{flex-wrap:wrap;}.rev-slider-left{width:100%;}.rev-slider-mid{width:100%;}.rev-slider-right{width:100%;display:flex;align-items:center;justify-content:space-between;}.rev-subtotal{margin-top:0;}}
    @media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}body{padding-bottom:20px;}}
  </style>
</head>
<body>
<!-- Mobile Header -->
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <div class="mobile-header-center"><div class="mobile-header-title">Sponsors</div><div class="business-name" id="mBiz">Loading...</div></div>
    <div class="mobile-header-right"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button></div>
  </div>
  <div style="padding:0 16px 10px;">
    <select class="hdr-sel" id="mobSheetSel" onchange="syncSel(this.value)" style="width:100%;"></select>
    <div style="display:flex;gap:6px;margin-top:8px;">
      <button class="hdr-btn primary" onclick="createSheet()" style="flex:1;">+ New</button>
      <button class="hdr-btn" onclick="saveToDb()" style="flex:1;">Save</button>
      <button class="hdr-btn danger" id="mobDelBtn" onclick="deleteSheet()" style="display:none;">Delete</button>
    </div>
  </div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:14px 24px 6px;display:flex;justify-content:space-between;align-items:center;">
    <div><h1 style="margin:0;font-size:28px;font-weight:600;">EventLogicPro</h1><div class="business-name" id="dBiz">Loading...</div></div>
    <div style="display:flex;align-items:center;gap:16px;"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button><a onclick="doLogout()" style="color:var(--text-secondary);cursor:pointer;font-size:13px;">Logout</a></div>
  </div>
  <div style="padding:0 24px 10px;"><nav style="display:flex;gap:24px;"><a href="eventlogicpro-scheduler.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Calendar</a><a href="eventlogicpro.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Tasks</a><a href="eventlogicpro-estimator.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Budget</a><a href="eventlogicpro-sponsors.html" style="padding:10px 0;color:var(--accent-primary);text-decoration:none;font-size:13px;border-bottom:2px solid var(--accent-primary);">Sponsors</a><a href="eventlogicpro-sitemap.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Site Map</a></nav></div>
  <div class="hdr-bar" style="padding:0 24px 10px;">
    <select class="hdr-sel" id="deskSheetSel" onchange="syncSel(this.value)"></select>
    <button class="hdr-btn primary" onclick="createSheet()">+ New Sheet</button>
    <button class="hdr-btn" onclick="saveToDb()">Save</button>
    <button class="hdr-btn danger" id="deskDelBtn" onclick="deleteSheet()" style="display:none;">Delete</button>
  </div>
</div>

<!-- Content -->
<div class="content">
  <div class="meta-row">
    <input class="meta-input" id="sheetName" placeholder="Sheet name (e.g., Redding Rock 2026)" oninput="dirty=true;scheduleAutoSave();">
    <input class="meta-input" id="sheetEvent" placeholder="Event name" oninput="dirty=true;scheduleAutoSave();">
  </div>
  <div class="summary-bar" id="summaryBar">
    <div><div class="sb-val" id="sbLevels">0</div><div class="sb-lbl">Levels</div></div>
    <div><div class="sb-val" id="sbPerks">0</div><div class="sb-lbl">Total Perks</div></div>
    <div><div class="sb-val" id="sbValue" style="color:var(--accent-light);">$0</div><div class="sb-lbl">Total Value</div></div>
    <div><div class="sb-val" id="sbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
    <div><div class="sb-val" id="sbOffset">$0</div><div class="sb-lbl">Offset</div></div>
  </div>
  <div class="section-title"><span>SPONSOR LEVELS</span></div>
  <div id="levelsArea"></div>
  <button class="add-level-btn" onclick="addLevel()">+ Add Sponsor Level</button>

  <div class="section-title" style="margin-top:32px;"><span>TICKET PACKAGES</span></div>
  <div class="summary-bar" id="tickSummary">
    <div><div class="sb-val" id="tbPkgs">0</div><div class="sb-lbl">Packages</div></div>
    <div><div class="sb-val" id="tbItems">0</div><div class="sb-lbl">Total Items</div></div>
    <div><div class="sb-val" id="tbValue" style="color:var(--accent-light);">$0</div><div class="sb-lbl">Highest Price</div></div>
    <div><div class="sb-val" id="tbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
    <div><div class="sb-val" id="tbOffset">$0</div><div class="sb-lbl">Offset</div></div>
  </div>
  <div id="tickArea"></div>
  <button class="add-level-btn" onclick="addTickPkg()">+ Add Ticket Package</button>

  <div class="section-title" style="margin-top:32px;"><span>TICKET REVENUE ESTIMATOR</span></div>
  <div class="rev-dashboard" id="revDash">
    <div class="rev-total-row">
      <div class="rev-total-card">
        <div class="rev-total-val" id="revTotal">$0</div>
        <div class="rev-total-lbl">Estimated Revenue</div>
      </div>
      <div class="rev-total-card">
        <div class="rev-total-val" id="revTickets" style="color:var(--accent-light);">0</div>
        <div class="rev-total-lbl">Total Tickets</div>
      </div>
      <div class="rev-total-card">
        <div class="rev-total-val" id="revCost" style="color:#f59e0b;">$0</div>
        <div class="rev-total-lbl">Total Cost</div>
      </div>
      <div class="rev-total-card">
        <div class="rev-total-val" id="revProfit">$0</div>
        <div class="rev-total-lbl">Net Profit</div>
      </div>
    </div>
    <div id="revSliders"></div>
  </div>
</div>

<div class="mobile-bottom-nav"><div class="mobile-nav-top"><a href="eventlogicpro-scheduler.html" class="mobile-nav-btn">Calendar</a><a href="eventlogicpro.html" class="mobile-nav-btn">Tasks</a><a href="eventlogicpro-estimator.html" class="mobile-nav-btn">Budget</a><a href="eventlogicpro-sponsors.html" class="mobile-nav-btn active">Sponsors</a><a href="eventlogicpro-sitemap.html" class="mobile-nav-btn">Site Map</a></div></div>
<div id="toast" class="toast"></div>
<div id="saveInd" class="save-indicator"></div>

<script>
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);
var tenantId=null,userId=null,dirty=false;
var allSheets=[],currentSheetId=null,levels=[],tickPkgs=[];
var autoSaveTimer=null,saving=false;
function scheduleAutoSave(){if(autoSaveTimer)clearTimeout(autoSaveTimer);autoSaveTimer=setTimeout(function(){autoSave();},3000);}
function showSaveStatus(status){var el=document.getElementById('saveInd');el.className='save-indicator '+status;el.textContent=status==='saving'?'Saving...':'Saved ✓';if(status==='saved')setTimeout(function(){el.classList.add('fade');},1500);}
async function autoSave(){if(!dirty||saving||!currentSheetId||!tenantId)return;saving=true;showSaveStatus('saving');try{await saveToDb(true);}catch(e){console.error('Auto-save error:',e);}saving=false;}
var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal','cyber','amber','honey','crimson','coral','rose','sand'];
var ti=Math.max(0,themes.indexOf(localStorage.getItem('app-theme')||'dark-blue'));
function cycleTheme(){ti=(ti+1)%themes.length;var t=themes[ti];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);toast('Theme: '+t.replace(/-/g,' '));}
function toast(msg){var el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2500);}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function fmt(n){return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});}
async function checkAuth(){var r=await sb.auth.getSession();var s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){window.location.href='login.html';return null;}}return s;}
async function doLogout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}

// Default perk templates
var DEFAULT_PERKS=[
  {name:'Event Tickets',qty:0,value:0,cost:0},
  {name:'VIP Passes',qty:0,value:0,cost:0},
  {name:'T-Shirts',qty:0,value:0,cost:0},
  {name:'Banner Placement',qty:0,value:0,cost:0},
  {name:'Stage Mention',qty:0,value:0,cost:0},
  {name:'Screen Ad Rotation',qty:0,value:0,cost:0},
  {name:'Social Media Shoutout',qty:0,value:0,cost:0},
  {name:'Booth Space',qty:0,value:0,cost:0},
  {name:'Logo on Flyer/Poster',qty:0,value:0,cost:0},
  {name:'Website Logo/Link',qty:0,value:0,cost:0},
  {name:'MC Announcement',qty:0,value:0,cost:0},
  {name:'Photo Op / Meet & Greet',qty:0,value:0,cost:0}
];

function makeDefaults(){
  return [
    {name:'Platinum',color:'#a78bfa',price:3500,perks:[
      {name:'Event Tickets',qty:20,value:25,cost:10},{name:'VIP Passes',qty:10,value:75,cost:25},{name:'T-Shirts',qty:10,value:25,cost:12},
      {name:'Banner Placement',qty:2,value:150,cost:50},{name:'Stage Mention',qty:4,value:50,cost:0},{name:'Screen Ad Rotation',qty:1,value:100,cost:25},
      {name:'Social Media Shoutout',qty:5,value:30,cost:0},{name:'Booth Space',qty:1,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},
      {name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:3,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:1,value:100,cost:0}
    ]},
    {name:'Gold',color:'#fbbf24',price:2000,perks:[
      {name:'Event Tickets',qty:10,value:25,cost:10},{name:'VIP Passes',qty:4,value:75,cost:25},{name:'T-Shirts',qty:6,value:25,cost:12},
      {name:'Banner Placement',qty:1,value:150,cost:50},{name:'Stage Mention',qty:2,value:50,cost:0},{name:'Screen Ad Rotation',qty:1,value:100,cost:25},
      {name:'Social Media Shoutout',qty:3,value:30,cost:0},{name:'Booth Space',qty:1,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},
      {name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:1,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:100,cost:0}
    ]},
    {name:'Silver',color:'#94a3b8',price:1500,perks:[
      {name:'Event Tickets',qty:6,value:25,cost:10},{name:'VIP Passes',qty:2,value:75,cost:25},{name:'T-Shirts',qty:4,value:25,cost:12},
      {name:'Banner Placement',qty:1,value:150,cost:50},{name:'Stage Mention',qty:1,value:50,cost:0},{name:'Screen Ad Rotation',qty:0,value:100,cost:25},
      {name:'Social Media Shoutout',qty:2,value:30,cost:0},{name:'Booth Space',qty:0,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},
      {name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:0,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:100,cost:0}
    ]}
  ];
}

// Load / Save sheets
async function loadSheets(){var r=await sb.from('sponsor_sheets').select('*').eq('tenant_id',tenantId).order('created_at',{ascending:false});if(r.error){console.error('Load sheets error:',r.error);allSheets=[];return;}allSheets=r.data||[];}
function buildOptions(){var h='<option value="">-- Select Sponsor Sheet --</option>';if(currentSheetId==='preloaded'&&!allSheets.find(function(s){return s.sheet_id==='preloaded';})){h+='<option value="preloaded" selected>Redding Rock 2026 (preloaded)</option>';}allSheets.forEach(function(s){h+='<option value="'+s.sheet_id+'"'+(s.sheet_id===currentSheetId?' selected':'')+'>'+esc(s.sheet_name||'Untitled')+'</option>';});return h;}
function renderSelects(){var h=buildOptions();document.getElementById('deskSheetSel').innerHTML=h;document.getElementById('mobSheetSel').innerHTML=h;}
function syncSel(id){if(!id){currentSheetId=null;clearForm();return;}document.getElementById('deskSheetSel').value=id;document.getElementById('mobSheetSel').value=id;if(id==='preloaded'){loadPreloaded();return;}currentSheetId=id;localStorage.setItem('elp-last-sponsor',id);loadSheetData(id);}

async function loadSheetData(id){var s=allSheets.find(function(e){return e.sheet_id===id;});if(!s)return;document.getElementById('sheetName').value=s.sheet_name||'';document.getElementById('sheetEvent').value=s.event_name||'';var lr=await sb.from('sponsor_levels').select('*').eq('sheet_id',id).order('sort_order');var lvls=lr.data||[];levels=[];for(var i=0;i<lvls.length;i++){var l=lvls[i];var pr=await sb.from('sponsor_perks').select('*').eq('level_id',l.level_id).order('sort_order');levels.push({name:l.level_name,color:l.color,price:parseFloat(l.price)||0,perks:(pr.data||[]).map(function(p){return{name:p.perk_name,qty:parseInt(p.quantity)||0,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0};})});}if(!levels.length)levels=makeDefaults();var tr=await sb.from('ticket_packages').select('*').eq('sheet_id',id).order('sort_order');var tpkgs=tr.data||[];tickPkgs=[];for(var j=0;j<tpkgs.length;j++){var tp=tpkgs[j];var tir=await sb.from('ticket_package_items').select('*').eq('package_id',tp.package_id).order('sort_order');tickPkgs.push({name:tp.package_name,color:tp.color,price:parseFloat(tp.price)||0,items:(tir.data||[]).map(function(ti){return{name:ti.item_name,qty:parseInt(ti.quantity)||0,cost:parseFloat(ti.cost)||0};})});}if(!tickPkgs.length)tickPkgs=makeDefaultTicks();updateButtons(s);render();}

function loadPreloaded(){currentSheetId='preloaded';localStorage.setItem('elp-last-sponsor','preloaded');document.getElementById('sheetName').value='Redding Rock 2026';document.getElementById('sheetEvent').value='Redding Rock';levels=makeDefaults();tickPkgs=makeDefaultTicks();updateButtons(null);render();}

function clearForm(){currentSheetId=null;document.getElementById('sheetName').value='';document.getElementById('sheetEvent').value='';levels=[];tickPkgs=[];updateButtons(null);render();}

function updateButtons(s){var isMine=s&&s.created_by===userId;document.getElementById('deskDelBtn').style.display=isMine?'':'none';document.getElementById('mobDelBtn').style.display=isMine?'':'none';}

async function createSheet(){if(!tenantId){toast('Not authenticated');return;}var name=prompt('Sheet name (e.g., Summer Bash 2026):');if(!name||!name.trim())return;var ins=await sb.from('sponsor_sheets').insert({tenant_id:tenantId,sheet_name:name.trim(),created_by:userId}).select().single();if(ins.error){toast('Error: '+ins.error.message);console.error('Create sheet error:',ins.error);return;}var sheetId=ins.data.sheet_id;var defs=makeDefaults();for(var i=0;i<defs.length;i++){var lv=defs[i];var li=await sb.from('sponsor_levels').insert({sheet_id:sheetId,tenant_id:tenantId,level_name:lv.name,color:lv.color,price:lv.price,sort_order:i}).select().single();if(li.error){console.error('Level create error:',li.error);continue;}if(li.data){var pRows=lv.perks.map(function(p,pi){return{level_id:li.data.level_id,sheet_id:sheetId,tenant_id:tenantId,perk_name:p.name,quantity:p.qty,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0,sort_order:pi};});if(pRows.length){var pr=await sb.from('sponsor_perks').insert(pRows);if(pr.error)console.error('Perk create error:',pr.error);}}}var defTicks=makeDefaultTicks();for(var j=0;j<defTicks.length;j++){var tp=defTicks[j];var ti=await sb.from('ticket_packages').insert({sheet_id:sheetId,tenant_id:tenantId,package_name:tp.name,color:tp.color,price:tp.price,sort_order:j}).select().single();if(ti.data){var tRows=tp.items.map(function(it,ii){return{package_id:ti.data.package_id,sheet_id:sheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,cost:parseFloat(it.cost)||0,sort_order:ii};});if(tRows.length)await sb.from('ticket_package_items').insert(tRows);}}currentSheetId=sheetId;localStorage.setItem('elp-last-sponsor',sheetId);await loadSheets();renderSelects();syncSel(sheetId);toast('"'+name.trim()+'" created');}

async function ensureTables(){try{var t=await sb.from('sponsor_sheets').select('sheet_id').limit(1);if(t.error&&t.error.code==='42P01'){await sb.rpc('exec_sql',{sql:"CREATE TABLE IF NOT EXISTS sponsor_sheets (sheet_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, tenant_id uuid, sheet_name text, event_name text, created_by uuid, created_at timestamptz DEFAULT now()); CREATE TABLE IF NOT EXISTS sponsor_levels (level_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, level_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS sponsor_perks (perk_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, level_id uuid REFERENCES sponsor_levels(level_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, perk_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS ticket_packages (package_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, package_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS ticket_package_items (item_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, package_id uuid REFERENCES ticket_packages(package_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, item_name text, quantity int DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); ALTER TABLE sponsor_sheets ENABLE ROW LEVEL SECURITY; ALTER TABLE sponsor_levels ENABLE ROW LEVEL SECURITY; ALTER TABLE sponsor_perks ENABLE ROW LEVEL SECURITY; CREATE POLICY IF NOT EXISTS sp_sheets ON sponsor_sheets FOR ALL USING (true); CREATE POLICY IF NOT EXISTS sp_levels ON sponsor_levels FOR ALL USING (true); CREATE POLICY IF NOT EXISTS sp_perks ON sponsor_perks FOR ALL USING (true); ALTER TABLE ticket_packages ENABLE ROW LEVEL SECURITY; ALTER TABLE ticket_package_items ENABLE ROW LEVEL SECURITY; CREATE POLICY IF NOT EXISTS tp_pkgs ON ticket_packages FOR ALL USING (true); CREATE POLICY IF NOT EXISTS tp_items ON ticket_package_items FOR ALL USING (true);"});toast('Tables created');}}catch(e){}}

async function saveToDb(silent){if(!tenantId){if(!silent)toast('Not authenticated');return;}if(!currentSheetId){if(!silent)toast('Select or create a sheet first');return;}var sheetName=document.getElementById('sheetName').value||'Untitled';var eventName=document.getElementById('sheetEvent').value||'';if(currentSheetId==='preloaded'){var ins=await sb.from('sponsor_sheets').insert({tenant_id:tenantId,sheet_name:sheetName,event_name:eventName,created_by:userId}).select().single();if(ins.error){toast('Save error: '+ins.error.message);console.error('Sheet insert error:',ins.error);return;}currentSheetId=ins.data.sheet_id;localStorage.setItem('elp-last-sponsor',currentSheetId);}else{var upd=await sb.from('sponsor_sheets').update({sheet_name:sheetName,event_name:eventName}).eq('sheet_id',currentSheetId);if(upd.error){toast('Update error: '+upd.error.message);console.error('Sheet update error:',upd.error);return;}}var delP=await sb.from('sponsor_perks').delete().eq('sheet_id',currentSheetId);if(delP.error)console.error('Perks delete:',delP.error);var delL=await sb.from('sponsor_levels').delete().eq('sheet_id',currentSheetId);if(delL.error)console.error('Levels delete:',delL.error);for(var i=0;i<levels.length;i++){var lv=levels[i];var li=await sb.from('sponsor_levels').insert({sheet_id:currentSheetId,tenant_id:tenantId,level_name:lv.name,color:lv.color,price:lv.price,sort_order:i}).select().single();if(li.error){toast('Level save error: '+li.error.message);console.error('Level insert error:',li.error);continue;}if(li.data&&lv.perks.length){var pRows=lv.perks.map(function(p,pi){return{level_id:li.data.level_id,sheet_id:currentSheetId,tenant_id:tenantId,perk_name:p.name,quantity:p.qty,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0,sort_order:pi};});var pr=await sb.from('sponsor_perks').insert(pRows);if(pr.error){toast('Perk save error: '+pr.error.message);console.error('Perk insert error:',pr.error);}}}await sb.from('ticket_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('ticket_packages').delete().eq('sheet_id',currentSheetId);for(var j=0;j<tickPkgs.length;j++){var tp=tickPkgs[j];var ti=await sb.from('ticket_packages').insert({sheet_id:currentSheetId,tenant_id:tenantId,package_name:tp.name,color:tp.color,price:tp.price,sort_order:j}).select().single();if(ti.error){console.error('Ticket pkg error:',ti.error);continue;}if(ti.data&&tp.items.length){var tRows=tp.items.map(function(it,ii){return{package_id:ti.data.package_id,sheet_id:currentSheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,cost:parseFloat(it.cost)||0,sort_order:ii};});var tpr=await sb.from('ticket_package_items').insert(tRows);if(tpr.error)console.error('Ticket item error:',tpr.error);}}dirty=false;await loadSheets();renderSelects();document.getElementById('deskSheetSel').value=currentSheetId;document.getElementById('mobSheetSel').value=currentSheetId;if(silent){showSaveStatus('saved');}else{toast('Saved!');}}

async function deleteSheet(){if(!currentSheetId||currentSheetId==='preloaded')return;var s=allSheets.find(function(e){return e.sheet_id===currentSheetId;});if(!s||s.created_by!==userId){toast('Cannot delete');return;}if(!confirm('Delete "'+s.sheet_name+'"?'))return;await sb.from('ticket_package_items').delete().eq('sheet_id',currentSheetId);await sb.from('ticket_packages').delete().eq('sheet_id',currentSheetId);await sb.from('sponsor_perks').delete().eq('sheet_id',currentSheetId);await sb.from('sponsor_levels').delete().eq('sheet_id',currentSheetId);await sb.from('sponsor_sheets').delete().eq('sheet_id',currentSheetId);currentSheetId=null;localStorage.removeItem('elp-last-sponsor');await loadSheets();renderSelects();clearForm();toast('Deleted');}

// Rendering
function render(){var area=document.getElementById('levelsArea');var h='';levels.forEach(function(lv,i){var totalPerks=lv.perks.filter(function(p){return p.qty>0;}).length;var lvCost=0,lvValue=0;lv.perks.forEach(function(p){var q=parseInt(p.qty)||0;lvCost+=q*(parseFloat(p.cost)||0);lvValue+=q*(parseFloat(p.value)||0);});h+='<div class="level-card" id="lvl-'+i+'">';h+='<div class="level-hdr" onclick="toggleLevel('+i+')">';h+='<div class="level-drag" onmousedown="handleGrab(event,'+i+')" ontouchstart="handleGrab(event,'+i+')" title="Drag to reorder"><i></i><i></i><i></i><i></i><i></i><i></i></div>';h+='<div class="level-dot" style="background:'+lv.color+';"></div>';h+='<div class="level-info"><div class="level-name" style="color:'+lv.color+';">'+esc(lv.name)+'</div>';h+='<div class="level-sub">'+totalPerks+' perks · Value $'+fmt(lvValue)+' · Cost $'+fmt(lvCost)+'</div></div>';h+='<div class="level-price" style="color:'+lv.color+';">$'+fmt(lv.price)+'</div>';h+='<button class="level-del" onclick="event.stopPropagation();removeLevel('+i+')" title="Delete level">&times;</button>';h+='<span class="level-chv">&#9660;</span></div>';
h+='<div class="level-body"><div class="level-inner">';
h+='<div class="level-meta">';
h+='<div><div class="lm-label">Level Name</div><input class="lm-input" value="'+esc(lv.name)+'" onchange="updLevel('+i+',\'name\',this.value)"></div>';
h+='<div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(lv.price||'')+'" step="0.01" oninput="updLevel('+i+',\'price\',this.value)"></div>';
h+='<div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+lv.color+'" oninput="updLevel('+i+',\'color\',this.value)"></div>';
h+='</div>';
h+='<div class="perks-title"><span>PERKS & INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Perk | Value | Cost</span></div>';
lv.perks.forEach(function(p,pi){
h+='<div class="perk-row">';
h+='<input type="number" class="perk-qty" value="'+(p.qty||0)+'" min="0" oninput="updPerk('+i+','+pi+',\'qty\',this.value)">';
h+='<input type="text" class="perk-name" value="'+esc(p.name)+'" onchange="updPerk('+i+','+pi+',\'name\',this.value)" placeholder="Perk name">';
h+='<input type="number" class="perk-value" value="'+(p.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updPerk('+i+','+pi+',\'value\',this.value)">';
h+='<input type="number" class="perk-cost" value="'+(p.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updPerk('+i+','+pi+',\'cost\',this.value)">';
h+='<button class="perk-del" onclick="removePerk('+i+','+pi+')" title="Remove">&times;</button>';
h+='</div>';});
h+='<button class="add-perk-btn" onclick="addPerk('+i+')">+ Add Perk</button>';
h+='</div></div></div>';});
area.innerHTML=h;calcSummary();renderTickPkgs();}

function toggleLevel(i){var card=document.getElementById('lvl-'+i);if(card){var wasExpanded=card.classList.contains('expanded');card.classList.toggle('expanded');if(wasExpanded&&dirty)autoSave();}}
function updLevel(i,key,val){if(key==='price')levels[i].price=parseFloat(val)||0;else if(key==='color'){levels[i].color=val;}else levels[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var prEl=document.querySelector('#lvl-'+i+' .level-price');if(prEl){prEl.textContent='$'+fmt(levels[i].price);}calcSummary();}else{render();var card=document.getElementById('lvl-'+i);if(card)card.classList.add('expanded');}}
function updPerk(li,pi,key,val){if(key==='qty')levels[li].perks[pi].qty=parseInt(val)||0;else if(key==='cost')levels[li].perks[pi].cost=parseFloat(val)||0;else if(key==='value')levels[li].perks[pi].value=parseFloat(val)||0;else levels[li].perks[pi][key]=val;dirty=true;scheduleAutoSave();calcSummary();}
function addPerk(li){levels[li].perks.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();render();var card=document.getElementById('lvl-'+li);if(card)card.classList.add('expanded');}
function removePerk(li,pi){levels[li].perks.splice(pi,1);dirty=true;scheduleAutoSave();render();var card=document.getElementById('lvl-'+li);if(card)card.classList.add('expanded');}
function addLevel(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[levels.length%colors.length];var name=prompt('Level name (e.g., Media, Standard):');if(!name||!name.trim())return;levels.push({name:name.trim(),color:c,price:0,perks:DEFAULT_PERKS.map(function(p){return{name:p.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();render();}
function removeLevel(i){if(!confirm('Delete "'+levels[i].name+'" level?'))return;levels.splice(i,1);dirty=true;scheduleAutoSave();render();}

var dragIdx=null,dragY=0,dragGhost=null;
function handleGrab(e,i){e.preventDefault();e.stopPropagation();dragIdx=i;var touch=e.touches?e.touches[0]:e;dragY=touch.clientY;var card=document.getElementById('lvl-'+i);card.classList.add('dragging');dragGhost=card.cloneNode(true);dragGhost.classList.remove('dragging');dragGhost.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent-primary);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(dragGhost);document.addEventListener('mousemove',handleMove);document.addEventListener('mouseup',handleRelease);document.addEventListener('touchmove',handleMove,{passive:false});document.addEventListener('touchend',handleRelease);}
function handleMove(e){if(dragIdx===null)return;e.preventDefault();var touch=e.touches?e.touches[0]:e;var y=touch.clientY;if(dragGhost)dragGhost.style.top=(y-30)+'px';document.querySelectorAll('.level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(touch.clientX,y);if(el){var card=el.closest('.level-card');if(card&&card.id!=='lvl-'+dragIdx)card.classList.add('drag-over');}}
function handleRelease(e){document.removeEventListener('mousemove',handleMove);document.removeEventListener('mouseup',handleRelease);document.removeEventListener('touchmove',handleMove);document.removeEventListener('touchend',handleRelease);if(dragGhost){document.body.removeChild(dragGhost);dragGhost=null;}if(dragIdx===null)return;var touch=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(touch.clientX,touch.clientY);var targetCard=el?el.closest('.level-card'):null;var targetIdx=-1;if(targetCard){var m=targetCard.id.match(/lvl-(\d+)/);if(m)targetIdx=parseInt(m[1]);}document.querySelectorAll('.level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(targetIdx>=0&&targetIdx!==dragIdx){var item=levels.splice(dragIdx,1)[0];levels.splice(targetIdx,0,item);dirty=true;scheduleAutoSave();render();}dragIdx=null;}

function calcSummary(){var totalPerks=0,totalCost=0,totalValue=0,totalPrice=0;levels.forEach(function(lv,i){var lvPerks=0,lvCost=0,lvValue=0;totalPrice+=lv.price;lv.perks.forEach(function(p){var q=parseInt(p.qty)||0;if(q>0)lvPerks++;lvCost+=q*(parseFloat(p.cost)||0);lvValue+=q*(parseFloat(p.value)||0);totalPerks++;});totalCost+=lvCost;totalValue+=lvValue;var sub=document.querySelector('#lvl-'+i+' .level-sub');if(sub)sub.textContent=lvPerks+' perks · Value $'+fmt(lvValue)+' · Cost $'+fmt(lvCost);});var offset=totalPrice-totalCost;document.getElementById('sbLevels').textContent=levels.length;document.getElementById('sbPerks').textContent=totalPerks;document.getElementById('sbValue').textContent='$'+fmt(totalValue);document.getElementById('sbCost').textContent='$'+fmt(totalCost);var oEl=document.getElementById('sbOffset');oEl.textContent=(offset>=0?'+$':'-$')+fmt(Math.abs(offset));oEl.style.color=offset>=0?'#22c55e':'#ef4444';calcTickSummary();}

// === TICKET PACKAGES ===
var DEFAULT_TICK_ITEMS=[{name:'General Admission Ticket',qty:1,cost:0},{name:'Drink Ticket',qty:0,cost:0},{name:'T-Shirt',qty:0,cost:0},{name:'Food Voucher',qty:0,cost:0},{name:'Parking Pass',qty:0,cost:0}];

function makeDefaultTicks(){return[
  {name:'VIP Bundle',color:'#a78bfa',price:85,items:[
    {name:'VIP Admission',qty:1,cost:15},{name:'Drink Ticket',qty:3,cost:3},{name:'T-Shirt',qty:1,cost:12},{name:'Food Voucher',qty:2,cost:5},{name:'Parking Pass',qty:1,cost:2},{name:'Meet & Greet Access',qty:1,cost:0}
  ]},
  {name:'Party Pack',color:'#22c55e',price:55,items:[
    {name:'General Admission',qty:1,cost:8},{name:'Drink Ticket',qty:2,cost:3},{name:'T-Shirt',qty:1,cost:12},{name:'Food Voucher',qty:1,cost:5}
  ]},
  {name:'General Admission',color:'#3b82f6',price:25,items:[
    {name:'General Admission Ticket',qty:1,cost:8},{name:'Drink Ticket',qty:1,cost:3}
  ]}
];}

function renderTickPkgs(){var area=document.getElementById('tickArea');var h='';tickPkgs.forEach(function(pk,i){var itemCnt=pk.items.filter(function(it){return it.qty>0;}).length;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});
h+='<div class="level-card" id="tpk-'+i+'">';
h+='<div class="level-hdr" onclick="toggleTick('+i+')">';
h+='<div class="level-drag" onmousedown="tickGrab(event,'+i+')" ontouchstart="tickGrab(event,'+i+')"><i></i><i></i><i></i><i></i><i></i><i></i></div>';
h+='<div class="level-dot" style="background:'+pk.color+';"></div>';
h+='<div class="level-info"><div class="level-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div>';
h+='<div class="level-sub">'+itemCnt+' items · Cost $'+fmt(pkCost)+'</div></div>';
h+='<div class="level-price" style="color:'+pk.color+';">$'+fmt(pk.price)+'</div>';
h+='<button class="level-del" onclick="event.stopPropagation();removeTickPkg('+i+')" title="Delete">&times;</button>';
h+='<span class="level-chv">&#9660;</span></div>';
h+='<div class="level-body"><div class="level-inner">';
h+='<div class="level-meta">';
h+='<div><div class="lm-label">Package Name</div><input class="lm-input" value="'+esc(pk.name)+'" onchange="updTick('+i+',\'name\',this.value)"></div>';
h+='<div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(pk.price||'')+'" step="0.01" oninput="updTick('+i+',\'price\',this.value)"></div>';
h+='<div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+pk.color+'" oninput="updTick('+i+',\'color\',this.value)"></div>';
h+='</div>';
h+='<div class="perks-title"><span>INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Item | Cost</span></div>';
pk.items.forEach(function(it,ii){
h+='<div class="perk-row" style="grid-template-columns:50px 1fr 80px 32px;">';
h+='<input type="number" class="perk-qty" value="'+(it.qty||0)+'" min="0" oninput="updTickItem('+i+','+ii+',\'qty\',this.value)">';
h+='<input type="text" class="perk-name" value="'+esc(it.name)+'" onchange="updTickItem('+i+','+ii+',\'name\',this.value)" placeholder="Item name">';
h+='<input type="number" class="perk-cost" value="'+(it.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updTickItem('+i+','+ii+',\'cost\',this.value)">';
h+='<button class="perk-del" onclick="removeTickItem('+i+','+ii+')">&times;</button>';
h+='</div>';});
h+='<button class="add-perk-btn" onclick="addTickItem('+i+')">+ Add Item</button>';
h+='</div></div></div>';});
area.innerHTML=h;calcTickSummary();renderRevSliders();}

function toggleTick(i){var c=document.getElementById('tpk-'+i);if(c){var wasExpanded=c.classList.contains('expanded');c.classList.toggle('expanded');if(wasExpanded&&dirty)autoSave();}}
function updTick(i,key,val){if(key==='price')tickPkgs[i].price=parseFloat(val)||0;else if(key==='color')tickPkgs[i].color=val;else tickPkgs[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#tpk-'+i+' .level-price');if(pr){pr.textContent='$'+fmt(tickPkgs[i].price);}calcTickSummary();renderRevSliders();}else{renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}}
function updTickItem(i,ii,key,val){if(key==='qty')tickPkgs[i].items[ii].qty=parseInt(val)||0;else if(key==='cost')tickPkgs[i].items[ii].cost=parseFloat(val)||0;else tickPkgs[i].items[ii][key]=val;dirty=true;scheduleAutoSave();calcTickSummary();renderRevSliders();}
function addTickItem(i){tickPkgs[i].items.push({name:'',qty:0,cost:0});dirty=true;scheduleAutoSave();renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}
function removeTickItem(i,ii){tickPkgs[i].items.splice(ii,1);dirty=true;scheduleAutoSave();renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}
function addTickPkg(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[tickPkgs.length%colors.length];var name=prompt('Package name (e.g., Family 4-Pack):');if(!name||!name.trim())return;tickPkgs.push({name:name.trim(),color:c,price:0,items:DEFAULT_TICK_ITEMS.map(function(it){return{name:it.name,qty:0,cost:0};})});dirty=true;scheduleAutoSave();renderTickPkgs();}
function removeTickPkg(i){if(!confirm('Delete "'+tickPkgs[i].name+'" package?'))return;tickPkgs.splice(i,1);dirty=true;scheduleAutoSave();renderTickPkgs();}
function calcTickSummary(){var tCost=0,maxP=0,tItems=0;tickPkgs.forEach(function(pk,i){var pkCost=0,pkItems=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;if(q>0)pkItems++;pkCost+=q*(parseFloat(it.cost)||0);});tCost+=pkCost;tItems+=pkItems;if(pk.price>maxP)maxP=pk.price;var sub=document.querySelector('#tpk-'+i+' .level-sub');if(sub)sub.textContent=pkItems+' items · Cost $'+fmt(pkCost);});var offset=maxP>0?(tickPkgs.reduce(function(s,p){return s+p.price;},0)-tCost):0;document.getElementById('tbPkgs').textContent=tickPkgs.length;document.getElementById('tbItems').textContent=tItems;document.getElementById('tbValue').textContent='$'+fmt(maxP);document.getElementById('tbCost').textContent='$'+fmt(tCost);var oEl=document.getElementById('tbOffset');var tpTotal=tickPkgs.reduce(function(s,p){return s+p.price;},0);var tpOff=tpTotal-tCost;oEl.textContent=(tpOff>=0?'+$':'-$')+fmt(Math.abs(tpOff));oEl.style.color=tpOff>=0?'#22c55e':'#ef4444';}

// Ticket drag
var tickDragIdx=null,tickGhost=null;
function tickGrab(e,i){e.preventDefault();e.stopPropagation();tickDragIdx=i;var card=document.getElementById('tpk-'+i);card.classList.add('dragging');tickGhost=card.cloneNode(true);tickGhost.classList.remove('dragging');tickGhost.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent-primary);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(tickGhost);document.addEventListener('mousemove',tickMove);document.addEventListener('mouseup',tickRelease);document.addEventListener('touchmove',tickMove,{passive:false});document.addEventListener('touchend',tickRelease);}
function tickMove(e){if(tickDragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(tickGhost)tickGhost.style.top=(t.clientY-30)+'px';document.querySelectorAll('#tickArea .level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id.startsWith('tpk-')&&card.id!=='tpk-'+tickDragIdx)card.classList.add('drag-over');}}
function tickRelease(e){document.removeEventListener('mousemove',tickMove);document.removeEventListener('mouseup',tickRelease);document.removeEventListener('touchmove',tickMove);document.removeEventListener('touchend',tickRelease);if(tickGhost){document.body.removeChild(tickGhost);tickGhost=null;}if(tickDragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var ti=-1;if(tc){var m=tc.id.match(/tpk-(\d+)/);if(m)ti=parseInt(m[1]);}document.querySelectorAll('#tickArea .level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(ti>=0&&ti!==tickDragIdx){var item=tickPkgs.splice(tickDragIdx,1)[0];tickPkgs.splice(ti,0,item);dirty=true;scheduleAutoSave();renderTickPkgs();}tickDragIdx=null;}

// === REVENUE ESTIMATOR ===
var revQtys=[];
function renderRevSliders(){var area=document.getElementById('revSliders');if(!tickPkgs.length){area.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-secondary);font-size:13px;">Add ticket packages above to estimate revenue</div>';calcRev();return;}while(revQtys.length<tickPkgs.length)revQtys.push(0);if(revQtys.length>tickPkgs.length)revQtys.length=tickPkgs.length;var h='';tickPkgs.forEach(function(pk,i){var qty=revQtys[i]||0;var sub=qty*pk.price;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});var totalCostForQty=qty*pkCost;var maxQ=500;var pct=Math.min(100,Math.round(qty/maxQ*100));
h+='<div class="rev-slider-row">';
h+='<div class="rev-slider-left"><div class="rev-slider-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div><div class="rev-slider-price">$'+fmt(pk.price)+' ea · $'+fmt(pkCost)+' cost</div></div>';
h+='<div class="rev-slider-mid"><div class="rev-range-wrap"><input type="range" class="rev-range" min="0" max="'+maxQ+'" value="'+qty+'" oninput="setRevQty('+i+',this.value)" style="background:linear-gradient(to right,'+pk.color+' '+pct+'%,var(--border-default) '+pct+'%);"></div>';
h+='<div class="rev-ticks"><span class="rev-tick">0</span><span class="rev-tick">'+Math.round(maxQ/4)+'</span><span class="rev-tick">'+Math.round(maxQ/2)+'</span><span class="rev-tick">'+Math.round(maxQ*3/4)+'</span><span class="rev-tick">'+maxQ+'</span></div></div>';
h+='<div class="rev-slider-right"><div class="rev-qty-row"><input type="number" class="rev-qty-input" value="'+qty+'" min="0" oninput="setRevQty('+i+',this.value)" style="border-color:'+pk.color+';"></div>';
h+='<div class="rev-subtotal">$'+fmt(sub)+'</div>';
h+='<div class="rev-bar"><div class="rev-bar-fill" style="width:'+pct+'%;background:'+pk.color+';"></div></div></div>';
h+='</div>';});
area.innerHTML=h;calcRev();}

function setRevQty(i,val){var v=parseInt(val)||0;if(v<0)v=0;revQtys[i]=v;var pk=tickPkgs[i];var sub=v*pk.price;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});var maxQ=500;var pct=Math.min(100,Math.round(v/maxQ*100));var row=document.querySelectorAll('.rev-slider-row')[i];if(row){var range=row.querySelector('.rev-range');var input=row.querySelector('.rev-qty-input');var subEl=row.querySelector('.rev-subtotal');var fill=row.querySelector('.rev-bar-fill');if(range&&range!==document.activeElement){range.value=v;range.style.background='linear-gradient(to right,'+pk.color+' '+pct+'%,var(--border-default) '+pct+'%)';}if(input&&input!==document.activeElement)input.value=v;if(subEl)subEl.textContent='$'+fmt(sub);if(fill){fill.style.width=pct+'%';fill.style.background=pk.color;}}calcRev();}

function calcRev(){var totalRev=0,totalTix=0,totalCost=0;tickPkgs.forEach(function(pk,i){var q=revQtys[i]||0;totalRev+=q*pk.price;totalTix+=q;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});totalCost+=q*pkCost;});var profit=totalRev-totalCost;document.getElementById('revTotal').textContent='$'+fmt(totalRev);document.getElementById('revTotal').style.color='#22c55e';document.getElementById('revTickets').textContent=fmt(totalTix);document.getElementById('revCost').textContent='$'+fmt(totalCost);var pEl=document.getElementById('revProfit');pEl.textContent=(profit>=0?'+$':'-$')+fmt(Math.abs(profit));pEl.style.color=profit>=0?'#22c55e':'#ef4444';}

// Init
async function init(){var s=await checkAuth();if(!s)return;userId=s.user.id;var email=s.user.email||'';if(email){var ur=await sb.from('users').select('tenant_id,user_id').eq('email',email).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}document.getElementById('dBiz').textContent=email;document.getElementById('mBiz').textContent=email;}if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}if(!tenantId){toast('Could not determine tenant');return;}await ensureTables();await loadSheets();renderSelects();var lastId=localStorage.getItem('elp-last-sponsor');if(lastId&&(lastId==='preloaded'||allSheets.find(function(s){return s.sheet_id===lastId;}))){syncSel(lastId);}else{loadPreloaded();}}
init();
window.addEventListener('beforeunload',function(){if(dirty&&currentSheetId&&currentSheetId!=='preloaded'){navigator.sendBeacon||autoSave();}});
document.addEventListener('visibilitychange',function(){if(document.hidden&&dirty)autoSave();});
document.querySelectorAll('.meta-input').forEach(function(el){el.addEventListener('blur',function(){if(currentSheetId){dirty=true;scheduleAutoSave();}});});
</script>
</body>
</html>
