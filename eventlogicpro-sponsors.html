-- Add status columns to sponsor_sheets
ALTER TABLE sponsor_sheets ADD COLUMN IF NOT EXISTS status text DEFAULT 'draft';
ALTER TABLE sponsor_sheets ADD COLUMN IF NOT EXISTS published_by uuid;
ALTER TABLE sponsor_sheets ADD COLUMN IF NOT EXISTS published_at timestamptz;
ALTER TABLE sponsor_sheets ADD COLUMN IF NOT EXISTS submitted_at timestamptz;
ALTER TABLE sponsor_sheets ADD COLUMN IF NOT EXISTS submitted_by_name text;
ALTER TABLE sponsor_sheets ADD COLUMN IF NOT EXISTS venue_name text DEFAULT '';

-- Voting table
CREATE TABLE IF NOT EXISTS sheet_votes (
  vote_id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE,
  tenant_id uuid,
  user_id uuid,
  vote int DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  UNIQUE(sheet_id, user_id)
);

ALTER TABLE sheet_votes ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS sv_all ON sheet_votes;
CREATE POLICY sv_all ON sheet_votes FOR ALL USING (true);

-- Publish history log
CREATE TABLE IF NOT EXISTS publish_history (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id uuid,
  sheet_id uuid,
  sheet_name text,
  published_by uuid,
  published_by_name text,
  published_at timestamptz DEFAULT now(),
  page_type text DEFAULT 'sponsors'
);

ALTER TABLE publish_history ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS ph_all ON publish_history;
CREATE POLICY ph_all ON publish_history FOR ALL USING (true);
