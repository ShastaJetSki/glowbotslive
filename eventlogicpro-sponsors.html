<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sponsors — EventLogicPro</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa; }
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fdfbf7;--bg-secondary:#f5f0e8;--bg-card:#fff;--bg-hover:#ebe4d6;--border-default:#d4c9b6;--text-primary:#3d3526;--text-secondary:#6b5f4e;--accent-primary:#a0845c;--accent-light:#b89a6e;}
    html{scrollbar-gutter:stable;}
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow-x:hidden;}
    body{padding-bottom:120px;}
    .desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);flex-shrink:0;}
    .mobile-top-header{display:none!important;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);position:sticky;top:0;z-index:100;}
    .mobile-header-bar{display:flex;align-items:center;padding:12px 16px;gap:12px;}
    .mobile-header-center{flex:1;min-width:0;}.mobile-header-title{font-size:16px;font-weight:600;}
    .business-name{font-size:11px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .mobile-header-right{display:flex;gap:8px;}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:6px 8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;}
    .mobile-nav-btn{padding:8px 4px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:40px;transition:all .2s;}
    .mobile-nav-btn:active{transform:scale(.95);}
    .mobile-nav-btn.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);}
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .content{max-width:900px;margin:0 auto;padding:16px;}
    .hdr-bar{display:flex;align-items:center;gap:8px;margin-bottom:0;flex-wrap:wrap;}
    .hdr-sel{flex:1;min-width:200px;padding:9px 12px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:13px;}
    .hdr-btn{padding:7px 14px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:all .15s;letter-spacing:.2px;}
    .hdr-btn:hover{color:var(--text-primary);border-color:var(--text-secondary);}
    .hdr-btn.primary{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);font-weight:600;}
    .hdr-btn.primary:hover{opacity:.9;}
    .hdr-btn.danger{color:#ef4444;border-color:rgba(239,68,68,.3);}
    .hdr-btn.danger:hover{border-color:#ef4444;background:rgba(239,68,68,.08);}
    .hdr-btn.success{color:#22c55e;border-color:rgba(34,197,94,.3);}
    .hdr-btn.success:hover{border-color:#22c55e;background:rgba(34,197,94,.08);}
    .hdr-btn.publish{background:rgba(34,197,94,.1);color:#22c55e;border-color:rgba(34,197,94,.3);font-weight:600;}
    .hdr-btn.publish:hover{background:rgba(34,197,94,.2);border-color:#22c55e;}
    .meta-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
    .meta-input{padding:10px 14px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:14px;width:100%;}
    .level-card{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;margin-bottom:12px;overflow:hidden;transition:border-color .2s;}
    .level-card:hover{border-color:var(--accent-primary);}
    .level-drag{cursor:grab;color:var(--text-secondary);padding:8px 6px;user-select:none;touch-action:none;opacity:.3;transition:opacity .2s;display:grid;grid-template-columns:repeat(2,4px);gap:3px;}
    .level-drag:hover{opacity:.7;}.level-drag:active{cursor:grabbing;opacity:1;}
    .level-drag i{display:block;width:4px;height:4px;border-radius:50%;background:currentColor;}
    .level-card.dragging{opacity:.3;border-color:var(--accent-primary);}
    .level-card.drag-over{border-top:3px solid var(--accent-primary);}
    .level-hdr{display:flex;align-items:center;padding:16px;gap:12px;cursor:pointer;user-select:none;}
    .level-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
    .level-info{flex:1;min-width:0;}
    .level-name{font-size:16px;font-weight:700;}
    .level-sub{font-size:12px;color:var(--text-secondary);margin-top:2px;}
    .level-price{font-size:18px;font-weight:700;margin-right:8px;}
    .level-del{width:28px;height:28px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
    .level-del:hover{color:#ef4444;border-color:#ef4444;}
    .level-chv{font-size:12px;color:var(--text-secondary);transition:transform .2s;}
    .level-card.expanded .level-chv{transform:rotate(180deg);}
    .level-body{max-height:0;overflow:hidden;transition:max-height .35s ease;}
    .level-card.expanded .level-body{max-height:5000px;}
    .level-inner{padding:0 16px 16px;}
    .level-meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;}
    .lm-label{font-size:11px;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;}
    .lm-input{padding:8px 12px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:14px;width:100%;}
    .lm-color{width:100%;height:36px;border-radius:8px;border:1px solid var(--border-default);cursor:pointer;background:none;padding:2px;}
    .perks-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .perk-row{display:grid;grid-template-columns:50px 1fr 80px 80px 32px;gap:8px;align-items:center;margin-bottom:6px;}
    .perk-qty{padding:8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:14px;text-align:center;width:100%;}
    .perk-name{padding:8px 12px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:14px;width:100%;}
    .perk-del{width:28px;height:28px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
    .perk-del:hover{color:#ef4444;border-color:#ef4444;}
    .perk-cost{padding:8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:#22c55e;font-size:13px;text-align:right;width:100%;}
    .perk-value{padding:8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--accent-light);font-size:13px;text-align:right;width:100%;}
    .add-perk-btn{display:block;width:100%;padding:8px;border-radius:8px;border:1px dashed var(--border-default);background:transparent;color:var(--text-secondary);font-size:13px;cursor:pointer;text-align:center;margin-top:6px;}
    .add-perk-btn:hover{background:var(--bg-hover);color:var(--text-primary);border-color:var(--accent-primary);}
    .add-level-btn{display:block;width:100%;padding:14px;border-radius:12px;border:2px dashed var(--border-default);background:transparent;color:var(--text-secondary);font-size:15px;font-weight:600;cursor:pointer;text-align:center;margin-top:8px;}
    .add-level-btn:hover{background:var(--bg-hover);color:var(--text-primary);border-color:var(--accent-primary);}
    .section-add-btn{padding:4px 12px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--accent-primary);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;}
    .section-add-btn:hover{background:var(--accent-primary);color:#fff;}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-card);color:var(--text-primary);padding:12px 24px;border-radius:10px;border:1px solid var(--border-default);font-size:14px;opacity:0;transition:opacity .3s;z-index:9999;pointer-events:none;}
    .toast.show{opacity:1;}
    .save-indicator{position:fixed;top:12px;right:12px;z-index:9999;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;opacity:0;transition:opacity .3s;pointer-events:none;}
    .save-indicator.saving{opacity:1;background:var(--accent-primary);color:#fff;}
    .save-indicator.saved{opacity:1;background:#22c55e;color:#fff;}
    .save-indicator.fade{opacity:0;}
    .summary-bar{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;padding:16px;margin-bottom:16px;display:grid;grid-template-columns:repeat(5,1fr);gap:12px;text-align:center;}
    .sb-val{font-size:22px;font-weight:700;}
    .sb-lbl{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
    .section-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin-bottom:10px;display:flex;align-items:center;cursor:pointer;user-select:none;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;}
    .section-title:hover{color:var(--text-primary);border-color:var(--accent-primary);}
    .section-title-left{flex:1;display:flex;align-items:center;gap:8px;}
    .section-chv{font-size:18px;margin-left:auto;transition:transform .3s;display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;background:var(--bg-hover);color:var(--text-secondary);flex-shrink:0;}
    .section-title:hover .section-chv{color:var(--text-primary);}
    .section-wrap{overflow:hidden;transition:max-height .35s ease,opacity .25s ease;max-height:0;opacity:0;}
    .section-wrap.open{max-height:none;opacity:1;}
    @media(max-width:768px){
      .desktop-header{display:none!important;}
      .mobile-top-header{display:block!important;}
      .mobile-bottom-nav{display:block!important;}
      body{padding-bottom:80px;}
      .content{padding:10px 8px;}
      .review-card{flex-wrap:wrap;gap:8px;padding:10px;}
      .review-actions{width:100%;justify-content:flex-end;}
      .meta-row{grid-template-columns:1fr;gap:8px;}
      .summary-bar{grid-template-columns:repeat(3,1fr);gap:6px;padding:10px;margin-bottom:12px;}
      .sb-val{font-size:16px;}
      .sb-lbl{font-size:8px;}
      .section-title{font-size:11px;letter-spacing:.5px;}
      .section-add-btn{font-size:10px;padding:3px 8px;}
      .level-card{margin-bottom:8px;}
      .level-hdr{padding:10px;gap:6px;}
      .level-drag{padding:2px;min-width:16px;}
      .level-drag i{width:3px;height:3px;}
      .level-dot{width:10px;height:10px;}
      .level-name{font-size:13px;}
      .level-sub{font-size:9px;}
      .level-price{font-size:14px;min-width:auto;}
      .level-del{width:22px;height:22px;font-size:11px;}
      .level-chv{font-size:9px;}
      .level-inner{padding:10px;}
      .level-meta{grid-template-columns:1fr 1fr;gap:8px;}
      .perk-row{grid-template-columns:44px 1fr 28px!important;grid-template-rows:auto auto;gap:3px 5px!important;margin-bottom:8px!important;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.04);}
      .perk-qty{grid-column:1;grid-row:1;}
      .perk-name{grid-column:2;grid-row:1;font-size:12px;padding:6px;}
      .perk-del{grid-column:3;grid-row:1;width:28px;height:28px;font-size:11px;}
      .perk-value{grid-column:1/2;grid-row:2;font-size:11px;padding:5px;width:auto!important;text-align:center;}
      .perk-cost{grid-column:2/4;grid-row:2;font-size:11px;padding:5px;width:auto!important;text-align:left;}
      .perks-title{font-size:10px;margin-bottom:6px;}
      .perks-title span:last-child{display:none;}
      .add-perk-btn{padding:6px;font-size:12px;margin-top:4px;}
      .mobile-nav-btn{font-size:10px;padding:6px 2px;min-height:34px;}
    }
    .rev-dashboard{background:var(--bg-card);border:1px solid var(--border-default);border-radius:12px;padding:20px;margin-bottom:16px;}
    .rev-section{border:1px solid var(--border-default);border-radius:8px;margin-bottom:8px;overflow:hidden;transition:border-color .2s;}
    .rev-section.drag-over{border-color:var(--accent-primary);}
    .rev-section.dragging{opacity:.4;}
    .rev-section-hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg-hover);cursor:default;}
    .rev-section-drag{cursor:grab;display:grid;grid-template-columns:repeat(2,4px);gap:3px;padding:4px 2px;opacity:.4;transition:opacity .2s;}
    .rev-section-drag:hover{opacity:1;}
    .rev-section-drag i{width:4px;height:4px;border-radius:1px;background:var(--text-secondary);display:block;}
    .rev-section-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);flex:1;}
    .rev-section-stats{font-size:11px;color:var(--text-secondary);white-space:nowrap;}
    .rev-total-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;text-align:center;}
    .rev-total-card{background:var(--bg-hover);border-radius:10px;padding:14px 8px;}
    .rev-total-val{font-size:24px;font-weight:800;}
    .rev-total-lbl{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}
    .rev-slider-row{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--border-default);}
    .rev-slider-row:last-child{border-bottom:none;}
    .rev-slider-left{min-width:0;flex-shrink:0;width:140px;}
    .rev-slider-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .rev-slider-price{font-size:12px;color:var(--text-secondary);}
    .rev-slider-mid{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0;}
    .rev-range-wrap{position:relative;height:28px;display:flex;align-items:center;}
    .rev-actual-marker{position:absolute;top:50%;width:3px;height:20px;border-radius:2px;background:#fff;transform:translate(-50%,-50%);pointer-events:none;z-index:2;opacity:.85;box-shadow:0 0 6px rgba(255,255,255,.4);}
    .rev-actual-label{position:absolute;top:-13px;transform:translateX(-50%);font-size:8px;font-weight:700;color:#fff;pointer-events:none;white-space:nowrap;opacity:.85;}
    .rev-range{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:3px;background:var(--border-default);outline:none;cursor:pointer;}
    .rev-range::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent-primary);border:2px solid var(--bg-card);cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,.3);}
    .rev-range::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent-primary);border:2px solid var(--bg-card);cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,.3);}
    .rev-range::-webkit-slider-thumb:active{cursor:grabbing;transform:scale(1.15);}
    .rev-ticks{display:flex;justify-content:space-between;padding:0 2px;}
    .rev-tick{font-size:9px;color:var(--text-secondary);}
    .rev-slider-right{text-align:right;flex-shrink:0;width:120px;}
    .rev-qty-row{display:flex;align-items:flex-start;gap:6px;justify-content:flex-end;}
    .rev-qty-input{width:48px;padding:5px 2px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-hover);color:var(--text-primary);font-size:14px;font-weight:700;text-align:center;}
    .rev-actual-input{width:48px;padding:5px 2px;border-radius:6px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.06);color:#fff;font-size:14px;font-weight:700;text-align:center;}
    .rev-input-col{display:flex;flex-direction:column;align-items:center;}
    .rev-input-lbl{font-size:8px;text-transform:uppercase;letter-spacing:.3px;color:var(--text-secondary);margin-top:2px;}
    .rev-subtotal{font-size:16px;font-weight:700;color:#22c55e;margin-top:2px;}
    .rev-bar{height:4px;border-radius:2px;background:var(--border-default);margin-top:2px;overflow:hidden;}
    .rev-bar-fill{height:100%;border-radius:2px;transition:width .15s ease;}
    @media(max-width:768px){
      .rev-dashboard{padding:10px;margin-bottom:12px;}
      .rev-total-row{grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:10px;}
      .rev-total-val{font-size:16px;}
      .rev-total-lbl{font-size:7px;letter-spacing:.3px;}
      .rev-total-card{padding:8px 4px;}
      .rev-slider-row{flex-direction:column;gap:6px;padding:10px 0;}
      .rev-slider-left{width:100%;display:flex;justify-content:space-between;align-items:center;}
      .rev-slider-name{font-size:13px;white-space:normal;}
      .rev-slider-price{font-size:10px;white-space:nowrap;}
      .rev-slider-mid{width:100%;}
      .rev-slider-right{width:100%;display:flex;align-items:center;gap:6px;}
      .rev-qty-row{flex-direction:row;gap:6px;align-items:center;}
      .rev-input-col{flex-direction:row;align-items:center;gap:3px;}
      .rev-input-lbl{margin-top:0;font-size:7px;}
      .rev-qty-input,.rev-actual-input{width:46px;padding:5px 2px;font-size:14px;}
      .rev-subtotal{font-size:16px;flex:1;text-align:right;margin-top:0;}
      .rev-bar{display:none;}
      .rev-ticks{font-size:7px;margin-top:-2px;}
      .rev-range::-webkit-slider-thumb{width:24px;height:24px;}
      .rev-range::-moz-range-thumb{width:24px;height:24px;}
      .rev-range{height:8px;}
    }
    @media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}body{padding-bottom:20px;}}
    @media print{
      body{background:#fff!important;color:#000!important;padding:0!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
      .desktop-header,.mobile-top-header,.mobile-bottom-nav,.toast,.save-indicator,.hdr-bar,.level-drag,.level-del,.perk-del,.add-perk-btn,.add-level-btn,.section-add-btn,.print-btn,.rev-section-drag,.view-tabs,.review-panel,.official-banner,.readonly-overlay{display:none!important;}
      .content{max-width:100%!important;padding:8px!important;}
      .section-wrap{max-height:none!important;opacity:1!important;overflow:visible!important;}
      .level-body{max-height:none!important;overflow:visible!important;}
      .level-card{break-inside:avoid;border:1px solid #ccc!important;margin-bottom:8px!important;background:#fff!important;}
      .level-card.expanded .level-body,.level-body{max-height:none!important;}
      .level-hdr{cursor:default!important;}
      .level-chv{display:none!important;}
      .summary-bar,.rev-dashboard{background:#f9f9f9!important;border:1px solid #ccc!important;}
      .sb-val,.level-name,.level-price,.rev-total-val,.rev-subtotal{color:#000!important;}
      .sb-lbl,.level-sub,.rev-total-lbl,.rev-slider-price,.rev-tick,.rev-input-lbl,.perks-title,.section-title,.lm-label{color:#555!important;}
      .perk-row{border-bottom:1px solid #eee!important;}
      .perk-qty,.perk-name,.perk-value,.perk-cost,.lm-input,.meta-input{border:1px solid #ccc!important;background:#fff!important;color:#000!important;-webkit-print-color-adjust:exact;}
      .rev-range-wrap,.rev-ticks,.rev-bar,.rev-actual-input,.rev-qty-input{display:none!important;}
      .rev-slider-row{border-bottom:1px solid #eee!important;padding:6px 0!important;}
      .rev-slider-right{width:auto!important;}
      .rev-qty-row{display:none!important;}
      .rev-subtotal{font-size:14px!important;}
      .rev-total-card{background:#f0f0f0!important;border:1px solid #ccc!important;}
      .rev-section{border:1px solid #ccc!important;break-inside:avoid;}
      .rev-section-hdr{background:#f0f0f0!important;}
      .level-dot{-webkit-print-color-adjust:exact;print-color-adjust:exact;}
      .print-header{display:block!important;text-align:center;padding:16px 0;border-bottom:2px solid #000;margin-bottom:16px;}
      .print-header h1{font-size:24px;margin:0;}
      .print-header p{font-size:14px;color:#555;margin:4px 0 0;}
      input[type="color"]{display:none!important;}
      .lm-color{display:none!important;}
      .level-meta{grid-template-columns:1fr 1fr!important;}
    }
    .print-header{display:none;}
    .print-btn{padding:7px 14px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:all .15s;letter-spacing:.2px;}
    .print-btn:hover{color:var(--text-primary);border-color:var(--text-secondary);}
    .view-tabs{display:flex;gap:0;padding:0 24px 12px;background:var(--bg-secondary);}
    .view-tab{padding:7px 16px;border:none;border-bottom:2px solid transparent;background:none;color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s;text-transform:uppercase;letter-spacing:.8px;}
    .view-tab:hover{color:var(--text-primary);}
    .view-tab.active{color:var(--accent-primary);border-bottom-color:var(--accent-primary);}
    .view-tab .tab-badge{display:inline-block;background:rgba(255,255,255,.08);border-radius:10px;padding:1px 6px;font-size:10px;margin-left:4px;font-weight:700;}
    .view-tab.active .tab-badge{background:rgba(99,102,241,.15);color:var(--accent-primary);}
    .review-panel{display:none;padding:16px;}
    .review-panel.show{display:block;}
    .review-card{background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:border-color .2s;}
    .review-card:hover{border-color:var(--accent-primary);}
    .review-card.published{border-color:#22c55e;border-width:2px;}
    .review-vote{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:44px;}
    .vote-btn{width:32px;height:24px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .vote-btn:hover{border-color:var(--accent-primary);color:var(--accent-primary);}
    .vote-btn.voted-up{background:#22c55e;color:#fff;border-color:#22c55e;}
    .vote-btn.voted-down{background:#ef4444;color:#fff;border-color:#ef4444;}
    .vote-score{font-size:16px;font-weight:700;color:var(--text-primary);line-height:1;}
    .review-info{flex:1;min-width:0;}
    .review-name{font-size:14px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .review-meta{font-size:11px;color:var(--text-secondary);margin-top:2px;}
    .review-actions{display:flex;gap:6px;flex-shrink:0;}
    .status-badge{display:inline-block;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border-radius:10px;}
    .status-draft{background:rgba(255,255,255,.08);color:var(--text-secondary);}
    .status-submitted{background:rgba(59,130,246,.15);color:#3b82f6;}
    .status-published{background:rgba(34,197,94,.15);color:#22c55e;}
    .official-banner{background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.02));border:1px solid rgba(34,197,94,.2);border-radius:10px;padding:14px 18px;margin-bottom:12px;}
    .official-banner-text{font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:2px;}
    .official-banner-sub{font-size:12px;color:var(--text-secondary);}
    .readonly-overlay{pointer-events:none;opacity:.85;}
    .publish-log{margin-top:16px;border-top:1px solid var(--border-default);padding-top:12px;}
    .publish-log-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-secondary);margin-bottom:8px;}
    .publish-log-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:12px;}
    .publish-log-row:last-child{border-bottom:none;}
    .publish-log-dot{width:6px;height:6px;border-radius:50%;background:#22c55e;flex-shrink:0;}
    .publish-log-name{color:var(--text-primary);font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .publish-log-by{color:var(--text-secondary);}
    .publish-log-date{color:var(--text-secondary);flex-shrink:0;font-size:11px;}
    @media(max-width:400px){
      .summary-bar{grid-template-columns:repeat(2,1fr);}
      .rev-total-row{gap:4px;}
      .rev-total-val{font-size:14px;}
      .mobile-nav-top{grid-template-columns:repeat(3,1fr);}
      .mobile-nav-btn{font-size:8px;padding:4px 1px;min-height:30px;}
      .level-price{font-size:13px;}
      .level-hdr{padding:8px 6px;gap:4px;}
      .level-name{font-size:12px;}
      .level-sub{font-size:8px;}
      .perk-row{gap:2px 4px!important;}
      .perk-qty,.perk-name,.perk-value,.perk-cost{font-size:11px!important;padding:5px!important;}
      .rev-qty-input,.rev-actual-input{width:40px;font-size:12px;}
      .rev-subtotal{font-size:14px;}
      .rev-slider-name{font-size:12px;}
    }
  </style>
</head>
<body>
<div class="print-header"><h1 id="printTitle">Sponsor Sheet</h1><p id="printSub"></p></div>
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <div class="mobile-header-center"><div class="mobile-header-title">Sponsors</div><div class="business-name" id="mBiz">Loading...</div></div>
    <div class="mobile-header-right"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button></div>
  </div>
  <div style="padding:0 16px 6px;">
    <select class="hdr-sel" id="mobSheetSel" onchange="syncSel(this.value)" style="width:100%;"></select>
    <div style="display:flex;gap:4px;margin-top:6px;">
      <button class="hdr-btn primary" onclick="createSheet()" style="flex:1;">New</button>
      <button class="hdr-btn" onclick="saveToDb()" style="flex:1;">Save</button>
      <button class="print-btn" onclick="printSheet()" style="flex:1;">Print</button>
      <button class="hdr-btn success" id="mobSubmitBtn" onclick="submitForReview()" style="display:none;flex:1;">Submit</button>
      <button class="hdr-btn publish" id="mobPublishBtn" onclick="publishSheet()" style="display:none;flex:1;">Publish</button>
      <button class="hdr-btn danger" id="mobDelBtn" onclick="deleteSheet()" style="display:none;flex:1;">Delete</button>
    </div>
    <div style="display:flex;gap:0;margin-top:6px;border-bottom:1px solid var(--border-default);">
      <div class="view-tab active" onclick="setViewMode('editor')" style="flex:1;text-align:center;font-size:10px;padding:6px 4px;">My Sheets</div>
      <div class="view-tab" onclick="setViewMode('review')" style="flex:1;text-align:center;font-size:10px;padding:6px 4px;">Review <span class="tab-badge" id="mobReviewCount">0</span></div>
      <div class="view-tab" onclick="setViewMode('official')" style="flex:1;text-align:center;font-size:10px;padding:6px 4px;">Official</div>
    </div>
  </div>
</div>

<!-- Desktop Header -->
<div class="desktop-header">
  <div style="padding:14px 24px 6px;display:flex;justify-content:space-between;align-items:center;">
    <div><h1 style="margin:0;font-size:28px;font-weight:600;">EventLogicPro</h1><div class="business-name" id="dBiz">Loading...</div></div>
    <div style="display:flex;align-items:center;gap:16px;"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button><a onclick="doLogout()" style="color:var(--text-secondary);cursor:pointer;font-size:13px;">Logout</a></div>
  </div>
  <div style="padding:0 24px 10px;"><nav style="display:flex;gap:24px;"><a href="eventlogicpro-scheduler.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Calendar</a><a href="eventlogicpro.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Tasks</a><a href="eventlogicpro-estimator.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Budget</a><a href="eventlogicpro-sponsors.html" style="padding:10px 0;color:var(--accent-primary);text-decoration:none;font-size:13px;border-bottom:2px solid var(--accent-primary);">Sponsors</a><a href="eventlogicpro-sitemap.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Site Map</a></nav></div>
  <div class="hdr-bar" style="padding:0 24px 8px;">
    <select class="hdr-sel" id="deskSheetSel" onchange="syncSel(this.value)"></select>
    <button class="hdr-btn primary" onclick="createSheet()">New Sheet</button>
    <button class="hdr-btn" onclick="saveToDb()">Save</button>
    <button class="print-btn" onclick="printSheet()">Print</button>
    <button class="hdr-btn success" id="deskSubmitBtn" onclick="submitForReview()" style="display:none;">Submit for Review</button>
    <button class="hdr-btn publish" id="deskPublishBtn" onclick="publishSheet()" style="display:none;">Publish as Official</button>
    <button class="hdr-btn danger" id="deskDelBtn" onclick="deleteSheet()" style="display:none;">Delete</button>
  </div>
  <div class="view-tabs" id="deskViewTabs" style="border-bottom:1px solid var(--border-default);">
    <div class="view-tab active" onclick="setViewMode('editor')">My Sheets</div>
    <div class="view-tab" onclick="setViewMode('review')">Review Board <span class="tab-badge" id="deskReviewCount">0</span></div>
    <div class="view-tab" onclick="setViewMode('official')">Official</div>
  </div>
</div>

<!-- Content -->
<div class="content">
  <!-- Review Board Panel -->
  <div class="review-panel" id="reviewPanel">
    <div style="font-size:18px;font-weight:700;margin-bottom:4px;color:var(--text-primary);">Review Board</div>
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">Vote on submitted budget proposals. Admins can publish the winning version.</div>
    <div id="reviewCards"></div>
    <div id="reviewEmpty" style="text-align:center;padding:40px 20px;color:var(--text-secondary);font-size:13px;">No sheets submitted for review yet.<br>Create a sheet and click "Submit for Review" to start.</div>
  </div>

  <!-- Official View -->
  <div id="officialView" style="display:none;">
    <div class="official-banner" id="officialBanner">
      <div class="official-banner-text">Official Budget</div>
      <div class="official-banner-sub" id="officialMeta">No official budget published yet</div>
    </div>
    <div class="publish-log" id="publishLogArea">
      <div class="publish-log-title">Publish History</div>
      <div id="publishLogRows"></div>
    </div>
  </div>

  <!-- Editor -->
  <div id="editorView">
  <div class="meta-row">
    <input class="meta-input" id="sheetName" placeholder="Sheet name (e.g., Redding Rock 2026)" oninput="dirty=true;scheduleAutoSave();">
    <input class="meta-input" id="sheetEvent" placeholder="Event name" oninput="dirty=true;scheduleAutoSave();">
  </div>

  <!-- SPONSOR LEVELS -->
  <div class="summary-bar" id="summaryBar" style="grid-template-columns:repeat(5,1fr);">
    <div><div class="sb-val" id="kpiGoalRev" style="color:#22c55e;">$0</div><div class="sb-lbl">Goal Revenue</div></div>
    <div><div class="sb-val" id="kpiActualRev" style="color:#fff;">$0</div><div class="sb-lbl">Actual Revenue</div></div>
    <div><div class="sb-val" id="kpiTotalCost" style="color:#f59e0b;">$0</div><div class="sb-lbl">Total Cost</div></div>
    <div><div class="sb-val" id="kpiProfit">$0</div><div class="sb-lbl">Net Profit</div></div>
    <div><div class="sb-val" id="kpiSold" style="color:var(--accent-light);">0</div><div class="sb-lbl">Actual Sold</div></div>
  </div>
  <div class="summary-bar" id="deptBar" style="grid-template-columns:repeat(4,1fr);margin-top:-8px;">
    <div><div class="sb-val" id="kpiSponsor" style="font-size:16px;">$0</div><div class="sb-lbl">Sponsors</div></div>
    <div><div class="sb-val" id="kpiTicket" style="font-size:16px;">$0</div><div class="sb-lbl">Tickets</div></div>
    <div><div class="sb-val" id="kpiVendor" style="font-size:16px;">$0</div><div class="sb-lbl">Vendors</div></div>
    <div><div class="sb-val" id="kpiCamping" style="font-size:16px;">$0</div><div class="sb-lbl">Camping</div></div>
  </div>
  <div class="section-title" onclick="toggleSection('sponsorSec',this)"><span class="section-title-left">SPONSOR LEVELS</span><button class="section-add-btn" onclick="event.stopPropagation();addLevel()">+ Add Level</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="sponsorSec">
    <div id="levelsArea"></div>
  </div>

  <!-- TICKET PACKAGES -->
  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('ticketSec',this)"><span class="section-title-left">TICKET PACKAGES</span><button class="section-add-btn" onclick="event.stopPropagation();addTickPkg()">+ Add Package</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="ticketSec">
    <div class="summary-bar" id="tickSummary">
      <div><div class="sb-val" id="tbPkgs">0</div><div class="sb-lbl">Packages</div></div>
      <div><div class="sb-val" id="tbItems">0</div><div class="sb-lbl">Total Items</div></div>
      <div><div class="sb-val" id="tbValue" style="color:var(--accent-light);">$0</div><div class="sb-lbl">Total Value</div></div>
      <div><div class="sb-val" id="tbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
      <div><div class="sb-val" id="tbOffset">$0</div><div class="sb-lbl">Offset</div></div>
    </div>
    <div id="tickArea"></div>
  </div>

  <!-- VENDOR PACKAGES -->
  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('vendorSec',this)"><span class="section-title-left">VENDOR PACKAGES</span><button class="section-add-btn" onclick="event.stopPropagation();addVendorPkg()">+ Add Package</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="vendorSec">
    <div class="summary-bar" id="vendorSummary">
      <div><div class="sb-val" id="vbPkgs">0</div><div class="sb-lbl">Packages</div></div>
      <div><div class="sb-val" id="vbItems">0</div><div class="sb-lbl">Total Items</div></div>
      <div><div class="sb-val" id="vbValue" style="color:var(--accent-light);">$0</div><div class="sb-lbl">Total Value</div></div>
      <div><div class="sb-val" id="vbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
      <div><div class="sb-val" id="vbOffset">$0</div><div class="sb-lbl">Offset</div></div>
    </div>
    <div id="vendorArea"></div>
  </div>

  <!-- CAMPING PACKAGES -->
  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('campingSec',this)"><span class="section-title-left">CAMPING PACKAGES</span><button class="section-add-btn" onclick="event.stopPropagation();addCampingPkg()">+ Add Package</button><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="campingSec">
    <div class="summary-bar" id="campingSummary">
      <div><div class="sb-val" id="cbPkgs">0</div><div class="sb-lbl">Packages</div></div>
      <div><div class="sb-val" id="cbItems">0</div><div class="sb-lbl">Total Items</div></div>
      <div><div class="sb-val" id="cbValue" style="color:var(--accent-light);">$0</div><div class="sb-lbl">Total Value</div></div>
      <div><div class="sb-val" id="cbCost" style="color:#22c55e;">$0</div><div class="sb-lbl">Total Cost</div></div>
      <div><div class="sb-val" id="cbOffset">$0</div><div class="sb-lbl">Offset</div></div>
    </div>
    <div id="campingArea"></div>
  </div>

  <!-- REVENUE ESTIMATOR -->
  <div class="section-title" style="margin-top:16px;" onclick="toggleSection('revSec',this)"><span class="section-title-left">REVENUE ESTIMATOR</span><span class="section-chv">▸</span></div>
  <div class="section-wrap" id="revSec">
  <div class="rev-dashboard" id="revDash">
    <div class="rev-total-row">
      <div class="rev-total-card">
        <div class="rev-total-val" id="revGoalQty" style="color:var(--accent-light);">0</div>
        <div class="rev-total-lbl">Goal Sold</div>
      </div>
      <div class="rev-total-card">
        <div class="rev-total-val" id="revActualQty" style="color:#22c55e;">0</div>
        <div class="rev-total-lbl">Actual Sold</div>
      </div>
      <div class="rev-total-card">
        <div class="rev-total-val" id="revPctSold" style="color:#fff;">0%</div>
        <div class="rev-total-lbl">% of Goal</div>
      </div>
      <div class="rev-total-card">
        <div class="rev-total-val" id="revRemaining" style="color:#f59e0b;">0</div>
        <div class="rev-total-lbl">Remaining</div>
      </div>
    </div>
    <div class="rev-total-row" style="margin-top:-8px;">
      <div class="rev-total-card" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);">
        <div class="rev-total-val" style="font-size:16px;" id="revSponsorQty">0 / 0</div>
        <div class="rev-total-lbl" style="color:rgba(255,255,255,.5);">Sponsors</div>
      </div>
      <div class="rev-total-card" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);">
        <div class="rev-total-val" style="font-size:16px;" id="revTicketQty">0 / 0</div>
        <div class="rev-total-lbl" style="color:rgba(255,255,255,.5);">Tickets</div>
      </div>
      <div class="rev-total-card" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);">
        <div class="rev-total-val" style="font-size:16px;" id="revVendorQty">0 / 0</div>
        <div class="rev-total-lbl" style="color:rgba(255,255,255,.5);">Vendors</div>
      </div>
      <div class="rev-total-card" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);">
        <div class="rev-total-val" style="font-size:16px;" id="revCampingQty">0 / 0</div>
        <div class="rev-total-lbl" style="color:rgba(255,255,255,.5);">Camping</div>
      </div>
    </div>
    <div id="revSliders"></div>
  </div>
  </div>
  </div><!-- close editorView -->
</div>

<div class="mobile-bottom-nav"><div class="mobile-nav-top"><a href="eventlogicpro-scheduler.html" class="mobile-nav-btn">Calendar</a><a href="eventlogicpro.html" class="mobile-nav-btn">Tasks</a><a href="eventlogicpro-estimator.html" class="mobile-nav-btn">Budget</a><a href="eventlogicpro-sponsors.html" class="mobile-nav-btn active">Sponsors</a><a href="eventlogicpro-sitemap.html" class="mobile-nav-btn">Site Map</a></div></div>
<div id="toast" class="toast"></div>
<div id="saveInd" class="save-indicator"></div>

<script>
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);
var tenantId=null,userId=null,dirty=false;
var allSheets=[],currentSheetId=null,levels=[],tickPkgs=[],vendorPkgs=[],campingPkgs=[];
var autoSaveTimer=null,saving=false;
function scheduleAutoSave(){if(autoSaveTimer)clearTimeout(autoSaveTimer);autoSaveTimer=setTimeout(function(){autoSave();},3000);}
function showSaveStatus(status){var el=document.getElementById('saveInd');el.className='save-indicator '+status;el.textContent=status==='saving'?'Saving...':'Saved ✓';if(status==='saved')setTimeout(function(){el.classList.add('fade');},1500);}
async function autoSave(){if(!dirty||saving||!currentSheetId||!tenantId)return;saving=true;showSaveStatus('saving');try{await saveToDb(true);}catch(e){console.error('Auto-save error:',e);}saving=false;}
var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal','cyber','amber','honey','crimson','coral','rose','sand'];
var ti=Math.max(0,themes.indexOf(localStorage.getItem('app-theme')||'dark-blue'));
function cycleTheme(){ti=(ti+1)%themes.length;var t=themes[ti];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);toast('Theme: '+t.replace(/-/g,' '));}
function toast(msg){var el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2500);}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function fmt(n){return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});}
async function checkAuth(){var r=await sb.auth.getSession();var s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){window.location.href='login.html';return null;}}return s;}
async function doLogout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}

// Default perk templates
var DEFAULT_PERKS=[
  {name:'Event Tickets',qty:0,value:0,cost:0},{name:'VIP Passes',qty:0,value:0,cost:0},{name:'T-Shirts',qty:0,value:0,cost:0},
  {name:'Banner Placement',qty:0,value:0,cost:0},{name:'Stage Mention',qty:0,value:0,cost:0},{name:'Screen Ad Rotation',qty:0,value:0,cost:0},
  {name:'Social Media Shoutout',qty:0,value:0,cost:0},{name:'Booth Space',qty:0,value:0,cost:0},{name:'Logo on Flyer/Poster',qty:0,value:0,cost:0},
  {name:'Website Logo/Link',qty:0,value:0,cost:0},{name:'MC Announcement',qty:0,value:0,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:0,cost:0}
];

function makeDefaults(){
  return [
    {name:'Platinum',color:'#a78bfa',price:3500,perks:[
      {name:'Event Tickets',qty:20,value:25,cost:10},{name:'VIP Passes',qty:10,value:75,cost:25},{name:'T-Shirts',qty:10,value:25,cost:12},
      {name:'Banner Placement',qty:2,value:150,cost:50},{name:'Stage Mention',qty:4,value:50,cost:0},{name:'Screen Ad Rotation',qty:1,value:100,cost:25},
      {name:'Social Media Shoutout',qty:5,value:30,cost:0},{name:'Booth Space',qty:1,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},
      {name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:3,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:1,value:100,cost:0}
    ]},
    {name:'Gold',color:'#fbbf24',price:2000,perks:[
      {name:'Event Tickets',qty:10,value:25,cost:10},{name:'VIP Passes',qty:4,value:75,cost:25},{name:'T-Shirts',qty:6,value:25,cost:12},
      {name:'Banner Placement',qty:1,value:150,cost:50},{name:'Stage Mention',qty:2,value:50,cost:0},{name:'Screen Ad Rotation',qty:1,value:100,cost:25},
      {name:'Social Media Shoutout',qty:3,value:30,cost:0},{name:'Booth Space',qty:1,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},
      {name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:1,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:100,cost:0}
    ]},
    {name:'Silver',color:'#94a3b8',price:1500,perks:[
      {name:'Event Tickets',qty:6,value:25,cost:10},{name:'VIP Passes',qty:2,value:75,cost:25},{name:'T-Shirts',qty:4,value:25,cost:12},
      {name:'Banner Placement',qty:1,value:150,cost:50},{name:'Stage Mention',qty:1,value:50,cost:0},{name:'Screen Ad Rotation',qty:0,value:100,cost:25},
      {name:'Social Media Shoutout',qty:2,value:30,cost:0},{name:'Booth Space',qty:0,value:200,cost:0},{name:'Logo on Flyer/Poster',qty:1,value:75,cost:15},
      {name:'Website Logo/Link',qty:1,value:50,cost:0},{name:'MC Announcement',qty:0,value:25,cost:0},{name:'Photo Op / Meet & Greet',qty:0,value:100,cost:0}
    ]}
  ];
}

// Ticket defaults with value field
function makeDefaultTicks(){return[
  {name:'VIP Bundle',color:'#a78bfa',price:85,items:[
    {name:'VIP Admission',qty:1,value:40,cost:15},{name:'Drink Ticket',qty:3,value:8,cost:3},{name:'T-Shirt',qty:1,value:25,cost:12},{name:'Food Voucher',qty:2,value:10,cost:5},{name:'Parking Pass',qty:1,value:10,cost:2},{name:'Meet & Greet Access',qty:1,value:20,cost:0}
  ]},
  {name:'Party Pack',color:'#22c55e',price:55,items:[
    {name:'General Admission',qty:1,value:25,cost:8},{name:'Drink Ticket',qty:2,value:8,cost:3},{name:'T-Shirt',qty:1,value:25,cost:12},{name:'Food Voucher',qty:1,value:10,cost:5}
  ]},
  {name:'General Admission',color:'#3b82f6',price:25,items:[
    {name:'General Admission Ticket',qty:1,value:20,cost:8},{name:'Drink Ticket',qty:1,value:8,cost:3}
  ]}
];}

// Vendor defaults
function makeDefaultVendors(){return[
  {name:'Premium Vendor',color:'#f59e0b',price:500,items:[
    {name:'10x10 Booth Space',qty:1,value:300,cost:50},{name:'Table & Chairs',qty:1,value:50,cost:20},{name:'Power Hookup',qty:1,value:40,cost:15},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Vendor Parking Pass',qty:2,value:10,cost:2},{name:'Logo on Event Map',qty:1,value:50,cost:10}
  ]},
  {name:'Standard Vendor',color:'#06b6d4',price:300,items:[
    {name:'10x10 Booth Space',qty:1,value:200,cost:50},{name:'Table & Chairs',qty:1,value:50,cost:20},{name:'Event Tickets',qty:2,value:25,cost:10},{name:'Vendor Parking Pass',qty:1,value:10,cost:2}
  ]},
  {name:'Food Vendor',color:'#ef4444',price:400,items:[
    {name:'10x10 Booth Space',qty:1,value:250,cost:50},{name:'Table & Chairs',qty:2,value:50,cost:20},{name:'Power Hookup',qty:1,value:40,cost:15},{name:'Water Access',qty:1,value:30,cost:10},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Vendor Parking Pass',qty:2,value:10,cost:2}
  ]}
];}

var DEFAULT_VENDOR_ITEMS=[{name:'Booth Space',qty:0,value:0,cost:0},{name:'Table & Chairs',qty:0,value:0,cost:0},{name:'Power Hookup',qty:0,value:0,cost:0},{name:'Event Tickets',qty:0,value:0,cost:0},{name:'Vendor Parking Pass',qty:0,value:0,cost:0}];
var DEFAULT_TICK_ITEMS=[{name:'General Admission Ticket',qty:1,value:0,cost:0},{name:'Drink Ticket',qty:0,value:0,cost:0},{name:'T-Shirt',qty:0,value:0,cost:0},{name:'Food Voucher',qty:0,value:0,cost:0},{name:'Parking Pass',qty:0,value:0,cost:0}];
var DEFAULT_CAMPING_ITEMS=[{name:'Campsite Spot',qty:0,value:0,cost:0},{name:'Parking Pass',qty:0,value:0,cost:0},{name:'Shower Access',qty:0,value:0,cost:0},{name:'Event Tickets',qty:0,value:0,cost:0},{name:'Firewood Bundle',qty:0,value:0,cost:0}];

function makeDefaultCamping(){return[
  {name:'Premium Campsite',color:'#22c55e',price:150,items:[
    {name:'Premium Campsite Spot',qty:1,value:100,cost:15},{name:'Parking Pass',qty:2,value:10,cost:2},{name:'Shower Access',qty:1,value:20,cost:5},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Firewood Bundle',qty:2,value:10,cost:4},{name:'Early Check-in',qty:1,value:15,cost:0}
  ]},
  {name:'Standard Campsite',color:'#3b82f6',price:75,items:[
    {name:'Standard Campsite Spot',qty:1,value:50,cost:10},{name:'Parking Pass',qty:1,value:10,cost:2},{name:'Shower Access',qty:1,value:20,cost:5},{name:'Event Tickets',qty:2,value:25,cost:10}
  ]},
  {name:'RV Hookup',color:'#f59e0b',price:200,items:[
    {name:'RV Spot w/ Hookup',qty:1,value:150,cost:30},{name:'Power Hookup',qty:1,value:30,cost:10},{name:'Water Hookup',qty:1,value:20,cost:5},{name:'Parking Pass',qty:1,value:10,cost:2},{name:'Event Tickets',qty:4,value:25,cost:10},{name:'Shower Access',qty:1,value:20,cost:5}
  ]}
];}

// Load / Save sheets
async function loadSheets(){var r=await sb.from('sponsor_sheets').select('*').eq('tenant_id',tenantId).order('created_at',{ascending:false});if(r.error){console.error('Load sheets error:',r.error);allSheets=[];return;}allSheets=r.data||[];}
function buildOptions(){var h='<option value="">-- Select Sponsor Sheet --</option>';if(currentSheetId==='preloaded'&&!allSheets.find(function(s){return s.sheet_id==='preloaded';})){h+='<option value="preloaded" selected>Redding Rock 2026 (preloaded)</option>';}allSheets.forEach(function(s){var st=s.status||'draft';var badge=st==='published'?' ★ OFFICIAL':st==='submitted'?' [submitted]':'';h+='<option value="'+s.sheet_id+'"'+(s.sheet_id===currentSheetId?' selected':'')+'>'+esc(s.sheet_name||'Untitled')+badge+'</option>';});return h;}
function renderSelects(){var h=buildOptions();document.getElementById('deskSheetSel').innerHTML=h;document.getElementById('mobSheetSel').innerHTML=h;}
function syncSel(id){if(!id){currentSheetId=null;clearForm();return;}document.getElementById('deskSheetSel').value=id;document.getElementById('mobSheetSel').value=id;if(id==='preloaded'){loadPreloaded();return;}currentSheetId=id;localStorage.setItem('elp-last-sponsor',id);loadSheetData(id);}

async function loadSheetData(id){var s=allSheets.find(function(e){return e.sheet_id===id;});if(!s)return;document.getElementById('sheetName').value=s.sheet_name||'';document.getElementById('sheetEvent').value=s.event_name||'';
// Load sponsor levels
var lr=await sb.from('sponsor_levels').select('*').eq('sheet_id',id).order('sort_order');var lvls=lr.data||[];levels=[];for(var i=0;i<lvls.length;i++){var l=lvls[i];var pr=await sb.from('sponsor_perks').select('*').eq('level_id',l.level_id).order('sort_order');levels.push({name:l.level_name,color:l.color,price:parseFloat(l.price)||0,perks:(pr.data||[]).map(function(p){return{name:p.perk_name,qty:parseInt(p.quantity)||0,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0};})});}if(!levels.length)levels=makeDefaults();
// Load ticket packages
var tr=await sb.from('ticket_packages').select('*').eq('sheet_id',id).order('sort_order');var tpkgs=tr.data||[];tickPkgs=[];for(var j=0;j<tpkgs.length;j++){var tp=tpkgs[j];var tir=await sb.from('ticket_package_items').select('*').eq('package_id',tp.package_id).order('sort_order');tickPkgs.push({name:tp.package_name,color:tp.color,price:parseFloat(tp.price)||0,items:(tir.data||[]).map(function(ti){return{name:ti.item_name,qty:parseInt(ti.quantity)||0,value:parseFloat(ti.value)||0,cost:parseFloat(ti.cost)||0};})});}if(!tickPkgs.length)tickPkgs=makeDefaultTicks();
// Load vendor packages
var vr=await sb.from('vendor_packages').select('*').eq('sheet_id',id).order('sort_order');var vpkgs=vr.data||[];vendorPkgs=[];for(var k=0;k<vpkgs.length;k++){var vp=vpkgs[k];var vir=await sb.from('vendor_package_items').select('*').eq('package_id',vp.package_id).order('sort_order');vendorPkgs.push({name:vp.package_name,color:vp.color,price:parseFloat(vp.price)||0,items:(vir.data||[]).map(function(vi){return{name:vi.item_name,qty:parseInt(vi.quantity)||0,value:parseFloat(vi.value)||0,cost:parseFloat(vi.cost)||0};})});}if(!vendorPkgs.length)vendorPkgs=makeDefaultVendors();
// Load camping packages
var cr=await sb.from('camping_packages').select('*').eq('sheet_id',id).order('sort_order');var cpkgs=cr.data||[];campingPkgs=[];for(var m=0;m<cpkgs.length;m++){var cp=cpkgs[m];var cir=await sb.from('camping_package_items').select('*').eq('package_id',cp.package_id).order('sort_order');campingPkgs.push({name:cp.package_name,color:cp.color,price:parseFloat(cp.price)||0,items:(cir.data||[]).map(function(ci){return{name:ci.item_name,qty:parseInt(ci.quantity)||0,value:parseFloat(ci.value)||0,cost:parseFloat(ci.cost)||0};})});}if(!campingPkgs.length)campingPkgs=makeDefaultCamping();
// Load rev data
try{var rd=s.rev_data?JSON.parse(s.rev_data):{};revData={sponsor:rd.sponsor||[],ticket:rd.ticket||[],vendor:rd.vendor||[],camping:rd.camping||[],sponsorActual:rd.sponsorActual||[],ticketActual:rd.ticketActual||[],vendorActual:rd.vendorActual||[],campingActual:rd.campingActual||[]};if(rd.sectionOrder&&rd.sectionOrder.length)revSectionOrder=rd.sectionOrder;}catch(e){revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};}
updateButtons(s);render();}

function loadPreloaded(){currentSheetId='preloaded';localStorage.setItem('elp-last-sponsor','preloaded');document.getElementById('sheetName').value='Redding Rock 2026';document.getElementById('sheetEvent').value='Redding Rock';levels=makeDefaults();tickPkgs=makeDefaultTicks();vendorPkgs=makeDefaultVendors();campingPkgs=makeDefaultCamping();revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};updateButtons(null);render();}

function clearForm(){currentSheetId=null;document.getElementById('sheetName').value='';document.getElementById('sheetEvent').value='';levels=[];tickPkgs=[];vendorPkgs=[];campingPkgs=[];revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};updateButtons(null);render();}

function updateButtons(s){updateActionButtons();}

async function createSheet(){if(!tenantId){toast('Not authenticated');return;}var name=prompt('Sheet name (e.g., Summer Bash 2026):');if(!name||!name.trim())return;var ins=await sb.from('sponsor_sheets').insert({tenant_id:tenantId,sheet_name:name.trim(),created_by:userId}).select().single();if(ins.error){toast('Error: '+ins.error.message);console.error('Create sheet error:',ins.error);return;}var sheetId=ins.data.sheet_id;
// Create default sponsor levels
var defs=makeDefaults();for(var i=0;i<defs.length;i++){var lv=defs[i];var li=await sb.from('sponsor_levels').insert({sheet_id:sheetId,tenant_id:tenantId,level_name:lv.name,color:lv.color,price:lv.price,sort_order:i}).select().single();if(li.error){console.error('Level create error:',li.error);continue;}if(li.data){var pRows=lv.perks.map(function(p,pi){return{level_id:li.data.level_id,sheet_id:sheetId,tenant_id:tenantId,perk_name:p.name,quantity:p.qty,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0,sort_order:pi};});if(pRows.length){var pr=await sb.from('sponsor_perks').insert(pRows);if(pr.error)console.error('Perk create error:',pr.error);}}}
// Create default ticket packages
var defTicks=makeDefaultTicks();for(var j=0;j<defTicks.length;j++){var tp=defTicks[j];var tpi=await sb.from('ticket_packages').insert({sheet_id:sheetId,tenant_id:tenantId,package_name:tp.name,color:tp.color,price:tp.price,sort_order:j}).select().single();if(tpi.data){var tRows=tp.items.map(function(it,ii){return{package_id:tpi.data.package_id,sheet_id:sheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});if(tRows.length)await sb.from('ticket_package_items').insert(tRows);}}
// Create default vendor packages
var defVendors=makeDefaultVendors();for(var v=0;v<defVendors.length;v++){var vp=defVendors[v];var vpi=await sb.from('vendor_packages').insert({sheet_id:sheetId,tenant_id:tenantId,package_name:vp.name,color:vp.color,price:vp.price,sort_order:v}).select().single();if(vpi.data){var vRows=vp.items.map(function(it,ii){return{package_id:vpi.data.package_id,sheet_id:sheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});if(vRows.length)await sb.from('vendor_package_items').insert(vRows);}}
// Create default camping packages
var defCamping=makeDefaultCamping();for(var c=0;c<defCamping.length;c++){var cp=defCamping[c];var cpi=await sb.from('camping_packages').insert({sheet_id:sheetId,tenant_id:tenantId,package_name:cp.name,color:cp.color,price:cp.price,sort_order:c}).select().single();if(cpi.data){var cRows=cp.items.map(function(it,ii){return{package_id:cpi.data.package_id,sheet_id:sheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});if(cRows.length)await sb.from('camping_package_items').insert(cRows);}}
currentSheetId=sheetId;localStorage.setItem('elp-last-sponsor',sheetId);await loadSheets();renderSelects();syncSel(sheetId);toast('"'+name.trim()+'" created');}

async function ensureTables(){try{var t=await sb.from('sponsor_sheets').select('sheet_id').limit(1);if(t.error&&t.error.code==='42P01'){await sb.rpc('exec_sql',{sql:"CREATE TABLE IF NOT EXISTS sponsor_sheets (sheet_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, tenant_id uuid, sheet_name text, event_name text, rev_data text, created_by uuid, created_at timestamptz DEFAULT now()); CREATE TABLE IF NOT EXISTS sponsor_levels (level_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, level_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS sponsor_perks (perk_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, level_id uuid REFERENCES sponsor_levels(level_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, perk_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS ticket_packages (package_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, package_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS ticket_package_items (item_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, package_id uuid REFERENCES ticket_packages(package_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, item_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS vendor_packages (package_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, package_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS vendor_package_items (item_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, package_id uuid REFERENCES vendor_packages(package_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, item_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); ALTER TABLE sponsor_sheets ENABLE ROW LEVEL SECURITY; ALTER TABLE sponsor_levels ENABLE ROW LEVEL SECURITY; ALTER TABLE sponsor_perks ENABLE ROW LEVEL SECURITY; ALTER TABLE ticket_packages ENABLE ROW LEVEL SECURITY; ALTER TABLE ticket_package_items ENABLE ROW LEVEL SECURITY; ALTER TABLE vendor_packages ENABLE ROW LEVEL SECURITY; ALTER TABLE vendor_package_items ENABLE ROW LEVEL SECURITY; CREATE POLICY IF NOT EXISTS sp_sheets ON sponsor_sheets FOR ALL USING (true); CREATE POLICY IF NOT EXISTS sp_levels ON sponsor_levels FOR ALL USING (true); CREATE POLICY IF NOT EXISTS sp_perks ON sponsor_perks FOR ALL USING (true); CREATE POLICY IF NOT EXISTS tp_pkgs ON ticket_packages FOR ALL USING (true); CREATE POLICY IF NOT EXISTS tp_items ON ticket_package_items FOR ALL USING (true); CREATE POLICY IF NOT EXISTS vp_pkgs ON vendor_packages FOR ALL USING (true); CREATE POLICY IF NOT EXISTS vp_items ON vendor_package_items FOR ALL USING (true); CREATE TABLE IF NOT EXISTS camping_packages (package_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, sheet_id uuid REFERENCES sponsor_sheets(sheet_id) ON DELETE CASCADE, tenant_id uuid, package_name text, color text, price numeric DEFAULT 0, sort_order int DEFAULT 0); CREATE TABLE IF NOT EXISTS camping_package_items (item_id uuid DEFAULT gen_random_uuid() PRIMARY KEY, package_id uuid REFERENCES camping_packages(package_id) ON DELETE CASCADE, sheet_id uuid, tenant_id uuid, item_name text, quantity int DEFAULT 0, value numeric DEFAULT 0, cost numeric DEFAULT 0, sort_order int DEFAULT 0); ALTER TABLE camping_packages ENABLE ROW LEVEL SECURITY; ALTER TABLE camping_package_items ENABLE ROW LEVEL SECURITY; CREATE POLICY IF NOT EXISTS cp_pkgs ON camping_packages FOR ALL USING (true); CREATE POLICY IF NOT EXISTS cp_items ON camping_package_items FOR ALL USING (true);"});toast('Tables created');}}catch(e){}}

// Also try adding value column to ticket_package_items if it doesn't exist
async function ensureValueColumns(){try{await sb.rpc('exec_sql',{sql:"ALTER TABLE ticket_package_items ADD COLUMN IF NOT EXISTS value numeric DEFAULT 0; ALTER TABLE vendor_package_items ADD COLUMN IF NOT EXISTS value numeric DEFAULT 0;"});}catch(e){}}

async function saveToDb(silent){if(!tenantId){if(!silent)toast('Not authenticated');return;}if(!currentSheetId){if(!silent)toast('Select or create a sheet first');return;}var sheetName=document.getElementById('sheetName').value||'Untitled';var eventName=document.getElementById('sheetEvent').value||'';
if(currentSheetId==='preloaded'){var ins=await sb.from('sponsor_sheets').insert({tenant_id:tenantId,sheet_name:sheetName,event_name:eventName,created_by:userId}).select().single();if(ins.error){toast('Save error: '+ins.error.message);return;}currentSheetId=ins.data.sheet_id;localStorage.setItem('elp-last-sponsor',currentSheetId);}else{var upd=await sb.from('sponsor_sheets').update({sheet_name:sheetName,event_name:eventName}).eq('sheet_id',currentSheetId);if(upd.error){toast('Update error: '+upd.error.message);return;}}
// Save sponsor levels
await sb.from('sponsor_perks').delete().eq('sheet_id',currentSheetId);
await sb.from('sponsor_levels').delete().eq('sheet_id',currentSheetId);
for(var i=0;i<levels.length;i++){var lv=levels[i];var li=await sb.from('sponsor_levels').insert({sheet_id:currentSheetId,tenant_id:tenantId,level_name:lv.name,color:lv.color,price:lv.price,sort_order:i}).select().single();if(li.error){console.error('Level insert error:',li.error);continue;}if(li.data&&lv.perks.length){var pRows=lv.perks.map(function(p,pi){return{level_id:li.data.level_id,sheet_id:currentSheetId,tenant_id:tenantId,perk_name:p.name,quantity:p.qty,value:parseFloat(p.value)||0,cost:parseFloat(p.cost)||0,sort_order:pi};});var pr=await sb.from('sponsor_perks').insert(pRows);if(pr.error)console.error('Perk insert error:',pr.error);}}
// Save ticket packages
await sb.from('ticket_package_items').delete().eq('sheet_id',currentSheetId);
await sb.from('ticket_packages').delete().eq('sheet_id',currentSheetId);
for(var j=0;j<tickPkgs.length;j++){var tp=tickPkgs[j];var tpi=await sb.from('ticket_packages').insert({sheet_id:currentSheetId,tenant_id:tenantId,package_name:tp.name,color:tp.color,price:tp.price,sort_order:j}).select().single();if(tpi.error){console.error('Ticket pkg error:',tpi.error);continue;}if(tpi.data&&tp.items.length){var tRows=tp.items.map(function(it,ii){return{package_id:tpi.data.package_id,sheet_id:currentSheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});await sb.from('ticket_package_items').insert(tRows);}}
// Save vendor packages
await sb.from('vendor_package_items').delete().eq('sheet_id',currentSheetId);
await sb.from('vendor_packages').delete().eq('sheet_id',currentSheetId);
for(var v=0;v<vendorPkgs.length;v++){var vp=vendorPkgs[v];var vpi=await sb.from('vendor_packages').insert({sheet_id:currentSheetId,tenant_id:tenantId,package_name:vp.name,color:vp.color,price:vp.price,sort_order:v}).select().single();if(vpi.error){console.error('Vendor pkg error:',vpi.error);continue;}if(vpi.data&&vp.items.length){var vRows=vp.items.map(function(it,ii){return{package_id:vpi.data.package_id,sheet_id:currentSheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});await sb.from('vendor_package_items').insert(vRows);}}
// Save camping packages
await sb.from('camping_package_items').delete().eq('sheet_id',currentSheetId);
await sb.from('camping_packages').delete().eq('sheet_id',currentSheetId);
for(var c=0;c<campingPkgs.length;c++){var cp=campingPkgs[c];var cpi=await sb.from('camping_packages').insert({sheet_id:currentSheetId,tenant_id:tenantId,package_name:cp.name,color:cp.color,price:cp.price,sort_order:c}).select().single();if(cpi.error){console.error('Camping pkg error:',cpi.error);continue;}if(cpi.data&&cp.items.length){var cRows=cp.items.map(function(it,ii){return{package_id:cpi.data.package_id,sheet_id:currentSheetId,tenant_id:tenantId,item_name:it.name,quantity:it.qty,value:parseFloat(it.value)||0,cost:parseFloat(it.cost)||0,sort_order:ii};});await sb.from('camping_package_items').insert(cRows);}}
// Save rev data
await sb.from('sponsor_sheets').update({rev_data:JSON.stringify(Object.assign({},revData,{sectionOrder:revSectionOrder}))}).eq('sheet_id',currentSheetId);
dirty=false;await loadSheets();renderSelects();document.getElementById('deskSheetSel').value=currentSheetId;document.getElementById('mobSheetSel').value=currentSheetId;if(silent){showSaveStatus('saved');}else{toast('Saved!');}}

async function deleteSheet(){if(!currentSheetId||currentSheetId==='preloaded')return;var s=allSheets.find(function(e){return e.sheet_id===currentSheetId;});if(!s||s.created_by!==userId){toast('Cannot delete');return;}if(!confirm('Delete "'+s.sheet_name+'"?'))return;
await sb.from('camping_package_items').delete().eq('sheet_id',currentSheetId);
await sb.from('camping_packages').delete().eq('sheet_id',currentSheetId);
await sb.from('vendor_package_items').delete().eq('sheet_id',currentSheetId);
await sb.from('vendor_packages').delete().eq('sheet_id',currentSheetId);
await sb.from('ticket_package_items').delete().eq('sheet_id',currentSheetId);
await sb.from('ticket_packages').delete().eq('sheet_id',currentSheetId);
await sb.from('sponsor_perks').delete().eq('sheet_id',currentSheetId);
await sb.from('sponsor_levels').delete().eq('sheet_id',currentSheetId);
await sb.from('sponsor_sheets').delete().eq('sheet_id',currentSheetId);
currentSheetId=null;localStorage.removeItem('elp-last-sponsor');await loadSheets();renderSelects();clearForm();toast('Deleted');}

// ============================================================
// RENDER SPONSOR LEVELS
// ============================================================
function render(){var area=document.getElementById('levelsArea');var h='';levels.forEach(function(lv,i){var totalPerks=lv.perks.filter(function(p){return p.qty>0;}).length;var lvCost=0,lvValue=0;lv.perks.forEach(function(p){var q=parseInt(p.qty)||0;lvCost+=q*(parseFloat(p.cost)||0);lvValue+=q*(parseFloat(p.value)||0);});
h+='<div class="level-card" id="lvl-'+i+'">';
h+='<div class="level-hdr" onclick="toggleLevel('+i+')">';
h+='<div class="level-drag" onmousedown="handleGrab(event,'+i+')" ontouchstart="handleGrab(event,'+i+')" title="Drag to reorder"><i></i><i></i><i></i><i></i><i></i><i></i></div>';
h+='<div class="level-dot" style="background:'+lv.color+';"></div>';
h+='<div class="level-info"><div class="level-name" style="color:'+lv.color+';">'+esc(lv.name)+'</div>';
h+='<div class="level-sub">'+totalPerks+' perks · Value $'+fmt(lvValue)+' · Cost $'+fmt(lvCost)+'</div></div>';
h+='<div class="level-price" style="color:'+lv.color+';">$'+fmt(lv.price)+'</div>';
h+='<button class="level-del" onclick="event.stopPropagation();removeLevel('+i+')" title="Delete level">&times;</button>';
h+='<span class="level-chv">&#9660;</span></div>';
h+='<div class="level-body"><div class="level-inner">';
h+='<div class="level-meta">';
h+='<div><div class="lm-label">Level Name</div><input class="lm-input" value="'+esc(lv.name)+'" onchange="updLevel('+i+',\'name\',this.value)"></div>';
h+='<div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(lv.price||'')+'" step="0.01" oninput="updLevel('+i+',\'price\',this.value)"></div>';
h+='<div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+lv.color+'" oninput="updLevel('+i+',\'color\',this.value)"></div></div>';
h+='<div class="perks-title"><span>PERKS & INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Perk | Value | Cost</span></div>';
lv.perks.forEach(function(p,pi){
h+='<div class="perk-row">';
h+='<input type="number" class="perk-qty" value="'+(p.qty||0)+'" min="0" oninput="updPerk('+i+','+pi+',\'qty\',this.value)">';
h+='<input type="text" class="perk-name" value="'+esc(p.name)+'" onchange="updPerk('+i+','+pi+',\'name\',this.value)" placeholder="Perk name">';
h+='<input type="number" class="perk-value" value="'+(p.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updPerk('+i+','+pi+',\'value\',this.value)">';
h+='<input type="number" class="perk-cost" value="'+(p.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updPerk('+i+','+pi+',\'cost\',this.value)">';
h+='<button class="perk-del" onclick="removePerk('+i+','+pi+')" title="Remove">&times;</button></div>';});
h+='<button class="add-perk-btn" onclick="addPerk('+i+')">+ Add Perk</button>';
h+='</div></div></div>';});
area.innerHTML=h;calcSummary();renderTickPkgs();renderVendorPkgs();renderCampingPkgs();}

function toggleLevel(i){var card=document.getElementById('lvl-'+i);if(card){var w=card.classList.contains('expanded');card.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function toggleSection(id,titleEl){var wrap=document.getElementById(id);if(!wrap)return;var isOpen=wrap.classList.contains('open');if(isOpen&&dirty)autoSave();wrap.classList.toggle('open');var chv=titleEl.querySelector('.section-chv');if(chv)chv.textContent=isOpen?'▸':'▾';}
function updLevel(i,key,val){if(key==='price')levels[i].price=parseFloat(val)||0;else if(key==='color')levels[i].color=val;else levels[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#lvl-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(levels[i].price);calcSummary();}else{render();var card=document.getElementById('lvl-'+i);if(card)card.classList.add('expanded');}}
function updPerk(li,pi,key,val){if(key==='qty')levels[li].perks[pi].qty=parseInt(val)||0;else if(key==='cost')levels[li].perks[pi].cost=parseFloat(val)||0;else if(key==='value')levels[li].perks[pi].value=parseFloat(val)||0;else levels[li].perks[pi][key]=val;dirty=true;scheduleAutoSave();calcSummary();}
function addPerk(li){levels[li].perks.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();render();var card=document.getElementById('lvl-'+li);if(card)card.classList.add('expanded');}
function removePerk(li,pi){levels[li].perks.splice(pi,1);dirty=true;scheduleAutoSave();render();var card=document.getElementById('lvl-'+li);if(card)card.classList.add('expanded');}
function addLevel(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[levels.length%colors.length];var name=prompt('Level name (e.g., Media, Standard):');if(!name||!name.trim())return;levels.push({name:name.trim(),color:c,price:0,perks:DEFAULT_PERKS.map(function(p){return{name:p.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();render();}
function removeLevel(i){if(!confirm('Delete "'+levels[i].name+'" level?'))return;levels.splice(i,1);dirty=true;scheduleAutoSave();render();}

// Sponsor drag
var dragIdx=null,dragGhost=null;
function handleGrab(e,i){e.preventDefault();e.stopPropagation();dragIdx=i;var card=document.getElementById('lvl-'+i);card.classList.add('dragging');dragGhost=card.cloneNode(true);dragGhost.classList.remove('dragging');dragGhost.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent-primary);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(dragGhost);document.addEventListener('mousemove',handleMove);document.addEventListener('mouseup',handleRelease);document.addEventListener('touchmove',handleMove,{passive:false});document.addEventListener('touchend',handleRelease);}
function handleMove(e){if(dragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(dragGhost)dragGhost.style.top=(t.clientY-30)+'px';document.querySelectorAll('.level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id!=='lvl-'+dragIdx&&card.id.startsWith('lvl-'))card.classList.add('drag-over');}}
function handleRelease(e){document.removeEventListener('mousemove',handleMove);document.removeEventListener('mouseup',handleRelease);document.removeEventListener('touchmove',handleMove);document.removeEventListener('touchend',handleRelease);if(dragGhost){document.body.removeChild(dragGhost);dragGhost=null;}if(dragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var ti=-1;if(tc){var m=tc.id.match(/lvl-(\d+)/);if(m)ti=parseInt(m[1]);}document.querySelectorAll('.level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(ti>=0&&ti!==dragIdx){var item=levels.splice(dragIdx,1)[0];levels.splice(ti,0,item);dirty=true;scheduleAutoSave();render();}dragIdx=null;}

function calcSummary(){levels.forEach(function(lv,i){var lvPerks=0,lvCost=0,lvValue=0;lv.perks.forEach(function(p){var q=parseInt(p.qty)||0;if(q>0)lvPerks++;lvCost+=q*(parseFloat(p.cost)||0);lvValue+=q*(parseFloat(p.value)||0);});var sub=document.querySelector('#lvl-'+i+' .level-sub');if(sub)sub.textContent=lvPerks+' perks · Value $'+fmt(lvValue)+' · Cost $'+fmt(lvCost);});calcTickSummary();calcVendorSummary();calcCampingSummary();updateMasterKPI();}

function updateMasterKPI(){
var goalRev=0,actualRev=0,totalCost=0,totalSold=0;
var deptGoal={sponsor:0,ticket:0,vendor:0,camping:0};
var deptActual={sponsor:0,ticket:0,vendor:0,camping:0};
// Sponsors
levels.forEach(function(lv,i){var g=revData.sponsor[i]||0;var a=revData.sponsorActual[i]||0;var lvCost=0;lv.perks.forEach(function(p){lvCost+=(parseInt(p.qty)||0)*(parseFloat(p.cost)||0);});deptGoal.sponsor+=g*lv.price;deptActual.sponsor+=a*lv.price;goalRev+=g*lv.price;actualRev+=a*lv.price;totalCost+=g*lvCost;totalSold+=a;});
// Tickets
tickPkgs.forEach(function(pk,i){var g=revData.ticket[i]||0;var a=revData.ticketActual[i]||0;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});deptGoal.ticket+=g*pk.price;deptActual.ticket+=a*pk.price;goalRev+=g*pk.price;actualRev+=a*pk.price;totalCost+=g*pkCost;totalSold+=a;});
// Vendors
vendorPkgs.forEach(function(pk,i){var g=revData.vendor[i]||0;var a=revData.vendorActual[i]||0;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});deptGoal.vendor+=g*pk.price;deptActual.vendor+=a*pk.price;goalRev+=g*pk.price;actualRev+=a*pk.price;totalCost+=g*pkCost;totalSold+=a;});
// Camping
campingPkgs.forEach(function(pk,i){var g=revData.camping[i]||0;var a=revData.campingActual[i]||0;var pkCost=0;pk.items.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});deptGoal.camping+=g*pk.price;deptActual.camping+=a*pk.price;goalRev+=g*pk.price;actualRev+=a*pk.price;totalCost+=g*pkCost;totalSold+=a;});
var profit=actualRev-totalCost;
document.getElementById('kpiGoalRev').textContent='$'+fmt(goalRev);
document.getElementById('kpiActualRev').textContent='$'+fmt(actualRev);
document.getElementById('kpiTotalCost').textContent='$'+fmt(totalCost);
var pEl=document.getElementById('kpiProfit');pEl.textContent=(profit>=0?'+$':'-$')+fmt(Math.abs(profit));pEl.style.color=profit>=0?'#22c55e':'#ef4444';
document.getElementById('kpiSold').textContent=fmt(totalSold);
document.getElementById('kpiSponsor').textContent='$'+fmt(deptActual.sponsor);document.getElementById('kpiSponsor').style.color=deptActual.sponsor>0?'#22c55e':'var(--text-secondary)';
document.getElementById('kpiTicket').textContent='$'+fmt(deptActual.ticket);document.getElementById('kpiTicket').style.color=deptActual.ticket>0?'#22c55e':'var(--text-secondary)';
document.getElementById('kpiVendor').textContent='$'+fmt(deptActual.vendor);document.getElementById('kpiVendor').style.color=deptActual.vendor>0?'#22c55e':'var(--text-secondary)';
document.getElementById('kpiCamping').textContent='$'+fmt(deptActual.camping);document.getElementById('kpiCamping').style.color=deptActual.camping>0?'#22c55e':'var(--text-secondary)';
}

// ============================================================
// TICKET PACKAGES (now with value + cost)
// ============================================================
function renderTickPkgs(){var area=document.getElementById('tickArea');var h='';tickPkgs.forEach(function(pk,i){var itemCnt=pk.items.filter(function(it){return it.qty>0;}).length;var pkCost=0,pkValue=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});
h+='<div class="level-card" id="tpk-'+i+'">';
h+='<div class="level-hdr" onclick="toggleTick('+i+')">';
h+='<div class="level-drag" onmousedown="tickGrab(event,'+i+')" ontouchstart="tickGrab(event,'+i+')"><i></i><i></i><i></i><i></i><i></i><i></i></div>';
h+='<div class="level-dot" style="background:'+pk.color+';"></div>';
h+='<div class="level-info"><div class="level-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div>';
h+='<div class="level-sub">'+itemCnt+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost)+'</div></div>';
h+='<div class="level-price" style="color:'+pk.color+';">$'+fmt(pk.price)+'</div>';
h+='<button class="level-del" onclick="event.stopPropagation();removeTickPkg('+i+')" title="Delete">&times;</button>';
h+='<span class="level-chv">&#9660;</span></div>';
h+='<div class="level-body"><div class="level-inner">';
h+='<div class="level-meta">';
h+='<div><div class="lm-label">Package Name</div><input class="lm-input" value="'+esc(pk.name)+'" onchange="updTick('+i+',\'name\',this.value)"></div>';
h+='<div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(pk.price||'')+'" step="0.01" oninput="updTick('+i+',\'price\',this.value)"></div>';
h+='<div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+pk.color+'" oninput="updTick('+i+',\'color\',this.value)"></div></div>';
h+='<div class="perks-title"><span>INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Item | Value | Cost</span></div>';
pk.items.forEach(function(it,ii){
h+='<div class="perk-row">';
h+='<input type="number" class="perk-qty" value="'+(it.qty||0)+'" min="0" oninput="updTickItem('+i+','+ii+',\'qty\',this.value)">';
h+='<input type="text" class="perk-name" value="'+esc(it.name)+'" onchange="updTickItem('+i+','+ii+',\'name\',this.value)" placeholder="Item name">';
h+='<input type="number" class="perk-value" value="'+(it.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updTickItem('+i+','+ii+',\'value\',this.value)">';
h+='<input type="number" class="perk-cost" value="'+(it.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updTickItem('+i+','+ii+',\'cost\',this.value)">';
h+='<button class="perk-del" onclick="removeTickItem('+i+','+ii+')">&times;</button></div>';});
h+='<button class="add-perk-btn" onclick="addTickItem('+i+')">+ Add Item</button>';
h+='</div></div></div>';});
area.innerHTML=h;calcTickSummary();renderRevSliders();}

function toggleTick(i){var c=document.getElementById('tpk-'+i);if(c){var w=c.classList.contains('expanded');c.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function updTick(i,key,val){if(key==='price')tickPkgs[i].price=parseFloat(val)||0;else if(key==='color')tickPkgs[i].color=val;else tickPkgs[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#tpk-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(tickPkgs[i].price);calcTickSummary();renderRevSliders();}else{renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}}
function updTickItem(i,ii,key,val){if(key==='qty')tickPkgs[i].items[ii].qty=parseInt(val)||0;else if(key==='cost')tickPkgs[i].items[ii].cost=parseFloat(val)||0;else if(key==='value')tickPkgs[i].items[ii].value=parseFloat(val)||0;else tickPkgs[i].items[ii][key]=val;dirty=true;scheduleAutoSave();calcTickSummary();renderRevSliders();}
function addTickItem(i){tickPkgs[i].items.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}
function removeTickItem(i,ii){tickPkgs[i].items.splice(ii,1);dirty=true;scheduleAutoSave();renderTickPkgs();var c=document.getElementById('tpk-'+i);if(c)c.classList.add('expanded');}
function addTickPkg(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[tickPkgs.length%colors.length];var name=prompt('Package name (e.g., Family 4-Pack):');if(!name||!name.trim())return;tickPkgs.push({name:name.trim(),color:c,price:0,items:DEFAULT_TICK_ITEMS.map(function(it){return{name:it.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();renderTickPkgs();}
function removeTickPkg(i){if(!confirm('Delete "'+tickPkgs[i].name+'" package?'))return;tickPkgs.splice(i,1);dirty=true;scheduleAutoSave();renderTickPkgs();}
function calcTickSummary(){var tCost=0,tValue=0,tItems=0;tickPkgs.forEach(function(pk,i){var pkCost=0,pkValue=0,pkItems=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;if(q>0)pkItems++;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});tCost+=pkCost;tValue+=pkValue;tItems+=pkItems;var sub=document.querySelector('#tpk-'+i+' .level-sub');if(sub)sub.textContent=pkItems+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost);});var tpTotal=tickPkgs.reduce(function(s,p){return s+p.price;},0);var tpOff=tpTotal-tCost;document.getElementById('tbPkgs').textContent=tickPkgs.length;document.getElementById('tbItems').textContent=tItems;document.getElementById('tbValue').textContent='$'+fmt(tValue);document.getElementById('tbCost').textContent='$'+fmt(tCost);var oEl=document.getElementById('tbOffset');oEl.textContent=(tpOff>=0?'+$':'-$')+fmt(Math.abs(tpOff));oEl.style.color=tpOff>=0?'#22c55e':'#ef4444';updateMasterKPI();}
// Ticket drag
var tickDragIdx=null,tickGhost=null;
function tickGrab(e,i){e.preventDefault();e.stopPropagation();tickDragIdx=i;var card=document.getElementById('tpk-'+i);card.classList.add('dragging');tickGhost=card.cloneNode(true);tickGhost.classList.remove('dragging');tickGhost.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent-primary);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(tickGhost);document.addEventListener('mousemove',tickMove);document.addEventListener('mouseup',tickRelease);document.addEventListener('touchmove',tickMove,{passive:false});document.addEventListener('touchend',tickRelease);}
function tickMove(e){if(tickDragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(tickGhost)tickGhost.style.top=(t.clientY-30)+'px';document.querySelectorAll('#tickArea .level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id.startsWith('tpk-')&&card.id!=='tpk-'+tickDragIdx)card.classList.add('drag-over');}}
function tickRelease(e){document.removeEventListener('mousemove',tickMove);document.removeEventListener('mouseup',tickRelease);document.removeEventListener('touchmove',tickMove);document.removeEventListener('touchend',tickRelease);if(tickGhost){document.body.removeChild(tickGhost);tickGhost=null;}if(tickDragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var idx=-1;if(tc){var m=tc.id.match(/tpk-(\d+)/);if(m)idx=parseInt(m[1]);}document.querySelectorAll('#tickArea .level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(idx>=0&&idx!==tickDragIdx){var item=tickPkgs.splice(tickDragIdx,1)[0];tickPkgs.splice(idx,0,item);dirty=true;scheduleAutoSave();renderTickPkgs();}tickDragIdx=null;}

// ============================================================
// VENDOR PACKAGES (same structure as tickets with value + cost)
// ============================================================
function renderVendorPkgs(){var area=document.getElementById('vendorArea');var h='';vendorPkgs.forEach(function(pk,i){var itemCnt=pk.items.filter(function(it){return it.qty>0;}).length;var pkCost=0,pkValue=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});
h+='<div class="level-card" id="vpk-'+i+'">';
h+='<div class="level-hdr" onclick="toggleVendor('+i+')">';
h+='<div class="level-drag" onmousedown="vendorGrab(event,'+i+')" ontouchstart="vendorGrab(event,'+i+')"><i></i><i></i><i></i><i></i><i></i><i></i></div>';
h+='<div class="level-dot" style="background:'+pk.color+';"></div>';
h+='<div class="level-info"><div class="level-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div>';
h+='<div class="level-sub">'+itemCnt+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost)+'</div></div>';
h+='<div class="level-price" style="color:'+pk.color+';">$'+fmt(pk.price)+'</div>';
h+='<button class="level-del" onclick="event.stopPropagation();removeVendorPkg('+i+')" title="Delete">&times;</button>';
h+='<span class="level-chv">&#9660;</span></div>';
h+='<div class="level-body"><div class="level-inner">';
h+='<div class="level-meta">';
h+='<div><div class="lm-label">Package Name</div><input class="lm-input" value="'+esc(pk.name)+'" onchange="updVendor('+i+',\'name\',this.value)"></div>';
h+='<div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(pk.price||'')+'" step="0.01" oninput="updVendor('+i+',\'price\',this.value)"></div>';
h+='<div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+pk.color+'" oninput="updVendor('+i+',\'color\',this.value)"></div></div>';
h+='<div class="perks-title"><span>INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Item | Value | Cost</span></div>';
pk.items.forEach(function(it,ii){
h+='<div class="perk-row">';
h+='<input type="number" class="perk-qty" value="'+(it.qty||0)+'" min="0" oninput="updVendorItem('+i+','+ii+',\'qty\',this.value)">';
h+='<input type="text" class="perk-name" value="'+esc(it.name)+'" onchange="updVendorItem('+i+','+ii+',\'name\',this.value)" placeholder="Item name">';
h+='<input type="number" class="perk-value" value="'+(it.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updVendorItem('+i+','+ii+',\'value\',this.value)">';
h+='<input type="number" class="perk-cost" value="'+(it.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updVendorItem('+i+','+ii+',\'cost\',this.value)">';
h+='<button class="perk-del" onclick="removeVendorItem('+i+','+ii+')">&times;</button></div>';});
h+='<button class="add-perk-btn" onclick="addVendorItem('+i+')">+ Add Item</button>';
h+='</div></div></div>';});
area.innerHTML=h;calcVendorSummary();renderRevSliders();}

function toggleVendor(i){var c=document.getElementById('vpk-'+i);if(c){var w=c.classList.contains('expanded');c.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function updVendor(i,key,val){if(key==='price')vendorPkgs[i].price=parseFloat(val)||0;else if(key==='color')vendorPkgs[i].color=val;else vendorPkgs[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#vpk-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(vendorPkgs[i].price);calcVendorSummary();renderRevSliders();}else{renderVendorPkgs();var c=document.getElementById('vpk-'+i);if(c)c.classList.add('expanded');}}
function updVendorItem(i,ii,key,val){if(key==='qty')vendorPkgs[i].items[ii].qty=parseInt(val)||0;else if(key==='cost')vendorPkgs[i].items[ii].cost=parseFloat(val)||0;else if(key==='value')vendorPkgs[i].items[ii].value=parseFloat(val)||0;else vendorPkgs[i].items[ii][key]=val;dirty=true;scheduleAutoSave();calcVendorSummary();renderRevSliders();}
function addVendorItem(i){vendorPkgs[i].items.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();renderVendorPkgs();var c=document.getElementById('vpk-'+i);if(c)c.classList.add('expanded');}
function removeVendorItem(i,ii){vendorPkgs[i].items.splice(ii,1);dirty=true;scheduleAutoSave();renderVendorPkgs();var c=document.getElementById('vpk-'+i);if(c)c.classList.add('expanded');}
function addVendorPkg(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[vendorPkgs.length%colors.length];var name=prompt('Package name (e.g., Food Truck, Merch Vendor):');if(!name||!name.trim())return;vendorPkgs.push({name:name.trim(),color:c,price:0,items:DEFAULT_VENDOR_ITEMS.map(function(it){return{name:it.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();renderVendorPkgs();}
function removeVendorPkg(i){if(!confirm('Delete "'+vendorPkgs[i].name+'" package?'))return;vendorPkgs.splice(i,1);dirty=true;scheduleAutoSave();renderVendorPkgs();}
function calcVendorSummary(){var tCost=0,tValue=0,tItems=0;vendorPkgs.forEach(function(pk,i){var pkCost=0,pkValue=0,pkItems=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;if(q>0)pkItems++;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});tCost+=pkCost;tValue+=pkValue;tItems+=pkItems;var sub=document.querySelector('#vpk-'+i+' .level-sub');if(sub)sub.textContent=pkItems+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost);});var vpTotal=vendorPkgs.reduce(function(s,p){return s+p.price;},0);var vpOff=vpTotal-tCost;document.getElementById('vbPkgs').textContent=vendorPkgs.length;document.getElementById('vbItems').textContent=tItems;document.getElementById('vbValue').textContent='$'+fmt(tValue);document.getElementById('vbCost').textContent='$'+fmt(tCost);var oEl=document.getElementById('vbOffset');oEl.textContent=(vpOff>=0?'+$':'-$')+fmt(Math.abs(vpOff));oEl.style.color=vpOff>=0?'#22c55e':'#ef4444';updateMasterKPI();}

// Vendor drag
var vendorDragIdx=null,vendorGhostEl=null;
function vendorGrab(e,i){e.preventDefault();e.stopPropagation();vendorDragIdx=i;var card=document.getElementById('vpk-'+i);card.classList.add('dragging');vendorGhostEl=card.cloneNode(true);vendorGhostEl.classList.remove('dragging');vendorGhostEl.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent-primary);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(vendorGhostEl);document.addEventListener('mousemove',vendorMove);document.addEventListener('mouseup',vendorRelease);document.addEventListener('touchmove',vendorMove,{passive:false});document.addEventListener('touchend',vendorRelease);}
function vendorMove(e){if(vendorDragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(vendorGhostEl)vendorGhostEl.style.top=(t.clientY-30)+'px';document.querySelectorAll('#vendorArea .level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id.startsWith('vpk-')&&card.id!=='vpk-'+vendorDragIdx)card.classList.add('drag-over');}}
function vendorRelease(e){document.removeEventListener('mousemove',vendorMove);document.removeEventListener('mouseup',vendorRelease);document.removeEventListener('touchmove',vendorMove);document.removeEventListener('touchend',vendorRelease);if(vendorGhostEl){document.body.removeChild(vendorGhostEl);vendorGhostEl=null;}if(vendorDragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var idx=-1;if(tc){var m=tc.id.match(/vpk-(\d+)/);if(m)idx=parseInt(m[1]);}document.querySelectorAll('#vendorArea .level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(idx>=0&&idx!==vendorDragIdx){var item=vendorPkgs.splice(vendorDragIdx,1)[0];vendorPkgs.splice(idx,0,item);dirty=true;scheduleAutoSave();renderVendorPkgs();}vendorDragIdx=null;}

// ============================================================
// CAMPING PACKAGES (same structure as vendors/tickets)
// ============================================================
function renderCampingPkgs(){var area=document.getElementById('campingArea');var h='';campingPkgs.forEach(function(pk,i){var itemCnt=pk.items.filter(function(it){return it.qty>0;}).length;var pkCost=0,pkValue=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});
h+='<div class="level-card" id="cpk-'+i+'">';
h+='<div class="level-hdr" onclick="toggleCamping('+i+')">';
h+='<div class="level-drag" onmousedown="campingGrab(event,'+i+')" ontouchstart="campingGrab(event,'+i+')"><i></i><i></i><i></i><i></i><i></i><i></i></div>';
h+='<div class="level-dot" style="background:'+pk.color+';"></div>';
h+='<div class="level-info"><div class="level-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div>';
h+='<div class="level-sub">'+itemCnt+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost)+'</div></div>';
h+='<div class="level-price" style="color:'+pk.color+';">$'+fmt(pk.price)+'</div>';
h+='<button class="level-del" onclick="event.stopPropagation();removeCampingPkg('+i+')" title="Delete">&times;</button>';
h+='<span class="level-chv">&#9660;</span></div>';
h+='<div class="level-body"><div class="level-inner">';
h+='<div class="level-meta">';
h+='<div><div class="lm-label">Package Name</div><input class="lm-input" value="'+esc(pk.name)+'" onchange="updCamping('+i+',\'name\',this.value)"></div>';
h+='<div><div class="lm-label">Price ($)</div><input type="number" class="lm-input" value="'+(pk.price||'')+'" step="0.01" oninput="updCamping('+i+',\'price\',this.value)"></div>';
h+='<div><div class="lm-label">Color</div><input type="color" class="lm-color" value="'+pk.color+'" oninput="updCamping('+i+',\'color\',this.value)"></div></div>';
h+='<div class="perks-title"><span>INCLUSIONS</span><span style="font-size:11px;font-weight:400;color:var(--text-secondary);">Qty | Item | Value | Cost</span></div>';
pk.items.forEach(function(it,ii){
h+='<div class="perk-row">';
h+='<input type="number" class="perk-qty" value="'+(it.qty||0)+'" min="0" oninput="updCampingItem('+i+','+ii+',\'qty\',this.value)">';
h+='<input type="text" class="perk-name" value="'+esc(it.name)+'" onchange="updCampingItem('+i+','+ii+',\'name\',this.value)" placeholder="Item name">';
h+='<input type="number" class="perk-value" value="'+(it.value||'')+'" min="0" step="0.01" placeholder="$0" oninput="updCampingItem('+i+','+ii+',\'value\',this.value)">';
h+='<input type="number" class="perk-cost" value="'+(it.cost||'')+'" min="0" step="0.01" placeholder="$0" oninput="updCampingItem('+i+','+ii+',\'cost\',this.value)">';
h+='<button class="perk-del" onclick="removeCampingItem('+i+','+ii+')">&times;</button></div>';});
h+='<button class="add-perk-btn" onclick="addCampingItem('+i+')">+ Add Item</button>';
h+='</div></div></div>';});
area.innerHTML=h;calcCampingSummary();renderRevSliders();}

function toggleCamping(i){var c=document.getElementById('cpk-'+i);if(c){var w=c.classList.contains('expanded');c.classList.toggle('expanded');if(w&&dirty)autoSave();}}
function updCamping(i,key,val){if(key==='price')campingPkgs[i].price=parseFloat(val)||0;else if(key==='color')campingPkgs[i].color=val;else campingPkgs[i][key]=val;dirty=true;scheduleAutoSave();if(key==='price'){var pr=document.querySelector('#cpk-'+i+' .level-price');if(pr)pr.textContent='$'+fmt(campingPkgs[i].price);calcCampingSummary();renderRevSliders();}else{renderCampingPkgs();var c=document.getElementById('cpk-'+i);if(c)c.classList.add('expanded');}}
function updCampingItem(i,ii,key,val){if(key==='qty')campingPkgs[i].items[ii].qty=parseInt(val)||0;else if(key==='cost')campingPkgs[i].items[ii].cost=parseFloat(val)||0;else if(key==='value')campingPkgs[i].items[ii].value=parseFloat(val)||0;else campingPkgs[i].items[ii][key]=val;dirty=true;scheduleAutoSave();calcCampingSummary();renderRevSliders();}
function addCampingItem(i){campingPkgs[i].items.push({name:'',qty:0,value:0,cost:0});dirty=true;scheduleAutoSave();renderCampingPkgs();var c=document.getElementById('cpk-'+i);if(c)c.classList.add('expanded');}
function removeCampingItem(i,ii){campingPkgs[i].items.splice(ii,1);dirty=true;scheduleAutoSave();renderCampingPkgs();var c=document.getElementById('cpk-'+i);if(c)c.classList.add('expanded');}
function addCampingPkg(){var colors=['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#6366f1'];var c=colors[campingPkgs.length%colors.length];var name=prompt('Package name (e.g., Tent Only, Glamping):');if(!name||!name.trim())return;campingPkgs.push({name:name.trim(),color:c,price:0,items:DEFAULT_CAMPING_ITEMS.map(function(it){return{name:it.name,qty:0,value:0,cost:0};})});dirty=true;scheduleAutoSave();renderCampingPkgs();}
function removeCampingPkg(i){if(!confirm('Delete "'+campingPkgs[i].name+'" package?'))return;campingPkgs.splice(i,1);dirty=true;scheduleAutoSave();renderCampingPkgs();}
function calcCampingSummary(){var tCost=0,tValue=0,tItems=0;campingPkgs.forEach(function(pk,i){var pkCost=0,pkValue=0,pkItems=0;pk.items.forEach(function(it){var q=parseInt(it.qty)||0;if(q>0)pkItems++;pkCost+=q*(parseFloat(it.cost)||0);pkValue+=q*(parseFloat(it.value)||0);});tCost+=pkCost;tValue+=pkValue;tItems+=pkItems;var sub=document.querySelector('#cpk-'+i+' .level-sub');if(sub)sub.textContent=pkItems+' items · Value $'+fmt(pkValue)+' · Cost $'+fmt(pkCost);});var cpTotal=campingPkgs.reduce(function(s,p){return s+p.price;},0);var cpOff=cpTotal-tCost;document.getElementById('cbPkgs').textContent=campingPkgs.length;document.getElementById('cbItems').textContent=tItems;document.getElementById('cbValue').textContent='$'+fmt(tValue);document.getElementById('cbCost').textContent='$'+fmt(tCost);var oEl=document.getElementById('cbOffset');oEl.textContent=(cpOff>=0?'+$':'-$')+fmt(Math.abs(cpOff));oEl.style.color=cpOff>=0?'#22c55e':'#ef4444';updateMasterKPI();}

// Camping drag
var campingDragIdx=null,campingGhostEl=null;
function campingGrab(e,i){e.preventDefault();e.stopPropagation();campingDragIdx=i;var card=document.getElementById('cpk-'+i);card.classList.add('dragging');campingGhostEl=card.cloneNode(true);campingGhostEl.classList.remove('dragging');campingGhostEl.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent-primary);top:'+(card.getBoundingClientRect().top)+'px;';document.body.appendChild(campingGhostEl);document.addEventListener('mousemove',campingMove);document.addEventListener('mouseup',campingRelease);document.addEventListener('touchmove',campingMove,{passive:false});document.addEventListener('touchend',campingRelease);}
function campingMove(e){if(campingDragIdx===null)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(campingGhostEl)campingGhostEl.style.top=(t.clientY-30)+'px';document.querySelectorAll('#campingArea .level-card').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var card=el.closest('.level-card');if(card&&card.id.startsWith('cpk-')&&card.id!=='cpk-'+campingDragIdx)card.classList.add('drag-over');}}
function campingRelease(e){document.removeEventListener('mousemove',campingMove);document.removeEventListener('mouseup',campingRelease);document.removeEventListener('touchmove',campingMove);document.removeEventListener('touchend',campingRelease);if(campingGhostEl){document.body.removeChild(campingGhostEl);campingGhostEl=null;}if(campingDragIdx===null)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tc=el?el.closest('.level-card'):null;var idx=-1;if(tc){var m=tc.id.match(/cpk-(\d+)/);if(m)idx=parseInt(m[1]);}document.querySelectorAll('#campingArea .level-card').forEach(function(c){c.classList.remove('dragging','drag-over');});if(idx>=0&&idx!==campingDragIdx){var item=campingPkgs.splice(campingDragIdx,1)[0];campingPkgs.splice(idx,0,item);dirty=true;scheduleAutoSave();renderCampingPkgs();}campingDragIdx=null;}

// ============================================================
// REVENUE ESTIMATOR (sponsors + tickets + vendors)
// ============================================================
var revData={sponsor:[],ticket:[],vendor:[],camping:[],sponsorActual:[],ticketActual:[],vendorActual:[],campingActual:[]};
var revSectionOrder=['sponsor','ticket','vendor','camping'];
function renderRevSliders(){var area=document.getElementById('revSliders');var h='';
while(revData.sponsor.length<levels.length)revData.sponsor.push(0);if(revData.sponsor.length>levels.length)revData.sponsor.length=levels.length;
while(revData.ticket.length<tickPkgs.length)revData.ticket.push(0);if(revData.ticket.length>tickPkgs.length)revData.ticket.length=tickPkgs.length;
while(revData.vendor.length<vendorPkgs.length)revData.vendor.push(0);if(revData.vendor.length>vendorPkgs.length)revData.vendor.length=vendorPkgs.length;
while(revData.camping.length<campingPkgs.length)revData.camping.push(0);if(revData.camping.length>campingPkgs.length)revData.camping.length=campingPkgs.length;
while(revData.sponsorActual.length<levels.length)revData.sponsorActual.push(0);if(revData.sponsorActual.length>levels.length)revData.sponsorActual.length=levels.length;
while(revData.ticketActual.length<tickPkgs.length)revData.ticketActual.push(0);if(revData.ticketActual.length>tickPkgs.length)revData.ticketActual.length=tickPkgs.length;
while(revData.vendorActual.length<vendorPkgs.length)revData.vendorActual.push(0);if(revData.vendorActual.length>vendorPkgs.length)revData.vendorActual.length=vendorPkgs.length;
while(revData.campingActual.length<campingPkgs.length)revData.campingActual.push(0);if(revData.campingActual.length>campingPkgs.length)revData.campingActual.length=campingPkgs.length;
if(!levels.length&&!tickPkgs.length&&!vendorPkgs.length&&!campingPkgs.length){area.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-secondary);font-size:13px;">Add sponsor levels, ticket packages, vendor packages, or camping packages above to estimate revenue</div>';calcRev();return;}
var secDefs={ticket:{label:'Ticket Packages',items:tickPkgs,data:'ticket',maxQ:500,ticks:['0','125','250','375','500']},vendor:{label:'Vendor Packages',items:vendorPkgs,data:'vendor',maxQ:50,ticks:['0','12','25','37','50']},camping:{label:'Camping Packages',items:campingPkgs,data:'camping',maxQ:200,ticks:['0','50','100','150','200']},sponsor:{label:'Sponsor Levels',items:levels,data:'sponsor',maxQ:3,ticks:['0','1','2','3']}};
revSectionOrder.forEach(function(secKey,si){var sec=secDefs[secKey];if(!sec||!sec.items.length)return;
var secGoal=0,secActual=0;sec.items.forEach(function(p,i){secGoal+=(revData[sec.data][i]||0);secActual+=(revData[sec.data+'Actual'][i]||0);});
h+='<div class="rev-section" data-rev-sec="'+secKey+'" id="revSec-'+secKey+'">';
h+='<div class="rev-section-hdr"><div class="rev-section-drag" onmousedown="revSecGrab(event,\''+secKey+'\')" ontouchstart="revSecGrab(event,\''+secKey+'\')"><i></i><i></i><i></i><i></i><i></i><i></i></div>';
h+='<div class="rev-section-label">'+sec.label+'</div>';
h+='<div class="rev-section-stats">'+secActual+' / '+secGoal+' sold</div></div>';
sec.items.forEach(function(pk,i){var qty=revData[sec.data][i]||0;var act=revData[sec.data+'Actual'][i]||0;var sub=qty*pk.price;var pkCost=0;var itemsArr=secKey==='sponsor'?pk.perks:pk.items;if(itemsArr)itemsArr.forEach(function(it){pkCost+=(parseInt(it.qty)||0)*(parseFloat(it.cost)||0);});
var mQ=secKey==='sponsor'?((pk.name.toLowerCase().indexOf('foundation')>=0)?100:sec.maxQ):sec.maxQ;var tks=secKey==='sponsor'?((pk.name.toLowerCase().indexOf('foundation')>=0)?['0','25','50','75','100']:sec.ticks):sec.ticks;
var pct=Math.min(100,Math.round(qty/mQ*100));var actPct=Math.min(100,Math.round(act/mQ*100));
h+='<div class="rev-slider-row" data-type="'+sec.data+'" data-idx="'+i+'" style="padding:8px 12px;">';
h+='<div class="rev-slider-left"><div class="rev-slider-name" style="color:'+pk.color+';">'+esc(pk.name)+'</div><div class="rev-slider-price">$'+fmt(pk.price)+' ea · $'+fmt(pkCost)+' cost</div></div>';
h+='<div class="rev-slider-mid"><div class="rev-range-wrap"><input type="range" class="rev-range" min="0" max="'+mQ+'" value="'+qty+'" oninput="setRevQty(\''+sec.data+'\','+i+',this.value)" style="background:linear-gradient(to right,'+pk.color+' '+pct+'%,rgba(255,255,255,.1) '+pct+'%);">';
if(act>0){h+='<div class="rev-actual-marker" style="left:'+actPct+'%;"></div><div class="rev-actual-label" style="left:'+actPct+'%;">'+act+'</div>';}
h+='</div><div class="rev-ticks">';tks.forEach(function(t){h+='<span class="rev-tick">'+t+'</span>';});h+='</div></div>';
h+='<div class="rev-slider-right"><div class="rev-qty-row"><div class="rev-input-col"><input type="number" class="rev-qty-input" value="'+qty+'" min="0" oninput="setRevQty(\''+sec.data+'\','+i+',this.value)" style="border-color:'+pk.color+';"><div class="rev-input-lbl">Goal</div></div>';
h+='<div class="rev-input-col"><input type="number" class="rev-actual-input" value="'+(act||'')+'" min="0" oninput="setRevActual(\''+sec.data+'\','+i+',this.value)" placeholder="0"><div class="rev-input-lbl" style="color:rgba(255,255,255,.6);">Actual</div></div></div>';
h+='<div class="rev-subtotal">'+act+' / '+qty+'</div>';
h+='<div class="rev-bar"><div class="rev-bar-fill" style="width:'+pct+'%;background:'+pk.color+';"></div></div>';
if(qty>0){var aP=Math.min(100,Math.round(act/qty*100));h+='<div class="rev-bar" style="margin-top:2px;"><div class="rev-bar-fill" style="width:'+aP+'%;background:#fff;opacity:.5;"></div></div>';}
h+='</div></div>';});
h+='</div>';});
area.innerHTML=h;calcRev();}

// Rev section drag
var revSecDragKey=null,revSecGhostEl=null;
function revSecGrab(e,key){e.preventDefault();e.stopPropagation();revSecDragKey=key;var el=document.getElementById('revSec-'+key);el.classList.add('dragging');revSecGhostEl=el.cloneNode(true);revSecGhostEl.classList.remove('dragging');revSecGhostEl.style.cssText='position:fixed;left:16px;right:16px;opacity:.85;z-index:9999;pointer-events:none;border:2px solid var(--accent-primary);border-radius:8px;top:'+(el.getBoundingClientRect().top)+'px;';document.body.appendChild(revSecGhostEl);document.addEventListener('mousemove',revSecMove);document.addEventListener('mouseup',revSecRelease);document.addEventListener('touchmove',revSecMove,{passive:false});document.addEventListener('touchend',revSecRelease);}
function revSecMove(e){if(!revSecDragKey)return;e.preventDefault();var t=e.touches?e.touches[0]:e;if(revSecGhostEl)revSecGhostEl.style.top=(t.clientY-30)+'px';document.querySelectorAll('.rev-section').forEach(function(c){c.classList.remove('drag-over');});var el=document.elementFromPoint(t.clientX,t.clientY);if(el){var sec=el.closest('.rev-section');if(sec&&sec.dataset.revSec!==revSecDragKey)sec.classList.add('drag-over');}}
function revSecRelease(e){document.removeEventListener('mousemove',revSecMove);document.removeEventListener('mouseup',revSecRelease);document.removeEventListener('touchmove',revSecMove);document.removeEventListener('touchend',revSecRelease);if(revSecGhostEl){document.body.removeChild(revSecGhostEl);revSecGhostEl=null;}if(!revSecDragKey)return;var t=e.changedTouches?e.changedTouches[0]:e;var el=document.elementFromPoint(t.clientX,t.clientY);var tgt=el?el.closest('.rev-section'):null;document.querySelectorAll('.rev-section').forEach(function(c){c.classList.remove('dragging','drag-over');});if(tgt&&tgt.dataset.revSec!==revSecDragKey){var fromIdx=revSectionOrder.indexOf(revSecDragKey);var toIdx=revSectionOrder.indexOf(tgt.dataset.revSec);if(fromIdx>=0&&toIdx>=0){revSectionOrder.splice(fromIdx,1);revSectionOrder.splice(toIdx,0,revSecDragKey);dirty=true;scheduleAutoSave();renderRevSliders();}}revSecDragKey=null;}

function setRevQty(type,i,val){var v=parseInt(val)||0;if(v<0)v=0;revData[type][i]=v;var items=type==='sponsor'?levels:(type==='ticket'?tickPkgs:(type==='vendor'?vendorPkgs:campingPkgs));var item=items[i];var price=item.price;var sub=v*price;var color=item.color;var maxQ;if(type==='ticket'){maxQ=500;}else if(type==='vendor'){maxQ=50;}else if(type==='camping'){maxQ=200;}else{maxQ=(item.name.toLowerCase().indexOf('foundation')>=0)?100:3;}var pct=Math.min(100,Math.round(v/maxQ*100));
var rows=document.querySelectorAll('.rev-slider-row[data-type="'+type+'"][data-idx="'+i+'"]');if(rows.length){var row=rows[0];var range=row.querySelector('.rev-range');var input=row.querySelector('.rev-qty-input');var subEl=row.querySelector('.rev-subtotal');var fill=row.querySelector('.rev-bar-fill');if(range){range.style.background='linear-gradient(to right,'+color+' '+pct+'%,rgba(255,255,255,.1) '+pct+'%)';if(range!==document.activeElement)range.value=v;}if(input&&input!==document.activeElement)input.value=v;if(subEl)subEl.textContent='$'+fmt(sub);if(fill){fill.style.width=pct+'%';fill.style.background=color;}}
dirty=true;scheduleAutoSave();calcRev();}

function setRevActual(type,i,val){var v=parseInt(val)||0;if(v<0)v=0;var key=type+'Actual';revData[key][i]=v;dirty=true;scheduleAutoSave();renderRevSliders();}

function calcRev(){var goalQty=0,actualQty=0;
var deptGoal={sponsor:0,ticket:0,vendor:0,camping:0};var deptActual={sponsor:0,ticket:0,vendor:0,camping:0};
levels.forEach(function(lv,i){var g=revData.sponsor[i]||0;var a=revData.sponsorActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.sponsor+=g;deptActual.sponsor+=a;});
tickPkgs.forEach(function(pk,i){var g=revData.ticket[i]||0;var a=revData.ticketActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.ticket+=g;deptActual.ticket+=a;});
vendorPkgs.forEach(function(pk,i){var g=revData.vendor[i]||0;var a=revData.vendorActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.vendor+=g;deptActual.vendor+=a;});
campingPkgs.forEach(function(pk,i){var g=revData.camping[i]||0;var a=revData.campingActual[i]||0;goalQty+=g;actualQty+=a;deptGoal.camping+=g;deptActual.camping+=a;});
var pctSold=goalQty>0?Math.round(actualQty/goalQty*100):0;var remaining=Math.max(0,goalQty-actualQty);
document.getElementById('revGoalQty').textContent=fmt(goalQty);
document.getElementById('revActualQty').textContent=fmt(actualQty);
document.getElementById('revPctSold').textContent=pctSold+'%';document.getElementById('revPctSold').style.color=pctSold>=100?'#22c55e':pctSold>=50?'#f59e0b':'#fff';
document.getElementById('revRemaining').textContent=fmt(remaining);document.getElementById('revRemaining').style.color=remaining===0?'#22c55e':'#f59e0b';
document.getElementById('revSponsorQty').textContent=deptActual.sponsor+' / '+deptGoal.sponsor;document.getElementById('revSponsorQty').style.color=deptActual.sponsor>=deptGoal.sponsor&&deptGoal.sponsor>0?'#22c55e':'#fff';
document.getElementById('revTicketQty').textContent=deptActual.ticket+' / '+deptGoal.ticket;document.getElementById('revTicketQty').style.color=deptActual.ticket>=deptGoal.ticket&&deptGoal.ticket>0?'#22c55e':'#fff';
document.getElementById('revVendorQty').textContent=deptActual.vendor+' / '+deptGoal.vendor;document.getElementById('revVendorQty').style.color=deptActual.vendor>=deptGoal.vendor&&deptGoal.vendor>0?'#22c55e':'#fff';
document.getElementById('revCampingQty').textContent=deptActual.camping+' / '+deptGoal.camping;document.getElementById('revCampingQty').style.color=deptActual.camping>=deptGoal.camping&&deptGoal.camping>0?'#22c55e':'#fff';
updateMasterKPI();}

// ============================================================
// VOTING & PUBLISH SYSTEM
// ============================================================
var userRole='manager',viewMode='editor';

async function detectRole(){try{var r=await sb.from('event_members').select('role_level').eq('tenant_id',tenantId).eq('email',(await sb.auth.getSession()).data.session.user.email).single();if(r.data)userRole=r.data.role_level||'manager';}catch(e){}}

function setViewMode(mode){viewMode=mode;
document.querySelectorAll('.view-tab').forEach(function(t){t.classList.remove('active');
var txt=t.textContent.toLowerCase();
if((mode==='editor'&&txt.indexOf('my')>=0)||(mode==='review'&&txt.indexOf('review')>=0)||(mode==='official'&&txt.indexOf('official')>=0))t.classList.add('active');});
document.getElementById('reviewPanel').classList.toggle('show',mode==='review');
document.getElementById('officialView').style.display=mode==='official'?'':'none';
if(mode==='editor'){document.getElementById('editorView').style.display='';exitReadOnly();}
else if(mode==='official'){loadOfficialSheet();}
else{document.getElementById('editorView').style.display='none';}
if(mode==='review')renderReviewBoard();
updateActionButtons();}

function updateActionButtons(){
var s=currentSheetId&&currentSheetId!=='preloaded'?allSheets.find(function(e){return e.sheet_id===currentSheetId;}):null;
var isMine=s&&s.created_by===userId;
var isAdmin=userRole==='admin';
var status=s?s.status||'draft':'draft';
// Delete
document.getElementById('deskDelBtn').style.display=isMine?'':'none';
document.getElementById('mobDelBtn').style.display=isMine?'':'none';
// Submit for review (own sheets only, draft status)
var canSubmit=isMine&&status==='draft';
document.getElementById('deskSubmitBtn').style.display=canSubmit?'':'none';
document.getElementById('mobSubmitBtn').style.display=canSubmit?'':'none';
// Publish (admin only, submitted or draft)
var canPublish=isAdmin&&s;
document.getElementById('deskPublishBtn').style.display=canPublish?'':'none';
document.getElementById('mobPublishBtn').style.display=canPublish?'':'none';
}

async function submitForReview(){if(!currentSheetId||currentSheetId==='preloaded')return;
await saveToDb(true);
var uName=(await sb.auth.getSession()).data.session.user.email||'Unknown';
var r=await sb.from('sponsor_sheets').update({status:'submitted',submitted_at:new Date().toISOString(),submitted_by_name:uName}).eq('sheet_id',currentSheetId);
if(r.error){toast('Error submitting');return;}
var s=allSheets.find(function(e){return e.sheet_id===currentSheetId;});if(s){s.status='submitted';s.submitted_by_name=uName;}
toast('Submitted for review!');updateActionButtons();updateReviewCounts();}

async function publishSheet(sheetId){
var id=sheetId||currentSheetId;if(!id||id==='preloaded')return;
if(!confirm('Publish this sheet as the Official Budget? This will replace any existing official version.'))return;
// Unpublish any existing
await sb.from('sponsor_sheets').update({status:'draft'}).eq('tenant_id',tenantId).eq('status','published');
// Publish selected
var uName=(await sb.auth.getSession()).data.session.user.email||'Unknown';
var now=new Date().toISOString();
var sheet=allSheets.find(function(s){return s.sheet_id===id;});
var sheetName=sheet?sheet.sheet_name:'Untitled';
var r=await sb.from('sponsor_sheets').update({status:'published',published_by:userId,published_at:now,submitted_by_name:uName}).eq('sheet_id',id);
if(r.error){toast('Error publishing');return;}
// Log to publish history
await sb.from('publish_history').insert({tenant_id:tenantId,sheet_id:id,sheet_name:sheetName,published_by:userId,published_by_name:uName,published_at:now,page_type:'sponsors'});
await loadSheets();renderSelects();updateActionButtons();updateReviewCounts();
toast('Published as Official Budget!');
if(viewMode==='review')renderReviewBoard();}

async function renderPublishLog(){
var area=document.getElementById('publishLogRows');
var r=await sb.from('publish_history').select('*').eq('tenant_id',tenantId).eq('page_type','sponsors').order('published_at',{ascending:false}).limit(20);
var rows=r.data||[];
if(!rows.length){area.innerHTML='<div style="font-size:12px;color:var(--text-secondary);padding:8px 0;">No publish history yet.</div>';return;}
var h='';rows.forEach(function(row){
var d=new Date(row.published_at);
var dateStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
var timeStr=d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
h+='<div class="publish-log-row">';
h+='<div class="publish-log-dot"></div>';
h+='<div class="publish-log-name">'+esc(row.sheet_name||'Untitled')+'</div>';
h+='<div class="publish-log-by">'+esc(row.published_by_name||'Unknown')+'</div>';
h+='<div class="publish-log-date">'+dateStr+' '+timeStr+'</div>';
h+='</div>';});
area.innerHTML=h;}

async function unpublishSheet(sheetId){
if(!confirm('Unpublish this sheet?'))return;
await sb.from('sponsor_sheets').update({status:'submitted'}).eq('sheet_id',sheetId);
await loadSheets();renderSelects();updateActionButtons();updateReviewCounts();toast('Unpublished');if(viewMode==='review')renderReviewBoard();}

async function voteOnSheet(sheetId,vote){
var existing=await sb.from('sheet_votes').select('*').eq('sheet_id',sheetId).eq('user_id',userId).single();
if(existing.data){
if(existing.data.vote===vote){await sb.from('sheet_votes').delete().eq('vote_id',existing.data.vote_id);}
else{await sb.from('sheet_votes').update({vote:vote}).eq('vote_id',existing.data.vote_id);}
}else{await sb.from('sheet_votes').insert({sheet_id:sheetId,tenant_id:tenantId,user_id:userId,vote:vote});}
renderReviewBoard();}

async function renderReviewBoard(){
var submitted=allSheets.filter(function(s){return s.status==='submitted'||s.status==='published';});
var area=document.getElementById('reviewCards');var empty=document.getElementById('reviewEmpty');
if(!submitted.length){area.innerHTML='';empty.style.display='';updateReviewCounts();return;}
empty.style.display='none';
// Get all votes for these sheets
var ids=submitted.map(function(s){return s.sheet_id;});
var vr=await sb.from('sheet_votes').select('*').in('sheet_id',ids);
var votes=vr.data||[];
// Get my votes
var myVotes={};votes.forEach(function(v){if(v.user_id===userId)myVotes[v.sheet_id]=v.vote;});
// Calculate scores
var scores={};ids.forEach(function(id){scores[id]=0;});
votes.forEach(function(v){scores[v.sheet_id]=(scores[v.sheet_id]||0)+v.vote;});
// Sort by: published first, then score desc, then submitted_at desc
submitted.sort(function(a,b){if(a.status==='published'&&b.status!=='published')return -1;if(b.status==='published'&&a.status!=='published')return 1;var sa=scores[a.sheet_id]||0,sb2=scores[b.sheet_id]||0;if(sb2!==sa)return sb2-sa;return new Date(b.submitted_at||0)-new Date(a.submitted_at||0);});
var isAdmin=userRole==='admin';
var h='';submitted.forEach(function(s){
var score=scores[s.sheet_id]||0;var myVote=myVotes[s.sheet_id]||0;
var isPub=s.status==='published';
var when=s.submitted_at?new Date(s.submitted_at).toLocaleDateString():'';
h+='<div class="review-card'+(isPub?' published':'')+'">';
h+='<div class="review-vote">';
h+='<button class="vote-btn'+(myVote===1?' voted-up':'')+'" onclick="voteOnSheet(\''+s.sheet_id+'\',1)">▲</button>';
h+='<div class="vote-score"'+(score>0?' style="color:#22c55e"':score<0?' style="color:#ef4444"':'')+'>'+score+'</div>';
h+='<button class="vote-btn'+(myVote===-1?' voted-down':'')+'" onclick="voteOnSheet(\''+s.sheet_id+'\',-1)">▼</button>';
h+='</div>';
h+='<div class="review-info"><div class="review-name">'+esc(s.sheet_name||'Untitled')+' <span class="status-badge status-'+(s.status||'draft')+'">'+(isPub?'★ OFFICIAL':s.status||'draft')+'</span></div>';
h+='<div class="review-meta">by '+esc(s.submitted_by_name||'Unknown')+' · '+when+'</div></div>';
h+='<div class="review-actions">';
h+='<button class="hdr-btn" onclick="syncSel(\''+s.sheet_id+'\');setViewMode(\'editor\')" style="font-size:11px;padding:5px 10px;">View</button>';
if(isAdmin&&!isPub)h+='<button class="hdr-btn publish" onclick="publishSheet(\''+s.sheet_id+'\')" style="font-size:11px;padding:5px 10px;">Publish</button>';
if(isAdmin&&isPub)h+='<button class="hdr-btn danger" onclick="unpublishSheet(\''+s.sheet_id+'\')" style="font-size:11px;padding:5px 10px;">Unpublish</button>';
h+='</div></div>';});
area.innerHTML=h;updateReviewCounts();}

function updateReviewCounts(){
var count=allSheets.filter(function(s){return s.status==='submitted';}).length;
var el1=document.getElementById('deskReviewCount');
var el2=document.getElementById('mobReviewCount');
if(el1)el1.textContent=count;if(el2)el2.textContent=count;}

async function loadOfficialSheet(){
var pub=allSheets.find(function(s){return s.status==='published';});
var view=document.getElementById('officialView');
var editor=document.getElementById('editorView');
renderPublishLog();
if(!pub){document.getElementById('officialMeta').textContent='No official budget published yet. Submit your sheet for review!';
editor.style.display='none';return;}
// Load it into the editor in read-only mode
syncSel(pub.sheet_id);
var when=pub.published_at?new Date(pub.published_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
document.getElementById('officialMeta').textContent='Published by '+(pub.submitted_by_name||'Admin')+' on '+when;
// Show editor content as read-only
editor.style.display='';editor.classList.add('readonly-overlay');
// Disable all inputs
setTimeout(function(){editor.querySelectorAll('input,select,button,textarea').forEach(function(el){el.disabled=true;});},100);}

function exitReadOnly(){
document.getElementById('editorView').classList.remove('readonly-overlay');
document.getElementById('editorView').querySelectorAll('input,select,button,textarea').forEach(function(el){el.disabled=false;});}

// Print / PDF
function printSheet(){
  var sheetName=document.getElementById('sheetName').value||'Sponsor Sheet';
  var eventName=document.getElementById('sheetEvent').value||'';
  document.getElementById('printTitle').textContent=sheetName;
  document.getElementById('printSub').textContent=eventName?(eventName+' — Printed '+new Date().toLocaleDateString()):('Printed '+new Date().toLocaleDateString());
  document.querySelectorAll('.section-wrap').forEach(function(w){w.classList.add('open');});
  document.querySelectorAll('.section-chv').forEach(function(c){c.textContent='▾';});
  document.querySelectorAll('.level-card').forEach(function(c){c.classList.add('expanded');});
  setTimeout(function(){window.print();},200);
}

// Init
async function init(){var s=await checkAuth();if(!s)return;userId=s.user.id;var email=s.user.email||'';if(email){var ur=await sb.from('users').select('tenant_id,user_id').eq('email',email).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}document.getElementById('dBiz').textContent=email;document.getElementById('mBiz').textContent=email;}if(!tenantId){var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}if(!tenantId){toast('Could not determine tenant');return;}await ensureTables();await ensureValueColumns();await detectRole();await loadSheets();renderSelects();updateReviewCounts();updateActionButtons();var lastId=localStorage.getItem('elp-last-sponsor');if(lastId&&(lastId==='preloaded'||allSheets.find(function(s){return s.sheet_id===lastId;}))){syncSel(lastId);}else{loadPreloaded();}}
init();
window.addEventListener('beforeunload',function(){if(dirty&&currentSheetId&&currentSheetId!=='preloaded'){navigator.sendBeacon||autoSave();}});
document.addEventListener('visibilitychange',function(){if(document.hidden&&dirty)autoSave();});
</script>
</body>
</html>
