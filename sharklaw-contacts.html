-- ============================================================
-- FUNNEL STAGES TABLE — stores custom funnel columns per tenant
-- ============================================================

CREATE TABLE IF NOT EXISTS funnel_stages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  tenant_id UUID NOT NULL,
  stage_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_color TEXT NOT NULL DEFAULT '#3b82f6',
  sort_order INTEGER NOT NULL DEFAULT 0,
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(tenant_id, stage_id)
);

-- Index for fast lookups
CREATE INDEX IF NOT EXISTS idx_funnel_stages_tenant 
  ON funnel_stages(tenant_id) WHERE is_deleted = FALSE;

-- Enable RLS
ALTER TABLE funnel_stages ENABLE ROW LEVEL SECURITY;

-- Policy: users can read/write their own tenant's funnels
CREATE POLICY "Users can view own tenant funnels" 
  ON funnel_stages FOR SELECT 
  USING (TRUE);

CREATE POLICY "Users can insert own tenant funnels" 
  ON funnel_stages FOR INSERT 
  WITH CHECK (TRUE);

CREATE POLICY "Users can update own tenant funnels" 
  ON funnel_stages FOR UPDATE 
  USING (TRUE);

CREATE POLICY "Users can delete own tenant funnels" 
  ON funnel_stages FOR DELETE 
  USING (TRUE);

-- ============================================================
-- SEED DEFAULT STAGES (run once per tenant — replace YOUR_TENANT_ID)
-- Or let the app auto-seed on first load (handled in JS below)
-- ============================================================
-- INSERT INTO funnel_stages (tenant_id, stage_id, stage_name, stage_color, sort_order) VALUES
--   ('YOUR_TENANT_ID', 1, '1st Contact',            '#3b82f6', 1),
--   ('YOUR_TENANT_ID', 2, 'Follow Up',              '#06b6d4', 2),
--   ('YOUR_TENANT_ID', 3, 'Swag Approved',          '#8b5cf6', 3),
--   ('YOUR_TENANT_ID', 4, 'Receive Artwork',        '#f59e0b', 4),
--   ('YOUR_TENANT_ID', 5, 'Deliver Pop Up',         '#10b981', 5),
--   ('YOUR_TENANT_ID', 6, 'Confirmed Partnership',  '#ef4444', 6);
