<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Contacts</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <link rel="stylesheet" href="themes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="employee-utils.js"></script>
  <style>
    :root{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="blue-light"]{--bg-primary:#f0f5ff;--bg-secondary:#e0eaff;--bg-card:#ffffff;--bg-hover:#d0e0ff;--border-default:#b0c8f0;--text-primary:#1a2744;--text-secondary:#4a5a74;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="slate-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#ffffff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#e0f7f4;--bg-card:#ffffff;--bg-hover:#ccfbf1;--border-default:#99f6e4;--text-primary:#134e4a;--text-secondary:#2d6a66;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="midnight-dark"],[data-theme="midnight"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#ffffff;--bg-hover:#ede4ff;--border-default:#d8b4fe;--text-primary:#3b1d5c;--text-secondary:#6b4d8a;--accent-primary:#9333ea;--accent-light:#a855f7;}
    [data-theme="forest-dark"],[data-theme="forest"]{--bg-primary:#071209;--bg-secondary:#0c1f10;--bg-card:#132a18;--bg-hover:#1a3820;--border-default:#234428;--text-primary:#e5f5e8;--text-secondary:#8fb898;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#ffffff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#3d6b4f;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#ffffff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#ffffff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#ffffff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#3a6a8a;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fefcf8;--bg-secondary:#faf6ee;--bg-card:#ffffff;--bg-hover:#f5efe0;--border-default:#e8dcc8;--text-primary:#44402a;--text-secondary:#6a6550;--accent-primary:#a89060;--accent-light:#c4aa78;}
    [data-theme="slate"],[data-theme="ocean"],[data-theme="light-blue"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#64748b;--accent-light:#94a3b8;}

    *{margin:0;padding:0;box-sizing:border-box;}html{background:var(--bg-primary);}body{font-family:system-ui;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden;width:100%;max-width:100vw;}

    /* ===== HEADER / NAV ===== */
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}.theme-toggle-btn:hover{background:var(--bg-hover);}.theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .theme-toast{position:fixed;bottom:200px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;z-index:1000;display:none;}.theme-toast.show{display:block;}
    .mobile-top-header{display:none;position:sticky;top:0;z-index:100;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);}
    .mobile-header-bar{display:flex;justify-content:space-between;align-items:center;padding:12px;gap:12px;}
    .mobile-menu-toggle{background:transparent;border:none;color:var(--text-secondary);font-size:20px;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .mobile-header-center{flex:1;}.mobile-header-title{font-size:18px;font-weight:600;}.business-name{font-size:12px;color:var(--accent-light);}
    .mobile-header-right{display:flex;align-items:center;gap:12px;}
    .mobile-menu-content{max-height:0;overflow:hidden;transition:max-height .3s;background:var(--bg-primary);border-top:1px solid var(--border-default);}.mobile-menu-content.expanded{max-height:200px;}
    .mobile-header-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:8px 12px 12px;}
    .mobile-header-actions button{padding:10px;font-size:13px;background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border:1px solid color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--accent-light);border-radius:8px;cursor:pointer;}
    .desktop-header{position:sticky;top:0;z-index:100;background:var(--bg-primary);border-bottom:1px solid var(--border-default);}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}.mobile-nav-row:last-child{margin-bottom:0;}.mobile-nav-row.three-col{grid-template-columns:1fr 1fr 1fr;}
    .mobile-nav-btn{padding:10px 8px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:44px;}
    .mobile-nav-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}
    .mobile-nav-btn.action-btn{background:color-mix(in srgb,var(--accent-primary) 20%,transparent);border-color:color-mix(in srgb,var(--accent-primary) 50%,transparent);color:var(--accent-light);font-size:14px;}
    @media(max-width:768px){.desktop-header{display:none!important;}.mobile-top-header{display:block;}.mobile-bottom-nav{display:block!important;}body{padding-bottom:120px;}}
    @media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}}

    /* ===== KPI BAR ===== */
    .kpi-bar{display:flex;gap:8px;padding:10px 16px;background:var(--bg-secondary);justify-content:center;border-bottom:1px solid var(--border-default);overflow-x:auto;scrollbar-width:none;}.kpi-bar::-webkit-scrollbar{display:none;}
    .kpi{display:flex;flex-direction:column;align-items:center;padding:8px 18px;background:var(--bg-card);border-radius:10px;border:1px solid var(--border-default);min-width:68px;cursor:pointer;transition:all .15s;flex-shrink:0;}
    .kpi:hover{border-color:var(--accent-primary);}
    .kpi.active{border-color:var(--accent-primary);background:color-mix(in srgb,var(--accent-primary) 10%,var(--bg-card));}
    .kpi.active .kpi-val{color:var(--accent-light);}
    .kpi-val{font-size:22px;font-weight:800;color:var(--text-primary);line-height:1.2;letter-spacing:-.5px;}
    .kpi-lbl{font-size:9px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.3px;margin-top:2px;white-space:nowrap;text-align:center;}
    @media(max-width:768px){.kpi-bar{flex-wrap:wrap;gap:6px;padding:8px;overflow:visible;}.kpi{flex:1 1 calc(25% - 6px);min-width:0;max-width:calc(25% - 6px);padding:6px 4px;}.kpi-val{font-size:17px;}.kpi-lbl{font-size:8px;}}

    /* ===== SEARCH ===== */
    .search-section{padding:12px;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);}
    .search-row{display:flex;gap:8px;align-items:center;}
    .search-wrap{position:relative;flex:1;}
    .search-input{width:100%;padding:10px 14px 10px 38px;border-radius:10px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:14px;}.search-input:focus{outline:none;border-color:var(--accent-primary);}
    .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:15px;pointer-events:none;}
    .ac-dd{position:absolute;top:100%;left:0;right:0;z-index:50;background:var(--bg-card);border:1px solid var(--border-default);border-top:none;border-radius:0 0 10px 10px;max-height:260px;overflow-y:auto;display:none;box-shadow:0 8px 24px rgba(0,0,0,.35);}.ac-dd.open{display:block;}
    .ac-row{padding:10px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid color-mix(in srgb,var(--border-default) 40%,transparent);font-size:13px;}.ac-row:last-child{border:none;}.ac-row:hover,.ac-row.hl{background:var(--bg-hover);}
    .ac-name{color:var(--text-primary);font-weight:500;}.ac-name mark{background:transparent;color:var(--accent-light);font-weight:700;}
    .ac-sub{font-size:11px;color:var(--text-secondary);}
    .add-btn{padding:10px 16px;border-radius:10px;border:none;background:var(--accent-primary);color:#fff;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;}.add-btn:hover{background:var(--accent-light);}

    /* ===== FILTER CHIPS ===== */
    /* filters handled by KPI pills */

    /* ===== SORT ===== */
    .list-toolbar{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;}
    .result-count{font-size:12px;color:var(--text-secondary);}
    .team-select{padding:6px 10px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:12px;max-width:180px;}
    .vault-btn{padding:5px 12px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;display:none;transition:all .15s;}.vault-btn:hover{border-color:var(--accent-primary);}.vault-btn.on{background:color-mix(in srgb,#ef4444 15%,var(--bg-card));border-color:#ef4444;color:#ef4444;}
    .vault-badge{display:inline-block;background:#ef4444;color:#fff;font-size:9px;padding:1px 5px;border-radius:8px;margin-left:4px;font-weight:700;}
    .alpha-strip{display:flex;gap:2px;padding:4px 12px 8px;overflow-x:auto;scrollbar-width:none;}.alpha-strip::-webkit-scrollbar{display:none;}
    .alpha-btn{width:28px;height:28px;border-radius:6px;border:1px solid transparent;background:transparent;color:var(--text-secondary);font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;}.alpha-btn:hover{background:var(--bg-hover);}.alpha-btn.on{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);}

    /* ===== CONTACT CARDS ===== */
    .contacts-grid{padding:8px 12px 20px;display:grid;gap:8px;grid-template-columns:1fr;}
    @media(min-width:769px){.contacts-grid{grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:10px;padding:12px 16px 20px;}}
    .cc{background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;padding:12px 14px;display:flex;gap:12px;align-items:center;cursor:pointer;transition:border-color .15s,transform .1s;}.cc:hover{border-color:var(--accent-primary);transform:translateY(-1px);}
    .cc-av{width:42px;height:42px;border-radius:50%;background:var(--bg-hover);display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:var(--accent-light);flex-shrink:0;border:2px solid var(--border-default);}
    .cc-body{flex:1;min-width:0;}
    .cc-name{font-size:14px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cc-org{font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cc-meta{display:flex;gap:10px;margin-top:3px;font-size:11px;color:var(--text-secondary);}.cc-meta a{color:var(--accent-light);text-decoration:none;}
    .cc-badge{padding:3px 8px;border-radius:6px;background:var(--bg-hover);color:var(--text-secondary);font-size:10px;font-weight:600;text-transform:uppercase;flex-shrink:0;letter-spacing:.3px;}
    .cc-empty{text-align:center;padding:60px 20px;color:var(--text-secondary);font-size:14px;}

    /* ===== DETAIL MODAL ===== */
    .modal-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;padding:20px;}.modal-bg.active{display:flex;}
    .modal-box{background:var(--bg-secondary);border-radius:14px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;border:1px solid var(--border-default);}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border-default);}
    .modal-title{font-size:18px;font-weight:600;}.modal-x{background:transparent;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;}
    .modal-body{padding:20px;}.fg{margin-bottom:14px;}.fl{display:block;font-size:13px;font-weight:500;color:var(--text-secondary);margin-bottom:5px;}.fl .req{color:#ef4444;}
    .fi,.fsel,.fta{width:100%;padding:10px 12px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-primary);font-size:14px;}.fta{min-height:80px;resize:vertical;}.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:768px){.fr{grid-template-columns:1fr;}.modal-bg{align-items:flex-end;padding:0;}.modal-box{border-radius:20px 20px 0 0;max-height:92vh;}}
    .modal-foot{display:flex;gap:12px;justify-content:flex-end;padding:14px 20px;border-top:1px solid var(--border-default);}
    .btn-s{padding:10px 20px;border-radius:6px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;}
    .btn-p{padding:10px 20px;border-radius:6px;border:none;background:var(--accent-primary);color:#fff;font-size:14px;font-weight:500;cursor:pointer;}.btn-p:hover{background:var(--accent-light);}
    .btn-d{padding:10px 20px;border-radius:6px;border:none;background:#dc2626;color:#fff;font-size:14px;cursor:pointer;width:100%;}.btn-d:hover{background:#ef4444;}
    .det-head{text-align:center;padding-bottom:16px;border-bottom:1px solid var(--border-default);margin-bottom:16px;}
    .det-av{width:80px;height:80px;border-radius:50%;background:var(--bg-hover);display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:600;color:var(--accent-light);margin:0 auto 12px;border:3px solid var(--border-default);}
    .det-name{font-size:20px;font-weight:600;}.det-company{font-size:14px;color:var(--text-secondary);}
    .det-actions{display:flex;gap:8px;justify-content:center;margin-top:12px;}
    .det-btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:12px;cursor:pointer;text-decoration:none;}.det-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .sec{margin-bottom:16px;}.sec-title{font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;}
  </style>
</head>
<body>
<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="document.getElementById('mMenu').classList.toggle('expanded')">‚ò∞</button>
    <div class="mobile-header-center"><div class="mobile-header-title">Contacts</div><div class="business-name" id="mBiz">Loading...</div></div>
    <div class="mobile-header-right"><button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button></div>
  </div>
  <div class="mobile-menu-content" id="mMenu"><div class="mobile-header-actions"><button onclick="location.href='sharklaw-settings.html'">Settings</button><button onclick="location.href='support.html'">Support</button><button onclick="location.href='account.html'">Account</button></div></div>
</div>
<div class="desktop-header">
  <div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;">
    <div><h1 style="margin:0;font-size:32px;font-weight:600;">Contacts</h1><div class="business-name" id="dBiz">Loading...</div></div>
    <div style="display:flex;align-items:center;gap:16px;"><button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button><a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a></div>
  </div>
  <div style="padding:0 24px 12px;"><nav style="display:flex;gap:24px;">
    <a href="dashboard-sharklaw.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Dashboard</a>
    <a href="sharklaw-scheduler.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Scheduler</a>
    <a href="sharklaw-contacts.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">Contacts</a>
    <a href="sharklaw-pipeline.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Pipeline</a>
    <a href="sharklaw-swag.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Swag</a>
    <a href="sharklaw-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a>
  </nav></div>
</div>

<div class="kpi-bar" id="kpiBar"></div>

<div class="search-section">
  <div class="search-row">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="searchBox" placeholder="Search by name, phone, organization..." oninput="onSearch()" onkeydown="onSearchKey(event)" autocomplete="off">
      <div class="ac-dd" id="acDd"></div>
    </div>
    <button class="add-btn" onclick="openAdd()">+ New</button>
  </div>
</div>

<div class="alpha-strip" id="alphaStrip"></div>
<div class="list-toolbar"><div class="result-count" id="rCount"></div><div style="display:flex;gap:6px;align-items:center;"><button class="vault-btn" id="vaultBtn" onclick="toggleVault()">üîí Vault</button><select class="team-select" id="teamSel" onchange="renderList()"><option value="">All Team Members</option></select></div></div>
<div class="contacts-grid" id="grid"></div>

<!-- Detail -->
<div class="modal-bg" id="detailModal"><div class="modal-box" style="max-width:540px;"><div class="modal-head"><div class="modal-title">Contact Details</div><button class="modal-x" onclick="closeDet()">&times;</button></div><div class="modal-body" id="detBody"></div></div></div>
<!-- Add -->
<div class="modal-bg" id="addModal"><div class="modal-box"><div class="modal-head"><div class="modal-title">New Contact</div><button class="modal-x" onclick="closeAdd()">&times;</button></div>
<div class="modal-body">
  <div class="fr"><div class="fg"><label class="fl">First Name <span class="req">*</span></label><input type="text" class="fi" id="nF"></div><div class="fg"><label class="fl">Last Name</label><input type="text" class="fi" id="nL"></div></div>
  <div class="fg"><label class="fl">Organization <span class="req">*</span></label><input type="text" class="fi" id="nO"></div>
  <div class="fg"><label class="fl">Phone <span class="req">*</span></label><input type="tel" class="fi" id="nP"></div>
  <div class="fg"><label class="fl">Email</label><input type="email" class="fi" id="nE"></div>
  <div class="fr"><div class="fg"><label class="fl">Client Type</label><select class="fsel" id="nT"><option value="">-- Select --</option><option value="RC">Riding Club</option><option value="HOG">HOG Chapter</option><option value="MC">Motorcycle Club</option><option value="SC">Social Club</option><option value="Shop">Shop</option><option value="Independent">Independent</option><option value="Other">Other</option></select></div><div class="fg"><label class="fl">Assign To</label><select class="fsel" id="nA"><option value="">-- Unassigned --</option></select></div></div>
  <div class="fg"><label class="fl">Notes</label><textarea class="fta" id="nN"></textarea></div>
</div>
<div class="modal-foot"><button class="btn-s" onclick="closeAdd()">Cancel</button><button class="btn-p" onclick="saveAdd()">Add Contact</button></div></div></div>

<div class="mobile-bottom-nav">
  <div class="mobile-nav-row"><a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a><a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a></div>
  <div class="mobile-nav-row three-col"><button class="mobile-nav-btn action-btn" onclick="openAdd()">+ Contact</button><a href="sharklaw-pipeline.html" class="mobile-nav-btn">Funnel</a><a href="sharklaw-contacts.html" class="mobile-nav-btn active">Contacts</a></div>
</div>
<div class="theme-toast" id="themeToast"></div>

<script>
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);
var currentUserId=null,currentTenantId=null,userEmail=null,currentUserRole=null,currentEmployeeId=null;
var allContacts=[],allEmployees=[],myRemovals=[],allRemovalIds=[],vaultContacts=[];
var activeFilter='all',activeLetter='',showVault=false;

var TYPES=[
  {key:'all',label:'All Contacts'},
  {key:'MC',label:'Motorcycle Clubs'},
  {key:'RC',label:'Riding Clubs'},
  {key:'HOG',label:'HOG Chapters'},
  {key:'SC',label:'Social Clubs'},
  {key:'Shop',label:'Shops'},
  {key:'Independent',label:'Independents'},
  {key:'Other',label:'Other'}
];

/* ===== THEME ===== */
var THEME_NAMES={'dark-blue':'Dark Blue','blue-light':'Blue Light','slate-dark':'Slate Dark','slate-light':'Slate Light','ocean-dark':'Ocean Dark','ocean-light':'Ocean Light','midnight-dark':'Midnight','lavender-light':'Lavender','forest-dark':'Forest','mint-light':'Mint','crimson-dark':'Crimson','coral-light':'Coral','amber-dark':'Amber','honey-light':'Honey','rose-dark':'Rose','sky-light':'Sky','cyber-dark':'Cyber','sand-light':'Sand'};
var userThemeBank=['dark-blue'],themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';if(!userThemeBank.includes(t))t='dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=userThemeBank.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){if(userThemeBank.length<=1){showToast('Unlock more themes in Settings!');return;}themeIndex=(themeIndex+1)%userThemeBank.length;var t=userThemeBank[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showToast(THEME_NAMES[t]||t);}
function showToast(m){var t=document.getElementById('themeToast');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
async function loadUserThemeBank(){if(!currentUserId)return;try{var r=await sb.from('user_theme_bank').select('theme_key').eq('user_id',currentUserId);if(r.data&&r.data.length>0){userThemeBank=['dark-blue'].concat(r.data.map(function(t){return t.theme_key;}));userThemeBank=[...new Set(userThemeBank)];}loadTheme();}catch(e){}}
loadTheme();
async function logout(){await sb.auth.signOut();localStorage.clear();location.replace('login.html');}

function empName(id){if(!id)return'Unassigned';var e=allEmployees.find(function(x){return x.employee_id===id;});return e?((e.first_name||'')+' '+(e.last_name||'')).trim()||e.email:'Unknown';}
function empColor(id){if(!id)return'#eab308';var e=allEmployees.find(function(x){return x.employee_id===id;});return(e&&e.color)||'#eab308';}

function isAdmin(){return['owner','admin'].includes((currentUserRole||'').toLowerCase());}
function isManager(){return(currentUserRole||'').toLowerCase()==='manager';}
function isStaff(){return!isAdmin()&&!isManager();}

/* ===== KPIs ===== */
function renderKpis(){
  var counts={};TYPES.forEach(function(t){if(t.key!=='all')counts[t.key]=0;});
  var source=showVault?vaultContacts:allContacts;
  var removedIds=isAdmin()?allRemovalIds:myRemovals.map(function(r){return r.customer_id;});
  var total=0;
  source.forEach(function(c){
    if(!showVault&&removedIds.includes(c.customer_id))return;
    total++;var t=c.customer_type||'';if(counts[t]!==undefined)counts[t]++;
  });
  var html='';
  TYPES.forEach(function(t){
    var n=t.key==='all'?total:(counts[t.key]||0);
    html+='<div class="kpi'+(activeFilter===t.key?' active':'')+'" onclick="setFilter(\''+t.key+'\')"><div class="kpi-val">'+n+'</div><div class="kpi-lbl">'+t.label+'</div></div>';
  });
  document.getElementById('kpiBar').innerHTML=html;
}

/* ===== FILTERS ===== */
function setFilter(k){activeFilter=k;activeLetter='';renderKpis();renderAlpha();renderList();}

function renderAlpha(){
  var html='<div class="alpha-btn'+(activeLetter===''?' on':'')+'" onclick="setLetter(\'\')">ALL</div>';
  'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(function(l){
    html+='<div class="alpha-btn'+(activeLetter===l?' on':'')+'" onclick="setLetter(\''+l+'\')">'+l+'</div>';
  });
  document.getElementById('alphaStrip').innerHTML=html;
}
function setLetter(l){activeLetter=l;renderAlpha();renderList();}

function populateTeamSelect(){
  var sel=document.getElementById('teamSel');
  var html='<option value="">All Team Members</option>';
  allEmployees.forEach(function(e){var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||e.email;html+='<option value="'+e.employee_id+'">'+n+'</option>';});
  html+='<option value="__none">Unassigned</option>';
  sel.innerHTML=html;
}

/* ===== LIST ===== */
function getFiltered(){
  var q=(document.getElementById('searchBox').value||'').trim().toLowerCase();
  var teamId=document.getElementById('teamSel').value;
  var source=showVault?vaultContacts:allContacts;
  var removedIds=isAdmin()?allRemovalIds:myRemovals.map(function(r){return r.customer_id;});
  var list=source.filter(function(c){
    // If not vault view, hide contacts that have been removed
    if(!showVault&&removedIds.includes(c.customer_id))return false;
    if(activeFilter!=='all'&&(c.customer_type||'')!==activeFilter)return false;
    if(activeLetter){var fn=(c.first_name||'').charAt(0).toUpperCase();if(fn!==activeLetter)return false;}
    if(teamId==='__none'){if(c.assigned_to)return false;}
    else if(teamId&&c.assigned_to!==teamId)return false;
    if(!q)return true;
    var n=((c.first_name||'')+' '+(c.last_name||'')+' '+(c.full_name||'')).toLowerCase();
    return n.includes(q)||(c.phone||'').includes(q)||(c.organization_name||'').toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q);
  });
  list.sort(function(a,b){return((a.first_name||'')+(a.last_name||'')).toLowerCase().localeCompare(((b.first_name||'')+(b.last_name||'')).toLowerCase());});
  return list;
}
function renderList(){
  var list=getFiltered();
  var label=showVault?'vault contact':'contact';
  document.getElementById('rCount').textContent=list.length+' '+label+(list.length!==1?'s':'');
  if(!list.length){document.getElementById('grid').innerHTML='<div class="cc-empty">'+(showVault?'Vault is empty':'No contacts found')+'</div>';return;}
  document.getElementById('grid').innerHTML=list.map(function(c){
    var name=((c.first_name||'')+' '+(c.last_name||'')).trim()||c.full_name||'Unknown';
    var ini=name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,2);
    var ec=empColor(c.assigned_to);
    var vaultStyle=showVault?' style="border-left:3px solid #ef4444;"':'';
    return '<div class="cc"'+vaultStyle+' onclick="openDet(\''+c.customer_id+'\')"><div class="cc-av" style="border-color:'+ec+'">'+ini+'</div><div class="cc-body"><div class="cc-name">'+name+'</div>'+(c.organization_name?'<div class="cc-org">'+c.organization_name+'</div>':'')+'<div class="cc-meta">'+(c.phone?'<a href="tel:'+c.phone+'" onclick="event.stopPropagation()">'+c.phone+'</a>':'')+(c.email?'<a href="mailto:'+c.email+'" onclick="event.stopPropagation()">'+c.email+'</a>':'')+'</div></div><div class="cc-badge">'+(c.customer_type||'‚Äî')+'</div></div>';
  }).join('');
}

/* ===== AUTOCOMPLETE ===== */
var acI=-1;
function onSearch(){renderList();
  var q=(document.getElementById('searchBox').value||'').trim().toLowerCase();
  var dd=document.getElementById('acDd');
  if(q.length<1){dd.classList.remove('open');acI=-1;return;}
  var m=getFiltered().slice(0,8);
  if(!m.length){dd.classList.remove('open');acI=-1;return;}
  var esc=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  dd.innerHTML=m.map(function(c,i){
    var name=((c.first_name||'')+' '+(c.last_name||'')).trim()||'Unknown';
    var hl=name.replace(new RegExp('('+esc+')','ig'),'<mark>$1</mark>');
    return '<div class="ac-row'+(i===acI?' hl':'')+'" onmousedown="acPick(\''+c.customer_id+'\')"><span class="ac-name">'+hl+'</span><span class="ac-sub">'+(c.organization_name||'')+(c.phone?' ¬∑ '+c.phone:'')+'</span></div>';
  }).join('');
  dd.classList.add('open');acI=-1;
}
function onSearchKey(e){var dd=document.getElementById('acDd'),items=dd.querySelectorAll('.ac-row');if(!items.length)return;if(e.key==='ArrowDown'){e.preventDefault();acI=Math.min(acI+1,items.length-1);}else if(e.key==='ArrowUp'){e.preventDefault();acI=Math.max(acI-1,0);}else if(e.key==='Enter'&&acI>=0){e.preventDefault();items[acI].onmousedown();}else if(e.key==='Escape'){dd.classList.remove('open');acI=-1;return;}items.forEach(function(el,i){el.classList.toggle('hl',i===acI);});}
function acPick(id){document.getElementById('acDd').classList.remove('open');acI=-1;openDet(id);}
document.addEventListener('click',function(e){if(!e.target.closest('.search-wrap'))document.getElementById('acDd').classList.remove('open');});

/* ===== DETAIL MODAL ===== */
var curEdit=null;
function openDet(id){
  var c=allContacts.find(function(x){return x.customer_id===id;});if(!c)return;curEdit=c;
  var name=((c.first_name||'')+' '+(c.last_name||'')).trim()||c.full_name||'Unknown';
  var ini=name.split(' ').map(function(w){return w[0]||'';}).join('').toUpperCase().slice(0,2);
  var ec=empColor(c.assigned_to);
  var isAdm=isAdmin();
  var del='';
  if(showVault&&isAdm){
    del='<button class="btn-p" style="width:100%;padding:12px;background:#22c55e;" onclick="restoreFromVault(\''+c.customer_id+'\')">Restore from Vault</button><button class="btn-d" onclick="delContact(\''+c.customer_id+'\')">Permanently Delete</button>';
  } else if(isAdm){
    del='<button class="btn-d" style="background:#f59e0b;" onclick="delContact(\''+c.customer_id+'\')">Move to Vault</button>';
  } else {
    del='<button class="btn-d" style="background:#f59e0b;" onclick="delContact(\''+c.customer_id+'\')">Remove from My Contacts</button>';
  }
  var ctO='<option value="">-- Select --</option>';['RC','HOG','MC','SC','Shop','Independent','Other','prospect'].forEach(function(v){ctO+='<option value="'+v+'"'+(c.customer_type===v?' selected':'')+'>'+v+'</option>';});
  document.getElementById('detBody').innerHTML=
    '<div class="det-head"><div class="det-av" style="border-color:'+ec+'">'+ini+'</div><div class="det-name">'+name+'</div>'+(c.organization_name?'<div class="det-company">'+c.organization_name+'</div>':'')+'<div class="det-actions">'+(c.phone?'<a href="tel:'+c.phone+'" class="det-btn">Call</a><a href="sms:'+c.phone+'" class="det-btn">Text</a>':'')+(c.email?'<a href="mailto:'+c.email+'" class="det-btn">Email</a>':'')+'</div></div>'+
    '<div class="sec"><div class="sec-title">Basic Info</div><div class="fr" style="margin-bottom:12px"><div class="fg" style="margin-bottom:0"><label class="fl">First Name <span class="req">*</span></label><input type="text" class="fi" id="eF" value="'+(c.first_name||'')+'"></div><div class="fg" style="margin-bottom:0"><label class="fl">Last Name</label><input type="text" class="fi" id="eL" value="'+(c.last_name||'')+'"></div></div><div class="fg"><label class="fl">Organization <span class="req">*</span></label><input type="text" class="fi" id="eO" value="'+(c.organization_name||'')+'"></div></div>'+
    '<div class="sec"><div class="sec-title">Contact Info</div><div class="fg"><label class="fl">Phone <span class="req">*</span></label><input type="tel" class="fi" id="eP" value="'+(c.phone||'')+'"></div><div class="fg"><label class="fl">Email</label><input type="email" class="fi" id="eE" value="'+(c.email||'')+'"></div></div>'+
    '<div class="sec"><div class="sec-title">Classification</div><div class="fr" style="margin-bottom:12px"><div class="fg" style="margin-bottom:0"><label class="fl">Client Type</label><select class="fsel" id="eT">'+ctO+'</select></div><div class="fg" style="margin-bottom:0"><label class="fl">Assigned To</label><select class="fsel" id="eA">'+buildAssignOpts(c.assigned_to)+'</select></div></div></div>'+
    '<div class="sec"><div class="sec-title">Important Dates</div><div class="fr"><div class="fg" style="margin-bottom:0"><label class="fl">Birthday</label><input type="date" class="fi" id="eBd" value="'+(c.birthday?c.birthday.split('T')[0]:'')+'"></div><div class="fg" style="margin-bottom:0"><label class="fl">Anniversary</label><input type="date" class="fi" id="eAn" value="'+(c.anniversary?c.anniversary.split('T')[0]:'')+'"></div></div></div>'+
    '<div class="sec"><div class="sec-title">Notes</div><textarea class="fta" id="eN">'+(c.notes||'')+'</textarea></div>'+
    '<div class="sec" style="padding-top:16px;border-top:1px solid var(--border-default);display:flex;flex-direction:column;gap:12px;"><button class="btn-p" style="width:100%;padding:12px" onclick="saveDet()">Save Changes</button><a href="sharklaw-profiles.html?id='+c.customer_id+'" class="btn-s" style="width:100%;padding:12px;text-align:center;text-decoration:none;display:block">View Full Profile</a>'+del+'</div>';
  document.getElementById('detailModal').classList.add('active');
}
function closeDet(){document.getElementById('detailModal').classList.remove('active');}
function buildAssignOpts(sel){var h='<option value="">-- Unassigned --</option>';allEmployees.forEach(function(e){var n=((e.first_name||'')+' '+(e.last_name||'')).trim()||e.email;h+='<option value="'+e.employee_id+'"'+(e.employee_id===sel?' selected':'')+'>'+n+'</option>';});return h;}

async function saveDet(){
  if(!curEdit)return;
  var fn=document.getElementById('eF').value.trim(),org=document.getElementById('eO').value.trim(),ph=document.getElementById('eP').value.trim();
  if(!fn||!org||!ph){alert('First name, organization, and phone are required.');return;}
  var u={first_name:fn,last_name:document.getElementById('eL').value.trim()||null,organization_name:org,phone:ph,email:document.getElementById('eE').value.trim()||null,customer_type:document.getElementById('eT').value||null,assigned_to:document.getElementById('eA').value||null,birthday:document.getElementById('eBd').value||null,anniversary:document.getElementById('eAn').value||null,notes:document.getElementById('eN').value.trim()||null,updated_at:new Date().toISOString()};
  u.full_name=(u.first_name+(u.last_name?' '+u.last_name:'')).trim();
  try{var r=await sb.from('customers').update(u).eq('customer_id',curEdit.customer_id).select().single();if(r.error)throw r.error;var i=allContacts.findIndex(function(c){return c.customer_id===curEdit.customer_id;});if(i>=0)Object.assign(allContacts[i],u);closeDet();renderAll();showToast('Saved!');}catch(e){alert('Error: '+e.message);}
}
async function delContact(id){
  if(showVault&&isAdmin()){
    // Permanent delete ‚Äî only from vault view by admin
    if(!confirm('Permanently delete this contact? This cannot be undone.'))return;
    try{
      await sb.from('contact_removals').delete().eq('customer_id',id).eq('tenant_id',currentTenantId);
      await sb.from('customers').update({is_deleted:true}).eq('customer_id',id);
      allContacts=allContacts.filter(function(c){return c.customer_id!==id;});
      vaultContacts=vaultContacts.filter(function(c){return c.customer_id!==id;});
      allRemovalIds=allRemovalIds.filter(function(rid){return rid!==id;});
      myRemovals=myRemovals.filter(function(r){return r.customer_id!==id;});
      updateVaultBadge();closeDet();renderAll();showToast('Permanently deleted');
    }catch(e){alert('Error: '+e.message);}
  } else {
    // All roles: soft remove to vault
    var msg=isAdmin()?'Move this contact to the vault?':'Remove this contact from your view?';
    if(!confirm(msg))return;
    try{
      await sb.from('contact_removals').upsert({tenant_id:currentTenantId,customer_id:id,removed_by:currentEmployeeId||currentUserId},{onConflict:'customer_id,removed_by'});
      myRemovals.push({customer_id:id,removed_by:currentEmployeeId||currentUserId});
      if(!allRemovalIds.includes(id))allRemovalIds.push(id);
      // Add to vault list if admin
      if(isAdmin()){
        var c=allContacts.find(function(x){return x.customer_id===id;});
        if(c&&!vaultContacts.find(function(v){return v.customer_id===id;}))vaultContacts.push(c);
      }
      updateVaultBadge();closeDet();renderAll();showToast('Moved to vault');
    }catch(e){alert('Error: '+e.message);}
  }
}

async function restoreFromVault(id){
  if(!isAdmin())return;
  try{
    // Remove ALL removal records for this contact
    await sb.from('contact_removals').delete().eq('customer_id',id).eq('tenant_id',currentTenantId);
    vaultContacts=vaultContacts.filter(function(c){return c.customer_id!==id;});
    allRemovalIds=allRemovalIds.filter(function(rid){return rid!==id;});
    myRemovals=myRemovals.filter(function(r){return r.customer_id!==id;});
    // Make sure it's in allContacts
    var exists=allContacts.find(function(c){return c.customer_id===id;});
    if(!exists){var r=await sb.from('customers').select('*').eq('customer_id',id).single();if(r.data)allContacts.push(r.data);}
    updateVaultBadge();
    closeDet();renderAll();showToast('Restored from vault');
  }catch(e){alert('Error: '+e.message);}
}

function toggleVault(){
  showVault=!showVault;
  document.getElementById('vaultBtn').classList.toggle('on',showVault);
  renderAll();
}
function updateVaultBadge(){
  var btn=document.getElementById('vaultBtn');
  if(!isAdmin()){btn.style.display='none';return;}
  btn.style.display='inline-flex';
  var n=vaultContacts.length;
  btn.innerHTML='üîí Vault'+(n>0?'<span class="vault-badge">'+n+'</span>':'');
}
function renderAll(){renderKpis();renderList();}

/* ===== ADD MODAL ===== */
function openAdd(){['nF','nL','nO','nP','nE','nN'].forEach(function(id){document.getElementById(id).value='';});document.getElementById('nT').value='';document.getElementById('nA').innerHTML=buildAssignOpts(null);document.getElementById('addModal').classList.add('active');}
function closeAdd(){document.getElementById('addModal').classList.remove('active');}
async function saveAdd(){
  var fn=document.getElementById('nF').value.trim(),org=document.getElementById('nO').value.trim(),ph=document.getElementById('nP').value.trim();
  if(!fn||!org||!ph){alert('First name, organization, and phone are required.');return;}
  var d={tenant_id:currentTenantId,first_name:fn,last_name:document.getElementById('nL').value.trim()||null,full_name:fn,phone:ph,email:document.getElementById('nE').value.trim()||null,organization_name:org,customer_type:document.getElementById('nT').value||'prospect',funnel_stage:1,notes:document.getElementById('nN').value.trim()||null,assigned_to:document.getElementById('nA').value||null,created_at:new Date().toISOString()};
  if(d.last_name)d.full_name=fn+' '+d.last_name;
  try{var r=await sb.from('customers').insert(d).select().single();if(r.error)throw r.error;allContacts.unshift(r.data);closeAdd();renderAll();showToast('Contact added!');}catch(e){alert('Error: '+e.message);}
}

/* ===== AUTH & INIT ===== */
async function checkAuth(){var r=await sb.auth.getSession(),s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){location.href='login.html';return null;}}currentUserId=s.user.id;userEmail=s.user.email;return s;}
async function init(){
  var s=await checkAuth();if(!s)return;
  var email=s.user?.email;
  if(email){var r=await sb.from('users').select('*').eq('email',email).single();if(r.data?.tenant_id){currentTenantId=r.data.tenant_id;currentUserId=r.data.user_id;currentUserRole=r.data.role||null;}}
  if(!currentTenantId){var r2=await sb.from('business_settings').select('tenant_id').limit(1).single();if(r2.data?.tenant_id)currentTenantId=r2.data.tenant_id;}
  if(!currentTenantId)return;
  if(!currentUserRole&&email){var e=await sb.from('employees').select('role').eq('email',email).single();if(e.data?.role)currentUserRole=e.data.role;}
  if(userEmail){document.getElementById('dBiz').textContent=userEmail;document.getElementById('mBiz').textContent=userEmail;}
  await loadUserThemeBank();
  var er=await sb.from('employees').select('employee_id,first_name,last_name,email,color,role').eq('tenant_id',currentTenantId).or('is_active.is.null,is_active.eq.true').order('last_name');allEmployees=er.data||[];
  // Resolve currentEmployeeId
  if(email){var me=allEmployees.find(function(e){return e.email===email;});if(me)currentEmployeeId=me.employee_id;}

  // Load ALL non-deleted contacts for tenant
  var cr=await sb.from('customers').select('*').eq('tenant_id',currentTenantId).or('is_deleted.is.null,is_deleted.eq.false').order('first_name');
  var allTenantContacts=cr.data||[];

  // Load removals
  var rr=await sb.from('contact_removals').select('customer_id,removed_by').eq('tenant_id',currentTenantId);
  var allRemovals=rr.data||[];
  myRemovals=allRemovals.filter(function(r){return r.removed_by===currentEmployeeId||r.removed_by===currentUserId;});
  allRemovalIds=[...new Set(allRemovals.map(function(r){return r.customer_id;}))];
  var removedIdSet=new Set(allRemovalIds);

  // Role-based filtering
  if(isAdmin()){
    // Owner/Admin: see all contacts, vault = removed ones
    allContacts=allTenantContacts;
    vaultContacts=allTenantContacts.filter(function(c){return removedIdSet.has(c.customer_id);});
  } else if(isManager()){
    // Manager: see own + staff/associate contacts (not removed by self)
    var staffIds=allEmployees.filter(function(e){return['staff','associate'].includes((e.role||'').toLowerCase());}).map(function(e){return e.employee_id;});
    allContacts=allTenantContacts.filter(function(c){return!c.assigned_to||c.assigned_to===currentEmployeeId||staffIds.includes(c.assigned_to);});
  } else {
    // Staff/Associate: see only own assigned contacts
    allContacts=allTenantContacts.filter(function(c){return c.assigned_to===currentEmployeeId;});
  }

  updateVaultBadge();
  renderKpis();renderAlpha();populateTeamSelect();renderList();
}
init();
</script>
</body>
</html>
