<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Contacts</title>
  <script>
    (function() {
      var theme = localStorage.getItem('app-theme') || 'dark-blue';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="themes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="employee-utils.js"></script>
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
      --funnel-1: #3b82f6; --funnel-2: #06b6d4; --funnel-3: #8b5cf6; --funnel-4: #f59e0b; --funnel-5: #10b981; --funnel-6: #ef4444;
    }
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="blue-light"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }
    [data-theme="slate-dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="slate-light"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; }
    [data-theme="ocean-dark"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="ocean-light"] { --bg-primary: #f0fdfa; --bg-secondary: #e0f7f4; --bg-card: #ffffff; --bg-hover: #ccfbf1; --border-default: #99f6e4; --text-primary: #134e4a; --text-secondary: #2d6a66; --accent-primary: #0d9488; --accent-light: #14b8a6; }
    [data-theme="midnight-dark"],[data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="lavender-light"],[data-theme="lavender"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; }
    [data-theme="forest-dark"],[data-theme="forest"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="mint-light"],[data-theme="mint"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="crimson-dark"],[data-theme="crimson"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; }
    [data-theme="coral-light"],[data-theme="coral"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; }
    [data-theme="amber-dark"],[data-theme="amber"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; }
    [data-theme="honey-light"],[data-theme="honey"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; }
    [data-theme="rose-dark"],[data-theme="rose"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; }
    [data-theme="sky-light"],[data-theme="sky"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="cyber-dark"],[data-theme="cyber"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; }
    [data-theme="sand-light"],[data-theme="sand"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; }
    [data-theme="slate"],[data-theme="ocean"],[data-theme="light-blue"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; scroll-behavior: auto; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    .theme-toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 1000; display: none; }
    .theme-toast.show { display: block; }
    
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    .mobile-menu-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-menu-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px 12px 12px; }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); border-radius: 8px; cursor: pointer; }
    
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }

    .toolbar { padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .toolbar-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; }
    .search-box:focus { outline: none; border-color: var(--accent-primary); }
    .add-btn { padding: 10px 16px; border-radius: 8px; border: none; background: var(--accent-primary); color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .add-btn:hover { background: var(--accent-light); }

    .quick-stats { display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); overflow-x: auto; }
    .stat-card { flex: 1; min-width: 100px; padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-default); text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--text-primary); }
    .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }

    /* Mobile KPI grid: 4 across, 2 rows */
    @media (max-width: 768px) {
      .quick-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 8px; overflow: visible; }
      .stat-card { min-width: 0; padding: 6px 4px; border-radius: 6px; }
      .stat-value { font-size: 18px; }
      .stat-label { font-size: 9px; letter-spacing: 0.2px; margin-top: 2px; }
    }

    .funnel-container { display: flex; gap: 12px; padding: 12px; overflow-x: auto; min-height: calc(100vh - 380px); scroll-behavior: auto; -webkit-overflow-scrolling: touch; }
    .funnel-column { flex: 1; min-width: 260px; max-width: 300px; background: var(--bg-secondary); border-radius: 12px; display: flex; flex-direction: column; }
    .funnel-header { padding: 12px 16px; border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .funnel-header:hover { background: var(--bg-hover); border-radius: 12px 12px 0 0; }
    .funnel-title { font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
    .funnel-dot { width: 10px; height: 10px; border-radius: 50%; }
    .funnel-header-controls { display: flex; align-items: center; gap: 8px; }
    .funnel-count { font-size: 13px; color: var(--text-secondary); background: var(--bg-hover); padding: 4px 10px; border-radius: 10px; min-width: 28px; text-align: center; font-weight: 500; }
    .funnel-expand-btn { display: none; }
    .funnel-title-text { cursor: text; }
    .funnel-rename-input { background: var(--bg-card); border: 1px solid var(--accent-primary); border-radius: 4px; color: var(--text-primary); font-size: 14px; font-weight: 600; padding: 2px 6px; width: 120px; outline: none; }
    .funnel-edit-btn, .funnel-delete-btn { width: 26px; height: 26px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; opacity: 0; transition: opacity .2s, background .15s; }
    .funnel-header:hover .funnel-edit-btn, .funnel-header:hover .funnel-delete-btn { opacity: 1; }
    .funnel-edit-btn:hover { background: var(--bg-hover); color: var(--accent-light); }
    .funnel-delete-btn:hover { background: color-mix(in srgb, #ef4444 15%, var(--bg-card)); color: #ef4444; border-color: #ef4444; }
    @media (max-width: 768px) { .funnel-edit-btn, .funnel-delete-btn { opacity: 1; width: 28px; height: 28px; } .funnel-column.collapsed .funnel-edit-btn, .funnel-column.collapsed .funnel-delete-btn { display: none; } }
    .funnel-arrow { font-size: 22px; color: var(--text-secondary); transition: transform 0.3s; padding: 4px; }
    .funnel-column.collapsed .funnel-arrow { transform: rotate(-90deg); }
    .funnel-column.collapsed .funnel-cards { display: none; }
    .funnel-column.collapsed .funnel-header { border-bottom: none; border-radius: 12px; }
    .funnel-cards { flex: 1; padding: 8px; overflow-y: auto; min-height: 50px; transition: all 0.3s; }
    .funnel-cards.drag-over { background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border-radius: 8px; }

    /* ===== CONTACT CARDS — 3-STATE SYSTEM (mobile) ===== */
    .contact-card { background: var(--bg-card); border-radius: 10px; padding: 12px; margin-bottom: 8px; cursor: grab; border: 1px solid var(--border-default); border-left: 4px solid #eab308; transition: all 0.2s; }
    .contact-card:hover { border-color: var(--accent-primary); border-left-color: inherit; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .contact-card.dragging { opacity: 0.5; cursor: grabbing; }
    .contact-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .contact-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .contact-company { font-size: 12px; color: var(--text-secondary); }
    .contact-info { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
    .contact-info-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .contact-info-item a { color: var(--accent-light); text-decoration: none; }
    .contact-assigned { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary); margin-bottom: 8px; padding: 4px 0; }
    .contact-assigned-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    
    .progress-dots { display: flex; gap: 6px; align-items: center; padding-top: 8px; border-top: 1px solid var(--border-default); }
    .progress-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--border-default); background: transparent; transition: all 0.3s; }
    .progress-dot.completed { border-color: currentColor; background: currentColor; }
    .progress-dot.current { border-color: currentColor; box-shadow: 0 0 0 3px color-mix(in srgb, currentColor 30%, transparent); animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 3px color-mix(in srgb, currentColor 30%, transparent); }
      50% { box-shadow: 0 0 0 6px color-mix(in srgb, currentColor 10%, transparent); }
    }
    /* progress-dot and stage-option colors set inline via JS */
    .progress-label { font-size: 10px; color: var(--text-secondary); margin-left: auto; }

    /* Mobile: 3-state card */
    @media (max-width: 768px) {
      .funnel-container { flex-direction: column; min-height: auto; padding: 8px; gap: 0; }
      .funnel-column { max-width: none; min-width: auto; border-radius: 8px; margin-bottom: 8px; }
      .funnel-column.collapsed { margin-bottom: 8px; }
      .funnel-column.collapsed .funnel-header { border-radius: 8px; }
      .funnel-header { padding: 14px 16px; border-radius: 8px 8px 0 0; }
      .contact-card { cursor: pointer; padding: 10px 12px; margin-bottom: 6px; }
      .contact-card:hover { transform: none; box-shadow: none; }
      /* STATE 1: Mini — 2 lines */
      .contact-card.card-mini { padding: 8px 12px; }
      .contact-card.card-mini .contact-card-header { margin-bottom: 0; }
      .contact-card.card-mini .contact-assigned,
      .contact-card.card-mini .contact-info,
      .contact-card.card-mini .progress-dots { display: none; }
      .contact-card.card-mini .card-mini-row { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
      .contact-card.card-mini .card-mini-stage { font-size: 10px; color: var(--text-secondary); padding: 2px 6px; border-radius: 4px; background: var(--bg-hover); }
      .contact-card.card-mini .card-mini-emp { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-secondary); }
      .contact-card.card-mini .card-mini-emp-dot { width: 6px; height: 6px; border-radius: 50%; }
      /* STATE 2: Expanded — 4 lines */
      .contact-card.card-expanded { border-color: var(--accent-primary); background: color-mix(in srgb, var(--accent-primary) 5%, var(--bg-card)); }
      .contact-card.card-expanded .card-mini-row { display: none; }
      /* Default: hide mini row on desktop / non-mini */
      .card-mini-row { display: none; }
    }
    @media (min-width: 769px) {
      .card-mini-row { display: none !important; }
    }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-default); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-default); }
    .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
    .form-label .required { color: #ef4444; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border-default); }
    .btn-secondary { padding: 10px 20px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; cursor: pointer; }
    .btn-primary { padding: 10px 20px; border-radius: 6px; border: none; background: var(--accent-primary); color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-danger { padding: 10px 20px; border-radius: 6px; border: none; background: #dc2626; color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; width: 100%; }
    .btn-danger:hover { background: #ef4444; }

    .contact-detail-header { text-align: center; padding-bottom: 16px; border-bottom: 1px solid var(--border-default); margin-bottom: 16px; }
    .contact-detail-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--bg-hover); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 600; color: var(--accent-light); margin: 0 auto 12px; border: 3px solid var(--border-default); }
    .contact-detail-name { font-size: 20px; font-weight: 600; }
    .contact-detail-company { font-size: 14px; color: var(--text-secondary); }
    .contact-actions { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
    .contact-action-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; text-decoration: none; }
    .contact-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .contact-section { margin-bottom: 16px; }
    .contact-section-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
    .stage-selector { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .stage-option { padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 8px; }
    .stage-option::before { content: ''; width: 10px; height: 10px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .stage-option:hover { background: var(--bg-hover); }
    .stage-option.active { border-color: currentColor; background: color-mix(in srgb, currentColor 20%, transparent); }
    /* stage-option colors set inline via JS */

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.action-btn { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 50%, transparent); color: var(--accent-light); font-size: 14px; }

    .import-section { background: var(--bg-card); border: 2px dashed var(--border-default); border-radius: 12px; padding: 20px; margin: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .import-section:hover { border-color: var(--accent-primary); background: var(--bg-hover); }
    .import-text { font-size: 13px; color: var(--text-secondary); }
    .import-text strong { color: var(--accent-light); }

    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      body { padding-bottom: 120px; }
      .form-row { grid-template-columns: 1fr; }
      .modal-overlay { align-items: flex-end; padding: 0; }
      .modal-content { border-radius: 20px 20px 0 0; max-height: 92vh; }
    }
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Contacts</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
    </div>
  </div>
  <div class="mobile-menu-content" id="mobileMenuContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='sharklaw-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
      <button onclick="location.href='account.html'">Account</button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 style="margin:0;font-size:32px;font-weight:600;">Contacts</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <div style="display:flex;align-items:center;gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex;gap:24px;align-items:center;">
      <a href="dashboard-sharklaw.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">Contacts</a>
      <a href="sharklaw-swag.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Swag</a>
      <a href="sharklaw-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a>
    </nav>
  </div>
</div>

<div class="quick-stats" id="quickStatsContainer">
  <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
</div>

<div class="toolbar">
  <div class="toolbar-row">
    <input type="text" class="search-box" id="searchBox" placeholder="Search by name, phone, or organization..." oninput="filterContacts()">
    <button class="add-btn" id="addFunnelBtn" onclick="addNewFunnel()" style="display:none;">+ Add Funnel</button>
  </div>
</div>

<div class="funnel-container" id="funnelContainer"></div>

<div class="import-section" onclick="document.getElementById('csvInput').click()">
  <div class="import-text"><strong>Drop a CSV file here</strong> or click to import contacts</div>
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(event)">
</div>

<!-- New Contact Modal -->
<div class="modal-overlay" id="newContactModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Contact</div><button class="modal-close" onclick="closeNewContactModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="contactFirstName" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name</label><input type="text" class="form-input" id="contactLastName" placeholder="Last name"></div>
      </div>
      <div class="form-group"><label class="form-label">Organization <span class="required">*</span></label><input type="text" class="form-input" id="contactOrganization" placeholder="Organization name"></div>
      <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="contactPhone" placeholder="(555) 123-4567"></div>
      <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="contactEmail" placeholder="email@example.com"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Client Type</label><select class="form-select" id="contactClientType"><option value="">-- Select --</option><option value="RC">RC</option><option value="HOG">HOG</option><option value="MC">MC</option><option value="SC">SC</option><option value="Shop">Shop</option><option value="Independent">Independent</option><option value="Other">Other</option></select></div>
        <div class="form-group"><label class="form-label">Funnel Stage</label><select class="form-select" id="contactStage"></select></div>
      </div>
      <div class="form-group"><label class="form-label">Assign To</label><select class="form-select" id="contactAssignTo"><option value="">-- Unassigned --</option></select></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Birthday</label><input type="date" class="form-input" id="contactBirthday"></div>
        <div class="form-group"><label class="form-label">Anniversary</label><input type="date" class="form-input" id="contactAnniversary"></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="contactNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeNewContactModal()">Cancel</button><button class="btn-primary" onclick="saveNewContact()">Add Contact</button></div>
  </div>
</div>

<!-- Contact Detail Modal -->
<div class="modal-overlay" id="contactDetailModal">
  <div class="modal-content" style="max-width:550px;">
    <div class="modal-header"><div class="modal-title">Contact Details</div><button class="modal-close" onclick="closeContactDetailModal()">&times;</button></div>
    <div class="modal-body" id="contactDetailBody"></div>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-row"><a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a><a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a></div>
  <div class="mobile-nav-row three-col"><button class="mobile-nav-btn action-btn" onclick="openNewContactModal()">+ Contact</button><a href="sharklaw-contacts.html" class="mobile-nav-btn active">Contacts</a><a href="sharklaw-swag.html" class="mobile-nav-btn">Swag</a></div>
</div>

<div class="theme-toast" id="themeToast"></div>

<script>
const SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let currentUserId=null,currentTenantId=null,userEmail=null,currentUserRole=null;
let allContacts=[],allEmployees=[],draggedCard=null;
let scrollAnimationId=null,currentScrollSpeed={x:0,y:0};
const SCROLL_ZONE=100,MAX_SCROLL_SPEED=12,UNASSIGNED_COLOR='#eab308';
var isMobile=window.innerWidth<=768;
window.addEventListener('resize',function(){isMobile=window.innerWidth<=768;});

function handleDragScroll(e){var mouseY=e.clientY,mouseX=e.clientX,windowHeight=window.innerHeight,fc=document.getElementById('funnelContainer');currentScrollSpeed.y=0;currentScrollSpeed.x=0;if(mouseY<SCROLL_ZONE){currentScrollSpeed.y=-(SCROLL_ZONE-mouseY)/SCROLL_ZONE*MAX_SCROLL_SPEED;}else if(mouseY>windowHeight-SCROLL_ZONE-120){currentScrollSpeed.y=(mouseY-(windowHeight-SCROLL_ZONE-120))/SCROLL_ZONE*MAX_SCROLL_SPEED;}if(fc&&window.innerWidth>768){var rect=fc.getBoundingClientRect();if(mouseX>rect.left&&mouseX<rect.left+SCROLL_ZONE)currentScrollSpeed.x=-(SCROLL_ZONE-(mouseX-rect.left))/SCROLL_ZONE*MAX_SCROLL_SPEED;else if(mouseX<rect.right&&mouseX>rect.right-SCROLL_ZONE)currentScrollSpeed.x=(mouseX-(rect.right-SCROLL_ZONE))/SCROLL_ZONE*MAX_SCROLL_SPEED;}if((currentScrollSpeed.x||currentScrollSpeed.y)&&!scrollAnimationId)smoothScroll();}
function smoothScroll(){if(currentScrollSpeed.y)window.scrollBy(0,currentScrollSpeed.y);if(currentScrollSpeed.x){var fc=document.getElementById('funnelContainer');if(fc)fc.scrollBy(currentScrollSpeed.x,0);}if(currentScrollSpeed.x||currentScrollSpeed.y)scrollAnimationId=requestAnimationFrame(smoothScroll);else scrollAnimationId=null;}
function stopAutoScroll(){currentScrollSpeed.x=0;currentScrollSpeed.y=0;if(scrollAnimationId){cancelAnimationFrame(scrollAnimationId);scrollAnimationId=null;}}
document.addEventListener('dragover',handleDragScroll);
document.addEventListener('dragend',stopAutoScroll);
document.addEventListener('drop',stopAutoScroll);

const FUNNEL_COLORS=['#3b82f6','#06b6d4','#8b5cf6','#f59e0b','#10b981','#ef4444','#ec4899','#f97316','#14b8a6','#6366f1','#a855f7','#84cc16'];
const DEFAULT_STAGES={1:{name:'1st Contact',color:'#3b82f6'},2:{name:'Follow Up',color:'#06b6d4'},3:{name:'Swag Approved',color:'#8b5cf6'},4:{name:'Receive Artwork',color:'#f59e0b'},5:{name:'Deliver Pop Up',color:'#10b981'},6:{name:'Confirmed Partnership',color:'#ef4444'}};
var STAGES={};

async function loadStages(){
  if(!currentTenantId)return;
  var r=await sb.from('funnel_stages').select('*').eq('tenant_id',currentTenantId).or('is_deleted.is.null,is_deleted.eq.false').order('sort_order',{ascending:true});
  if(r.data&&r.data.length>0){
    STAGES={};
    r.data.forEach(function(row){STAGES[row.stage_id]={name:row.stage_name,color:row.stage_color};});
  } else {
    // First load — seed defaults into DB
    STAGES=JSON.parse(JSON.stringify(DEFAULT_STAGES));
    var inserts=Object.keys(DEFAULT_STAGES).map(function(id){
      return{tenant_id:currentTenantId,stage_id:parseInt(id),stage_name:DEFAULT_STAGES[id].name,stage_color:DEFAULT_STAGES[id].color,sort_order:parseInt(id)};
    });
    await sb.from('funnel_stages').insert(inserts);
  }
}
async function saveStageToDb(stageId,name,color,sortOrder){
  var r=await sb.from('funnel_stages').upsert({tenant_id:currentTenantId,stage_id:stageId,stage_name:name,stage_color:color,sort_order:sortOrder||stageId,updated_at:new Date().toISOString()},{onConflict:'tenant_id,stage_id'});
  if(r.error)console.error('Save stage error:',r.error);
}
async function deleteStageFromDb(stageId){
  await sb.from('funnel_stages').update({is_deleted:true,updated_at:new Date().toISOString()}).eq('tenant_id',currentTenantId).eq('stage_id',stageId);
}
function getStageIds(){return Object.keys(STAGES).map(Number).sort(function(a,b){return a-b;});}
function getStageName(id){return STAGES[id]?STAGES[id].name:'Stage '+id;}
function getStageColor(id){return STAGES[id]?STAGES[id].color:FUNNEL_COLORS[id%FUNNEL_COLORS.length];}

function isAdminOrOwner(){return['owner','admin'].includes((currentUserRole||'').toLowerCase());}

// ===== DYNAMIC FUNNEL RENDERING =====
function renderFunnelColumns(){
  var fc=document.getElementById('funnelContainer');
  fc.innerHTML='';
  var ids=getStageIds();
  var canEdit=isAdminOrOwner();
  ids.forEach(function(id){
    var s=STAGES[id];
    var col=document.createElement('div');
    col.className='funnel-column';
    col.dataset.stage=id;
    var dblClick=canEdit?' ondblclick="startRenameFunnel(event,'+id+')"':'';
    var editBtns=canEdit?'<button class="funnel-edit-btn" onclick="event.stopPropagation();startRenameFunnel(event,'+id+')" title="Rename">✎</button><button class="funnel-delete-btn" onclick="event.stopPropagation();deleteFunnel('+id+')" title="Delete">✕</button>':'';
    col.innerHTML='<div class="funnel-header" onclick="toggleColumn('+id+')"><div class="funnel-title"><span class="funnel-dot" style="background:'+s.color+'"></span><span class="funnel-title-text"'+dblClick+'>'+s.name+'</span></div><div class="funnel-header-controls">'+editBtns+'<span class="funnel-count" id="count'+id+'">0</span><span class="funnel-arrow">▼</span></div></div><div class="funnel-cards" id="stage'+id+'" ondragover="allowDrop(event)" ondrop="drop(event,'+id+')" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>';
    fc.appendChild(col);
  });
  collapseFunnelsOnMobile();
  // Show/hide add funnel button
  var addBtn=document.getElementById('addFunnelBtn');
  if(addBtn)addBtn.style.display=canEdit?'flex':'none';
}

function renderStats(){
  var container=document.getElementById('quickStatsContainer');
  var ids=getStageIds();
  var html='<div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>';
  ids.forEach(function(id){
    var label=STAGES[id].name;
    if(label.length>10)label=label.substring(0,9)+'…';
    html+='<div class="stat-card"><div class="stat-value" id="stat'+id+'">0</div><div class="stat-label">'+label+'</div></div>';
  });
  container.innerHTML=html;
}

// ===== ADD / DELETE / RENAME FUNNELS =====
async function addNewFunnel(){
  if(!isAdminOrOwner()){showToast('Only admins can add funnels');return;}
  var ids=getStageIds();
  var nextId=ids.length?Math.max.apply(null,ids)+1:1;
  var colorIdx=nextId%FUNNEL_COLORS.length;
  var name=prompt('Enter funnel stage name:');
  if(!name||!name.trim())return;
  name=name.trim();
  STAGES[nextId]={name:name,color:FUNNEL_COLORS[colorIdx]};
  await saveStageToDb(nextId,name,FUNNEL_COLORS[colorIdx],nextId);
  renderFunnelColumns();
  renderStats();
  renderContacts();
  updateStats();
  showToast('Funnel "'+name+'" added');
}

async function deleteFunnel(stageId){
  if(!isAdminOrOwner()){showToast('Only admins can delete funnels');return;}
  var ids=getStageIds();
  if(ids.length<=1){alert('You need at least one funnel stage.');return;}
  var name=getStageName(stageId);
  var contactsInStage=allContacts.filter(function(c){return(c.funnel_stage||1)===stageId;});
  var msg='Delete "'+name+'"?';
  if(contactsInStage.length>0){
    var firstStage=ids.find(function(id){return id!==stageId;});
    msg+='\n\n'+contactsInStage.length+' contact(s) will be moved to "'+getStageName(firstStage)+'".';
  }
  if(!confirm(msg))return;
  // Move contacts to first remaining stage
  if(contactsInStage.length>0){
    var targetStage=ids.find(function(id){return id!==stageId;});
    for(var i=0;i<contactsInStage.length;i++){
      contactsInStage[i].funnel_stage=targetStage;
      await sb.from('customers').update({funnel_stage:targetStage}).eq('customer_id',contactsInStage[i].customer_id);
    }
  }
  delete STAGES[stageId];
  await deleteStageFromDb(stageId);
  renderFunnelColumns();
  renderStats();
  renderContacts();
  updateStats();
  showToast('"'+name+'" deleted');
}

async function startRenameFunnel(e,stageId){
  e.stopPropagation();
  if(!isAdminOrOwner())return;
  var header=document.querySelector('.funnel-column[data-stage="'+stageId+'"] .funnel-title');
  var titleSpan=header.querySelector('.funnel-title-text');
  if(header.querySelector('.funnel-rename-input'))return;
  var current=STAGES[stageId].name;
  var input=document.createElement('input');
  input.type='text';
  input.className='funnel-rename-input';
  input.value=current;
  input.addEventListener('click',function(ev){ev.stopPropagation();});
  async function save(){
    var val=input.value.trim();
    if(val&&val!==current){
      STAGES[stageId].name=val;
      await saveStageToDb(stageId,val,STAGES[stageId].color,stageId);
      renderFunnelColumns();
      renderStats();
      updateStats();
      showToast('Renamed to "'+val+'"');
    } else {
      titleSpan.style.display='';
      if(input.parentNode)input.parentNode.removeChild(input);
    }
  }
  input.addEventListener('blur',save);
  input.addEventListener('keydown',function(ev){if(ev.key==='Enter')input.blur();if(ev.key==='Escape'){input.value=current;input.blur();}});
  titleSpan.style.display='none';
  titleSpan.parentNode.insertBefore(input,titleSpan.nextSibling);
  input.focus();
  input.select();
}

var THEME_NAMES={'dark-blue':'Dark Blue','blue-light':'Blue Light','slate-dark':'Slate Dark','slate-light':'Slate Light','ocean-dark':'Ocean Dark','ocean-light':'Ocean Light','midnight-dark':'Midnight','lavender-light':'Lavender','forest-dark':'Forest','mint-light':'Mint','crimson-dark':'Crimson','coral-light':'Coral','amber-dark':'Amber','honey-light':'Honey','rose-dark':'Rose','sky-light':'Sky','cyber-dark':'Cyber','sand-light':'Sand'};
var userThemeBank=['dark-blue'],themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';if(!userThemeBank.includes(t))t='dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=userThemeBank.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){if(userThemeBank.length<=1){showThemeToast('Unlock more themes in Settings!');return;}themeIndex=(themeIndex+1)%userThemeBank.length;var t=userThemeBank[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(THEME_NAMES[t]||t);}
function showThemeToast(msg){var toast=document.getElementById('themeToast');toast.textContent=msg;toast.classList.add('show');setTimeout(function(){toast.classList.remove('show');},2000);}
async function loadUserThemeBank(){if(!currentUserId)return;try{var r=await sb.from('user_theme_bank').select('theme_key').eq('user_id',currentUserId);if(r.data&&r.data.length>0){userThemeBank=['dark-blue'].concat(r.data.map(function(t){return t.theme_key;}));userThemeBank=[...new Set(userThemeBank)];}loadTheme();}catch(e){}}
loadTheme();

async function logout(){await sb.auth.signOut();localStorage.clear();location.replace("login.html");}
function toggleMobileMenu(){document.getElementById('mobileMenuContent').classList.toggle('expanded');}
function getContactEmployeeColor(assignedTo){if(!assignedTo)return UNASSIGNED_COLOR;var emp=allEmployees.find(function(e){return e.employee_id===assignedTo;});return(emp&&emp.color)||UNASSIGNED_COLOR;}
function getEmployeeNameById(empId){if(!empId)return'Unassigned';var emp=allEmployees.find(function(e){return e.employee_id===empId;});if(!emp)return'Unassigned';return((emp.first_name||'')+' '+(emp.last_name||'')).trim()||emp.email||'Unknown';}

async function loadContacts(){if(!currentTenantId)return;var r=await sb.from('customers').select('*').eq('tenant_id',currentTenantId).or('is_deleted.is.null,is_deleted.eq.false').order('created_at',{ascending:false});allContacts=(r.data||[]).map(function(c){return Object.assign({},c,{funnel_stage:c.funnel_stage||1});});renderContacts();updateStats();}

function renderContacts(){
  var ids=getStageIds();
  ids.forEach(function(id){var el=document.getElementById('stage'+id);if(el)el.innerHTML='';});
  var searchTerm=(document.getElementById('searchBox').value||'').toLowerCase();
  var stageCounts={};ids.forEach(function(id){stageCounts[id]=0;});
  allContacts.forEach(function(contact){
    var name=((contact.first_name||'')+' '+(contact.last_name||'')+' '+(contact.full_name||'')).toLowerCase();
    var org=(contact.organization_name||'').toLowerCase();
    if(!searchTerm||name.includes(searchTerm)||(contact.phone||'').includes(searchTerm)||org.includes(searchTerm)){
      var stage=contact.funnel_stage||ids[0]||1;
      if(!STAGES[stage])stage=ids[0]||1; // fallback if stage was deleted
      if(stageCounts[stage]!==undefined)stageCounts[stage]++;
      var card=createContactCard(contact);
      var el=document.getElementById('stage'+stage);
      if(el)el.appendChild(card);
    }
  });
  ids.forEach(function(id){var el=document.getElementById('count'+id);if(el)el.textContent=stageCounts[id]||0;});
}

function createContactCard(contact){
  var card=document.createElement('div');
  card.className='contact-card'+(isMobile?' card-mini':'');
  card.draggable=!isMobile;
  card.dataset.id=contact.customer_id;
  card.dataset.cardState='mini'; // mini → expanded → detail
  var empColor=getContactEmployeeColor(contact.assigned_to);
  card.style.borderLeftColor=empColor;
  var firstName=contact.first_name||'Unknown';
  var stage=contact.funnel_stage||getStageIds()[0]||1;
  if(!STAGES[stage])stage=getStageIds()[0]||1;
  var empName=getEmployeeNameById(contact.assigned_to);
  
  // Progress dots — dynamic
  var ids=getStageIds();
  var stageIdx=ids.indexOf(stage);
  var dotsHtml='';
  ids.forEach(function(id,i){var dc='progress-dot';if(i<stageIdx)dc+=' completed';if(id===stage)dc+=' current';dotsHtml+='<div class="'+dc+'" style="color:'+getStageColor(id)+'" title="'+getStageName(id)+'"></div>';});
  
  // Assigned row
  var assignedHtml='<div class="contact-assigned"><span class="contact-assigned-dot" style="background:'+empColor+'"></span>'+empName+'</div>';
  
  // Mini row (mobile only — visible when card-mini)
  var miniRow='<div class="card-mini-row"><span class="card-mini-stage">'+getStageName(stage)+'</span><span class="card-mini-emp"><span class="card-mini-emp-dot" style="background:'+empColor+'"></span>'+empName+'</span></div>';
  
  card.innerHTML='<div class="contact-card-header"><div><div class="contact-name">'+firstName+(contact.organization_name?' <span style="font-weight:400;color:var(--text-secondary);font-size:12px;">· '+contact.organization_name+'</span>':'')+'</div></div></div>'+miniRow+assignedHtml+'<div class="contact-info">'+(contact.phone?'<div class="contact-info-item"><a href="tel:'+contact.phone+'" onclick="event.stopPropagation()">'+contact.phone+'</a></div>':'')+'</div><div class="progress-dots">'+dotsHtml+'<span class="progress-label">'+getStageName(stage)+'</span></div>';
  
  // Desktop: drag + click opens detail
  if(!isMobile){
    card.addEventListener('dragstart',function(e){draggedCard=this;this.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',contact.customer_id);});
    card.addEventListener('dragend',function(){this.classList.remove('dragging');document.querySelectorAll('.funnel-cards').forEach(function(col){col.classList.remove('drag-over');});});
    card.addEventListener('click',function(){openContactDetail(contact);});
  } else {
    // Mobile: 3-state click handler
    card.addEventListener('click',function(e){
      if(e.target.closest('a'))return; // let links work
      var state=this.dataset.cardState;
      if(state==='mini'){
        // Collapse any other expanded cards in same column
        var parent=this.parentElement;
        parent.querySelectorAll('.contact-card.card-expanded').forEach(function(c){
          c.classList.remove('card-expanded');
          c.classList.add('card-mini');
          c.dataset.cardState='mini';
        });
        this.classList.remove('card-mini');
        this.classList.add('card-expanded');
        this.dataset.cardState='expanded';
      } else if(state==='expanded'){
        openContactDetail(contact);
        // Reset card back to mini after opening detail
        this.classList.remove('card-expanded');
        this.classList.add('card-mini');
        this.dataset.cardState='mini';
      }
    });
  }
  return card;
}

function toggleColumn(stage){var col=document.querySelector('.funnel-column[data-stage="'+stage+'"]');if(col)col.classList.toggle('collapsed');}
function allowDrop(e){e.preventDefault();}
function dragEnter(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function dragLeave(e){e.currentTarget.classList.remove('drag-over');}
async function drop(e,newStage){e.preventDefault();e.currentTarget.classList.remove('drag-over');if(!draggedCard)return;var contactId=draggedCard.dataset.id;var contact=allContacts.find(function(c){return c.customer_id==contactId;});if(contact&&contact.funnel_stage!==newStage){contact.funnel_stage=newStage;renderContacts();updateStats();var r=await sb.from('customers').update({funnel_stage:newStage}).eq('customer_id',contact.customer_id).select();if(r.error)alert('Error saving: '+r.error.message);}draggedCard=null;}
function filterContacts(){renderContacts();}
function updateStats(){var ids=getStageIds();var counts={};ids.forEach(function(id){counts[id]=0;});allContacts.forEach(function(c){var s=c.funnel_stage||ids[0]||1;if(counts[s]!==undefined)counts[s]++;});var el=document.getElementById('statTotal');if(el)el.textContent=allContacts.length;ids.forEach(function(id){var el=document.getElementById('stat'+id);if(el)el.textContent=counts[id]||0;});}

function populateAssignDropdowns(){var s=document.getElementById('contactAssignTo'),html='<option value="">-- Unassigned --</option>';allEmployees.forEach(function(emp){var name=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||emp.email||'Unknown';html+='<option value="'+emp.employee_id+'">'+name+'</option>';});if(s)s.innerHTML=html;}

function openNewContactModal(){document.getElementById('contactFirstName').value='';document.getElementById('contactLastName').value='';document.getElementById('contactPhone').value='';document.getElementById('contactEmail').value='';document.getElementById('contactOrganization').value='';document.getElementById('contactClientType').value='';var stageSelect=document.getElementById('contactStage');var ids=getStageIds();stageSelect.innerHTML=ids.map(function(id){return'<option value="'+id+'">'+getStageName(id)+'</option>';}).join('');document.getElementById('contactAssignTo').value='';document.getElementById('contactBirthday').value='';document.getElementById('contactAnniversary').value='';document.getElementById('contactNotes').value='';populateAssignDropdowns();document.getElementById('newContactModal').classList.add('active');}
function closeNewContactModal(){document.getElementById('newContactModal').classList.remove('active');}

async function saveNewContact(){var firstName=document.getElementById('contactFirstName').value.trim(),lastName=document.getElementById('contactLastName').value.trim(),phone=document.getElementById('contactPhone').value.trim(),email=document.getElementById('contactEmail').value.trim(),org=document.getElementById('contactOrganization').value.trim(),clientType=document.getElementById('contactClientType').value,stage=document.getElementById('contactStage').value,assignTo=document.getElementById('contactAssignTo').value,birthday=document.getElementById('contactBirthday').value,anniversary=document.getElementById('contactAnniversary').value,notes=document.getElementById('contactNotes').value.trim();if(!firstName){alert('Enter first name');return;}if(!org){alert('Enter organization');return;}if(!phone){alert('Enter phone number');return;}try{var d={tenant_id:currentTenantId,first_name:firstName,last_name:lastName||null,full_name:(firstName+(lastName?' '+lastName:'')).trim(),phone:phone,email:email||null,organization_name:org,customer_type:clientType||'prospect',funnel_stage:parseInt(stage)||1,created_at:new Date().toISOString()};if(notes)d.notes=notes;if(assignTo)d.assigned_to=assignTo;if(birthday)d.birthday=birthday;if(anniversary)d.anniversary=anniversary;var r=await sb.from('customers').insert(d).select().single();if(r.error)throw r.error;closeNewContactModal();await loadContacts();}catch(e){alert('Error: '+(e.message||'Failed to save'));}}

function formatDateForInput(d){return d?d.split('T')[0]:'';}
var currentEditingContact=null;
function buildAssignDropdownOptions(sel){var h='<option value="">-- Unassigned --</option>';allEmployees.forEach(function(emp){var n=((emp.first_name||'')+' '+(emp.last_name||'')).trim()||emp.email||'Unknown';h+='<option value="'+emp.employee_id+'"'+(emp.employee_id===sel?' selected':'')+'>'+n+'</option>';});return h;}

function openContactDetail(contact){
  currentEditingContact=contact;
  var name=((contact.first_name||'')+' '+(contact.last_name||'')).trim()||contact.full_name||'Unknown';
  var initials=name.split(' ').map(function(n){return n[0]||'';}).join('').toUpperCase().slice(0,2)||'U';
  var stage=contact.funnel_stage||getStageIds()[0]||1;
  if(!STAGES[stage])stage=getStageIds()[0]||1;
  var empColor=getContactEmployeeColor(contact.assigned_to);
  var isAdmin=['owner','admin'].includes(currentUserRole);
  var deleteBtn=isAdmin?'<button class="btn-danger" onclick="deleteContact(\''+contact.customer_id+'\')">Delete Contact</button>':'';
  var ctOpts='<option value="">-- Select --</option>';['RC','HOG','MC','SC','Shop','Independent','Other','prospect'].forEach(function(v){ctOpts+='<option value="'+v+'"'+(contact.customer_type===v?' selected':'')+'>'+v+'</option>';});
  document.getElementById('contactDetailBody').innerHTML='<div class="contact-detail-header"><div class="contact-detail-avatar" style="border-color:'+empColor+'">'+initials+'</div><div class="contact-detail-name">'+name+'</div>'+(contact.organization_name?'<div class="contact-detail-company">'+contact.organization_name+'</div>':'')+'<div class="contact-actions">'+(contact.phone?'<a href="tel:'+contact.phone+'" class="contact-action-btn">Call</a><a href="sms:'+contact.phone+'" class="contact-action-btn">Text</a>':'')+(contact.email?'<a href="mailto:'+contact.email+'" class="contact-action-btn">Email</a>':'')+'</div></div><div class="contact-section"><div class="contact-section-title">Basic Info</div><div class="form-row" style="margin-bottom:12px;"><div class="form-group" style="margin-bottom:0;"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="editFirstName" value="'+(contact.first_name||'')+'"></div><div class="form-group" style="margin-bottom:0;"><label class="form-label">Last Name</label><input type="text" class="form-input" id="editLastName" value="'+(contact.last_name||'')+'"></div></div><div class="form-group"><label class="form-label">Organization <span class="required">*</span></label><input type="text" class="form-input" id="editOrganization" value="'+(contact.organization_name||'')+'"></div></div><div class="contact-section"><div class="contact-section-title">Contact Info</div><div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="editPhone" value="'+(contact.phone||'')+'"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="editEmail" value="'+(contact.email||'')+'"></div></div><div class="contact-section"><div class="contact-section-title">Classification</div><div class="form-row" style="margin-bottom:12px;"><div class="form-group" style="margin-bottom:0;"><label class="form-label">Client Type</label><select class="form-select" id="editClientType">'+ctOpts+'</select></div><div class="form-group" style="margin-bottom:0;"><label class="form-label">Assigned To</label><select class="form-select" id="editAssignedTo">'+buildAssignDropdownOptions(contact.assigned_to)+'</select></div></div></div><div class="contact-section"><div class="contact-section-title">Funnel Stage</div><div class="stage-selector">'+getStageIds().map(function(s){return'<button type="button" class="stage-option '+(s===stage?'active':'')+'" style="color:'+getStageColor(s)+'" data-stage="'+s+'" onclick="selectStageInEdit('+s+')">'+getStageName(s)+'</button>';}).join('')+'</div><input type="hidden" id="editFunnelStage" value="'+stage+'"></div><div class="contact-section"><div class="contact-section-title">Important Dates</div><div class="form-row"><div class="form-group" style="margin-bottom:0;"><label class="form-label">Birthday</label><input type="date" class="form-input" id="editBirthday" value="'+formatDateForInput(contact.birthday)+'"></div><div class="form-group" style="margin-bottom:0;"><label class="form-label">Anniversary</label><input type="date" class="form-input" id="editAnniversary" value="'+formatDateForInput(contact.anniversary)+'"></div></div></div><div class="contact-section"><div class="contact-section-title">Notes</div><textarea class="form-textarea" id="editNotes" placeholder="Additional notes...">'+(contact.notes||'')+'</textarea></div><div class="contact-section" style="padding-top:16px;border-top:1px solid var(--border-default);display:flex;flex-direction:column;gap:12px;"><button class="btn-primary" style="width:100%;padding:12px;" onclick="saveContactChanges()">Save Changes</button><a href="sharklaw-profiles.html?id='+contact.customer_id+'" class="btn-secondary" style="width:100%;padding:12px;text-align:center;text-decoration:none;display:block;">View Full Profile</a>'+deleteBtn+'</div>';
  document.getElementById('contactDetailModal').classList.add('active');
}

function selectStageInEdit(stage){document.getElementById('editFunnelStage').value=stage;document.querySelectorAll('#contactDetailBody .stage-option').forEach(function(btn){btn.classList.remove('active');if(parseInt(btn.dataset.stage)===stage)btn.classList.add('active');});}

async function saveContactChanges(){if(!currentEditingContact)return;var firstName=document.getElementById('editFirstName').value.trim(),org=document.getElementById('editOrganization').value.trim(),phone=document.getElementById('editPhone').value.trim();if(!firstName){alert('Enter first name');return;}if(!org){alert('Enter organization');return;}if(!phone){alert('Enter phone number');return;}var u={first_name:firstName,last_name:document.getElementById('editLastName').value.trim()||null,organization_name:org,phone:phone,email:document.getElementById('editEmail').value.trim()||null,customer_type:document.getElementById('editClientType').value||'prospect',assigned_to:document.getElementById('editAssignedTo').value||null,funnel_stage:parseInt(document.getElementById('editFunnelStage').value)||1,birthday:document.getElementById('editBirthday').value||null,anniversary:document.getElementById('editAnniversary').value||null,notes:document.getElementById('editNotes').value.trim()||null,updated_at:new Date().toISOString()};u.full_name=(u.first_name+(u.last_name?' '+u.last_name:'')).trim();try{var r=await sb.from('customers').update(u).eq('customer_id',currentEditingContact.customer_id).select().single();if(r.error)throw r.error;var idx=allContacts.findIndex(function(c){return c.customer_id===currentEditingContact.customer_id;});if(idx>=0)allContacts[idx]=Object.assign(allContacts[idx],u);closeContactDetailModal();renderContacts();updateStats();showToast('Contact saved!');}catch(e){alert('Error: '+(e.message||'Unknown'));}}

async function deleteContact(id){if(!confirm('Delete this contact?'))return;try{var r=await sb.from('customers').update({is_deleted:true,deleted_at:new Date().toISOString()}).eq('customer_id',id);if(r.error)throw r.error;allContacts=allContacts.filter(function(c){return c.customer_id!==id;});closeContactDetailModal();renderContacts();updateStats();showToast('Contact deleted');}catch(e){alert('Error: '+(e.message||'Unknown'));}}

function showToast(msg){var t=document.getElementById('themeToast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
function closeContactDetailModal(){document.getElementById('contactDetailModal').classList.remove('active');}

function importCSV(event){var file=event.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=async function(e){var lines=e.target.result.split('\n'),imported=0;for(var i=1;i<lines.length;i++){var v=lines[i].split(',').map(function(x){return x.trim().replace(/^"|"$/g,'');});if(v.length>=2&&v[0]){await sb.from('customers').insert({tenant_id:currentTenantId,first_name:v[0],last_name:v[1]||'',phone:v[2]||'',email:v[3]||null,organization_name:v[4]||null,customer_type:'prospect',funnel_stage:1});imported++;}}alert('Imported '+imported+' contacts!');await loadContacts();};reader.readAsText(file);event.target.value='';}

async function checkAuth(){var r=await sb.auth.getSession(),s=r.data.session;if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}if(!s){window.location.href='login.html';return null;}}currentUserId=s.user.id;userEmail=s.user.email;return s;}
function updateEmailDisplay(){if(userEmail){document.getElementById('desktopBusinessName').textContent=userEmail;document.getElementById('mobileBusinessName').textContent=userEmail;}}
async function loadEmployees(){if(!currentTenantId)return;var r=await sb.from('employees').select('employee_id, first_name, last_name, email, color, role').eq('tenant_id',currentTenantId).or('is_active.is.null,is_active.eq.true').order('last_name');allEmployees=r.data||[];}

// Collapse all funnels on mobile
function collapseFunnelsOnMobile(){
  if(!isMobile)return;
  document.querySelectorAll('.funnel-column').forEach(function(col){col.classList.add('collapsed');});
}

async function init(){
  var s=await checkAuth();if(!s)return;
  var email=s.user?.email;
  if(email){var r=await sb.from('users').select('*').eq('email',email).single();if(r.data?.tenant_id){currentTenantId=r.data.tenant_id;currentUserId=r.data.user_id;currentUserRole=r.data.role||null;}}
  if(!currentTenantId){var r=await sb.from('business_settings').select('tenant_id').limit(1).single();if(r.data?.tenant_id)currentTenantId=r.data.tenant_id;}
  if(!currentTenantId){console.error('No tenant');return;}
  if(!currentUserRole&&email){var empR=await sb.from('employees').select('role').eq('email',email).single();if(empR.data?.role)currentUserRole=empR.data.role;}
  updateEmailDisplay();
  await loadUserThemeBank();
  await loadEmployees();
  await loadStages();
  renderFunnelColumns();
  renderStats();
  await loadContacts();
  collapseFunnelsOnMobile();
}
init();
</script>
</body>
</html>
