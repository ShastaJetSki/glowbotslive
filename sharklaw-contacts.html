<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Contacts</title>
  <script>
    (function() {
      var theme = localStorage.getItem('app-theme') || 'dark-blue';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="themes.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="employee-utils.js"></script>
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
      --funnel-1: #3b82f6; --funnel-2: #06b6d4; --funnel-3: #8b5cf6; --funnel-4: #f59e0b; --funnel-5: #10b981; --funnel-6: #ef4444;
    }
    /* Core themes */
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="blue-light"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }
    [data-theme="slate-dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="slate-light"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; }
    [data-theme="ocean-dark"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="ocean-light"] { --bg-primary: #f0fdfa; --bg-secondary: #e0f7f4; --bg-card: #ffffff; --bg-hover: #ccfbf1; --border-default: #99f6e4; --text-primary: #134e4a; --text-secondary: #2d6a66; --accent-primary: #0d9488; --accent-light: #14b8a6; }
    [data-theme="midnight-dark"],[data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="lavender-light"],[data-theme="lavender"] { --bg-primary: #faf5ff; --bg-secondary: #f3e8ff; --bg-card: #ffffff; --bg-hover: #ede4ff; --border-default: #d8b4fe; --text-primary: #3b1d5c; --text-secondary: #6b4d8a; --accent-primary: #9333ea; --accent-light: #a855f7; }
    [data-theme="forest-dark"],[data-theme="forest"] { --bg-primary: #071209; --bg-secondary: #0c1f10; --bg-card: #132a18; --bg-hover: #1a3820; --border-default: #234428; --text-primary: #e5f5e8; --text-secondary: #8fb898; --accent-primary: #22c55e; --accent-light: #4ade80; }
    [data-theme="mint-light"],[data-theme="mint"] { --bg-primary: #f0fdf4; --bg-secondary: #dcfce7; --bg-card: #ffffff; --bg-hover: #bbf7d0; --border-default: #86efac; --text-primary: #14532d; --text-secondary: #3d6b4f; --accent-primary: #16a34a; --accent-light: #22c55e; }
    [data-theme="crimson-dark"],[data-theme="crimson"] { --bg-primary: #0f0708; --bg-secondary: #1a0c0e; --bg-card: #261214; --bg-hover: #331a1c; --border-default: #442225; --text-primary: #fee2e2; --text-secondary: #c9a3a5; --accent-primary: #dc2626; --accent-light: #ef4444; }
    [data-theme="coral-light"],[data-theme="coral"] { --bg-primary: #fff5f5; --bg-secondary: #fee2e2; --bg-card: #ffffff; --bg-hover: #fecaca; --border-default: #fca5a5; --text-primary: #7f1d1d; --text-secondary: #a04444; --accent-primary: #ef4444; --accent-light: #f87171; }
    [data-theme="amber-dark"],[data-theme="amber"] { --bg-primary: #0f0c05; --bg-secondary: #1a1508; --bg-card: #26200c; --bg-hover: #332a10; --border-default: #443815; --text-primary: #fef3c7; --text-secondary: #c9b896; --accent-primary: #f59e0b; --accent-light: #fbbf24; }
    [data-theme="honey-light"],[data-theme="honey"] { --bg-primary: #fffbeb; --bg-secondary: #fef3c7; --bg-card: #ffffff; --bg-hover: #fde68a; --border-default: #fcd34d; --text-primary: #78350f; --text-secondary: #a06020; --accent-primary: #d97706; --accent-light: #f59e0b; }
    [data-theme="rose-dark"],[data-theme="rose"] { --bg-primary: #0f070a; --bg-secondary: #1a0c12; --bg-card: #26121a; --bg-hover: #331a24; --border-default: #44222e; --text-primary: #ffe4ec; --text-secondary: #c9a3b0; --accent-primary: #ec4899; --accent-light: #f472b6; }
    [data-theme="sky-light"],[data-theme="sky"] { --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --bg-card: #ffffff; --bg-hover: #bae6fd; --border-default: #7dd3fc; --text-primary: #0c4a6e; --text-secondary: #3a6a8a; --accent-primary: #0284c7; --accent-light: #0ea5e9; }
    [data-theme="cyber-dark"],[data-theme="cyber"] { --bg-primary: #0a0a0f; --bg-secondary: #0f0f18; --bg-card: #151522; --bg-hover: #1c1c2e; --border-default: #2a2a44; --text-primary: #e0e0ff; --text-secondary: #9090c0; --accent-primary: #00ff88; --accent-light: #44ffaa; }
    [data-theme="sand-light"],[data-theme="sand"] { --bg-primary: #fefcf8; --bg-secondary: #faf6ee; --bg-card: #ffffff; --bg-hover: #f5efe0; --border-default: #e8dcc8; --text-primary: #44402a; --text-secondary: #6a6550; --accent-primary: #a89060; --accent-light: #c4aa78; }
    [data-theme="slate"],[data-theme="ocean"],[data-theme="light-blue"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; scroll-behavior: auto; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    .theme-toast { position: fixed; bottom: 200px; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border-default); color: var(--text-primary); padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 1000; display: none; }
    .theme-toast.show { display: block; }
    
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    .mobile-menu-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: var(--bg-primary); border-top: 1px solid var(--border-default); }
    .mobile-menu-content.expanded { max-height: 200px; }
    .mobile-header-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px 12px 12px; }
    .mobile-header-actions button { padding: 10px; font-size: 13px; background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-primary) 30%, transparent); color: var(--accent-light); border-radius: 8px; cursor: pointer; }
    
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }

    .toolbar { padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .toolbar-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; }
    .search-box:focus { outline: none; border-color: var(--accent-primary); }
    .add-btn { padding: 10px 16px; border-radius: 8px; border: none; background: var(--accent-primary); color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .add-btn:hover { background: var(--accent-light); }

    .quick-stats { display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); overflow-x: auto; }
    .stat-card { flex: 1; min-width: 100px; padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-default); text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--text-primary); }
    .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }

    .funnel-container { display: flex; gap: 12px; padding: 12px; overflow-x: auto; min-height: calc(100vh - 380px); scroll-behavior: auto; -webkit-overflow-scrolling: touch; }
    .funnel-column { flex: 1; min-width: 260px; max-width: 300px; background: var(--bg-secondary); border-radius: 12px; display: flex; flex-direction: column; }
    .funnel-header { padding: 12px 16px; border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
    .funnel-title { font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
    .funnel-dot { width: 10px; height: 10px; border-radius: 50%; }
    .funnel-header-controls { display: flex; align-items: center; gap: 8px; }
    .funnel-count { font-size: 13px; color: var(--text-secondary); background: var(--bg-hover); padding: 4px 10px; border-radius: 10px; min-width: 28px; text-align: center; font-weight: 500; }
    .funnel-expand-btn { width: 32px; height: 32px; border: 1px solid var(--border-default); border-radius: 6px; background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .funnel-expand-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .funnel-arrow { font-size: 22px; color: var(--text-secondary); cursor: pointer; transition: transform 0.3s; padding: 4px; }
    .funnel-arrow:hover { color: var(--text-primary); }
    .funnel-column.collapsed .funnel-arrow { transform: rotate(-90deg); }
    .funnel-column.collapsed .funnel-cards { display: none; }
    .funnel-cards { flex: 1; padding: 8px; overflow-y: auto; min-height: 50px; transition: all 0.3s; }
    .funnel-cards.collapsed { display: none; }
    .funnel-cards.drag-over { background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border-radius: 8px; }

    .contact-card { background: var(--bg-card); border-radius: 10px; padding: 12px; margin-bottom: 8px; cursor: grab; border: 1px solid var(--border-default); border-left: 4px solid #eab308; transition: all 0.2s; }
    .contact-card:hover { border-color: var(--accent-primary); border-left-color: inherit; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .contact-card.dragging { opacity: 0.5; cursor: grabbing; }
    .contact-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .contact-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .contact-company { font-size: 12px; color: var(--text-secondary); }
    .contact-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--bg-hover); color: var(--text-secondary); text-transform: uppercase; }
    .contact-info { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
    .contact-info-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .contact-info-item a { color: var(--accent-light); text-decoration: none; }
    .contact-info-item a:hover { text-decoration: underline; }
    .contact-assigned { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary); margin-bottom: 8px; padding: 4px 0; }
    .contact-assigned-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    
    .progress-dots { display: flex; gap: 6px; align-items: center; padding-top: 8px; border-top: 1px solid var(--border-default); }
    .progress-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--border-default); background: transparent; transition: all 0.3s; }
    .progress-dot.completed { border-color: currentColor; background: currentColor; }
    .progress-dot.current { border-color: currentColor; box-shadow: 0 0 0 3px color-mix(in srgb, currentColor 30%, transparent); animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 3px color-mix(in srgb, currentColor 30%, transparent); }
      50% { box-shadow: 0 0 0 6px color-mix(in srgb, currentColor 10%, transparent); }
    }
    .progress-dot[data-stage="1"] { color: var(--funnel-1); }
    .progress-dot[data-stage="2"] { color: var(--funnel-2); }
    .progress-dot[data-stage="3"] { color: var(--funnel-3); }
    .progress-dot[data-stage="4"] { color: var(--funnel-4); }
    .progress-dot[data-stage="5"] { color: var(--funnel-5); }
    .progress-dot[data-stage="6"] { color: var(--funnel-6); }
    .progress-label { font-size: 10px; color: var(--text-secondary); margin-left: auto; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-default); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-default); }
    .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
    .form-label .required { color: #ef4444; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border-default); }
    .btn-secondary { padding: 10px 20px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; cursor: pointer; }
    .btn-primary { padding: 10px 20px; border-radius: 6px; border: none; background: var(--accent-primary); color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-danger { padding: 10px 20px; border-radius: 6px; border: none; background: #dc2626; color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; width: 100%; }
    .btn-danger:hover { background: #ef4444; }

    .contact-detail-header { text-align: center; padding-bottom: 16px; border-bottom: 1px solid var(--border-default); margin-bottom: 16px; }
    .contact-detail-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--bg-hover); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 600; color: var(--accent-light); margin: 0 auto 12px; border: 3px solid var(--border-default); }
    .contact-detail-name { font-size: 20px; font-weight: 600; }
    .contact-detail-company { font-size: 14px; color: var(--text-secondary); }
    .contact-actions { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
    .contact-action-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; text-decoration: none; }
    .contact-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .contact-section { margin-bottom: 16px; }
    .contact-section-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
    .contact-field { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-default); }
    .contact-field:last-child { border-bottom: none; }
    .contact-field-label { font-size: 13px; color: var(--text-secondary); }
    .contact-field-value { font-size: 13px; color: var(--text-primary); }
    .contact-field-value a { color: var(--accent-light); text-decoration: none; }
    .stage-selector { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .stage-option { padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 8px; }
    .stage-option::before { content: ''; width: 10px; height: 10px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .stage-option:hover { background: var(--bg-hover); }
    .stage-option.active { border-color: currentColor; background: color-mix(in srgb, currentColor 20%, transparent); }
    .stage-option[data-stage="1"] { color: var(--funnel-1); }
    .stage-option[data-stage="2"] { color: var(--funnel-2); }
    .stage-option[data-stage="3"] { color: var(--funnel-3); }
    .stage-option[data-stage="4"] { color: var(--funnel-4); }
    .stage-option[data-stage="5"] { color: var(--funnel-5); }
    .stage-option[data-stage="6"] { color: var(--funnel-6); }

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.action-btn { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 50%, transparent); color: var(--accent-light); font-size: 14px; }

    .import-section { background: var(--bg-card); border: 2px dashed var(--border-default); border-radius: 12px; padding: 20px; margin: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .import-section:hover { border-color: var(--accent-primary); background: var(--bg-hover); }
    .import-text { font-size: 13px; color: var(--text-secondary); }
    .import-text strong { color: var(--accent-light); }

    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      body { padding-bottom: 120px; }
      .funnel-container { flex-direction: column; }
      .funnel-column { max-width: none; min-width: auto; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Contacts</div>
      <div class="business-name" id="mobileBusinessName">Loading...</div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
    </div>
  </div>
  <div class="mobile-menu-content" id="mobileMenuContent">
    <div class="mobile-header-actions">
      <button onclick="location.href='sharklaw-settings.html'">Settings</button>
      <button onclick="location.href='support.html'">Support</button>
      <button onclick="location.href='account.html'">Account</button>
    </div>
  </div>
</div>

<!-- Desktop Header - MATCHING DASHBOARD EXACTLY -->
<div class="desktop-header">
  <div style="padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 style="margin:0;font-size:32px;font-weight:600;">Contacts</h1>
      <div class="business-name" id="desktopBusinessName">Loading...</div>
    </div>
    <div style="display:flex;align-items:center;gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary);cursor:pointer;font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex;gap:24px;align-items:center;">
      <a href="dashboard-sharklaw.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0;color:var(--accent-primary);text-decoration:none;font-size:14px;border-bottom:2px solid var(--accent-primary);">Contacts</a>
      <a href="sharklaw-swag.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Swag</a>
      <a href="sharklaw-settings.html" style="padding:12px 0;color:var(--text-secondary);text-decoration:none;font-size:14px;">Settings</a>
    </nav>
  </div>
</div>

<div class="quick-stats">
  <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
  <div class="stat-card"><div class="stat-value" id="stat1">0</div><div class="stat-label">1st Contact</div></div>
  <div class="stat-card"><div class="stat-value" id="stat2">0</div><div class="stat-label">Opt-in</div></div>
  <div class="stat-card"><div class="stat-value" id="stat3">0</div><div class="stat-label">Swag OK</div></div>
  <div class="stat-card"><div class="stat-value" id="stat4">0</div><div class="stat-label">Artwork</div></div>
  <div class="stat-card"><div class="stat-value" id="stat5">0</div><div class="stat-label">Delivered</div></div>
  <div class="stat-card"><div class="stat-value" id="stat6">0</div><div class="stat-label">Leads</div></div>
</div>

<div class="toolbar">
  <div class="toolbar-row">
    <input type="text" class="search-box" id="searchBox" placeholder="Search by name, phone, or email..." oninput="filterContacts()">
    <button class="add-btn" onclick="openNewContactModal()">+ New Contact</button>
  </div>
</div>

<div class="funnel-container" id="funnelContainer">
  <div class="funnel-column" data-stage="1">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-1)"></span> <span>1st Contact</span></div>
      <div class="funnel-header-controls">
        <span class="funnel-count" id="count1">0</span>
        <button class="funnel-expand-btn" onclick="toggleColumn(1)" title="Toggle">☐</button>
        <span class="funnel-arrow" onclick="toggleColumn(1)">▼</span>
      </div>
    </div>
    <div class="funnel-cards" id="stage1" ondragover="allowDrop(event)" ondrop="drop(event, 1)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <div class="funnel-column" data-stage="2">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-2)"></span> <span>Opt-in Contact</span></div>
      <div class="funnel-header-controls">
        <span class="funnel-count" id="count2">0</span>
        <button class="funnel-expand-btn" onclick="toggleColumn(2)" title="Toggle">☐</button>
        <span class="funnel-arrow" onclick="toggleColumn(2)">▼</span>
      </div>
    </div>
    <div class="funnel-cards" id="stage2" ondragover="allowDrop(event)" ondrop="drop(event, 2)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <div class="funnel-column" data-stage="3">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-3)"></span> <span>Swag Approved</span></div>
      <div class="funnel-header-controls">
        <span class="funnel-count" id="count3">0</span>
        <button class="funnel-expand-btn" onclick="toggleColumn(3)" title="Toggle">☐</button>
        <span class="funnel-arrow" onclick="toggleColumn(3)">▼</span>
      </div>
    </div>
    <div class="funnel-cards" id="stage3" ondragover="allowDrop(event)" ondrop="drop(event, 3)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <div class="funnel-column" data-stage="4">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-4)"></span> <span>Receive Artwork</span></div>
      <div class="funnel-header-controls">
        <span class="funnel-count" id="count4">0</span>
        <button class="funnel-expand-btn" onclick="toggleColumn(4)" title="Toggle">☐</button>
        <span class="funnel-arrow" onclick="toggleColumn(4)">▼</span>
      </div>
    </div>
    <div class="funnel-cards" id="stage4" ondragover="allowDrop(event)" ondrop="drop(event, 4)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <div class="funnel-column" data-stage="5">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-5)"></span> <span>Deliver Pop Up</span></div>
      <div class="funnel-header-controls">
        <span class="funnel-count" id="count5">0</span>
        <button class="funnel-expand-btn" onclick="toggleColumn(5)" title="Toggle">☐</button>
        <span class="funnel-arrow" onclick="toggleColumn(5)">▼</span>
      </div>
    </div>
    <div class="funnel-cards" id="stage5" ondragover="allowDrop(event)" ondrop="drop(event, 5)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <div class="funnel-column" data-stage="6">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-6)"></span> <span>Lead</span></div>
      <div class="funnel-header-controls">
        <span class="funnel-count" id="count6">0</span>
        <button class="funnel-expand-btn" onclick="toggleColumn(6)" title="Toggle">☐</button>
        <span class="funnel-arrow" onclick="toggleColumn(6)">▼</span>
      </div>
    </div>
    <div class="funnel-cards" id="stage6" ondragover="allowDrop(event)" ondrop="drop(event, 6)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
</div>

<div class="import-section" onclick="document.getElementById('csvInput').click()">
  <div class="import-text"><strong>Drop a CSV file here</strong> or click to import contacts</div>
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(event)">
</div>

<!-- New Contact Modal -->
<div class="modal-overlay" id="newContactModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">New Contact</div>
      <button class="modal-close" onclick="closeNewContactModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name <span class="required">*</span></label><input type="text" class="form-input" id="contactFirstName" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name <span class="required">*</span></label><input type="text" class="form-input" id="contactLastName" placeholder="Last name"></div>
      </div>
      <div class="form-group"><label class="form-label">Phone <span class="required">*</span></label><input type="tel" class="form-input" id="contactPhone" placeholder="(555) 123-4567"></div>
      <div class="form-group"><label class="form-label">Email <span class="required">*</span></label><input type="email" class="form-input" id="contactEmail" placeholder="email@example.com"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="contactOrganization" placeholder="Organization name"></div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Client Type</label>
          <select class="form-select" id="contactClientType">
            <option value="">-- Select --</option>
            <option value="RC">RC</option>
            <option value="HOG">HOG</option>
            <option value="Independent">Independent</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Funnel Stage</label>
          <select class="form-select" id="contactStage">
            <option value="1">1st Contact</option>
            <option value="2">Opt-in Contact</option>
            <option value="3">Swag Approved</option>
            <option value="4">Receive Artwork</option>
            <option value="5">Deliver Pop Up</option>
            <option value="6">Lead</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Assign To</label>
        <select class="form-select" id="contactAssignTo">
          <option value="">-- Unassigned --</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Birthday</label>
          <input type="date" class="form-input" id="contactBirthday">
        </div>
        <div class="form-group">
          <label class="form-label">Anniversary</label>
          <input type="date" class="form-input" id="contactAnniversary">
        </div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="contactNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewContactModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewContact()">Add Contact</button>
    </div>
  </div>
</div>

<!-- Contact Detail Modal -->
<div class="modal-overlay" id="contactDetailModal">
  <div class="modal-content" style="max-width:550px;">
    <div class="modal-header">
      <div class="modal-title">Contact Details</div>
      <button class="modal-close" onclick="closeContactDetailModal()">&times;</button>
    </div>
    <div class="modal-body" id="contactDetailBody"></div>
  </div>
</div>

<!-- New Event Modal -->
<div class="modal-overlay" id="newEventModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="eventModalTitle">New Event</div>
      <button class="modal-close" onclick="closeNewEventModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Event Title <span class="required">*</span></label><input type="text" class="form-input" id="eventTitle" placeholder="Event name"></div>
      <div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="eventOrganization" placeholder="Hosting organization"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date <span class="required">*</span></label><input type="date" class="form-input" id="eventDate"></div>
        <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="eventTime" value="10:00"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Event Type</label>
        <select class="form-select" id="eventType">
          <option value="">-- Select --</option>
          <option value="Open House">Open House</option>
          <option value="Bike Night">Bike Night</option>
          <option value="Run">Run</option>
          <option value="Party">Party</option>
          <option value="Fundraiser">Fundraiser</option>
          <option value="Support">Support</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Ticket Price</label><input type="number" class="form-input" id="eventTicketPrice" placeholder="0.00" step="0.01" min="0"></div>
        <div class="form-group"><label class="form-label">Expected Attendance</label><input type="number" class="form-input" id="eventAttendance" placeholder="0" min="0"></div>
      </div>
      <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="eventLocation" placeholder="Event location"></div>
      <div class="form-group"><label class="form-label">Assign To</label>
        <select class="form-select" id="eventAssign">
          <option value="">-- Unassigned --</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="eventNotes" placeholder="Event details..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewEventModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewEvent()">Create Event</button>
    </div>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a>
  </div>
  <div class="mobile-nav-row three-col">
    <button class="mobile-nav-btn action-btn" onclick="openNewContactModal()">+ Contact</button>
    <a href="sharklaw-contacts.html" class="mobile-nav-btn active">Contacts</a>
    <a href="sharklaw-swag.html" class="mobile-nav-btn">Swag</a>
  </div>
</div>

<div class="theme-toast" id="themeToast"></div>

<script>
const SUPABASE_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let currentUserId=null,currentTenantId=null,userEmail=null,currentUserRole=null;
let allContacts=[];
let allEmployees=[];
let draggedCard=null;
let scrollAnimationId=null;
let currentScrollSpeed={x:0,y:0};
const SCROLL_ZONE=100;
const MAX_SCROLL_SPEED=12;
const UNASSIGNED_COLOR='#eab308'; // Gold for unassigned

function handleDragScroll(e){var mouseY=e.clientY;var mouseX=e.clientX;var windowHeight=window.innerHeight;var funnelContainer=document.getElementById('funnelContainer');currentScrollSpeed.y=0;currentScrollSpeed.x=0;if(mouseY<SCROLL_ZONE){var distance=SCROLL_ZONE-mouseY;currentScrollSpeed.y=-(distance/SCROLL_ZONE)*MAX_SCROLL_SPEED;}else if(mouseY>windowHeight-SCROLL_ZONE-120){var distance=mouseY-(windowHeight-SCROLL_ZONE-120);currentScrollSpeed.y=(distance/SCROLL_ZONE)*MAX_SCROLL_SPEED;}if(funnelContainer&&window.innerWidth>768){var rect=funnelContainer.getBoundingClientRect();if(mouseX>rect.left&&mouseX<rect.left+SCROLL_ZONE){var distance=SCROLL_ZONE-(mouseX-rect.left);currentScrollSpeed.x=-(distance/SCROLL_ZONE)*MAX_SCROLL_SPEED;}else if(mouseX<rect.right&&mouseX>rect.right-SCROLL_ZONE){var distance=mouseX-(rect.right-SCROLL_ZONE);currentScrollSpeed.x=(distance/SCROLL_ZONE)*MAX_SCROLL_SPEED;}}if((currentScrollSpeed.x!==0||currentScrollSpeed.y!==0)&&!scrollAnimationId){smoothScroll();}}

function smoothScroll(){if(currentScrollSpeed.y!==0){window.scrollBy(0,currentScrollSpeed.y);}if(currentScrollSpeed.x!==0){var funnelContainer=document.getElementById('funnelContainer');if(funnelContainer)funnelContainer.scrollBy(currentScrollSpeed.x,0);}if(currentScrollSpeed.x!==0||currentScrollSpeed.y!==0){scrollAnimationId=requestAnimationFrame(smoothScroll);}else{scrollAnimationId=null;}}

function stopAutoScroll(){currentScrollSpeed.x=0;currentScrollSpeed.y=0;if(scrollAnimationId){cancelAnimationFrame(scrollAnimationId);scrollAnimationId=null;}}

document.addEventListener('dragover',handleDragScroll);
document.addEventListener('dragend',stopAutoScroll);
document.addEventListener('drop',stopAutoScroll);

const STAGES={1:{name:'1st Contact',color:'var(--funnel-1)'},2:{name:'Opt-in Contact',color:'var(--funnel-2)'},3:{name:'Swag Approved',color:'var(--funnel-3)'},4:{name:'Receive Artwork',color:'var(--funnel-4)'},5:{name:'Deliver Pop Up',color:'var(--funnel-5)'},6:{name:'Lead',color:'var(--funnel-6)'}};

var THEME_NAMES={'dark-blue':'Dark Blue','blue-light':'Blue Light','slate-dark':'Slate Dark','slate-light':'Slate Light','ocean-dark':'Ocean Dark','ocean-light':'Ocean Light','midnight-dark':'Midnight','lavender-light':'Lavender','forest-dark':'Forest','mint-light':'Mint','crimson-dark':'Crimson','coral-light':'Coral','amber-dark':'Amber','honey-light':'Honey','rose-dark':'Rose','sky-light':'Sky','cyber-dark':'Cyber','sand-light':'Sand'};
var userThemeBank=['dark-blue'];
var themeIndex=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';if(!userThemeBank.includes(t))t='dark-blue';document.documentElement.setAttribute('data-theme',t);themeIndex=userThemeBank.indexOf(t);if(themeIndex<0)themeIndex=0;}
function cycleTheme(){if(userThemeBank.length<=1){showThemeToast('Unlock more themes in Settings!');return;}themeIndex=(themeIndex+1)%userThemeBank.length;var t=userThemeBank[themeIndex];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(THEME_NAMES[t]||t);}
function showThemeToast(msg){var toast=document.getElementById('themeToast');toast.textContent=msg;toast.classList.add('show');setTimeout(function(){toast.classList.remove('show');},2000);}
async function loadUserThemeBank(){if(!currentUserId)return;try{var r=await sb.from('user_theme_bank').select('theme_key').eq('user_id',currentUserId);if(r.data&&r.data.length>0){userThemeBank=['dark-blue'].concat(r.data.map(function(t){return t.theme_key;}));userThemeBank=[...new Set(userThemeBank)];}loadTheme();}catch(e){}}
loadTheme();

async function logout(){await sb.auth.signOut();localStorage.clear();location.replace("login.html");}
function toggleMobileMenu(){document.getElementById('mobileMenuContent').classList.toggle('expanded');}

// Get employee color using employee-utils.js pattern
function getContactEmployeeColor(assignedTo) {
  if (!assignedTo) return UNASSIGNED_COLOR;
  var emp = allEmployees.find(function(e) { return e.employee_id === assignedTo; });
  if (!emp) return UNASSIGNED_COLOR;
  return emp.color || UNASSIGNED_COLOR;
}

// Get employee name
function getEmployeeNameById(empId) {
  if (!empId) return 'Unassigned';
  var emp = allEmployees.find(function(e) { return e.employee_id === empId; });
  if (!emp) return 'Unassigned';
  return ((emp.first_name || '') + ' ' + (emp.last_name || '')).trim() || emp.email || 'Unknown';
}

async function loadContacts(){
  if(!currentTenantId)return;
  var r=await sb.from('customers')
    .select('*')
    .eq('tenant_id',currentTenantId)
    .or('is_deleted.is.null,is_deleted.eq.false')
    .order('created_at',{ascending:false});
  allContacts=(r.data||[]).map(function(c){return Object.assign({},c,{funnel_stage:c.funnel_stage||1});});
  renderContacts();
  updateStats();
}

function renderContacts(){for(var i=1;i<=6;i++)document.getElementById('stage'+i).innerHTML='';var searchTerm=(document.getElementById('searchBox').value||'').toLowerCase();var stageCounts={1:0,2:0,3:0,4:0,5:0,6:0};allContacts.forEach(function(contact){var name=((contact.first_name||'')+' '+(contact.last_name||'')+' '+(contact.full_name||'')).toLowerCase();var matchesSearch=!searchTerm||name.includes(searchTerm)||(contact.phone||'').includes(searchTerm)||(contact.email||'').toLowerCase().includes(searchTerm);if(matchesSearch){var stage=contact.funnel_stage||1;stageCounts[stage]++;var card=createContactCard(contact);document.getElementById('stage'+stage).appendChild(card);}});for(var i=1;i<=6;i++)document.getElementById('count'+i).textContent=stageCounts[i];}

function createContactCard(contact){
  var card=document.createElement('div');
  card.className='contact-card';
  card.draggable=true;
  card.dataset.id=contact.customer_id;
  
  // Get employee color for left border
  var empColor = getContactEmployeeColor(contact.assigned_to);
  card.style.borderLeftColor = empColor;
  
  var name=((contact.first_name||'')+' '+(contact.last_name||'')).trim()||contact.full_name||'Unknown';
  var stage=contact.funnel_stage||1;
  
  // Progress dots
  var dotsHtml='';
  for(var i=1;i<=6;i++){
    var dotClass='progress-dot';
    if(i<stage)dotClass+=' completed';
    if(i===stage)dotClass+=' current';
    dotsHtml+='<div class="'+dotClass+'" data-stage="'+i+'" title="'+STAGES[i].name+'"></div>';
  }
  
  // Assigned employee info
  var assignedHtml = '';
  if (contact.assigned_to) {
    var empName = getEmployeeNameById(contact.assigned_to);
    assignedHtml = '<div class="contact-assigned"><span class="contact-assigned-dot" style="background:'+empColor+'"></span>'+empName+'</div>';
  }
  
  card.innerHTML='<div class="contact-card-header"><div><div class="contact-name">'+name+'</div>'+(contact.company?'<div class="contact-company">'+contact.company+'</div>':'')+'</div><span class="contact-type">'+(contact.contact_type||'prospect')+'</span></div>'+assignedHtml+'<div class="contact-info">'+(contact.phone?'<div class="contact-info-item"><a href="tel:'+contact.phone+'" onclick="event.stopPropagation()">'+contact.phone+'</a></div>':'')+(contact.email?'<div class="contact-info-item"><a href="mailto:'+contact.email+'" onclick="event.stopPropagation()">'+contact.email+'</a></div>':'')+'</div><div class="progress-dots">'+dotsHtml+'<span class="progress-label">'+STAGES[stage].name+'</span></div>';
  
  card.addEventListener('dragstart',function(e){
    draggedCard=this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain',contact.customer_id||contact.id);
  });
  card.addEventListener('dragend',function(){
    this.classList.remove('dragging');
    document.querySelectorAll('.funnel-cards').forEach(function(col){col.classList.remove('drag-over');});
  });
  card.addEventListener('click',function(){openContactDetail(contact);});
  return card;
}

function toggleColumn(stage){var col=document.querySelector('.funnel-column[data-stage="'+stage+'"]');if(col)col.classList.toggle('collapsed');}
function expandAllColumns(){document.querySelectorAll('.funnel-column').forEach(function(c){c.classList.remove('collapsed');});}
function collapseAllColumns(){document.querySelectorAll('.funnel-column').forEach(function(c){c.classList.add('collapsed');});}

function allowDrop(e){e.preventDefault();}
function dragEnter(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function dragLeave(e){e.currentTarget.classList.remove('drag-over');}

async function drop(e,newStage){e.preventDefault();e.currentTarget.classList.remove('drag-over');if(!draggedCard)return;var contactId=draggedCard.dataset.id;var contact=allContacts.find(function(c){return c.customer_id==contactId;});if(contact&&contact.funnel_stage!==newStage){contact.funnel_stage=newStage;renderContacts();updateStats();var r=await sb.from('customers').update({funnel_stage:newStage}).eq('customer_id',contact.customer_id).select();if(r.error){alert('Error saving: '+r.error.message);}}draggedCard=null;}

function filterContacts(){renderContacts();}

function updateStats(){var counts={1:0,2:0,3:0,4:0,5:0,6:0};allContacts.forEach(function(c){counts[c.funnel_stage||1]++;});document.getElementById('statTotal').textContent=allContacts.length;for(var i=1;i<=6;i++)document.getElementById('stat'+i).textContent=counts[i];}

function populateAssignDropdowns(){
  var contactSelect = document.getElementById('contactAssignTo');
  var eventSelect = document.getElementById('eventAssign');
  
  var optionsHtml = '<option value="">-- Unassigned --</option>';
  allEmployees.forEach(function(emp){
    var name = ((emp.first_name||'') + ' ' + (emp.last_name||'')).trim() || emp.email || 'Unknown';
    optionsHtml += '<option value="'+emp.employee_id+'">'+name+'</option>';
  });
  
  if(contactSelect) contactSelect.innerHTML = optionsHtml;
  if(eventSelect) eventSelect.innerHTML = optionsHtml;
}

function openNewContactModal(){
  document.getElementById('contactFirstName').value='';
  document.getElementById('contactLastName').value='';
  document.getElementById('contactPhone').value='';
  document.getElementById('contactEmail').value='';
  document.getElementById('contactOrganization').value='';
  document.getElementById('contactClientType').value='';
  document.getElementById('contactStage').value='1';
  document.getElementById('contactAssignTo').value='';
  document.getElementById('contactBirthday').value='';
  document.getElementById('contactAnniversary').value='';
  document.getElementById('contactNotes').value='';
  populateAssignDropdowns();
  document.getElementById('newContactModal').classList.add('active');
}
function closeNewContactModal(){document.getElementById('newContactModal').classList.remove('active');}

async function saveNewContact(){
  var firstName=document.getElementById('contactFirstName').value.trim();
  var lastName=document.getElementById('contactLastName').value.trim();
  var phone=document.getElementById('contactPhone').value.trim();
  var email=document.getElementById('contactEmail').value.trim();
  var org=document.getElementById('contactOrganization').value.trim();
  var clientType=document.getElementById('contactClientType').value;
  var stage=document.getElementById('contactStage').value;
  var assignTo=document.getElementById('contactAssignTo').value;
  var birthday=document.getElementById('contactBirthday').value;
  var anniversary=document.getElementById('contactAnniversary').value;
  var notes=document.getElementById('contactNotes').value.trim();
  
  if(!firstName||!lastName){alert('Enter first and last name');return;}
  if(!phone){alert('Enter phone number');return;}
  if(!email){alert('Enter email address');return;}
  
  try{
    var contactData={
      tenant_id:currentTenantId,
      first_name:firstName,
      last_name:lastName,
      full_name:firstName+' '+lastName,
      phone:phone,
      email:email,
      customer_type:clientType||'prospect',
      funnel_stage:parseInt(stage)||1,
      created_at:new Date().toISOString()
    };
    
    if(org) contactData.organization_name=org;
    if(notes) contactData.notes=notes;
    if(assignTo) contactData.assigned_to=assignTo;
    if(birthday) contactData.birthday=birthday;
    if(anniversary) contactData.anniversary=anniversary;
    
    var r=await sb.from('customers').insert(contactData).select().single();
    if(r.error)throw r.error;
    await incrementStat('contacts_added');
    closeNewContactModal();
    await loadContacts();
  }catch(e){
    alert('Error: '+(e.message||'Failed to save'));
  }
}

async function incrementStat(statName,amount){if(!currentUserId||!currentTenantId)return;amount=amount||1;var r=await sb.from('user_stats').select('*').eq('user_id',currentUserId).single();var stats=r.data;if(!stats){stats={user_id:currentUserId,tenant_id:currentTenantId};stats[statName]=amount;await sb.from('user_stats').insert(stats);}else{var update={};update[statName]=(stats[statName]||0)+amount;update.updated_at=new Date().toISOString();await sb.from('user_stats').update(update).eq('user_id',currentUserId);}}

function formatDate(dateStr) {
  if (!dateStr) return '—';
  var d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatDateForInput(dateStr) {
  if (!dateStr) return '';
  return dateStr.split('T')[0];
}

var currentEditingContact = null;

function buildAssignDropdownOptions(selectedId) {
  var html = '<option value="">-- Unassigned --</option>';
  allEmployees.forEach(function(emp) {
    var name = ((emp.first_name||'') + ' ' + (emp.last_name||'')).trim() || emp.email || 'Unknown';
    var selected = emp.employee_id === selectedId ? ' selected' : '';
    html += '<option value="'+emp.employee_id+'"'+selected+'>'+name+'</option>';
  });
  return html;
}

function openContactDetail(contact){
  currentEditingContact = contact;
  var name=((contact.first_name||'')+' '+(contact.last_name||'')).trim()||contact.full_name||'Unknown';
  var initials=name.split(' ').map(function(n){return n[0]||'';}).join('').toUpperCase().slice(0,2)||'U';
  var stage=contact.funnel_stage||1;
  var empColor = getContactEmployeeColor(contact.assigned_to);
  
  // Check if user is admin/owner (can delete)
  var managementRoles = ['owner', 'admin'];
  var isAdmin = managementRoles.includes(currentUserRole);
  var deleteBtn = isAdmin ? '<button class="btn-danger" onclick="deleteContact(\''+contact.customer_id+'\')">Delete Contact</button>' : '';
  
  document.getElementById('contactDetailBody').innerHTML=
    '<div class="contact-detail-header">'+
      '<div class="contact-detail-avatar" style="border-color:'+empColor+'">'+initials+'</div>'+
      '<div class="contact-detail-name">'+name+'</div>'+
      (contact.organization_name?'<div class="contact-detail-company">'+contact.organization_name+'</div>':'')+
      '<div class="contact-actions">'+
        (contact.phone?'<a href="tel:'+contact.phone+'" class="contact-action-btn">Call</a><a href="sms:'+contact.phone+'" class="contact-action-btn">Text</a>':'')+
        (contact.email?'<a href="mailto:'+contact.email+'" class="contact-action-btn">Email</a>':'')+
      '</div>'+
    '</div>'+
    
    '<div class="contact-section">'+
      '<div class="contact-section-title">Basic Info</div>'+
      '<div class="form-row" style="margin-bottom:12px;">'+
        '<div class="form-group" style="margin-bottom:0;"><label class="form-label">First Name</label><input type="text" class="form-input" id="editFirstName" value="'+(contact.first_name||'')+'"></div>'+
        '<div class="form-group" style="margin-bottom:0;"><label class="form-label">Last Name</label><input type="text" class="form-input" id="editLastName" value="'+(contact.last_name||'')+'"></div>'+
      '</div>'+
      '<div class="form-group"><label class="form-label">Organization</label><input type="text" class="form-input" id="editOrganization" value="'+(contact.organization_name||'')+'"></div>'+
    '</div>'+
    
    '<div class="contact-section">'+
      '<div class="contact-section-title">Contact Info</div>'+
      '<div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="editPhone" value="'+(contact.phone||'')+'"></div>'+
      '<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="editEmail" value="'+(contact.email||'')+'"></div>'+
    '</div>'+
    
    '<div class="contact-section">'+
      '<div class="contact-section-title">Classification</div>'+
      '<div class="form-row" style="margin-bottom:12px;">'+
        '<div class="form-group" style="margin-bottom:0;">'+
          '<label class="form-label">Client Type</label>'+
          '<select class="form-select" id="editClientType">'+
            '<option value="">-- Select --</option>'+
            '<option value="RC"'+(contact.customer_type==='RC'?' selected':'')+'>RC</option>'+
            '<option value="HOG"'+(contact.customer_type==='HOG'?' selected':'')+'>HOG</option>'+
            '<option value="Independent"'+(contact.customer_type==='Independent'?' selected':'')+'>Independent</option>'+
            '<option value="Other"'+(contact.customer_type==='Other'?' selected':'')+'>Other</option>'+
            '<option value="prospect"'+(contact.customer_type==='prospect'?' selected':'')+'>Prospect</option>'+
          '</select>'+
        '</div>'+
        '<div class="form-group" style="margin-bottom:0;">'+
          '<label class="form-label">Assigned To</label>'+
          '<select class="form-select" id="editAssignedTo">'+buildAssignDropdownOptions(contact.assigned_to)+'</select>'+
        '</div>'+
      '</div>'+
    '</div>'+
    
    '<div class="contact-section">'+
      '<div class="contact-section-title">Funnel Stage</div>'+
      '<div class="stage-selector">'+
        [1,2,3,4,5,6].map(function(s){
          return '<button type="button" class="stage-option '+(s===stage?'active':'')+'" data-stage="'+s+'" onclick="selectStageInEdit('+s+')">'+STAGES[s].name+'</button>';
        }).join('')+
      '</div>'+
      '<input type="hidden" id="editFunnelStage" value="'+stage+'">'+
    '</div>'+
    
    '<div class="contact-section">'+
      '<div class="contact-section-title">Important Dates</div>'+
      '<div class="form-row">'+
        '<div class="form-group" style="margin-bottom:0;"><label class="form-label">Birthday</label><input type="date" class="form-input" id="editBirthday" value="'+formatDateForInput(contact.birthday)+'"></div>'+
        '<div class="form-group" style="margin-bottom:0;"><label class="form-label">Anniversary</label><input type="date" class="form-input" id="editAnniversary" value="'+formatDateForInput(contact.anniversary)+'"></div>'+
      '</div>'+
    '</div>'+
    
    '<div class="contact-section">'+
      '<div class="contact-section-title">Notes</div>'+
      '<textarea class="form-textarea" id="editNotes" placeholder="Additional notes...">'+(contact.notes||'')+'</textarea>'+
    '</div>'+
    
    '<div class="contact-section" style="padding-top:16px;border-top:1px solid var(--border-default);display:flex;flex-direction:column;gap:12px;">'+
      '<button class="btn-primary" style="width:100%;padding:12px;" onclick="saveContactChanges()">Save Changes</button>'+
      '<a href="sharklaw-profiles.html?id='+contact.customer_id+'" class="btn-secondary" style="width:100%;padding:12px;text-align:center;text-decoration:none;display:block;">View Full Profile</a>'+
      deleteBtn+
    '</div>';
  
  document.getElementById('contactDetailModal').classList.add('active');
}

function selectStageInEdit(stage) {
  document.getElementById('editFunnelStage').value = stage;
  document.querySelectorAll('#contactDetailBody .stage-option').forEach(function(btn) {
    btn.classList.remove('active');
    if (parseInt(btn.dataset.stage) === stage) {
      btn.classList.add('active');
    }
  });
}

async function saveContactChanges() {
  if (!currentEditingContact) return;
  
  var updateData = {
    first_name: document.getElementById('editFirstName').value.trim(),
    last_name: document.getElementById('editLastName').value.trim(),
    organization_name: document.getElementById('editOrganization').value.trim() || null,
    phone: document.getElementById('editPhone').value.trim(),
    email: document.getElementById('editEmail').value.trim(),
    customer_type: document.getElementById('editClientType').value || 'prospect',
    assigned_to: document.getElementById('editAssignedTo').value || null,
    funnel_stage: parseInt(document.getElementById('editFunnelStage').value) || 1,
    birthday: document.getElementById('editBirthday').value || null,
    anniversary: document.getElementById('editAnniversary').value || null,
    notes: document.getElementById('editNotes').value.trim() || null,
    updated_at: new Date().toISOString()
  };
  
  // Update full_name
  updateData.full_name = (updateData.first_name + ' ' + updateData.last_name).trim();
  
  try {
    var r = await sb.from('customers')
      .update(updateData)
      .eq('customer_id', currentEditingContact.customer_id)
      .select()
      .single();
    
    if (r.error) throw r.error;
    
    // Update local data
    var idx = allContacts.findIndex(function(c) { return c.customer_id === currentEditingContact.customer_id; });
    if (idx >= 0) {
      allContacts[idx] = Object.assign(allContacts[idx], updateData);
    }
    
    closeContactDetailModal();
    renderContacts();
    updateStats();
    showToast('Contact saved!');
  } catch(e) {
    alert('Error saving: ' + (e.message || 'Unknown error'));
  }
}

async function deleteContact(contactId) {
  if (!confirm('Are you sure you want to delete this contact?')) return;
  
  try {
    // Soft delete - set is_deleted flag
    var r = await sb.from('customers')
      .update({ 
        is_deleted: true,
        deleted_at: new Date().toISOString()
      })
      .eq('customer_id', contactId);
    
    if (r.error) throw r.error;
    
    // Remove from local data
    allContacts = allContacts.filter(function(c) { return c.customer_id !== contactId; });
    
    closeContactDetailModal();
    renderContacts();
    updateStats();
    showToast('Contact deleted');
  } catch(e) {
    alert('Error deleting: ' + (e.message || 'Unknown error'));
  }
}

function showToast(msg) {
  var toast = document.getElementById('themeToast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2000);
}
function closeContactDetailModal(){document.getElementById('contactDetailModal').classList.remove('active');}

function importCSV(event){var file=event.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=async function(e){var lines=e.target.result.split('\n');var imported=0;for(var i=1;i<lines.length;i++){var vals=lines[i].split(',').map(function(v){return v.trim().replace(/^"|"$/g,'');});if(vals.length>=2&&vals[0]){await sb.from('customers').insert({tenant_id:currentTenantId,first_name:vals[0],last_name:vals[1]||'',phone:vals[2]||'',email:vals[3]||null,company:vals[4]||null,customer_type:'prospect',funnel_stage:1});imported++;}}alert('Imported '+imported+' contacts!');await loadContacts();};reader.readAsText(file);event.target.value='';}

function openNewEventModal(){
  document.getElementById('eventModalTitle').textContent='New Event';
  document.getElementById('eventTitle').value='';
  document.getElementById('eventOrganization').value='';
  document.getElementById('eventType').value='';
  document.getElementById('eventTicketPrice').value='';
  document.getElementById('eventAttendance').value='';
  document.getElementById('eventLocation').value='';
  document.getElementById('eventAssign').value='';
  document.getElementById('eventNotes').value='';
  document.getElementById('eventDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('eventTime').value='10:00';
  populateAssignDropdowns();
  document.getElementById('newEventModal').classList.add('active');
}
function closeNewEventModal(){document.getElementById('newEventModal').classList.remove('active');}

async function saveNewEvent(){
  var title=document.getElementById('eventTitle').value.trim();
  var date=document.getElementById('eventDate').value;
  if(!title){alert('Enter event title');return;}
  if(!date){alert('Select a date');return;}
  try{
    var assignId=document.getElementById('eventAssign').value;
    var eventData={
      tenant_id:currentTenantId,
      event_name:title,
      description:document.getElementById('eventOrganization').value.trim()||null,
      event_date:date,
      event_time:document.getElementById('eventTime').value||null,
      event_type:document.getElementById('eventType').value||null,
      estimated_cost:parseFloat(document.getElementById('eventTicketPrice').value)||null,
      mileage:parseInt(document.getElementById('eventAttendance').value)||null,
      location:document.getElementById('eventLocation').value.trim()||null,
      notes:document.getElementById('eventNotes').value.trim()||null,
      created_at:new Date().toISOString()
    };
    if(assignId) eventData.assigned_to=assignId;
    var r=await sb.from('events').insert(eventData).select().single();
    if(r.error)throw r.error;
    closeNewEventModal();
    alert('Event created!');
  }catch(e){
    alert('Error: '+(e.message||'Failed to save'));
  }
}

async function checkAuth(){
  var r=await sb.auth.getSession();
  var session=r.data.session;
  if(!session){
    var token=localStorage.getItem('sb_access_token'),refresh=localStorage.getItem('sb_refresh_token');
    if(token&&refresh){
      var sr=await sb.auth.setSession({access_token:token,refresh_token:refresh});
      session=sr.data?.session;
    }
    if(!session){window.location.href='login.html';return null;}
  }
  currentUserId=session.user.id;
  userEmail=session.user.email;
  return session;
}

function updateEmailDisplay(){
  if(userEmail){
    document.getElementById('desktopBusinessName').textContent=userEmail;
    document.getElementById('mobileBusinessName').textContent=userEmail;
  }
}

async function loadEmployees(){
  if(!currentTenantId)return;
  var r=await sb.from('employees')
    .select('employee_id, first_name, last_name, email, color, role')
    .eq('tenant_id',currentTenantId)
    .or('is_active.is.null,is_active.eq.true')
    .order('last_name');
  allEmployees=r.data||[];
}

async function init(){
  var session=await checkAuth();
  if(!session)return;
  var email=session.user?.email;
  if(email){
    var r=await sb.from('users').select('*').eq('email',email).single();
    if(r.data?.tenant_id){
      currentTenantId=r.data.tenant_id;
      currentUserId=r.data.user_id;
      currentUserRole=r.data.role||null;
    }
  }
  if(!currentTenantId){
    var r=await sb.from('business_settings').select('tenant_id').limit(1).single();
    if(r.data?.tenant_id)currentTenantId=r.data.tenant_id;
  }
  if(!currentTenantId){console.error('No tenant');return;}
  
  // Also check employees table for role if not set
  if(!currentUserRole && email){
    var empR=await sb.from('employees').select('role').eq('email',email).single();
    if(empR.data?.role) currentUserRole=empR.data.role;
  }
  
  updateEmailDisplay();
  await loadUserThemeBank();
  await loadEmployees();
  await loadContacts();
}

init();
</script>
</body>
</html>
