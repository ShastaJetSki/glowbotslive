<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SharkLaw - Contacts</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044;
      --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3;
      --accent-primary: #3b82f6; --accent-light: #60a5fa;
      --funnel-1: #3b82f6; --funnel-2: #8b5cf6; --funnel-3: #f59e0b; --funnel-4: #10b981; --funnel-5: #ef4444;
    }
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="slate"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #6366f1; --accent-light: #818cf8; }
    [data-theme="midnight"] { --bg-primary: #09090b; --bg-secondary: #0f0f12; --bg-card: #18181d; --bg-hover: #222228; --border-default: #27272f; --text-primary: #eeeef0; --text-secondary: #9898a4; --accent-primary: #8b5cf6; --accent-light: #a78bfa; }
    [data-theme="ocean"] { --bg-primary: #0a1214; --bg-secondary: #0e181c; --bg-card: #152228; --bg-hover: #1c2d35; --border-default: #243842; --text-primary: #e5f0f3; --text-secondary: #8faab5; --accent-primary: #14b8a6; --accent-light: #2dd4bf; }
    [data-theme="light-blue"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #2563eb; --accent-light: #3b82f6; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); min-height: 100%; }
    body { font-family: system-ui; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .theme-toggle-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .theme-toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .theme-toggle-btn svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
    
    .mobile-top-header { display: none; position: sticky; top: 0; z-index: 100; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .mobile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px; gap: 12px; }
    .mobile-menu-toggle { background: transparent; border: none; color: var(--text-secondary); font-size: 20px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .mobile-header-center { flex: 1; }
    .mobile-header-title { font-size: 18px; font-weight: 600; }
    .business-name { font-size: 12px; color: var(--accent-light); }
    .mobile-header-right { display: flex; align-items: center; gap: 12px; }
    
    .desktop-header { position: sticky; top: 0; z-index: 100; background: var(--bg-primary); border-bottom: 1px solid var(--border-default); }

    /* Search and Filter Bar */
    .toolbar { padding: 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); }
    .toolbar-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; }
    .search-box:focus { outline: none; border-color: var(--accent-primary); }
    .filter-btn { padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .filter-btn:hover { background: var(--bg-hover); }
    .filter-btn.active { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: var(--accent-primary); color: var(--accent-light); }
    .add-btn { padding: 10px 16px; border-radius: 8px; border: none; background: var(--accent-primary); color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .add-btn:hover { background: var(--accent-light); }

    /* Quick Stats */
    .quick-stats { display: flex; gap: 12px; padding: 12px; background: var(--bg-secondary); overflow-x: auto; }
    .stat-card { flex: 1; min-width: 100px; padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-default); text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--text-primary); }
    .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }

    /* Quick Capture Section */
    .quick-capture { background: var(--bg-card); border-radius: 12px; padding: 16px; margin: 12px; border: 1px solid var(--border-default); }
    .quick-capture-title { font-size: 14px; font-weight: 600; color: var(--accent-light); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .quick-capture-form { display: flex; gap: 8px; flex-wrap: wrap; }
    .quick-input { flex: 1; min-width: 150px; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; }
    .quick-input:focus { outline: none; border-color: var(--accent-primary); }
    .quick-submit { padding: 10px 20px; border-radius: 8px; border: none; background: var(--accent-primary); color: #fff; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .quick-submit:hover { background: var(--accent-light); }

    /* Funnel View */
    .funnel-container { display: flex; gap: 12px; padding: 12px; overflow-x: auto; min-height: calc(100vh - 380px); }
    .funnel-column { flex: 1; min-width: 260px; max-width: 300px; background: var(--bg-secondary); border-radius: 12px; display: flex; flex-direction: column; }
    .funnel-header { padding: 12px 16px; border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
    .funnel-title { font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
    .funnel-dot { width: 10px; height: 10px; border-radius: 50%; }
    .funnel-count { font-size: 12px; color: var(--text-secondary); background: var(--bg-hover); padding: 2px 8px; border-radius: 10px; }
    .funnel-cards { flex: 1; padding: 8px; overflow-y: auto; min-height: 150px; }
    .funnel-cards.drag-over { background: color-mix(in srgb, var(--accent-primary) 10%, transparent); border-radius: 8px; }

    /* Contact Cards */
    .contact-card { background: var(--bg-card); border-radius: 10px; padding: 12px; margin-bottom: 8px; cursor: grab; border: 1px solid var(--border-default); transition: all 0.2s; }
    .contact-card:hover { border-color: var(--accent-primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .contact-card.dragging { opacity: 0.5; cursor: grabbing; }
    .contact-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .contact-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .contact-company { font-size: 12px; color: var(--text-secondary); }
    .contact-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--bg-hover); color: var(--text-secondary); text-transform: uppercase; }
    .contact-info { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
    .contact-info-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .contact-info-item a { color: var(--accent-light); text-decoration: none; }
    .contact-info-item a:hover { text-decoration: underline; }
    
    /* Progress Dots - KEY FEATURE */
    .progress-dots { display: flex; gap: 6px; align-items: center; padding-top: 8px; border-top: 1px solid var(--border-default); }
    .progress-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--border-default); background: transparent; transition: all 0.3s; }
    .progress-dot.completed { border-color: currentColor; background: currentColor; }
    .progress-dot.current { border-color: currentColor; box-shadow: 0 0 0 3px color-mix(in srgb, currentColor 30%, transparent); animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 3px color-mix(in srgb, currentColor 30%, transparent); }
      50% { box-shadow: 0 0 0 6px color-mix(in srgb, currentColor 10%, transparent); }
    }
    .progress-dot[data-stage="1"] { color: var(--funnel-1); }
    .progress-dot[data-stage="2"] { color: var(--funnel-2); }
    .progress-dot[data-stage="3"] { color: var(--funnel-3); }
    .progress-dot[data-stage="4"] { color: var(--funnel-4); }
    .progress-dot[data-stage="5"] { color: var(--funnel-5); }
    .progress-label { font-size: 10px; color: var(--text-secondary); margin-left: auto; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-default); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-default); }
    .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-primary); font-size: 14px; }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border-default); }
    .btn-secondary { padding: 10px 20px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; cursor: pointer; }
    .btn-primary { padding: 10px 20px; border-radius: 6px; border: none; background: var(--accent-primary); color: #fff; font-size: 14px; font-weight: 500; cursor: pointer; }

    /* Contact Detail Modal */
    .contact-detail-header { text-align: center; padding-bottom: 16px; border-bottom: 1px solid var(--border-default); margin-bottom: 16px; }
    .contact-detail-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--bg-hover); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 600; color: var(--accent-light); margin: 0 auto 12px; }
    .contact-detail-name { font-size: 20px; font-weight: 600; }
    .contact-detail-company { font-size: 14px; color: var(--text-secondary); }
    .contact-actions { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
    .contact-action-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; text-decoration: none; }
    .contact-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .contact-section { margin-bottom: 16px; }
    .contact-section-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
    .contact-field { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-default); }
    .contact-field:last-child { border-bottom: none; }
    .contact-field-label { font-size: 13px; color: var(--text-secondary); }
    .contact-field-value { font-size: 13px; color: var(--text-primary); }
    .contact-field-value a { color: var(--accent-light); text-decoration: none; }
    .stage-selector { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
    .stage-option { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 12px; cursor: pointer; }
    .stage-option:hover { background: var(--bg-hover); }
    .stage-option.active { border-color: currentColor; background: color-mix(in srgb, currentColor 20%, transparent); }
    .stage-option[data-stage="1"] { color: var(--funnel-1); }
    .stage-option[data-stage="2"] { color: var(--funnel-2); }
    .stage-option[data-stage="3"] { color: var(--funnel-3); }
    .stage-option[data-stage="4"] { color: var(--funnel-4); }
    .stage-option[data-stage="5"] { color: var(--funnel-5); }

    /* Mobile Bottom Nav */
    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 8px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .mobile-nav-row:last-child { margin-bottom: 0; }
    .mobile-nav-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .mobile-nav-btn { padding: 10px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center; min-height: 44px; }
    .mobile-nav-btn:active { transform: scale(0.95); }
    .mobile-nav-btn.active { background: color-mix(in srgb, var(--accent-primary) 60%, transparent); border-color: var(--accent-primary); color: var(--text-primary); }
    .mobile-nav-btn.action-btn { background: color-mix(in srgb, var(--accent-primary) 20%, transparent); border-color: color-mix(in srgb, var(--accent-primary) 50%, transparent); color: var(--accent-light); font-size: 14px; }

    /* Import Section */
    .import-section { background: var(--bg-card); border: 2px dashed var(--border-default); border-radius: 12px; padding: 20px; margin: 12px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .import-section:hover { border-color: var(--accent-primary); background: var(--bg-hover); }
    .import-icon { font-size: 28px; margin-bottom: 8px; }
    .import-text { font-size: 13px; color: var(--text-secondary); }
    .import-text strong { color: var(--accent-light); }

    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block !important; }
      body { padding-bottom: 120px; }
      .funnel-container { flex-direction: column; }
      .funnel-column { max-width: none; min-width: auto; }
      .form-row { grid-template-columns: 1fr; }
      .quick-capture-form { flex-direction: column; }
      .quick-input { min-width: auto; }
    }
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
    }
  </style>
</head>
<body>

<div class="mobile-top-header">
  <div class="mobile-header-bar">
    <a href="dashboard-sharklaw.html" class="mobile-menu-toggle">‚Üê</a>
    <div class="mobile-header-center">
      <div class="mobile-header-title">Contacts</div>
      <div class="business-name">SharkLaw Pipeline</div>
    </div>
    <div class="mobile-header-right">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
    </div>
  </div>
</div>

<div class="desktop-header">
  <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0; font-size:28px; font-weight:600;">üìã Contacts Pipeline</h1>
      <div class="business-name">SharkLaw - Customer Nerve Center</div>
    </div>
    <div style="display:flex; align-items:center; gap:16px;">
      <button class="theme-toggle-btn" onclick="cycleTheme()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px;">Logout</a>
    </div>
  </div>
  <div style="padding:0 24px 12px;">
    <nav style="display:flex; gap:24px;">
      <a href="sharklaw-dashboard.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Dashboard</a>
      <a href="sharklaw-scheduler.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Scheduler</a>
      <a href="sharklaw-contacts.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; border-bottom:2px solid var(--accent-primary);">Contacts</a>
      <a href="sharklaw-swag.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px;">Swag</a>
    </nav>
  </div>
</div>

<!-- Quick Add Section -->
<div class="quick-capture">
  <div class="quick-capture-title">‚ö° Quick Add Contact</div>
  <div class="quick-capture-form">
    <input type="text" class="quick-input" id="quickName" placeholder="Full Name *">
    <input type="tel" class="quick-input" id="quickPhone" placeholder="Phone *">
    <input type="email" class="quick-input" id="quickEmail" placeholder="Email (optional)">
    <button class="quick-submit" onclick="quickAddContact()">+ Add</button>
  </div>
</div>

<!-- Quick Stats -->
<div class="quick-stats">
  <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
  <div class="stat-card"><div class="stat-value" id="stat1">0</div><div class="stat-label">1st Contact</div></div>
  <div class="stat-card"><div class="stat-value" id="stat2">0</div><div class="stat-label">Artwork</div></div>
  <div class="stat-card"><div class="stat-value" id="stat3">0</div><div class="stat-label">Opt-in</div></div>
  <div class="stat-card"><div class="stat-value" id="stat4">0</div><div class="stat-label">Delivered</div></div>
  <div class="stat-card"><div class="stat-value" id="stat5">0</div><div class="stat-label">Leads</div></div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <div class="toolbar-row">
    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search by name, phone, or email..." oninput="filterContacts()">
    <button class="add-btn" onclick="openNewContactModal()">+ New Contact</button>
  </div>
</div>

<!-- Funnel View - Drag and Drop -->
<div class="funnel-container" id="funnelContainer">
  <!-- Stage 1: 1st Contact -->
  <div class="funnel-column" data-stage="1">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-1)"></span> 1st Contact</div>
      <span class="funnel-count" id="count1">0</span>
    </div>
    <div class="funnel-cards" id="stage1" ondragover="allowDrop(event)" ondrop="drop(event, 1)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <!-- Stage 2: Receive Artwork -->
  <div class="funnel-column" data-stage="2">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-2)"></span> Receive Artwork</div>
      <span class="funnel-count" id="count2">0</span>
    </div>
    <div class="funnel-cards" id="stage2" ondragover="allowDrop(event)" ondrop="drop(event, 2)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <!-- Stage 3: Opt-in Contact -->
  <div class="funnel-column" data-stage="3">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-3)"></span> Opt-in Contact</div>
      <span class="funnel-count" id="count3">0</span>
    </div>
    <div class="funnel-cards" id="stage3" ondragover="allowDrop(event)" ondrop="drop(event, 3)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <!-- Stage 4: Deliver Pop Up -->
  <div class="funnel-column" data-stage="4">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-4)"></span> Deliver Pop Up</div>
      <span class="funnel-count" id="count4">0</span>
    </div>
    <div class="funnel-cards" id="stage4" ondragover="allowDrop(event)" ondrop="drop(event, 4)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
  
  <!-- Stage 5: Lead -->
  <div class="funnel-column" data-stage="5">
    <div class="funnel-header">
      <div class="funnel-title"><span class="funnel-dot" style="background:var(--funnel-5)"></span> üéØ Lead</div>
      <span class="funnel-count" id="count5">0</span>
    </div>
    <div class="funnel-cards" id="stage5" ondragover="allowDrop(event)" ondrop="drop(event, 5)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)"></div>
  </div>
</div>

<!-- Import Section -->
<div class="import-section" onclick="document.getElementById('csvInput').click()">
  <div class="import-icon">üì•</div>
  <div class="import-text">Drop a CSV file here or <strong>click to import contacts</strong></div>
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(event)">
</div>

<!-- New Contact Modal -->
<div class="modal-overlay" id="newContactModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">New Contact</div>
      <button class="modal-close" onclick="closeNewContactModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name *</label><input type="text" class="form-input" id="contactFirstName" placeholder="First name"></div>
        <div class="form-group"><label class="form-label">Last Name *</label><input type="text" class="form-input" id="contactLastName" placeholder="Last name"></div>
      </div>
      <div class="form-group"><label class="form-label">Phone *</label><input type="tel" class="form-input" id="contactPhone" placeholder="(555) 123-4567"></div>
      <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="contactEmail" placeholder="email@example.com"></div>
      <div class="form-group"><label class="form-label">Company</label><input type="text" class="form-input" id="contactCompany" placeholder="Company name"></div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-select" id="contactType"><option value="prospect">Prospect</option><option value="client">Client</option><option value="vendor">Vendor</option><option value="referral">Referral</option></select>
        </div>
        <div class="form-group">
          <label class="form-label">Funnel Stage</label>
          <select class="form-select" id="contactStage"><option value="1">1st Contact</option><option value="2">Receive Artwork</option><option value="3">Opt-in Contact</option><option value="4">Deliver Pop Up</option><option value="5">Lead</option></select>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="contactNotes" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeNewContactModal()">Cancel</button>
      <button class="btn-primary" onclick="saveNewContact()">Add Contact</button>
    </div>
  </div>
</div>

<!-- Contact Detail Modal -->
<div class="modal-overlay" id="contactDetailModal">
  <div class="modal-content" style="max-width:550px;">
    <div class="modal-header">
      <div class="modal-title">Contact Details</div>
      <button class="modal-close" onclick="closeContactDetailModal()">&times;</button>
    </div>
    <div class="modal-body" id="contactDetailBody"></div>
  </div>
</div>

<!-- Event Modal -->
<div class="modal-overlay" id="newEventModal">
  <div class="modal-content">
    <div class="modal-header"><div class="modal-title">New Event</div><button class="modal-close" onclick="closeNewEventModal()">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Event Title *</label><input type="text" class="form-input" id="eventTitle"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Date *</label><input type="date" class="form-input" id="eventDate"></div>
        <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="eventTime"></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn-secondary" onclick="closeNewEventModal()">Cancel</button><button class="btn-primary" onclick="saveNewEvent()">Create</button></div>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<div class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="sharklaw-dashboard.html" class="mobile-nav-btn">Dashboard</a>
    <a href="sharklaw-scheduler.html" class="mobile-nav-btn">Scheduler</a>
  </div>
  <div class="mobile-nav-row three-col">
    <button class="mobile-nav-btn action-btn" onclick="openNewEventModal()">+ Event</button>
    <button class="mobile-nav-btn action-btn" onclick="openNewContactModal()">+ Contact</button>
    <a href="sharklaw-contacts.html" class="mobile-nav-btn active">Contacts</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUserId = null, currentTenantId = null;
let allContacts = [];
let draggedCard = null;

const STAGES = {
  1: { name: '1st Contact', color: 'var(--funnel-1)' },
  2: { name: 'Receive Artwork', color: 'var(--funnel-2)' },
  3: { name: 'Opt-in Contact', color: 'var(--funnel-3)' },
  4: { name: 'Deliver Pop Up', color: 'var(--funnel-4)' },
  5: { name: 'Lead', color: 'var(--funnel-5)' }
};

// Theme
var themes = ['dark-blue', 'slate', 'midnight', 'ocean', 'light-blue'];
var themeIndex = 0;
function loadTheme() { var t = localStorage.getItem('app-theme') || 'dark-blue'; document.documentElement.setAttribute('data-theme', t); themeIndex = themes.indexOf(t); if (themeIndex < 0) themeIndex = 0; }
function cycleTheme() { themeIndex = (themeIndex + 1) % themes.length; var t = themes[themeIndex]; document.documentElement.setAttribute('data-theme', t); localStorage.setItem('app-theme', t); }
loadTheme();

async function logout() { await sb.auth.signOut(); localStorage.clear(); location.replace("login.html"); }

// Load contacts
async function loadContacts() {
  if (!currentTenantId) return;
  const { data } = await sb.from('customers').select('*').eq('tenant_id', currentTenantId).order('created_at', { ascending: false });
  allContacts = (data || []).map(c => ({ ...c, funnel_stage: c.funnel_stage || 1 }));
  renderContacts();
  updateStats();
}

// Render contacts to funnel columns
function renderContacts() {
  // Clear columns
  for (let i = 1; i <= 5; i++) document.getElementById('stage' + i).innerHTML = '';
  
  const searchTerm = (document.getElementById('searchBox').value || '').toLowerCase();
  const stageCounts = {1:0, 2:0, 3:0, 4:0, 5:0};
  
  allContacts.forEach(contact => {
    const name = `${contact.first_name || ''} ${contact.last_name || ''}`.toLowerCase();
    const matchesSearch = !searchTerm || name.includes(searchTerm) || (contact.phone || '').includes(searchTerm) || (contact.email || '').toLowerCase().includes(searchTerm);
    
    if (matchesSearch) {
      const stage = contact.funnel_stage || 1;
      stageCounts[stage]++;
      const card = createContactCard(contact);
      document.getElementById('stage' + stage).appendChild(card);
    }
  });
  
  // Update column counts
  for (let i = 1; i <= 5; i++) document.getElementById('count' + i).textContent = stageCounts[i];
}

// Create draggable contact card with progress dots
function createContactCard(contact) {
  const card = document.createElement('div');
  card.className = 'contact-card';
  card.draggable = true;
  card.dataset.id = contact.customer_id || contact.id;
  
  const name = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'Unknown';
  const stage = contact.funnel_stage || 1;
  
  // Build progress dots HTML - key feature!
  let dotsHtml = '';
  for (let i = 1; i <= 5; i++) {
    let dotClass = 'progress-dot';
    if (i < stage) dotClass += ' completed';
    if (i === stage) dotClass += ' current';
    dotsHtml += `<div class="${dotClass}" data-stage="${i}" title="${STAGES[i].name}"></div>`;
  }
  
  card.innerHTML = `
    <div class="contact-card-header">
      <div>
        <div class="contact-name">${name}</div>
        ${contact.company ? `<div class="contact-company">${contact.company}</div>` : ''}
      </div>
      <span class="contact-type">${contact.contact_type || 'prospect'}</span>
    </div>
    <div class="contact-info">
      ${contact.phone ? `<div class="contact-info-item">üì± <a href="tel:${contact.phone}" onclick="event.stopPropagation()">${contact.phone}</a></div>` : ''}
      ${contact.email ? `<div class="contact-info-item">‚úâÔ∏è <a href="mailto:${contact.email}" onclick="event.stopPropagation()">${contact.email}</a></div>` : ''}
    </div>
    <div class="progress-dots">
      ${dotsHtml}
      <span class="progress-label">${STAGES[stage].name}</span>
    </div>
  `;
  
  // Drag events
  card.addEventListener('dragstart', function(e) {
    draggedCard = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', contact.customer_id || contact.id);
  });
  
  card.addEventListener('dragend', function() {
    this.classList.remove('dragging');
    document.querySelectorAll('.funnel-cards').forEach(col => col.classList.remove('drag-over'));
  });
  
  // Click to open detail
  card.addEventListener('click', function() { openContactDetail(contact); });
  
  return card;
}

// Drag and drop handlers
function allowDrop(e) { e.preventDefault(); }
function dragEnter(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function dragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

async function drop(e, newStage) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  
  if (!draggedCard) return;
  const contactId = draggedCard.dataset.id;
  const contact = allContacts.find(c => (c.customer_id || c.id) == contactId);
  
  if (contact && contact.funnel_stage !== newStage) {
    contact.funnel_stage = newStage;
    await sb.from('customers').update({ funnel_stage: newStage }).eq('customer_id', contactId);
    renderContacts();
    updateStats();
  }
  draggedCard = null;
}

// Search filter
function filterContacts() { renderContacts(); }

// Update stats
function updateStats() {
  const counts = {1:0, 2:0, 3:0, 4:0, 5:0};
  allContacts.forEach(c => { counts[c.funnel_stage || 1]++; });
  document.getElementById('statTotal').textContent = allContacts.length;
  for (let i = 1; i <= 5; i++) document.getElementById('stat' + i).textContent = counts[i];
}

// Quick add contact
async function quickAddContact() {
  const name = document.getElementById('quickName').value.trim();
  const phone = document.getElementById('quickPhone').value.trim();
  const email = document.getElementById('quickEmail').value.trim();
  
  if (!name || !phone) { alert('Name and phone are required'); return; }
  
  const parts = name.split(' ');
  const newContact = {
    tenant_id: currentTenantId,
    first_name: parts[0],
    last_name: parts.slice(1).join(' ') || '',
    phone: phone,
    email: email || null,
    contact_type: 'prospect',
    funnel_stage: 1,
    created_by: currentUserId
  };
  
  const { error } = await sb.from('customers').insert(newContact);
  if (error) { alert('Error: ' + error.message); return; }
  
  document.getElementById('quickName').value = '';
  document.getElementById('quickPhone').value = '';
  document.getElementById('quickEmail').value = '';
  
  await loadContacts();
}

// New contact modal
function openNewContactModal() { document.getElementById('newContactModal').classList.add('active'); }
function closeNewContactModal() { document.getElementById('newContactModal').classList.remove('active'); }

async function saveNewContact() {
  const firstName = document.getElementById('contactFirstName').value.trim();
  const lastName = document.getElementById('contactLastName').value.trim();
  const phone = document.getElementById('contactPhone').value.trim();
  
  if (!firstName || !lastName || !phone) { alert('First name, last name, and phone required'); return; }
  
  const { error } = await sb.from('customers').insert({
    tenant_id: currentTenantId,
    first_name: firstName,
    last_name: lastName,
    phone: phone,
    email: document.getElementById('contactEmail').value.trim() || null,
    company: document.getElementById('contactCompany').value.trim() || null,
    contact_type: document.getElementById('contactType').value,
    funnel_stage: parseInt(document.getElementById('contactStage').value),
    notes: document.getElementById('contactNotes').value.trim() || null,
    created_by: currentUserId
  });
  
  if (error) { alert('Error: ' + error.message); return; }
  closeNewContactModal();
  await loadContacts();
}

// Contact detail modal
function openContactDetail(contact) {
  const name = `${contact.first_name || ''} ${contact.last_name || ''}`.trim() || 'Unknown';
  const initials = `${(contact.first_name || 'U')[0]}${(contact.last_name || '')[0] || ''}`.toUpperCase();
  const stage = contact.funnel_stage || 1;
  
  document.getElementById('contactDetailBody').innerHTML = `
    <div class="contact-detail-header">
      <div class="contact-detail-avatar">${initials}</div>
      <div class="contact-detail-name">${name}</div>
      ${contact.company ? `<div class="contact-detail-company">${contact.company}</div>` : ''}
      <div class="contact-actions">
        ${contact.phone ? `<a href="tel:${contact.phone}" class="contact-action-btn">üì± Call</a><a href="sms:${contact.phone}" class="contact-action-btn">üí¨ Text</a>` : ''}
        ${contact.email ? `<a href="mailto:${contact.email}" class="contact-action-btn">‚úâÔ∏è Email</a>` : ''}
      </div>
    </div>
    
    <div class="contact-section">
      <div class="contact-section-title">Move in Funnel</div>
      <div class="stage-selector">
        ${[1,2,3,4,5].map(s => `<button class="stage-option ${s === stage ? 'active' : ''}" data-stage="${s}" onclick="changeStage('${contact.customer_id||contact.id}', ${s})">${STAGES[s].name}</button>`).join('')}
      </div>
    </div>
    
    <div class="contact-section">
      <div class="contact-section-title">Contact Info</div>
      <div class="contact-field"><span class="contact-field-label">Phone</span><span class="contact-field-value">${contact.phone ? `<a href="tel:${contact.phone}">${contact.phone}</a>` : '‚Äî'}</span></div>
      <div class="contact-field"><span class="contact-field-label">Email</span><span class="contact-field-value">${contact.email ? `<a href="mailto:${contact.email}">${contact.email}</a>` : '‚Äî'}</span></div>
      <div class="contact-field"><span class="contact-field-label">Company</span><span class="contact-field-value">${contact.company || '‚Äî'}</span></div>
      <div class="contact-field"><span class="contact-field-label">Type</span><span class="contact-field-value">${contact.contact_type || 'prospect'}</span></div>
      <div class="contact-field"><span class="contact-field-label">Added</span><span class="contact-field-value">${contact.created_at ? new Date(contact.created_at).toLocaleDateString() : '‚Äî'}</span></div>
    </div>
    ${contact.notes ? `<div class="contact-section"><div class="contact-section-title">Notes</div><p style="font-size:13px;color:var(--text-secondary);">${contact.notes}</p></div>` : ''}
  `;
  document.getElementById('contactDetailModal').classList.add('active');
}

function closeContactDetailModal() { document.getElementById('contactDetailModal').classList.remove('active'); }

async function changeStage(contactId, newStage) {
  const contact = allContacts.find(c => (c.customer_id || c.id) == contactId);
  if (contact) {
    contact.funnel_stage = newStage;
    await sb.from('customers').update({ funnel_stage: newStage }).eq('customer_id', contactId);
    renderContacts();
    updateStats();
    openContactDetail(contact);
  }
}

// CSV Import
function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    const lines = e.target.result.split('\n');
    let imported = 0;
    
    for (let i = 1; i < lines.length; i++) {
      const vals = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      if (vals.length >= 2 && vals[0]) {
        await sb.from('customers').insert({
          tenant_id: currentTenantId,
          first_name: vals[0],
          last_name: vals[1] || '',
          phone: vals[2] || '',
          email: vals[3] || null,
          company: vals[4] || null,
          contact_type: 'prospect',
          funnel_stage: 1,
          created_by: currentUserId
        });
        imported++;
      }
    }
    alert(`Imported ${imported} contacts!`);
    await loadContacts();
  };
  reader.readAsText(file);
  event.target.value = '';
}

// Event modal
function openNewEventModal() { document.getElementById('eventDate').value = new Date().toISOString().split('T')[0]; document.getElementById('newEventModal').classList.add('active'); }
function closeNewEventModal() { document.getElementById('newEventModal').classList.remove('active'); }
async function saveNewEvent() {
  const title = document.getElementById('eventTitle').value.trim();
  const date = document.getElementById('eventDate').value;
  if (!title || !date) { alert('Title and date required'); return; }
  await sb.from('events').insert({ tenant_id: currentTenantId, title, event_date: new Date(`${date}T${document.getElementById('eventTime').value || '00:00'}`).toISOString(), created_by: currentUserId });
  closeNewEventModal();
  alert('Event created!');
}

// Auth
async function checkAuth() {
  let { data: { session } } = await sb.auth.getSession();
  if (!session) {
    const token = localStorage.getItem('sb_access_token'), refresh = localStorage.getItem('sb_refresh_token');
    if (token && refresh) { const { data } = await sb.auth.setSession({ access_token: token, refresh_token: refresh }); session = data?.session; }
    if (!session) { window.location.href = 'login.html'; return null; }
  }
  currentUserId = session.user.id;
  return session;
}

// Init
async function init() {
  const session = await checkAuth();
  if (!session) return;
  
  const email = session.user?.email;
  if (email) { const { data } = await sb.from('users').select('*').eq('email', email).single(); if (data?.tenant_id) { currentTenantId = data.tenant_id; currentUserId = data.user_id; } }
  if (!currentTenantId) { const { data } = await sb.from('business_settings').select('tenant_id').limit(1).single(); if (data?.tenant_id) currentTenantId = data.tenant_id; }
  if (!currentTenantId) { console.error('No tenant'); return; }
  
  await loadContacts();
}

init();
</script>
</body>
</html>
