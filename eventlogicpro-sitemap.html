<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Site Maps – Event Logic Pro</title>
  <link rel="icon" href="favicon-eventlogic.ico">
  <link rel="icon" type="image/png" href="favicon-eventlogic-32.png" sizes="32x32">
  <link rel="apple-touch-icon" href="favicon-eventlogic-192.png">
  <meta name="apple-mobile-web-app-title" content="Event Logic Pro">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg-primary:#f4f5f7;--bg-secondary:#ebedf1;--bg-card:#ffffff;--bg-hover:#f0f0f3;
  --border:#e2e4e8;--text-primary:#1a1a1a;--text-secondary:#6b7280;
  --accent:#DC2626;--accent-hover:#B91C1C;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.10);--accent-glow2:rgba(220,38,38,.06);
  --shadow:0 2px 12px rgba(0,0,0,.06);--input-bg:#fafafa;--modal-overlay:rgba(0,0,0,.45);
}
body.dark{
  --bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#222;--bg-hover:#2a2a2a;
  --border:#333;--text-primary:#f0f0f0;--text-secondary:#999;
  --accent:#DC2626;--accent-hover:#EF4444;--accent-light:#EF4444;
  --accent-glow:rgba(220,38,38,.15);--accent-glow2:rgba(220,38,38,.08);
  --shadow:0 2px 12px rgba(0,0,0,.3);--input-bg:#1a1a1a;--modal-overlay:rgba(0,0,0,.75);
}
html{scrollbar-gutter:stable;}
html,body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow:hidden;height:100vh;}

/* ===== HEADER (matches contacts) ===== */
.desktop-header{background:var(--bg-primary);border-bottom:1px solid var(--border);flex-shrink:0;}
.header-top{padding:16px 24px 8px;display:flex;justify-content:space-between;align-items:center;}
.header-brand{display:flex;align-items:center;gap:14px;}
.header-logo{height:36px;}
.header-titles h1{font-size:28px;font-weight:700;letter-spacing:-.3px;}
.header-titles .sub{font-size:12px;color:var(--accent);font-weight:600;letter-spacing:.5px;text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:14px;}
.dark-toggle{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.dark-toggle:hover{border-color:var(--accent);color:var(--accent);}
.dark-toggle svg{width:18px;height:18px;fill:currentColor;}
.logout-link{color:var(--text-secondary);cursor:pointer;font-size:13px;text-decoration:none;transition:color .2s;}.logout-link:hover{color:var(--accent);}
.settings-link{color:var(--text-secondary);cursor:pointer;font-size:12px;text-decoration:none;transition:color .2s;}.settings-link:hover{color:var(--accent);}
.header-right-stack{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.desktop-nav{padding:0 24px;display:flex;gap:0;}
.desktop-nav a{padding:12px 16px;color:var(--text-secondary);text-decoration:none;font-size:14px;font-weight:500;border-bottom:2px solid transparent;transition:all .2s;}
.desktop-nav a:hover{color:var(--text-primary);}
.desktop-nav a.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600;}

/* ===== MOBILE HEADER ===== */
.mobile-top-header{display:none;background:var(--bg-secondary);border-bottom:1px solid var(--border);flex-shrink:0;}
.m-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;}
.m-menu-btn{background:transparent;border:none;color:var(--text-secondary);font-size:20px;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.m-center{flex:1;}.m-title{font-size:18px;font-weight:600;}.m-biz{font-size:12px;color:var(--accent);font-weight:600;}
.m-right{display:flex;align-items:center;gap:10px;}
.m-menu{max-height:0;overflow:hidden;transition:max-height .3s;background:var(--bg-primary);border-top:1px solid var(--border);}
.m-menu.expanded{max-height:200px;}
.m-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:8px 12px 12px;}
.m-actions button{padding:10px;font-size:13px;background:var(--accent-glow);border:1px solid rgba(220,38,38,.25);color:var(--accent);border-radius:8px;cursor:pointer;}
.mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:8px;z-index:100;border-top:1px solid var(--border);}
.m-nav-btn{padding:10px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:44px;}
.m-nav-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;}
@media(max-width:768px){.desktop-header{display:none!important;}.mobile-top-header{display:block!important;}.mobile-bottom-nav{display:block!important;}}
@media(min-width:769px){.mobile-top-header{display:none!important;}.mobile-bottom-nav{display:none!important;}}

/* ===== APP LAYOUT ===== */
.app{display:flex;height:100vh;flex-direction:column;}
.top-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border);flex-shrink:0;z-index:10;}
.top-bar h1{font-size:20px;font-weight:700;letter-spacing:-.3px;}
.top-actions{display:flex;gap:6px;align-items:center;}
.btn{padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .15s;}
.btn:hover{background:var(--bg-hover);color:var(--text-primary);}
.btn.pri{background:var(--accent);color:#fff;border-color:var(--accent);}.btn.pri:hover{background:var(--accent-hover);}
.btn.danger{color:#ef4444;border-color:rgba(239,68,68,.3);}.btn.danger:hover{background:rgba(239,68,68,.1);}
.workspace{display:flex;flex:1;overflow:hidden;}

/* ===== LEFT PANEL ===== */
.panel-left{width:220px;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;}
.panel-section{padding:12px;}
.panel-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin-bottom:10px;}
.shape-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;}
.shape-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;user-select:none;}
.shape-btn:hover{border-color:var(--accent);color:var(--text-primary);background:var(--bg-hover);}
.shape-btn.active{border-color:var(--accent);background:var(--accent-glow);color:var(--accent);}
.shape-btn canvas{width:28px;height:28px;}
.color-row{display:flex;gap:5px;flex-wrap:wrap;}
.color-swatch{width:24px;height:24px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .12s;}
.color-swatch:hover{transform:scale(1.15);}
.color-swatch.active{border-color:var(--text-primary);transform:scale(1.15);}
.preset-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;}
.preset-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:9px;font-weight:600;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.3px;}
.preset-btn:hover{border-color:var(--accent);color:var(--text-primary);}
.preset-btn .pi{font-size:20px;line-height:1;}

/* ===== CANVAS ===== */
.canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--bg-primary);}
.canvas-wrap canvas{position:absolute;top:0;left:0;cursor:crosshair;}
.canvas-toolbar{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:6px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;z-index:5;box-shadow:var(--shadow);}
.ct-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;}
.ct-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
.ct-btn.active{background:var(--accent-glow);color:var(--accent);border-color:var(--accent);}
.ct-sep{width:1px;background:var(--border);margin:4px 2px;}
.zoom-label{font-size:11px;color:var(--text-secondary);display:flex;align-items:center;padding:0 4px;font-weight:600;min-width:40px;justify-content:center;}
.grid-canvas{position:absolute;top:0;left:0;pointer-events:none;z-index:0;}

/* ===== RIGHT PANEL ===== */
.panel-right{width:220px;background:var(--bg-secondary);border-left:1px solid var(--border);flex-shrink:0;overflow-y:auto;display:flex;flex-direction:column;}
.prop-group{padding:12px;border-bottom:1px solid var(--border);}
.prop-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:6px;}
.prop-row{display:flex;gap:6px;align-items:center;margin-bottom:6px;}
.prop-input{flex:1;padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:var(--input-bg);color:var(--text-primary);font-size:12px;font-family:inherit;width:100%;}
.prop-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
.prop-sm{width:60px;text-align:center;}
.prop-unit{font-size:10px;color:var(--text-secondary);flex-shrink:0;}
.slider-row{display:flex;align-items:center;gap:8px;}
.slider-row input[type="range"]{flex:1;accent-color:var(--accent);height:4px;}
.slider-val{font-size:11px;color:var(--text-secondary);min-width:30px;text-align:right;}
.empty-props{padding:24px 16px;text-align:center;color:var(--text-secondary);font-size:12px;line-height:1.6;}
.layer-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:all .12s;border:1px solid transparent;}
.layer-item:hover{background:var(--bg-hover);}
.layer-item.active{background:var(--accent-glow);border-color:rgba(220,38,38,.25);}
.layer-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
.layer-name{font-size:12px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.layer-del{width:20px;height:20px;border:none;background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .12s;}
.layer-item:hover .layer-del{opacity:.6;}
.layer-del:hover{opacity:1!important;background:rgba(239,68,68,.15);color:#ef4444;}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);padding:10px 18px;border-radius:10px;font-size:13px;z-index:1000;display:none;box-shadow:var(--shadow);}
.toast.show{display:block;animation:toastIn .3s ease;}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

@media(max-width:900px){.panel-left{width:180px;}.panel-right{width:180px;}}
@media(max-width:768px){.panel-right{display:none;}.panel-left{width:160px;}.canvas-toolbar{bottom:70px;}}
  </style>
</head>
<body>
<div class="app">

<!-- MOBILE TOP HEADER -->
<div class="mobile-top-header">
  <div class="m-bar">
    <button class="m-menu-btn" onclick="document.getElementById('mMenu').classList.toggle('expanded')">&#9776;</button>
    <div class="m-center"><div class="m-title">Site Maps</div><div class="m-biz" id="mBiz">Event Logic Pro</div></div>
    <div class="m-right"><button class="dark-toggle" onclick="toggleDark()"><svg id="mMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><svg id="mSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div>
  </div>
  <div class="m-menu" id="mMenu"><div class="m-actions"><button onclick="location.href='eventlogicpro-settings.html'">Settings</button><button onclick="location.href='support.html'">Support</button><button onclick="logout()">Logout</button></div></div>
</div>

<!-- DESKTOP HEADER -->
<div class="desktop-header">
  <div class="header-top">
    <div class="header-brand">
      <img id="headerLogo" class="header-logo" src="eventlogicpro-logo.png" alt="Event Logic Pro">
      <div class="header-titles"><h1>Site Maps</h1><div class="sub" id="dBiz">Event Logic Pro</div></div>
    </div>
    <div class="header-right">
      <button class="dark-toggle" onclick="toggleDark()">
        <svg id="dMoon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg id="dSun" viewBox="0 0 24 24" style="display:none;"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <div class="header-right-stack">
        <a class="logout-link" onclick="logout()">Logout</a>
        <a class="settings-link" href="eventlogicpro-settings.html">Settings</a>
      </div>
    </div>
  </div>
  <nav class="desktop-nav">
    <a href="eventlogicpro-calendar.html">Calendar</a>
    <a href="eventlogicpro.html">Tasks</a>
    <a href="eventlogicpro-budget.html">Budget</a>
    <a href="eventlogicpro-sponsors.html">Packages</a>
    <a href="eventlogicpro-contacts.html">Contacts</a>
    <a href="eventlogicpro-sitemap.html" class="active">Site Maps</a>
  </nav>
</div>

<!-- SITEMAP TOOLBAR -->
<div class="top-bar">
  <h1>Site Map Creator</h1>
  <div class="top-actions">
    <select id="mapSelect" class="prop-input" style="max-width:200px;font-size:12px;padding:6px 8px;" onchange="switchMap(this.value)">
      <option value="">-- No saved maps --</option>
    </select>
    <button class="btn pri" onclick="saveMap()">Save</button>
    <button class="btn" onclick="newMap()">+ New</button>
    <button class="btn danger" id="deleteMapBtn" onclick="deleteMap()" style="display:none;">Delete</button>
    <div style="width:1px;height:24px;background:var(--border);"></div>
    <button class="btn" onclick="document.getElementById('bgInput').click()">BG Image</button>
    <button class="btn" id="bgRemoveBtn" onclick="removeBg()" style="display:none;">Remove BG</button>
    <input type="file" id="bgInput" accept="image/*" style="display:none;" onchange="loadBgImage(this)">
    <button class="btn" onclick="exportPNG()">Export PNG</button>
    <button class="btn" onclick="clearAll()">Clear</button>
  </div>
</div>

<div class="workspace">
  <!-- Left Panel -->
  <div class="panel-left">
    <div class="panel-section"><div class="panel-title">Shapes</div><div class="shape-grid" id="shapeGrid"></div></div>
    <div class="panel-section" style="border-top:1px solid var(--border);"><div class="panel-title">Event Presets</div><div class="preset-grid" id="presetGrid"></div></div>
    <div class="panel-section" style="border-top:1px solid var(--border);"><div class="panel-title">Fill Color</div><div class="color-row" id="colorRow"></div></div>
    <div class="panel-section" style="border-top:1px solid var(--border);"><div class="panel-title">Layers</div><div id="layerList"></div></div>
  </div>
  <!-- Canvas -->
  <div class="canvas-wrap" id="canvasWrap">
    <canvas id="gridCanvas" class="grid-canvas"></canvas>
    <canvas id="mainCanvas"></canvas>
    <div class="canvas-toolbar">
      <button class="ct-btn active" id="tbSelect" onclick="setTool('select')" title="Select (V)">&#9995;</button>
      <button class="ct-btn" id="tbDraw" onclick="setTool('draw')" title="Draw Shape">&#9998;</button>
      <div class="ct-sep"></div>
      <button class="ct-btn" onclick="zoomIn()" title="Zoom In">+</button>
      <span class="zoom-label" id="zoomLabel">100%</span>
      <button class="ct-btn" onclick="zoomOut()" title="Zoom Out">&minus;</button>
      <button class="ct-btn" onclick="zoomFit()" title="Fit">&#9634;</button>
      <div class="ct-sep"></div>
      <button class="ct-btn" id="tbGrid" onclick="toggleGrid()" title="Toggle Grid">&#9638;</button>
    </div>
  </div>
  <!-- Right Panel -->
  <div class="panel-right"><div id="propsPanel"><div class="empty-props">Select an object to<br>edit its properties</div></div></div>
</div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-bottom-nav">
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:4px;">
    <a href="eventlogicpro-calendar.html" class="m-nav-btn">Calendar</a>
    <a href="eventlogicpro.html" class="m-nav-btn">Tasks</a>
    <a href="eventlogicpro-budget.html" class="m-nav-btn">Budget</a>
    <a href="eventlogicpro-sponsors.html" class="m-nav-btn">Packages</a>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
    <a href="eventlogicpro-contacts.html" class="m-nav-btn">Contacts</a>
    <a href="eventlogicpro-sitemap.html" class="m-nav-btn active">Site Maps</a>
  </div>
</div>

<div id="toastEl" class="toast"></div>

<script>
// ===== AUTH & SUPABASE =====
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);

// ===== DARK MODE (matches contacts) =====
var isDark=localStorage.getItem('elp_dark_mode')==='true';
if(isDark)document.body.classList.add('dark');
function applyDarkIcons(){
  var d=document.body.classList.contains('dark');
  ['d','m'].forEach(function(p){var moon=document.getElementById(p+'Moon'),sun=document.getElementById(p+'Sun');if(moon)moon.style.display=d?'none':'block';if(sun)sun.style.display=d?'block':'none';});
  var logo=document.getElementById('headerLogo');if(logo)logo.src=d?'eventlogicpro-logo-dark.png':'eventlogicpro-logo.png';
}
applyDarkIcons();
function toggleDark(){document.body.classList.toggle('dark');isDark=document.body.classList.contains('dark');localStorage.setItem('elp_dark_mode',isDark);applyDarkIcons();renderAll();}

async function checkAuth(){
  var r=await sb.auth.getSession(),s=r.data.session;
  if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');
    if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}
    if(!s){location.replace('/');return null;}}
  return s;
}
async function logout(){await sb.auth.signOut();localStorage.clear();location.replace('/');}

// ===== CONFIG =====
var COLORS=['#DC2626','#ef4444','#3b82f6','#22c55e','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#84cc16','#64748b','#a78bfa','#fbbf24','#10b981','#f472b6','#0ea5e9','#fb923c','#e879f9','#334155'];

var SHAPES=[
  {id:'rect',name:'Rectangle',icon:function(ctx,s){ctx.fillStyle=s;ctx.fillRect(4,8,20,12);}},
  {id:'square',name:'Square',icon:function(ctx,s){ctx.fillStyle=s;ctx.fillRect(6,6,16,16);}},
  {id:'circle',name:'Circle',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.arc(14,14,9,0,Math.PI*2);ctx.fill();}},
  {id:'ellipse',name:'Ellipse',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.ellipse(14,14,12,7,0,0,Math.PI*2);ctx.fill();}},
  {id:'triangle',name:'Triangle',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.moveTo(14,4);ctx.lineTo(26,24);ctx.lineTo(2,24);ctx.closePath();ctx.fill();}},
  {id:'star',name:'Star',icon:function(ctx,s){ctx.fillStyle=s;drawStar(ctx,14,14,5,10,5);ctx.fill();}},
  {id:'diamond',name:'Diamond',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.moveTo(14,3);ctx.lineTo(25,14);ctx.lineTo(14,25);ctx.lineTo(3,14);ctx.closePath();ctx.fill();}},
  {id:'line',name:'Line',icon:function(ctx,s){ctx.strokeStyle=s;ctx.lineWidth=3;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(4,24);ctx.lineTo(24,4);ctx.stroke();}}
];

var PRESETS=[
  {name:'Stage',shape:'rect',w:160,h:80,color:'#8b5cf6',label:'STAGE'},
  {name:'Tent',shape:'rect',w:100,h:100,color:'#14b8a6',label:'TENT'},
  {name:'Bathroom',shape:'square',w:50,h:50,color:'#3b82f6',label:'WC'},
  {name:'Parking',shape:'rect',w:120,h:200,color:'#64748b',label:'PARKING'},
  {name:'Bar',shape:'rect',w:80,h:40,color:'#f59e0b',label:'BAR'},
  {name:'Food',shape:'rect',w:80,h:60,color:'#f97316',label:'FOOD'},
  {name:'Gate',shape:'rect',w:60,h:20,color:'#ef4444',label:'GATE'},
  {name:'Med',shape:'square',w:40,h:40,color:'#dc2626',label:'MED'},
  {name:'Vendor',shape:'square',w:50,h:50,color:'#22c55e',label:'VENDOR'},
  {name:'Merch',shape:'rect',w:60,h:40,color:'#fbbf24',label:'MERCH'},
  {name:'Sound',shape:'rect',w:50,h:30,color:'#6366f1',label:'SOUND'},
  {name:'Car',shape:'rect',w:30,h:50,color:'#475569',label:'CAR'},
  {name:'VIP',shape:'rect',w:100,h:60,color:'#ec4899',label:'VIP'},
  {name:'Table',shape:'circle',w:40,h:40,color:'#a78bfa',label:'TABLE'},
  {name:'Tree',shape:'circle',w:30,h:30,color:'#22c55e',label:''},
  {name:'Fence',shape:'line',w:120,h:4,color:'#64748b',label:''}
];

// ===== STATE =====
var objects=[];var selectedId=null;var currentShape='rect';var currentColor=COLORS[0];var tool='select';var showGrid=true;var zoom=1;var panX=0,panY=0;
var isDragging=false,isResizing=false,isPanning=false,isDrawing=false;
var dragStart={x:0,y:0},objStart={x:0,y:0,w:0,h:0};var drawStart=null;var resizeHandle='';var nextId=1;
var bgImage=null;var bgOpacity=0.3;var tenantId=null,userId=null,authUid=null;var allMaps=[],currentMapId=null;
var wrap,mainCanvas,ctx,gridCanvas,gctx;var W,H;

function drawStar(ctx,cx,cy,spikes,R,r){ctx.beginPath();var rot=Math.PI/2*3,step=Math.PI/spikes;ctx.moveTo(cx,cy-R);for(var i=0;i<spikes;i++){var x=cx+Math.cos(rot)*R,y=cy+Math.sin(rot)*R;ctx.lineTo(x,y);rot+=step;x=cx+Math.cos(rot)*r;y=cy+Math.sin(rot)*r;ctx.lineTo(x,y);rot+=step;}ctx.closePath();}

function initUI(){
  var sg=document.getElementById('shapeGrid');SHAPES.forEach(function(s){var btn=document.createElement('div');btn.className='shape-btn'+(currentShape===s.id?' active':'');btn.dataset.shape=s.id;var cv=document.createElement('canvas');cv.width=28;cv.height=28;s.icon(cv.getContext('2d'),currentColor);btn.appendChild(cv);var lbl=document.createElement('span');lbl.textContent=s.name;btn.appendChild(lbl);btn.onclick=function(){currentShape=s.id;tool='draw';document.querySelectorAll('.shape-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');updateToolbar();};sg.appendChild(btn);});
  var pg=document.getElementById('presetGrid');PRESETS.forEach(function(p){var btn=document.createElement('div');btn.className='preset-btn';btn.innerHTML='<span class="pi" style="color:'+p.color+';">&#9632;</span>'+p.name;btn.onclick=function(){addPreset(p);};pg.appendChild(btn);});
  var cr=document.getElementById('colorRow');COLORS.forEach(function(c){var sw=document.createElement('div');sw.className='color-swatch'+(c===currentColor?' active':'');sw.style.background=c;sw.onclick=function(){currentColor=c;cr.querySelectorAll('.color-swatch').forEach(function(s){s.classList.remove('active');});sw.classList.add('active');if(selectedId!==null){var obj=getObj(selectedId);if(obj){obj.color=c;renderAll();renderProps();}}updateShapeIcons();};cr.appendChild(sw);});
}
function updateShapeIcons(){document.querySelectorAll('.shape-btn').forEach(function(btn){var cv=btn.querySelector('canvas');if(!cv)return;var c=cv.getContext('2d');c.clearRect(0,0,28,28);var s=SHAPES.find(function(sh){return sh.id===btn.dataset.shape;});if(s)s.icon(c,currentColor);});}
function updateToolbar(){document.getElementById('tbSelect').classList.toggle('active',tool==='select');document.getElementById('tbDraw').classList.toggle('active',tool==='draw');}
function setTool(t){tool=t;updateToolbar();if(t==='select')document.querySelectorAll('.shape-btn').forEach(function(b){b.classList.remove('active');});}
function initCanvas(){wrap=document.getElementById('canvasWrap');mainCanvas=document.getElementById('mainCanvas');ctx=mainCanvas.getContext('2d');gridCanvas=document.getElementById('gridCanvas');gctx=gridCanvas.getContext('2d');resize();window.addEventListener('resize',resize);}
function resize(){W=wrap.clientWidth;H=wrap.clientHeight;mainCanvas.width=W;mainCanvas.height=H;gridCanvas.width=W;gridCanvas.height=H;mainCanvas.style.width=W+'px';mainCanvas.style.height=H+'px';gridCanvas.style.width=W+'px';gridCanvas.style.height=H+'px';renderAll();}
function drawGrid(){gctx.clearRect(0,0,W,H);if(!showGrid)return;var step=20*zoom;var offX=panX%step,offY=panY%step;gctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--border').trim();gctx.lineWidth=0.5;gctx.globalAlpha=0.4;for(var x=offX;x<W;x+=step){gctx.beginPath();gctx.moveTo(x,0);gctx.lineTo(x,H);gctx.stroke();}for(var y=offY;y<H;y+=step){gctx.beginPath();gctx.moveTo(0,y);gctx.lineTo(W,y);gctx.stroke();}gctx.globalAlpha=1;}
function toggleGrid(){showGrid=!showGrid;document.getElementById('tbGrid').classList.toggle('active',showGrid);drawGrid();}
function addObj(shape,x,y,w,h,color,label,rotation){var obj={id:nextId++,shape:shape,x:x,y:y,w:Math.max(w,10),h:Math.max(h,10),color:color||currentColor,label:label||'',rotation:rotation||0,opacity:1};objects.push(obj);selectedId=obj.id;renderAll();renderLayers();renderProps();return obj;}
function getObj(id){return objects.find(function(o){return o.id===id;});}
function deleteObj(id){objects=objects.filter(function(o){return o.id!==id;});if(selectedId===id)selectedId=null;renderAll();renderLayers();renderProps();}
function addPreset(p){var cx=(W/2-panX)/zoom,cy=(H/2-panY)/zoom;addObj(p.shape,cx-p.w/2,cy-p.h/2,p.w,p.h,p.color,p.label);tool='select';updateToolbar();}

function renderAll(){ctx.clearRect(0,0,W,H);drawGrid();ctx.save();ctx.translate(panX,panY);ctx.scale(zoom,zoom);
if(bgImage){ctx.globalAlpha=bgOpacity;ctx.drawImage(bgImage,0,0);ctx.globalAlpha=1;}
objects.forEach(function(obj){ctx.save();ctx.globalAlpha=obj.opacity;var cx=obj.x+obj.w/2,cy=obj.y+obj.h/2;ctx.translate(cx,cy);ctx.rotate((obj.rotation||0)*Math.PI/180);ctx.translate(-cx,-cy);drawShape(ctx,obj);
if(obj.label){ctx.fillStyle='#fff';ctx.font='bold '+Math.min(14,obj.h*0.35)+'px system-ui,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowColor='rgba(0,0,0,.5)';ctx.shadowBlur=3;ctx.fillText(obj.label,cx,cy);ctx.shadowBlur=0;}ctx.restore();
if(obj.id===selectedId){ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();ctx.lineWidth=2/zoom;ctx.setLineDash([6/zoom,4/zoom]);ctx.strokeRect(obj.x-2/zoom,obj.y-2/zoom,obj.w+4/zoom,obj.h+4/zoom);ctx.setLineDash([]);var hs=6/zoom;var handles=[{x:obj.x-hs,y:obj.y-hs},{x:obj.x+obj.w,y:obj.y-hs},{x:obj.x-hs,y:obj.y+obj.h},{x:obj.x+obj.w,y:obj.y+obj.h}];ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();handles.forEach(function(h){ctx.fillRect(h.x,h.y,hs,hs);});}});ctx.restore();}

function drawShape(ctx,obj){ctx.fillStyle=obj.color;ctx.strokeStyle=obj.color;switch(obj.shape){case 'rect':case 'square':ctx.fillRect(obj.x,obj.y,obj.w,obj.h);break;case 'circle':var r=Math.min(obj.w,obj.h)/2;ctx.beginPath();ctx.arc(obj.x+obj.w/2,obj.y+obj.h/2,r,0,Math.PI*2);ctx.fill();break;case 'ellipse':ctx.beginPath();ctx.ellipse(obj.x+obj.w/2,obj.y+obj.h/2,obj.w/2,obj.h/2,0,0,Math.PI*2);ctx.fill();break;case 'triangle':ctx.beginPath();ctx.moveTo(obj.x+obj.w/2,obj.y);ctx.lineTo(obj.x+obj.w,obj.y+obj.h);ctx.lineTo(obj.x,obj.y+obj.h);ctx.closePath();ctx.fill();break;case 'star':drawStar(ctx,obj.x+obj.w/2,obj.y+obj.h/2,5,Math.min(obj.w,obj.h)/2,Math.min(obj.w,obj.h)/4.5);ctx.fill();break;case 'diamond':ctx.beginPath();var cx2=obj.x+obj.w/2,cy2=obj.y+obj.h/2;ctx.moveTo(cx2,obj.y);ctx.lineTo(obj.x+obj.w,cy2);ctx.lineTo(cx2,obj.y+obj.h);ctx.lineTo(obj.x,cy2);ctx.closePath();ctx.fill();break;case 'line':ctx.lineWidth=Math.max(3,obj.h);ctx.lineCap='round';ctx.beginPath();ctx.moveTo(obj.x,obj.y+obj.h/2);ctx.lineTo(obj.x+obj.w,obj.y+obj.h/2);ctx.stroke();break;}}

function renderLayers(){var el=document.getElementById('layerList');if(!objects.length){el.innerHTML='<div style="padding:8px;color:var(--text-secondary);font-size:11px;">No objects yet</div>';return;}el.innerHTML=objects.slice().reverse().map(function(obj){return '<div class="layer-item'+(obj.id===selectedId?' active':'')+'" onclick="selectObj('+obj.id+')"><div class="layer-dot" style="background:'+obj.color+'"></div><span class="layer-name">'+(obj.label||obj.shape+' #'+obj.id)+'</span><button class="layer-del" onclick="event.stopPropagation();deleteObj('+obj.id+')">&times;</button></div>';}).join('');}
function selectObj(id){selectedId=id;renderAll();renderLayers();renderProps();}

function renderProps(){var el=document.getElementById('propsPanel');if(selectedId===null){var map=currentMapId?allMaps.find(function(m){return m.id===currentMapId;}):null;var bgHtml='<div class="empty-props">'+(map?'<strong>'+esc(map.name)+'</strong><br><button class="btn" onclick="renameMap()" style="margin-top:6px;font-size:11px;">Rename</button>':'Select an object to<br>edit its properties')+'</div>';if(bgImage){bgHtml+='<div class="prop-group"><div class="prop-label">Background Image</div><div class="slider-row"><span class="prop-unit" style="font-size:11px;">Opacity</span><input type="range" min="5" max="100" value="'+Math.round(bgOpacity*100)+'" oninput="setBgOpacity(this.value/100);this.parentElement.querySelector(\'.slider-val\').textContent=this.value+\'%\'"><span class="slider-val">'+Math.round(bgOpacity*100)+'%</span></div><button class="btn danger" onclick="removeBg()" style="width:100%;margin-top:8px;">Remove Background</button></div>';}el.innerHTML=bgHtml;return;}
var obj=getObj(selectedId);if(!obj){el.innerHTML='';return;}
var h='<div class="prop-group"><div class="prop-label">Label</div><input class="prop-input" value="'+esc(obj.label)+'" oninput="propSet(\'label\',this.value)" placeholder="Enter label"></div>';
h+='<div class="prop-group"><div class="prop-label">Position</div><div class="prop-row"><span class="prop-unit">X</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.x)+'" oninput="propSet(\'x\',+this.value)"><span class="prop-unit">Y</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.y)+'" oninput="propSet(\'y\',+this.value)"></div></div>';
h+='<div class="prop-group"><div class="prop-label">Size</div><div class="prop-row"><span class="prop-unit">W</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.w)+'" oninput="propSet(\'w\',Math.max(10,+this.value))"><span class="prop-unit">H</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.h)+'" oninput="propSet(\'h\',Math.max(10,+this.value))"></div></div>';
h+='<div class="prop-group"><div class="prop-label">Rotation</div><div class="slider-row"><input type="range" min="0" max="360" value="'+(obj.rotation||0)+'" oninput="propSet(\'rotation\',+this.value);this.nextElementSibling.textContent=this.value+\'°\'"><span class="slider-val">'+(obj.rotation||0)+'°</span></div></div>';
h+='<div class="prop-group"><div class="prop-label">Opacity</div><div class="slider-row"><input type="range" min="10" max="100" value="'+Math.round((obj.opacity||1)*100)+'" oninput="propSet(\'opacity\',this.value/100);this.nextElementSibling.textContent=this.value+\'%\'"><span class="slider-val">'+Math.round((obj.opacity||1)*100)+'%</span></div></div>';
h+='<div class="prop-group"><div class="prop-label">Actions</div><div class="prop-row"><button class="btn" onclick="dupObj()" style="flex:1;">Duplicate</button><button class="btn danger" onclick="deleteObj('+obj.id+')" style="flex:1;">Delete</button></div><div class="prop-row"><button class="btn" onclick="bringFwd()" style="flex:1;">Bring Front</button><button class="btn" onclick="sendBack()" style="flex:1;">Send Back</button></div></div>';
el.innerHTML=h;}

function propSet(key,val){var obj=getObj(selectedId);if(!obj)return;obj[key]=val;renderAll();renderLayers();}
function dupObj(){var obj=getObj(selectedId);if(!obj)return;addObj(obj.shape,obj.x+20,obj.y+20,obj.w,obj.h,obj.color,obj.label,obj.rotation);}
function bringFwd(){var i=objects.findIndex(function(o){return o.id===selectedId;});if(i<0||i>=objects.length-1)return;var tmp=objects[i];objects[i]=objects[i+1];objects[i+1]=tmp;renderAll();renderLayers();}
function sendBack(){var i=objects.findIndex(function(o){return o.id===selectedId;});if(i<=0)return;var tmp=objects[i];objects[i]=objects[i-1];objects[i-1]=tmp;renderAll();renderLayers();}
function hitTest(mx,my){var cx2=(mx-panX)/zoom,cy2=(my-panY)/zoom;for(var i=objects.length-1;i>=0;i--){var o=objects[i];if(cx2>=o.x&&cx2<=o.x+o.w&&cy2>=o.y&&cy2<=o.y+o.h)return o;}return null;}
function hitHandle(mx,my){if(selectedId===null)return'';var obj=getObj(selectedId);if(!obj)return'';var cx2=(mx-panX)/zoom,cy2=(my-panY)/zoom;var hs=8/zoom;var corners=[{name:'nw',x:obj.x,y:obj.y},{name:'ne',x:obj.x+obj.w,y:obj.y},{name:'sw',x:obj.x,y:obj.y+obj.h},{name:'se',x:obj.x+obj.w,y:obj.y+obj.h}];for(var i=0;i<corners.length;i++){if(Math.abs(cx2-corners[i].x)<hs&&Math.abs(cy2-corners[i].y)<hs)return corners[i].name;}return'';}
function canvasXY(e){var r=mainCanvas.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top};}

function setupEvents(){
mainCanvas.addEventListener('mousedown',onDown);mainCanvas.addEventListener('mousemove',onMove);mainCanvas.addEventListener('mouseup',onUp);mainCanvas.addEventListener('wheel',onWheel,{passive:false});mainCanvas.addEventListener('dblclick',onDblClick);
mainCanvas.addEventListener('touchstart',function(e){e.preventDefault();var t=e.touches[0];onDown({clientX:t.clientX,clientY:t.clientY,button:0});},{passive:false});
mainCanvas.addEventListener('touchmove',function(e){e.preventDefault();var t=e.touches[0];onMove({clientX:t.clientX,clientY:t.clientY,buttons:1});},{passive:false});
mainCanvas.addEventListener('touchend',function(e){onUp({});});
mainCanvas.addEventListener('dragover',function(e){e.preventDefault();e.dataTransfer.dropEffect='copy';});
mainCanvas.addEventListener('drop',function(e){e.preventDefault();var file=e.dataTransfer.files&&e.dataTransfer.files[0];if(!file||!file.type.startsWith('image/'))return;var reader=new FileReader();reader.onload=function(ev){var img=new Image();img.onload=function(){bgImage=img;bgOpacity=0.3;document.getElementById('bgRemoveBtn').style.display='';renderAll();renderProps();toast('Background set');};img.src=ev.target.result;};reader.readAsDataURL(file);});}

function onDown(e){var p=canvasXY(e);if(e.button===1){isPanning=true;dragStart=p;return;}if(tool==='draw'){isDrawing=true;drawStart=p;return;}var h=hitHandle(p.x,p.y);if(h){isResizing=true;resizeHandle=h;var obj=getObj(selectedId);dragStart=p;objStart={x:obj.x,y:obj.y,w:obj.w,h:obj.h};return;}var hit=hitTest(p.x,p.y);if(hit){selectedId=hit.id;isDragging=true;dragStart=p;objStart={x:hit.x,y:hit.y};renderAll();renderLayers();renderProps();}else{if(e.button===0&&!e.shiftKey){isPanning=true;dragStart=p;}selectedId=null;renderAll();renderLayers();renderProps();}}
function onMove(e){var p=canvasXY(e);if(isPanning){panX+=(p.x-dragStart.x);panY+=(p.y-dragStart.y);dragStart=p;renderAll();return;}if(isDragging){var obj=getObj(selectedId);if(!obj)return;obj.x=objStart.x+(p.x-dragStart.x)/zoom;obj.y=objStart.y+(p.y-dragStart.y)/zoom;renderAll();return;}if(isResizing){var obj=getObj(selectedId);if(!obj)return;var dx=(p.x-dragStart.x)/zoom,dy=(p.y-dragStart.y)/zoom;if(resizeHandle.includes('e'))obj.w=Math.max(10,objStart.w+dx);if(resizeHandle.includes('w')){obj.x=objStart.x+dx;obj.w=Math.max(10,objStart.w-dx);}if(resizeHandle.includes('s'))obj.h=Math.max(10,objStart.h+dy);if(resizeHandle.includes('n')){obj.y=objStart.y+dy;obj.h=Math.max(10,objStart.h-dy);}renderAll();return;}if(isDrawing&&drawStart){renderAll();var x1=(drawStart.x-panX)/zoom,y1=(drawStart.y-panY)/zoom,x2=(p.x-panX)/zoom,y2=(p.y-panY)/zoom;ctx.save();ctx.translate(panX,panY);ctx.scale(zoom,zoom);ctx.globalAlpha=0.5;drawShape(ctx,{shape:currentShape,x:Math.min(x1,x2),y:Math.min(y1,y2),w:Math.abs(x2-x1),h:Math.abs(y2-y1),color:currentColor});ctx.restore();return;}var h=hitHandle(p.x,p.y);if(h)mainCanvas.style.cursor=h==='nw'||h==='se'?'nwse-resize':'nesw-resize';else if(hitTest(p.x,p.y))mainCanvas.style.cursor='move';else mainCanvas.style.cursor=tool==='draw'?'crosshair':'grab';}
function onUp(e){if(isDrawing&&drawStart){var p=canvasXY(e.clientX?e:drawStart);var x1=(drawStart.x-panX)/zoom,y1=(drawStart.y-panY)/zoom,x2=(p.x-panX)/zoom,y2=(p.y-panY)/zoom;if(Math.abs(x2-x1)>5||Math.abs(y2-y1)>5)addObj(currentShape,Math.min(x1,x2),Math.min(y1,y2),Math.abs(x2-x1),Math.abs(y2-y1),currentColor,'');}if(isDragging||isResizing)renderProps();isDragging=false;isResizing=false;isPanning=false;isDrawing=false;drawStart=null;}
function onWheel(e){e.preventDefault();var p=canvasXY(e);var oldZoom=zoom;if(e.deltaY<0)zoom=Math.min(5,zoom*1.1);else zoom=Math.max(0.1,zoom/1.1);panX=p.x-(p.x-panX)*zoom/oldZoom;panY=p.y-(p.y-panY)*zoom/oldZoom;document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';renderAll();}
function onDblClick(e){var p=canvasXY(e);var hit=hitTest(p.x,p.y);if(hit){var lbl=prompt('Label:',hit.label||'');if(lbl!==null){hit.label=lbl;renderAll();renderLayers();renderProps();}}}
function zoomIn(){zoom=Math.min(5,zoom*1.25);document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';renderAll();}
function zoomOut(){zoom=Math.max(0.1,zoom/1.25);document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';renderAll();}
function zoomFit(){zoom=1;panX=0;panY=0;document.getElementById('zoomLabel').textContent='100%';renderAll();}
document.addEventListener('keydown',function(e){if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;if(e.key==='Delete'||e.key==='Backspace'){if(selectedId!==null)deleteObj(selectedId);}if(e.key==='v'||e.key==='V')setTool('select');if(e.key==='d'||e.key==='D'){if(selectedId!==null)dupObj();}if(e.key==='Escape'){selectedId=null;renderAll();renderLayers();renderProps();}});

// ===== DB SAVE/LOAD =====
async function loadMaps(){if(!tenantId)return;var r=await sb.from('site_maps').select('*').eq('tenant_id',tenantId).order('updated_at',{ascending:false});allMaps=r.data||[];renderMapSelect();}
function renderMapSelect(){var sel=document.getElementById('mapSelect');var h='<option value="">-- Select Site Map --</option>';allMaps.forEach(function(m){h+='<option value="'+m.id+'"'+(m.id===currentMapId?' selected':'')+'>'+esc(m.name)+(m.is_shared?' [SHARED]':'')+'</option>';});sel.innerHTML=h;document.getElementById('deleteMapBtn').style.display=currentMapId?'':'none';}
async function switchMap(id){if(!id){currentMapId=null;objects=[];nextId=1;selectedId=null;bgImage=null;panX=0;panY=0;zoom=1;renderAll();renderLayers();renderProps();renderMapSelect();return;}var map=allMaps.find(function(m){return m.id===id;});if(!map)return;currentMapId=id;objects=map.objects||[];nextId=objects.length?Math.max.apply(null,objects.map(function(o){return o.id;}))+1:1;panX=map.pan_x||0;panY=map.pan_y||0;zoom=map.zoom_level||1;bgOpacity=map.bg_opacity||0.3;selectedId=null;document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';if(map.bg_image_url){var img=new Image();img.onload=function(){bgImage=img;document.getElementById('bgRemoveBtn').style.display='';renderAll();};img.onerror=function(){bgImage=null;renderAll();};img.src=map.bg_image_url;}else{bgImage=null;document.getElementById('bgRemoveBtn').style.display='none';}localStorage.setItem('elp-last-map',id);renderAll();renderLayers();renderProps();renderMapSelect();}
async function uploadBgImage(mapId){if(!bgImage||!bgImage.src||!bgImage.src.startsWith('data:'))return null;try{var parts=bgImage.src.split(',');var mime=parts[0].match(/:(.*?);/)[1];var b=atob(parts[1]);var arr=new Uint8Array(b.length);for(var i=0;i<b.length;i++)arr[i]=b.charCodeAt(i);var blob=new Blob([arr],{type:mime});var ext=mime.split('/')[1]||'png';var path=tenantId+'/'+mapId+'/bg.'+ext;var r=await sb.storage.from('sitemap-images').upload(path,blob,{upsert:true,contentType:mime});if(r.error)return null;return sb.storage.from('sitemap-images').getPublicUrl(path).data.publicUrl;}catch(e){return null;}}
async function deleteBgImage(mapId){try{['png','jpg','jpeg','gif','webp'].forEach(async function(ext){await sb.storage.from('sitemap-images').remove([tenantId+'/'+mapId+'/bg.'+ext]);});}catch(e){}}
async function saveMap(){if(!tenantId){toast('Not authenticated');return;}if(!currentMapId){var name=prompt('Name for this site map:','Site Map');if(!name||!name.trim())return;var ins=await sb.from('site_maps').insert({tenant_id:tenantId,created_by:authUid,name:name.trim(),objects:objects,bg_opacity:bgOpacity,pan_x:panX,pan_y:panY,zoom_level:zoom,is_shared:false}).select().single();if(ins.error){toast('Error: '+ins.error.message);return;}currentMapId=ins.data.id;var bgUrl=await uploadBgImage(currentMapId);if(bgUrl)await sb.from('site_maps').update({bg_image_url:bgUrl}).eq('id',currentMapId);localStorage.setItem('elp-last-map',currentMapId);}else{var bgUrl=await uploadBgImage(currentMapId);var upd={objects:objects,bg_opacity:bgOpacity,pan_x:panX,pan_y:panY,zoom_level:zoom,updated_at:new Date().toISOString()};if(bgUrl)upd.bg_image_url=bgUrl;else if(!bgImage)upd.bg_image_url=null;var r=await sb.from('site_maps').update(upd).eq('id',currentMapId);if(r.error){toast('Error: '+r.error.message);return;}}await loadMaps();toast('Site map saved');}
async function newMap(){var name=prompt('Name for new site map:','Site Map');if(!name||!name.trim())return;if(!tenantId){toast('Not authenticated');return;}var ins=await sb.from('site_maps').insert({tenant_id:tenantId,created_by:authUid,name:name.trim(),objects:[],is_shared:false}).select().single();if(ins.error){toast('Error: '+ins.error.message);return;}currentMapId=ins.data.id;objects=[];nextId=1;selectedId=null;bgImage=null;bgOpacity=0.3;panX=0;panY=0;zoom=1;document.getElementById('bgRemoveBtn').style.display='none';document.getElementById('zoomLabel').textContent='100%';localStorage.setItem('elp-last-map',currentMapId);await loadMaps();renderAll();renderLayers();renderProps();toast('"'+name.trim()+'" created');}
async function deleteMap(){if(!currentMapId)return;var map=allMaps.find(function(m){return m.id===currentMapId;});if(!confirm('Delete "'+(map?map.name:'this map')+'"?'))return;await deleteBgImage(currentMapId);await sb.from('site_maps').delete().eq('id',currentMapId);currentMapId=null;objects=[];nextId=1;selectedId=null;bgImage=null;document.getElementById('bgRemoveBtn').style.display='none';localStorage.removeItem('elp-last-map');await loadMaps();renderAll();renderLayers();renderProps();toast('Site map deleted');}
async function renameMap(){if(!currentMapId)return;var map=allMaps.find(function(m){return m.id===currentMapId;});var name=prompt('Rename site map:',map?map.name:'');if(!name||!name.trim())return;await sb.from('site_maps').update({name:name.trim()}).eq('id',currentMapId);await loadMaps();renderProps();toast('Renamed');}
function exportPNG(){var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;objects.forEach(function(o){minX=Math.min(minX,o.x);minY=Math.min(minY,o.y);maxX=Math.max(maxX,o.x+o.w);maxY=Math.max(maxY,o.y+o.h);});if(!objects.length){toast('Nothing to export');return;}var pad=40;minX-=pad;minY-=pad;maxX+=pad;maxY+=pad;var cw=maxX-minX,ch=maxY-minY;var oc=document.createElement('canvas');oc.width=cw*2;oc.height=ch*2;var ox=oc.getContext('2d');ox.scale(2,2);ox.fillStyle=document.body.classList.contains('dark')?'#1a1a1a':'#f4f5f7';ox.fillRect(0,0,cw,ch);ox.translate(-minX,-minY);if(bgImage){ox.globalAlpha=bgOpacity;ox.drawImage(bgImage,0,0);ox.globalAlpha=1;}objects.forEach(function(obj){ox.save();ox.globalAlpha=obj.opacity||1;var cx2=obj.x+obj.w/2,cy2=obj.y+obj.h/2;ox.translate(cx2,cy2);ox.rotate((obj.rotation||0)*Math.PI/180);ox.translate(-cx2,-cy2);drawShape(ox,obj);if(obj.label){ox.fillStyle='#fff';ox.font='bold '+Math.min(14,obj.h*0.35)+'px system-ui';ox.textAlign='center';ox.textBaseline='middle';ox.fillText(obj.label,cx2,cy2);}ox.restore();});var link=document.createElement('a');link.download='sitemap.png';link.href=oc.toDataURL();link.click();toast('PNG exported');}
function clearAll(){if(!confirm('Clear all objects?'))return;objects=[];selectedId=null;nextId=1;renderAll();renderLayers();renderProps();}
function loadBgImage(input){if(!input.files||!input.files[0])return;var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){bgImage=img;bgOpacity=0.3;document.getElementById('bgRemoveBtn').style.display='';renderAll();renderProps();toast('Background set');};img.src=e.target.result;};reader.readAsDataURL(input.files[0]);input.value='';}
function removeBg(){bgImage=null;bgOpacity=0.3;document.getElementById('bgRemoveBtn').style.display='none';renderAll();renderProps();toast('Background removed');}
function setBgOpacity(val){bgOpacity=parseFloat(val);renderAll();}
function toast(m){var t=document.getElementById('toastEl');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2200);}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ===== BOOT =====
async function init(){
  var s=await checkAuth();if(!s)return;
  userId=s.user.id;authUid=s.user.id;var email=s.user.email||'';
  try{var ur=await sb.from('users').select('tenant_id,user_id').eq('email',email).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}}catch(e){}
  if(!tenantId){try{var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}catch(e){}}
  if(!tenantId)toast('Warning: Could not resolve tenant');
  initUI();initCanvas();setupEvents();
  document.getElementById('tbGrid').classList.add('active');
  await loadMaps();
  var lastId=localStorage.getItem('elp-last-map');
  if(lastId&&allMaps.find(function(m){return m.id===lastId;}))switchMap(lastId);
  else if(allMaps.length)switchMap(allMaps[0].id);
}
init();
</script>
</body>
</html>
