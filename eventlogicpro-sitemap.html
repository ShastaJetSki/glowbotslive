<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Site Map Creator — EventLogicPro</title>
  <script>(function(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="dark-blue"]{--bg-primary:#0b0f14;--bg-secondary:#0f1621;--bg-card:#1a2535;--bg-hover:#223044;--border-default:#223044;--text-primary:#e8eef6;--text-secondary:#9fb0c3;--accent-primary:#3b82f6;--accent-light:#60a5fa;}
    [data-theme="grey"]{--bg-primary:#111;--bg-secondary:#1a1a1a;--bg-card:#242424;--bg-hover:#2e2e2e;--border-default:#333;--text-primary:#e5e5e5;--text-secondary:#a3a3a3;--accent-primary:#525252;--accent-light:#737373;}
    [data-theme="slate"],[data-theme="slate-dark"]{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:#273549;--bg-hover:#334155;--border-default:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-primary:#6366f1;--accent-light:#818cf8;}
    [data-theme="charcoal"]{--bg-primary:#121214;--bg-secondary:#18181b;--bg-card:#27272a;--bg-hover:#3f3f46;--border-default:#3f3f46;--text-primary:#fafafa;--text-secondary:#a1a1aa;--accent-primary:#a1a1aa;--accent-light:#d4d4d8;}
    [data-theme="midnight"],[data-theme="midnight-dark"]{--bg-primary:#09090b;--bg-secondary:#0f0f12;--bg-card:#18181d;--bg-hover:#222228;--border-default:#27272f;--text-primary:#eeeef0;--text-secondary:#9898a4;--accent-primary:#8b5cf6;--accent-light:#a78bfa;}
    [data-theme="navy"]{--bg-primary:#0a0e1a;--bg-secondary:#0f1526;--bg-card:#182035;--bg-hover:#1f2a45;--border-default:#253352;--text-primary:#e8ecf4;--text-secondary:#9aa5bd;--accent-primary:#4a7cc9;--accent-light:#6b9ae0;}
    [data-theme="graphite"]{--bg-primary:#0d0d0d;--bg-secondary:#141414;--bg-card:#1f1f1f;--bg-hover:#292929;--border-default:#2e2e2e;--text-primary:#e8e8e8;--text-secondary:#999;--accent-primary:#4a9eff;--accent-light:#6bb3ff;}
    [data-theme="ocean"],[data-theme="ocean-dark"]{--bg-primary:#0a1214;--bg-secondary:#0e181c;--bg-card:#152228;--bg-hover:#1c2d35;--border-default:#243842;--text-primary:#e5f0f3;--text-secondary:#8faab5;--accent-primary:#14b8a6;--accent-light:#2dd4bf;}
    [data-theme="forest"],[data-theme="forest-dark"]{--bg-primary:#0a100c;--bg-secondary:#0f1812;--bg-card:#16221a;--bg-hover:#1e2e24;--border-default:#263830;--text-primary:#e5f0e8;--text-secondary:#8faa96;--accent-primary:#22c55e;--accent-light:#4ade80;}
    [data-theme="obsidian"]{--bg-primary:#050505;--bg-secondary:#0a0a0a;--bg-card:#141414;--bg-hover:#1c1c1c;--border-default:#252525;--text-primary:#e0e0e0;--text-secondary:#888;--accent-primary:#0ea5e9;--accent-light:#38bdf8;}
    [data-theme="steel"]{--bg-primary:#0c0f13;--bg-secondary:#12161c;--bg-card:#1a2028;--bg-hover:#242c38;--border-default:#2c3644;--text-primary:#e4e8ed;--text-secondary:#8b95a5;--accent-primary:#64748b;--accent-light:#94a3b8;}
    [data-theme="espresso"]{--bg-primary:#0f0c0a;--bg-secondary:#161210;--bg-card:#211c18;--bg-hover:#2c2520;--border-default:#382f28;--text-primary:#f0ebe5;--text-secondary:#a89e94;--accent-primary:#a78b6e;--accent-light:#c4a88a;}
    [data-theme="onyx"]{--bg-primary:#000;--bg-secondary:#080808;--bg-card:#121212;--bg-hover:#1a1a1a;--border-default:#222;--text-primary:#f5f5f5;--text-secondary:#8c8c8c;--accent-primary:#06b6d4;--accent-light:#22d3ee;}
    [data-theme="light-blue"],[data-theme="blue-light"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#2563eb;--accent-light:#3b82f6;}
    [data-theme="light-grey"],[data-theme="slate-light"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#e5e5e5;--border-default:#d4d4d4;--text-primary:#171717;--text-secondary:#525252;--accent-primary:#404040;--accent-light:#525252;}
    [data-theme="light-slate"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#0f172a;--text-secondary:#475569;--accent-primary:#4f46e5;--accent-light:#6366f1;}
    [data-theme="light-ocean"],[data-theme="ocean-light"]{--bg-primary:#f0fdfa;--bg-secondary:#ccfbf1;--bg-card:#fff;--bg-hover:#99f6e4;--border-default:#5eead4;--text-primary:#134e4a;--text-secondary:#0f766e;--accent-primary:#0d9488;--accent-light:#14b8a6;}
    [data-theme="light-forest"],[data-theme="mint-light"],[data-theme="mint"]{--bg-primary:#f0fdf4;--bg-secondary:#dcfce7;--bg-card:#fff;--bg-hover:#bbf7d0;--border-default:#86efac;--text-primary:#14532d;--text-secondary:#166534;--accent-primary:#16a34a;--accent-light:#22c55e;}
    [data-theme="light-midnight"],[data-theme="lavender-light"],[data-theme="lavender"]{--bg-primary:#faf5ff;--bg-secondary:#f3e8ff;--bg-card:#fff;--bg-hover:#e9d5ff;--border-default:#d8b4fe;--text-primary:#1e1b4b;--text-secondary:#5b21b6;--accent-primary:#7c3aed;--accent-light:#8b5cf6;}
    [data-theme="light-obsidian"],[data-theme="sky-light"],[data-theme="sky"]{--bg-primary:#f0f9ff;--bg-secondary:#e0f2fe;--bg-card:#fff;--bg-hover:#bae6fd;--border-default:#7dd3fc;--text-primary:#0c4a6e;--text-secondary:#0369a1;--accent-primary:#0284c7;--accent-light:#0ea5e9;}
    [data-theme="light-espresso"]{--bg-primary:#fefcfb;--bg-secondary:#fdf4ef;--bg-card:#fff;--bg-hover:#f5e6db;--border-default:#ddc9b8;--text-primary:#3d2c1e;--text-secondary:#6b5344;--accent-primary:#8b6f4e;--accent-light:#a78b6e;}
    [data-theme="light-graphite"]{--bg-primary:#fafafa;--bg-secondary:#f5f5f5;--bg-card:#fff;--bg-hover:#ebebeb;--border-default:#d1d1d1;--text-primary:#1a1a1a;--text-secondary:#4a4a4a;--accent-primary:#2196f3;--accent-light:#42a5f5;}
    [data-theme="light-onyx"]{--bg-primary:#ecfeff;--bg-secondary:#cffafe;--bg-card:#fff;--bg-hover:#a5f3fc;--border-default:#67e8f9;--text-primary:#164e63;--text-secondary:#0e7490;--accent-primary:#0891b2;--accent-light:#06b6d4;}
    [data-theme="light-steel"]{--bg-primary:#f8fafc;--bg-secondary:#f1f5f9;--bg-card:#fff;--bg-hover:#e2e8f0;--border-default:#cbd5e1;--text-primary:#1e293b;--text-secondary:#475569;--accent-primary:#475569;--accent-light:#64748b;}
    [data-theme="light-navy"]{--bg-primary:#f0f4ff;--bg-secondary:#e0e7ff;--bg-card:#fff;--bg-hover:#c7d2fe;--border-default:#a5b4fc;--text-primary:#1e1b4b;--text-secondary:#3730a3;--accent-primary:#3949ab;--accent-light:#5c6bc0;}
    [data-theme="light-charcoal"]{--bg-primary:#fafafa;--bg-secondary:#f4f4f5;--bg-card:#fff;--bg-hover:#e4e4e7;--border-default:#d4d4d8;--text-primary:#18181b;--text-secondary:#52525b;--accent-primary:#71717a;--accent-light:#a1a1aa;}
    [data-theme="cyber-dark"],[data-theme="cyber"]{--bg-primary:#0a0a0f;--bg-secondary:#0f0f18;--bg-card:#151522;--bg-hover:#1c1c2e;--border-default:#2a2a44;--text-primary:#e0e0ff;--text-secondary:#9090c0;--accent-primary:#00ff88;--accent-light:#44ffaa;}
    [data-theme="amber-dark"],[data-theme="amber"]{--bg-primary:#0f0c05;--bg-secondary:#1a1508;--bg-card:#26200c;--bg-hover:#332a10;--border-default:#443815;--text-primary:#fef3c7;--text-secondary:#c9b896;--accent-primary:#f59e0b;--accent-light:#fbbf24;}
    [data-theme="honey-light"],[data-theme="honey"]{--bg-primary:#fffbeb;--bg-secondary:#fef3c7;--bg-card:#fff;--bg-hover:#fde68a;--border-default:#fcd34d;--text-primary:#78350f;--text-secondary:#a06020;--accent-primary:#d97706;--accent-light:#f59e0b;}
    [data-theme="crimson-dark"],[data-theme="crimson"]{--bg-primary:#0f0708;--bg-secondary:#1a0c0e;--bg-card:#261214;--bg-hover:#331a1c;--border-default:#442225;--text-primary:#fee2e2;--text-secondary:#c9a3a5;--accent-primary:#dc2626;--accent-light:#ef4444;}
    [data-theme="coral-light"],[data-theme="coral"]{--bg-primary:#fff5f5;--bg-secondary:#fee2e2;--bg-card:#fff;--bg-hover:#fecaca;--border-default:#fca5a5;--text-primary:#7f1d1d;--text-secondary:#a04444;--accent-primary:#ef4444;--accent-light:#f87171;}
    [data-theme="rose-dark"],[data-theme="rose"]{--bg-primary:#0f070a;--bg-secondary:#1a0c12;--bg-card:#26121a;--bg-hover:#331a24;--border-default:#44222e;--text-primary:#ffe4ec;--text-secondary:#c9a3b0;--accent-primary:#ec4899;--accent-light:#f472b6;}
    [data-theme="sand-light"],[data-theme="sand"]{--bg-primary:#fefcf8;--bg-secondary:#faf6ee;--bg-card:#fff;--bg-hover:#f5efe0;--border-default:#e8dcc8;--text-primary:#44402a;--text-secondary:#6a6550;--accent-primary:#a89060;--accent-light:#c4aa78;}

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html{scrollbar-gutter:stable;}html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow:hidden;height:100vh;}

    /* === SHARED HEADER STYLES === */
    .desktop-header{background:var(--bg-secondary);border-bottom:1px solid var(--border-default);flex-shrink:0;}
    .business-name{font-size:12px;color:var(--accent-light);}
    .theme-toggle-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .theme-toggle-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .theme-toggle-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none;}
    .mobile-top-header{display:none;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);flex-shrink:0;}
    .mobile-header-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;gap:8px;}
    .mobile-menu-toggle{background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text-secondary);font-size:20px;padding:0;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .mobile-header-center{flex:1;}.mobile-header-title{font-size:16px;font-weight:600;}
    .mobile-header-content{max-height:0;overflow:hidden;transition:max-height .3s ease;}
    .mobile-header-content.expanded{max-height:200px;}
    .mobile-header-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:8px 12px 12px;background:var(--bg-primary);border-top:1px solid var(--border-default);}
    .mobile-header-actions button{padding:10px;font-size:13px;background:color-mix(in srgb,var(--accent-primary) 10%,transparent);border:1px solid color-mix(in srgb,var(--accent-primary) 30%,transparent);color:var(--accent-light);border-radius:8px;cursor:pointer;}
    .mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);padding:6px 8px;z-index:100;border-top:1px solid var(--border-default);}
    .mobile-nav-top{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;}
    .mobile-nav-btn{padding:8px 4px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;min-height:40px;transition:all .2s;}
    .mobile-nav-btn.active{background:color-mix(in srgb,var(--accent-primary) 60%,transparent);border-color:var(--accent-primary);color:var(--text-primary);}

    /* === APP LAYOUT === */
    .app{display:flex;height:100vh;flex-direction:column;}
    .top-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--border-default);flex-shrink:0;z-index:10;}
    .top-bar h1{font-size:20px;font-weight:700;letter-spacing:-.3px;}
    .top-bar h1 span{color:var(--accent-light);font-weight:400;font-size:14px;margin-left:8px;}
    .top-actions{display:flex;gap:6px;align-items:center;}
    .btn{padding:7px 14px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .15s;}
    .btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .btn.pri{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary);}
    .btn.pri:hover{opacity:.9;}
    .btn.danger{color:#ef4444;border-color:rgba(239,68,68,.3);}
    .btn.danger:hover{background:rgba(239,68,68,.1);}

    .workspace{display:flex;flex:1;overflow:hidden;}

    /* === LEFT PANEL: SHAPE LIBRARY === */
    .panel-left{width:220px;background:var(--bg-secondary);border-right:1px solid var(--border-default);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;}
    .panel-section{padding:12px;}
    .panel-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-secondary);margin-bottom:10px;}
    .shape-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;}
    .shape-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;-webkit-user-select:none;user-select:none;}
    .shape-btn:hover{border-color:var(--accent-primary);color:var(--text-primary);background:var(--bg-hover);}
    .shape-btn.active{border-color:var(--accent-primary);background:color-mix(in srgb,var(--accent-primary) 15%,transparent);color:var(--accent-light);}
    .shape-btn svg{width:28px;height:28px;}
    .shape-btn canvas{width:28px;height:28px;}

    .color-row{display:flex;gap:5px;flex-wrap:wrap;}
    .color-swatch{width:24px;height:24px;border-radius:6px;border:2px solid transparent;cursor:pointer;transition:all .12s;}
    .color-swatch:hover{transform:scale(1.15);}
    .color-swatch.active{border-color:var(--text-primary);transform:scale(1.15);}

    .preset-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;}
    .preset-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-card);color:var(--text-secondary);font-size:9px;font-weight:600;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:.3px;}
    .preset-btn:hover{border-color:var(--accent-primary);color:var(--text-primary);}
    .preset-btn .pi{font-size:20px;line-height:1;}

    /* === CANVAS === */
    .canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--bg-primary);}
    .canvas-wrap canvas{position:absolute;top:0;left:0;cursor:crosshair;}

    /* === RIGHT PANEL: PROPERTIES === */
    .panel-right{width:220px;background:var(--bg-secondary);border-left:1px solid var(--border-default);flex-shrink:0;overflow-y:auto;display:flex;flex-direction:column;}
    .prop-group{padding:12px;border-bottom:1px solid var(--border-default);}
    .prop-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:6px;}
    .prop-row{display:flex;gap:6px;align-items:center;margin-bottom:6px;}
    .prop-input{flex:1;padding:6px 8px;border-radius:6px;border:1px solid var(--border-default);background:var(--bg-primary);color:var(--text-primary);font-size:12px;font-family:inherit;width:100%;}
    .prop-input:focus{outline:none;border-color:var(--accent-primary);}
    .prop-sm{width:60px;text-align:center;}
    .prop-unit{font-size:10px;color:var(--text-secondary);flex-shrink:0;}
    .slider-row{display:flex;align-items:center;gap:8px;}
    .slider-row input[type="range"]{flex:1;accent-color:var(--accent-primary);height:4px;}
    .slider-val{font-size:11px;color:var(--text-secondary);min-width:30px;text-align:right;}
    .empty-props{padding:24px 16px;text-align:center;color:var(--text-secondary);font-size:12px;line-height:1.6;}

    .layer-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:all .12s;border:1px solid transparent;}
    .layer-item:hover{background:var(--bg-hover);}
    .layer-item.active{background:color-mix(in srgb,var(--accent-primary) 12%,transparent);border-color:color-mix(in srgb,var(--accent-primary) 30%,transparent);}
    .layer-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
    .layer-name{font-size:12px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .layer-del{width:20px;height:20px;border:none;background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .12s;}
    .layer-item:hover .layer-del{opacity:.6;}
    .layer-del:hover{opacity:1!important;background:rgba(239,68,68,.15);color:#ef4444;}

    .canvas-toolbar{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:6px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-default);border-radius:10px;z-index:5;box-shadow:0 4px 20px rgba(0,0,0,.3);}
    .ct-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border-default);background:transparent;color:var(--text-secondary);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;}
    .ct-btn:hover{background:var(--bg-hover);color:var(--text-primary);}
    .ct-btn.active{background:color-mix(in srgb,var(--accent-primary) 20%,transparent);color:var(--accent-light);border-color:var(--accent-primary);}
    .ct-sep{width:1px;background:var(--border-default);margin:4px 2px;}
    .zoom-label{font-size:11px;color:var(--text-secondary);display:flex;align-items:center;padding:0 4px;font-weight:600;min-width:40px;justify-content:center;}
    .grid-canvas{position:absolute;top:0;left:0;pointer-events:none;z-index:0;}

    .theme-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:14px;z-index:1000;display:none;}
    .theme-toast.show{display:block;animation:toastIn .3s ease;}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

    @media(max-width:900px){.panel-left{width:180px;}.panel-right{width:180px;}}
    @media(max-width:768px){
      .desktop-header{display:none !important;}.mobile-top-header{display:block !important;}.mobile-bottom-nav{display:block !important;}
      .panel-right{display:none;}.panel-left{width:160px;}
      .canvas-toolbar{bottom:70px;}
    }
    @media(min-width:769px){.mobile-top-header{display:none !important;}.mobile-bottom-nav{display:none !important;}}
  </style>
</head>
<body>
<div class="app">

  <!-- MOBILE HEADER -->
  <div class="mobile-top-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)"><span>&#9776;</span></button>
      <div class="mobile-header-center"><div class="mobile-header-title">Site Map Creator</div><div class="business-name" id="mBizName">EventLogicPro</div></div>
      <button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
    </div>
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-actions">
        <button onclick="location.href='eventlogicpro-settings.html'">Settings</button>
        <button onclick="doLogout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- DESKTOP HEADER -->
  <div class="desktop-header">
    <div style="padding:14px 24px 6px;display:flex;justify-content:space-between;align-items:center;">
      <div><h1 style="margin:0;font-size:28px;font-weight:600;">EventLogicPro</h1><div class="business-name" id="dBizName">Loading...</div></div>
      <div style="display:flex;align-items:center;gap:14px;"><button class="theme-toggle-btn" onclick="cycleTheme()" title="Change theme"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button><a onclick="doLogout()" style="color:var(--text-secondary);cursor:pointer;font-size:13px;">Logout</a></div>
    </div>
    <div style="padding:0 24px 10px;"><nav style="display:flex;gap:24px;"><a href="eventlogicpro-scheduler.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Calendar</a><a href="eventlogicpro.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Tasks</a><a href="eventlogicpro-estimator.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Budget</a><a href="eventlogicpro-sponsors.html" style="padding:10px 0;color:var(--text-secondary);text-decoration:none;font-size:13px;">Sponsors</a><a href="eventlogicpro-sitemap.html" style="padding:10px 0;color:var(--accent-primary);text-decoration:none;font-size:13px;border-bottom:2px solid var(--accent-primary);">Site Map</a></nav></div>
  </div>

  <!-- SITEMAP TOOLBAR (map-specific controls only) -->
  <div class="top-bar">
    <h1>Site Map Creator</h1>
    <div class="top-actions">
      <select id="mapSelect" class="prop-input" style="max-width:200px;font-size:12px;padding:6px 8px;" onchange="switchMap(this.value)">
        <option value="">-- No saved maps --</option>
      </select>
      <button class="btn pri" onclick="saveMap()">Save</button>
      <button class="btn" onclick="newMap()">+ New</button>
      <button class="btn danger" id="deleteMapBtn" onclick="deleteMap()" style="display:none;">Delete</button>
      <div style="width:1px;height:24px;background:var(--border-default);"></div>
      <button class="btn" onclick="document.getElementById('bgInput').click()">BG Image</button>
      <button class="btn" id="bgRemoveBtn" onclick="removeBg()" style="display:none;">Remove BG</button>
      <input type="file" id="bgInput" accept="image/*" style="display:none;" onchange="loadBgImage(this)">
      <button class="btn" onclick="exportPNG()">Export PNG</button>
      <button class="btn" onclick="clearAll()">Clear</button>
    </div>
  </div>

  <div class="workspace">
    <!-- Left Panel: Shapes -->
    <div class="panel-left">
      <div class="panel-section">
        <div class="panel-title">Shapes</div>
        <div class="shape-grid" id="shapeGrid"></div>
      </div>
      <div class="panel-section" style="border-top:1px solid var(--border-default);">
        <div class="panel-title">Event Presets</div>
        <div class="preset-grid" id="presetGrid"></div>
      </div>
      <div class="panel-section" style="border-top:1px solid var(--border-default);">
        <div class="panel-title">Fill Color</div>
        <div class="color-row" id="colorRow"></div>
      </div>
      <div class="panel-section" style="border-top:1px solid var(--border-default);">
        <div class="panel-title">Layers</div>
        <div id="layerList"></div>
      </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-wrap" id="canvasWrap">
      <canvas id="gridCanvas" class="grid-canvas"></canvas>
      <canvas id="mainCanvas"></canvas>
      <div class="canvas-toolbar">
        <button class="ct-btn active" id="tbSelect" onclick="setTool('select')" title="Select (V)">&#9995;</button>
        <button class="ct-btn" id="tbDraw" onclick="setTool('draw')" title="Draw Shape">&#9998;</button>
        <div class="ct-sep"></div>
        <button class="ct-btn" onclick="zoomIn()" title="Zoom In">+</button>
        <span class="zoom-label" id="zoomLabel">100%</span>
        <button class="ct-btn" onclick="zoomOut()" title="Zoom Out">&minus;</button>
        <button class="ct-btn" onclick="zoomFit()" title="Fit">&#9634;</button>
        <div class="ct-sep"></div>
        <button class="ct-btn" id="tbGrid" onclick="toggleGrid()" title="Toggle Grid">&#9638;</button>
      </div>
    </div>

    <!-- Right Panel: Properties -->
    <div class="panel-right">
      <div id="propsPanel">
        <div class="empty-props">Select an object to<br>edit its properties</div>
      </div>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-bottom-nav"><div class="mobile-nav-top"><a href="eventlogicpro-scheduler.html" class="mobile-nav-btn">Calendar</a><a href="eventlogicpro.html" class="mobile-nav-btn">Tasks</a><a href="eventlogicpro-estimator.html" class="mobile-nav-btn">Budget</a><a href="eventlogicpro-sponsors.html" class="mobile-nav-btn">Sponsors</a><a href="eventlogicpro-sitemap.html" class="mobile-nav-btn active">Site Map</a></div></div>

<div id="themeToast" class="theme-toast"></div>

<script>
// ===== AUTH =====
var SB_URL='https://kxqkwpkmtgvmthpafoqx.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);

// ===== THEME =====
var themes=['dark-blue','grey','slate','charcoal','midnight','navy','graphite','ocean','forest','obsidian','steel','espresso','onyx','light-blue','light-grey','light-slate','light-ocean','light-forest','light-midnight','light-obsidian','light-espresso','light-graphite','light-onyx','light-steel','light-navy','light-charcoal','cyber','amber','honey','crimson','coral','rose','sand'];var themeIdx=0;
function loadTheme(){var t=localStorage.getItem('app-theme')||'dark-blue';document.documentElement.setAttribute('data-theme',t);themeIdx=themes.indexOf(t);if(themeIdx<0)themeIdx=0;}
function cycleTheme(){themeIdx=(themeIdx+1)%themes.length;var t=themes[themeIdx];document.documentElement.setAttribute('data-theme',t);localStorage.setItem('app-theme',t);showThemeToast(t.replace(/-/g,' '));}
function showThemeToast(msg){var t=document.getElementById('themeToast');t.textContent='Theme: '+msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2000);}
loadTheme();

function toggleMobileMenu(btn){document.getElementById('mobileHeaderContent').classList.toggle('expanded');btn.classList.toggle('active');}

async function checkAuth(){
  var r=await sb.auth.getSession();var s=r.data.session;
  if(!s){var t=localStorage.getItem('sb_access_token'),rf=localStorage.getItem('sb_refresh_token');
    if(t&&rf){var sr=await sb.auth.setSession({access_token:t,refresh_token:rf});s=sr.data?.session;}
    if(!s){window.location.href='login.html';return null;}}
  return s;
}
async function doLogout(){await sb.auth.signOut();localStorage.removeItem('sb_access_token');localStorage.removeItem('sb_refresh_token');window.location.href='login.html';}

// ===== CONFIG =====
var COLORS=['#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316','#06b6d4','#84cc16','#64748b','#dc2626','#a78bfa','#fbbf24','#10b981','#f472b6','#0ea5e9','#fb923c','#e879f9','#334155'];

var SHAPES=[
  {id:'rect',name:'Rectangle',icon:function(ctx,s){ctx.fillStyle=s;ctx.fillRect(4,8,20,12);}},
  {id:'square',name:'Square',icon:function(ctx,s){ctx.fillStyle=s;ctx.fillRect(6,6,16,16);}},
  {id:'circle',name:'Circle',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.arc(14,14,9,0,Math.PI*2);ctx.fill();}},
  {id:'ellipse',name:'Ellipse',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.ellipse(14,14,12,7,0,0,Math.PI*2);ctx.fill();}},
  {id:'triangle',name:'Triangle',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.moveTo(14,4);ctx.lineTo(26,24);ctx.lineTo(2,24);ctx.closePath();ctx.fill();}},
  {id:'star',name:'Star',icon:function(ctx,s){ctx.fillStyle=s;drawStar(ctx,14,14,5,10,5);ctx.fill();}},
  {id:'diamond',name:'Diamond',icon:function(ctx,s){ctx.fillStyle=s;ctx.beginPath();ctx.moveTo(14,3);ctx.lineTo(25,14);ctx.lineTo(14,25);ctx.lineTo(3,14);ctx.closePath();ctx.fill();}},
  {id:'line',name:'Line',icon:function(ctx,s){ctx.strokeStyle=s;ctx.lineWidth=3;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(4,24);ctx.lineTo(24,4);ctx.stroke();}}
];

var PRESETS=[
  {name:'Stage',shape:'rect',w:160,h:80,color:'#8b5cf6',label:'STAGE'},
  {name:'Tent',shape:'rect',w:100,h:100,color:'#14b8a6',label:'TENT'},
  {name:'Bathroom',shape:'square',w:50,h:50,color:'#3b82f6',label:'WC'},
  {name:'Parking',shape:'rect',w:120,h:200,color:'#64748b',label:'PARKING'},
  {name:'Bar',shape:'rect',w:80,h:40,color:'#f59e0b',label:'BAR'},
  {name:'Food',shape:'rect',w:80,h:60,color:'#f97316',label:'FOOD'},
  {name:'Gate',shape:'rect',w:60,h:20,color:'#ef4444',label:'GATE'},
  {name:'Med',shape:'square',w:40,h:40,color:'#dc2626',label:'MED'},
  {name:'Vendor',shape:'square',w:50,h:50,color:'#22c55e',label:'VENDOR'},
  {name:'Merch',shape:'rect',w:60,h:40,color:'#fbbf24',label:'MERCH'},
  {name:'Sound',shape:'rect',w:50,h:30,color:'#6366f1',label:'SOUND'},
  {name:'Car',shape:'rect',w:30,h:50,color:'#475569',label:'CAR'},
  {name:'VIP',shape:'rect',w:100,h:60,color:'#ec4899',label:'VIP'},
  {name:'Table',shape:'circle',w:40,h:40,color:'#a78bfa',label:'TABLE'},
  {name:'Tree',shape:'circle',w:30,h:30,color:'#22c55e',label:''},
  {name:'Fence',shape:'line',w:120,h:4,color:'#64748b',label:''}
];

// ===== STATE =====
var objects=[];var selectedId=null;var currentShape='rect';var currentColor=COLORS[0];var tool='select';var showGrid=true;var zoom=1;var panX=0,panY=0;var isDragging=false,isResizing=false,isPanning=false,isDrawing=false;var dragStart={x:0,y:0},objStart={x:0,y:0,w:0,h:0};var drawStart=null;var resizeHandle='';var nextId=1;var bgImage=null;var bgOpacity=0.3;var tenantId=null,userId=null,authUid=null;var allMaps=[],currentMapId=null;
var wrap,mainCanvas,ctx,gridCanvas,gctx;var W,H;

function drawStar(ctx,cx,cy,spikes,R,r){ctx.beginPath();var rot=Math.PI/2*3,step=Math.PI/spikes;ctx.moveTo(cx,cy-R);for(var i=0;i<spikes;i++){var x=cx+Math.cos(rot)*R,y=cy+Math.sin(rot)*R;ctx.lineTo(x,y);rot+=step;x=cx+Math.cos(rot)*r;y=cy+Math.sin(rot)*r;ctx.lineTo(x,y);rot+=step;}ctx.closePath();}

function initUI(){var sg=document.getElementById('shapeGrid');SHAPES.forEach(function(s){var btn=document.createElement('div');btn.className='shape-btn'+(currentShape===s.id?' active':'');btn.dataset.shape=s.id;var cv=document.createElement('canvas');cv.width=28;cv.height=28;var c=cv.getContext('2d');s.icon(c,currentColor);btn.appendChild(cv);var lbl=document.createElement('span');lbl.textContent=s.name;btn.appendChild(lbl);btn.onclick=function(){currentShape=s.id;tool='draw';document.querySelectorAll('.shape-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');updateToolbar();};sg.appendChild(btn);});
var pg=document.getElementById('presetGrid');PRESETS.forEach(function(p){var btn=document.createElement('div');btn.className='preset-btn';btn.innerHTML='<span class="pi" style="color:'+p.color+';">&#9632;</span>'+p.name;btn.onclick=function(){addPreset(p);};pg.appendChild(btn);});
var cr=document.getElementById('colorRow');COLORS.forEach(function(c){var sw=document.createElement('div');sw.className='color-swatch'+(c===currentColor?' active':'');sw.style.background=c;sw.onclick=function(){currentColor=c;cr.querySelectorAll('.color-swatch').forEach(function(s){s.classList.remove('active');});sw.classList.add('active');if(selectedId!==null){var obj=getObj(selectedId);if(obj){obj.color=c;renderAll();renderProps();}}updateShapeIcons();};cr.appendChild(sw);});}
function updateShapeIcons(){document.querySelectorAll('.shape-btn').forEach(function(btn){var cv=btn.querySelector('canvas');if(!cv)return;var c=cv.getContext('2d');c.clearRect(0,0,28,28);var s=SHAPES.find(function(sh){return sh.id===btn.dataset.shape;});if(s)s.icon(c,currentColor);});}
function updateToolbar(){document.getElementById('tbSelect').classList.toggle('active',tool==='select');document.getElementById('tbDraw').classList.toggle('active',tool==='draw');}
function setTool(t){tool=t;updateToolbar();if(t==='select'){document.querySelectorAll('.shape-btn').forEach(function(b){b.classList.remove('active');});}}
function initCanvas(){wrap=document.getElementById('canvasWrap');mainCanvas=document.getElementById('mainCanvas');ctx=mainCanvas.getContext('2d');gridCanvas=document.getElementById('gridCanvas');gctx=gridCanvas.getContext('2d');resize();window.addEventListener('resize',resize);}
function resize(){W=wrap.clientWidth;H=wrap.clientHeight;mainCanvas.width=W;mainCanvas.height=H;gridCanvas.width=W;gridCanvas.height=H;mainCanvas.style.width=W+'px';mainCanvas.style.height=H+'px';gridCanvas.style.width=W+'px';gridCanvas.style.height=H+'px';renderAll();}
function drawGrid(){gctx.clearRect(0,0,W,H);if(!showGrid)return;var step=20*zoom;var offX=panX%step,offY=panY%step;gctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--border-default').trim();gctx.lineWidth=0.5;gctx.globalAlpha=0.5;for(var x=offX;x<W;x+=step){gctx.beginPath();gctx.moveTo(x,0);gctx.lineTo(x,H);gctx.stroke();}for(var y=offY;y<H;y+=step){gctx.beginPath();gctx.moveTo(0,y);gctx.lineTo(W,y);gctx.stroke();}gctx.globalAlpha=1;}
function toggleGrid(){showGrid=!showGrid;document.getElementById('tbGrid').classList.toggle('active',showGrid);drawGrid();}
function addObj(shape,x,y,w,h,color,label,rotation){var obj={id:nextId++,shape:shape,x:x,y:y,w:Math.max(w,10),h:Math.max(h,10),color:color||currentColor,label:label||'',rotation:rotation||0,opacity:1};objects.push(obj);selectedId=obj.id;renderAll();renderLayers();renderProps();return obj;}
function getObj(id){return objects.find(function(o){return o.id===id;});}
function deleteObj(id){objects=objects.filter(function(o){return o.id!==id;});if(selectedId===id)selectedId=null;renderAll();renderLayers();renderProps();}
function addPreset(p){var cx=(W/2-panX)/zoom,cy=(H/2-panY)/zoom;addObj(p.shape,cx-p.w/2,cy-p.h/2,p.w,p.h,p.color,p.label);tool='select';updateToolbar();}
function renderAll(){ctx.clearRect(0,0,W,H);drawGrid();ctx.save();ctx.translate(panX,panY);ctx.scale(zoom,zoom);if(bgImage){ctx.globalAlpha=bgOpacity;ctx.drawImage(bgImage,0,0);ctx.globalAlpha=1;}objects.forEach(function(obj){ctx.save();ctx.globalAlpha=obj.opacity;var cx=obj.x+obj.w/2,cy=obj.y+obj.h/2;ctx.translate(cx,cy);ctx.rotate((obj.rotation||0)*Math.PI/180);ctx.translate(-cx,-cy);drawShape(ctx,obj);if(obj.label){ctx.fillStyle='#fff';ctx.font='bold '+Math.min(14,obj.h*0.35)+'px system-ui,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowColor='rgba(0,0,0,.5)';ctx.shadowBlur=3;ctx.fillText(obj.label,cx,cy);ctx.shadowBlur=0;}ctx.restore();if(obj.id===selectedId){ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent-light').trim();ctx.lineWidth=2/zoom;ctx.setLineDash([6/zoom,4/zoom]);ctx.strokeRect(obj.x-2/zoom,obj.y-2/zoom,obj.w+4/zoom,obj.h+4/zoom);ctx.setLineDash([]);var hs=6/zoom;var handles=[{x:obj.x-hs,y:obj.y-hs},{x:obj.x+obj.w,y:obj.y-hs},{x:obj.x-hs,y:obj.y+obj.h},{x:obj.x+obj.w,y:obj.y+obj.h}];ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();handles.forEach(function(h){ctx.fillRect(h.x,h.y,hs,hs);});}});ctx.restore();}
function drawShape(ctx,obj){ctx.fillStyle=obj.color;ctx.strokeStyle=obj.color;switch(obj.shape){case 'rect':case 'square':ctx.fillRect(obj.x,obj.y,obj.w,obj.h);break;case 'circle':var r=Math.min(obj.w,obj.h)/2;ctx.beginPath();ctx.arc(obj.x+obj.w/2,obj.y+obj.h/2,r,0,Math.PI*2);ctx.fill();break;case 'ellipse':ctx.beginPath();ctx.ellipse(obj.x+obj.w/2,obj.y+obj.h/2,obj.w/2,obj.h/2,0,0,Math.PI*2);ctx.fill();break;case 'triangle':ctx.beginPath();ctx.moveTo(obj.x+obj.w/2,obj.y);ctx.lineTo(obj.x+obj.w,obj.y+obj.h);ctx.lineTo(obj.x,obj.y+obj.h);ctx.closePath();ctx.fill();break;case 'star':drawStar(ctx,obj.x+obj.w/2,obj.y+obj.h/2,5,Math.min(obj.w,obj.h)/2,Math.min(obj.w,obj.h)/4.5);ctx.fill();break;case 'diamond':ctx.beginPath();var cx2=obj.x+obj.w/2,cy2=obj.y+obj.h/2;ctx.moveTo(cx2,obj.y);ctx.lineTo(obj.x+obj.w,cy2);ctx.lineTo(cx2,obj.y+obj.h);ctx.lineTo(obj.x,cy2);ctx.closePath();ctx.fill();break;case 'line':ctx.lineWidth=Math.max(3,obj.h);ctx.lineCap='round';ctx.beginPath();ctx.moveTo(obj.x,obj.y+obj.h/2);ctx.lineTo(obj.x+obj.w,obj.y+obj.h/2);ctx.stroke();break;}}
function renderLayers(){var el=document.getElementById('layerList');if(!objects.length){el.innerHTML='<div style="padding:8px;color:var(--text-secondary);font-size:11px;">No objects yet</div>';return;}el.innerHTML=objects.slice().reverse().map(function(obj){return '<div class="layer-item'+(obj.id===selectedId?' active':'')+'" onclick="selectObj('+obj.id+')">'+'<div class="layer-dot" style="background:'+obj.color+'"></div>'+'<span class="layer-name">'+(obj.label||obj.shape+' #'+obj.id)+'</span>'+'<button class="layer-del" onclick="event.stopPropagation();deleteObj('+obj.id+')">&times;</button></div>';}).join('');}
function selectObj(id){selectedId=id;renderAll();renderLayers();renderProps();}
function renderProps(){var el=document.getElementById('propsPanel');if(selectedId===null){var map=currentMapId?allMaps.find(function(m){return m.id===currentMapId;}):null;var bgHtml='<div class="empty-props">'+(map?'<strong>'+esc(map.name)+'</strong><br><button class="btn" onclick="renameMap()" style="margin-top:6px;font-size:11px;">Rename</button>':'Select an object to<br>edit its properties')+'</div>';if(bgImage){bgHtml+='<div class="prop-group"><div class="prop-label">Background Image</div>';bgHtml+='<div class="slider-row"><span class="prop-unit" style="font-size:11px;">Opacity</span><input type="range" min="5" max="100" value="'+Math.round(bgOpacity*100)+'" oninput="setBgOpacity(this.value/100);this.parentElement.querySelector(\'.slider-val\').textContent=this.value+\'%\'"><span class="slider-val">'+Math.round(bgOpacity*100)+'%</span></div>';bgHtml+='<button class="btn danger" onclick="removeBg()" style="width:100%;margin-top:8px;">Remove Background</button></div>';}el.innerHTML=bgHtml;return;}var obj=getObj(selectedId);if(!obj){el.innerHTML='';return;}var h='<div class="prop-group"><div class="prop-label">Label</div>';h+='<input class="prop-input" value="'+esc(obj.label)+'" oninput="propSet(\'label\',this.value)" placeholder="Enter label"></div>';h+='<div class="prop-group"><div class="prop-label">Position</div>';h+='<div class="prop-row"><span class="prop-unit">X</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.x)+'" oninput="propSet(\'x\',+this.value)">';h+='<span class="prop-unit">Y</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.y)+'" oninput="propSet(\'y\',+this.value)"></div></div>';h+='<div class="prop-group"><div class="prop-label">Size</div>';h+='<div class="prop-row"><span class="prop-unit">W</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.w)+'" oninput="propSet(\'w\',Math.max(10,+this.value))">';h+='<span class="prop-unit">H</span><input type="number" class="prop-input prop-sm" value="'+Math.round(obj.h)+'" oninput="propSet(\'h\',Math.max(10,+this.value))"></div></div>';h+='<div class="prop-group"><div class="prop-label">Rotation</div>';h+='<div class="slider-row"><input type="range" min="0" max="360" value="'+(obj.rotation||0)+'" oninput="propSet(\'rotation\',+this.value);this.nextElementSibling.textContent=this.value+\'°\'"><span class="slider-val">'+(obj.rotation||0)+'°</span></div></div>';h+='<div class="prop-group"><div class="prop-label">Opacity</div>';h+='<div class="slider-row"><input type="range" min="10" max="100" value="'+Math.round((obj.opacity||1)*100)+'" oninput="propSet(\'opacity\',this.value/100);this.nextElementSibling.textContent=this.value+\'%\'"><span class="slider-val">'+Math.round((obj.opacity||1)*100)+'%</span></div></div>';h+='<div class="prop-group"><div class="prop-label">Actions</div>';h+='<div class="prop-row"><button class="btn" onclick="dupObj()" style="flex:1;">Duplicate</button>';h+='<button class="btn danger" onclick="deleteObj('+obj.id+')" style="flex:1;">Delete</button></div>';h+='<div class="prop-row"><button class="btn" onclick="bringFwd()" style="flex:1;">Bring Front</button>';h+='<button class="btn" onclick="sendBack()" style="flex:1;">Send Back</button></div></div>';el.innerHTML=h;}
function propSet(key,val){var obj=getObj(selectedId);if(!obj)return;obj[key]=val;renderAll();renderLayers();}
function dupObj(){var obj=getObj(selectedId);if(!obj)return;addObj(obj.shape,obj.x+20,obj.y+20,obj.w,obj.h,obj.color,obj.label,obj.rotation);}
function bringFwd(){var i=objects.findIndex(function(o){return o.id===selectedId;});if(i<0||i>=objects.length-1)return;var tmp=objects[i];objects[i]=objects[i+1];objects[i+1]=tmp;renderAll();renderLayers();}
function sendBack(){var i=objects.findIndex(function(o){return o.id===selectedId;});if(i<=0)return;var tmp=objects[i];objects[i]=objects[i-1];objects[i-1]=tmp;renderAll();renderLayers();}
function hitTest(mx,my){var cx2=(mx-panX)/zoom,cy2=(my-panY)/zoom;for(var i=objects.length-1;i>=0;i--){var o=objects[i];if(cx2>=o.x&&cx2<=o.x+o.w&&cy2>=o.y&&cy2<=o.y+o.h)return o;}return null;}
function hitHandle(mx,my){if(selectedId===null)return'';var obj=getObj(selectedId);if(!obj)return'';var cx2=(mx-panX)/zoom,cy2=(my-panY)/zoom;var hs=8/zoom;var corners=[{name:'nw',x:obj.x,y:obj.y},{name:'ne',x:obj.x+obj.w,y:obj.y},{name:'sw',x:obj.x,y:obj.y+obj.h},{name:'se',x:obj.x+obj.w,y:obj.y+obj.h}];for(var i=0;i<corners.length;i++){if(Math.abs(cx2-corners[i].x)<hs&&Math.abs(cy2-corners[i].y)<hs)return corners[i].name;}return'';}
function canvasXY(e){var r=mainCanvas.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top};}
function setupEvents(){mainCanvas=document.getElementById('mainCanvas');mainCanvas.addEventListener('mousedown',onDown);mainCanvas.addEventListener('mousemove',onMove);mainCanvas.addEventListener('mouseup',onUp);mainCanvas.addEventListener('wheel',onWheel,{passive:false});mainCanvas.addEventListener('dblclick',onDblClick);mainCanvas.addEventListener('touchstart',function(e){e.preventDefault();var t=e.touches[0];onDown({clientX:t.clientX,clientY:t.clientY,button:0});},{passive:false});mainCanvas.addEventListener('touchmove',function(e){e.preventDefault();var t=e.touches[0];onMove({clientX:t.clientX,clientY:t.clientY,buttons:1});},{passive:false});mainCanvas.addEventListener('touchend',function(e){onUp({});});mainCanvas.addEventListener('dragover',function(e){e.preventDefault();e.dataTransfer.dropEffect='copy';});mainCanvas.addEventListener('drop',function(e){e.preventDefault();var file=e.dataTransfer.files&&e.dataTransfer.files[0];if(!file||!file.type.startsWith('image/'))return;var reader=new FileReader();reader.onload=function(ev){var img=new Image();img.onload=function(){bgImage=img;bgOpacity=0.3;document.getElementById('bgRemoveBtn').style.display='';renderAll();renderProps();toast('Background set from dropped image');};img.src=ev.target.result;};reader.readAsDataURL(file);});}
function onDown(e){var p=canvasXY(e);if(e.button===1){isPanning=true;dragStart=p;return;}if(tool==='draw'){isDrawing=true;drawStart=p;return;}var h=hitHandle(p.x,p.y);if(h){isResizing=true;resizeHandle=h;var obj=getObj(selectedId);dragStart=p;objStart={x:obj.x,y:obj.y,w:obj.w,h:obj.h};return;}var hit=hitTest(p.x,p.y);if(hit){selectedId=hit.id;isDragging=true;dragStart=p;objStart={x:hit.x,y:hit.y};renderAll();renderLayers();renderProps();}else{if(e.button===0&&!e.shiftKey){isPanning=true;dragStart=p;}selectedId=null;renderAll();renderLayers();renderProps();}}
function onMove(e){var p=canvasXY(e);if(isPanning){panX+=(p.x-dragStart.x);panY+=(p.y-dragStart.y);dragStart=p;renderAll();return;}if(isDragging){var obj=getObj(selectedId);if(!obj)return;var dx=(p.x-dragStart.x)/zoom,dy=(p.y-dragStart.y)/zoom;obj.x=objStart.x+dx;obj.y=objStart.y+dy;renderAll();return;}if(isResizing){var obj=getObj(selectedId);if(!obj)return;var dx=(p.x-dragStart.x)/zoom,dy=(p.y-dragStart.y)/zoom;if(resizeHandle.includes('e')){obj.w=Math.max(10,objStart.w+dx);}if(resizeHandle.includes('w')){obj.x=objStart.x+dx;obj.w=Math.max(10,objStart.w-dx);}if(resizeHandle.includes('s')){obj.h=Math.max(10,objStart.h+dy);}if(resizeHandle.includes('n')){obj.y=objStart.y+dy;obj.h=Math.max(10,objStart.h-dy);}renderAll();return;}if(isDrawing&&drawStart){renderAll();var x1=(drawStart.x-panX)/zoom,y1=(drawStart.y-panY)/zoom;var x2=(p.x-panX)/zoom,y2=(p.y-panY)/zoom;var rx=Math.min(x1,x2),ry=Math.min(y1,y2),rw=Math.abs(x2-x1),rh=Math.abs(y2-y1);ctx.save();ctx.translate(panX,panY);ctx.scale(zoom,zoom);ctx.globalAlpha=0.5;drawShape(ctx,{shape:currentShape,x:rx,y:ry,w:rw,h:rh,color:currentColor});ctx.restore();return;}var h=hitHandle(p.x,p.y);if(h)mainCanvas.style.cursor=h==='nw'||h==='se'?'nwse-resize':'nesw-resize';else if(hitTest(p.x,p.y))mainCanvas.style.cursor='move';else mainCanvas.style.cursor=tool==='draw'?'crosshair':'grab';}
function onUp(e){if(isDrawing&&drawStart){var p=canvasXY(e.clientX?e:drawStart);var x1=(drawStart.x-panX)/zoom,y1=(drawStart.y-panY)/zoom;var x2=(p.x-panX)/zoom,y2=(p.y-panY)/zoom;var rw=Math.abs(x2-x1),rh=Math.abs(y2-y1);if(rw>5||rh>5){addObj(currentShape,Math.min(x1,x2),Math.min(y1,y2),rw,rh,currentColor,'');}}if(isDragging||isResizing)renderProps();isDragging=false;isResizing=false;isPanning=false;isDrawing=false;drawStart=null;}
function onWheel(e){e.preventDefault();var p=canvasXY(e);var oldZoom=zoom;if(e.deltaY<0)zoom=Math.min(5,zoom*1.1);else zoom=Math.max(0.1,zoom/1.1);panX=p.x-(p.x-panX)*zoom/oldZoom;panY=p.y-(p.y-panY)*zoom/oldZoom;document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';renderAll();}
function onDblClick(e){var p=canvasXY(e);var hit=hitTest(p.x,p.y);if(hit){var lbl=prompt('Label:',hit.label||'');if(lbl!==null){hit.label=lbl;renderAll();renderLayers();renderProps();}}}
function zoomIn(){zoom=Math.min(5,zoom*1.25);document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';renderAll();}
function zoomOut(){zoom=Math.max(0.1,zoom/1.25);document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';renderAll();}
function zoomFit(){zoom=1;panX=0;panY=0;document.getElementById('zoomLabel').textContent='100%';renderAll();}
document.addEventListener('keydown',function(e){if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;if(e.key==='Delete'||e.key==='Backspace'){if(selectedId!==null)deleteObj(selectedId);}if(e.key==='v'||e.key==='V')setTool('select');if(e.key==='d'||e.key==='D'){if(selectedId!==null)dupObj();}if(e.key==='Escape'){selectedId=null;renderAll();renderLayers();renderProps();}});

// ===== DB SAVE/LOAD =====
async function loadMaps(){if(!tenantId)return;var r=await sb.from('site_maps').select('*').eq('tenant_id',tenantId).order('updated_at',{ascending:false});allMaps=r.data||[];renderMapSelect();}
function renderMapSelect(){var sel=document.getElementById('mapSelect');var h='<option value="">-- Select Site Map --</option>';allMaps.forEach(function(m){h+='<option value="'+m.id+'"'+(m.id===currentMapId?' selected':'')+'>'+esc(m.name)+(m.is_shared?' [SHARED]':'')+'</option>';});sel.innerHTML=h;document.getElementById('deleteMapBtn').style.display=currentMapId?'':'none';}
async function switchMap(id){if(!id){currentMapId=null;objects=[];nextId=1;selectedId=null;bgImage=null;panX=0;panY=0;zoom=1;renderAll();renderLayers();renderProps();renderMapSelect();return;}var map=allMaps.find(function(m){return m.id===id;});if(!map)return;currentMapId=id;objects=map.objects||[];nextId=objects.length?Math.max.apply(null,objects.map(function(o){return o.id;}))+1:1;panX=map.pan_x||0;panY=map.pan_y||0;zoom=map.zoom_level||1;bgOpacity=map.bg_opacity||0.3;selectedId=null;document.getElementById('zoomLabel').textContent=Math.round(zoom*100)+'%';if(map.bg_image_url){var img=new Image();img.onload=function(){bgImage=img;document.getElementById('bgRemoveBtn').style.display='';renderAll();};img.onerror=function(){bgImage=null;renderAll();};img.src=map.bg_image_url;}else{bgImage=null;document.getElementById('bgRemoveBtn').style.display='none';}localStorage.setItem('elp-last-map',id);renderAll();renderLayers();renderProps();renderMapSelect();}
async function uploadBgImage(mapId){if(!bgImage||!bgImage.src||!bgImage.src.startsWith('data:'))return null;try{var parts=bgImage.src.split(',');var mime=parts[0].match(/:(.*?);/)[1];var b=atob(parts[1]);var arr=new Uint8Array(b.length);for(var i=0;i<b.length;i++)arr[i]=b.charCodeAt(i);var blob=new Blob([arr],{type:mime});var ext=mime.split('/')[1]||'png';var path=tenantId+'/'+mapId+'/bg.'+ext;var r=await sb.storage.from('sitemap-images').upload(path,blob,{upsert:true,contentType:mime});if(r.error)return null;var pub=sb.storage.from('sitemap-images').getPublicUrl(path);return pub.data.publicUrl;}catch(e){return null;}}
async function deleteBgImage(mapId){try{var exts=['png','jpg','jpeg','gif','webp'];for(var i=0;i<exts.length;i++){await sb.storage.from('sitemap-images').remove([tenantId+'/'+mapId+'/bg.'+exts[i]]);}}catch(e){}}
async function saveMap(){if(!tenantId){toast('Not authenticated');return;}var name;if(!currentMapId){name=prompt('Name for this site map:','Site Map');if(!name||!name.trim())return;name=name.trim();var ins=await sb.from('site_maps').insert({tenant_id:tenantId,created_by:authUid,name:name,objects:objects,bg_opacity:bgOpacity,pan_x:panX,pan_y:panY,zoom_level:zoom,is_shared:false}).select().single();if(ins.error){toast('Error: '+ins.error.message);return;}currentMapId=ins.data.id;var bgUrl=await uploadBgImage(currentMapId);if(bgUrl){await sb.from('site_maps').update({bg_image_url:bgUrl}).eq('id',currentMapId);}localStorage.setItem('elp-last-map',currentMapId);}else{var bgUrl=await uploadBgImage(currentMapId);var updateData={objects:objects,bg_opacity:bgOpacity,pan_x:panX,pan_y:panY,zoom_level:zoom,updated_at:new Date().toISOString()};if(bgUrl)updateData.bg_image_url=bgUrl;else if(!bgImage)updateData.bg_image_url=null;var upd=await sb.from('site_maps').update(updateData).eq('id',currentMapId);if(upd.error){toast('Error: '+upd.error.message);return;}}await loadMaps();toast('Site map saved');}
async function newMap(){var name=prompt('Name for new site map:','Site Map');if(!name||!name.trim())return;if(!tenantId){toast('Not authenticated');return;}var ins=await sb.from('site_maps').insert({tenant_id:tenantId,created_by:authUid,name:name.trim(),objects:[],is_shared:false}).select().single();if(ins.error){toast('Error: '+ins.error.message);return;}currentMapId=ins.data.id;objects=[];nextId=1;selectedId=null;bgImage=null;bgOpacity=0.3;panX=0;panY=0;zoom=1;document.getElementById('bgRemoveBtn').style.display='none';document.getElementById('zoomLabel').textContent='100%';localStorage.setItem('elp-last-map',currentMapId);await loadMaps();renderAll();renderLayers();renderProps();toast('"'+name.trim()+'" created');}
async function deleteMap(){if(!currentMapId)return;var map=allMaps.find(function(m){return m.id===currentMapId;});if(!confirm('Delete "'+(map?map.name:'this map')+'"?'))return;await deleteBgImage(currentMapId);var r=await sb.from('site_maps').delete().eq('id',currentMapId);if(r.error){toast('Delete error: '+r.error.message);return;}currentMapId=null;objects=[];nextId=1;selectedId=null;bgImage=null;document.getElementById('bgRemoveBtn').style.display='none';localStorage.removeItem('elp-last-map');await loadMaps();renderAll();renderLayers();renderProps();toast('Site map deleted');}
async function renameMap(){if(!currentMapId)return;var map=allMaps.find(function(m){return m.id===currentMapId;});var name=prompt('Rename site map:',map?map.name:'');if(!name||!name.trim())return;await sb.from('site_maps').update({name:name.trim()}).eq('id',currentMapId);await loadMaps();toast('Renamed');}
function exportPNG(){var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;objects.forEach(function(o){minX=Math.min(minX,o.x);minY=Math.min(minY,o.y);maxX=Math.max(maxX,o.x+o.w);maxY=Math.max(maxY,o.y+o.h);});if(!objects.length){toast('Nothing to export');return;}var pad=40;minX-=pad;minY-=pad;maxX+=pad;maxY+=pad;var cw=maxX-minX,ch=maxY-minY;var oc=document.createElement('canvas');oc.width=cw*2;oc.height=ch*2;var ox=oc.getContext('2d');ox.scale(2,2);ox.fillStyle='#1a2535';ox.fillRect(0,0,cw,ch);ox.translate(-minX,-minY);if(bgImage){ox.globalAlpha=bgOpacity;ox.drawImage(bgImage,0,0);ox.globalAlpha=1;}objects.forEach(function(obj){ox.save();ox.globalAlpha=obj.opacity||1;var cx2=obj.x+obj.w/2,cy2=obj.y+obj.h/2;ox.translate(cx2,cy2);ox.rotate((obj.rotation||0)*Math.PI/180);ox.translate(-cx2,-cy2);drawShape(ox,obj);if(obj.label){ox.fillStyle='#fff';ox.font='bold '+Math.min(14,obj.h*0.35)+'px system-ui';ox.textAlign='center';ox.textBaseline='middle';ox.fillText(obj.label,cx2,cy2);}ox.restore();});var link=document.createElement('a');link.download='sitemap.png';link.href=oc.toDataURL();link.click();toast('PNG exported');}
function clearAll(){if(!confirm('Clear all objects?'))return;objects=[];selectedId=null;nextId=1;renderAll();renderLayers();renderProps();}
function loadBgImage(input){if(!input.files||!input.files[0])return;var file=input.files[0];var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){bgImage=img;bgOpacity=0.3;document.getElementById('bgRemoveBtn').style.display='';renderAll();renderProps();toast('Background set');};img.src=e.target.result;};reader.readAsDataURL(file);input.value='';}
function removeBg(){bgImage=null;bgOpacity=0.3;document.getElementById('bgRemoveBtn').style.display='none';renderAll();renderProps();toast('Background removed');}
function setBgOpacity(val){bgOpacity=parseFloat(val);renderAll();}
function toast(m){var t=document.getElementById('toastEl');if(!t){t=document.createElement('div');t.id='toastEl';t.style.cssText='position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border-default);color:var(--text-primary);padding:10px 18px;border-radius:10px;font-size:13px;z-index:100;display:none;';document.body.appendChild(t);}t.textContent=m;t.style.display='block';setTimeout(function(){t.style.display='none';},2000);}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ===== BOOT =====
async function init(){
  var s=await checkAuth();if(!s)return;
  userId=s.user.id;authUid=s.user.id;var email=s.user.email||'';
  try{var ur=await sb.from('users').select('tenant_id,user_id').eq('email',email).single();if(ur.data){tenantId=ur.data.tenant_id;userId=ur.data.user_id;}}catch(e){}
  if(!tenantId){try{var bs=await sb.from('business_settings').select('tenant_id').limit(1).single();if(bs.data)tenantId=bs.data.tenant_id;}catch(e){}}
  document.getElementById('dBizName').textContent=email;document.getElementById('mBizName').textContent=email;
  if(!tenantId){toast('Warning: Could not resolve tenant');}
  initUI();initCanvas();setupEvents();
  document.getElementById('tbGrid').classList.add('active');
  await loadMaps();
  var lastId=localStorage.getItem('elp-last-map');
  if(lastId&&allMaps.find(function(m){return m.id===lastId;})){switchMap(lastId);}
  else if(allMaps.length){switchMap(allMaps[0].id);}
}
init();
</script>
</body>
</html>
