-- ============================================
-- MASTER DASHBOARD - COMPLETE SETUP
-- Run this entire script in Supabase SQL Editor
-- ============================================

-- ============================================
-- STEP 1: Create business_accounts table
-- ============================================
CREATE TABLE IF NOT EXISTS business_accounts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_name VARCHAR(255) NOT NULL,
  contact_email VARCHAR(255),
  contact_phone VARCHAR(50),
  
  -- Subscription info
  status VARCHAR(50) DEFAULT 'active', -- active, trial, inactive, suspended
  monthly_fee DECIMAL(10,2) DEFAULT 0.00,
  trial_ends_at TIMESTAMP WITH TIME ZONE,
  subscription_started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- VAPI usage tracking
  vapi_minutes_used INTEGER DEFAULT 0, -- Total all-time minutes
  vapi_minutes_current_month INTEGER DEFAULT 0, -- This month's minutes
  vapi_last_reset_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Activity tracking
  last_active_at TIMESTAMP WITH TIME ZONE,
  user_count INTEGER DEFAULT 0,
  
  -- Metadata
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================
-- STEP 2: Create vapi_usage_logs table
-- ============================================
CREATE TABLE IF NOT EXISTS vapi_usage_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_account_id UUID REFERENCES business_accounts(id) ON DELETE CASCADE,
  account_id UUID REFERENCES accounts(id) ON DELETE CASCADE,
  
  -- Call details
  call_duration_seconds INTEGER NOT NULL,
  call_duration_minutes DECIMAL(10,2) NOT NULL,
  call_cost DECIMAL(10,4) NOT NULL,
  call_sid VARCHAR(255),
  
  -- Metadata
  call_started_at TIMESTAMP WITH TIME ZONE,
  call_ended_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ============================================
-- STEP 3: Add indexes
-- ============================================
CREATE INDEX IF NOT EXISTS idx_business_accounts_status ON business_accounts(status);
CREATE INDEX IF NOT EXISTS idx_business_accounts_last_active ON business_accounts(last_active_at);
CREATE INDEX IF NOT EXISTS idx_vapi_logs_business ON vapi_usage_logs(business_account_id);
CREATE INDEX IF NOT EXISTS idx_vapi_logs_date ON vapi_usage_logs(created_at);

-- ============================================
-- STEP 4: Add RLS policies
-- ============================================
ALTER TABLE business_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE vapi_usage_logs ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist
DROP POLICY IF EXISTS "Super admins can view all accounts" ON business_accounts;
DROP POLICY IF EXISTS "Super admins can view all logs" ON vapi_usage_logs;

-- Super admin can see all accounts
CREATE POLICY "Super admins can view all accounts"
  ON business_accounts
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'super_admin'
    )
  );

-- Super admin can see all logs
CREATE POLICY "Super admins can view all logs"
  ON vapi_usage_logs
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'super_admin'
    )
  );

-- ============================================
-- STEP 5: Create helper functions
-- ============================================

-- Function to reset monthly VAPI minutes
CREATE OR REPLACE FUNCTION reset_monthly_vapi_minutes()
RETURNS void AS $$
BEGIN
  UPDATE business_accounts
  SET 
    vapi_minutes_current_month = 0,
    vapi_last_reset_at = NOW()
  WHERE 
    DATE_TRUNC('month', vapi_last_reset_at) < DATE_TRUNC('month', NOW());
END;
$$ LANGUAGE plpgsql;

-- Function to log VAPI usage
CREATE OR REPLACE FUNCTION log_vapi_usage(
  p_business_account_id UUID,
  p_account_id UUID,
  p_duration_seconds INTEGER,
  p_cost DECIMAL
)
RETURNS void AS $$
DECLARE
  v_minutes DECIMAL(10,2);
BEGIN
  v_minutes := CEIL(p_duration_seconds / 60.0);
  
  -- Insert log entry
  INSERT INTO vapi_usage_logs (
    business_account_id,
    account_id,
    call_duration_seconds,
    call_duration_minutes,
    call_cost,
    call_started_at,
    call_ended_at
  ) VALUES (
    p_business_account_id,
    p_account_id,
    p_duration_seconds,
    v_minutes,
    p_cost,
    NOW() - (p_duration_seconds || ' seconds')::INTERVAL,
    NOW()
  );
  
  -- Update business account totals
  UPDATE business_accounts
  SET 
    vapi_minutes_used = vapi_minutes_used + v_minutes,
    vapi_minutes_current_month = vapi_minutes_current_month + v_minutes,
    last_active_at = NOW(),
    updated_at = NOW()
  WHERE id = p_business_account_id;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- STEP 6: Link accounts table to business_accounts
-- ============================================
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'accounts' 
    AND column_name = 'business_account_id'
  ) THEN
    ALTER TABLE accounts 
    ADD COLUMN business_account_id UUID REFERENCES business_accounts(id);
    
    CREATE INDEX idx_accounts_business_account ON accounts(business_account_id);
  END IF;
END $$;

-- ============================================
-- STEP 7: INSERT MOCK DATA
-- ============================================

-- Insert 15 mock business accounts with realistic data
INSERT INTO business_accounts (
  business_name,
  contact_email,
  contact_phone,
  status,
  monthly_fee,
  vapi_minutes_used,
  vapi_minutes_current_month,
  user_count,
  last_active_at,
  subscription_started_at,
  trial_ends_at
) VALUES
  -- Active accounts with high usage
  ('Premium Auto Care', 'owner@premiumauto.com', '408-555-0101', 'active', 99.00, 4580, 680, 5, NOW() - INTERVAL '2 hours', NOW() - INTERVAL '6 months', NULL),
  ('Quick Fix Auto', 'admin@quickfix.com', '415-555-0102', 'active', 99.00, 3820, 520, 3, NOW() - INTERVAL '5 hours', NOW() - INTERVAL '8 months', NULL),
  ('Best Auto Service', 'info@bestauto.com', '650-555-0103', 'active', 149.00, 6780, 980, 8, NOW() - INTERVAL '1 hour', NOW() - INTERVAL '1 year', NULL),
  ('Elite Motors', 'contact@elitemotors.com', '510-555-0104', 'active', 149.00, 5920, 820, 7, NOW() - INTERVAL '3 hours', NOW() - INTERVAL '10 months', NULL),
  ('Speedy Auto Repair', 'manager@speedyauto.com', '925-555-0105', 'active', 99.00, 2450, 450, 4, NOW() - INTERVAL '4 hours', NOW() - INTERVAL '4 months', NULL),
  
  -- Active accounts with medium usage
  ('City Auto Center', 'owner@cityauto.com', '408-555-0106', 'active', 99.00, 1890, 290, 3, NOW() - INTERVAL '8 hours', NOW() - INTERVAL '5 months', NULL),
  ('Master Mechanics', 'info@mastermech.com', '415-555-0107', 'active', 149.00, 3240, 540, 6, NOW() - INTERVAL '12 hours', NOW() - INTERVAL '7 months', NULL),
  ('Pro Auto Solutions', 'admin@proauto.com', '650-555-0108', 'active', 99.00, 2680, 380, 4, NOW() - INTERVAL '6 hours', NOW() - INTERVAL '3 months', NULL),
  
  -- Trial accounts
  ('New Age Auto', 'trial@newageauto.com', '510-555-0109', 'trial', 0.00, 125, 125, 2, NOW() - INTERVAL '1 hour', NOW() - INTERVAL '10 days', NOW() + INTERVAL '20 days'),
  ('Fast Lane Repair', 'trial@fastlane.com', '925-555-0110', 'trial', 0.00, 89, 89, 1, NOW() - INTERVAL '2 hours', NOW() - INTERVAL '5 days', NOW() + INTERVAL '25 days'),
  ('Auto Express', 'trial@autoexpress.com', '408-555-0111', 'trial', 0.00, 156, 156, 2, NOW() - INTERVAL '3 hours', NOW() - INTERVAL '15 days', NOW() + INTERVAL '15 days'),
  
  -- Inactive accounts
  ('Classic Car Repair', 'manager@classiccar.com', '415-555-0112', 'inactive', 99.00, 890, 0, 4, NOW() - INTERVAL '45 days', NOW() - INTERVAL '1 year', NULL),
  ('Budget Auto Fix', 'contact@budgetauto.com', '650-555-0113', 'inactive', 99.00, 450, 0, 2, NOW() - INTERVAL '60 days', NOW() - INTERVAL '8 months', NULL),
  
  -- Recently suspended
  ('Tech Auto Services', 'admin@techauto.com', '510-555-0114', 'suspended', 149.00, 2340, 0, 5, NOW() - INTERVAL '15 days', NOW() - INTERVAL '6 months', NULL),
  
  -- New active account
  ('Modern Motors', 'owner@modernmotors.com', '925-555-0115', 'active', 99.00, 340, 340, 3, NOW() - INTERVAL '30 minutes', NOW() - INTERVAL '1 month', NULL);

-- Insert realistic VAPI usage logs for the past month
-- This creates varied usage patterns across different accounts
DO $$
DECLARE
  business_rec RECORD;
  day_offset INTEGER;
  calls_per_day INTEGER;
  call_duration INTEGER;
  i INTEGER;
BEGIN
  FOR business_rec IN 
    SELECT id, vapi_minutes_current_month 
    FROM business_accounts 
    WHERE status IN ('active', 'trial')
  LOOP
    -- Generate calls for the past 30 days
    FOR day_offset IN 0..29 LOOP
      -- Random number of calls per day (0-5 calls)
      calls_per_day := floor(random() * 6)::INTEGER;
      
      FOR i IN 1..calls_per_day LOOP
        -- Random call duration between 60 and 600 seconds (1-10 minutes)
        call_duration := 60 + floor(random() * 540)::INTEGER;
        
        INSERT INTO vapi_usage_logs (
          business_account_id,
          account_id,
          call_duration_seconds,
          call_duration_minutes,
          call_cost,
          call_started_at,
          call_ended_at,
          created_at
        ) VALUES (
          business_rec.id,
          NULL, -- We don't have specific account_ids yet
          call_duration,
          CEIL(call_duration / 60.0),
          CEIL(call_duration / 60.0) * 0.15, -- $0.15 per minute
          NOW() - (day_offset || ' days')::INTERVAL - (call_duration || ' seconds')::INTERVAL,
          NOW() - (day_offset || ' days')::INTERVAL,
          NOW() - (day_offset || ' days')::INTERVAL
        );
      END LOOP;
    END LOOP;
  END LOOP;
END $$;

-- ============================================
-- STEP 8: CREATE SUPER ADMIN USER
-- ============================================

-- First, check if super_admin role constraint exists, if not add it
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint 
    WHERE conname = 'check_valid_role'
  ) THEN
    ALTER TABLE users 
    DROP CONSTRAINT IF EXISTS users_role_check;
    
    ALTER TABLE users 
    ADD CONSTRAINT check_valid_role 
    CHECK (role IN ('business_owner', 'admin', 'employee', 'super_admin'));
  END IF;
END $$;

-- Create super admin account
-- Password: Admin123!
-- (This uses Supabase's default password hashing)
INSERT INTO auth.users (
  instance_id,
  id,
  aud,
  role,
  email,
  encrypted_password,
  email_confirmed_at,
  created_at,
  updated_at,
  raw_app_meta_data,
  raw_user_meta_data,
  is_super_admin,
  confirmation_token,
  email_change,
  email_change_token_new,
  recovery_token
) VALUES (
  '00000000-0000-0000-0000-000000000000',
  gen_random_uuid(),
  'authenticated',
  'authenticated',
  'admin@worklogicpro.com',
  crypt('Admin123!', gen_salt('bf')), -- Password: Admin123!
  NOW(),
  NOW(),
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"full_name":"System Administrator"}',
  false,
  '',
  '',
  '',
  ''
) ON CONFLICT (email) DO NOTHING;

-- Insert into users table (your app's user table)
INSERT INTO users (
  id,
  email,
  first_name,
  last_name,
  role,
  created_at,
  updated_at
)
SELECT 
  id,
  'admin@worklogicpro.com',
  'System',
  'Administrator',
  'super_admin',
  NOW(),
  NOW()
FROM auth.users 
WHERE email = 'admin@worklogicpro.com'
ON CONFLICT (email) DO UPDATE 
SET role = 'super_admin';

-- ============================================
-- STEP 9: VERIFICATION QUERIES
-- ============================================

-- View all business accounts
SELECT 
  business_name,
  status,
  monthly_fee,
  vapi_minutes_used,
  vapi_minutes_current_month,
  user_count,
  last_active_at
FROM business_accounts
ORDER BY vapi_minutes_current_month DESC;

-- View total stats
SELECT 
  COUNT(*) as total_accounts,
  SUM(monthly_fee) as total_monthly_revenue,
  SUM(vapi_minutes_used) as total_minutes,
  SUM(vapi_minutes_current_month) as month_minutes,
  SUM(vapi_minutes_used * 0.15) as total_cost,
  SUM(vapi_minutes_current_month * 0.15) as month_cost
FROM business_accounts
WHERE status = 'active';

-- View VAPI usage logs count
SELECT COUNT(*) as total_vapi_calls FROM vapi_usage_logs;

-- Verify super admin user
SELECT email, first_name, last_name, role 
FROM users 
WHERE role = 'super_admin';

-- ============================================
-- SETUP COMPLETE!
-- ============================================
-- 
-- CREDENTIALS:
-- Email: admin@worklogicpro.com
-- Password: Admin123!
--
-- Access the master dashboard at:
-- master-dashboard.html
-- ============================================
