<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Master Dashboard - GlowbotsLive</title>
  
  <!-- Supabase JS - Load FIRST -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
    }

    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .account-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .account-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .account-name {
      font-size: 1.3rem;
      font-weight: bold;
      color: #333;
    }

    .account-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .status-active {
      background: #10b981;
      color: white;
    }

    .status-inactive {
      background: #ef4444;
      color: white;
    }

    .status-pending {
      background: #f59e0b;
      color: white;
    }

    .account-info {
      margin-top: 15px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-label {
      color: #666;
      font-size: 0.9rem;
    }

    .info-value {
      color: #333;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      color: white;
      font-size: 1.5rem;
      padding: 50px;
    }

    .debug-info {
      background: rgba(255,255,255,0.1);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .error {
      background: #fee;
      color: #c00;
      padding: 20px;
      border-radius: 10px;
      margin: 20px;
      text-align: center;
    }

    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .accounts-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <button class="logout-btn" onclick="logout()">Logout</button>

  <div class="container">
    <h1>üéØ Master Dashboard</h1>

    <div id="debugInfo" class="debug-info" style="display:none;"></div>

    <div class="stats-grid" id="statsContainer">
      <div class="stat-card">
        <div class="stat-label">Total Businesses</div>
        <div class="stat-value" id="totalBusinesses">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Accounts</div>
        <div class="stat-value" id="activeAccounts">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending Accounts</div>
        <div class="stat-value" id="pendingAccounts">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value" id="totalRevenue">$0</div>
      </div>
    </div>

    <div id="accountsContainer">
      <div class="loading">Loading business accounts...</div>
    </div>
  </div>

  <script>
    // Initialize Supabase INLINE (not from external file)
    const SUPABASE_URL = 'https://vvkjydmzmevcfkxivrxi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2a2p5ZG16bWV2Y2ZreGl2cnhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMzNjAzOTQsImV4cCI6MjA0ODkzNjM5NH0.xO0cEQVq7FPJKWcNXlwqHPGPwvBYQF3vGwHXtdyFoSI';

    let supabase;
    let debugLog = [];

    function addDebug(message) {
      debugLog.push(`[${new Date().toISOString()}] ${message}`);
      const debugDiv = document.getElementById('debugInfo');
      debugDiv.textContent = debugLog.join('\n');
      debugDiv.style.display = 'block';
      console.log(message);
    }

    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', async () => {
      addDebug('=== Master Dashboard Loading ===');
      
      // Check if Supabase library loaded
      if (typeof window.supabase === 'undefined') {
        addDebug('‚ùå ERROR: Supabase library not loaded!');
        document.getElementById('accountsContainer').innerHTML = 
          '<div class="error">Supabase library failed to load. Check your internet connection.</div>';
        return;
      }
      addDebug('‚úÖ Supabase library loaded');

      // Initialize Supabase client
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        addDebug(`‚úÖ Supabase client created for: ${SUPABASE_URL}`);
      } catch (err) {
        addDebug(`‚ùå ERROR creating Supabase client: ${err.message}`);
        document.getElementById('accountsContainer').innerHTML = 
          `<div class="error">Failed to initialize Supabase: ${err.message}</div>`;
        return;
      }

      // Check if user is logged in
      const userRole = localStorage.getItem('userRole');
      const authUserId = localStorage.getItem('authUserId');
      const supabaseToken = localStorage.getItem('supabaseToken');
      
      addDebug(`User Role: ${userRole}`);
      addDebug(`Auth User ID: ${authUserId}`);
      addDebug(`Supabase Token: ${supabaseToken ? 'Present' : 'Missing'}`);

      if (userRole !== 'super_admin') {
        alert('Access Denied: Super Admin privileges required');
        window.location.href = 'login.html';
        return;
      }

      if (!authUserId || !supabaseToken) {
        alert('Session expired. Please login again.');
        window.location.href = 'login.html';
        return;
      }

      // Load the dashboard
      await loadMasterDashboard();
    });

    async function loadMasterDashboard() {
      addDebug('=== Starting Dashboard Load ===');

      try {
        // Test basic connectivity to Supabase
        addDebug('Testing Supabase connectivity...');
        try {
          const response = await fetch(SUPABASE_URL);
          addDebug(`‚úÖ Supabase URL is reachable (status: ${response.status})`);
        } catch (fetchErr) {
          addDebug(`‚ùå Cannot reach Supabase URL: ${fetchErr.message}`);
          throw new Error(`Network error: Cannot reach ${SUPABASE_URL}. Check your internet connection.`);
        }

        // Try to restore session from token
        addDebug('Attempting to restore session...');
        const token = localStorage.getItem('supabaseToken');
        if (token) {
          try {
            const { data, error } = await supabase.auth.setSession({
              access_token: token,
              refresh_token: token
            });
            if (error) {
              addDebug(`‚ö†Ô∏è Session restore warning: ${error.message}`);
            } else {
              addDebug('‚úÖ Session restored successfully');
            }
          } catch (sessionErr) {
            addDebug(`‚ö†Ô∏è Session restore failed: ${sessionErr.message}`);
          }
        }

        // Fetch business accounts
        addDebug('Fetching business accounts from database...');
        const { data: accounts, error, count } = await supabase
          .from('business_accounts')
          .select('*', { count: 'exact' })
          .order('created_at', { ascending: false });

        if (error) {
          addDebug(`‚ùå Database query error: ${error.message}`);
          addDebug(`Error code: ${error.code}`);
          addDebug(`Error hint: ${error.hint}`);
          addDebug(`Error details: ${error.details}`);
          throw error;
        }

        addDebug(`‚úÖ Successfully fetched ${accounts?.length || 0} accounts`);

        if (!accounts || accounts.length === 0) {
          addDebug('‚ö†Ô∏è No business accounts found in database');
          document.getElementById('accountsContainer').innerHTML = 
            '<div class="loading">No business accounts found. Create your first account!</div>';
          return;
        }

        // Calculate statistics
        const activeAccounts = accounts.filter(a => a.status === 'active').length;
        const pendingAccounts = accounts.filter(a => a.status === 'pending').length;
        const totalRevenue = accounts.reduce((sum, a) => sum + (parseFloat(a.monthly_fee) || 0), 0);

        addDebug(`Stats: ${accounts.length} total, ${activeAccounts} active, ${pendingAccounts} pending`);

        // Update stats
        document.getElementById('totalBusinesses').textContent = accounts.length;
        document.getElementById('activeAccounts').textContent = activeAccounts;
        document.getElementById('pendingAccounts').textContent = pendingAccounts;
        document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;

        // Display accounts
        displayAccounts(accounts);
        addDebug('‚úÖ Dashboard loaded successfully!');

        // Hide debug info after successful load
        setTimeout(() => {
          document.getElementById('debugInfo').style.display = 'none';
        }, 3000);

      } catch (err) {
        addDebug(`‚ùå FATAL ERROR: ${err.message}`);
        console.error('Full error object:', err);
        
        let errorHTML = `
          <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; margin: 0 auto; text-align: left;">
            <h2 style="color: #ef4444; margin-bottom: 20px;">‚ùå Error Loading Dashboard</h2>
            <div style="background: #fee; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <strong>Error:</strong> ${err.message}
            </div>
            <h3 style="margin: 20px 0 10px 0;">Troubleshooting Steps:</h3>
            <ol style="line-height: 2;">
              <li>Open browser console (F12) and check for errors</li>
              <li>Verify you're connected to the internet</li>
              <li>Try disabling ad blockers or VPN</li>
              <li>Try opening in incognito/private mode</li>
              <li>Clear browser cache and reload</li>
              <li>Check if ${SUPABASE_URL} is accessible</li>
            </ol>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
              Retry
            </button>
          </div>
        `;
        
        document.getElementById('accountsContainer').innerHTML = errorHTML;
      }
    }

    function displayAccounts(accounts) {
      const container = document.getElementById('accountsContainer');
      container.innerHTML = '';

      const accountsGrid = document.createElement('div');
      accountsGrid.className = 'accounts-grid';

      accounts.forEach(account => {
        const card = document.createElement('div');
        card.className = 'account-card';
        card.onclick = () => viewAccountDetails(account.id);

        const statusClass = account.status === 'active' ? 'status-active' : 
                           account.status === 'pending' ? 'status-pending' : 'status-inactive';

        card.innerHTML = `
          <div class="account-header">
            <div class="account-name">${account.business_name || 'Unnamed Business'}</div>
            <div class="account-status ${statusClass}">${account.status || 'Unknown'}</div>
          </div>
          <div class="account-info">
            <div class="info-row">
              <span class="info-label">Contact:</span>
              <span class="info-value">${account.contact_name || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value">${account.email || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Phone:</span>
              <span class="info-value">${account.phone || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Monthly Fee:</span>
              <span class="info-value">$${parseFloat(account.monthly_fee || 0).toFixed(2)}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Created:</span>
              <span class="info-value">${new Date(account.created_at).toLocaleDateString()}</span>
            </div>
          </div>
        `;

        accountsGrid.appendChild(card);
      });

      container.appendChild(accountsGrid);
    }

    function viewAccountDetails(accountId) {
      window.location.href = `account-details.html?id=${accountId}`;
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }
  </script>
</body>
</html>
