<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repair Orders - LIVE & CORRECTED</title>
  <style>
    body {font-family: Arial, sans-serif; margin:40px; background:#f9fafb;}
    h1 {color:#1e40af;}
    table {width:100%; border-collapse:collapse; background:white; box-shadow:0 4px 20px rgba(0,0,0,0.1); border-radius:8px; margin-top:20px;}
    th {background:#1e40af; color:white; padding:14px; text-align:left; position:sticky; top:0;}
    td {padding:12px; border-bottom:1px solid #e2e8f0; vertical-align:top;}
    tr:hover {background:#dbeafe;}
    img {max-height:90px; border-radius:6px; margin:4px; border:1px solid #ccc; cursor:zoom-in;}
    .status {padding:6px 12px; border-radius:20px; color:white; font-weight:bold; font-size:0.9em;}
    .On-Schedule {background:#10b981;}
    .in-process {background:#f59e0b;}
    .completed {background:#6366f1;}
    .Parts-on-order {background:#8b5cf6;}
    .complications {background:#ef4444;}
  </style>
</head>
<body>

<h1>Repair Orders – LIVE FROM YOUR AIRTABLE (Fixed Field Mapping)</h1>
<div id="loading" style="font-size:1.4em; color:#6366f1; font-weight:bold;">Loading your real data…</div>
<div id="output"></div>

<script>
// Your working token
const TOKEN = "patnifri546G0mjVK.fbf7d5192704c2ec2d373d30a5c83f88621d0267f5f33092d6d415e032afe214";
const BASE = "appfVdfmxvTwLv7uV";
const TABLE = "repair_order";

async function getAllRecords() {
  let records = [];
  let offset = "";
  do {
    const url = `https://api.airtable.com/v0/${BASE}/${TABLE}?pageSize=100${offset ? "&offset=" + offset : ""}`;
    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${TOKEN}` }
    });
    if (!res.ok) throw new Error(`Airtable error: ${res.status}`);
    const data = await res.json();
    records = records.concat(data.records);
    offset = data.offset || "";
  } while (offset);
  return records;
}

getAllRecords().then(records => {
  document.getElementById("loading").remove();

  let html = `<table>
    <thead><tr>
      <th>Repair Order ID</th>
      <th>Customer Name</th>
      <th>Phone</th>
      <th>Jet Ski</th>
      <th>Hull ID</th>
      <th>Status</th>
      <th>Priority</th>
      <th>Diagnosis / Notes</th>
      <th>Photos</th>
      <th>Created</th>
    </tr></thead><tbody>`;

  records.forEach(r => {
    const f = r.fields;
    // Fixed: Use exact field names from your base
    const id = f["Repair Order ID"] || "—";
    const customer = f["Customer Name"] || "—";
    const phone = f.Phone || "—";
    const jetSki = `${f.Make || ""} ${f.Model || ""}`.trim() || "—";
    const hull = f["Hull ID"] || "—";
    const status = f.Status || "—";
    const priority = f.Priority || "—";
    const notes = (f.Diagnosis || f.Notes || "—").replace(/\n/g, "<br>");
    const photos = (f.Photos || []).map(p => 
      `<a href="${p.url}" target="_blank"><img src="${p.thumbnails?.large?.url || p.thumbnails?.small?.url || p.url}" alt="Photo"></a>`
    ).join('') || "—";
    const created = new Date(r.createdTime).toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric' 
    });

    html += `<tr>
      <td>${id}</td>
      <td><strong>${customer}</strong></td>
      <td>${phone}</td>
      <td>${jetSki}</td>
      <td>${hull}</td>
      <td><span class="status ${status.toLowerCase().replace(/ /g, '-')}">${status}</span></td>
      <td>${priority}</td>
      <td>${notes}</td>
      <td>${photos}</td>
      <td>${created}</td>
    </tr>`;
  });

  html += `</tbody></table>
    <p><strong>${records.length} records loaded live from your Airtable (with correct dates & fields).</strong></p>`;

  document.getElementById("output").innerHTML = html;

}).catch(err => {
  document.getElementById("loading").innerHTML = `<p style="color:red;">Error: ${err.message}. Ensure uploaded to server (CORS issue if local).</p>`;
  console.error(err);
});
</script>

<hr>
<small>
  Fixed: Exact field mapping (e.g., "Hull ID", "Repair Order ID") + correct date formatting (e.g., "Jul 31, 2025").<br>
  Upload to server only — works like ChatGPT's but with all your data, photos, & no random dates.
</small>

</body>
</html>
