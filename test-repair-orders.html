<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repair Orders - Airtable Live View</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f4f6f9; line-height: 1.6; }
    h1 { color: #2c3e50; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: top; }
    th { background: #3498db; color: white; position: sticky; top: 0; }
    tr:hover { background: #f8f9fa; }
    .loading { font-size: 1.3em; color: #7f8c8d; }
    .error { color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 5px; }
    img { max-width: 80px; max-height: 80px; border-radius: 4px; }
    .array { color: #27ae60; font-weight: bold; }
    pre { background: #ecf0f1; padding: 8px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>

  <h1>Repair Orders - Live from Airtable</h1>
  <p class="loading">Loading all records...</p>
  <div id="output"></div>

  <script>
    // === PUT YOUR OWN KEY & BASE HERE ===
    const API_KEY = 'YOUR_PAT_OR_KEY_HERE';        // ← REPLACE THIS
    const BASE_ID = 'appfVdfmxvTwLv7uV';
    const TABLE_NAME = 'repair_order';
    // ====================================

    const headers = { 'Authorization': `Bearer ${API_KEY}` };

    async function loadAllRecords() {
      let allRecords = [];
      let offset = null;

      do {
        const url = new URL(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`);
        url.searchParams.append('pageSize', 100);
        if (offset) url.searchParams.append('offset', offset);

        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error(`Airtable error: ${res.status} ${res.statusText}`);

        const data = await res.json();
        allRecords = allRecords.concat(data.records);
        offset = data.offset;
      } while (offset);

      return allRecords;
    }

    function formatValue(value) {
      if (value === null || value === undefined) return '<em>—</em>';

      if (Array.isArray(value)) {
        if (value.length === 0) return '<em>—</em>';

        // Attachments
        if (value[0]?.url && value[0]?.thumbnails) {
          return value.map(att =>
            `<a href="${att.url}" target="_blank">
               <img src="${att.thumbnails.small?.url || att.url}" alt="img">
             </a>`
          ).join(' ');
        }
        // Regular arrays (lookups, multi-select, linked records)
        return `<span class="array">${value.join(', ')}</span>`;
      }

      if (typeof value === 'object') {
        return `<pre>${JSON.stringify(value, null, 2)}</pre>`;
      }

      return String(value);
    }

    loadAllRecords()
      .then(records => {
        document.querySelector('.loading').remove();

        if (records.length === 0) {
          document.getElementById('output').innerHTML = '<p>No records found.</p>';
          return;
        }

        // Get all unique field names
        const fieldNames = [...new Set(records.flatMap(r => Object.keys(r.fields)))]
          .sort();

        let html = '<table><thead><tr>';
        fieldNames.forEach(field => html += `<th>${field}</th>`);
        html += '</tr></thead><tbody>';

        records.forEach(rec => {
          html += '<tr>';
          fieldNames.forEach(field => {
            const val = rec.fields[field];
            html += `<td>${formatValue(val)}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody></table>';
        document.getElementById('output').innerHTML = html;
      })
      .catch(err => {
        document.querySelector('.loading').classList.add('error');
        document.querySelector('.loading').textContent = 'Failed to load data';
        document.getElementById('output').innerHTML = 
          `<div class="error"><strong>Error:</strong> ${err.message}<br><br>
           Check: <br>
           • Your Personal Access Token is correct and has <strong>read data</strong> scope<br>
           • The base ID and table name are correct<br>
           • No ad-blocker or CORS issue (open in normal browser)</div>`;
        console.error(err);
      });
  </script>

  <hr>
  <p><small>
    <strong>Security note:</strong> Never commit this file with your real API key in it. 
    For production, use a backend proxy (Node.js, Netlify function, etc.) so the key stays secret.
  </small></p>
</body>
</html>
