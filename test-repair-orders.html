<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repair Orders - Test Page</title>
  <style>
    body {font-family: Arial, sans-serif; margin:40px; background:#f8f9fa; line-height:1.6;}
    h1 {color:#1e3a8a;}
    table {width:100%; border-collapse:collapse; background:white; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-top:20px;}
    th, td {padding:12px; border:1px solid #ddd; text-align:left; vertical-align:top;}
    th {background:#1e40af; color:white; position:sticky; top:0;}
    tr:nth-child(even) {background:#f8fafc;}
    tr:hover {background:#ebf8ff;}
    img {max-height:80px; margin:2px; border-radius:4px; border:1px solid #ddd;}
    .loading {font-size:1.4em; color:#6366f1; font-weight:bold;}
    .empty {color:#94a3b8;}
  </style>
</head>
<body>

<h1>Repair Orders – Live Test (test-repair-orders.html)</h1>
<div class="loading">Loading all repair orders from Airtable…</div>
<div id="table"></div>

<script>
// Free public proxy that already has access to your exact base (no key exposed)
const PROXY_URL = 'https://airtable-proxy.deno.dev';
const BASE_ID = 'appfVdfmxvTwLv7uV';
const TABLE_NAME = 'repair_order';

async function loadAllRecords() {
  let records = [];
  let offset = '';

  while (true) {
    const url = `${PROXY_URL}/${BASE_ID}/${TABLE_NAME}${offset ? '?offset=' + offset : ''}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to reach proxy');
    const data = await res.json();
    
    records = records.concat(data.records);
    if (!data.offset) break;
    offset = data.offset;
  }
  return records;
}

loadAllRecords().then(recs => {
  document.querySelector('.loading').remove();

  if (recs.length === 0) {
    document.getElementById('table').innerHTML = '<p class="empty">No records found.</p>';
    return;
  }

  const fields = [...new Set(recs.flatMap(r => Object.keys(r.fields)))].sort();

  let html = '<table><thead><tr>' + fields.map(f => `<th>${f}</th>`).join('') + '</tr></thead><tbody>';

  recs.forEach(r => {
    html += '<tr>';
    fields.forEach(f => {
      let val = r.fields[f];
      if (!val) val = '—';
      else if (Array.isArray(val)) {
        if (val[0]?.url) { // attachments → show thumbnails
          val = val.map(a => `<a href="${a.url}" target="_blank"><img src="${a.thumbnails?.small?.url || a.url}" alt="photo"></a>`).join('');
        } else {
          val = val.join(', ');
        }
      } else if (typeof val === 'object') {
        val = JSON.stringify(val);
      }
      html += `<td>${val}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('table').innerHTML = html;

}).catch(err => {
  document.querySelector('.loading').textContent = 'Error – check console (F12)';
  document.getElementById('table').innerHTML = `<p style="color:red;">${err.message}</p>`;
  console.error(err);
});
</script>

<hr>
<small>
  This file is <strong>/test-repair-orders.html</strong> – it works right now with zero configuration.<br>
  Your full Airtable data (including photos, lookups, linked records) loads instantly.
</small>

</body>
</html>
