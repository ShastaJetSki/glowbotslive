<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WorkLogic Pro – Login (Debug)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
      background: #0b0f14; font-family: system-ui, -apple-system, Segoe UI, Roboto; color: #e8eef6;
    }
    .card {
      width: 420px; max-width: 92vw; padding: 28px; border-radius: 18px;
      background: #0f1621; border: 1px solid #223044;
    }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    .muted { color: #9fb0c3; font-size: 14px; margin-bottom: 18px; }
    label { display:block; margin-top:14px; margin-bottom:6px; font-size:13px; color:#9fb0c3; }
    input {
      width:100%; padding:12px 14px; font-size:15px; border-radius:12px;
      border:1px solid #223044; background:#0b0f14; color:#fff;
    }
    input:focus { outline:none; border-color:#3b82f6; }
    button {
      width:100%; margin-top:22px; padding:12px; font-size:16px; border-radius:14px;
      border:1px solid #2a3b55; background:#1a2535; color:#fff; cursor:pointer;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .message {
      margin-top:16px; padding:12px; border-radius:12px;
      font-size:14px; white-space:pre-wrap;
    }
    .error { background:#2a1414; border:1px solid #553333; color:#ffb3b3; }
    .info { background:#1a2a3a; border:1px solid #2a4a6a; color:#93c5fd; }
    pre { 
      background:#1a2535; 
      padding:8px; 
      border-radius:6px; 
      overflow-x:auto; 
      font-size:11px;
      margin:8px 0;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>WorkLogic Pro</h1>
  <div class="muted">Login Debug Mode</div>

  <label>Email</label>
  <input id="email" type="email" value="boxsterbrothers@gmail.com" />

  <label>Password</label>
  <input id="password" type="password" />

  <button id="loginBtn1">Method 1: /token?grant_type=password</button>
  <button id="loginBtn2">Method 2: /signup (then /token)</button>
  
  <div id="output"></div>
</div>

<script>
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4";

  const output = document.getElementById('output');

  function showMessage(msg, type = 'info') {
    output.innerHTML = `<div class="message ${type}">${msg}</div>`;
  }

  // Method 1: Standard password grant
  document.getElementById('loginBtn1').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    showMessage('Testing Method 1...', 'info');
    console.log('=== METHOD 1 ===');
    
    try {
      const url = `${API_BASE}/auth/v1/token?grant_type=password`;
      console.log('URL:', url);
      console.log('Body:', { email, password: '[HIDDEN]' });
      
      const res = await fetch(url, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "apikey": ANON_KEY
        },
        body: JSON.stringify({ email, password })
      });

      console.log('Status:', res.status);
      const text = await res.text();
      console.log('Response:', text);
      
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        data = { raw: text };
      }

      if (res.ok && data.access_token) {
        showMessage('✅ Method 1 SUCCESS!\n\n' + JSON.stringify(data, null, 2), 'info');
        localStorage.setItem("sb_access_token", data.access_token);
        setTimeout(() => location.replace("dashboard-business.html"), 2000);
      } else {
        showMessage('❌ Method 1 FAILED\n\nStatus: ' + res.status + '\n\n' + JSON.stringify(data, null, 2), 'error');
      }
    } catch (err) {
      console.error('Method 1 error:', err);
      showMessage('❌ Method 1 ERROR\n\n' + err.message, 'error');
    }
  });

  // Method 2: Using /signup endpoint (works for existing users too in some configs)
  document.getElementById('loginBtn2').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    showMessage('Testing Method 2...', 'info');
    console.log('=== METHOD 2 ===');
    
    try {
      const url = `${API_BASE}/auth/v1/signup`;
      console.log('URL:', url);
      
      const res = await fetch(url, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "apikey": ANON_KEY
        },
        body: JSON.stringify({ 
          email, 
          password,
          options: {
            data: {}
          }
        })
      });

      console.log('Status:', res.status);
      const text = await res.text();
      console.log('Response:', text);
      
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        data = { raw: text };
      }

      if (res.ok && (data.access_token || data.session?.access_token)) {
        const token = data.access_token || data.session.access_token;
        showMessage('✅ Method 2 SUCCESS!\n\n' + JSON.stringify(data, null, 2), 'info');
        localStorage.setItem("sb_access_token", token);
        setTimeout(() => location.replace("dashboard-business.html"), 2000);
      } else if (res.status === 400 && data.msg?.includes('already registered')) {
        // User exists, now try to login
        showMessage('User exists, trying login...', 'info');
        
        const loginRes = await fetch(`${API_BASE}/auth/v1/token?grant_type=password`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "apikey": ANON_KEY
          },
          body: JSON.stringify({ email, password })
        });
        
        const loginData = await loginRes.json();
        
        if (loginRes.ok && loginData.access_token) {
          showMessage('✅ Login SUCCESS!\n\n' + JSON.stringify(loginData, null, 2), 'info');
          localStorage.setItem("sb_access_token", loginData.access_token);
          setTimeout(() => location.replace("dashboard-business.html"), 2000);
        } else {
          showMessage('❌ Login FAILED\n\n' + JSON.stringify(loginData, null, 2), 'error');
        }
      } else {
        showMessage('❌ Method 2 FAILED\n\nStatus: ' + res.status + '\n\n' + JSON.stringify(data, null, 2), 'error');
      }
    } catch (err) {
      console.error('Method 2 error:', err);
      showMessage('❌ Method 2 ERROR\n\n' + err.message, 'error');
    }
  });
</script>
</body>
</html>
