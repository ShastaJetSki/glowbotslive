-- ============================================================================
-- DIAGNOSE: Check RLS and data access issues
-- ============================================================================

-- 1. Check if RLS is enabled on key tables
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('work_orders', 'deals', 'parts_inventory', 'parts_invoices', 'business_settings');

-- 2. Check policies on these tables
SELECT tablename, policyname, cmd 
FROM pg_policies 
WHERE schemaname = 'public'
AND tablename IN ('work_orders', 'deals', 'parts_inventory', 'parts_invoices', 'business_settings')
ORDER BY tablename;

-- 3. Check work_orders columns
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'work_orders' 
ORDER BY ordinal_position;

-- 4. Check deals columns
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'deals' 
ORDER BY ordinal_position;

-- 5. Check parts_invoices columns
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'parts_invoices' 
ORDER BY ordinal_position;

-- 6. Test data counts per tenant
SELECT 'work_orders' as tbl, tenant_id, COUNT(*) FROM work_orders GROUP BY tenant_id
UNION ALL
SELECT 'deals', tenant_id, COUNT(*) FROM deals GROUP BY tenant_id
UNION ALL  
SELECT 'parts_invoices', tenant_id, COUNT(*) FROM parts_invoices GROUP BY tenant_id;
