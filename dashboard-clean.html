<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Foreign Key Deployment - 120 Constraints</title>

  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:#0f1419; color:#e1e8ed; line-height:1.5;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .header {
      background: linear-gradient(135deg, #1a5f45 0%, #1e7a5f 100%);
      padding: 28px; border-radius: 12px; margin-bottom: 18px;
      box-shadow: 0 10px 40px rgba(26, 95, 69, 0.3);
    }
    .header h1 { font-size: 2.0rem; font-weight: 800; color:#fff; margin-bottom: 6px; }
    .header p { color: rgba(255,255,255,.9); }

    .grid { display:grid; gap: 14px; }
    .stats-bar { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); margin: 14px 0 18px; }
    .stat {
      background:#1a1f2e; border:1px solid #2a3441; border-radius: 10px; padding: 16px; text-align:center;
    }
    .stat-number { font-size: 2.1rem; font-weight: 800; margin-bottom: 2px; }
    .stat-number.total { color:#2a9d68; }
    .stat-number.passed { color:#22c55e; }
    .stat-number.failed { color:#ef4444; }
    .stat-number.pending { color:#64748b; }
    .stat-label { font-size:.8rem; color:#94a3b8; text-transform: uppercase; letter-spacing:.06em; }

    .panel {
      background:#1a1f2e; border:1px solid #2a3441; border-radius: 10px; padding: 18px; margin-bottom: 16px;
    }
    .panel h3 { color:#2a9d68; margin-bottom: 10px; font-size:1.05rem; }

    .row { display:flex; flex-wrap:wrap; gap: 10px; align-items:center; }
    .input-group { display:grid; grid-template-columns: 1fr 1fr auto; gap: 10px; width: 100%; }
    @media (max-width: 900px) { .input-group { grid-template-columns: 1fr; } }

    input[type="text"], input[type="password"] {
      background:#0f1419; border:1px solid #2a3441; border-radius: 8px;
      padding: 11px 14px; color:#e1e8ed; font-size:.95rem;
    }
    input:focus { outline:none; border-color:#2a9d68; box-shadow:0 0 0 3px rgba(42,157,104,.12); }

    .btn {
      padding: 11px 14px; border:none; border-radius: 8px;
      font-weight: 800; cursor:pointer; transition: transform .15s, box-shadow .15s, background .15s;
      display:inline-flex; align-items:center; gap:8px; font-size:.92rem;
      user-select:none;
    }
    .btn-primary { background:#2a9d68; color:#fff; }
    .btn-primary:hover { background:#248556; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(42,157,104,.25); }
    .btn-secondary { background:#1e293b; color:#e1e8ed; border: 1px solid #2a3441; }
    .btn-secondary:hover { background:#2a3441; }

    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px; font-weight: 800; font-size: .82rem;
      border: 1px solid #2a3441; background:#0f1419; color:#94a3b8;
    }
    .pill.ok { border-color: rgba(34,197,94,.35); color:#22c55e; background: rgba(34,197,94,.08); }
    .pill.bad { border-color: rgba(239,68,68,.35); color:#ef4444; background: rgba(239,68,68,.08); }
    .pill.warn { border-color: rgba(42,157,104,.35); color:#2a9d68; background: rgba(42,157,104,.10); }

    .progress-outer { background:#0f1419; border-radius: 999px; height: 10px; overflow:hidden; border:1px solid #2a3441; }
    .progress-inner { height:100%; width:0%; background: linear-gradient(90deg, #2a9d68, #248556); transition: width .25s ease; }

    .tabs { display:flex; gap: 10px; flex-wrap:wrap; margin-bottom: 12px; }
    .tab {
      padding: 9px 12px; border-radius: 8px; border:1px solid #2a3441;
      background:#1a1f2e; color:#94a3b8; font-weight: 800; cursor:pointer;
    }
    .tab.active { background:#2a9d68; border-color:#2a9d68; color:#fff; }

    .search { margin: 12px 0; }

    .table-wrap { background:#1a1f2e; border:1px solid #2a3441; border-radius: 10px; overflow:hidden; }
    table { width:100%; border-collapse: collapse; }
    thead { background:#0f1419; position: sticky; top:0; z-index:10; }
    th, td { padding: 12px 12px; text-align:left; border-bottom:1px solid #2a3441; font-size:.92rem; }
    th { color:#2a9d68; text-transform: uppercase; letter-spacing:.06em; font-size:.82rem; }
    tbody tr:hover { background:#1e293b; }

    .fk-number { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; color:#64748b; font-weight:800; }
    .fk-category { display:inline-block; padding: 4px 9px; border-radius: 999px; background:#1e293b; border:1px solid #2a3441; color:#94a3b8; font-weight:800; font-size:.78rem; }
    .fk-relationship { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; color:#94a3b8; font-size:.82rem; }

    .status-badge {
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 8px; font-weight: 900; font-size:.78rem;
      text-transform: uppercase; letter-spacing:.06em;
      border: 1px solid #2a3441; background:#1e293b; color:#64748b;
    }
    .status-badge.pending { background:#1e293b; color:#64748b; border-color:#2a3441; }
    .status-badge.running { background: rgba(42,157,104,.12); color:#2a9d68; border-color: rgba(42,157,104,.35); }
    .status-badge.passed { background: rgba(34,197,94,.12); color:#22c55e; border-color: rgba(34,197,94,.35); }
    .status-badge.failed { background: rgba(239,68,68,.12); color:#ef4444; border-color: rgba(239,68,68,.35); }

    .btn-run {
      padding: 8px 12px; border-radius: 8px; border:none; cursor:pointer; font-weight: 900;
      background:#2a9d68; color:#fff; transition: background .15s, transform .15s;
      min-width: 96px;
    }
    .btn-run:hover:not(:disabled) { background:#248556; transform: translateY(-1px); }
    .btn-run:disabled { background:#2a3441; color:#64748b; cursor:not-allowed; }

    .error-box {
      margin: 8px 12px 12px; padding: 10px 12px;
      border-left: 3px solid #ef4444; border-radius: 8px;
      background: rgba(239,68,68,.10); color:#fca5a5;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: .82rem;
      white-space: pre-wrap;
    }
    .muted { color:#94a3b8; font-size:.88rem; }
    .small { font-size:.84rem; color:#94a3b8; }
  </style>
</head>

<body>
  <div class="container">

    <div class="header">
      <h1>üîó Foreign Key Deployment</h1>
      <p>Run 1 FK at a time, track pass/fail, resume anytime.</p>
      <div class="row" style="margin-top:10px;">
        <span id="conn-pill" class="pill">üîå Not Connected</span>
        <span class="pill">üíæ Auto-saves progress</span>
      </div>
      <div style="margin-top:10px;" class="progress-outer">
        <div id="progress-bar" class="progress-inner"></div>
      </div>
      <div class="small" style="margin-top:8px;">
        Tip: This UI calls <code>rpc('exec_sql', { sql })</code>. Your DB must have an <code>exec_sql</code> function and the caller must be allowed to execute it.
      </div>
    </div>

    <div class="grid stats-bar">
      <div class="stat">
        <div class="stat-number total" id="stat-total">0</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat">
        <div class="stat-number passed" id="stat-passed">0</div>
        <div class="stat-label">‚úÖ Passed</div>
      </div>
      <div class="stat">
        <div class="stat-number failed" id="stat-failed">0</div>
        <div class="stat-label">‚ùå Failed</div>
      </div>
      <div class="stat">
        <div class="stat-number pending" id="stat-pending">0</div>
        <div class="stat-label">‚è≥ Pending</div>
      </div>
    </div>

    <div class="panel">
      <h3>‚ö° Supabase Connection</h3>

      <div class="input-group">
        <input type="text" id="supabase-url" placeholder="Supabase Project URL (https://xxxx.supabase.co)">
        <input type="password" id="supabase-key" placeholder="Anon Key (public)">
        <button class="btn btn-primary" id="btn-connect">Connect</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn btn-primary" id="btn-run-next">‚ñ∂Ô∏è Run Next Pending</button>
        <button class="btn btn-primary" id="btn-run-all">‚ñ∂Ô∏è Run All (sequential)</button>
        <button class="btn btn-secondary" id="btn-reset">üîÑ Reset Progress</button>
        <button class="btn btn-secondary" id="btn-export">üíæ Export Progress</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        Your URL/key are stored in <code>localStorage</code> for convenience. Do NOT paste service_role keys in a browser.
      </div>
    </div>

    <div class="search">
      <input type="text" id="search" placeholder="üîç Search by name, category, table..." oninput="renderTable()" />
    </div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-filter="all">All (<span id="filter-all">0</span>)</button>
      <button class="tab" data-filter="pending">Pending (<span id="filter-pending">0</span>)</button>
      <button class="tab" data-filter="passed">Passed (<span id="filter-passed">0</span>)</button>
      <button class="tab" data-filter="failed">Failed (<span id="filter-failed">0</span>)</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:70px;">#</th>
            <th style="width:220px;">Category</th>
            <th>FK Name / Description</th>
            <th style="width:340px;">Target</th>
            <th style="width:140px;">Status</th>
            <th style="width:120px;">Action</th>
          </tr>
        </thead>
        <tbody id="fk-table-body"></tbody>
      </table>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG / STORAGE KEYS
     ***********************/
    const LS = {
      STATUSES: "fk-statuses",
      URL: "supabase-url",
      KEY: "supabase-key",
    };

    /***********************
     * YOUR 120 FKs GO HERE
     * - Keep this array exactly as you already have it.
     * - It MUST contain 120 objects with fields:
     *   { id, category, name, table, constraint, sql }
     ***********************/
    const foreignKeys = [
      // ‚úÖ Paste your full 120 list here (you already have it)
      // Example entries (leave these or replace with your full list):
      { id: 1, category: "Multi-Tenancy", name: "tenant_users ‚Üí tenants", table: "tenant_users", constraint: "fk_tenant_users_tenant", sql: "ALTER TABLE tenant_users ADD CONSTRAINT fk_tenant_users_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(tenant_id) ON DELETE CASCADE NOT VALID;" },
      { id: 2, category: "Multi-Tenancy", name: "tenant_users ‚Üí users", table: "tenant_users", constraint: "fk_tenant_users_user", sql: "ALTER TABLE tenant_users ADD CONSTRAINT fk_tenant_users_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE NOT VALID;" },
      // ... continue until id:120
    ];

    /***********************
     * STATE
     ***********************/
    let supabaseClient = null;
    let fkStatuses = {}; // { [id]: { status, error, timestamp, durationMs } }
    let currentFilter = "all";

    /***********************
     * HELPERS
     ***********************/
    function $(id) { return document.getElementById(id); }

    function setConnPill(state, msg) {
      const pill = $("conn-pill");
      pill.classList.remove("ok", "bad", "warn");
      if (state === "ok") pill.classList.add("ok");
      if (state === "bad") pill.classList.add("bad");
      if (state === "warn") pill.classList.add("warn");
      pill.textContent = msg;
    }

    function saveProgress() {
      localStorage.setItem(LS.STATUSES, JSON.stringify(fkStatuses));
    }

    function loadProgress() {
      // statuses
      const saved = localStorage.getItem(LS.STATUSES);
      if (saved) {
        try { fkStatuses = JSON.parse(saved) || {}; } catch { fkStatuses = {}; }
      }

      // url + key
      const url = localStorage.getItem(LS.URL);
      const key = localStorage.getItem(LS.KEY);

      if (url) $("supabase-url").value = url;
      if (key) $("supabase-key").value = key;
    }

    function updateStats() {
      const total = foreignKeys.length;
      let passed = 0, failed = 0, pending = 0;

      for (const fk of foreignKeys) {
        const st = fkStatuses[fk.id]?.status || "pending";
        if (st === "passed") passed++;
        else if (st === "failed") failed++;
        else if (st === "running") {} // running doesn't count as pending
        else pending++;
      }

      $("stat-total").textContent = total;
      $("stat-passed").textContent = passed;
      $("stat-failed").textContent = failed;
      $("stat-pending").textContent = pending;

      $("filter-all").textContent = total;
      $("filter-pending").textContent = pending;
      $("filter-passed").textContent = passed;
      $("filter-failed").textContent = failed;

      const pct = total ? Math.round((passed / total) * 1000) / 10 : 0;
      $("progress-bar").style.width = pct + "%";
    }

    function getFilteredList() {
      const search = $("search").value.trim().toLowerCase();

      return foreignKeys.filter(fk => {
        const st = fkStatuses[fk.id]?.status || "pending";
        const matchesFilter = (currentFilter === "all") || (st === currentFilter);

        const hay = (fk.name + " " + fk.category + " " + fk.table + " " + fk.constraint).toLowerCase();
        const matchesSearch = !search || hay.includes(search);

        return matchesFilter && matchesSearch;
      });
    }

    /***********************
     * RENDER
     ***********************/
    function renderTable() {
      const tbody = $("fk-table-body");
      tbody.innerHTML = "";

      const list = getFilteredList();

      for (const fk of list) {
        const info = fkStatuses[fk.id] || { status: "pending", error: null };
        const st = info.status || "pending";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="fk-number">#${fk.id}</td>
          <td><span class="fk-category">${escapeHtml(fk.category)}</span></td>
          <td>
            <div style="font-weight:800;">${escapeHtml(fk.name)}</div>
            <div class="small">${escapeHtml(fk.constraint)}</div>
          </td>
          <td class="fk-relationship">${escapeHtml(fk.table)} ‚Üí ${escapeHtml(fk.constraint)}</td>
          <td><span class="status-badge ${st}">${st}</span></td>
          <td>
            <button class="btn-run" data-id="${fk.id}" ${st === "running" ? "disabled" : ""}>
              ${st === "running" ? "‚è≥ Running" : st === "passed" ? "‚úÖ Re-run" : st === "failed" ? "üîÅ Retry" : "‚ñ∂Ô∏è Run"}
            </button>
          </td>
        `;
        tbody.appendChild(tr);

        if (info.error) {
          const errTr = document.createElement("tr");
          errTr.innerHTML = `<td colspan="6"><div class="error-box">‚ùå ${escapeHtml(info.error)}</div></td>`;
          tbody.appendChild(errTr);
        }
      }

      // hook buttons
      tbody.querySelectorAll(".btn-run").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = Number(btn.getAttribute("data-id"));
          await runFK(id);
        });
      });

      updateStats();
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    /***********************
     * CONNECT
     ***********************/
    async function connectSupabase() {
      const url = $("supabase-url").value.trim();
      const key = $("supabase-key").value.trim();

      if (!url || !key) {
        alert("Please enter both Supabase URL and Anon Key.");
        return;
      }

      try {
        supabaseClient = window.supabase.createClient(url, key, {
          auth: { persistSession: false }, // keep this simple
        });

        setConnPill("warn", "üîå Connecting...");

        // simple ping (choose a table that exists for you; "tenants" is common)
        const { error } = await supabaseClient.from("tenants").select("*", { count: "exact", head: true }).limit(1);
        if (error) throw error;

        localStorage.setItem(LS.URL, url);
        localStorage.setItem(LS.KEY, key);

        setConnPill("ok", "‚úÖ Connected");
        alert("‚úÖ Connected successfully!");
      } catch (e) {
        console.error(e);
        supabaseClient = null;
        setConnPill("bad", "‚ùå Not Connected");
        alert("‚ùå Connection failed: " + (e?.message || String(e)));
      }
    }

    /***********************
     * RUN ONE FK
     ***********************/
    async function runFK(id) {
      if (!supabaseClient) {
        alert("Please connect to Supabase first.");
        return;
      }

      const fk = foreignKeys.find(x => x.id === id);
      if (!fk) return;

      // mark running
      fkStatuses[id] = { status: "running", error: null, timestamp: Date.now() };
      saveProgress();
      renderTable();

      const started = performance.now();

      try {
        // IMPORTANT: this expects a DB function named exec_sql(sql text)
        const { error } = await supabaseClient.rpc("exec_sql", { sql: fk.sql });

        const durationMs = Math.round(performance.now() - started);

        if (error) {
          fkStatuses[id] = { status: "failed", error: error.message || String(error), timestamp: Date.now(), durationMs };
        } else {
          fkStatuses[id] = { status: "passed", error: null, timestamp: Date.now(), durationMs };
        }
      } catch (e) {
        const durationMs = Math.round(performance.now() - started);
        fkStatuses[id] = { status: "failed", error: e?.message || String(e), timestamp: Date.now(), durationMs };
      }

      saveProgress();
      renderTable();
    }

    /***********************
     * RUN NEXT PENDING
     ***********************/
    async function runNextPending() {
      if (!supabaseClient) { alert("Please connect to Supabase first."); return; }

      const next = foreignKeys.find(fk => (fkStatuses[fk.id]?.status || "pending") === "pending");
      if (!next) { alert("No pending foreign keys left üéâ"); return; }

      await runFK(next.id);
    }

    /***********************
     * RUN ALL (SEQUENTIAL)
     ***********************/
    async function runAllSequential() {
      if (!supabaseClient) { alert("Please connect to Supabase first."); return; }
      if (!confirm(`Run all foreign keys sequentially? (Total: ${foreignKeys.length})`)) return;

      for (const fk of foreignKeys) {
        const st = fkStatuses[fk.id]?.status || "pending";
        if (st === "passed") continue; // skip passed
        await runFK(fk.id);
        await new Promise(r => setTimeout(r, 120)); // tiny delay to reduce rate/lock spikes
      }
    }

    /***********************
     * RESET / EXPORT
     ***********************/
    function resetAll() {
      if (!confirm("Reset all progress? This only clears local status, not DB changes.")) return;
      fkStatuses = {};
      saveProgress();
      renderTable();
    }

    function exportProgress() {
      const payload = { exported_at: new Date().toISOString(), statuses: fkStatuses };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `fk-progress-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    /***********************
     * TABS
     ***********************/
    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelector(`.tab[data-filter="${filter}"]`)?.classList.add("active");
      renderTable();
    }

    /***********************
     * INIT
     ***********************/
    document.addEventListener("DOMContentLoaded", () => {
      loadProgress();

      // wire buttons
      $("btn-connect").addEventListener("click", connectSupabase);
      $("btn-run-next").addEventListener("click", runNextPending);
      $("btn-run-all").addEventListener("click", runAllSequential);
      $("btn-reset").addEventListener("click", resetAll);
      $("btn-export").addEventListener("click", exportProgress);

      // tabs
      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => setFilter(tab.dataset.filter));
      });

      // initial counts
      $("stat-total").textContent = foreignKeys.length;
      $("filter-all").textContent = foreignKeys.length;

      // initial render
      renderTable();

      // if url/key were saved, show "Not Connected" but ready
      setConnPill("warn", "üîå Not Connected (ready)");
    });
  </script>
</body>
</html>
