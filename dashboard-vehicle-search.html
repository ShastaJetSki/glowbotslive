<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Vehicle Lookup</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="PASTE_YOUR_ANON_KEY_HERE" />

<style>
body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
.appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

.sub-nav {
  display:flex; gap:16px; margin:8px 0 20px;
  padding-bottom:10px; border-bottom:1px solid #1f2937;
}
.sub-nav a { color:#9ca3af; text-decoration:none; }
.sub-nav a.active {
  color:#38bdf8; font-weight:500;
  border-bottom:2px solid #38bdf8; padding-bottom:10px;
}

h1 { margin:0 0 12px; font-size:36px; }

.card {
  background:#0f1621; border:1px solid #223044;
  border-radius:14px; padding:14px 16px;
}
.list { display:flex; flex-direction:column; gap:10px; margin-top:16px; }

input {
  width:100%; padding:12px 14px;
  border-radius:12px; border:1px solid #223044;
  background:#0f1621; color:#fff;
}

.muted { font-size:12px; color:#9fb0c3; }
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<h1>Vehicle Lookup</h1>

<div class="sub-nav">
  <a href="/dashboard-business.html">Dashboard</a>
  <a href="/dashboard-customer-search.html">Customers</a>
  <a href="/dashboard-vehicle-search.html" class="active">Vehicles</a>
</div>

<input id="search" placeholder="Search by plate, VIN, make, model…" />
<div id="results" class="list"></div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let vehicles = [];
let customers = [];

async function validateAuth() {
  const token = localStorage.getItem("sb_access_token");
  if (!token) location.replace("login.html");
  return token;
}

async function fetchTable(table, token) {
  const res = await fetch(
    `https://${PROJECT_REF}.supabase.co/rest/v1/${table}?select=*`,
    {
      headers: {
        Authorization: `Bearer ${token}`,
        apikey: ANON_KEY,
        Accept: "application/json",
        "Content-Type": "application/json"
      }
    }
  );
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function render() {
  const q = search.value.toLowerCase();

  const filtered = vehicles
    .filter(v =>
      (`${v.make} ${v.model} ${v.year} ${v.vin_or_cf_number||""} ${v.license_plate||""}`)
        .toLowerCase().includes(q)
    )
    .sort((a,b) => {
      const ap = (a.license_plate||"").toLowerCase();
      const bp = (b.license_plate||"").toLowerCase();
      if (ap.startsWith(q)) return -1;
      if (bp.startsWith(q)) return 1;
      return ap.localeCompare(bp);
    });

  results.innerHTML = filtered.map(v => {
    const c = customers.find(x => x.customer_id === v.customer_id);
    return `
      <div class="card">
        <strong>${v.year||""} ${v.make||""} ${v.model||""}</strong>
        <div class="muted">Plate: ${v.license_plate||"—"}</div>
        <div class="muted">Owner: ${c ? `${c.first_name} ${c.last_name}` : "—"}</div>
      </div>
    `;
  }).join("");
}

(async () => {
  const token = await validateAuth();
  vehicles  = await fetchTable("vehicles", token);
  customers = await fetchTable("customers", token);
  render();
  search.oninput = render;
})();
</script>
</body>
</html>
