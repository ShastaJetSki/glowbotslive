<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Work Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    button, select {
      padding:8px 14px; border-radius:10px; border:1px solid #2a3b55; background:#1a2535; color:#fff; cursor:pointer;
    }
    .kpis { display:flex; gap:12px; margin-bottom:16px; }
    .kpi { background:#0f1621; border:1px solid #223044; border-radius:12px; padding:12px 16px; min-width:160px; }
    .kpi .label { font-size:12px; color:#9fb0c3; }
    .kpi .value { font-size:20px; font-weight:600; }

    .filters { margin-bottom:16px; }

    .card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:14px; margin-bottom:12px; }
    .muted { color:#9fb0c3; font-size:13px; }
    .job-name { font-weight:600; margin-bottom:4px; }
    .meta { font-size:11px; color:#7c8ca3; margin-top:6px; }
    .empty { padding:18px; border:1px dashed #223044; border-radius:14px; background:#0f1621; color:#9fb0c3; }
    .error { padding:16px; border-radius:12px; background:#2a1414; border:1px solid #553333; color:#ffb3b3; white-space:pre-wrap; }
  </style>
</head>

<body>
<header>
  <h1>Work Orders</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="kpis" id="kpis"></div>

<div class="filters">
  <label class="muted">Filter by status:</label><br/>
  <select id="statusFilter">
    <option value="all">All</option>
    <option value="scheduled">Scheduled</option>
    <option value="in_progress">In Progress</option>
    <option value="completed">Completed</option>
  </select>
</div>

<div id="content">Loading…</div>

<script>
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const FUNCTIONS = `${API_BASE}/functions/v1`;

  const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;
  const token = localStorage.getItem("sb_access_token");
  if (!token) location.href = "login.html";

  let ALL_ORDERS = [];
  let CUSTOMER_MAP = new Map();

  function money(n) {
    const x = Number(n ?? 0);
    return `$${x}`;
  }

  function customerDisplay(c) {
    if (!c) return null;
    // support either schema:
    // - name
    // - first_name/last_name
    if (c.name) return c.name;
    const fn = c.first_name || "";
    const ln = c.last_name || "";
    const full = `${fn} ${ln}`.trim();
    return full || null;
  }

  async function apiGet(path) {
    const res = await fetch(`${FUNCTIONS}${path}`, {
      headers: {
        Authorization: `Bearer ${token}`,
        apikey: ANON_KEY
      }
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`${path} → ${res.status}\n${text}`);
    }
    return res.json();
  }

  async function load() {
    const content = document.getElementById("content");
    try {
      // Fetch both in parallel — NO joins, no function changes.
      const [woJson, custJson] = await Promise.all([
        apiGet("/work_orders"),
        apiGet("/customers")
      ]);

      ALL_ORDERS = woJson.work_orders || [];

      const customers = custJson.customers || custJson.data || [];
      CUSTOMER_MAP = new Map();

      for (const c of customers) {
        const display = customerDisplay(c);
        if (c.customer_id) CUSTOMER_MAP.set(c.customer_id, display || `Customer ${String(c.customer_id).slice(0,6)}`);
      }

      render();
    } catch (err) {
      console.error(err);
      content.innerHTML = `<div class="error">Failed to load:\n${err.message}</div>`;
    }
  }

  function render() {
    const status = document.getElementById("statusFilter").value;
    const orders = status === "all" ? ALL_ORDERS : ALL_ORDERS.filter(o => o.status === status);

    const total = orders.reduce((sum, w) => sum + Number(w.grand_total || 0), 0);

    document.getElementById("kpis").innerHTML = `
      <div class="kpi">
        <div class="label">Work Orders</div>
        <div class="value">${orders.length}</div>
      </div>
      <div class="kpi">
        <div class="label">Total Revenue</div>
        <div class="value">$${total}</div>
      </div>
    `;

    const content = document.getElementById("content");
    content.innerHTML = "";

    if (!orders.length) {
      content.innerHTML = `<div class="empty">No work orders.</div>`;
      return;
    }

    for (let i = 0; i < orders.length; i++) {
      const wo = orders[i];
      const shortId = String(wo.work_order_id || "").slice(0, 8);
      const created = wo.created_at ? new Date(wo.created_at).toLocaleString() : "—";

      const custName = wo.customer_id ? (CUSTOMER_MAP.get(wo.customer_id) || `Customer ${String(wo.customer_id).slice(0,6)}`) : "No customer";

      // Simple “name” to prove distinctness even if pricing same
      const displayName = `${wo.summary || "Work Order"} #${i + 1}`;

      content.innerHTML += `
        <div class="card">
          <div class="job-name">${displayName}</div>
          <div class="muted">Customer: ${custName}</div>
          <div class="muted">Status: ${wo.status || "—"}</div>
          <div>
            Labor: ${money(wo.labor_total)} ·
            Parts: ${money(wo.parts_total)} ·
            <strong>Total: ${money(wo.grand_total)}</strong>
          </div>
          <div class="meta">
            WO ${shortId} · Created ${created}
          </div>
        </div>
      `;
    }
  }

  document.getElementById("statusFilter").addEventListener("change", render);

  function logout() {
    localStorage.removeItem("sb_access_token");
    location.href = "login.html";
  }

  load();
</script>
</body>
</html>
