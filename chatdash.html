import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import { handleCors, json } from "./_shared/http.ts";
import { requireAuthAndTenant } from "./_shared/guard.ts";

serve(async (req) => {
  const cors = handleCors(req);
  if (cors) return cors;

  try {
    const { supabase, tenant } =
      await requireAuthAndTenant(req);

    if (req.method === "GET") {
      const { data, error } = await supabase
        .from("work_orders")
        .select(`
          work_order_id,
          summary,
          status,
          labor_total,
          parts_total,
          grand_total,
          created_at,
          customers (
            customer_id,
            name
          )
        `)
        .eq("tenant_id", tenant.tenant_id)
        .order("created_at", { ascending: false });

      if (error) {
        return json({ error: error.message }, 500);
      }

      return json({ work_orders: data });
    }

    return json({ error: "Method not allowed" }, 405);
  } catch (err) {
    return json({ error: String(err) }, 500);
  }
});
