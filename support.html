<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Support</title>
  <script>
    (function() {
      var theme = localStorage.getItem('app-theme') || 'dark-blue';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="dark-blue"] { --bg-primary: #0b0f14; --bg-secondary: #0f1621; --bg-card: #1a2535; --bg-hover: #223044; --border-default: #223044; --text-primary: #e8eef6; --text-secondary: #9fb0c3; --accent-primary: #3b82f6; --accent-light: #60a5fa; }
    [data-theme="blue-light"] { --bg-primary: #f0f5ff; --bg-secondary: #e0eaff; --bg-card: #ffffff; --bg-hover: #d0e0ff; --border-default: #b0c8f0; --text-primary: #1a2744; --text-secondary: #4a5a74; --accent-primary: #2563eb; --accent-light: #3b82f6; }
    [data-theme="slate-dark"] { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #273549; --bg-hover: #334155; --border-default: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --accent-primary: #64748b; --accent-light: #94a3b8; }
    [data-theme="slate-light"] { --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-card: #ffffff; --bg-hover: #e2e8f0; --border-default: #cbd5e1; --text-primary: #0f172a; --text-secondary: #475569; --accent-primary: #475569; --accent-light: #64748b; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { background: var(--bg-primary); }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding-bottom: 100px; }

    .header { padding: 16px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .back-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; cursor: pointer; text-decoration: none; }
    .back-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

    .content { max-width: 800px; margin: 0 auto; padding: 20px; }

    .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
    .tab { padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border-default); background: transparent; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; }
    .tab:hover { background: var(--bg-hover); }
    .tab.active { background: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-default); padding: 24px; margin-bottom: 16px; }
    .card-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-label .required { color: #ef4444; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border-default); background: var(--bg-secondary); color: var(--text-primary); font-size: 16px; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
    .form-textarea { min-height: 150px; resize: vertical; font-family: inherit; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .btn { padding: 14px 24px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--accent-primary); color: #fff; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-secondary { background: transparent; border: 1px solid var(--border-default); color: var(--text-secondary); }
    .btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }

    .ticket-list { display: flex; flex-direction: column; gap: 12px; }
    .ticket-item { background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-default); padding: 16px; cursor: pointer; transition: all 0.2s; }
    .ticket-item:hover { background: var(--bg-hover); border-color: var(--accent-primary); }
    .ticket-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 12px; }
    .ticket-subject { font-weight: 600; font-size: 15px; flex: 1; }
    .ticket-number { font-size: 12px; color: var(--text-secondary); white-space: nowrap; }
    .ticket-meta { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-secondary); }
    .ticket-status { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .status-open { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .status-in_progress { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .status-waiting_on_customer { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
    .status-resolved { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .status-closed { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }

    .ticket-detail { display: none; }
    .ticket-detail.active { display: block; }
    .ticket-detail-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-default); }
    .ticket-detail-subject { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
    .ticket-detail-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; color: var(--text-secondary); }

    .ticket-description { background: var(--bg-secondary); border-radius: 10px; padding: 16px; margin-bottom: 24px; line-height: 1.6; white-space: pre-wrap; }

    .replies-section { margin-top: 24px; }
    .replies-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .reply-item { background: var(--bg-secondary); border-radius: 10px; padding: 16px; margin-bottom: 12px; border-left: 3px solid var(--border-default); }
    .reply-item.admin { border-left-color: var(--accent-primary); background: rgba(59, 130, 246, 0.05); }
    .reply-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
    .reply-author { font-weight: 600; color: var(--text-primary); }
    .reply-author.admin { color: var(--accent-light); }
    .reply-time { color: var(--text-secondary); }
    .reply-message { line-height: 1.6; white-space: pre-wrap; }

    .reply-form { margin-top: 20px; }
    .reply-textarea { min-height: 100px; }

    .success-message { background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; color: #22c55e; padding: 16px; border-radius: 10px; margin-bottom: 20px; display: none; }
    .success-message.show { display: block; }

    .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); padding: 12px; z-index: 100; border-top: 1px solid var(--border-default); }
    .mobile-nav-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .mobile-nav-btn { padding: 12px 8px; border-radius: 8px; border: 1px solid var(--border-default); background: var(--bg-card); color: var(--text-secondary); font-size: 12px; font-weight: 600; cursor: pointer; text-decoration: none; text-align: center; }
    .mobile-nav-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }

    @media (max-width: 768px) {
      .mobile-bottom-nav { display: block; }
      .form-row { grid-template-columns: 1fr; }
      .header h1 { font-size: 20px; }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>Support</h1>
  <div class="header-actions">
    <a href="dashboard-sharklaw.html" class="back-btn">‚Üê Back</a>
  </div>
</div>

<div class="content">
  <div class="tabs">
    <button class="tab active" onclick="switchTab('new')">New Ticket</button>
    <button class="tab" onclick="switchTab('mytickets')">My Tickets</button>
  </div>

  <!-- NEW TICKET TAB -->
  <div id="newTab" class="tab-content active">
    <div class="success-message" id="successMessage">
      <strong>‚úì Ticket Submitted!</strong><br>
      We've received your support request and will respond as soon as possible. You can track your ticket in "My Tickets".
    </div>

    <div class="card">
      <div class="card-title">Submit a Support Request</div>
      
      <form id="ticketForm" onsubmit="submitTicket(event)">
        <div class="form-group">
          <label class="form-label">Subject <span class="required">*</span></label>
          <input type="text" class="form-input" id="ticketSubject" placeholder="Brief description of your issue" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="ticketCategory">
              <option value="general">General Question</option>
              <option value="bug">Bug Report</option>
              <option value="feature">Feature Request</option>
              <option value="billing">Billing</option>
              <option value="account">Account Issue</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Priority</label>
            <select class="form-select" id="ticketPriority">
              <option value="low">Low</option>
              <option value="normal" selected>Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Description <span class="required">*</span></label>
          <textarea class="form-textarea" id="ticketDescription" placeholder="Please describe your issue in detail. Include any steps to reproduce if reporting a bug." required></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Your Email <span class="required">*</span></label>
          <input type="email" class="form-input" id="ticketEmail" placeholder="your@email.com" required>
        </div>

        <div class="form-group">
          <label class="form-label">Your Name</label>
          <input type="text" class="form-input" id="ticketName" placeholder="Your name (optional)">
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Ticket</button>
      </form>
    </div>
  </div>

  <!-- MY TICKETS TAB -->
  <div id="myticketsTab" class="tab-content">
    <div id="ticketListView">
      <div class="ticket-list" id="ticketList">
        <div class="empty-state">
          <div class="empty-state-icon">üé´</div>
          <div class="empty-state-title">No tickets yet</div>
          <p>Submit a support request and it will appear here.</p>
        </div>
      </div>
    </div>

    <div id="ticketDetailView" class="ticket-detail">
      <button class="btn btn-secondary" onclick="backToList()" style="margin-bottom: 20px;">‚Üê Back to Tickets</button>
      
      <div class="card">
        <div class="ticket-detail-header">
          <div class="ticket-detail-subject" id="detailSubject">Loading...</div>
          <div class="ticket-detail-meta">
            <span id="detailTicketNumber">#0000</span>
            <span id="detailStatus" class="ticket-status status-open">Open</span>
            <span id="detailCategory">General</span>
            <span id="detailCreated">Created: --</span>
          </div>
        </div>

        <div class="ticket-description" id="detailDescription">Loading...</div>

        <div class="replies-section">
          <div class="replies-title">üí¨ Conversation</div>
          <div id="repliesList"></div>

          <div class="reply-form" id="replyForm">
            <div class="form-group">
              <label class="form-label">Add a Reply</label>
              <textarea class="form-textarea reply-textarea" id="replyMessage" placeholder="Type your message..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitReply()">Send Reply</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mobile-bottom-nav">
  <div class="mobile-nav-row">
    <a href="dashboard-sharklaw.html" class="mobile-nav-btn">Dashboard</a>
    <a href="support.html" class="mobile-nav-btn active">Support</a>
    <a href="sharklaw-settings.html" class="mobile-nav-btn">Settings</a>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Detect which project based on URL or localStorage
const PROJECT_NAME = window.location.hostname.includes('worklogic') ? 'worklogic_pro' : 'sharklaw';

let currentUserId = null;
let currentTenantId = null;
let userEmail = null;
let userName = null;
let currentTicketId = null;
let allTickets = [];

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(tab + 'Tab').classList.add('active');
  
  if (tab === 'mytickets') {
    loadMyTickets();
    backToList();
  }
}

// Submit new ticket
async function submitTicket(e) {
  e.preventDefault();
  
  const subject = document.getElementById('ticketSubject').value.trim();
  const description = document.getElementById('ticketDescription').value.trim();
  const category = document.getElementById('ticketCategory').value;
  const priority = document.getElementById('ticketPriority').value;
  const email = document.getElementById('ticketEmail').value.trim();
  const name = document.getElementById('ticketName').value.trim();
  
  if (!subject || !description || !email) {
    alert('Please fill in all required fields.');
    return;
  }
  
  try {
    const { data, error } = await sb.from('support_tickets').insert({
      tenant_id: currentTenantId || '55555555-5555-5555-5555-555555555555',
      user_id: currentUserId,
      submitter_email: email,
      submitter_name: name || null,
      team: PROJECT_NAME,
      subject: subject,
      description: description,
      category: category,
      priority: priority,
      status: 'open',
      tags: { browser: navigator.userAgent, page: window.location.href }
    }).select();
    
    if (error) throw error;
    
    // Show success message
    document.getElementById('successMessage').classList.add('show');
    document.getElementById('ticketForm').reset();
    
    // Pre-fill email again
    if (userEmail) {
      document.getElementById('ticketEmail').value = userEmail;
    }
    if (userName) {
      document.getElementById('ticketName').value = userName;
    }
    
    // Hide success after 5 seconds
    setTimeout(() => {
      document.getElementById('successMessage').classList.remove('show');
    }, 5000);
    
  } catch (err) {
    console.error('Error submitting ticket:', err);
    alert('Error submitting ticket: ' + (err.message || 'Unknown error'));
  }
}

// Load user's tickets
async function loadMyTickets() {
  if (!userEmail) {
    document.getElementById('ticketList').innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üîí</div>
        <div class="empty-state-title">Please log in</div>
        <p>Log in to view your support tickets.</p>
      </div>
    `;
    return;
  }
  
  try {
    const { data, error } = await sb
      .from('support_tickets')
      .select('*')
      .eq('submitter_email', userEmail)
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    allTickets = data || [];
    renderTicketList();
    
  } catch (err) {
    console.error('Error loading tickets:', err);
    document.getElementById('ticketList').innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">‚ö†Ô∏è</div>
        <div class="empty-state-title">Error loading tickets</div>
        <p>${err.message || 'Please try again later.'}</p>
      </div>
    `;
  }
}

function renderTicketList() {
  const container = document.getElementById('ticketList');
  
  if (!allTickets.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üé´</div>
        <div class="empty-state-title">No tickets yet</div>
        <p>Submit a support request and it will appear here.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = allTickets.map(t => `
    <div class="ticket-item" onclick="viewTicket('${t.ticket_id}')">
      <div class="ticket-header">
        <div class="ticket-subject">${escapeHtml(t.subject)}</div>
        <div class="ticket-number">#${t.ticket_number || t.ticket_id.slice(0,8)}</div>
      </div>
      <div class="ticket-meta">
        <span class="ticket-status status-${t.status}">${formatStatus(t.status)}</span>
        <span>${t.category}</span>
        <span>${formatDate(t.created_at)}</span>
      </div>
    </div>
  `).join('');
}

function formatStatus(status) {
  const map = {
    'open': 'Open',
    'in_progress': 'In Progress',
    'waiting_on_customer': 'Waiting on You',
    'resolved': 'Resolved',
    'closed': 'Closed'
  };
  return map[status] || status;
}

function formatDate(d) {
  if (!d) return '--';
  const date = new Date(d);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatDateTime(d) {
  if (!d) return '--';
  const date = new Date(d);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// View ticket detail
async function viewTicket(ticketId) {
  currentTicketId = ticketId;
  
  document.getElementById('ticketListView').style.display = 'none';
  document.getElementById('ticketDetailView').classList.add('active');
  
  const ticket = allTickets.find(t => t.ticket_id === ticketId);
  if (!ticket) return;
  
  document.getElementById('detailSubject').textContent = ticket.subject;
  document.getElementById('detailTicketNumber').textContent = '#' + (ticket.ticket_number || ticket.ticket_id.slice(0,8));
  document.getElementById('detailStatus').textContent = formatStatus(ticket.status);
  document.getElementById('detailStatus').className = 'ticket-status status-' + ticket.status;
  document.getElementById('detailCategory').textContent = ticket.category;
  document.getElementById('detailCreated').textContent = 'Created: ' + formatDateTime(ticket.created_at);
  document.getElementById('detailDescription').textContent = ticket.description;
  
  // Hide reply form if ticket is closed
  document.getElementById('replyForm').style.display = (ticket.status === 'closed') ? 'none' : 'block';
  
  // Load replies
  loadReplies(ticketId);
}

async function loadReplies(ticketId) {
  try {
    const { data, error } = await sb
      .from('ticket_comments')
      .select('*')
      .eq('ticket_id', ticketId)
      .eq('is_internal', false)  // Don't show internal notes to customers
      .order('created_at', { ascending: true });
    
    if (error) throw error;
    
    const container = document.getElementById('repliesList');
    
    if (!data || !data.length) {
      container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">No replies yet. We\'ll respond as soon as possible.</p>';
      return;
    }
    
    container.innerHTML = data.map(r => `
      <div class="reply-item ${r.comment_type === 'agent' ? 'admin' : ''}">
        <div class="reply-header">
          <span class="reply-author ${r.comment_type === 'agent' ? 'admin' : ''}">${r.comment_type === 'agent' ? 'üë§ Support Team' : (r.commenter_name || 'You')}</span>
          <span class="reply-time">${formatDateTime(r.created_at)}</span>
        </div>
        <div class="reply-message">${escapeHtml(r.content)}</div>
      </div>
    `).join('');
    
  } catch (err) {
    console.error('Error loading replies:', err);
  }
}

async function submitReply() {
  const message = document.getElementById('replyMessage').value.trim();
  if (!message) {
    alert('Please enter a message.');
    return;
  }
  
  try {
    const { error } = await sb.from('ticket_comments').insert({
      ticket_id: currentTicketId,
      user_id: currentUserId,
      commenter_email: userEmail,
      commenter_name: userName,
      content: message,
      comment_type: 'customer',
      is_internal: false
    });
    
    if (error) throw error;
    
    document.getElementById('replyMessage').value = '';
    loadReplies(currentTicketId);
    
  } catch (err) {
    console.error('Error submitting reply:', err);
    alert('Error submitting reply: ' + (err.message || 'Unknown error'));
  }
}

function backToList() {
  currentTicketId = null;
  document.getElementById('ticketDetailView').classList.remove('active');
  document.getElementById('ticketListView').style.display = 'block';
}

// Auth check
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  
  if (!session) {
    const token = localStorage.getItem('sb_access_token');
    const refresh = localStorage.getItem('sb_refresh_token');
    if (token && refresh) {
      const { data } = await sb.auth.setSession({ access_token: token, refresh_token: refresh });
      if (data?.session) {
        currentUserId = data.session.user.id;
        userEmail = data.session.user.email;
      }
    }
  } else {
    currentUserId = session.user.id;
    userEmail = session.user.email;
  }
  
  // Get user details
  if (userEmail) {
    const { data: userData } = await sb.from('users').select('*').eq('email', userEmail).single();
    if (userData) {
      currentTenantId = userData.tenant_id;
      currentUserId = userData.user_id;
    }
    
    // Try to get name from employees
    const { data: empData } = await sb.from('employees').select('first_name, last_name').eq('email', userEmail).single();
    if (empData) {
      userName = ((empData.first_name || '') + ' ' + (empData.last_name || '')).trim();
    }
    
    // Pre-fill form
    document.getElementById('ticketEmail').value = userEmail;
    if (userName) {
      document.getElementById('ticketName').value = userName;
    }
  }
}

// Initialize
checkAuth();
</script>

</body>
</html>
