<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }

    /* pin app name top-right */
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }

    /* Updated sub-nav under title */
    .sub-nav {
      display:flex;
      gap:16px;
      margin: 8px 0 0;
      padding-bottom:10px;
      border-bottom:1px solid #1f2937;
      flex-wrap:wrap;
    }
    .sub-nav-link {
      font-size:14px;
      color:#9ca3af;
      text-decoration:none;
      padding:4px 2px;
      position:relative;
    }
    .sub-nav-link:hover { color:#e5e7eb; }
    .sub-nav-link.active { color:#38bdf8; font-weight:500; }
    .sub-nav-link.active::after {
      content:"";
      position:absolute;
      left:0;
      bottom:-11px;
      width:100%;
      height:2px;
      background:#38bdf8;
      border-radius:2px;
    }

    /* Button group for Settings and Logout */
    .header-buttons {
      display:flex;
      gap:8px;
      align-items:center;
    }

    button {
      padding:8px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:#243648; }

    .card {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:14px;
      padding:20px;
      margin-bottom:16px;
    }

    .setting-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #223044;
    }

    .setting-row:last-child {
      border-bottom:none;
    }

    .setting-label {
      font-size:14px;
      font-weight:500;
    }

    .setting-description {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="file"] {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #223044;
      background:#0b0f14;
      color:#e8eef6;
      width:200px;
    }

    input[type="file"] {
      padding:6px 12px;
      font-size:12px;
    }

    input:focus {
      outline:none;
      border-color:#3b82f6;
    }

    .save-btn {
      background:#3b82f6;
      border-color:#3b82f6;
      margin-top:16px;
    }

    .save-btn:hover {
      background:#2563eb;
    }

    .muted {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    .success {
      color:#4ade80;
      font-size:12px;
      margin-top:8px;
    }

    .error {
      color:#ef4444;
      font-size:12px;
      margin-top:8px;
    }

    /* Employee Avatar Styles */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .employee-card {
      background: #0b0f14;
      border: 1px solid #223044;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .employee-avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      border: 2px solid #223044;
      background: #0f1621;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      color: #e8eef6;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .employee-avatar-preview:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .employee-avatar-preview::after {
      content: 'Click to edit';
      position: absolute;
      bottom: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(59, 130, 246, 0.95);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .employee-avatar-preview:hover::after {
      opacity: 1;
    }

    .employee-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .employee-role {
      font-size: 11px;
      color: #9fb0c3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .employee-stats {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #223044;
      text-align: left;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .stat-label {
      color: #9fb0c3;
    }

    .stat-value {
      color: #e8eef6;
      font-weight: 600;
    }

    .view-profile-btn {
      width: 100%;
      margin-top: 10px;
      padding: 6px 10px;
      font-size: 12px;
      background: #0f1621;
      border-color: #3b82f6;
    }

    .view-profile-btn:hover {
      background: #1a2535;
      border-color: #38bdf8;
    }

    /* Employee Profile Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: #0f1621;
      border: 1px solid #223044;
      border-radius: 14px;
      padding: 24px;
      width: 100%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #223044;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #9fb0c3;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .modal-close:hover {
      color: #e8eef6;
      background: #1a2535;
      border-radius: 8px;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #9fb0c3;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .modal-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #223044;
      gap: 16px;
    }

    .modal-info-row:last-child {
      border-bottom: none;
    }

    .modal-label {
      font-size: 13px;
      color: #9fb0c3;
      flex-shrink: 0;
    }

    .modal-value {
      font-size: 13px;
      font-weight: 500;
      text-align: right;
      flex-grow: 1;
    }

    .modal-input,
    .modal-select,
    .modal-textarea {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #223044;
      background: #0b0f14;
      color: #e8eef6;
      font-family: system-ui;
      font-size: 13px;
    }

    .modal-input:focus,
    .modal-select:focus,
    .modal-textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .modal-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #223044;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-save-btn {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .modal-save-btn:hover {
      background: #2563eb;
    }

    .modal-delete-btn {
      background: #ef4444;
      border-color: #ef4444;
    }

    .modal-delete-btn:hover {
      background: #dc2626;
    }

    .accomplishments-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .accomplishments-list li {
      padding: 8px 12px;
      background: #0b0f14;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
      border-left: 3px solid #3b82f6;
    }

    /* Accordion Styles */
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
    }

    .accordion-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .accordion-icon {
      font-size: 20px;
      color: #9fb0c3;
      transition: transform 0.2s ease;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.active {
      max-height: 2000px;
    }

    .accordion-inner {
      padding-top: 16px;
    }

    /* Icon Nav Bar - Compact 3-button row */
    .icon-nav-bar {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding: 6px;
      background: rgba(15, 22, 33, 0.5);
      border-radius: 10px;
      border: 1px solid #223044;
    }

    .icon-nav-btn {
      flex: 1;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      background: transparent;
      padding: 0;
    }

    .icon-nav-btn svg {
      transition: all 0.15s ease;
    }

    .icon-nav-primary {
      color: #6b7280;
    }

    .icon-nav-primary:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .icon-nav-danger {
      color: #6b7280;
    }

    .icon-nav-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }

    .icon-nav-btn:active {
      transform: scale(0.95);
    }

    /* Old icon button styles - hidden */
    .icon-btn {
      width: 100%;
      aspect-ratio: 1;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      position: relative;
    }

    .icon-btn svg {
      transition: all 0.2s ease;
    }

    .icon-btn-primary {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .icon-btn-primary:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: #60a5fa;
      color: #60a5fa;
      transform: translateY(-1px);
    }

    .icon-btn-primary:active {
      transform: translateY(0);
    }

    .icon-btn-danger {
      border-color: #6b7280;
      color: #6b7280;
    }

    .icon-btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
      transform: translateY(-1px);
    }

    .icon-btn-danger:active {
      transform: translateY(0);
    }

    .icon-btn-disabled {
      border-color: #374151;
      color: #4b5563;
      cursor: not-allowed;
      opacity: 0.4;
    }

    .icon-btn-disabled:hover {
      background: transparent;
      border-color: #374151;
      color: #4b5563;
      transform: none;
    }

    .upload-btn {
      background: #1e3a5f;
      color: #60a5fa;
      border: 1px solid #2563eb;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: none; /* Hidden - using icon buttons now */
    }

    .remove-btn {
      width: 100%;
      font-size: 12px;
      padding: 6px 10px;
      margin-top: 6px;
      background: #ef4444;
      border-color: #ef4444;
    }

    .remove-btn:hover {
      background: #dc2626;
    }

    input[type="file"].hidden {
      display: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #223044;
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile responsive */
    @media (max-width: 640px) {
      header { padding-bottom: 8px; }
      h1 { font-size: 32px; }
      .header-buttons { width: 100%; justify-content: flex-end; }
      .setting-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="file"] { width: 100%; }
      .employee-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <div>
      <h1 id="tenantTitle">Settings</h1>

      <div class="sub-nav">
        <a href="dashboard-business.html" class="sub-nav-link">Dashboard</a>
        <a href="dashboard-customer-search.html" class="sub-nav-link">Customers</a>
        <a href="dashboard-vehicle-search.html" class="sub-nav-link">Vehicles</a>
        <a href="dashboard-scheduling.html" class="sub-nav-link">Scheduling</a>
      </div>
    </div>

    <div class="header-buttons">
      <button onclick="goToSettings()">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Employee Avatars - MOVED TO TOP -->
  <div class="card">
    <button class="accordion-header active" onclick="toggleAccordion(this)">
      <h2>Employee Profiles</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content active">
      <div class="accordion-inner">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <div class="setting-description">
            Manage employee photos, compensation, and profile information. Click on an employee to view/edit details.
          </div>
          <button onclick="addNewEmployee()" style="white-space:nowrap;">+ Add Employee</button>
        </div>
        <div id="employeeAvatars" class="employee-grid">
          <div style="text-align:center; color:#9fb0c3; padding:20px;">Loading employees...</div>
        </div>
        <div id="avatarMessage"></div>
      </div>
    </div>
  </div>

  <!-- Employee Profile Modal -->
  <div id="employeeModal" class="modal" onclick="if(event.target===this) closeEmployeeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalEmployeeName">Employee Profile</div>
        <button class="modal-close" onclick="closeEmployeeModal()">×</button>
      </div>
      <div id="modalEmployeeBody"></div>
    </div>
  </div>

  <!-- Business Settings -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Business Settings</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="setting-row">
          <div>
            <div class="setting-label">Business Name</div>
            <div class="setting-description">Your company or shop name</div>
          </div>
          <input type="text" id="businessName" placeholder="Business Name" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Name</div>
            <div class="setting-description">Primary contact person name</div>
          </div>
          <input type="text" id="contactName" placeholder="Contact Name" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Email</div>
            <div class="setting-description">Primary contact email for notifications</div>
          </div>
          <input type="email" id="contactEmail" placeholder="email@example.com" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Phone</div>
            <div class="setting-description">Primary contact phone number</div>
          </div>
          <input type="text" id="contactPhone" placeholder="(555) 555-5555" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Labor Rate</div>
            <div class="setting-description">Hourly rate for labor calculations ($/hr)</div>
          </div>
          <input type="number" id="laborRate" min="0" step="1" placeholder="125" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Local Sales Tax</div>
            <div class="setting-description">Sales tax percentage for your area (%)</div>
          </div>
          <input type="number" id="localTax" min="0" max="100" step="0.01" placeholder="8.5" />
        </div>

        <button class="save-btn" onclick="saveSettings()">Save Settings</button>
        <div id="saveMessage"></div>
      </div>
    </div>
  </div>


<!-- Business Info & Branding -->
<div class="card">
  <button class="accordion-header" onclick="toggleAccordion(this)">
    <h2>Business Info & Branding</h2>
    <span class="accordion-icon">▼</span>
  </button>

  <div class="accordion-content">
    <div class="accordion-inner">

      <div class="setting-row">
        <div>
          <div class="setting-label">Business Logo</div>
          <div class="setting-description">
            Upload your company logo (used on invoices and documents)
          </div>
        </div>
        <input type="file" id="businessLogo" accept="image/*" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Business Address</div>
          <div class="setting-description">
            Street address for your shop
          </div>
        </div>
        <input type="text" id="businessStreet" placeholder="123 Main St" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">City</div>
          <div class="setting-description">
            City where your business is located
          </div>
        </div>
        <input type="text" id="businessCity" placeholder="Redding" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">State</div>
          <div class="setting-description">
            Two-letter state code
          </div>
        </div>
        <input type="text" id="businessState" placeholder="CA" maxlength="2" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">ZIP Code</div>
          <div class="setting-description">
            Postal code
          </div>
        </div>
        <input type="text" id="businessZip" placeholder="96001" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Shop Phone</div>
          <div class="setting-description">
            Public phone number for customers
          </div>
        </div>
        <input type="text" id="businessPhone" placeholder="(530) 555-1234" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Website</div>
          <div class="setting-description">
            Optional business website URL
          </div>
        </div>
        <input type="text" id="businessWebsite" placeholder="https://example.com" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Business License Number</div>
          <div class="setting-description">
            Local or state business license
          </div>
        </div>
        <input type="text" id="businessLicense" placeholder="LIC-123456" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Tax ID / EIN</div>
          <div class="setting-description">
            Used for invoices and accounting
          </div>
        </div>
        <input type="text" id="businessEIN" placeholder="12-3456789" />
      </div>

      <button class="save-btn" onclick="saveBusinessBranding()">
        Save Business Info
      </button>

      <div class="muted">
        These settings will be used across invoices, reports, and customer documents.
      </div>

    </div>
  </div>
</div>

<!-- Financial & Pricing Defaults -->
<div class="card">
  <button class="accordion-header" onclick="toggleAccordion(this)">
    <h2>Financial & Pricing Defaults</h2>
    <span class="accordion-icon">▼</span>
  </button>
  <div class="accordion-content">
    <div class="accordion-inner">

      <div class="setting-row">
        <div>
          <div class="setting-label">Default Parts Markup (%)</div>
          <div class="setting-description">Applied automatically to parts pricing</div>
        </div>
        <input type="number" id="partsMarkup" min="0" step="0.1" placeholder="25" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Shop Supply Fee ($)</div>
          <div class="setting-description">Flat fee added per work order</div>
        </div>
        <input type="number" id="shopSupplyFee" min="0" step="0.01" placeholder="9.99" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Environmental Fee ($)</div>
          <div class="setting-description">Optional environmental disposal fee</div>
        </div>
        <input type="number" id="environmentalFee" min="0" step="0.01" placeholder="5.00" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Hazmat Fee ($)</div>
          <div class="setting-description">Hazardous material handling fee</div>
        </div>
        <input type="number" id="hazmatFee" min="0" step="0.01" placeholder="12.00" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Max Discount Allowed (%)</div>
          <div class="setting-description">Maximum discount employees can apply</div>
        </div>
        <input type="number" id="maxDiscount" min="0" max="100" step="1" placeholder="10" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Payment Terms</div>
          <div class="setting-description">Default invoice payment terms</div>
        </div>
        <select id="paymentTerms">
          <option value="due_on_receipt">Due on Receipt</option>
          <option value="net_15">Net 15</option>
          <option value="net_30">Net 30</option>
          <option value="net_45">Net 45</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Currency Format</div>
          <div class="setting-description">Displayed on invoices and totals</div>
        </div>
        <select id="currencyFormat">
          <option value="USD">$ USD</option>
          <option value="EUR">€ EUR</option>
          <option value="GBP">£ GBP</option>
          <option value="CAD">$ CAD</option>
        </select>
      </div>

      <button class="save-btn" onclick="savePricingDefaults()">Save Pricing Defaults</button>
      <div id="pricingSaveMessage"></div>

    </div>
  </div>
</div>

  <!-- Invoicing & Document Settings -->
<div class="card">
  <button class="accordion-header" onclick="toggleAccordion(this)">
    <h2>Invoicing & Documents</h2>
    <span class="accordion-icon">▼</span>
  </button>
  <div class="accordion-content">
    <div class="accordion-inner">

      <div class="setting-row">
        <div>
          <div class="setting-label">Invoice Prefix</div>
          <div class="setting-description">Prefix added to invoice numbers</div>
        </div>
        <input type="text" id="invoicePrefix" placeholder="INV-" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Next Invoice Number</div>
          <div class="setting-description">Starting number for next invoice</div>
        </div>
        <input type="number" id="nextInvoiceNumber" min="1" step="1" placeholder="1001" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Invoice Footer Text</div>
          <div class="setting-description">Displayed at the bottom of invoices</div>
        </div>
        <input type="text" id="invoiceFooter" placeholder="Thank you for your business" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Invoice Logo Position</div>
          <div class="setting-description">Placement of logo on invoices</div>
        </div>
        <select id="invoiceLogoPosition">
          <option value="top_left">Top Left</option>
          <option value="top_center">Top Center</option>
          <option value="top_right">Top Right</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Default Payment Instructions</div>
          <div class="setting-description">Shown on invoices and estimates</div>
        </div>
        <input type="text" id="paymentInstructions" placeholder="Payment due upon receipt" />
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Estimate Validity (Days)</div>
          <div class="setting-description">How long estimates remain valid</div>
        </div>
        <input type="number" id="estimateValidityDays" min="1" step="1" placeholder="30" />
      </div>

      <button class="save-btn" onclick="saveInvoiceSettings()">Save Invoice Settings</button>
      <div id="invoiceSaveMessage"></div>

    </div>
  </div>
</div>

  <!-- Work Order Defaults -->
<div class="card">
  <button class="accordion-header" onclick="toggleAccordion(this)">
    <h2>Work Order Defaults</h2>
    <span class="accordion-icon">▼</span>
  </button>
  <div class="accordion-content">
    <div class="accordion-inner">

      <div class="setting-row">
        <div>
          <div class="setting-label">Default Work Order Status</div>
          <div class="setting-description">Status assigned to new work orders</div>
        </div>
        <select id="defaultWorkOrderStatus">
          <option value="draft">Draft</option>
          <option value="scheduled">Scheduled</option>
          <option value="diagnosis_required">Diagnosis Required</option>
          <option value="awaiting_parts">Awaiting Parts</option>
          <option value="customer_approval">Customer Approval</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Default Priority</div>
          <div class="setting-description">Initial priority for new work orders</div>
        </div>
        <select id="defaultWorkOrderPriority">
          <option value="low">Low</option>
          <option value="normal" selected>Normal</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Require Customer Approval</div>
          <div class="setting-description">Block work until customer approves estimate</div>
        </div>
        <select id="requireCustomerApproval">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Auto-Assign Technician</div>
          <div class="setting-description">Automatically assign based on availability</div>
        </div>
        <select id="autoAssignTechnician">
          <option value="true">Enabled</option>
          <option value="false">Disabled</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Warranty Period (Days)</div>
          <div class="setting-description">Default warranty duration after completion</div>
        </div>
        <input type="number" id="defaultWarrantyDays" min="0" step="1" placeholder="90" />
      </div>

      <button class="save-btn" onclick="saveWorkOrderDefaults()">Save Work Order Defaults</button>
      <div id="workOrderDefaultsMessage"></div>

    </div>
  </div>
</div>

  <!-- Customer Notifications & Portal -->
<div class="card">
  <button class="accordion-header" onclick="toggleAccordion(this)">
    <h2>Customer Notifications & Portal</h2>
    <span class="accordion-icon">▼</span>
  </button>
  <div class="accordion-content">
    <div class="accordion-inner">

      <div class="setting-row">
        <div>
          <div class="setting-label">Customer Portal</div>
          <div class="setting-description">Allow customers to view estimates, invoices, and status</div>
        </div>
        <select id="customerPortalEnabled">
          <option value="true">Enabled</option>
          <option value="false">Disabled</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Auto-Send Estimates</div>
          <div class="setting-description">Email estimates automatically when created</div>
        </div>
        <select id="autoSendEstimates">
          <option value="true">Enabled</option>
          <option value="false">Disabled</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Auto-Send Invoices</div>
          <div class="setting-description">Email invoices automatically when finalized</div>
        </div>
        <select id="autoSendInvoices">
          <option value="true">Enabled</option>
          <option value="false">Disabled</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">SMS Notifications</div>
          <div class="setting-description">Send SMS updates for status changes</div>
        </div>
        <select id="smsNotificationsEnabled">
          <option value="true">Enabled</option>
          <option value="false">Disabled</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Email Notifications</div>
          <div class="setting-description">Send email updates for work order events</div>
        </div>
        <select id="emailNotificationsEnabled">
          <option value="true">Enabled</option>
          <option value="false">Disabled</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Reminder Timing</div>
          <div class="setting-description">Send appointment reminders before scheduled time</div>
        </div>
        <select id="reminderTiming">
          <option value="24">24 hours before</option>
          <option value="12">12 hours before</option>
          <option value="2">2 hours before</option>
          <option value="0">Same day</option>
        </select>
      </div>

      <button class="save-btn" onclick="saveCustomerNotificationSettings()">Save Notification Settings</button>
      <div id="customerNotificationMessage"></div>

    </div>
  </div>
</div>

  
  
  <!-- Account Settings -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Account</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="setting-row">
          <div>
            <div class="setting-label">Logged in as</div>
            <div class="setting-description" id="userEmail">Loading...</div>
          </div>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Account Type</div>
            <div class="setting-description" id="accountType">Standard</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Management -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Data Management</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Export Data</div>
        <div class="setting-description">Download your business data as CSV</div>
      </div>
      <button onclick="exportData()">Export</button>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Clear Cache</div>
        <div class="setting-description">Clear local browser cache and stored data</div>
      </div>
      <button onclick="clearCache()">Clear Cache</button>
    </div>
      </div>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL = `${API_BASE}/storage/v1`;
const REST_BASE = `${API_BASE}/rest/v1`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const RATE_KEY = "wl_labor_rate";
const LOCAL_TAX_KEY = "wl_local_tax";
const BUSINESS_NAME_KEY = "wl_business_name";
const CONTACT_NAME_KEY = "wl_contact_name";
const CONTACT_EMAIL_KEY = "wl_contact_email";
const CONTACT_PHONE_KEY = "wl_contact_phone";

let employees = [];

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function goToSettings(){
  location.reload();
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;

  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
  });
  
  if(!r.ok) return null;
  
  const user = await r.json();
  return { token, user };
}

function loadSettings(){
  const laborRate = localStorage.getItem(RATE_KEY);
  if(laborRate) {
    document.getElementById('laborRate').value = laborRate;
  } else {
    document.getElementById('laborRate').value = 125;
  }

  const localTax = localStorage.getItem(LOCAL_TAX_KEY);
  if(localTax) {
    document.getElementById('localTax').value = localTax;
  }

  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) document.getElementById('businessName').value = businessName;

  const contactName = localStorage.getItem(CONTACT_NAME_KEY);
  if(contactName) document.getElementById('contactName').value = contactName;

  const contactEmail = localStorage.getItem(CONTACT_EMAIL_KEY);
  if(contactEmail) document.getElementById('contactEmail').value = contactEmail;

  const contactPhone = localStorage.getItem(CONTACT_PHONE_KEY);
  if(contactPhone) document.getElementById('contactPhone').value = contactPhone;
}

function saveSettings(){
  const laborRate = document.getElementById('laborRate').value;
  const localTax = document.getElementById('localTax').value;
  const businessName = document.getElementById('businessName').value;
  const contactName = document.getElementById('contactName').value;
  const contactEmail = document.getElementById('contactEmail').value;
  const contactPhone = document.getElementById('contactPhone').value;

  if(laborRate && Number(laborRate) > 0) {
    localStorage.setItem(RATE_KEY, laborRate);
  }

  if(localTax && Number(localTax) >= 0) {
    localStorage.setItem(LOCAL_TAX_KEY, localTax);
  }
  
  if(businessName) localStorage.setItem(BUSINESS_NAME_KEY, businessName);
  if(contactName) localStorage.setItem(CONTACT_NAME_KEY, contactName);
  if(contactEmail) localStorage.setItem(CONTACT_EMAIL_KEY, contactEmail);
  if(contactPhone) localStorage.setItem(CONTACT_PHONE_KEY, contactPhone);

  const msg = document.getElementById('saveMessage');
  msg.className = 'success';
  msg.textContent = '✓ Settings saved successfully!';
  
  setTimeout(() => {
    msg.textContent = '';
  }, 3000);
}

function exportData(){
  alert('Export functionality coming soon! This will allow you to download all your business data as CSV files.');
}

function clearCache(){
  if(confirm('Are you sure you want to clear all cached data? This will not delete your account data.')){
    const token = localStorage.getItem('sb_access_token');
    localStorage.clear();
    if(token) localStorage.setItem('sb_access_token', token);
    
    alert('Cache cleared successfully!');
    location.reload();
  }
}

function initialsFromName(first, last){
  const f = (first || "").trim();
  const l = (last || "").trim();
  if(!f && !l) return "??";
  return ((f[0] || "") + (l[0] || "")).toUpperCase();
}

function getAvatarUrl(employee){
  if(employee.avatar_url) {
    // If it's already a full URL, use it
    if(employee.avatar_url.startsWith('http')) {
      return employee.avatar_url;
    }
    // Otherwise construct the storage URL
    return `${STORAGE_URL}/object/public/avatars/${employee.avatar_url}`;
  }
  return null;
}

function renderEmployees(){
  const container = document.getElementById('employeeAvatars');
  
  if(!employees.length) {
    container.innerHTML = '<div style="text-align:center; color:#9fb0c3; padding:20px;">No employees found.</div>';
    return;
  }

  console.log('Rendering employees:', employees);

  // Define role ranking
  const roleRank = {
    'owner': 1,
    'manager': 2,
    'technician': 3,
    'service_advisor': 4,
    'admin': 5
  };

  // Sort employees by role rank
  const sortedEmployees = [...employees].sort((a, b) => {
    const rankA = roleRank[a.role] || 99;
    const rankB = roleRank[b.role] || 99;
    return rankA - rankB;
  });

  container.innerHTML = sortedEmployees.map(emp => {
    const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
    console.log('Employee:', emp.employee_id, 'Name:', name, 'Metadata:', emp.metadata);
    
    const initials = initialsFromName(emp.first_name, emp.last_name);
    const avatarUrl = getAvatarUrl(emp);
    
    const avatarStyle = avatarUrl 
      ? `background-image: url('${avatarUrl}');` 
      : '';

    const laborRate = emp.hourly_labor_rate || 0;
    
    // Safely parse metadata (could be string or object)
    let metadata = {};
    if (emp.metadata) {
      if (typeof emp.metadata === 'string') {
        try {
          metadata = JSON.parse(emp.metadata);
        } catch {
          metadata = {};
        }
      } else {
        metadata = emp.metadata;
      }
    }
    
    console.log('Parsed metadata:', metadata);
    
    // Calculate years with company (tenure)
    const hireDate = metadata.hire_date ? new Date(metadata.hire_date) : null;
    const yearsWithCompany = hireDate 
      ? ((new Date() - hireDate) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1)
      : null;
    
    // Format birthday
    const birthday = metadata.birthday ? new Date(metadata.birthday).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : null;
    
    // Format hire date
    const hireDateFormatted = hireDate ? hireDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : null;
    
    console.log('Years:', yearsWithCompany, 'Birthday:', birthday);

    return `
      <div class="employee-card">
        <div class="employee-avatar-preview" style="${avatarStyle}" onclick="viewEmployeeProfile('${emp.employee_id}')" title="Click to view/edit profile">
          ${!avatarUrl ? initials : ''}
        </div>
        <div class="employee-name">${name}</div>
        <div class="employee-role">${emp.role || 'Employee'}</div>
        
        <input type="file" 
          id="file-${emp.employee_id}" 
          class="hidden" 
          accept="image/*"
          onchange="handleFileSelect(event, '${emp.employee_id}')" />
        
        <!-- Icon Nav Bar: 3 buttons in a row -->
        <div class="icon-nav-bar">
          <button class="icon-nav-btn icon-nav-primary" onclick="document.getElementById('file-${emp.employee_id}').click()" title="${avatarUrl ? 'Change Photo' : 'Upload Photo'}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </button>
          
          <button class="icon-nav-btn icon-nav-primary" onclick="location.href='employee-edit.html?id=${emp.employee_id}'" title="Edit Profile">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          
          <button class="icon-nav-btn icon-nav-danger" onclick="confirmDeleteEmployee('${emp.employee_id}', '${name}')" title="Delete Employee">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </button>
        </div>

        <div class="employee-stats">
          <div class="stat-row">
            <span class="stat-label">Labor Rate</span>
            <span class="stat-value">$${laborRate}/hr</span>
          </div>
          ${hireDateFormatted ? `
            <div class="stat-row">
              <span class="stat-label">Hire Date</span>
              <span class="stat-value">${hireDateFormatted}</span>
            </div>
          ` : ''}
          ${yearsWithCompany ? `
            <div class="stat-row">
              <span class="stat-label">Tenure</span>
              <span class="stat-value">${yearsWithCompany} yrs</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function confirmDeleteEmployee(employeeId, name) {
  if(confirm(`Are you sure you want to delete ${name}? This action cannot be undone.`)) {
    deleteEmployeeFromCard(employeeId);
  }
}

async function deleteEmployeeFromCard(employeeId) {
  const token = localStorage.getItem('sb_access_token');
  if(!token) {
    showAvatarMessage('Not authenticated', 'error');
    return;
  }

  try {
    showAvatarMessage('Deleting employee...', 'muted');
    console.log('Deleting employee:', employeeId);

    // Find employee
    const emp = employees.find(e => e.employee_id === employeeId);
    console.log('Employee to delete:', emp);

    // Delete avatar if exists
    if(emp && emp.avatar_url) {
      console.log('Deleting avatar:', emp.avatar_url);
      const avatarResp = await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'apikey': ANON_KEY
        }
      });
      console.log('Avatar delete response:', avatarResp.status);
    }

    // Delete employee from database
    console.log('Deleting from database...');
    const response = await fetch(`${API_BASE}/rest/v1/employees?employee_id=eq.${employeeId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    console.log('Delete response:', response.status, response.statusText);

    if(!response.ok) {
      const errorText = await response.text();
      console.error('Delete failed:', errorText);
      throw new Error(`Failed to delete employee: ${response.status} ${errorText}`);
    }

    showAvatarMessage('Employee deleted successfully!', 'success');
    
    // Reload employee list
    await loadEmployees();

  } catch(err) {
    console.error('Delete employee error:', err);
    showAvatarMessage('Error: ' + err.message, 'error');
  }
}

function getInitialsFromFullName(fullName) {
  if (!fullName) return '?';
  const parts = fullName.trim().split(' ');
  if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
  return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}

async function handleFileSelect(event, employeeId){
  const file = event.target.files[0];
  if(!file) return;

  // Validate file type
  if(!file.type.startsWith('image/')) {
    showAvatarMessage('Please select an image file.', 'error');
    return;
  }

  // Validate file size (5MB max)
  if(file.size > 5 * 1024 * 1024) {
    showAvatarMessage('Image must be less than 5MB.', 'error');
    return;
  }

  await uploadAvatar(employeeId, file);
}

async function uploadAvatar(employeeId, file){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    showAvatarMessage('Uploading photo...', 'muted');

    // Create unique filename
    const fileExt = file.name.split('.').pop();
    const fileName = `${employeeId}-${Date.now()}.${fileExt}`;
    const filePath = fileName;

    // Upload to Supabase Storage
    const uploadResponse = await fetch(`${STORAGE_URL}/object/avatars/${filePath}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY,
        'Content-Type': file.type
      },
      body: file
    });

    if(!uploadResponse.ok) {
      const error = await uploadResponse.text();
      throw new Error(`Upload failed: ${error}`);
    }

    // Update employee record with avatar URL
    const updateResponse = await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify({ avatar_url: filePath })
    });

    if(!updateResponse.ok) {
      throw new Error('Failed to update employee record');
    }

    // Update local employee data
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp) emp.avatar_url = filePath;

    showAvatarMessage('Photo uploaded successfully!', 'success');
    renderEmployees();

  } catch(err) {
    console.error('Upload error:', err);
    showAvatarMessage('Error uploading photo: ' + err.message, 'error');
  }
}

async function removeAvatar(employeeId){
  if(!confirm('Are you sure you want to remove this photo?')) return;

  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    const emp = employees.find(e => e.employee_id === employeeId);
    if(!emp || !emp.avatar_url) return;

    // Delete from storage
    await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    // Update employee record
    await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify({ avatar_url: null })
    });

    // Update local data
    emp.avatar_url = null;

    showAvatarMessage('Photo removed successfully!', 'success');
    renderEmployees();

  } catch(err) {
    console.error('Remove error:', err);
    showAvatarMessage('Error removing photo: ' + err.message, 'error');
  }
}

function showAvatarMessage(msg, type = 'success'){
  const area = document.getElementById('avatarMessage');
  area.innerHTML = `<div class="${type}" style="margin-top:12px;">${msg}</div>`;
  setTimeout(() => { area.innerHTML = ''; }, 5000);
}

async function loadEmployees(){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    const [empResponse, userData] = await Promise.all([
      fetch(`${API_BASE}/rest/v1/employees?select=*`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'apikey': ANON_KEY
        }
      }),
      fetch(`${API_BASE}/auth/v1/user`, {
        headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
      }).then(r => r.json())
    ]);

    if(!empResponse.ok) throw new Error('Failed to load employees');

    let allEmployees = await empResponse.json();
    console.log('Raw employees from API:', allEmployees);
    
    // Filter out test/placeholder employees but keep real ones
    employees = allEmployees.filter(emp => {
      const firstName = (emp.first_name || '').trim();
      const lastName = (emp.last_name || '').trim();
      
      // Exclude if first_name contains @ (email addresses)
      if (firstName.includes('@')) return false;
      
      // Exclude specific test patterns where BOTH match the pattern
      const testPatterns = [
        { first: ['Alex', 'Mark', 'Evan', 'Pat', 'Loren', 'Eddie', 'Casey', 'Joey', 'Wes', 'Sam', 'Kyle', 'Roger'], last: ['Tech1', 'Tech2', 'Tech3'] },
        { first: ['Jade', 'Dana', 'Riley', 'Morgan', 'Maria'], last: ['Parts'] },
        { first: ['Chris', 'Jordan', 'Taylor', 'Kelly', 'Lee'], last: ['Manager'] },
        { first: ['North', 'Rapid', 'Midtown', 'Sierra'], last: ['Owner'] }
      ];
      
      for (const pattern of testPatterns) {
        if (pattern.first.includes(firstName) && pattern.last.includes(lastName)) {
          return false; // Exclude this test employee
        }
      }
      
      // Keep all others (real employees)
      return true;
    });
    
    console.log('All employees:', allEmployees.length);
    console.log('Filtered employees:', employees.length, employees);

    // Store current user's employee record for permission checks
    // Check against user_id (not email) and use ALL employees (not filtered)
    window.currentUserEmployee = allEmployees.find(e => e.user_id === userData.id);
    console.log('Current user employee record:', window.currentUserEmployee);

    renderEmployees();

  } catch(err) {
    console.error('Load employees error:', err);
    showAvatarMessage('Error loading employees: ' + err.message, 'error');
  }
}

function showEmployeeMessage(msg, type = 'success'){
  const area = document.getElementById('employeeMessage');
  area.innerHTML = `<div class="${type}" style="margin-top:12px;">${msg}</div>`;
  setTimeout(() => { area.innerHTML = ''; }, 5000);
}

function viewEmployeeProfile(employeeId){
  const emp = employees.find(e => e.employee_id === employeeId);
  if(!emp) return;

  const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
  document.getElementById('modalEmployeeName').textContent = name;

  // Get current user role
  const currentUser = window.currentUserEmployee;
  const canEdit = currentUser && (currentUser.role === 'owner' || currentUser.role === 'manager');
  
  console.log('Current user:', currentUser);
  console.log('Can edit:', canEdit);

  const laborRate = emp.hourly_labor_rate || 0;
  const metadata = emp.metadata || {};
  
  // Parse certifications
  const certifications = metadata.certifications || [];
  const certificationsText = Array.isArray(certifications) ? certifications.join('\n') : '';
  
  const hireDate = metadata.hire_date || '';

  const modalBody = document.getElementById('modalEmployeeBody');

  if(canEdit) {
    // Editable form for owners/managers
    modalBody.innerHTML = `
      <form id="employeeProfileForm">
        <div class="modal-section">
          <div class="modal-section-title">Personal Information</div>
          <div class="modal-info-row">
            <span class="modal-label">First Name *</span>
            <input type="text" class="modal-input" id="editFirstName" value="${emp.first_name || ''}" required />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Last Name *</span>
            <input type="text" class="modal-input" id="editLastName" value="${emp.last_name || ''}" required />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Email</span>
            <input type="email" class="modal-input" id="editEmail" value="${metadata.email || ''}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Phone</span>
            <input type="tel" class="modal-input" id="editPhone" value="${metadata.phone || ''}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Street</span>
            <input type="text" class="modal-input" id="editStreet" value="${metadata.street || ''}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">City</span>
            <input type="text" class="modal-input" id="editCity" value="${metadata.city || ''}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">State</span>
            <input type="text" class="modal-input" id="editState" value="${metadata.state || ''}" maxlength="2" style="text-transform: uppercase;" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">ZIP</span>
            <input type="text" class="modal-input" id="editZip" value="${metadata.zip || ''}" maxlength="10" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Birthday</span>
            <input type="date" class="modal-input" id="editBirthday" value="${metadata.birthday || ''}" />
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Employment Details</div>
          <div class="modal-info-row">
            <span class="modal-label">Role *</span>
            <select class="modal-select" id="editRole" required>
              <option value="owner" ${emp.role === 'owner' ? 'selected' : ''}>Owner</option>
              <option value="manager" ${emp.role === 'manager' ? 'selected' : ''}>Manager</option>
              <option value="technician" ${emp.role === 'technician' ? 'selected' : ''}>Technician</option>
              <option value="service_advisor" ${emp.role === 'service_advisor' ? 'selected' : ''}>Service Advisor</option>
              <option value="admin" ${emp.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Hourly Labor Rate ($)</span>
            <input type="number" class="modal-input" id="editLaborRate" value="${laborRate}" step="0.01" min="0" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Hire Date</span>
            <input type="date" class="modal-input" id="editHireDate" value="${hireDate}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Status</span>
            <select class="modal-select" id="editStatus">
              <option value="true" ${emp.is_active ? 'selected' : ''}>Active</option>
              <option value="false" ${!emp.is_active ? 'selected' : ''}>Inactive</option>
            </select>
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Certifications & Notes</div>
          <div class="modal-info-row">
            <span class="modal-label">Certifications</span>
            <textarea class="modal-textarea" id="editCertifications" rows="3">${certificationsText}</textarea>
            <div class="muted" style="margin-top:4px;">Enter one certification per line</div>
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Notes</span>
            <textarea class="modal-textarea" id="editNotes" rows="3">${metadata.notes || ''}</textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="modal-delete-btn" onclick="deleteEmployeeFromModal('${emp.employee_id}')">Delete</button>
          <button type="button" onclick="closeEmployeeModal()">Cancel</button>
          <button type="submit" class="modal-save-btn">Save Changes</button>
        </div>
      </form>
    `;

    document.getElementById('employeeProfileForm').addEventListener('submit', (e) => {
      e.preventDefault();
      saveEmployeeProfile(emp.employee_id);
    });

  } else {
    // Read-only view for non-managers
    const yearsWithCompany = hireDate ? 
      ((new Date() - new Date(hireDate)) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1) : 'N/A';

    const certificationsHtml = certifications.length > 0
      ? `<ul class="accomplishments-list">${certifications.map(c => `<li>${c}</li>`).join('')}</ul>`
      : '<div style="color:#9fb0c3; font-size:13px;">No certifications recorded</div>';

    modalBody.innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">Personal Information</div>
        <div class="modal-info-row">
          <span class="modal-label">Name</span>
          <span class="modal-value">${name}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Email</span>
          <span class="modal-value">${metadata.email || 'Not set'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Phone</span>
          <span class="modal-value">${metadata.phone || 'Not set'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Street</span>
          <span class="modal-value">${metadata.street || 'Not set'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">City, State ZIP</span>
          <span class="modal-value">${[metadata.city, metadata.state, metadata.zip].filter(Boolean).join(', ') || 'Not set'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Birthday</span>
          <span class="modal-value">${metadata.birthday ? new Date(metadata.birthday).toLocaleDateString() : 'Not set'}</span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Employment Details</div>
        <div class="modal-info-row">
          <span class="modal-label">Role</span>
          <span class="modal-value">${emp.role || 'Employee'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Hourly Labor Rate</span>
          <span class="modal-value">$${laborRate}/hr</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Hire Date</span>
          <span class="modal-value">${hireDate ? new Date(hireDate).toLocaleDateString() : 'Not set'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Years with Company</span>
          <span class="modal-value">${yearsWithCompany} years</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Status</span>
          <span class="modal-value">${emp.is_active ? 'Active' : 'Inactive'}</span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Certifications</div>
        ${certificationsHtml}
      </div>

      ${metadata.notes ? `
        <div class="modal-section">
          <div class="modal-section-title">Notes</div>
          <div style="color:#e8eef6; font-size:13px; line-height:1.6;">${metadata.notes}</div>
        </div>
      ` : ''}

      <div class="modal-footer">
        <button onclick="closeEmployeeModal()">Close</button>
      </div>
    `;
  }

  document.getElementById('employeeModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function editEmployee(employeeId){
  window.location.href = `employee-edit.html?id=${employeeId}`;
}

function addNewEmployee(){
  // Set modal for new employee mode
  document.getElementById('modalEmployeeName').textContent = 'Add New Employee';
  
  const modalBody = document.getElementById('modalEmployeeBody');
  modalBody.innerHTML = `
    <form id="newEmployeeForm">
      <div class="modal-section">
        <div class="modal-section-title">Personal Information</div>
        <div class="modal-info-row">
          <span class="modal-label">First Name *</span>
          <input type="text" class="modal-input" id="newFirstName" required />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Last Name *</span>
          <input type="text" class="modal-input" id="newLastName" required />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Email</span>
          <input type="email" class="modal-input" id="newEmail" placeholder="employee@example.com" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Phone</span>
          <input type="tel" class="modal-input" id="newPhone" placeholder="(555) 123-4567" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Street</span>
          <input type="text" class="modal-input" id="newStreet" placeholder="123 Main Street" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">City</span>
          <input type="text" class="modal-input" id="newCity" placeholder="San Francisco" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">State</span>
          <input type="text" class="modal-input" id="newState" placeholder="CA" maxlength="2" style="text-transform: uppercase;" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">ZIP</span>
          <input type="text" class="modal-input" id="newZip" placeholder="94102" maxlength="10" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Birthday</span>
          <input type="date" class="modal-input" id="newBirthday" />
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Employment Details</div>
        <div class="modal-info-row">
          <span class="modal-label">Role *</span>
          <select class="modal-select" id="newRole" required>
            <option value="">Select role...</option>
            <option value="owner">Owner</option>
            <option value="manager">Manager</option>
            <option value="technician">Technician</option>
            <option value="service_advisor">Service Advisor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Hourly Labor Rate ($)</span>
          <input type="number" class="modal-input" id="newLaborRate" placeholder="42.00" step="0.01" min="0" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Hire Date</span>
          <input type="date" class="modal-input" id="newHireDate" />
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Status</span>
          <select class="modal-select" id="newStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Certifications & Notes</div>
        <div class="modal-info-row">
          <span class="modal-label">Certifications</span>
          <textarea class="modal-textarea" id="newCertifications" placeholder="ASE Master Certified&#10;EPA 609 Certified&#10;State Inspection License" rows="3"></textarea>
          <div class="muted" style="margin-top:4px;">Enter one certification per line</div>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Notes</span>
          <textarea class="modal-textarea" id="newNotes" placeholder="Additional notes about this employee..." rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" onclick="closeEmployeeModal()">Cancel</button>
        <button type="submit" class="modal-save-btn">Add Employee</button>
      </div>
    </form>
  `;

  document.getElementById('newEmployeeForm').addEventListener('submit', handleNewEmployeeSubmit);
  document.getElementById('employeeModal').classList.add('active');
  document.body.style.overflow = 'hidden'; // Prevent background scroll
}

async function handleNewEmployeeSubmit(e){
  e.preventDefault();
  
  const token = localStorage.getItem('sb_access_token');
  if(!token) {
    showAvatarMessage('Not authenticated', 'error');
    return;
  }

  try {
    // Get current user to extract tenant_id and user_id
    const userResponse = await fetch(`${API_BASE}/auth/v1/user`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    if(!userResponse.ok) {
      throw new Error('Failed to get user info');
    }

    const userData = await userResponse.json();
    
    // Collect additional data for metadata
    const certifications = document.getElementById('newCertifications').value
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0);

    const metadata = {
      email: document.getElementById('newEmail').value.trim() || null,
      phone: document.getElementById('newPhone').value.trim() || null,
      street: document.getElementById('newStreet').value.trim() || null,
      city: document.getElementById('newCity').value.trim() || null,
      state: document.getElementById('newState').value.trim().toUpperCase() || null,
      zip: document.getElementById('newZip').value.trim() || null,
      birthday: document.getElementById('newBirthday').value || null,
      hire_date: document.getElementById('newHireDate').value || null,
      certifications: certifications.length > 0 ? certifications : null,
      notes: document.getElementById('newNotes').value.trim() || null
    };

    // Build employee data with required fields
    const formData = {
      first_name: document.getElementById('newFirstName').value.trim(),
      last_name: document.getElementById('newLastName').value.trim(),
      role: document.getElementById('newRole').value,
      user_id: userData.id,
      tenant_id: userData.user_metadata?.tenant_id || userData.id,
      is_active: document.getElementById('newStatus').value === 'true',
      metadata: metadata
    };

    const laborRate = document.getElementById('newLaborRate').value;
    if(laborRate && parseFloat(laborRate) > 0) {
      formData.hourly_labor_rate = parseFloat(laborRate);
    }

    console.log('Creating employee with data:', formData);
    showAvatarMessage('Adding employee...', 'muted');

    const response = await fetch(`${API_BASE}/rest/v1/employees`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(formData)
    });

    if(!response.ok) {
      const errorText = await response.text();
      console.error('Employee creation failed:', response.status, errorText);
      
      let errorMessage = 'Failed to create employee';
      try {
        const errorJson = JSON.parse(errorText);
        errorMessage = errorJson.message || errorJson.hint || errorJson.details || errorText;
      } catch {
        errorMessage = errorText;
      }
      
      throw new Error(errorMessage);
    }

    const newEmployee = await response.json();
    console.log('Employee created successfully:', newEmployee);

    showAvatarMessage('Employee added successfully!', 'success');
    closeEmployeeModal();
    await loadEmployees();

  } catch(err) {
    console.error('Add employee error:', err);
    showAvatarMessage('Error adding employee: ' + err.message, 'error');
  }
}

async function saveEmployeeProfile(employeeId){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    // Collect certifications
    const certifications = document.getElementById('editCertifications').value
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0);

    // Build metadata object
    const metadata = {
      email: document.getElementById('editEmail').value.trim() || null,
      phone: document.getElementById('editPhone').value.trim() || null,
      street: document.getElementById('editStreet').value.trim() || null,
      city: document.getElementById('editCity').value.trim() || null,
      state: document.getElementById('editState').value.trim().toUpperCase() || null,
      zip: document.getElementById('editZip').value.trim() || null,
      birthday: document.getElementById('editBirthday').value || null,
      hire_date: document.getElementById('editHireDate').value || null,
      certifications: certifications.length > 0 ? certifications : null,
      notes: document.getElementById('editNotes').value.trim() || null
    };

    const updateData = {
      first_name: document.getElementById('editFirstName').value.trim(),
      last_name: document.getElementById('editLastName').value.trim(),
      role: document.getElementById('editRole').value,
      is_active: document.getElementById('editStatus').value === 'true',
      metadata: metadata
    };

    const laborRate = document.getElementById('editLaborRate').value;
    if(laborRate && parseFloat(laborRate) >= 0) {
      updateData.hourly_labor_rate = parseFloat(laborRate);
    }

    showAvatarMessage('Saving changes...', 'muted');

    const response = await fetch(`${API_BASE}/rest/v1/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(updateData)
    });

    if(!response.ok) {
      const errorText = await response.text();
      console.error('Update failed:', errorText);
      throw new Error('Failed to save employee profile');
    }

    // Update local data
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp) {
      Object.assign(emp, updateData);
    }

    showAvatarMessage('Profile updated successfully!', 'success');
    closeEmployeeModal();
    renderEmployees();

  } catch(err) {
    console.error('Save error:', err);
    showAvatarMessage('Error saving profile: ' + err.message, 'error');
  }
}

async function deleteEmployeeFromModal(employeeId){
  if(!confirm('Are you sure you want to delete this employee? This action cannot be undone.')) return;

  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    showAvatarMessage('Deleting employee...', 'muted');

    // Delete avatar if exists
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp && emp.avatar_url) {
      await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'apikey': ANON_KEY
        }
      });
    }

    // Delete employee using REST API
    const response = await fetch(`${API_BASE}/rest/v1/employees?employee_id=eq.${employeeId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    if(!response.ok) {
      throw new Error('Failed to delete employee');
    }

    showAvatarMessage('Employee deleted successfully!', 'success');
    closeEmployeeModal();
    
    // Reload employees
    await loadEmployees();

  } catch(err) {
    console.error('Delete employee error:', err);
    showAvatarMessage('Error deleting employee: ' + err.message, 'error');
  }
}

function toggleAccordion(button){
  const content = button.nextElementSibling;
  button.classList.toggle('active');
  content.classList.toggle('active');
}

function closeEmployeeModal(){
  const modalBody = document.getElementById('modalEmployeeBody');
  modalBody.dataset.editMode = 'false';
  document.getElementById('employeeModal').classList.remove('active');
  document.body.style.overflow = ''; // Re-enable body scroll
}

async function load(){
  const auth = await validateAuth();
  if(!auth) return location.replace("login.html");

  if(auth.user && auth.user.email) {
    document.getElementById('userEmail').textContent = auth.user.email;
  }

  // Load employees and settings
  await loadEmployees();
  loadSettings();

  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) {
    document.getElementById('tenantTitle').textContent = businessName + ' - Settings';
    document.title = businessName + ' - Settings';
  }
}

load();
</script>
</body>
</html>
