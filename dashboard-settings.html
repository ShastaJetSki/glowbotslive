<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
/* ================= BASE ================= */
body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }
.appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
h1 { margin:0; font-size:40px; }
h2 { margin:18px 0 10px; font-size:18px; }

/* ================= NAV ================= */
.sub-nav { display:flex; gap:16px; margin-top:8px; padding-bottom:10px; border-bottom:1px solid #1f2937; }
.sub-nav-link { font-size:14px; color:#9ca3af; text-decoration:none; }
.sub-nav-link.active { color:#38bdf8; font-weight:500; }

/* ================= CARDS ================= */
.card { background:#0f1621; border:1px solid #223044; border-radius:14px; padding:20px; margin-bottom:16px; }

/* ================= EMPLOYEES ================= */
.employee-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:16px;
}

.employee-card {
  background:#0b0f14;
  border:1px solid #223044;
  border-radius:12px;
  padding:16px;
  text-align:center;
}

.employee-avatar-preview {
  width:96px;
  height:96px;
  margin:0 auto 10px;
  border-radius:10px;
  border:2px solid #223044;
  background:#0f1621;
  background-size:cover;
  background-position:center;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  font-weight:700;
  cursor:pointer;
}

/* ================= ICON BUTTONS (ONLY CHANGE) ================= */

/* Smaller squares */
.icon-btn {
  width:100%;
  min-height:34px;
  max-height:38px;
  aspect-ratio:1;
  border-radius:6px;
  border:1px solid;
  background:transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all .15s ease;
}

.icon-btn svg {
  width:16px;
  height:16px;
}

/* Button variants */
.icon-btn-primary { border-color:#3b82f6; color:#3b82f6; }
.icon-btn-danger { border-color:#6b7280; color:#6b7280; }
.icon-btn-disabled { border-color:#374151; color:#4b5563; cursor:not-allowed; }

/* Wrapper + label */
.icon-btn-wrap {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}

.icon-btn-label {
  font-size:11px;
  color:#9fb0c3;
  user-select:none;
}

/* ================= MODAL ================= */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:999; align-items:center; justify-content:center; }
.modal.active { display:flex; }
.modal-content {
  background:#0f1621;
  border:1px solid #223044;
  border-radius:14px;
  padding:24px;
  width:100%;
  max-width:720px;
  max-height:85vh;
  overflow-y:auto;
}

/* ================= MOBILE ================= */
@media(max-width:640px){
  h1{font-size:32px}
  .employee-grid{grid-template-columns:1fr}
}
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<header>
  <div>
    <h1 id="tenantTitle">Settings</h1>
    <div class="sub-nav">
      <a class="sub-nav-link" href="dashboard-business.html">Dashboard</a>
      <a class="sub-nav-link" href="dashboard-customer-search.html">Customers</a>
      <a class="sub-nav-link" href="dashboard-vehicle-search.html">Vehicles</a>
      <a class="sub-nav-link" href="dashboard-scheduling.html">Scheduling</a>
    </div>
  </div>
  <div>
    <button onclick="location.reload()">Settings</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<!-- EMPLOYEES -->
<div class="card">
<h2>Employee Profiles</h2>
<div id="employeeAvatars" class="employee-grid"></div>
</div>

<!-- MODAL -->
<div id="employeeModal" class="modal" onclick="if(event.target===this)closeEmployeeModal()">
<div class="modal-content">
<h2 id="modalEmployeeName"></h2>
<div id="modalEmployeeBody"></div>
</div>
</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API=`https://${PROJECT_REF}.supabase.co`;
const STORAGE=`${API}/storage/v1/object/public/avatars`;
const FUNCTIONS=`${API}/functions/v1`;
const ANON=document.querySelector('meta[name="supabase-anon-key"]').content;

let employees=[];

function logout(){
  localStorage.removeItem("sb_access_token");
  location.href="login.html";
}

function initials(f,l){
  return ((f?.[0]||'')+(l?.[0]||'')).toUpperCase()||"??";
}

function avatar(emp){
  return emp.avatar_url ? `${STORAGE}/${emp.avatar_url}` : null;
}

function renderEmployees(){
  const c=document.getElementById("employeeAvatars");
  c.innerHTML=employees.map(emp=>{
    const img=avatar(emp);
    return `
<div class="employee-card">
  <div class="employee-avatar-preview" style="${img?`background-image:url('${img}')`:''}" onclick="viewEmployee('${emp.employee_id}')">
    ${!img?initials(emp.first_name,emp.last_name):''}
  </div>
  <div><strong>${emp.first_name} ${emp.last_name}</strong></div>
  <div style="font-size:11px;color:#9fb0c3">${emp.role}</div>

  <input type="file" id="file-${emp.employee_id}" hidden accept="image/*"
    onchange="uploadAvatar('${emp.employee_id}',this.files[0])"/>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">

    <div class="icon-btn-wrap">
      <button class="icon-btn icon-btn-primary" onclick="document.getElementById('file-${emp.employee_id}').click()">
        ‚¨ÜÔ∏è
      </button>
      <div class="icon-btn-label">${img?'Change':'Upload'}</div>
    </div>

    <div class="icon-btn-wrap">
      <button class="icon-btn ${img?'icon-btn-danger':'icon-btn-disabled'}" ${img?'onclick="removeAvatar(\\''+emp.employee_id+'\\')"':'disabled'}>
        üóë
      </button>
      <div class="icon-btn-label">Remove</div>
    </div>

    <div class="icon-btn-wrap">
      <button class="icon-btn icon-btn-primary" onclick="viewEmployee('${emp.employee_id}')">‚úèÔ∏è</button>
      <div class="icon-btn-label">Edit</div>
    </div>

    <div class="icon-btn-wrap">
      <button class="icon-btn icon-btn-danger" onclick="deleteEmployee('${emp.employee_id}')">‚ùå</button>
      <div class="icon-btn-label">Delete</div>
    </div>

  </div>
</div>`;
  }).join('');
}

async function loadEmployees(){
  const t=localStorage.getItem("sb_access_token");
  const r=await fetch(`${FUNCTIONS}/employees`,{
    headers:{Authorization:`Bearer ${t}`,apikey:ANON}
  });
  employees=await r.json();
  renderEmployees();
}

function viewEmployee(id){
  const e=employees.find(x=>x.employee_id===id);
  document.getElementById("modalEmployeeName").textContent=`${e.first_name} ${e.last_name}`;
  document.getElementById("modalEmployeeBody").innerHTML=`<pre>${JSON.stringify(e,null,2)}</pre>`;
  document.getElementById("employeeModal").classList.add("active");
}

function closeEmployeeModal(){
  document.getElementById("employeeModal").classList.remove("active");
}

async function uploadAvatar(id,file){
  if(!file)return;
  const t=localStorage.getItem("sb_access_token");
  const name=`${id}-${Date.now()}.${file.name.split('.').pop()}`;
  await fetch(`${STORAGE.replace('/public','')}/avatars/${name}`,{
    method:"POST",
    headers:{Authorization:`Bearer ${t}`,apikey:ANON,"Content-Type":file.type},
    body:file
  });
  await fetch(`${API}/rest/v1/employees?employee_id=eq.${id}`,{
    method:"PATCH",
    headers:{Authorization:`Bearer ${t}`,apikey:ANON,"Content-Type":"application/json"},
    body:JSON.stringify({avatar_url:name})
  });
  loadEmployees();
}

async function removeAvatar(id){
  const e=employees.find(x=>x.employee_id===id);
  if(!e.avatar_url)return;
  const t=localStorage.getItem("sb_access_token");
  await fetch(`${STORAGE.replace('/public','')}/avatars/${e.avatar_url}`,{
    method:"DELETE",
    headers:{Authorization:`Bearer ${t}`,apikey:ANON}
  });
  await fetch(`${API}/rest/v1/employees?employee_id=eq.${id}`,{
    method:"PATCH",
    headers:{Authorization:`Bearer ${t}`,apikey:ANON,"Content-Type":"application/json"},
    body:JSON.stringify({avatar_url:null})
  });
  loadEmployees();
}

async function deleteEmployee(id){
  if(!confirm("Delete employee?"))return;
  const t=localStorage.getItem("sb_access_token");
  await fetch(`${API}/rest/v1/employees?employee_id=eq.${id}`,{
    method:"DELETE",
    headers:{Authorization:`Bearer ${t}`,apikey:ANON}
  });
  loadEmployees();
}

loadEmployees();
</script>
</body>
</html>
