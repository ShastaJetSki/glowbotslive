<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }

    /* pin app name top-right */
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }

    /* Updated sub-nav under title */
    .sub-nav {
      display:flex;
      gap:16px;
      margin: 8px 0 0;
      padding-bottom:10px;
      border-bottom:1px solid #1f2937;
      flex-wrap:wrap;
    }
    .sub-nav-link {
      font-size:14px;
      color:#9ca3af;
      text-decoration:none;
      padding:4px 2px;
      position:relative;
    }
    .sub-nav-link:hover { color:#e5e7eb; }
    .sub-nav-link.active { color:#38bdf8; font-weight:500; }
    .sub-nav-link.active::after {
      content:"";
      position:absolute;
      left:0;
      bottom:-11px;
      width:100%;
      height:2px;
      background:#38bdf8;
      border-radius:2px;
    }

    /* Button group for Settings and Logout */
    .header-buttons {
      display:flex;
      gap:8px;
      align-items:center;
    }

    button {
      padding:8px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:#243648; }

    .card {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:14px;
      padding:20px;
      margin-bottom:16px;
    }

    .setting-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #223044;
    }

    .setting-row:last-child {
      border-bottom:none;
    }

    .setting-label {
      font-size:14px;
      font-weight:500;
    }

    .setting-description {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="file"] {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #223044;
      background:#0b0f14;
      color:#e8eef6;
      width:200px;
    }

    input[type="file"] {
      padding:6px 12px;
      font-size:12px;
    }

    input:focus {
      outline:none;
      border-color:#3b82f6;
    }

    .save-btn {
      background:#3b82f6;
      border-color:#3b82f6;
      margin-top:16px;
    }

    .save-btn:hover {
      background:#2563eb;
    }

    .muted {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    .success {
      color:#4ade80;
      font-size:12px;
      margin-top:8px;
    }

    .error {
      color:#ef4444;
      font-size:12px;
      margin-top:8px;
    }

    /* Employee Avatar Styles */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .employee-card {
      background: #0b0f14;
      border: 1px solid #223044;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .employee-avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      border: 2px solid #223044;
      background: #0f1621;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      color: #e8eef6;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .download-avatar-btn {
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 28px;
      height: 28px;
      padding: 0;
      background: #1a2535;
      border: 1px solid #3b82f6;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
    }

    .download-avatar-btn:hover {
      background: #3b82f6;
    }

    .employee-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .employee-role {
      font-size: 11px;
      color: #9fb0c3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .schedule-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #223044;
      text-align: left;
    }

    .schedule-title {
      font-size: 11px;
      font-weight: 600;
      color: #9fb0c3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .schedule-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .schedule-day {
      color: #e8eef6;
    }

    .schedule-time {
      color: #9fb0c3;
      font-size: 11px;
    }

    .schedule-input {
      width: 80px;
      padding: 4px 6px;
      font-size: 11px;
      background: #0f1621;
      border: 1px solid #223044;
      border-radius: 4px;
      color: #e8eef6;
    }

    .schedule-input:focus {
      border-color: #3b82f6;
      outline: none;
    }

    .save-schedule-btn {
      width: 100%;
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 11px;
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .save-schedule-btn:hover {
      background: #2563eb;
    }

    .upload-btn {
      width: 100%;
      font-size: 12px;
      padding: 6px 10px;
    }

    .remove-btn {
      width: 100%;
      font-size: 12px;
      padding: 6px 10px;
      margin-top: 6px;
      background: #ef4444;
      border-color: #ef4444;
    }

    .remove-btn:hover {
      background: #dc2626;
    }

    input[type="file"].hidden {
      display: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #223044;
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .employee-list-item {
      background: #0b0f14;
      border: 1px solid #223044;
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .employee-info {
      flex: 1;
      min-width: 0;
    }

    .employee-info-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .employee-info-details {
      font-size: 12px;
      color: #9fb0c3;
    }

    .employee-actions {
      display: flex;
      gap: 6px;
    }

    .delete-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: #ef4444;
      border-color: #ef4444;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    /* Mobile responsive */
    @media (max-width: 640px) {
      header { padding-bottom: 8px; }
      h1 { font-size: 32px; }
      .header-buttons { width: 100%; justify-content: flex-end; }
      .setting-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="file"] { width: 100%; }
      .employee-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <div>
      <h1 id="tenantTitle">Settings</h1>

      <div class="sub-nav">
        <a href="dashboard-business.html" class="sub-nav-link">Dashboard</a>
        <a href="dashboard-customer-search.html" class="sub-nav-link">Customers</a>
        <a href="dashboard-vehicle-search.html" class="sub-nav-link">Vehicles</a>
        <a href="dashboard-scheduling.html" class="sub-nav-link">Scheduling</a>
      </div>
    </div>

    <div class="header-buttons">
      <button onclick="goToSettings()">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Employee Avatars - MOVED TO TOP -->
  <div class="card">
    <h2>Employee Avatars & Scheduling</h2>
    <div class="setting-description" style="margin-bottom:16px;">
      Upload profile photos and manage work schedules for your technicians.
    </div>
    <div id="employeeAvatars" class="employee-grid">
      <div style="text-align:center; color:#9fb0c3; padding:20px;">Loading employees...</div>
    </div>
    <div id="avatarMessage"></div>
  </div>

  <!-- Business Settings -->
  <div class="card">
    <h2>Business Settings</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Labor Rate</div>
        <div class="setting-description">Hourly rate for labor calculations ($/hr)</div>
      </div>
      <input type="number" id="laborRate" min="0" step="1" placeholder="125" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Business Name</div>
        <div class="setting-description">Your company or shop name</div>
      </div>
      <input type="text" id="businessName" placeholder="Business Name" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Contact Email</div>
        <div class="setting-description">Primary contact email for notifications</div>
      </div>
      <input type="email" id="contactEmail" placeholder="email@example.com" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Contact Phone</div>
        <div class="setting-description">Primary contact phone number</div>
      </div>
      <input type="text" id="contactPhone" placeholder="(555) 555-5555" />
    </div>

    <button class="save-btn" onclick="saveSettings()">Save Settings</button>
    <div id="saveMessage"></div>
  </div>

  <!-- Employee Onboarding -->
  <div class="card">
    <h2>Employee Onboarding</h2>
    <div class="setting-description" style="margin-bottom:16px;">
      Add new employees to your team. They will receive login credentials via email.
    </div>

    <form id="employeeForm" style="background:#0b0f14; border:1px solid #223044; border-radius:12px; padding:20px; margin-bottom:16px;">
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px;">
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">First Name *</label>
          <input type="text" id="empFirstName" required style="width:100%;" />
        </div>
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Last Name *</label>
          <input type="text" id="empLastName" required style="width:100%;" />
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px;">
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Email *</label>
          <input type="email" id="empEmail" required style="width:100%;" />
        </div>
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Phone</label>
          <input type="text" id="empPhone" placeholder="(555) 555-5555" style="width:100%;" />
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px;">
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Role *</label>
          <select id="empRole" required style="width:100%;">
            <option value="">Select role...</option>
            <option value="owner">Owner</option>
            <option value="manager">Manager</option>
            <option value="technician">Technician</option>
            <option value="service_advisor">Service Advisor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Status</label>
          <select id="empStatus" style="width:100%;">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>

      <button type="submit" class="save-btn" style="margin-top:0;">Add Employee</button>
    </form>

    <div id="employeeMessage"></div>

    <div style="margin-top:20px;">
      <div class="setting-label" style="margin-bottom:12px;">Current Employees</div>
      <div id="employeeList" style="display:grid; gap:8px;">
        <div style="text-align:center; color:#9fb0c3; padding:20px;">Loading employees...</div>
      </div>
    </div>
  </div>

  <!-- Account Settings -->
  <div class="card">
    <h2>Account</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Logged in as</div>
        <div class="setting-description" id="userEmail">Loading...</div>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Account Type</div>
        <div class="setting-description" id="accountType">Standard</div>
      </div>
    </div>
  </div>

  <!-- Data Management -->
  <div class="card">
    <h2>Data Management</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Export Data</div>
        <div class="setting-description">Download your business data as CSV</div>
      </div>
      <button onclick="exportData()">Export</button>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Clear Cache</div>
        <div class="setting-description">Clear local browser cache and stored data</div>
      </div>
      <button onclick="clearCache()">Clear Cache</button>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL = `${API_BASE}/storage/v1`;
const REST_BASE = `${API_BASE}/rest/v1`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const RATE_KEY = "wl_labor_rate";
const BUSINESS_NAME_KEY = "wl_business_name";
const CONTACT_EMAIL_KEY = "wl_contact_email";
const CONTACT_PHONE_KEY = "wl_contact_phone";

let employees = [];

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function goToSettings(){
  location.reload();
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;

  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
  });
  
  if(!r.ok) return null;
  
  const user = await r.json();
  return { token, user };
}

function loadSettings(){
  const laborRate = localStorage.getItem(RATE_KEY);
  if(laborRate) {
    document.getElementById('laborRate').value = laborRate;
  } else {
    document.getElementById('laborRate').value = 125;
  }

  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) document.getElementById('businessName').value = businessName;

  const contactEmail = localStorage.getItem(CONTACT_EMAIL_KEY);
  if(contactEmail) document.getElementById('contactEmail').value = contactEmail;

  const contactPhone = localStorage.getItem(CONTACT_PHONE_KEY);
  if(contactPhone) document.getElementById('contactPhone').value = contactPhone;
}

function saveSettings(){
  const laborRate = document.getElementById('laborRate').value;
  const businessName = document.getElementById('businessName').value;
  const contactEmail = document.getElementById('contactEmail').value;
  const contactPhone = document.getElementById('contactPhone').value;

  if(laborRate && Number(laborRate) > 0) {
    localStorage.setItem(RATE_KEY, laborRate);
  }
  
  if(businessName) localStorage.setItem(BUSINESS_NAME_KEY, businessName);
  if(contactEmail) localStorage.setItem(CONTACT_EMAIL_KEY, contactEmail);
  if(contactPhone) localStorage.setItem(CONTACT_PHONE_KEY, contactPhone);

  const msg = document.getElementById('saveMessage');
  msg.className = 'success';
  msg.textContent = '✓ Settings saved successfully!';
  
  setTimeout(() => {
    msg.textContent = '';
  }, 3000);
}

function exportData(){
  alert('Export functionality coming soon! This will allow you to download all your business data as CSV files.');
}

function clearCache(){
  if(confirm('Are you sure you want to clear all cached data? This will not delete your account data.')){
    const token = localStorage.getItem('sb_access_token');
    localStorage.clear();
    if(token) localStorage.setItem('sb_access_token', token);
    
    alert('Cache cleared successfully!');
    location.reload();
  }
}

function initialsFromName(first, last){
  const f = (first || "").trim();
  const l = (last || "").trim();
  if(!f && !l) return "??";
  return ((f[0] || "") + (l[0] || "")).toUpperCase();
}

function getAvatarUrl(employee){
  if(employee.avatar_url) {
    // If it's already a full URL, use it
    if(employee.avatar_url.startsWith('http')) {
      return employee.avatar_url;
    }
    // Otherwise construct the storage URL
    return `${STORAGE_URL}/object/public/avatars/${employee.avatar_url}`;
  }
  return null;
}

function renderEmployees(){
  const container = document.getElementById('employeeAvatars');
  
  if(!employees.length) {
    container.innerHTML = '<div style="text-align:center; color:#9fb0c3; padding:20px;">No employees found.</div>';
    return;
  }

  container.innerHTML = employees.map(emp => {
    const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
    const initials = initialsFromName(emp.first_name, emp.last_name);
    const avatarUrl = getAvatarUrl(emp);
    
    const avatarStyle = avatarUrl 
      ? `background-image: url('${avatarUrl}');` 
      : '';

    // Parse schedule or use defaults
    const schedule = emp.work_schedule || {
      monday: { start: '08:00', end: '17:00' },
      tuesday: { start: '08:00', end: '17:00' },
      wednesday: { start: '08:00', end: '17:00' },
      thursday: { start: '08:00', end: '17:00' },
      friday: { start: '08:00', end: '17:00' },
      saturday: { start: 'OFF', end: 'OFF' },
      sunday: { start: 'OFF', end: 'OFF' }
    };

    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    return `
      <div class="employee-card">
        <div class="employee-avatar-preview" style="${avatarStyle}">
          ${!avatarUrl ? initials : ''}
          ${avatarUrl ? `<button class="download-avatar-btn" onclick="downloadAvatar('${avatarUrl}', '${name}')" title="Download Photo">↓</button>` : ''}
        </div>
        <div class="employee-name">${name}</div>
        <div class="employee-role">${emp.role || 'Employee'}</div>
        
        <input type="file" 
          id="file-${emp.employee_id}" 
          class="hidden" 
          accept="image/*"
          onchange="handleFileSelect(event, '${emp.employee_id}')" />
        
        <button class="upload-btn" onclick="document.getElementById('file-${emp.employee_id}').click()">
          ${avatarUrl ? 'Change Photo' : 'Upload Photo'}
        </button>
        
        ${avatarUrl ? `
          <button class="remove-btn" onclick="removeAvatar('${emp.employee_id}')">
            Remove Photo
          </button>
        ` : ''}

        <div class="schedule-section">
          <div class="schedule-title">Work Schedule</div>
          ${days.map(day => {
            const dayName = day.charAt(0).toUpperCase() + day.slice(1);
            const daySchedule = schedule[day] || { start: '08:00', end: '17:00' };
            return `
              <div class="schedule-row">
                <span class="schedule-day">${dayName}</span>
                <div>
                  <input type="time" 
                    class="schedule-input" 
                    id="schedule-${emp.employee_id}-${day}-start"
                    value="${daySchedule.start === 'OFF' ? '' : daySchedule.start}"
                    ${daySchedule.start === 'OFF' ? 'placeholder="OFF"' : ''} />
                  <span style="color:#9fb0c3; margin:0 4px;">-</span>
                  <input type="time" 
                    class="schedule-input" 
                    id="schedule-${emp.employee_id}-${day}-end"
                    value="${daySchedule.end === 'OFF' ? '' : daySchedule.end}"
                    ${daySchedule.end === 'OFF' ? 'placeholder="OFF"' : ''} />
                </div>
              </div>
            `;
          }).join('')}
          <button class="save-schedule-btn" onclick="saveSchedule('${emp.employee_id}')">
            Save Schedule
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function renderEmployeeList(){
  const container = document.getElementById('employeeList');
  
  if(!employees.length) {
    container.innerHTML = '<div style="text-align:center; color:#9fb0c3; padding:20px;">No employees found.</div>';
    return;
  }

  container.innerHTML = employees.map(emp => {
    const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
    const role = emp.role || 'Employee';
    const email = emp.email || 'No email';
    const status = emp.status || 'active';
    
    return `
      <div class="employee-list-item">
        <div class="employee-info">
          <div class="employee-info-name">${name}</div>
          <div class="employee-info-details">
            ${role.charAt(0).toUpperCase() + role.slice(1)} • ${email} • ${status.charAt(0).toUpperCase() + status.slice(1)}
          </div>
        </div>
        <div class="employee-actions">
          <button class="delete-btn" onclick="deleteEmployee('${emp.employee_id}')">Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

async function handleFileSelect(event, employeeId){
  const file = event.target.files[0];
  if(!file) return;

  // Validate file type
  if(!file.type.startsWith('image/')) {
    showAvatarMessage('Please select an image file.', 'error');
    return;
  }

  // Validate file size (5MB max)
  if(file.size > 5 * 1024 * 1024) {
    showAvatarMessage('Image must be less than 5MB.', 'error');
    return;
  }

  await uploadAvatar(employeeId, file);
}

async function uploadAvatar(employeeId, file){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    showAvatarMessage('Uploading photo...', 'muted');

    // Create unique filename
    const fileExt = file.name.split('.').pop();
    const fileName = `${employeeId}-${Date.now()}.${fileExt}`;
    const filePath = fileName;

    // Upload to Supabase Storage
    const uploadResponse = await fetch(`${STORAGE_URL}/object/avatars/${filePath}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY,
        'Content-Type': file.type
      },
      body: file
    });

    if(!uploadResponse.ok) {
      const error = await uploadResponse.text();
      throw new Error(`Upload failed: ${error}`);
    }

    // Update employee record with avatar URL
    const updateResponse = await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify({ avatar_url: filePath })
    });

    if(!updateResponse.ok) {
      throw new Error('Failed to update employee record');
    }

    // Update local employee data
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp) emp.avatar_url = filePath;

    showAvatarMessage('Photo uploaded successfully!', 'success');
    renderEmployees();

  } catch(err) {
    console.error('Upload error:', err);
    showAvatarMessage('Error uploading photo: ' + err.message, 'error');
  }
}

async function removeAvatar(employeeId){
  if(!confirm('Are you sure you want to remove this photo?')) return;

  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    const emp = employees.find(e => e.employee_id === employeeId);
    if(!emp || !emp.avatar_url) return;

    // Delete from storage
    await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    // Update employee record
    await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify({ avatar_url: null })
    });

    // Update local data
    emp.avatar_url = null;

    showAvatarMessage('Photo removed successfully!', 'success');
    renderEmployees();

  } catch(err) {
    console.error('Remove error:', err);
    showAvatarMessage('Error removing photo: ' + err.message, 'error');
  }
}

function showAvatarMessage(msg, type = 'success'){
  const area = document.getElementById('avatarMessage');
  area.innerHTML = `<div class="${type}" style="margin-top:12px;">${msg}</div>`;
  setTimeout(() => { area.innerHTML = ''; }, 5000);
}

async function loadEmployees(){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    const response = await fetch(`${FUNCTIONS_BASE}/employees`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    if(!response.ok) throw new Error('Failed to load employees');

    employees = await response.json();
    renderEmployees();
    renderEmployeeList();

  } catch(err) {
    console.error('Load employees error:', err);
    document.getElementById('employeeAvatars').innerHTML = 
      '<div style="text-align:center; color:#ef4444; padding:20px;">Error loading employees.</div>';
  }
}

async function handleEmployeeSubmit(e){
  e.preventDefault();
  
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  const formData = {
    first_name: document.getElementById('empFirstName').value.trim(),
    last_name: document.getElementById('empLastName').value.trim(),
    email: document.getElementById('empEmail').value.trim(),
    phone: document.getElementById('empPhone').value.trim() || null,
    role: document.getElementById('empRole').value,
    status: document.getElementById('empStatus').value || 'active'
  };

  try {
    showEmployeeMessage('Adding employee...', 'muted');

    const response = await fetch(`${REST_BASE}/employees`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(formData)
    });

    if(!response.ok) {
      const error = await response.text();
      throw new Error(error);
    }

    showEmployeeMessage('Employee added successfully!', 'success');
    
    // Reset form
    document.getElementById('employeeForm').reset();
    
    // Reload employees
    await loadEmployees();

  } catch(err) {
    console.error('Add employee error:', err);
    showEmployeeMessage('Error adding employee: ' + err.message, 'error');
  }
}

async function deleteEmployee(employeeId){
  if(!confirm('Are you sure you want to delete this employee? This action cannot be undone.')) return;

  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    showEmployeeMessage('Deleting employee...', 'muted');

    // Delete avatar if exists
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp && emp.avatar_url) {
      await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'apikey': ANON_KEY
        }
      });
    }

    // Delete employee
    const response = await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    if(!response.ok) {
      throw new Error('Failed to delete employee');
    }

    showEmployeeMessage('Employee deleted successfully!', 'success');
    
    // Reload employees
    await loadEmployees();

  } catch(err) {
    console.error('Delete employee error:', err);
    showEmployeeMessage('Error deleting employee: ' + err.message, 'error');
  }
}

function showEmployeeMessage(msg, type = 'success'){
  const area = document.getElementById('employeeMessage');
  area.innerHTML = `<div class="${type}" style="margin-top:12px;">${msg}</div>`;
  setTimeout(() => { area.innerHTML = ''; }, 5000);
}

async function downloadAvatar(avatarUrl, employeeName){
  try {
    const response = await fetch(avatarUrl);
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${employeeName.replace(/\s+/g, '_')}_avatar.jpg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  } catch(err) {
    console.error('Download error:', err);
    showAvatarMessage('Error downloading photo', 'error');
  }
}

async function saveSchedule(employeeId){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  const schedule = {};

  days.forEach(day => {
    const startInput = document.getElementById(`schedule-${employeeId}-${day}-start`);
    const endInput = document.getElementById(`schedule-${employeeId}-${day}-end`);
    
    const start = startInput.value || 'OFF';
    const end = endInput.value || 'OFF';
    
    schedule[day] = { start, end };
  });

  try {
    showAvatarMessage('Saving schedule...', 'muted');

    const response = await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify({ work_schedule: schedule })
    });

    if(!response.ok) {
      throw new Error('Failed to save schedule');
    }

    // Update local data
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp) emp.work_schedule = schedule;

    showAvatarMessage('Schedule saved successfully!', 'success');

  } catch(err) {
    console.error('Save schedule error:', err);
    showAvatarMessage('Error saving schedule: ' + err.message, 'error');
  }
}

async function load(){
  const auth = await validateAuth();
  if(!auth) return location.replace("login.html");

  if(auth.user && auth.user.email) {
    document.getElementById('userEmail').textContent = auth.user.email;
  }

  loadSettings();
  loadEmployees();

  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) {
    document.getElementById('tenantTitle').textContent = businessName + ' - Settings';
    document.title = businessName + ' - Settings';
  }

  // Add employee form submit handler
  document.getElementById('employeeForm').addEventListener('submit', handleEmployeeSubmit);
}

load();
</script>
</body>
</html>
