<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }

    /* pin app name top-right */
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }

    /* Updated sub-nav under title */
    .sub-nav {
      display:flex;
      gap:16px;
      margin: 8px 0 0;
      padding-bottom:10px;
      border-bottom:1px solid #1f2937;
      flex-wrap:wrap;
    }
    .sub-nav-link {
      font-size:14px;
      color:#9ca3af;
      text-decoration:none;
      padding:4px 2px;
      position:relative;
    }
    .sub-nav-link:hover { color:#e5e7eb; }
    .sub-nav-link.active { color:#38bdf8; font-weight:500; }
    .sub-nav-link.active::after {
      content:"";
      position:absolute;
      left:0;
      bottom:-11px;
      width:100%;
      height:2px;
      background:#38bdf8;
      border-radius:2px;
    }

    /* Button group for Settings and Logout */
    .header-buttons {
      display:flex;
      gap:8px;
      align-items:center;
    }

    button {
      padding:8px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:#243648; }

    .card {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:14px;
      padding:20px;
      margin-bottom:16px;
    }

    .setting-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #223044;
    }

    .setting-row:last-child {
      border-bottom:none;
    }

    .setting-label {
      font-size:14px;
      font-weight:500;
    }

    .setting-description {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="file"] {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #223044;
      background:#0b0f14;
      color:#e8eef6;
      width:200px;
    }

    input[type="file"] {
      padding:6px 12px;
      font-size:12px;
    }

    input:focus {
      outline:none;
      border-color:#3b82f6;
    }

    .save-btn {
      background:#3b82f6;
      border-color:#3b82f6;
      margin-top:16px;
    }

    .save-btn:hover {
      background:#2563eb;
    }

    .muted {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    .success {
      color:#4ade80;
      font-size:12px;
      margin-top:8px;
    }

    .error {
      color:#ef4444;
      font-size:12px;
      margin-top:8px;
    }

    /* Employee Avatar Styles */
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .employee-card {
      background: #0b0f14;
      border: 1px solid #223044;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .employee-avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      border: 2px solid #223044;
      background: #0f1621;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      color: #e8eef6;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .employee-avatar-preview:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
    }

    .employee-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .employee-role {
      font-size: 11px;
      color: #9fb0c3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .employee-stats {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #223044;
      text-align: left;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .stat-label {
      color: #9fb0c3;
    }

    .stat-value {
      color: #e8eef6;
      font-weight: 600;
    }

    .view-profile-btn {
      width: 100%;
      margin-top: 10px;
      padding: 6px 10px;
      font-size: 12px;
      background: #0f1621;
      border-color: #3b82f6;
    }

    .view-profile-btn:hover {
      background: #1a2535;
      border-color: #38bdf8;
    }

    /* Employee Profile Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      z-index: 999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: #0f1621;
      border: 1px solid #223044;
      border-radius: 14px;
      padding: 24px;
      width: 100%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #223044;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #9fb0c3;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .modal-close:hover {
      color: #e8eef6;
      background: #1a2535;
      border-radius: 8px;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #9fb0c3;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .modal-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #223044;
      gap: 16px;
    }

    .modal-info-row:last-child {
      border-bottom: none;
    }

    .modal-label {
      font-size: 13px;
      color: #9fb0c3;
      flex-shrink: 0;
    }

    .modal-value {
      font-size: 13px;
      font-weight: 500;
      text-align: right;
      flex-grow: 1;
    }

    .modal-input,
    .modal-select,
    .modal-textarea {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #223044;
      background: #0b0f14;
      color: #e8eef6;
      font-family: system-ui;
      font-size: 13px;
    }

    .modal-input:focus,
    .modal-select:focus,
    .modal-textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .modal-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #223044;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-save-btn {
      background: #3b82f6;
      border-color: #3b82f6;
    }

    .modal-save-btn:hover {
      background: #2563eb;
    }

    .modal-delete-btn {
      background: #ef4444;
      border-color: #ef4444;
    }

    .modal-delete-btn:hover {
      background: #dc2626;
    }

    .accomplishments-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .accomplishments-list li {
      padding: 8px 12px;
      background: #0b0f14;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
      border-left: 3px solid #3b82f6;
    }

    .upload-btn {
      width: 100%;
      font-size: 12px;
      padding: 6px 10px;
    }

    .remove-btn {
      width: 100%;
      font-size: 12px;
      padding: 6px 10px;
      margin-top: 6px;
      background: #ef4444;
      border-color: #ef4444;
    }

    .remove-btn:hover {
      background: #dc2626;
    }

    input[type="file"].hidden {
      display: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #223044;
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile responsive */
    @media (max-width: 640px) {
      header { padding-bottom: 8px; }
      h1 { font-size: 32px; }
      .header-buttons { width: 100%; justify-content: flex-end; }
      .setting-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="file"] { width: 100%; }
      .employee-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <div>
      <h1 id="tenantTitle">Settings</h1>

      <div class="sub-nav">
        <a href="dashboard-business.html" class="sub-nav-link">Dashboard</a>
        <a href="dashboard-customer-search.html" class="sub-nav-link">Customers</a>
        <a href="dashboard-vehicle-search.html" class="sub-nav-link">Vehicles</a>
        <a href="dashboard-scheduling.html" class="sub-nav-link">Scheduling</a>
      </div>
    </div>

    <div class="header-buttons">
      <button onclick="goToSettings()">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Employee Avatars - MOVED TO TOP -->
  <div class="card">
    <h2>Employee Profiles</h2>
    <div class="setting-description" style="margin-bottom:16px;">
      Manage employee photos, compensation, and profile information. Click "View Profile" for full details.
    </div>
    <div id="employeeAvatars" class="employee-grid">
      <div style="text-align:center; color:#9fb0c3; padding:20px;">Loading employees...</div>
    </div>
    <div id="avatarMessage"></div>
  </div>

  <!-- Employee Profile Modal -->
  <div id="employeeModal" class="modal" onclick="if(event.target===this) closeEmployeeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalEmployeeName">Employee Profile</div>
        <button class="modal-close" onclick="closeEmployeeModal()">×</button>
      </div>
      <div id="modalEmployeeBody"></div>
    </div>
  </div>

  <!-- Business Settings -->
  <div class="card">
    <h2>Business Settings</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Labor Rate</div>
        <div class="setting-description">Hourly rate for labor calculations ($/hr)</div>
      </div>
      <input type="number" id="laborRate" min="0" step="1" placeholder="125" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Business Name</div>
        <div class="setting-description">Your company or shop name</div>
      </div>
      <input type="text" id="businessName" placeholder="Business Name" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Contact Email</div>
        <div class="setting-description">Primary contact email for notifications</div>
      </div>
      <input type="email" id="contactEmail" placeholder="email@example.com" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Contact Phone</div>
        <div class="setting-description">Primary contact phone number</div>
      </div>
      <input type="text" id="contactPhone" placeholder="(555) 555-5555" />
    </div>

    <button class="save-btn" onclick="saveSettings()">Save Settings</button>
    <div id="saveMessage"></div>
  </div>

  <!-- Employee Onboarding -->
  <div class="card">
    <h2>Employee Onboarding</h2>
    <div class="setting-description" style="margin-bottom:16px;">
      Add new employees to your team. They will receive login credentials via email.
    </div>

    <form id="employeeForm" style="background:#0b0f14; border:1px solid #223044; border-radius:12px; padding:20px; margin-bottom:16px;">
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px;">
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">First Name *</label>
          <input type="text" id="empFirstName" required style="width:100%;" />
        </div>
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Last Name *</label>
          <input type="text" id="empLastName" required style="width:100%;" />
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px;">
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Email *</label>
          <input type="email" id="empEmail" required style="width:100%;" />
        </div>
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Phone</label>
          <input type="text" id="empPhone" placeholder="(555) 555-5555" style="width:100%;" />
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:16px;">
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Role *</label>
          <select id="empRole" required style="width:100%;">
            <option value="">Select role...</option>
            <option value="owner">Owner</option>
            <option value="manager">Manager</option>
            <option value="technician">Technician</option>
            <option value="service_advisor">Service Advisor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div>
          <label class="setting-label" style="display:block; margin-bottom:6px;">Status</label>
          <select id="empStatus" style="width:100%;">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>

      <button type="submit" class="save-btn" style="margin-top:0;">Add Employee</button>
    </form>

    <div id="employeeMessage"></div>
  </div>

  <!-- Account Settings -->
  <div class="card">
    <h2>Account</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Logged in as</div>
        <div class="setting-description" id="userEmail">Loading...</div>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Account Type</div>
        <div class="setting-description" id="accountType">Standard</div>
      </div>
    </div>
  </div>

  <!-- Data Management -->
  <div class="card">
    <h2>Data Management</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Export Data</div>
        <div class="setting-description">Download your business data as CSV</div>
      </div>
      <button onclick="exportData()">Export</button>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Clear Cache</div>
        <div class="setting-description">Clear local browser cache and stored data</div>
      </div>
      <button onclick="clearCache()">Clear Cache</button>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL = `${API_BASE}/storage/v1`;
const REST_BASE = `${API_BASE}/rest/v1`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const RATE_KEY = "wl_labor_rate";
const BUSINESS_NAME_KEY = "wl_business_name";
const CONTACT_EMAIL_KEY = "wl_contact_email";
const CONTACT_PHONE_KEY = "wl_contact_phone";

let employees = [];

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function goToSettings(){
  location.reload();
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;

  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
  });
  
  if(!r.ok) return null;
  
  const user = await r.json();
  return { token, user };
}

function loadSettings(){
  const laborRate = localStorage.getItem(RATE_KEY);
  if(laborRate) {
    document.getElementById('laborRate').value = laborRate;
  } else {
    document.getElementById('laborRate').value = 125;
  }

  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) document.getElementById('businessName').value = businessName;

  const contactEmail = localStorage.getItem(CONTACT_EMAIL_KEY);
  if(contactEmail) document.getElementById('contactEmail').value = contactEmail;

  const contactPhone = localStorage.getItem(CONTACT_PHONE_KEY);
  if(contactPhone) document.getElementById('contactPhone').value = contactPhone;
}

function saveSettings(){
  const laborRate = document.getElementById('laborRate').value;
  const businessName = document.getElementById('businessName').value;
  const contactEmail = document.getElementById('contactEmail').value;
  const contactPhone = document.getElementById('contactPhone').value;

  if(laborRate && Number(laborRate) > 0) {
    localStorage.setItem(RATE_KEY, laborRate);
  }
  
  if(businessName) localStorage.setItem(BUSINESS_NAME_KEY, businessName);
  if(contactEmail) localStorage.setItem(CONTACT_EMAIL_KEY, contactEmail);
  if(contactPhone) localStorage.setItem(CONTACT_PHONE_KEY, contactPhone);

  const msg = document.getElementById('saveMessage');
  msg.className = 'success';
  msg.textContent = '✓ Settings saved successfully!';
  
  setTimeout(() => {
    msg.textContent = '';
  }, 3000);
}

function exportData(){
  alert('Export functionality coming soon! This will allow you to download all your business data as CSV files.');
}

function clearCache(){
  if(confirm('Are you sure you want to clear all cached data? This will not delete your account data.')){
    const token = localStorage.getItem('sb_access_token');
    localStorage.clear();
    if(token) localStorage.setItem('sb_access_token', token);
    
    alert('Cache cleared successfully!');
    location.reload();
  }
}

function initialsFromName(first, last){
  const f = (first || "").trim();
  const l = (last || "").trim();
  if(!f && !l) return "??";
  return ((f[0] || "") + (l[0] || "")).toUpperCase();
}

function getAvatarUrl(employee){
  if(employee.avatar_url) {
    // If it's already a full URL, use it
    if(employee.avatar_url.startsWith('http')) {
      return employee.avatar_url;
    }
    // Otherwise construct the storage URL
    return `${STORAGE_URL}/object/public/avatars/${employee.avatar_url}`;
  }
  return null;
}

function renderEmployees(){
  const container = document.getElementById('employeeAvatars');
  
  if(!employees.length) {
    container.innerHTML = '<div style="text-align:center; color:#9fb0c3; padding:20px;">No employees found.</div>';
    return;
  }

  container.innerHTML = employees.map(emp => {
    const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
    const initials = initialsFromName(emp.first_name, emp.last_name);
    const avatarUrl = getAvatarUrl(emp);
    
    const avatarStyle = avatarUrl 
      ? `background-image: url('${avatarUrl}');` 
      : '';

    // Calculate years with company
    const hireDate = emp.hire_date ? new Date(emp.hire_date) : null;
    const yearsWithCompany = hireDate 
      ? ((new Date() - hireDate) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1)
      : 'N/A';

    // Get compensation info
    const payRate = emp.pay_rate || 0;
    const payType = emp.pay_type || 'hourly';
    const payDisplay = payType === 'hourly' 
      ? `$${payRate}/hr`
      : payType === 'percentage'
      ? `${payRate}% of job`
      : payType === 'salary'
      ? `$${payRate.toLocaleString()}/yr`
      : 'Not set';

    return `
      <div class="employee-card">
        <div class="employee-avatar-preview" style="${avatarStyle}" onclick="viewEmployeeProfile('${emp.employee_id}')">
          ${!avatarUrl ? initials : ''}
        </div>
        <div class="employee-name">${name}</div>
        <div class="employee-role">${emp.role || 'Employee'}</div>
        
        <input type="file" 
          id="file-${emp.employee_id}" 
          class="hidden" 
          accept="image/*"
          onchange="handleFileSelect(event, '${emp.employee_id}')" />
        
        <button class="upload-btn" onclick="document.getElementById('file-${emp.employee_id}').click()">
          ${avatarUrl ? 'Change Photo' : 'Upload Photo'}
        </button>
        
        ${avatarUrl ? `
          <button class="remove-btn" onclick="removeAvatar('${emp.employee_id}')">
            Remove Photo
          </button>
        ` : ''}

        <div class="employee-stats">
          <div class="stat-row">
            <span class="stat-label">Compensation</span>
            <span class="stat-value">${payDisplay}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Years with us</span>
            <span class="stat-value">${yearsWithCompany}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Status</span>
            <span class="stat-value">${emp.status || 'Active'}</span>
          </div>
        </div>

        <button class="view-profile-btn" onclick="viewEmployeeProfile('${emp.employee_id}')">
          View Profile
        </button>
      </div>
    `;
  }).join('');
}

async function handleFileSelect(event, employeeId){
  const file = event.target.files[0];
  if(!file) return;

  // Validate file type
  if(!file.type.startsWith('image/')) {
    showAvatarMessage('Please select an image file.', 'error');
    return;
  }

  // Validate file size (5MB max)
  if(file.size > 5 * 1024 * 1024) {
    showAvatarMessage('Image must be less than 5MB.', 'error');
    return;
  }

  await uploadAvatar(employeeId, file);
}

async function uploadAvatar(employeeId, file){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    showAvatarMessage('Uploading photo...', 'muted');

    // Create unique filename
    const fileExt = file.name.split('.').pop();
    const fileName = `${employeeId}-${Date.now()}.${fileExt}`;
    const filePath = fileName;

    // Upload to Supabase Storage
    const uploadResponse = await fetch(`${STORAGE_URL}/object/avatars/${filePath}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY,
        'Content-Type': file.type
      },
      body: file
    });

    if(!uploadResponse.ok) {
      const error = await uploadResponse.text();
      throw new Error(`Upload failed: ${error}`);
    }

    // Update employee record with avatar URL
    const updateResponse = await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify({ avatar_url: filePath })
    });

    if(!updateResponse.ok) {
      throw new Error('Failed to update employee record');
    }

    // Update local employee data
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp) emp.avatar_url = filePath;

    showAvatarMessage('Photo uploaded successfully!', 'success');
    renderEmployees();

  } catch(err) {
    console.error('Upload error:', err);
    showAvatarMessage('Error uploading photo: ' + err.message, 'error');
  }
}

async function removeAvatar(employeeId){
  if(!confirm('Are you sure you want to remove this photo?')) return;

  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    const emp = employees.find(e => e.employee_id === employeeId);
    if(!emp || !emp.avatar_url) return;

    // Delete from storage
    await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    // Update employee record
    await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify({ avatar_url: null })
    });

    // Update local data
    emp.avatar_url = null;

    showAvatarMessage('Photo removed successfully!', 'success');
    renderEmployees();

  } catch(err) {
    console.error('Remove error:', err);
    showAvatarMessage('Error removing photo: ' + err.message, 'error');
  }
}

function showAvatarMessage(msg, type = 'success'){
  const area = document.getElementById('avatarMessage');
  area.innerHTML = `<div class="${type}" style="margin-top:12px;">${msg}</div>`;
  setTimeout(() => { area.innerHTML = ''; }, 5000);
}

async function loadEmployees(){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    const [empResponse, userData] = await Promise.all([
      fetch(`${FUNCTIONS_BASE}/employees`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'apikey': ANON_KEY
        }
      }),
      fetch(`${API_BASE}/auth/v1/user`, {
        headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
      }).then(r => r.json())
    ]);

    if(!empResponse.ok) throw new Error('Failed to load employees');

    employees = await empResponse.json();

    // Store current user's employee record for permission checks
    window.currentUserEmployee = employees.find(e => e.email === userData.email);

    renderEmployees();

  } catch(err) {
    console.error('Load employees error:', err);
    document.getElementById('employeeAvatars').innerHTML = 
      '<div style="text-align:center; color:#ef4444; padding:20px;">Error loading employees.</div>';
  }
}

async function handleEmployeeSubmit(e){
  e.preventDefault();
  
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  const formData = {
    first_name: document.getElementById('empFirstName').value.trim(),
    last_name: document.getElementById('empLastName').value.trim(),
    email: document.getElementById('empEmail').value.trim(),
    phone: document.getElementById('empPhone').value.trim() || null,
    role: document.getElementById('empRole').value,
    status: document.getElementById('empStatus').value || 'active'
  };

  try {
    showEmployeeMessage('Adding employee...', 'muted');

    const response = await fetch(`${REST_BASE}/employees`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(formData)
    });

    if(!response.ok) {
      const error = await response.text();
      throw new Error(error);
    }

    showEmployeeMessage('Employee added successfully!', 'success');
    
    // Reset form
    document.getElementById('employeeForm').reset();
    
    // Reload employees
    await loadEmployees();

  } catch(err) {
    console.error('Add employee error:', err);
    showEmployeeMessage('Error adding employee: ' + err.message, 'error');
  }
}

function showEmployeeMessage(msg, type = 'success'){
  const area = document.getElementById('employeeMessage');
  area.innerHTML = `<div class="${type}" style="margin-top:12px;">${msg}</div>`;
  setTimeout(() => { area.innerHTML = ''; }, 5000);
}

function viewEmployeeProfile(employeeId){
  const emp = employees.find(e => e.employee_id === employeeId);
  if(!emp) return;

  const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown';
  document.getElementById('modalEmployeeName').textContent = name;

  // Get current user role
  const currentUser = window.currentUserEmployee;
  const canEdit = currentUser && (currentUser.role === 'owner' || currentUser.role === 'manager');

  // Calculate years with company
  const hireDate = emp.hire_date ? new Date(emp.hire_date) : null;
  const yearsWithCompany = hireDate 
    ? ((new Date() - hireDate) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1)
    : 'N/A';
  const hireDateValue = hireDate ? hireDate.toISOString().split('T')[0] : '';

  // Get compensation info
  const payRate = emp.pay_rate || 0;
  const payType = emp.pay_type || 'hourly';

  // Parse accomplishments
  const accomplishments = emp.accomplishments || [];
  const accomplishmentsText = accomplishments.join('\n');

  const modalBody = document.getElementById('modalEmployeeBody');
  
  if(canEdit) {
    // Editable form for owners/managers
    modalBody.innerHTML = `
      <form id="employeeProfileForm">
        <div class="modal-section">
          <div class="modal-section-title">Personal Information</div>
          <div class="modal-info-row">
            <span class="modal-label">First Name</span>
            <input type="text" class="modal-input" id="editFirstName" value="${emp.first_name || ''}" required />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Last Name</span>
            <input type="text" class="modal-input" id="editLastName" value="${emp.last_name || ''}" required />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Email</span>
            <input type="email" class="modal-input" id="editEmail" value="${emp.email || ''}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Phone</span>
            <input type="tel" class="modal-input" id="editPhone" value="${emp.phone || ''}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Address</span>
            <input type="text" class="modal-input" id="editAddress" value="${emp.address || ''}" />
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Employment Details</div>
          <div class="modal-info-row">
            <span class="modal-label">Role</span>
            <select class="modal-select" id="editRole" required>
              <option value="owner" ${emp.role === 'owner' ? 'selected' : ''}>Owner</option>
              <option value="manager" ${emp.role === 'manager' ? 'selected' : ''}>Manager</option>
              <option value="technician" ${emp.role === 'technician' ? 'selected' : ''}>Technician</option>
              <option value="service_advisor" ${emp.role === 'service_advisor' ? 'selected' : ''}>Service Advisor</option>
              <option value="admin" ${emp.role === 'admin' ? 'selected' : ''}>Admin</option>
            </select>
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Hire Date</span>
            <input type="date" class="modal-input" id="editHireDate" value="${hireDateValue}" />
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Status</span>
            <select class="modal-select" id="editStatus">
              <option value="active" ${emp.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="inactive" ${emp.status === 'inactive' ? 'selected' : ''}>Inactive</option>
            </select>
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Compensation</div>
          <div class="modal-info-row">
            <span class="modal-label">Pay Type</span>
            <select class="modal-select" id="editPayType">
              <option value="hourly" ${payType === 'hourly' ? 'selected' : ''}>Hourly</option>
              <option value="percentage" ${payType === 'percentage' ? 'selected' : ''}>Percentage</option>
              <option value="salary" ${payType === 'salary' ? 'selected' : ''}>Salary</option>
            </select>
          </div>
          <div class="modal-info-row">
            <span class="modal-label">Pay Rate</span>
            <input type="number" class="modal-input" id="editPayRate" value="${payRate}" step="0.01" />
          </div>
        </div>

        <div class="modal-section">
          <div class="modal-section-title">Accomplishments & Certifications</div>
          <textarea class="modal-textarea" id="editAccomplishments" placeholder="Enter one accomplishment per line">${accomplishmentsText}</textarea>
          <div class="muted" style="margin-top:4px;">Enter one accomplishment or certification per line</div>
        </div>

        <div class="modal-footer">
          <button type="button" class="modal-delete-btn" onclick="deleteEmployeeFromModal('${emp.employee_id}')">Delete Employee</button>
          <button type="button" onclick="closeEmployeeModal()">Cancel</button>
          <button type="submit" class="modal-save-btn">Save Changes</button>
        </div>
      </form>
    `;

    document.getElementById('employeeProfileForm').addEventListener('submit', (e) => {
      e.preventDefault();
      saveEmployeeProfile(emp.employee_id);
    });

  } else {
    // Read-only view for others
    const payDisplay = payType === 'hourly' 
      ? `$${payRate}/hr`
      : payType === 'percentage'
      ? `${payRate}% of job`
      : payType === 'salary'
      ? `$${payRate.toLocaleString()}/yr`
      : 'Not set';

    const hireDateDisplay = hireDate ? hireDate.toLocaleDateString() : 'Not set';
    const accomplishmentsHtml = accomplishments.length > 0
      ? `<ul class="accomplishments-list">${accomplishments.map(a => `<li>${a}</li>`).join('')}</ul>`
      : '<div style="color:#9fb0c3; font-size:13px;">No accomplishments recorded yet.</div>';

    modalBody.innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">Personal Information</div>
        <div class="modal-info-row">
          <span class="modal-label">Full Name</span>
          <span class="modal-value">${name}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Email</span>
          <span class="modal-value">${emp.email || 'Not set'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Phone</span>
          <span class="modal-value">${emp.phone || 'Not set'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Address</span>
          <span class="modal-value">${emp.address || 'Not set'}</span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Employment Details</div>
        <div class="modal-info-row">
          <span class="modal-label">Role</span>
          <span class="modal-value">${emp.role || 'Employee'}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Hire Date</span>
          <span class="modal-value">${hireDateDisplay}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Years with Company</span>
          <span class="modal-value">${yearsWithCompany} years</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Status</span>
          <span class="modal-value">${emp.status || 'Active'}</span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Compensation</div>
        <div class="modal-info-row">
          <span class="modal-label">Pay Type</span>
          <span class="modal-value">${payType.charAt(0).toUpperCase() + payType.slice(1)}</span>
        </div>
        <div class="modal-info-row">
          <span class="modal-label">Pay Rate</span>
          <span class="modal-value">${payDisplay}</span>
        </div>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">Accomplishments & Certifications</div>
        ${accomplishmentsHtml}
      </div>

      <div class="modal-footer">
        <button onclick="closeEmployeeModal()">Close</button>
      </div>
    `;
  }

  document.getElementById('employeeModal').classList.add('active');
}

async function saveEmployeeProfile(employeeId){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  const accomplishmentsText = document.getElementById('editAccomplishments').value;
  const accomplishments = accomplishmentsText
    .split('\n')
    .map(line => line.trim())
    .filter(line => line.length > 0);

  const updateData = {
    first_name: document.getElementById('editFirstName').value.trim(),
    last_name: document.getElementById('editLastName').value.trim(),
    email: document.getElementById('editEmail').value.trim() || null,
    phone: document.getElementById('editPhone').value.trim() || null,
    address: document.getElementById('editAddress').value.trim() || null,
    role: document.getElementById('editRole').value,
    hire_date: document.getElementById('editHireDate').value || null,
    status: document.getElementById('editStatus').value,
    pay_type: document.getElementById('editPayType').value,
    pay_rate: parseFloat(document.getElementById('editPayRate').value) || 0,
    accomplishments: accomplishments
  };

  try {
    showAvatarMessage('Saving changes...', 'muted');

    const response = await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      },
      body: JSON.stringify(updateData)
    });

    if(!response.ok) {
      throw new Error('Failed to save employee profile');
    }

    // Update local data
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp) {
      Object.assign(emp, updateData);
    }

    showAvatarMessage('Profile updated successfully!', 'success');
    closeEmployeeModal();
    renderEmployees();

  } catch(err) {
    console.error('Save error:', err);
    showAvatarMessage('Error saving profile: ' + err.message, 'error');
  }
}

async function deleteEmployeeFromModal(employeeId){
  if(!confirm('Are you sure you want to delete this employee? This action cannot be undone.')) return;

  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    showAvatarMessage('Deleting employee...', 'muted');

    // Delete avatar if exists
    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp && emp.avatar_url) {
      await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`,
          'apikey': ANON_KEY
        }
      });
    }

    // Delete employee
    const response = await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': ANON_KEY
      }
    });

    if(!response.ok) {
      throw new Error('Failed to delete employee');
    }

    showAvatarMessage('Employee deleted successfully!', 'success');
    closeEmployeeModal();
    
    // Reload employees
    await loadEmployees();

  } catch(err) {
    console.error('Delete employee error:', err);
    showAvatarMessage('Error deleting employee: ' + err.message, 'error');
  }
}

function closeEmployeeModal(){
  document.getElementById('employeeModal').classList.remove('active');
}

async function load(){
  const auth = await validateAuth();
  if(!auth) return location.replace("login.html");

  if(auth.user && auth.user.email) {
    document.getElementById('userEmail').textContent = auth.user.email;
  }

  loadSettings();
  loadEmployees();

  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) {
    document.getElementById('tenantTitle').textContent = businessName + ' - Settings';
    document.title = businessName + ' - Settings';
  }

  // Add employee form submit handler
  document.getElementById('employeeForm').addEventListener('submit', handleEmployeeSubmit);
}

load();
</script>
</body>
</html>
