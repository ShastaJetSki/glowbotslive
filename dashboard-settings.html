<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
button{cursor:pointer}
.hidden{display:none}
.success{color:#4ade80}
.error{color:#ef4444}
.muted{color:#9fb0c3}
.employee-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
.employee-card{background:#0f1621;border:1px solid #223044;border-radius:12px;padding:16px;text-align:center}
.employee-avatar-preview{width:100px;height:100px;border-radius:12px;margin:0 auto 10px;background:#1a2535;color:#fff;font-size:32px;display:flex;align-items:center;justify-content:center;background-size:cover;background-position:center}
</style>
</head>

<body>

<h1>Employee Profiles</h1>
<div id="employeeAvatars">Loading…</div>
<div id="avatarMessage"></div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL = `${API_BASE}/storage/v1`;
const REST_BASE = `${API_BASE}/rest/v1`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let employees = [];

function initialsFromName(f,l){
  return ((f?.[0]||"")+(l?.[0]||"")).toUpperCase() || "??";
}

function getAvatarUrl(emp){
  if(!emp.avatar_url) return null;
  if(emp.avatar_url.startsWith("http")) return emp.avatar_url;
  return `${STORAGE_URL}/object/public/avatars/${emp.avatar_url}`;
}

function showAvatarMessage(msg,type){
  const el=document.getElementById("avatarMessage");
  el.innerHTML=`<div class="${type}">${msg}</div>`;
  setTimeout(()=>el.innerHTML="",4000);
}

async function uploadAvatar(employeeId,file){
  const token=localStorage.getItem("sb_access_token");
  if(!token) return;

  try{
    showAvatarMessage("Uploading photo…","muted");

    const ext=file.name.split(".").pop();
    const fileName=`${employeeId}-${Date.now()}.${ext}`;

    const formData=new FormData();
    formData.append("file",file);

    const upload=await fetch(
      `${STORAGE_URL}/object/avatars/${fileName}`,
      {
        method:"POST",
        headers:{
          Authorization:`Bearer ${token}`,
          apikey:ANON_KEY
        },
        body:formData
      }
    );

    if(!upload.ok){
      throw new Error(await upload.text());
    }

    const update=await fetch(
      `${REST_BASE}/employees?employee_id=eq.${employeeId}`,
      {
        method:"PATCH",
        headers:{
          "Content-Type":"application/json",
          Authorization:`Bearer ${token}`,
          apikey:ANON_KEY
        },
        body:JSON.stringify({avatar_url:fileName})
      }
    );

    if(!update.ok) throw new Error("DB update failed");

    const emp=employees.find(e=>e.employee_id===employeeId);
    if(emp) emp.avatar_url=fileName;

    showAvatarMessage("Photo uploaded","success");
    renderEmployees();

  }catch(err){
    console.error(err);
    showAvatarMessage(err.message,"error");
  }
}

function handleFileSelect(e,id){
  const f=e.target.files[0];
  if(!f) return;
  if(!f.type.startsWith("image/")) return showAvatarMessage("Image only","error");
  if(f.size>5*1024*1024) return showAvatarMessage("Max 5MB","error");
  uploadAvatar(id,f);
}

function renderEmployees(){
  const el=document.getElementById("employeeAvatars");
  if(!employees.length){
    el.innerHTML="No employees";
    return;
  }

  el.innerHTML=employees.map(emp=>{
    const name=`${emp.first_name} ${emp.last_name}`;
    const url=getAvatarUrl(emp);
    const style=url?`style="background-image:url('${url}')"`:"";
    return `
    <div class="employee-card">
      <div class="employee-avatar-preview" ${style}>
        ${!url?initialsFromName(emp.first_name,emp.last_name):""}
      </div>

      <strong>${name}</strong><br>
      <input type="file" class="hidden" id="f-${emp.employee_id}"
        accept="image/*"
        onchange="handleFileSelect(event,'${emp.employee_id}')">

      <button onclick="document.getElementById('f-${emp.employee_id}').click()">
        ${url?"Change":"Upload"} Photo
      </button>
    </div>`;
  }).join("");
}

async function loadEmployees(){
  const token=localStorage.getItem("sb_access_token");
  if(!token) return location.replace("login.html");

  const r=await fetch(`${FUNCTIONS_BASE}/employees`,{
    headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
  });

  if(!r.ok){
    document.getElementById("employeeAvatars").innerHTML="Load error";
    return;
  }

  employees=await r.json();
  renderEmployees();
}

loadEmployees();
</script>
</body>
</html>
