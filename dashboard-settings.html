<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body { margin:0; padding:24px; font-family:system-ui; background:#0b0f14; color:#e8eef6; }

    /* pin app name top-right */
    .appName { position:fixed; top:10px; right:24px; font-size:12px; color:#9fb0c3; }

    header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:16px; gap:16px; flex-wrap:wrap; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }

    /* Updated sub-nav under title */
    .sub-nav {
      display:flex;
      gap:16px;
      margin: 8px 0 0;
      padding-bottom:10px;
      border-bottom:1px solid #1f2937;
      flex-wrap:wrap;
    }
    .sub-nav-link {
      font-size:14px;
      color:#9ca3af;
      text-decoration:none;
      padding:4px 2px;
      position:relative;
    }
    .sub-nav-link:hover { color:#e5e7eb; }
    .sub-nav-link.active { color:#38bdf8; font-weight:500; }
    .sub-nav-link.active::after {
      content:"";
      position:absolute;
      left:0;
      bottom:-11px;
      width:100%;
      height:2px;
      background:#38bdf8;
      border-radius:2px;
    }

    /* Button group for Settings and Logout */
    .header-buttons {
      display:flex;
      gap:8px;
      align-items:center;
    }

    button {
      padding:8px 14px;
      border-radius:10px;
      border:1px solid #2a3b55;
      background:#1a2535;
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:#243648; }

    .card {
      background:#0f1621;
      border:1px solid #223044;
      border-radius:14px;
      padding:20px;
      margin-bottom:16px;
    }

    .setting-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #223044;
    }

    .setting-row:last-child {
      border-bottom:none;
    }

    .setting-label {
      font-size:14px;
      font-weight:500;
    }

    .setting-description {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"] {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #223044;
      background:#0b0f14;
      color:#e8eef6;
      width:200px;
    }

    input:focus {
      outline:none;
      border-color:#3b82f6;
    }

    .save-btn {
      background:#3b82f6;
      border-color:#3b82f6;
      margin-top:16px;
    }

    .save-btn:hover {
      background:#2563eb;
    }

    .muted {
      font-size:12px;
      color:#9fb0c3;
      margin-top:4px;
    }

    .success {
      color:#4ade80;
      font-size:12px;
      margin-top:8px;
    }

    .error {
      color:#ef4444;
      font-size:12px;
      margin-top:8px;
    }

    /* Mobile responsive */
    @media (max-width: 640px) {
      header { padding-bottom: 8px; }
      h1 { font-size: 32px; }
      .header-buttons { width: 100%; justify-content: flex-end; }
      .setting-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      input[type="text"],
      input[type="number"],
      input[type="email"] { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="appName">WorkLogicPro</div>

  <header>
    <div>
      <h1 id="tenantTitle">Settings</h1>

      <div class="sub-nav">
        <a href="dashboard-business.html" class="sub-nav-link">Dashboard</a>
        <a href="dashboard-customer-search.html" class="sub-nav-link">Customers</a>
        <a href="dashboard-vehicle-search.html" class="sub-nav-link">Vehicles</a>
        <a href="dashboard-scheduling.html" class="sub-nav-link">Scheduling</a>
      </div>
    </div>

    <div class="header-buttons">
      <button onclick="goToSettings()">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Business Settings -->
  <div class="card">
    <h2>Business Settings</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Labor Rate</div>
        <div class="setting-description">Hourly rate for labor calculations ($/hr)</div>
      </div>
      <input type="number" id="laborRate" min="0" step="1" placeholder="125" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Business Name</div>
        <div class="setting-description">Your company or shop name</div>
      </div>
      <input type="text" id="businessName" placeholder="Business Name" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Contact Email</div>
        <div class="setting-description">Primary contact email for notifications</div>
      </div>
      <input type="email" id="contactEmail" placeholder="email@example.com" />
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Contact Phone</div>
        <div class="setting-description">Primary contact phone number</div>
      </div>
      <input type="text" id="contactPhone" placeholder="(555) 555-5555" />
    </div>

    <button class="save-btn" onclick="saveSettings()">Save Settings</button>
    <div id="saveMessage"></div>
  </div>

  <!-- Account Settings -->
  <div class="card">
    <h2>Account</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Logged in as</div>
        <div class="setting-description" id="userEmail">Loading...</div>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Account Type</div>
        <div class="setting-description" id="accountType">Standard</div>
      </div>
    </div>
  </div>

  <!-- Data Management -->
  <div class="card">
    <h2>Data Management</h2>
    
    <div class="setting-row">
      <div>
        <div class="setting-label">Export Data</div>
        <div class="setting-description">Download your business data as CSV</div>
      </div>
      <button onclick="exportData()">Export</button>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Clear Cache</div>
        <div class="setting-description">Clear local browser cache and stored data</div>
      </div>
      <button onclick="clearCache()">Clear Cache</button>
    </div>
  </div>

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

const RATE_KEY = "wl_labor_rate";
const BUSINESS_NAME_KEY = "wl_business_name";
const CONTACT_EMAIL_KEY = "wl_contact_email";
const CONTACT_PHONE_KEY = "wl_contact_phone";

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function goToSettings(){
  // Already on settings page, do nothing or reload
  location.reload();
}

async function validateAuth(){
  const token = localStorage.getItem("sb_access_token");
  if(!token) return null;

  const r = await fetch(`${API_BASE}/auth/v1/user`, {
    headers:{ apikey:ANON_KEY, Authorization:`Bearer ${token}` }
  });
  
  if(!r.ok) return null;
  
  const user = await r.json();
  return { token, user };
}

function loadSettings(){
  // Load labor rate
  const laborRate = localStorage.getItem(RATE_KEY);
  if(laborRate) {
    document.getElementById('laborRate').value = laborRate;
  } else {
    document.getElementById('laborRate').value = 125; // default
  }

  // Load business settings
  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) document.getElementById('businessName').value = businessName;

  const contactEmail = localStorage.getItem(CONTACT_EMAIL_KEY);
  if(contactEmail) document.getElementById('contactEmail').value = contactEmail;

  const contactPhone = localStorage.getItem(CONTACT_PHONE_KEY);
  if(contactPhone) document.getElementById('contactPhone').value = contactPhone;
}

function saveSettings(){
  const laborRate = document.getElementById('laborRate').value;
  const businessName = document.getElementById('businessName').value;
  const contactEmail = document.getElementById('contactEmail').value;
  const contactPhone = document.getElementById('contactPhone').value;

  // Save to localStorage
  if(laborRate && Number(laborRate) > 0) {
    localStorage.setItem(RATE_KEY, laborRate);
  }
  
  if(businessName) localStorage.setItem(BUSINESS_NAME_KEY, businessName);
  if(contactEmail) localStorage.setItem(CONTACT_EMAIL_KEY, contactEmail);
  if(contactPhone) localStorage.setItem(CONTACT_PHONE_KEY, contactPhone);

  // Show success message
  const msg = document.getElementById('saveMessage');
  msg.className = 'success';
  msg.textContent = 'âœ“ Settings saved successfully!';
  
  setTimeout(() => {
    msg.textContent = '';
  }, 3000);
}

function exportData(){
  alert('Export functionality coming soon! This will allow you to download all your business data as CSV files.');
}

function clearCache(){
  if(confirm('Are you sure you want to clear all cached data? This will not delete your account data.')){
    // Clear everything except auth token
    const token = localStorage.getItem('sb_access_token');
    localStorage.clear();
    if(token) localStorage.setItem('sb_access_token', token);
    
    alert('Cache cleared successfully!');
    location.reload();
  }
}

async function load(){
  const auth = await validateAuth();
  if(!auth) return location.replace("login.html");

  // Display user email
  if(auth.user && auth.user.email) {
    document.getElementById('userEmail').textContent = auth.user.email;
  }

  // Load settings
  loadSettings();

  // Set business name as title if available
  const businessName = localStorage.getItem(BUSINESS_NAME_KEY);
  if(businessName) {
    document.getElementById('tenantTitle').textContent = businessName + ' - Settings';
    document.title = businessName + ' - Settings';
  }
}

load();
</script>
</body>
</html>
