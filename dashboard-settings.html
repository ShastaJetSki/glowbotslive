<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <link rel="stylesheet" href="theme-system.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin:0; padding:0; font-family:system-ui; background:var(--bg-primary, #0b0f14); color:var(--text-primary, #e8eef6); padding-bottom: 165px; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }

    button {
      padding:8px 14px;
      border-radius:10px;
      border:1px solid var(--border-default, #2a3b55);
      background:var(--bg-card, #1a2535);
      color:var(--text-primary, #fff);
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:var(--bg-hover, #243648); }

    .card {
      background:var(--bg-secondary, #0f1621);
      border:1px solid var(--border-default, #223044);
      border-radius:14px;
      padding:20px;
      margin-bottom:16px;
    }

    .setting-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid var(--border-default, #223044);
    }

    .setting-row:last-child {
      border-bottom:none;
    }

    .setting-label {
      font-size:14px;
      font-weight:500;
    }

    .setting-description {
      font-size:12px;
      color:var(--text-secondary, #9fb0c3);
      margin-top:4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    input[type="url"],
    input[type="file"],
    input[type="date"],
    input[type="color"],
    textarea,
    select {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border-default, #223044);
      background:var(--bg-card, #1a2535);
      color:var(--text-primary, #e8eef6);
      width:200px;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    input[type="color"] {
      padding: 4px;
      width: 60px;
      height: 40px;
      cursor: pointer;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    input[type="file"] {
      padding:6px 12px;
      font-size:12px;
    }

    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:var(--accent-primary, #3b82f6);
    }

    .save-btn {
      background:var(--accent-primary, #3b82f6);
      border-color:var(--accent-primary, #3b82f6);
      margin-top:16px;
      color:white;
    }

    .save-btn:hover {
      background:var(--accent-light, #2563eb);
    }

    .muted {
      font-size:12px;
      color:var(--text-secondary, #9fb0c3);
      margin-top:4px;
    }

    .success {
      color:#4ade80;
      font-size:12px;
      margin-top:8px;
    }

    .error {
      color:#ef4444;
      font-size:12px;
      margin-top:8px;
    }

    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .employee-card {
      background: var(--bg-primary, #0b0f14);
      border: 1px solid var(--border-default, #223044);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .employee-card:hover {
      border-color: var(--accent-primary, #3b82f6);
      transform: translateY(-2px);
    }

    .employee-avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      border: 2px solid var(--border-default, #223044);
      background: var(--bg-secondary, #0f1621);
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      color: var(--text-primary, #e8eef6);
      overflow: hidden;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .employee-avatar-preview:hover {
      border-color: var(--accent-primary, #3b82f6);
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .employee-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .employee-role {
      font-size: 11px;
      color: var(--text-secondary, #9fb0c3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .employee-stats {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-default, #223044);
      text-align: left;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .stat-label {
      color: var(--text-secondary, #9fb0c3);
    }

    .stat-value {
      color: var(--text-primary, #e8eef6);
      font-weight: 600;
    }

    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
    }

    .accordion-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .accordion-icon {
      font-size: 20px;
      color: var(--text-secondary, #9fb0c3);
      transition: transform 0.2s ease;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.active {
      max-height: 5000px;
    }

    .accordion-inner {
      padding-top: 16px;
    }

    .icon-nav-bar {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding: 6px;
      background: rgba(15, 22, 33, 0.5);
      border-radius: 10px;
      border: 1px solid var(--border-default, #223044);
    }

    .icon-nav-btn {
      flex: 1;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      background: transparent;
      padding: 0;
    }

    .icon-nav-primary {
      color: #6b7280;
    }

    .icon-nav-primary:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--accent-primary, #3b82f6);
      color: var(--accent-primary, #3b82f6);
    }

    .icon-nav-danger {
      color: #6b7280;
    }

    .icon-nav-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }

    .icon-nav-btn:active {
      transform: scale(0.95);
    }

    input[type="file"].hidden {
      display: none;
    }
    
    /* Logo/Image Preview */
    .image-preview-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo-preview {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      border: 2px dashed var(--border-default, #223044);
      background: var(--bg-card, #1a2535);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .logo-preview:hover {
      border-color: var(--accent-primary, #3b82f6);
    }
    
    .logo-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .logo-preview-placeholder {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .social-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .social-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
      border-radius: 6px;
      font-size: 16px;
    }

    /* Appointment Type Styles */
    .appointment-type-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary, #0b0f14);
      border: 1px solid var(--border-default, #223044);
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .appointment-type-row:hover {
      border-color: var(--accent-primary, #3b82f6);
    }

    /* Mobile Header with Hamburger */
    .mobile-top-header {
      display: none;
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary, #0f1621);
      border-bottom: 1px solid var(--border-default, #223044);
    }

    .mobile-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
    }

    .mobile-menu-toggle {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: #6b7280;
      font-size: 20px;
      padding: 0;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .mobile-menu-toggle:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--accent-primary, #3b82f6);
      color: var(--accent-primary, #3b82f6);
    }

    .mobile-menu-toggle:active {
      transform: scale(0.95);
    }

    .mobile-header-center {
      flex: 1;
      margin-left: 12px;
    }

    .mobile-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .mobile-header-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .mobile-header-content.expanded {
      max-height: 200px;
    }

    .mobile-header-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 8px 12px 12px;
      background: var(--bg-primary, #0b0f14);
      border-top: 1px solid var(--border-default, #223044);
    }

    .mobile-header-actions button {
      padding: 10px;
      font-size: 13px;
      background: var(--bg-card, #1a2535);
      border: 1px solid var(--accent-primary, #3b82f6);
      transition: all 0.2s;
    }

    .mobile-header-actions button:active {
      background: var(--bg-hover, #243648);
    }

    .accordion-icon-header {
      font-size: 20px;
      color: var(--text-secondary, #9fb0c3);
      transition: transform 0.2s ease;
    }

    .mobile-menu-toggle.active .accordion-icon-header {
      transform: rotate(180deg);
    }

    /* Mobile Bottom Nav - Matching Business Page */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary, #0f1621);
      padding: 8px;
      z-index: 100;
    }
    
    .mobile-nav-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .mobile-nav-secondary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .mobile-nav-btn {
      padding: 10px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-default, #223044);
      background: var(--bg-card, #1a2535);
      color: var(--text-secondary, #9fb0c3);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }
    
    .mobile-nav-grid .mobile-nav-btn {
      background: var(--bg-hover, #1f2e40);
    }

    .mobile-nav-btn.active {
      background: var(--accent-primary, #3b82f6);
      border-color: var(--accent-primary, #3b82f6);
      color: #fff;
    }

    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block; }
      
      h1 {
        font-size: 24px !important;
      }
      
      .setting-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="tel"],
      input[type="url"],
      input[type="file"],
      textarea,
      select { width: 100%; }
      .employee-grid { grid-template-columns: 1fr; }
      
      .appointment-type-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .apt-type-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- Mobile Top Header -->
  <div class="mobile-top-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">
        <span class="accordion-icon-header">☰</span>
      </button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Settings</div>
      </div>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-actions">
        <button onclick="location.href='dashboard-service.html'">Service</button>
        <button onclick="location.href='dashboard-parts.html'">Parts</button>
        <button onclick="location.href='dashboard-sales.html'">Sales</button>
      </div>
    </div>
  </div>

  <!-- Desktop Sticky Header -->
  <div class="desktop-header" style="position:sticky; top:0; z-index:100; background:var(--bg-primary); border-bottom:1px solid var(--border-default);">
    <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
      <h1 style="margin:0; font-size:32px; font-weight:600;">Settings</h1>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
    </div>
    
    <div style="padding:0 24px 12px;">
      <nav style="display:flex; gap:24px; overflow-x:auto;">
        <a href="dashboard-business.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Business</a>
        <a href="dashboard-customer-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
        <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
        <a href="dashboard-settings.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid var(--accent-primary);">Settings</a>
      </nav>
    </div>
    
    <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="location.href='dashboard-service.html'">Service</button>
        <button onclick="location.href='dashboard-parts.html'">Parts</button>
        <button onclick="location.href='dashboard-sales.html'">Sales</button>
      </div>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <div class="mobile-bottom-nav">
    <div class="mobile-nav-grid">
      <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
      <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
      <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
      <a href="dashboard-settings.html" class="mobile-nav-btn active">Settings</a>
    </div>
    <div class="mobile-nav-secondary">
      <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
      <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
      <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
    </div>
  </div>

  <!-- Main Content -->
  <div style="padding:24px;">

  <!-- BUSINESS DEPARTMENT -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Business</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        
        <!-- Company Information -->
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Company Information</h3>
        
        <div class="setting-row">
          <div>
            <div class="setting-label">Business Name</div>
            <div class="setting-description">Your company or shop name</div>
          </div>
          <input type="text" id="businessName" placeholder="Business Name" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Name</div>
            <div class="setting-description">Primary contact person name</div>
          </div>
          <input type="text" id="contactName" placeholder="Contact Name" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Email</div>
            <div class="setting-description">Primary contact email</div>
          </div>
          <input type="email" id="contactEmail" placeholder="email@example.com" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Phone</div>
            <div class="setting-description">Auto-formats to XXX-XXX-XXXX</div>
          </div>
          <input type="tel" id="contactPhone" placeholder="555-555-5555" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Business Address</div>
            <div class="setting-description">Street address</div>
          </div>
          <input type="text" id="businessAddress" placeholder="123 Main St" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">City, State ZIP</div>
          </div>
          <input type="text" id="businessCityStateZip" placeholder="Redding, CA 96001" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Local Sales Tax</div>
            <div class="setting-description">Sales tax percentage (%)</div>
          </div>
          <input type="number" id="localTax" min="0" max="100" step="0.01" placeholder="8.5" />
        </div>

        <button class="save-btn" onclick="saveAllSettings()">Save Business Settings</button>
        <div id="saveMessage"></div>
      </div>
    </div>
  </div>

  <!-- EMPLOYEES SECTION -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Employees</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Employee Management</h3>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:8px;">
          <div class="setting-description">
            Manage employee photos, compensation, schedules, and profile information.
          </div>
          <button onclick="openNewEmployeeModal()">+ Add Employee</button>
        </div>
        
        <!-- Employee Filters -->
        <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
          <select id="employeeFilterDept" onchange="filterEmployees()" style="width:auto;">
            <option value="">All Departments</option>
            <option value="service">Service</option>
            <option value="sales">Sales</option>
            <option value="parts">Parts</option>
            <option value="admin">Admin</option>
          </select>
          <select id="employeeFilterStatus" onchange="filterEmployees()" style="width:auto;">
            <option value="">All Status</option>
            <option value="active">Active Only</option>
            <option value="inactive">Inactive Only</option>
          </select>
        </div>
        
        <div id="employeeAvatars" class="employee-grid">
          <div style="text-align:center; color:var(--text-secondary); padding:20px;">Loading employees...</div>
        </div>
        <div id="avatarMessage"></div>
        
        <!-- Payroll Quick Stats -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Payroll Overview</h3>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="totalEmployees">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Total Employees</div>
          </div>
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="activeEmployees">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Active</div>
          </div>
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="serviceTechs">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Service Techs</div>
          </div>
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="salesStaff">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Sales Staff</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APPEARANCE & THEMES -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Appearance & Themes</h2>
      <span class="accordion-icon">▼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="setting-description" style="margin-bottom:16px;">
          Choose your preferred color scheme. Changes apply instantly across all pages.
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:16px; margin-top:20px;">
          <div style="background:#0f1621; border:3px solid var(--accent-primary); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-blue')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:var(--bg-primary);">
              <div style="flex:1; border-radius:4px; background:#1a2535;"></div>
              <div style="flex:1; border-radius:4px; background:#3b82f6;"></div>
              <div style="flex:1; border-radius:4px; background:#60a5fa;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Blue</div>
            <div style="font-size:11px; color:var(--text-secondary);">Default</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-grey')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#0f0f0f;">
              <div style="flex:1; border-radius:4px; background:#252525;"></div>
              <div style="flex:1; border-radius:4px; background:#6b7280;"></div>
              <div style="flex:1; border-radius:4px; background:#9ca3af;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Grey</div>
            <div style="font-size:11px; color:var(--text-secondary);">Monochrome</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>
  <!-- End Main Content -->

<!-- New Employee Modal -->
<div id="newEmployeeModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.75); z-index:2000; align-items:flex-end; justify-content:center;">
  <div style="background:var(--bg-secondary, #0f1621); border-radius:20px 20px 0 0; width:100%; max-width:500px; max-height:90vh; overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid var(--border-default, #223044); position:sticky; top:0; background:var(--bg-secondary, #0f1621); z-index:10;">
      <h3 style="font-size:20px; font-weight:700;">Add New Employee</h3>
      <button onclick="closeNewEmployeeModal()" style="background:transparent; border:none; color:var(--text-secondary); font-size:28px; cursor:pointer;">&times;</button>
    </div>
    <div style="padding:20px;">
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:6px;">First Name *</label>
        <input type="text" id="newEmpFirstName" style="width:100%;" placeholder="John" />
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:6px;">Last Name *</label>
        <input type="text" id="newEmpLastName" style="width:100%;" placeholder="Smith" />
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:6px;">Email</label>
        <input type="email" id="newEmpEmail" style="width:100%;" placeholder="john@company.com" />
        <div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">Required to assign tasks. Creates user account automatically.</div>
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:6px;">Phone *</label>
        <input type="tel" id="newEmpPhone" style="width:100%;" placeholder="555-123-4567" />
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
        <div>
          <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:6px;">Department</label>
          <select id="newEmpDepartment" style="width:100%;">
            <option value="">Select...</option>
            <option value="service">Service</option>
            <option value="sales">Sales</option>
            <option value="parts">Parts</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div>
          <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:6px;">Role</label>
          <select id="newEmpRole" style="width:100%;">
            <option value="technician">Technician</option>
            <option value="manager">Manager</option>
            <option value="sales_consultant">Sales Consultant</option>
            <option value="sales_manager">Sales Manager</option>
            <option value="admin">Admin</option>
            <option value="owner">Owner</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:6px;">Hire Date</label>
        <input type="date" id="newEmpHireDate" style="width:100%;" />
      </div>
    </div>
    <div style="padding:16px 20px 24px; border-top:1px solid var(--border-default, #223044);">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="save-btn" style="margin-top:0;" onclick="saveNewEmployee()">Add Employee</button>
        <button onclick="closeNewEmployeeModal()">Cancel</button>
      </div>
      <div id="newEmployeeMessage" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const SUPABASE_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let sb;
let tenantId = null;

async function initSupabase() {
  const token = localStorage.getItem('sb_access_token');
  if (!token) {
    window.location.href = 'login.html';
    return null;
  }
  
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    global: { headers: { Authorization: 'Bearer ' + token } }
  });
  
  // Get tenant_id
  const { data: settings } = await sb.from('business_settings').select('tenant_id, business_name').limit(1).single();
  if (settings) {
    tenantId = settings.tenant_id;
  }
  
  return sb;
}

function toggleMobileMenu(button) {
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
  button.classList.toggle('active');
}

function toggleAccordion(button){
  const content = button.nextElementSibling;
  button.classList.toggle('active');
  content.classList.toggle('active');
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function setTheme(theme) {
  localStorage.setItem('app-theme', theme);
  document.documentElement.setAttribute('data-theme', theme);
}

function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
loadTheme();

// =====================================================
// EMPLOYEE MANAGEMENT
// =====================================================

function openNewEmployeeModal() {
  document.getElementById('newEmpFirstName').value = '';
  document.getElementById('newEmpLastName').value = '';
  document.getElementById('newEmpEmail').value = '';
  document.getElementById('newEmpPhone').value = '';
  document.getElementById('newEmpDepartment').value = '';
  document.getElementById('newEmpRole').value = 'technician';
  document.getElementById('newEmpHireDate').value = '';
  document.getElementById('newEmployeeMessage').innerHTML = '';
  document.getElementById('newEmployeeModal').style.display = 'flex';
}

function closeNewEmployeeModal() {
  document.getElementById('newEmployeeModal').style.display = 'none';
}

async function saveNewEmployee() {
  if (!sb || !tenantId) {
    document.getElementById('newEmployeeMessage').innerHTML = '<span class="error">Not authenticated</span>';
    return;
  }
  
  const firstName = document.getElementById('newEmpFirstName').value.trim();
  const lastName = document.getElementById('newEmpLastName').value.trim();
  const email = document.getElementById('newEmpEmail').value.trim() || null;
  const phone = document.getElementById('newEmpPhone').value.trim();
  const department = document.getElementById('newEmpDepartment').value || null;
  const empRole = document.getElementById('newEmpRole').value || 'technician';
  const hireDate = document.getElementById('newEmpHireDate').value || null;
  
  if (!firstName || !lastName || !phone) {
    document.getElementById('newEmployeeMessage').innerHTML = '<span class="error">First name, last name, and phone are required.</span>';
    return;
  }
  
  // Map employee role to valid user role (admin, technician, owner, manager)
  const userRoleMap = {
    'owner': 'owner',
    'manager': 'manager',
    'sales_manager': 'manager',
    'sales_consultant': 'technician',
    'technician': 'technician',
    'admin': 'admin'
  };
  const userRole = userRoleMap[empRole] || 'technician';
  
  let userId = null;
  
  // If email provided, create a user account first so employee can be assigned tasks
  if (email) {
    // Check if user already exists with this email
    const { data: existingUser } = await sb.from('users')
      .select('user_id')
      .eq('email', email)
      .eq('tenant_id', tenantId)
      .single();
    
    if (existingUser) {
      userId = existingUser.user_id;
    } else {
      // Create new user record
      const newUserId = crypto.randomUUID();
      const { error: userError } = await sb.from('users').insert({
        user_id: newUserId,
        tenant_id: tenantId,
        email: email,
        role: userRole,
        is_active: true,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      });
      
      if (userError) {
        console.error('Error creating user:', userError);
        // Continue without user_id - employee can still be created
      } else {
        userId = newUserId;
      }
    }
  }
  
  const newEmp = {
    tenant_id: tenantId,
    first_name: firstName,
    last_name: lastName,
    email: email,
    phone: phone,
    department: department,
    role: empRole,
    hire_date: hireDate,
    user_id: userId,
    is_active: true,
    created_at: new Date().toISOString()
  };
  
  const { error } = await sb.from('employees').insert(newEmp);
  
  if (error) {
    document.getElementById('newEmployeeMessage').innerHTML = '<span class="error">Error: ' + error.message + '</span>';
    return;
  }
  
  closeNewEmployeeModal();
  loadEmployeesSection();
  
  if (userId) {
    alert(`Employee added! ${firstName} ${lastName} can now be assigned tasks.`);
  } else {
    alert(`Employee added! Note: Without an email, ${firstName} cannot be assigned tasks.`);
  }
}

async function loadEmployeesSection() {
  if (!sb || !tenantId) return;
  
  try {
    const { data: employees, error } = await sb.from('employees')
      .select('*')
      .eq('tenant_id', tenantId)
      .order('last_name', { ascending: true });
    
    if (error) throw error;
    
    const total = employees ? employees.length : 0;
    const active = employees ? employees.filter(e => e.is_active === true).length : 0;
    const serviceTechs = employees ? employees.filter(e => {
      const dept = (e.department || '').toLowerCase();
      const role = (e.role || '').toLowerCase();
      return dept === 'service' || role.includes('tech') || role.includes('mechanic');
    }).length : 0;
    const salesStaff = employees ? employees.filter(e => {
      const dept = (e.department || '').toLowerCase();
      const role = (e.role || '').toLowerCase();
      return dept === 'sales' || role.includes('sales');
    }).length : 0;
    
    document.getElementById('totalEmployees').textContent = total;
    document.getElementById('activeEmployees').textContent = active;
    document.getElementById('serviceTechs').textContent = serviceTechs;
    document.getElementById('salesStaff').textContent = salesStaff;
    
    const grid = document.getElementById('employeeAvatars');
    
    if (!employees || employees.length === 0) {
      grid.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No employees found. Click "+ Add Employee" to create one.</div>';
      return;
    }
    
    const deptFilter = document.getElementById('employeeFilterDept')?.value || '';
    const statusFilter = document.getElementById('employeeFilterStatus')?.value || '';
    
    let filtered = employees;
    
    if (deptFilter) {
      filtered = filtered.filter(e => (e.department || '').toLowerCase() === deptFilter);
    }
    
    if (statusFilter === 'active') {
      filtered = filtered.filter(e => e.is_active === true);
    } else if (statusFilter === 'inactive') {
      filtered = filtered.filter(e => e.is_active === false);
    }
    
    if (filtered.length === 0) {
      grid.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No employees match the current filters.</div>';
      return;
    }
    
    const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#14b8a6', '#ec4899'];
    
    grid.innerHTML = filtered.map((emp, i) => {
      const name = ((emp.first_name || '') + ' ' + (emp.last_name || '')).trim() || 'Unknown';
      const initials = emp.first_name && emp.last_name 
        ? (emp.first_name[0] + emp.last_name[0]).toUpperCase() 
        : '??';
      const role = (emp.role || 'Staff').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      const color = colors[i % colors.length];
      const avatarStyle = emp.avatar_url 
        ? `background-image:url('${emp.avatar_url}'); background-size:cover;` 
        : `background:${color};`;
      const avatarContent = emp.avatar_url ? '' : initials;
      const hasUser = emp.user_id ? '✓' : '⚠️';
      
      return `
        <div class="employee-card" onclick="location.href='employee-edit.html?id=${emp.employee_id}'">
          <div class="employee-avatar-preview" style="${avatarStyle}">
            ${avatarContent}
          </div>
          <div class="employee-name">${name}</div>
          <div class="employee-role">${role}</div>
          <div class="employee-stats">
            <div class="stat-row">
              <span class="stat-label">Department</span>
              <span class="stat-value">${emp.department || 'N/A'}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Status</span>
              <span class="stat-value">${emp.is_active ? 'Active' : 'Inactive'}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Can Assign Tasks</span>
              <span class="stat-value">${hasUser}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
  } catch (err) {
    console.error('Error loading employees:', err);
    document.getElementById('employeeAvatars').innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">Error loading employees</div>';
  }
}

function filterEmployees() {
  loadEmployeesSection();
}

async function saveAllSettings() {
  if (!sb || !tenantId) {
    document.getElementById('saveMessage').innerHTML = '<span class="error">Not authenticated</span>';
    return;
  }
  
  const updates = {
    business_name: document.getElementById('businessName').value.trim() || null,
    contact_name: document.getElementById('contactName').value.trim() || null,
    contact_email: document.getElementById('contactEmail').value.trim() || null,
    contact_phone: document.getElementById('contactPhone').value.trim() || null,
    address: document.getElementById('businessAddress').value.trim() || null,
    city_state_zip: document.getElementById('businessCityStateZip').value.trim() || null,
    tax_rate: parseFloat(document.getElementById('localTax').value) || null,
    updated_at: new Date().toISOString()
  };
  
  const { error } = await sb.from('business_settings').update(updates).eq('tenant_id', tenantId);
  
  if (error) {
    document.getElementById('saveMessage').innerHTML = '<span class="error">Error: ' + error.message + '</span>';
  } else {
    document.getElementById('saveMessage').innerHTML = '<span class="success">Settings saved!</span>';
    setTimeout(() => { document.getElementById('saveMessage').innerHTML = ''; }, 3000);
  }
}

async function loadSettings() {
  if (!sb || !tenantId) return;
  
  const { data, error } = await sb.from('business_settings').select('*').eq('tenant_id', tenantId).single();
  
  if (data) {
    document.getElementById('businessName').value = data.business_name || '';
    document.getElementById('contactName').value = data.contact_name || '';
    document.getElementById('contactEmail').value = data.contact_email || '';
    document.getElementById('contactPhone').value = data.contact_phone || '';
    document.getElementById('businessAddress').value = data.address || '';
    document.getElementById('businessCityStateZip').value = data.city_state_zip || '';
    document.getElementById('localTax').value = data.tax_rate || '';
  }
}

// =====================================================
// INITIALIZATION
// =====================================================

async function init() {
  await initSupabase();
  if (sb && tenantId) {
    loadSettings();
    loadEmployeesSection();
  }
}

init();
</script>
</body>
</html>
