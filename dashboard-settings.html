<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <link rel="stylesheet" href="theme-system.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin:0; padding:0; font-family:system-ui; background:var(--bg-primary, #0b0f14); color:var(--text-primary, #e8eef6); padding-bottom: 165px; }
    h1 { margin:0; font-size:40px; }
    h2 { margin:18px 0 10px; font-size:18px; }

    button {
      padding:8px 14px;
      border-radius:10px;
      border:1px solid var(--border-default, #2a3b55);
      background:var(--bg-card, #1a2535);
      color:var(--text-primary, #fff);
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover { background:var(--bg-hover, #243648); }

    .card {
      background:var(--bg-secondary, #0f1621);
      border:1px solid var(--border-default, #223044);
      border-radius:14px;
      padding:20px;
      margin-bottom:16px;
    }

    .setting-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid var(--border-default, #223044);
    }

    .setting-row:last-child {
      border-bottom:none;
    }

    .setting-label {
      font-size:14px;
      font-weight:500;
    }

    .setting-description {
      font-size:12px;
      color:var(--text-secondary, #9fb0c3);
      margin-top:4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    input[type="url"],
    input[type="file"],
    input[type="date"],
    input[type="color"],
    textarea,
    select {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border-default, #223044);
      background:var(--bg-card, #1a2535);
      color:var(--text-primary, #e8eef6);
      width:200px;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    input[type="color"] {
      padding: 4px;
      width: 60px;
      height: 40px;
      cursor: pointer;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    input[type="file"] {
      padding:6px 12px;
      font-size:12px;
    }

    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:var(--accent-primary, #3b82f6);
    }

    .save-btn {
      background:var(--accent-primary, #3b82f6);
      border-color:var(--accent-primary, #3b82f6);
      margin-top:16px;
      color:white;
    }

    .save-btn:hover {
      background:var(--accent-light, #2563eb);
    }

    .muted {
      font-size:12px;
      color:var(--text-secondary, #9fb0c3);
      margin-top:4px;
    }

    .success {
      color:#4ade80;
      font-size:12px;
      margin-top:8px;
    }

    .error {
      color:#ef4444;
      font-size:12px;
      margin-top:8px;
    }

    .employee-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .employee-card {
      background: var(--bg-primary, #0b0f14);
      border: 1px solid var(--border-default, #223044);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .employee-card:hover {
      border-color: var(--accent-primary, #3b82f6);
      transform: translateY(-2px);
    }

    .employee-avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      border: 2px solid var(--border-default, #223044);
      background: var(--bg-secondary, #0f1621);
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      color: var(--text-primary, #e8eef6);
      overflow: hidden;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .employee-avatar-preview:hover {
      border-color: var(--accent-primary, #3b82f6);
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .employee-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .employee-role {
      font-size: 11px;
      color: var(--text-secondary, #9fb0c3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .employee-stats {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-default, #223044);
      text-align: left;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .stat-label {
      color: var(--text-secondary, #9fb0c3);
    }

    .stat-value {
      color: var(--text-primary, #e8eef6);
      font-weight: 600;
    }

    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 0;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
    }

    .accordion-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .accordion-icon {
      font-size: 20px;
      color: var(--text-secondary, #9fb0c3);
      transition: transform 0.2s ease;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion-content.active {
      max-height: 5000px;
    }

    .accordion-inner {
      padding-top: 16px;
    }

    .icon-nav-bar {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding: 6px;
      background: rgba(15, 22, 33, 0.5);
      border-radius: 10px;
      border: 1px solid var(--border-default, #223044);
    }

    .icon-nav-btn {
      flex: 1;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      background: transparent;
      padding: 0;
    }

    .icon-nav-primary {
      color: #6b7280;
    }

    .icon-nav-primary:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--accent-primary, #3b82f6);
      color: var(--accent-primary, #3b82f6);
    }

    .icon-nav-danger {
      color: #6b7280;
    }

    .icon-nav-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }

    .icon-nav-btn:active {
      transform: scale(0.95);
    }

    input[type="file"].hidden {
      display: none;
    }
    
    /* Logo/Image Preview */
    .image-preview-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo-preview {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      border: 2px dashed var(--border-default, #223044);
      background: var(--bg-card, #1a2535);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .logo-preview:hover {
      border-color: var(--accent-primary, #3b82f6);
    }
    
    .logo-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .logo-preview-placeholder {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .social-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .social-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
      border-radius: 6px;
      font-size: 16px;
    }

    /* Appointment Type Styles */
    .appointment-type-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary, #0b0f14);
      border: 1px solid var(--border-default, #223044);
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .appointment-type-row:hover {
      border-color: var(--accent-primary, #3b82f6);
    }

    /* Mobile Header with Hamburger */
    .mobile-top-header {
      display: none;
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-secondary, #0f1621);
      border-bottom: 1px solid var(--border-default, #223044);
    }

    .mobile-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
    }

    .mobile-menu-toggle {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: #6b7280;
      font-size: 20px;
      padding: 0;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .mobile-menu-toggle:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--accent-primary, #3b82f6);
      color: var(--accent-primary, #3b82f6);
    }

    .mobile-menu-toggle:active {
      transform: scale(0.95);
    }

    .mobile-header-center {
      flex: 1;
      margin-left: 12px;
    }

    .mobile-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .mobile-header-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .mobile-header-content.expanded {
      max-height: 200px;
    }

    .mobile-header-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 8px 12px 12px;
      background: var(--bg-primary, #0b0f14);
      border-top: 1px solid var(--border-default, #223044);
    }

    .mobile-header-actions button {
      padding: 10px;
      font-size: 13px;
      background: var(--bg-card, #1a2535);
      border: 1px solid var(--accent-primary, #3b82f6);
      transition: all 0.2s;
    }

    .mobile-header-actions button:active {
      background: var(--bg-hover, #243648);
    }

    .accordion-icon-header {
      font-size: 20px;
      color: var(--text-secondary, #9fb0c3);
      transition: transform 0.2s ease;
    }

    .mobile-menu-toggle.active .accordion-icon-header {
      transform: rotate(180deg);
    }

    /* Mobile Bottom Nav - Matching Business Page */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary, #0f1621);
      padding: 8px;
      z-index: 100;
    }
    
    .mobile-nav-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .mobile-nav-secondary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    
    .mobile-nav-btn {
      padding: 10px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-default, #223044);
      background: var(--bg-card, #1a2535);
      color: var(--text-secondary, #9fb0c3);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }
    
    .mobile-nav-grid .mobile-nav-btn {
      background: var(--bg-hover, #1f2e40);
    }

    .mobile-nav-btn.active {
      background: var(--accent-primary, #3b82f6);
      border-color: var(--accent-primary, #3b82f6);
      color: #fff;
    }

    @media (max-width: 768px) {
      .desktop-header { display: none !important; }
      .mobile-top-header { display: block; }
      .mobile-bottom-nav { display: block; }
      
      h1 {
        font-size: 24px !important;
      }
      
      .setting-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="tel"],
      input[type="url"],
      input[type="file"],
      textarea,
      select { width: 100%; }
      .employee-grid { grid-template-columns: 1fr; }
      
      .appointment-type-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .apt-type-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-top-header { display: none !important; }
      .mobile-bottom-nav { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- Mobile Top Header -->
  <div class="mobile-top-header">
    <div class="mobile-header-bar">
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu(this)">
        <span class="accordion-icon-header">â˜°</span>
      </button>
      <div class="mobile-header-center">
        <div class="mobile-header-title">Settings</div>
      </div>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
    </div>
    
    <div class="mobile-header-content" id="mobileHeaderContent">
      <div class="mobile-header-actions">
        <button onclick="location.href='dashboard-service.html'">Service</button>
        <button onclick="location.href='dashboard-parts.html'">Parts</button>
        <button onclick="location.href='dashboard-sales.html'">Sales</button>
      </div>
    </div>
  </div>

  <!-- Desktop Sticky Header -->
  <div class="desktop-header" style="position:sticky; top:0; z-index:100; background:var(--bg-primary); border-bottom:1px solid var(--border-default);">
    <div style="padding:16px 24px 8px; display:flex; justify-content:space-between; align-items:center;">
      <h1 style="margin:0; font-size:32px; font-weight:600;">Settings</h1>
      <a onclick="logout()" style="color:var(--text-secondary); cursor:pointer; font-size:14px; text-decoration:none;">Logout</a>
    </div>
    
    <div style="padding:0 24px 12px;">
      <nav style="display:flex; gap:24px; overflow-x:auto;">
        <a href="dashboard-business.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Business</a>
        <a href="dashboard-customer-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Customers</a>
        <a href="dashboard-vehicle-search.html" style="padding:12px 0; color:var(--text-secondary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid transparent;">Vehicles</a>
        <a href="dashboard-settings.html" style="padding:12px 0; color:var(--accent-primary); text-decoration:none; font-size:14px; white-space:nowrap; border-bottom:2px solid var(--accent-primary);">Settings</a>
      </nav>
    </div>
    
    <div style="padding:0 24px 12px; border-top:1px solid var(--border-default); padding-top:12px;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="location.href='dashboard-service.html'">Service</button>
        <button onclick="location.href='dashboard-parts.html'">Parts</button>
        <button onclick="location.href='dashboard-sales.html'">Sales</button>
      </div>
    </div>
  </div>

  <!-- Mobile Bottom Navigation - Matching Scheduler -->
  <div class="mobile-bottom-nav">
    <div class="mobile-nav-grid">
      <a href="dashboard-business.html" class="mobile-nav-btn">Business</a>
      <a href="dashboard-customer-search.html" class="mobile-nav-btn">Customers</a>
      <a href="dashboard-vehicle-search.html" class="mobile-nav-btn">Vehicles</a>
      <a href="dashboard-settings.html" class="mobile-nav-btn active">Settings</a>
    </div>
    <div class="mobile-nav-secondary">
      <a href="dashboard-service.html" class="mobile-nav-btn">Service</a>
      <a href="dashboard-parts.html" class="mobile-nav-btn">Parts</a>
      <a href="dashboard-sales.html" class="mobile-nav-btn">Sales</a>
    </div>
  </div>

  <!-- Main Content -->
  <div style="padding:24px;">

  <!-- BUSINESS DEPARTMENT -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Business</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        
        <!-- Company Information -->
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Company Information</h3>
        
        <div class="setting-row">
          <div>
            <div class="setting-label">Business Name</div>
            <div class="setting-description">Your company or shop name</div>
          </div>
          <input type="text" id="businessName" placeholder="Business Name" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Name</div>
            <div class="setting-description">Primary contact person name</div>
          </div>
          <input type="text" id="contactName" placeholder="Contact Name" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Email</div>
            <div class="setting-description">Primary contact email</div>
          </div>
          <input type="email" id="contactEmail" placeholder="email@example.com" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Contact Phone</div>
            <div class="setting-description">Auto-formats to XXX-XXX-XXXX</div>
          </div>
          <input type="tel" id="contactPhone" placeholder="555-555-5555" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Business Address</div>
            <div class="setting-description">Street address</div>
          </div>
          <input type="text" id="businessAddress" placeholder="123 Main St" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">City, State ZIP</div>
          </div>
          <input type="text" id="businessCityStateZip" placeholder="Redding, CA 96001" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Business Hours</div>
            <div class="setting-description">Displayed to customers</div>
          </div>
          <input type="text" id="businessHours" placeholder="Monâ€“Fri 8amâ€“5pm" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Shop Phone</div>
            <div class="setting-description">Public phone (auto-formats)</div>
          </div>
          <input type="tel" id="shopPhone" placeholder="530-555-1234" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Website</div>
          </div>
          <input type="text" id="websiteUrl" placeholder="https://yourshop.com" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Business License #</div>
          </div>
          <input type="text" id="licenseNumber" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Tax ID / EIN</div>
          </div>
          <input type="text" id="taxId" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Local Sales Tax</div>
            <div class="setting-description">Sales tax percentage (%)</div>
          </div>
          <input type="number" id="localTax" min="0" max="100" step="0.01" placeholder="8.5" />
        </div>

        <!-- Payroll Settings -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Payroll Settings</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Pay Period Type</div>
            <div class="setting-description">How often employees are paid</div>
          </div>
          <select id="payPeriodType" onchange="updatePayPeriodStartOptions()">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Bi-Weekly (Every 2 weeks)</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>

        <div class="setting-row" id="payPeriodStartRow">
          <div>
            <div class="setting-label">Pay Period Start</div>
            <div class="setting-description" id="payPeriodStartDesc">Week starts on...</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="payPeriodStart">
              <option value="0">Sunday</option>
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
            <input type="date" id="payPeriodStartDate" style="width:160px; display:none;" />
          </div>
        </div>

        <!-- Invoicing -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Invoicing & Payments</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Invoice Prefix</div>
          </div>
          <input type="text" id="invoicePrefix" placeholder="INV-" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Next Invoice Number</div>
          </div>
          <input type="number" id="nextInvoiceNumber" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Payment Terms</div>
          </div>
          <input type="text" id="paymentTerms" placeholder="Due on receipt / Net 30" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Invoice Footer Text</div>
          </div>
          <input type="text" id="invoiceFooter" placeholder="Thank you for your business" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Payment Instructions</div>
          </div>
          <input type="text" id="paymentInstructions" placeholder="Pay online or in person" />
        </div>

        <!-- Customer Notifications -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Customer Notifications</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Customer Portal</div>
          </div>
          <select id="customerPortalEnabled">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Auto-Send Estimates</div>
          </div>
          <select id="autoSendEstimates">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Auto-Send Invoices</div>
          </div>
          <select id="autoSendInvoices">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">SMS Notifications</div>
          </div>
          <select id="smsNotificationsEnabled">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Email Notifications</div>
          </div>
          <select id="emailNotificationsEnabled">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Reminder Timing</div>
          </div>
          <select id="reminderTiming">
            <option value="24">24 hours before</option>
            <option value="12">12 hours before</option>
            <option value="2">2 hours before</option>
          </select>
        </div>

        <!-- Account Info -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Account Information</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Logged in as</div>
            <div class="setting-description" id="userEmail">Loading...</div>
          </div>
        </div>

        <button class="save-btn" onclick="saveAllSettings()">Save Business Settings</button>
        <div id="saveMessage"></div>
      </div>
    </div>
  </div>

  <!-- EMPLOYEES SECTION -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Employees</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Employee Management</h3>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <div class="setting-description">
            Manage employee photos, compensation, schedules, and profile information.
          </div>
          <button onclick="location.href='employee-edit.html?new=true'">+ Add Employee</button>
        </div>
        
        <!-- Employee Filters -->
        <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
          <select id="employeeFilterDept" onchange="filterEmployees()" style="width:auto;">
            <option value="">All Departments</option>
            <option value="service">Service</option>
            <option value="sales">Sales</option>
            <option value="parts">Parts</option>
            <option value="admin">Admin</option>
          </select>
          <select id="employeeFilterStatus" onchange="filterEmployees()" style="width:auto;">
            <option value="active">Active Only</option>
            <option value="inactive">Inactive Only</option>
            <option value="">All Status</option>
          </select>
        </div>
        
        <div id="employeeAvatars" class="employee-grid">
          <div style="text-align:center; color:var(--text-secondary); padding:20px;">Loading employees...</div>
        </div>
        <div id="avatarMessage"></div>
        
        <!-- Payroll Quick Stats -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Payroll Overview</h3>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="totalEmployees">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Total Employees</div>
          </div>
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="activeEmployees">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Active</div>
          </div>
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="serviceTechs">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Service Techs</div>
          </div>
          <div style="background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; text-align:center;">
            <div style="font-size:24px; font-weight:700;" id="salesStaff">0</div>
            <div style="font-size:12px; color:var(--text-secondary);">Sales Staff</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APPOINTMENT TYPES SECTION (NEW) -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Appointment Types</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        
        <!-- Industry Preset Selector -->
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Industry Presets</h3>
        
        <div class="setting-row">
          <div>
            <div class="setting-label">Industry Type</div>
            <div class="setting-description">Select a preset to load default appointment types for your industry</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <select id="industryPreset" style="width:180px;">
              <option value="auto">Auto Dealer</option>
              <option value="motorcycle">Motorcycle / Powersports</option>
              <option value="marine">Marine / Jet Ski</option>
              <option value="field_sales">Traveling Sales</option>
              <option value="political">Political / Canvassing</option>
            </select>
            <button onclick="loadIndustryPreset()">Apply Preset</button>
          </div>
        </div>
        
        <div class="setting-description" style="margin-top:8px; padding:12px; background:rgba(59,130,246,0.1); border-radius:8px; border:1px solid rgba(59,130,246,0.2);">
          <strong>Note:</strong> Applying a preset will add new appointment types. Your existing custom types will not be deleted.
        </div>

        <!-- Current Appointment Types -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Your Appointment Types</h3>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:8px;">
          <div class="setting-description">
            Manage appointment types used in scheduling.
          </div>
          <button onclick="showAddAppointmentTypeForm()">+ Add Type</button>
        </div>

        <!-- Add/Edit Form -->
        <div id="appointmentTypeForm" style="display:none; background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; margin-bottom:16px;">
          <h3 style="margin:0 0 12px; font-size:16px;" id="appointmentTypeFormTitle">Add Appointment Type</h3>
          <input type="hidden" id="editingAppointmentTypeId" />
          
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
            <div>
              <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Name *</label>
              <input type="text" id="aptTypeName" placeholder="Test Drive" style="width:100%;" />
            </div>
            <div>
              <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Duration (minutes)</label>
              <input type="number" id="aptTypeDuration" min="5" step="5" placeholder="30" style="width:100%;" />
            </div>
            <div>
              <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Color</label>
              <input type="color" id="aptTypeColor" value="#3b82f6" style="width:60px; height:38px; padding:2px;" />
            </div>
          </div>
          
          <div style="margin-top:12px;">
            <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Description</label>
            <input type="text" id="aptTypeDescription" placeholder="Brief description of this appointment type" style="width:100%;" />
          </div>
          
          <div style="display:flex; gap:8px; margin-top:12px;">
            <button class="save-btn" style="margin-top:0;" onclick="saveAppointmentType()">Save</button>
            <button onclick="cancelAppointmentTypeForm()">Cancel</button>
          </div>
          <div id="appointmentTypeFormMessage"></div>
        </div>

        <!-- Appointment Types List -->
        <div id="appointmentTypesList" style="display:grid; gap:8px;">
          <div style="text-align:center; color:var(--text-secondary); padding:20px;">Loading appointment types...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MEDIA SECTION -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Media</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        
        <!-- Branding -->
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Branding & Logo</h3>
        
        <div class="setting-row">
          <div>
            <div class="setting-label">Business Logo</div>
            <div class="setting-description">Appears on invoices, estimates, and customer portal</div>
          </div>
          <div class="image-preview-container">
            <div class="logo-preview" onclick="document.getElementById('logoUpload').click()">
              <div class="logo-preview-placeholder" id="logoPreviewContent">
                <div style="font-size:24px; margin-bottom:4px;">ðŸ“·</div>
                <div>Click to upload</div>
              </div>
            </div>
            <input type="file" id="logoUpload" accept="image/*" style="display:none;" onchange="previewLogo(this)" />
          </div>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Favicon</div>
            <div class="setting-description">Small icon shown in browser tabs (32x32px recommended)</div>
          </div>
          <div class="image-preview-container">
            <div class="logo-preview" style="width:64px; height:64px;" onclick="document.getElementById('faviconUpload').click()">
              <div class="logo-preview-placeholder" id="faviconPreviewContent">
                <div style="font-size:16px;">ðŸ”·</div>
              </div>
            </div>
            <input type="file" id="faviconUpload" accept="image/*" style="display:none;" onchange="previewFavicon(this)" />
          </div>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Primary Brand Color</div>
            <div class="setting-description">Used for buttons and accents on customer-facing pages</div>
          </div>
          <input type="color" id="brandColorPrimary" value="#3b82f6" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Secondary Brand Color</div>
            <div class="setting-description">Used for highlights and secondary elements</div>
          </div>
          <input type="color" id="brandColorSecondary" value="#1e40af" />
        </div>

        <!-- Social Media -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Social Media</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Facebook</div>
            <div class="setting-description">Your Facebook page URL</div>
          </div>
          <input type="url" id="socialFacebook" placeholder="https://facebook.com/yourpage" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Instagram</div>
            <div class="setting-description">Your Instagram profile</div>
          </div>
          <input type="url" id="socialInstagram" placeholder="https://instagram.com/yourhandle" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">YouTube</div>
            <div class="setting-description">Your YouTube channel</div>
          </div>
          <input type="url" id="socialYouTube" placeholder="https://youtube.com/@yourchannel" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">TikTok</div>
            <div class="setting-description">Your TikTok profile</div>
          </div>
          <input type="url" id="socialTikTok" placeholder="https://tiktok.com/@yourhandle" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">X (Twitter)</div>
            <div class="setting-description">Your X/Twitter profile</div>
          </div>
          <input type="url" id="socialTwitter" placeholder="https://x.com/yourhandle" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">LinkedIn</div>
            <div class="setting-description">Your company LinkedIn page</div>
          </div>
          <input type="url" id="socialLinkedIn" placeholder="https://linkedin.com/company/yourcompany" />
        </div>

        <!-- Review Platforms -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Review Platforms</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Google Business Profile</div>
            <div class="setting-description">Link to your Google Business listing</div>
          </div>
          <input type="url" id="googleBusinessUrl" placeholder="https://g.page/yourbusiness" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Yelp Page</div>
            <div class="setting-description">Link to your Yelp business page</div>
          </div>
          <input type="url" id="yelpUrl" placeholder="https://yelp.com/biz/yourbusiness" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">CarFax Service</div>
            <div class="setting-description">CarFax service shop link</div>
          </div>
          <input type="url" id="carfaxUrl" placeholder="https://carfax.com/..." />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">RepairPal</div>
            <div class="setting-description">RepairPal shop listing</div>
          </div>
          <input type="url" id="repairpalUrl" placeholder="https://repairpal.com/..." />
        </div>

        <!-- Marketing -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Marketing & Media</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Promo Video URL</div>
            <div class="setting-description">YouTube/Vimeo link for promotional video</div>
          </div>
          <input type="url" id="promoVideoUrl" placeholder="https://youtube.com/watch?v=..." />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Virtual Tour URL</div>
            <div class="setting-description">Google 360Â° or Matterport tour link</div>
          </div>
          <input type="url" id="virtualTourUrl" placeholder="https://..." />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Tagline / Slogan</div>
            <div class="setting-description">Short tagline for marketing materials</div>
          </div>
          <input type="text" id="businessTagline" placeholder="Your trusted local experts!" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">About Us (Short)</div>
            <div class="setting-description">Brief description for listings and social media</div>
          </div>
          <textarea id="aboutUsShort" placeholder="Family-owned since 1995. We specialize in..." style="width:300px;"></textarea>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">About Us (Full)</div>
            <div class="setting-description">Detailed description for website</div>
          </div>
          <textarea id="aboutUsFull" placeholder="Complete business story and description..." style="width:300px; min-height:120px;"></textarea>
        </div>

        <!-- Gallery -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Photo Gallery</h3>

        <div class="setting-description" style="margin-bottom:12px;">
          Upload photos of your shop, team, and work to display on your customer portal and marketing materials.
        </div>

        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:12px; margin-bottom:16px;" id="galleryGrid">
          <div class="logo-preview" style="width:100%; height:100px;" onclick="document.getElementById('galleryUpload').click()">
            <div class="logo-preview-placeholder">
              <div style="font-size:20px; margin-bottom:4px;">+</div>
              <div style="font-size:11px;">Add Photo</div>
            </div>
          </div>
        </div>
        <input type="file" id="galleryUpload" accept="image/*" multiple style="display:none;" onchange="handleGalleryUpload(this)" />

        <button class="save-btn" onclick="saveMediaSettings()">Save Media Settings</button>
        <div id="mediaSaveMessage"></div>
      </div>
    </div>
  </div>

  <!-- SERVICE DEPARTMENT -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Service</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <!-- Service Pricing -->
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Pricing & Rates</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Labor Rate</div>
            <div class="setting-description">Hourly rate ($/hr)</div>
          </div>
          <input type="number" id="laborRate" min="0" step="1" placeholder="125" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Shop Supply Fee ($)</div>
          </div>
          <input type="number" id="shopSupplyFee" step="0.01" placeholder="12.00" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Environmental Fee ($)</div>
          </div>
          <input type="number" id="environmentalFee" step="0.01" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Hazmat Fee ($)</div>
          </div>
          <input type="number" id="hazmatFee" step="0.01" />
        </div>

        <!-- Work Order Defaults -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Work Order Defaults</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Default Work Order Status</div>
          </div>
          <select id="defaultWorkOrderStatus">
            <option value="draft">Draft</option>
            <option value="scheduled">Scheduled</option>
            <option value="diagnosis_required">Diagnosis Required</option>
            <option value="awaiting_parts">Awaiting Parts</option>
            <option value="customer_approval">Customer Approval</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Default Priority</div>
          </div>
          <select id="defaultWorkOrderPriority">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Require Customer Approval</div>
          </div>
          <select id="requireCustomerApproval">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Auto-Assign Technician</div>
          </div>
          <select id="autoAssignTechnician">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Warranty Period (Days)</div>
          </div>
          <input type="number" id="defaultWarrantyDays" min="0" placeholder="90" />
        </div>

        <!-- Labor Codes Library -->
        <h3 style="font-size:15px; margin:24px 0 12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Labor Codes Library</h3>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <div class="setting-description">
            Create labor codes for common jobs with preset descriptions, hours, and rates.
          </div>
          <button onclick="showAddLaborCodeForm()">+ Add Labor Code</button>
        </div>

        <div id="laborCodeForm" style="display:none; background:var(--bg-primary); border:1px solid var(--border-default); border-radius:8px; padding:16px; margin-bottom:16px;">
          <h3 style="margin:0 0 12px; font-size:16px;" id="laborCodeFormTitle">Add Labor Code</h3>
          <input type="hidden" id="editingLaborCodeId" />
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
            <div>
              <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Code*</label>
              <input type="text" id="newLaborCode" placeholder="BRKPAD-F" style="width:100%;" />
            </div>
            <div>
              <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Category</label>
              <input type="text" id="newLaborCategory" placeholder="Brakes" style="width:100%;" />
            </div>
            <div>
              <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Standard Hours</label>
              <input type="number" id="newLaborHours" step="0.1" min="0" placeholder="1.5" style="width:100%;" />
            </div>
            <div>
              <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Rate ($/hr)</label>
              <input type="number" id="newLaborRate" step="1" min="0" placeholder="125" style="width:100%;" />
            </div>
          </div>
          <div style="margin-top:12px;">
            <label style="font-size:12px; color:var(--text-secondary); display:block; margin-bottom:4px;">Description*</label>
            <input type="text" id="newLaborDescription" placeholder="Replace Front Brake Pads" style="width:100%;" />
          </div>
          <div style="display:flex; gap:8px; margin-top:12px;">
            <button class="save-btn" onclick="saveLaborCode()">Save Labor Code</button>
            <button onclick="cancelLaborCodeForm()">Cancel</button>
          </div>
          <div id="laborCodeFormMessage"></div>
        </div>

        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:1px solid #223044;">
                <th style="text-align:left; padding:8px; font-size:12px; color:var(--text-secondary); font-weight:500;">CODE</th>
                <th style="text-align:left; padding:8px; font-size:12px; color:var(--text-secondary); font-weight:500;">DESCRIPTION</th>
                <th style="text-align:left; padding:8px; font-size:12px; color:var(--text-secondary); font-weight:500;">CATEGORY</th>
                <th style="text-align:right; padding:8px; font-size:12px; color:var(--text-secondary); font-weight:500;">HOURS</th>
                <th style="text-align:right; padding:8px; font-size:12px; color:var(--text-secondary); font-weight:500;">RATE</th>
                <th style="text-align:right; padding:8px; font-size:12px; color:var(--text-secondary); font-weight:500;">TOTAL</th>
                <th style="text-align:center; padding:8px; font-size:12px; color:var(--text-secondary); font-weight:500; width:100px;">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="laborCodesTable">
              <tr><td colspan="7" style="text-align:center; padding:20px; color:var(--text-secondary);">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- PARTS DEPARTMENT -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Parts</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Parts Pricing & Inventory</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Parts Markup (%)</div>
            <div class="setting-description">Default markup percentage</div>
          </div>
          <input type="number" id="partsMarkup" step="0.01" placeholder="30" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Low Stock Threshold</div>
            <div class="setting-description">Alert when quantity below this</div>
          </div>
          <input type="number" id="lowStockThreshold" min="0" placeholder="5" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Auto-Order Parts</div>
            <div class="setting-description">Automatically create PO when low</div>
          </div>
          <select id="autoOrderParts">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Default Vendor</div>
          </div>
          <input type="text" id="defaultVendor" placeholder="Primary Parts Supplier" />
        </div>
      </div>
    </div>
  </div>

  <!-- SALES DEPARTMENT -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Sales</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Sales Settings</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Commission Rate (%)</div>
            <div class="setting-description">Default sales commission</div>
          </div>
          <input type="number" id="commissionRate" step="0.01" placeholder="5" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Max Discount (%)</div>
            <div class="setting-description">Maximum allowed discount</div>
          </div>
          <input type="number" id="maxDiscount" step="0.01" placeholder="15" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Quote Validity (Days)</div>
            <div class="setting-description">How long quotes remain valid</div>
          </div>
          <input type="number" id="quoteValidDays" min="1" placeholder="30" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Auto-Follow-Up</div>
            <div class="setting-description">Send follow-up reminders</div>
          </div>
          <select id="autoFollowUp">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- RENTALS DEPARTMENT -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Rentals</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <h3 style="font-size:15px; margin-bottom:12px; color:var(--accent-light); border-bottom:1px solid var(--border-default); padding-bottom:8px;">Rental Settings</h3>

        <div class="setting-row">
          <div>
            <div class="setting-label">Enable Rentals</div>
            <div class="setting-description">Offer vehicle/equipment rentals</div>
          </div>
          <select id="rentalsEnabled">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Daily Rate</div>
            <div class="setting-description">Base daily rental rate</div>
          </div>
          <input type="number" id="rentalDailyRate" step="1" placeholder="50" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Security Deposit</div>
            <div class="setting-description">Default deposit amount</div>
          </div>
          <input type="number" id="rentalDeposit" step="1" placeholder="200" />
        </div>

        <div class="setting-row">
          <div>
            <div class="setting-label">Late Fee (Per Day)</div>
          </div>
          <input type="number" id="rentalLateFee" step="1" placeholder="25" />
        </div>
      </div>
    </div>
  </div>

  <!-- APPEARANCE & THEMES -->
  <div class="card">
    <button class="accordion-header" onclick="toggleAccordion(this)">
      <h2>Appearance & Themes</h2>
      <span class="accordion-icon">â–¼</span>
    </button>
    <div class="accordion-content">
      <div class="accordion-inner">
        <div class="setting-description" style="margin-bottom:16px;">
          Choose your preferred color scheme. Changes apply instantly across all pages.
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:16px; margin-top:20px;">
          <div style="background:#0f1621; border:3px solid var(--accent-primary); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-blue')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:var(--bg-primary);">
              <div style="flex:1; border-radius:4px; background:#1a2535;"></div>
              <div style="flex:1; border-radius:4px; background:#3b82f6;"></div>
              <div style="flex:1; border-radius:4px; background:#60a5fa;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Blue</div>
            <div style="font-size:11px; color:var(--text-secondary);">Default</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-green')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#0a1410;">
              <div style="flex:1; border-radius:4px; background:#1a2f25;"></div>
              <div style="flex:1; border-radius:4px; background:#10b981;"></div>
              <div style="flex:1; border-radius:4px; background:#34d399;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Green</div>
            <div style="font-size:11px; color:var(--text-secondary);">Forest</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-purple')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#100b14;">
              <div style="flex:1; border-radius:4px; background:#2d1a35;"></div>
              <div style="flex:1; border-radius:4px; background:#8b5cf6;"></div>
              <div style="flex:1; border-radius:4px; background:#a78bfa;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Purple</div>
            <div style="font-size:11px; color:var(--text-secondary);">Violet</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-grey')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#0f0f0f;">
              <div style="flex:1; border-radius:4px; background:#252525;"></div>
              <div style="flex:1; border-radius:4px; background:#6b7280;"></div>
              <div style="flex:1; border-radius:4px; background:#9ca3af;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Grey</div>
            <div style="font-size:11px; color:var(--text-secondary);">Monochrome</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-teal')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#0a1214;">
              <div style="flex:1; border-radius:4px; background:#1a3035;"></div>
              <div style="flex:1; border-radius:4px; background:#14b8a6;"></div>
              <div style="flex:1; border-radius:4px; background:#2dd4bf;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Teal</div>
            <div style="font-size:11px; color:var(--text-secondary);">Ocean</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('dark-crimson')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#140a0b;">
              <div style="flex:1; border-radius:4px; background:#351a1d;"></div>
              <div style="flex:1; border-radius:4px; background:#dc2626;"></div>
              <div style="flex:1; border-radius:4px; background:#ef4444;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Dark Crimson</div>
            <div style="font-size:11px; color:var(--text-secondary);">Burgundy</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('light-blue')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#f8fafc;">
              <div style="flex:1; border-radius:4px; background:#f1f5f9;"></div>
              <div style="flex:1; border-radius:4px; background:#3b82f6;"></div>
              <div style="flex:1; border-radius:4px; background:#2563eb;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Light Blue</div>
            <div style="font-size:11px; color:var(--text-secondary);">Sky</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('light-green')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#f7fef9;">
              <div style="flex:1; border-radius:4px; background:#f0fdf4;"></div>
              <div style="flex:1; border-radius:4px; background:#10b981;"></div>
              <div style="flex:1; border-radius:4px; background:#059669;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Light Green</div>
            <div style="font-size:11px; color:var(--text-secondary);">Mint</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('light-purple')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#faf5ff;">
              <div style="flex:1; border-radius:4px; background:#f5f3ff;"></div>
              <div style="flex:1; border-radius:4px; background:#8b5cf6;"></div>
              <div style="flex:1; border-radius:4px; background:#7c3aed;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Light Purple</div>
            <div style="font-size:11px; color:var(--text-secondary);">Lavender</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('light-grey')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#fafafa;">
              <div style="flex:1; border-radius:4px; background:#f5f5f5;"></div>
              <div style="flex:1; border-radius:4px; background:#6b7280;"></div>
              <div style="flex:1; border-radius:4px; background:#4b5563;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Light Grey</div>
            <div style="font-size:11px; color:var(--text-secondary);">Slate</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('light-teal')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#f0fdfa;">
              <div style="flex:1; border-radius:4px; background:#ccfbf1;"></div>
              <div style="flex:1; border-radius:4px; background:#14b8a6;"></div>
              <div style="flex:1; border-radius:4px; background:#0d9488;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Light Teal</div>
            <div style="font-size:11px; color:var(--text-secondary);">Aqua</div>
          </div>
          
          <div style="background:var(--bg-secondary); border:3px solid var(--border-default); border-radius:12px; padding:16px; cursor:pointer; text-align:center; transition:all 0.2s;" onclick="setTheme('light-crimson')">
            <div style="width:100%; height:70px; border-radius:8px; margin-bottom:12px; display:flex; gap:4px; padding:8px; background:#fef2f2;">
              <div style="flex:1; border-radius:4px; background:#fee2e2;"></div>
              <div style="flex:1; border-radius:4px; background:#dc2626;"></div>
              <div style="flex:1; border-radius:4px; background:#b91c1c;"></div>
            </div>
            <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Light Crimson</div>
            <div style="font-size:11px; color:var(--text-secondary);">Rose</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>
  <!-- End Main Content -->

<script src="dashboard-settings.js"></script>

<script>
function toggleMobileMenu(button) {
  const content = document.getElementById('mobileHeaderContent');
  content.classList.toggle('expanded');
  button.classList.toggle('active');
}

function toggleAccordion(button){
  const content = button.nextElementSibling;
  button.classList.toggle('active');
  content.classList.toggle('active');
}

function logout(){
  localStorage.removeItem("sb_access_token");
  location.replace("login.html");
}

function setTheme(theme) {
  localStorage.setItem('app-theme', theme);
  document.documentElement.setAttribute('data-theme', theme);
  
  const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
  const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-default').trim();
  
  document.querySelectorAll('[onclick^="setTheme"]').forEach(card => {
    if(card.getAttribute('onclick').includes(theme)) {
      card.style.borderColor = accentColor;
      card.style.boxShadow = `0 0 0 3px rgba(59, 130, 246, 0.1)`;
    } else {
      card.style.borderColor = borderColor;
      card.style.boxShadow = 'none';
    }
  });
}

function loadTheme() {
  const savedTheme = localStorage.getItem('app-theme') || 'dark-blue';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  setTimeout(() => {
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
    const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-default').trim();
    
    document.querySelectorAll('[onclick^="setTheme"]').forEach(card => {
      if(card.getAttribute('onclick').includes(savedTheme)) {
        card.style.borderColor = accentColor;
        card.style.boxShadow = `0 0 0 3px rgba(59, 130, 246, 0.1)`;
      } else {
        card.style.borderColor = borderColor;
      }
    });
  }, 100);
}

// Media preview functions
function previewLogo(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('logoPreviewContent').innerHTML = '<img src="' + e.target.result + '" alt="Logo" />';
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function previewFavicon(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('faviconPreviewContent').innerHTML = '<img src="' + e.target.result + '" alt="Favicon" style="width:32px; height:32px;" />';
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function handleGalleryUpload(input) {
  if (input.files && input.files.length > 0) {
    const grid = document.getElementById('galleryGrid');
    
    for (let i = 0; i < input.files.length; i++) {
      const file = input.files[i];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const newPhoto = document.createElement('div');
        newPhoto.className = 'logo-preview';
        newPhoto.style.width = '100%';
        newPhoto.style.height = '100px';
        newPhoto.innerHTML = '<img src="' + e.target.result + '" alt="Gallery photo" style="width:100%; height:100%; object-fit:cover;" />';
        grid.insertBefore(newPhoto, grid.lastElementChild);
      };
      reader.readAsDataURL(file);
    }
  }
}

function saveMediaSettings() {
  const msg = document.getElementById('mediaSaveMessage');
  msg.innerHTML = '<span class="success">Media settings saved!</span>';
  setTimeout(() => { msg.innerHTML = ''; }, 3000);
}

// Load theme on page load
loadTheme();

// =====================================================
// EMPLOYEE MANAGEMENT
// =====================================================

async function loadEmployeesSection() {
  const supabaseUrl = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
  const supabaseKey = document.querySelector('meta[name="supabase-anon-key"]').content;
  const token = localStorage.getItem('sb_access_token');
  
  if (!token) return;
  
  const sb = supabase.createClient(supabaseUrl, supabaseKey, {
    global: { headers: { Authorization: 'Bearer ' + token } }
  });
  
  const { data: settings } = await sb.from('business_settings').select('tenant_id').limit(1).single();
  if (!settings) return;
  
  const tenantId = settings.tenant_id;
  
  const { data: employees, error } = await sb.from('employees')
    .select('*')
    .eq('tenant_id', tenantId)
    .order('last_name', { ascending: true });
  
  if (error) {
    console.error('Error loading employees:', error);
    document.getElementById('employeeAvatars').innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">Error loading employees</div>';
    return;
  }
  
  const total = employees ? employees.length : 0;
  const active = employees ? employees.filter(e => e.is_active).length : 0;
  const serviceTechs = employees ? employees.filter(e => {
    const dept = (e.department || '').toLowerCase();
    const role = (e.role || '').toLowerCase();
    return dept === 'service' || role.includes('tech') || role.includes('mechanic');
  }).length : 0;
  const salesStaff = employees ? employees.filter(e => {
    const dept = (e.department || '').toLowerCase();
    const role = (e.role || '').toLowerCase();
    return dept === 'sales' || role.includes('sales');
  }).length : 0;
  
  document.getElementById('totalEmployees').textContent = total;
  document.getElementById('activeEmployees').textContent = active;
  document.getElementById('serviceTechs').textContent = serviceTechs;
  document.getElementById('salesStaff').textContent = salesStaff;
  
  const grid = document.getElementById('employeeAvatars');
  
  if (!employees || employees.length === 0) {
    grid.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No employees found. Click "+ Add Employee" to create one.</div>';
    return;
  }
  
  const deptFilter = document.getElementById('employeeFilterDept')?.value || '';
  const statusFilter = document.getElementById('employeeFilterStatus')?.value || 'active';
  
  let filtered = employees;
  
  if (deptFilter) {
    filtered = filtered.filter(e => (e.department || '').toLowerCase() === deptFilter);
  }
  
  if (statusFilter === 'active') {
    filtered = filtered.filter(e => e.is_active);
  } else if (statusFilter === 'inactive') {
    filtered = filtered.filter(e => !e.is_active);
  }
  
  if (filtered.length === 0) {
    grid.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No employees match the current filters.</div>';
    return;
  }
  
  const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#14b8a6', '#ec4899'];
  
  grid.innerHTML = filtered.map((emp, i) => {
    const name = ((emp.first_name || '') + ' ' + (emp.last_name || '')).trim() || 'Unknown';
    const initials = emp.first_name && emp.last_name 
      ? (emp.first_name[0] + emp.last_name[0]).toUpperCase() 
      : '??';
    const role = (emp.role || 'Staff').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const color = colors[i % colors.length];
    const avatarStyle = emp.avatar_url 
      ? `background-image:url('${emp.avatar_url}'); background-size:cover;` 
      : `background:${color};`;
    const avatarContent = emp.avatar_url ? '' : initials;
    
    return `
      <div class="employee-card" onclick="location.href='employee-edit.html?id=${emp.employee_id}'">
        <div class="employee-avatar-preview" style="${avatarStyle}">
          ${avatarContent}
        </div>
        <div class="employee-name">${name}</div>
        <div class="employee-role">${role}</div>
        <div class="employee-stats">
          <div class="stat-row">
            <span class="stat-label">Department</span>
            <span class="stat-value">${emp.department || 'N/A'}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Status</span>
            <span class="stat-value">${emp.is_active ? 'Active' : 'Inactive'}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function filterEmployees() {
  loadEmployeesSection();
}

// =====================================================
// APPOINTMENT TYPES MANAGEMENT
// =====================================================

let appointmentTypes = [];
const supabaseUrl = 'https://kxqkwpkmtgvmthpafoqx.supabase.co';
const supabaseKey = document.querySelector('meta[name="supabase-anon-key"]')?.content;

async function loadAppointmentTypes() {
  const token = localStorage.getItem('sb_access_token');
  if (!token) return;
  
  try {
    const response = await fetch(`${supabaseUrl}/rest/v1/appointment_types?order=sort_order.asc,name.asc`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'apikey': supabaseKey
      }
    });
    
    if (!response.ok) throw new Error('Failed to load');
    
    appointmentTypes = await response.json();
    renderAppointmentTypes();
    
  } catch (err) {
    console.error('Error loading appointment types:', err);
    document.getElementById('appointmentTypesList').innerHTML = 
      '<div style="text-align:center; color:#ef4444; padding:20px;">Error loading appointment types</div>';
  }
}

function renderAppointmentTypes() {
  const container = document.getElementById('appointmentTypesList');
  
  if (!appointmentTypes || appointmentTypes.length === 0) {
    container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No appointment types found. Add one or apply an industry preset.</div>';
    return;
  }
  
  container.innerHTML = appointmentTypes.map(type => `
    <div class="appointment-type-row">
      <div style="width:8px; height:40px; border-radius:4px; background:${type.color || '#3b82f6'}; flex-shrink:0;"></div>
      <div style="flex:1; min-width:0;">
        <div style="font-weight:600; font-size:14px;">${type.name}</div>
        <div style="font-size:12px; color:var(--text-secondary);">${type.description || 'No description'} &bull; ${type.duration_minutes || 30} min</div>
      </div>
      <div style="display:flex; gap:6px; flex-shrink:0;" class="apt-type-actions">
        <button onclick="editAppointmentType('${type.id}')" style="padding:6px 12px; font-size:12px;">Edit</button>
        <button onclick="toggleAppointmentType('${type.id}', ${!type.is_active})" style="padding:6px 12px; font-size:12px; ${type.is_active ? '' : 'opacity:0.5;'}">${type.is_active ? 'Active' : 'Inactive'}</button>
        <button onclick="deleteAppointmentType('${type.id}')" style="padding:6px 12px; font-size:12px; color:#ef4444; border-color:#ef4444;">Delete</button>
      </div>
    </div>
  `).join('');
}

function showAddAppointmentTypeForm() {
  document.getElementById('appointmentTypeFormTitle').textContent = 'Add Appointment Type';
  document.getElementById('editingAppointmentTypeId').value = '';
  document.getElementById('aptTypeName').value = '';
  document.getElementById('aptTypeDuration').value = '30';
  document.getElementById('aptTypeColor').value = '#3b82f6';
  document.getElementById('aptTypeDescription').value = '';
  document.getElementById('appointmentTypeForm').style.display = 'block';
}

function editAppointmentType(id) {
  const type = appointmentTypes.find(t => t.id === id);
  if (!type) return;
  
  document.getElementById('appointmentTypeFormTitle').textContent = 'Edit Appointment Type';
  document.getElementById('editingAppointmentTypeId').value = id;
  document.getElementById('aptTypeName').value = type.name || '';
  document.getElementById('aptTypeDuration').value = type.duration_minutes || 30;
  document.getElementById('aptTypeColor').value = type.color || '#3b82f6';
  document.getElementById('aptTypeDescription').value = type.description || '';
  document.getElementById('appointmentTypeForm').style.display = 'block';
}

function cancelAppointmentTypeForm() {
  document.getElementById('appointmentTypeForm').style.display = 'none';
  document.getElementById('appointmentTypeFormMessage').innerHTML = '';
}

async function saveAppointmentType() {
  const token = localStorage.getItem('sb_access_token');
  if (!token) return;
  
  const id = document.getElementById('editingAppointmentTypeId').value;
  const name = document.getElementById('aptTypeName').value.trim();
  const duration = parseInt(document.getElementById('aptTypeDuration').value) || 30;
  const color = document.getElementById('aptTypeColor').value;
  const description = document.getElementById('aptTypeDescription').value.trim();
  
  if (!name) {
    document.getElementById('appointmentTypeFormMessage').innerHTML = '<span class="error">Name is required</span>';
    return;
  }
  
  try {
    const settingsRes = await fetch(`${supabaseUrl}/rest/v1/business_settings?select=tenant_id&limit=1`, {
      headers: { 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey }
    });
    const settings = await settingsRes.json();
    const tenantId = settings[0]?.tenant_id;
    
    if (!tenantId) throw new Error('No tenant found');
    
    const data = { name, duration_minutes: duration, color, description: description || null, is_active: true };
    
    let response;
    
    if (id) {
      response = await fetch(`${supabaseUrl}/rest/v1/appointment_types?id=eq.${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey },
        body: JSON.stringify(data)
      });
    } else {
      data.tenant_id = tenantId;
      data.sort_order = appointmentTypes.length;
      
      response = await fetch(`${supabaseUrl}/rest/v1/appointment_types`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey, 'Prefer': 'return=representation' },
        body: JSON.stringify(data)
      });
    }
    
    if (!response.ok) throw new Error('Failed to save');
    
    document.getElementById('appointmentTypeFormMessage').innerHTML = '<span class="success">Saved!</span>';
    setTimeout(() => { cancelAppointmentTypeForm(); loadAppointmentTypes(); }, 500);
    
  } catch (err) {
    document.getElementById('appointmentTypeFormMessage').innerHTML = `<span class="error">Error: ${err.message}</span>`;
  }
}

async function toggleAppointmentType(id, isActive) {
  const token = localStorage.getItem('sb_access_token');
  if (!token) return;
  
  try {
    await fetch(`${supabaseUrl}/rest/v1/appointment_types?id=eq.${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey },
      body: JSON.stringify({ is_active: isActive })
    });
    loadAppointmentTypes();
  } catch (err) {
    console.error('Toggle error:', err);
  }
}

async function deleteAppointmentType(id) {
  if (!confirm('Delete this appointment type?')) return;
  
  const token = localStorage.getItem('sb_access_token');
  if (!token) return;
  
  try {
    await fetch(`${supabaseUrl}/rest/v1/appointment_types?id=eq.${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey }
    });
    loadAppointmentTypes();
  } catch (err) {
    alert('Error deleting');
  }
}

async function loadIndustryPreset() {
  const industry = document.getElementById('industryPreset').value;
  const names = { 'auto': 'Auto Dealer', 'motorcycle': 'Motorcycle / Powersports', 'marine': 'Marine / Jet Ski', 'field_sales': 'Traveling Sales', 'political': 'Political / Canvassing' };
  
  if (!confirm(`Load ${names[industry]} preset?\n\nThis will add new types. Existing types will not be deleted.`)) return;
  
  const token = localStorage.getItem('sb_access_token');
  if (!token) return;
  
  try {
    const presetsRes = await fetch(`${supabaseUrl}/rest/v1/appointment_type_presets?industry=eq.${industry}&order=sort_order.asc`, {
      headers: { 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey }
    });
    const presets = await presetsRes.json();
    
    if (!presets || presets.length === 0) { alert('No presets found'); return; }
    
    const settingsRes = await fetch(`${supabaseUrl}/rest/v1/business_settings?select=tenant_id&limit=1`, {
      headers: { 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey }
    });
    const settings = await settingsRes.json();
    const tenantId = settings[0]?.tenant_id;
    
    if (!tenantId) throw new Error('No tenant found');
    
    let added = 0;
    for (const preset of presets) {
      try {
        const res = await fetch(`${supabaseUrl}/rest/v1/appointment_types`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey },
          body: JSON.stringify({ tenant_id: tenantId, name: preset.name, description: preset.description, duration_minutes: preset.duration_minutes, color: preset.color, sort_order: preset.sort_order, is_active: true })
        });
        if (res.ok) added++;
      } catch (e) { /* duplicate */ }
    }
    
    // Update business_settings with selected industry preset
    await fetch(`${supabaseUrl}/rest/v1/business_settings?tenant_id=eq.${tenantId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'apikey': supabaseKey },
      body: JSON.stringify({ industry_preset: industry })
    });
    
    alert(`Loaded ${added} new appointment types!`);
    loadAppointmentTypes();
    
  } catch (err) {
    alert('Error loading preset: ' + err.message);
  }
}

// =====================================================
// INITIALIZATION
// =====================================================

setTimeout(() => {
  loadEmployeesSection();
  loadAppointmentTypes();
}, 500);
</script>
</body>
</html>
