<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
.appName{position:fixed;top:10px;right:24px;font-size:12px;color:#9fb0c3}
header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:16px;gap:16px;flex-wrap:wrap}
h1{margin:0;font-size:40px}
h2{margin:18px 0 10px;font-size:18px}
.sub-nav{display:flex;gap:16px;margin:8px 0 0;padding-bottom:10px;border-bottom:1px solid #1f2937}
.sub-nav-link{font-size:14px;color:#9ca3af;text-decoration:none}
.sub-nav-link:hover{color:#e5e7eb}
.header-buttons{display:flex;gap:8px}
button{padding:8px 14px;border-radius:10px;border:1px solid #2a3b55;background:#1a2535;color:#fff;cursor:pointer}
button:hover{background:#243648}
.card{background:#0f1621;border:1px solid #223044;border-radius:14px;padding:20px;margin-bottom:16px}
.employee-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:16px}
.employee-card{background:#0b0f14;border:1px solid #223044;border-radius:12px;padding:16px;text-align:center}
.employee-avatar-preview{width:100px;height:100px;border-radius:12px;border:2px solid #223044;background:#0f1621;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:32px;overflow:hidden;background-size:cover;background-position:center;opacity:.9;box-shadow:inset 0 0 8px rgba(255,255,255,.05)}
.employee-name{font-size:14px;font-weight:600}
.employee-role{font-size:11px;color:#9fb0c3;text-transform:uppercase;margin-bottom:10px}
.upload-btn,.remove-btn{width:100%;font-size:12px;margin-top:6px}
.remove-btn{background:#ef4444;border-color:#ef4444}
.view-profile-btn{width:100%;margin-top:10px;font-size:12px}
.hidden{display:none}
.success{color:#4ade80;font-size:12px;margin-top:8px}
.error{color:#ef4444;font-size:12px;margin-top:8px}
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<header>
  <div>
    <h1>Settings</h1>
    <div class="sub-nav">
      <a class="sub-nav-link" href="#">Dashboard</a>
      <a class="sub-nav-link" href="#">Customers</a>
      <a class="sub-nav-link" href="#">Vehicles</a>
      <a class="sub-nav-link" href="#">Scheduling</a>
    </div>
  </div>
  <div class="header-buttons">
    <button onclick="location.reload()">Settings</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="card">
<h2>Employee Profiles</h2>
<div id="employeeAvatars" class="employee-grid">
<div style="opacity:.6">Loading employeesâ€¦</div>
</div>
<div id="avatarMessage"></div>
</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API_BASE=`https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL=`${API_BASE}/storage/v1`;
const REST_BASE=`${API_BASE}/rest/v1`;
const FUNCTIONS_BASE=`${API_BASE}/functions/v1`;
const ANON_KEY=document.querySelector('meta[name="supabase-anon-key"]').content;

let employees=[];

function logout(){
localStorage.removeItem("sb_access_token");
location.href="login.html";
}

function initials(f,l){
return ((f?.[0]||"")+(l?.[0]||"")).toUpperCase()||"??";
}

function avatarURL(emp){
return emp.avatar_url
? `${STORAGE_URL}/object/public/avatars/${emp.avatar_url}`
: null;
}

function render(){
const el=document.getElementById("employeeAvatars");
el.innerHTML="";
employees.forEach(emp=>{
const url=avatarURL(emp);
el.innerHTML+=`
<div class="employee-card">
<div class="employee-avatar-preview" style="${url?`background-image:url('${url}')`:``}">
${url?"":initials(emp.first_name,emp.last_name)}
</div>
<div class="employee-name">${emp.first_name||""} ${emp.last_name||""}</div>
<div class="employee-role">${emp.role||""}</div>

<input class="hidden" type="file" id="file-${emp.employee_id}" accept="image/*"
onchange="uploadAvatar('${emp.employee_id}',this.files[0])"/>

<button class="upload-btn" onclick="document.getElementById('file-${emp.employee_id}').click()">Upload Photo</button>
${url?`<button class="remove-btn" onclick="removeAvatar('${emp.employee_id}')">Remove</button>`:""}
<button class="view-profile-btn">View Profile</button>
</div>`;
});
}

async function uploadAvatar(id,file){
const token=localStorage.getItem("sb_access_token");
if(!token||!file)return;

const ext=file.name.split(".").pop();
const name=`${id}.${ext}`;
const fd=new FormData();
fd.append("file",file);

await fetch(`${STORAGE_URL}/object/avatars/${name}`,{
method:"POST",
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY},
body:fd
});

await fetch(`${REST_BASE}/employees?employee_id=eq.${id}`,{
method:"PATCH",
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY,"Content-Type":"application/json"},
body:JSON.stringify({avatar_url:name})
});

const emp=employees.find(e=>e.employee_id===id);
if(emp)emp.avatar_url=name;
render();
}

async function removeAvatar(id){
const token=localStorage.getItem("sb_access_token");
const emp=employees.find(e=>e.employee_id===id);
if(!emp||!emp.avatar_url)return;

await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`,{
method:"DELETE",
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
});

await fetch(`${REST_BASE}/employees?employee_id=eq.${id}`,{
method:"PATCH",
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY,"Content-Type":"application/json"},
body:JSON.stringify({avatar_url:null})
});

emp.avatar_url=null;
render();
}

async function load(){
const token=localStorage.getItem("sb_access_token");
if(!token)return logout();

const r=await fetch(`${FUNCTIONS_BASE}/employees`,{
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
});
employees=await r.json();
render();
}

load();
</script>
</body>
</html>
