<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <!-- styles unchanged -->
  <style>
    /* ALL YOUR EXISTING CSS — UNCHANGED */
  </style>
</head>

<body>
  <!-- ALL YOUR EXISTING HTML — UNCHANGED -->

<script>
const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
const API_BASE = `https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL = `${API_BASE}/storage/v1`;
const REST_BASE = `${API_BASE}/rest/v1`;
const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

let employees = [];

/* =========================================
   AVATAR UPLOAD — FIXED (ONLY CHANGE)
   ========================================= */
async function uploadAvatar(employeeId, file){
  const token = localStorage.getItem('sb_access_token');
  if(!token) return;

  try {
    showAvatarMessage('Uploading photo...', 'muted');

    const fileExt = file.name.split('.').pop();
    const fileName = `${employeeId}-${Date.now()}.${fileExt}`;

    const formData = new FormData();
    formData.append('file', file);

    const uploadResponse = await fetch(
      `${STORAGE_URL}/object/avatars/${fileName}`,
      {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${token}`,
          apikey: ANON_KEY
          // ❌ DO NOT set Content-Type
        },
        body: formData
      }
    );

    if(!uploadResponse.ok){
      throw new Error(await uploadResponse.text());
    }

    const updateResponse = await fetch(
      `${REST_BASE}/employees?employee_id=eq.${employeeId}`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
          apikey: ANON_KEY
        },
        body: JSON.stringify({ avatar_url: fileName })
      }
    );

    if(!updateResponse.ok){
      throw new Error('Failed to update employee record');
    }

    const emp = employees.find(e => e.employee_id === employeeId);
    if(emp) emp.avatar_url = fileName;

    showAvatarMessage('Photo uploaded successfully!', 'success');
    renderEmployees();

  } catch(err){
    console.error('Upload error:', err);
    showAvatarMessage('Error uploading photo: ' + err.message, 'error');
  }
}

/* =========================================
   EVERYTHING BELOW — UNCHANGED
   (removeAvatar, renderEmployees, load, etc)
   ========================================= */
</script>
</body>
</html>
