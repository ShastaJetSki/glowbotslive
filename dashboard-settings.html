<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4"/>

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
.appName{position:fixed;top:10px;right:24px;font-size:12px;color:#9fb0c3}
header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:16px;gap:16px;flex-wrap:wrap}
h1{margin:0;font-size:40px}
h2{margin:18px 0 10px;font-size:18px}
button{padding:8px 14px;border-radius:10px;border:1px solid #2a3b55;background:#1a2535;color:#fff;cursor:pointer}
button:hover{background:#243648}
.card{background:#0f1621;border:1px solid #223044;border-radius:14px;padding:20px;margin-bottom:16px}

.employee-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
.employee-card{background:#0b0f14;border:1px solid #223044;border-radius:12px;padding:16px;text-align:center}
.employee-avatar{width:100px;height:100px;border-radius:12px;border:2px solid #223044;margin:0 auto 12px;
background:#0f1621;display:flex;align-items:center;justify-content:center;
font-weight:700;font-size:32px;color:#e8eef6;background-size:cover;background-position:center}
.upload-btn,.remove-btn{width:100%;font-size:12px;padding:6px 10px}
.remove-btn{background:#ef4444;border-color:#ef4444;margin-top:6px}
.remove-btn:hover{background:#dc2626}

input[type=file]{display:none}
.success{color:#4ade80;font-size:12px}
.error{color:#ef4444;font-size:12px}
.muted{color:#9fb0c3;font-size:12px}
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<header>
  <h1>Settings</h1>
  <div>
    <button onclick="location.reload()">Settings</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<!-- ================= EMPLOYEE PROFILES ================= -->
<div class="card">
<h2>Employee Profiles</h2>
<div id="employeeAvatars" class="employee-grid">Loading…</div>
<div id="avatarMessage"></div>
</div>

<!-- ================= BUSINESS SETTINGS ================= -->
<div class="card">
<h2>Business Settings</h2>
<input id="businessName" placeholder="Business Name"/>
<button onclick="saveSettings()">Save</button>
<div id="saveMessage"></div>
</div>

<!-- ================= EMPLOYEE ONBOARDING ================= -->
<div class="card">
<h2>Employee Onboarding</h2>
<form id="employeeForm">
<input id="empFirstName" placeholder="First Name" required/>
<input id="empLastName" placeholder="Last Name" required/>
<input id="empEmail" placeholder="Email" required/>
<button>Add Employee</button>
</form>
<div id="employeeMessage"></div>
<div id="employeeList"></div>
</div>

<!-- ================= ACCOUNT ================= -->
<div class="card">
<h2>Account</h2>
<div id="userEmail">Loading…</div>
</div>

<!-- ================= DATA MANAGEMENT ================= -->
<div class="card">
<h2>Data Management</h2>
<button onclick="clearCache()">Clear Cache</button>
</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API=`https://${PROJECT_REF}.supabase.co`;
const STORAGE=`${API}/storage/v1/object/public/avatars`;
const REST=`${API}/rest/v1`;
const FN=`${API}/functions/v1/employees`;
const KEY=document.querySelector('meta[name="supabase-anon-key"]').content;

let employees=[];

function logout(){
  localStorage.removeItem("sb_access_token");
  location.href="login.html";
}

function showAvatarMessage(msg,type="success"){
  avatarMessage.innerHTML=`<div class="${type}">${msg}</div>`;
}

function initials(f,l){
  return ((f?.[0]||"")+(l?.[0]||"")).toUpperCase()||"??";
}

function avatarUrl(emp){
  return emp.avatar_url ? `${STORAGE}/${emp.avatar_url}` : null;
}

function renderEmployees(){
  employeeAvatars.innerHTML=employees.map(e=>{
    const url=avatarUrl(e);
    return `
    <div class="employee-card">
      <div class="employee-avatar" style="${url?`background-image:url('${url}')`:''}">
        ${url?'':initials(e.first_name,e.last_name)}
      </div>
      <strong>${e.first_name}</strong>
      <div class="muted">${e.role||''}</div>

      <input type="file" id="f-${e.employee_id}" accept="image/*"
        onchange="uploadAvatar('${e.employee_id}',this.files[0])"/>

      <button class="upload-btn"
        onclick="document.getElementById('f-${e.employee_id}').click()">
        ${url?'Change Photo':'Upload Photo'}
      </button>

      ${url?`<button class="remove-btn"
        onclick="removeAvatar('${e.employee_id}')">Remove</button>`:''}
    </div>`;
  }).join("");
}

async function uploadAvatar(id,file){
  const token=localStorage.getItem("sb_access_token");
  if(!file||!token) return;

  const ext=file.name.split(".").pop();
  const name=`${id}.${ext}`;
  const fd=new FormData();
  fd.append("file",file);

  await fetch(`${API}/storage/v1/object/avatars/${name}`,{
    method:"POST",
    headers:{Authorization:`Bearer ${token}`,apikey:KEY},
    body:fd
  });

  await fetch(`${REST}/employees?employee_id=eq.${id}`,{
    method:"PATCH",
    headers:{Authorization:`Bearer ${token}`,apikey:KEY,"Content-Type":"application/json"},
    body:JSON.stringify({avatar_url:name})
  });

  const emp=employees.find(e=>e.employee_id===id);
  if(emp) emp.avatar_url=name;
  renderEmployees();
}

async function removeAvatar(id){
  const token=localStorage.getItem("sb_access_token");
  const emp=employees.find(e=>e.employee_id===id);
  if(!emp||!token) return;

  await fetch(`${API}/storage/v1/object/avatars/${emp.avatar_url}`,{
    method:"DELETE",
    headers:{Authorization:`Bearer ${token}`,apikey:KEY}
  });

  await fetch(`${REST}/employees?employee_id=eq.${id}`,{
    method:"PATCH",
    headers:{Authorization:`Bearer ${token}`,apikey:KEY,"Content-Type":"application/json"},
    body:JSON.stringify({avatar_url:null})
  });

  emp.avatar_url=null;
  renderEmployees();
}

async function loadEmployees(){
  const token=localStorage.getItem("sb_access_token");
  const r=await fetch(FN,{headers:{Authorization:`Bearer ${token}`,apikey:KEY}});
  employees=await r.json();
  renderEmployees();
}

function saveSettings(){
  localStorage.setItem("biz_name",businessName.value);
  saveMessage.innerHTML="<div class='success'>Saved</div>";
}

function clearCache(){
  localStorage.clear();
  location.reload();
}

document.getElementById("employeeForm").onsubmit=async e=>{
  e.preventDefault();
  employeeMessage.innerHTML="<div class='muted'>Stub</div>";
};

loadEmployees();
</script>
</body>
</html>
