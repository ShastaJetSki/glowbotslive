<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<meta name="supabase-anon-key"
content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4"/>

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
.appName{position:fixed;top:10px;right:24px;font-size:12px;color:#9fb0c3}
h1{font-size:40px;margin:0}
h2{font-size:18px;margin:18px 0 10px}

.card{background:#0f1621;border:1px solid #223044;border-radius:14px;padding:20px;margin-bottom:16px}

.employee-grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
gap:16px
}

.employee-card{
background:#0b0f14;
border:1px solid #223044;
border-radius:12px;
padding:16px;
text-align:center
}

/* AVATAR EFFECTS */
.employee-avatar{
width:100px;height:100px;
border-radius:12px;
margin:0 auto 12px;
display:flex;align-items:center;justify-content:center;
font-size:32px;font-weight:700;
background:#0f1621;
background-size:cover;
background-position:center;
opacity:.9;
box-shadow:
inset 0 1px 0 rgba(255,255,255,.08),
inset 0 -1px 0 rgba(0,0,0,.45),
0 4px 10px rgba(0,0,0,.35);
transition:.2s
}
.employee-avatar:hover{
opacity:1;
transform:translateY(-1px);
box-shadow:
inset 0 1px 0 rgba(255,255,255,.12),
inset 0 -1px 0 rgba(0,0,0,.35),
0 6px 14px rgba(0,0,0,.45)
}

.employee-name{font-size:14px;font-weight:600;margin-bottom:2px}
.employee-role{font-size:11px;color:#9fb0c3;text-transform:uppercase}

button{
padding:6px 12px;
border-radius:10px;
border:1px solid #2a3b55;
background:#1a2535;
color:#fff;
cursor:pointer;
font-size:12px
}
button:hover{background:#243648}

.upload-btn{width:100%;margin-top:8px}
.remove-btn{width:100%;margin-top:6px;background:#ef4444;border-color:#ef4444}
.remove-btn:hover{background:#dc2626}

.hidden{display:none}
.success{color:#4ade80;font-size:12px}
.error{color:#ef4444;font-size:12px}
.muted{color:#9fb0c3;font-size:12px}
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<h1>Settings</h1>

<div class="card">
<h2>Employee Profiles</h2>
<div id="employeeAvatars" class="employee-grid"></div>
<div id="avatarMessage"></div>
</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API_BASE=`https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL=`${API_BASE}/storage/v1`;
const REST_BASE=`${API_BASE}/rest/v1`;
const FUNCTIONS_BASE=`${API_BASE}/functions/v1`;
const ANON_KEY=document.querySelector('meta[name="supabase-anon-key"]').content;

let employees=[];

function initials(name){
return name?.[0]?.toUpperCase() || "—";
}

function avatarUrl(emp){
if(!emp.avatar_url) return null;
return `${STORAGE_URL}/object/public/avatars/${emp.avatar_url}`;
}

function msg(text,type){
const el=document.getElementById("avatarMessage");
el.innerHTML=`<div class="${type}">${text}</div>`;
setTimeout(()=>el.innerHTML="",4000);
}

/* UPLOAD */
async function uploadAvatar(employeeId,file){
const token=localStorage.getItem("sb_access_token");
if(!token||!file) return;

try{
msg("Uploading photo…","muted");

const ext=file.name.split(".").pop();
const fileName=`${employeeId}-${Date.now()}.${ext}`;

const fd=new FormData();
fd.append("file",file);

const up=await fetch(`${STORAGE_URL}/object/avatars/${fileName}`,{
method:"POST",
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY},
body:fd
});

if(!up.ok) throw new Error(await up.text());

await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`,{
method:"PATCH",
headers:{
"Content-Type":"application/json",
Authorization:`Bearer ${token}`,
apikey:ANON_KEY
},
body:JSON.stringify({avatar_url:fileName})
});

const emp=employees.find(e=>e.employee_id===employeeId);
if(emp) emp.avatar_url=fileName;

renderEmployees();
msg("Photo uploaded","success");

}catch(err){
console.error(err);
msg(err.message,"error");
}
}

/* REMOVE */
async function removeAvatar(employeeId){
const token=localStorage.getItem("sb_access_token");
const emp=employees.find(e=>e.employee_id===employeeId);
if(!token||!emp?.avatar_url) return;

await fetch(`${STORAGE_URL}/object/avatars/${emp.avatar_url}`,{
method:"DELETE",
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
});

await fetch(`${REST_BASE}/employees?employee_id=eq.${employeeId}`,{
method:"PATCH",
headers:{
"Content-Type":"application/json",
Authorization:`Bearer ${token}`,
apikey:ANON_KEY
},
body:JSON.stringify({avatar_url:null})
});

emp.avatar_url=null;
renderEmployees();
}

/* RENDER */
function renderEmployees(){
const el=document.getElementById("employeeAvatars");
el.innerHTML=employees.map(emp=>{
const name=emp.first_name || "Employee";
const role=emp.role || "";
const url=avatarUrl(emp);

return `
<div class="employee-card">
<div class="employee-avatar" style="${url?`background-image:url('${url}')`:''}">
${!url?initials(name):""}
</div>

<div class="employee-name">${name}</div>
<div class="employee-role">${role}</div>

<input type="file" id="f-${emp.employee_id}" class="hidden"
accept="image/*"
onchange="uploadAvatar('${emp.employee_id}',this.files[0])"/>

<button class="upload-btn"
onclick="document.getElementById('f-${emp.employee_id}').click()">
${url?"Change Photo":"Upload Photo"}
</button>

${url?`<button class="remove-btn" onclick="removeAvatar('${emp.employee_id}')">Remove</button>`:""}
</div>`;
}).join("");
}

/* LOAD */
async function loadEmployees(){
const token=localStorage.getItem("sb_access_token");
if(!token) return location.replace("login.html");

const r=await fetch(`${FUNCTIONS_BASE}/employees`,{
headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
});

employees=await r.json();
renderEmployees();
}

loadEmployees();
</script>
</body>
</html>
