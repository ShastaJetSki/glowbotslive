<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Settings</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="supabase-anon-key"
  content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

<style>
body{margin:0;padding:24px;font-family:system-ui;background:#0b0f14;color:#e8eef6}
.appName{position:fixed;top:10px;right:24px;font-size:12px;color:#9fb0c3}
h1{font-size:40px;margin:0}
h2{margin:18px 0 10px;font-size:18px}

.card{background:#0f1621;border:1px solid #223044;border-radius:14px;padding:20px;margin-bottom:16px}

.employee-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}

.employee-card{
  background:#0b0f14;
  border:1px solid #223044;
  border-radius:14px;
  padding:16px;
  text-align:center;
  transition:.2s ease;
}

.employee-card:hover{
  border-color:#3b82f6;
}

.employee-avatar-preview{
  width:110px;
  height:110px;
  margin:0 auto 12px;
  border-radius:14px;
  background:#0f1621;
  background-size:cover;
  background-position:center;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:34px;
  font-weight:700;
  color:#e8eef6;
  cursor:pointer;

  /* IMAGE TONING */
  filter:brightness(.85) contrast(.95);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.06),
    0 6px 16px rgba(0,0,0,.45);
}

.employee-avatar-preview:hover{
  filter:brightness(.95);
}

.employee-name{font-weight:600;font-size:14px}
.employee-role{font-size:11px;color:#9fb0c3;margin-bottom:10px;text-transform:uppercase}

button{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #2a3b55;
  background:#1a2535;
  color:#fff;
  cursor:pointer;
  font-size:12px;
}

button:hover{background:#243648}

.upload-btn{width:100%;margin-top:6px}

.remove-btn{
  width:100%;
  margin-top:6px;
  background:#2a1111;
  border-color:#7f1d1d;
  color:#fca5a5;
}

.remove-btn:hover{
  background:#7f1d1d;
  color:#fff;
}

input.hidden{display:none}

.success{color:#4ade80;font-size:12px}
.error{color:#ef4444;font-size:12px}
.muted{color:#9fb0c3;font-size:12px}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal.active{display:flex}

.modal-content{
  background:#0f1621;
  border:1px solid #223044;
  border-radius:14px;
  padding:24px;
  max-width:520px;
  width:100%;
}

.modal h3{margin-top:0}

.modal-close{
  float:right;
  cursor:pointer;
  color:#9fb0c3;
}

.modal a{
  color:#60a5fa;
  font-size:13px;
}
</style>
</head>

<body>
<div class="appName">WorkLogicPro</div>

<h1>Settings</h1>

<div class="card">
<h2>Employee Profiles</h2>
<div id="employeeAvatars" class="employee-grid"></div>
<div id="avatarMessage"></div>
</div>

<!-- MODAL -->
<div id="employeeModal" class="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">✕</span>
    <h3 id="modalName"></h3>
    <p id="modalRole" class="muted"></p>
    <hr style="border-color:#223044">
    <p><strong>Hourly Rate:</strong> $<span id="modalRate"></span></p>
    <p><strong>Status:</strong> Active</p>

    <div style="margin-top:16px">
      <a href="#" onclick="showFullDetails()">View Full Details →</a>
    </div>

    <div id="fullDetails" style="display:none;margin-top:16px">
      <p><strong>Address:</strong> On file</p>
      <p><strong>Notes:</strong> Certifications, history, internal notes</p>
    </div>
  </div>
</div>

<script>
const PROJECT_REF="kxqkwpkmtgvmthpafoqx";
const API_BASE=`https://${PROJECT_REF}.supabase.co`;
const STORAGE_URL=`${API_BASE}/storage/v1`;
const REST_BASE=`${API_BASE}/rest/v1`;
const FUNCTIONS_BASE=`${API_BASE}/functions/v1`;
const ANON_KEY=document.querySelector('meta[name="supabase-anon-key"]').content;

let employees=[];

const ROLE_RANK={owner:1,manager:2,technician:3,tech:3};

function initials(name){
  const p=name?.split(" ")||[];
  return ((p[0]?.[0]||"")+(p[1]?.[0]||"")).toUpperCase()||"??";
}

function avatarUrl(e){
  return e.avatar_url ? `${STORAGE_URL}/object/public/avatars/${e.avatar_url}` : null;
}

function render(){
  const el=document.getElementById("employeeAvatars");
  el.innerHTML=employees.map(e=>{
    const img=avatarUrl(e);
    return `
      <div class="employee-card">
        <div class="employee-avatar-preview"
          onclick="openModal('${e.employee_id}')"
          style="${img?`background-image:url('${img}')`:''}">
          ${!img?initials(e.name):''}
        </div>
        <div class="employee-name">${e.name}</div>
        <div class="employee-role">${e.role}</div>

        <input type="file" id="f-${e.employee_id}" class="hidden"
          onchange="upload('${e.employee_id}',this.files[0])">

        <button class="upload-btn"
          onclick="document.getElementById('f-${e.employee_id}').click()">
          ${img?"Change Photo":"Upload Photo"}
        </button>

        ${img?`<button class="remove-btn" onclick="remove('${e.employee_id}')">
          Remove Photo
        </button>`:""}
      </div>
    `;
  }).join("");
}

function openModal(id){
  const e=employees.find(x=>x.employee_id===id);
  if(!e)return;
  document.getElementById("modalName").textContent=e.name;
  document.getElementById("modalRole").textContent=e.role.toUpperCase();
  document.getElementById("modalRate").textContent=e.hourly_labor_rate||"—";
  document.getElementById("employeeModal").classList.add("active");
}

function closeModal(){
  document.getElementById("employeeModal").classList.remove("active");
  document.getElementById("fullDetails").style.display="none";
}

function showFullDetails(){
  document.getElementById("fullDetails").style.display="block";
}

async function upload(id,file){
  if(!file)return;
  const token=localStorage.getItem("sb_access_token");
  const ext=file.name.split(".").pop();
  const name=`${id}-${Date.now()}.${ext}`;

  await fetch(`${STORAGE_URL}/object/avatars/${name}`,{
    method:"POST",
    headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY},
    body:file
  });

  await fetch(`${REST_BASE}/employees?employee_id=eq.${id}`,{
    method:"PATCH",
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${token}`,
      apikey:ANON_KEY
    },
    body:JSON.stringify({avatar_url:name})
  });

  employees.find(e=>e.employee_id===id).avatar_url=name;
  render();
}

async function remove(id){
  if(!confirm("Remove photo?"))return;
  const token=localStorage.getItem("sb_access_token");
  const e=employees.find(x=>x.employee_id===id);

  await fetch(`${STORAGE_URL}/object/avatars/${e.avatar_url}`,{
    method:"DELETE",
    headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
  });

  await fetch(`${REST_BASE}/employees?employee_id=eq.${id}`,{
    method:"PATCH",
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${token}`,
      apikey:ANON_KEY
    },
    body:JSON.stringify({avatar_url:null})
  });

  e.avatar_url=null;
  render();
}

async function load(){
  const token=localStorage.getItem("sb_access_token");
  const r=await fetch(`${FUNCTIONS_BASE}/employees`,{
    headers:{Authorization:`Bearer ${token}`,apikey:ANON_KEY}
  });
  employees=await r.json();
  employees.sort((a,b)=>(ROLE_RANK[a.role]??99)-(ROLE_RANK[b.role]??99));
  render();
}

load();
</script>
</body>
</html>
