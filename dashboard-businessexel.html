<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Business Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="supabase-anon-key"
    content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4cWt3cGttdGd2bXRocGFmb3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDI1OTQsImV4cCI6MjA4MTAxODU5NH0.GT9pOMqrUr1EvVLh1magyoB4I_LprziRaybKsGHhrX4" />

  <style>
    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui;
      background: #0b0f14;
      color: #e8eef6;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }

    button {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid #2a3b55;
      background: #1a2535;
      color: #fff;
      cursor: pointer;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .card {
      background: #0f1621;
      border: 1px solid #223044;
      border-radius: 14px;
      padding: 14px 16px;
    }

    .kpi { min-width: 260px; flex: 1 1 260px; }
    .tech {
      min-width: 240px;
      flex: 1 1 240px;
      cursor: pointer;
      transition: border-color .15s;
    }
    .tech.active {
      border-color: #3b82f6;
      box-shadow: inset 0 0 0 1px rgba(59,130,246,.35);
    }

    .label { font-size: 12px; color: #9fb0c3; }
    .value { font-size: 18px; font-weight: 650; margin-top: 6px; }
    .muted { font-size: 12px; color: #9fb0c3; margin-top: 6px; }
    .wo { margin-bottom: 10px; }
    .error { color: #ffb3b3; white-space: pre-wrap; }

    h2 { margin: 18px 0 10px; font-size: 18px; }
  </style>
</head>

<body>

<header>
  <h1 style="margin:0;">Business Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<!-- KPI ROW -->
<div class="row" id="kpis"></div>

<!-- TECH ROW -->
<h2>Technicians</h2>
<div class="row" id="techCards"></div>

<!-- WORK ORDERS -->
<h2>Work Orders</h2 hookup
<div id="workOrders">Loading…</div>

<script>
  const PROJECT_REF = "kxqkwpkmtgvmthpafoqx";
  const API_BASE = `https://${PROJECT_REF}.supabase.co`;
  const FUNCTIONS_BASE = `${API_BASE}/functions/v1`;
  const ANON_KEY = document.querySelector('meta[name="supabase-anon-key"]').content;

  const DEFAULT_JOB_HOURS = 1.0;

  let employees = [];
  let employeesById = {};
  let technicians = [];
  let orders = [];
  let activeTechId = null;

  const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
  const endOfToday = new Date(); endOfToday.setHours(23,59,59,999);

  function money(n){ return `$${Number(n || 0).toFixed(2)}`; }

  function jobHours(w){
    if (w.scheduled_start && w.scheduled_end) {
      return (new Date(w.scheduled_end) - new Date(w.scheduled_start)) / 36e5;
    }
    if (w.status === "scheduled") return DEFAULT_JOB_HOURS;
    return 0;
  }

  function orderRevenue(w){
    const hrs = jobHours(w);
    const rate = employeesById[w.assigned_to]?.hourly_labor_rate || 0;
    return hrs * rate;
  }

  async function fetchJson(url, token){
    const res = await fetch(url, {
      headers: {
        Authorization: `Bearer ${token}`,
        apikey: ANON_KEY
      }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function validateAuth(){
    const token = localStorage.getItem("sb_access_token");
    if (!token) return null;

    const res = await fetch(`${API_BASE}/auth/v1/user`, {
      headers: { Authorization: `Bearer ${token}`, apikey: ANON_KEY }
    });
    if (!res.ok) return null;
    return token;
  }

  function logout(){
    localStorage.removeItem("sb_access_token");
    location.replace("login.html");
  }

  function renderKPIs(){
    let todayH=0, todayRev=0;

    orders.forEach(w=>{
      const hrs = jobHours(w);
      const rev = orderRevenue(w);
      const s = w.scheduled_start ? new Date(w.scheduled_start) : null;
      if (s && s >= startOfToday && s <= endOfToday) {
        todayH += hrs;
        todayRev += rev;
      }
    });

    document.getElementById("kpis").innerHTML = `
      <div class="card kpi">
        <div class="label">Scheduled Work</div>
        <div class="value">
          Today ${todayH.toFixed(1)}h / ${money(todayRev)}
        </div>
      </div>
    `;
  }

  function renderTechCards(){
    document.getElementById("techCards").innerHTML = technicians.map(t=>{
      const active = activeTechId === t.employee_id ? "active" : "";
      return `
        <div class="card tech ${active}" onclick="selectTech('${t.employee_id}')">
          <div class="label">
            <span style="color:#3b82f6;">●</span>
            TECH · ${t.tech_code} · ${t.display_name}
          </div>
          <div class="value">0.0h / $0.00</div>
          <div class="muted">Rate ${money(t.hourly_labor_rate)}/hr</div>
        </div>
      `;
    }).join("");
  }

  function selectTech(id){
    activeTechId = activeTechId === id ? null : id;
    renderTechCards();
    renderWorkOrders();
  }
  window.selectTech = selectTech;

  function renderWorkOrders(){
    const list = document.getElementById("workOrders");
    const filtered = activeTechId
      ? orders.filter(w => w.assigned_to === activeTechId)
      : orders;

    if (!filtered.length) {
      list.innerHTML = `<div class="muted">No work orders for this view.</div>`;
      return;
    }

    list.innerHTML = filtered.map(w=>{
      const techName = w.assigned_to
        ? employeesById[w.assigned_to]?.display_name || "Unknown Tech"
        : "Unassigned";

      return `
        <div class="card wo">
          <strong>${w.summary}</strong> · ${w.status}
          <div class="muted">Assigned: ${techName}</div>
        </div>
      `;
    }).join("");
  }

  async function load(){
    const token = await validateAuth();
    if (!token) {
      localStorage.removeItem("sb_access_token");
      location.replace("login.html");
      return;
    }

    employees = await fetchJson(`${FUNCTIONS_BASE}/employees`, token);

    employees.forEach(e=>{
      e.display_name = `${e.first_name} ${e.last_name?.charAt(0) || ""}.`;
      e.tech_code = e.role === "technician" ? e.last_name : "";
      employeesById[e.employee_id] = e;
    });

    technicians = employees.filter(e => e.role === "technician");
    orders = await fetchJson(`${FUNCTIONS_BASE}/work_orders`, token);

    renderKPIs();
    renderTechCards();
    renderWorkOrders();
  }

  load();
</script>

</body>
</html>
